<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    html, body {
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    
    body {
      background: linear-gradient(150deg, #f8f9fc 0%, #eef1f8 40%, #e8ecf5 60%, #f0f3f9 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }
    
    /* ========== MODERN GLASS EFFECTS ========== */
    .glass {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.03);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .glass-card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    
    .glass-modal {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255, 255, 255, 1);
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.12);
    }
    
    .glass-input {
      background: rgba(255, 255, 255, 0.7);
      border: 2px solid rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      font-size: 16px !important;
      border-radius: 12px;
    }
    
    .glass-input:focus {
      background: rgba(255, 255, 255, 0.95);
      border-color: #8b5cf6;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
      outline: none;
    }
    
    /* ========== BUTTONS ========== */
    .glass-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 14px rgba(124, 58, 237, 0.35);
    }
    
    .glass-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.45);
    }
    
    .glass-btn:active { 
      transform: scale(0.98); 
    }
    
    .glass-btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
    }
    
    .glass-btn-success:hover {
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.45);
    }
    
    /* ========== SIDEBAR ========== */
    .sidebar-item {
      transition: all 0.2s ease;
      border-radius: 14px;
      position: relative;
    }
    
    .sidebar-item:hover { 
      background: rgba(139, 92, 246, 0.08); 
    }
    
    .sidebar-item.active { 
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
      color: #7c3aed;
    }
    
    .sidebar-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
      border-radius: 0 4px 4px 0;
    }
    
    /* ========== GRADIENTS ========== */
    .gradient-text {
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .gradient-text-green {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .gradient-text-blue {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .gradient-text-orange {
      background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    /* ========== STAT CARDS ========== */
    .stat-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    
    .stat-card-icon.purple { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); }
    .stat-card-icon.green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
    .stat-card-icon.blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
    .stat-card-icon.orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
    .stat-card-icon.pink { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
    
    /* ========== MODAL ========== */
    .modal-overlay { 
      background: rgba(15, 23, 42, 0.3); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    /* ========== SCROLLBAR ========== */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { 
      background: rgba(139, 92, 246, 0.25); 
      border-radius: 10px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { 
      background: rgba(139, 92, 246, 0.4); 
    }
    
    .filter-btn-active { 
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%) !important; 
      color: #7c3aed !important; 
      font-weight: 600 !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
    }
    
    /* ========== FLOATING DECORATIONS ========== */
    .floating-orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.2;
      pointer-events: none;
      z-index: -1;
    }
    .orb-1 { width: 400px; height: 400px; background: #c4b5fd; top: -150px; right: -150px; }
    .orb-2 { width: 350px; height: 350px; background: #99f6e4; bottom: -100px; left: -100px; }
    .orb-3 { width: 250px; height: 250px; background: #fde68a; top: 35%; left: 15%; }

    /* ========== MOBILE NAVIGATION ========== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      padding: 6px 8px;
      padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
      z-index: 100;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.06);
    }
    
    .bottom-nav button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 4px;
      border-radius: 14px;
      font-size: 10px;
      color: #94a3b8;
      background: transparent;
      border: none;
      cursor: pointer;
      min-height: 54px;
      transition: all 0.2s ease;
    }
    
    .bottom-nav button.active {
      color: #7c3aed;
      background: rgba(139, 92, 246, 0.08);
    }
    
    .bottom-nav button .icon { 
      font-size: 22px; 
      margin-bottom: 3px;
      transition: transform 0.2s ease;
    }
    
    .bottom-nav button.active .icon {
      transform: scale(1.1);
    }
    
    .bottom-nav button span:last-child { 
      font-weight: 500;
      font-size: 10px;
    }
    
    /* ========== MOBILE SLIDE MENU ========== */
    .mobile-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .mobile-menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 300px;
      max-width: 85vw;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 201;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 4px 0 30px rgba(0, 0, 0, 0.1);
    }
    
    .mobile-sidebar.active {
      transform: translateX(0);
    }
    
    .mobile-sidebar .menu-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(139, 92, 246, 0.02) 100%);
    }
    
    .mobile-sidebar nav button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      font-size: 15px;
      color: #374151;
      background: transparent;
      border: none;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    .mobile-sidebar nav button:active {
      background: rgba(139, 92, 246, 0.08);
    }
    
    .mobile-sidebar nav button span:first-child {
      font-size: 20px;
      width: 32px;
      text-align: center;
    }
    
    /* ========== DESKTOP SIDEBAR ========== */
    .desktop-sidebar {
      display: none !important;
    }
    
    @media (min-width: 768px) {
      .desktop-sidebar {
        display: flex !important;
        position: fixed;
        left: 16px;
        top: 16px;
        bottom: 16px;
        width: 200px;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.06);
        z-index: 40;
        overflow: hidden;
      }
      
      .sidebar-logo {
        padding: 24px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .sidebar-logo span {
        font-size: 32px;
      }
      
      .sidebar-nav {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .sidebar-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        color: #475569;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
        position: relative;
      }
      
      .sidebar-item:hover {
        background: rgba(139, 92, 246, 0.06);
        color: #6d28d9;
      }
      
      .sidebar-item.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.12) 0%, rgba(139, 92, 246, 0.06) 100%);
        color: #7c3aed;
      }
      
      .sidebar-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 20px;
        background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
        border-radius: 0 4px 4px 0;
      }
      
      .sidebar-icon {
        font-size: 18px;
        width: 24px;
        text-align: center;
        flex-shrink: 0;
      }
      
      .sidebar-label {
        font-size: 13px;
        white-space: nowrap;
      }
      
      .sidebar-divider {
        height: 1px;
        background: rgba(0, 0, 0, 0.04);
        margin: 8px 0;
      }
      
      .sidebar-logout {
        margin: 12px;
        color: #ef4444 !important;
      }
      
      .sidebar-logout:hover {
        background: rgba(239, 68, 68, 0.08) !important;
      }
    }
    
    /* ========== MAIN CONTENT ========== */
    .main-content {
      padding: 16px;
      padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px));
      min-height: 100vh;
      margin-left: 0 !important;
    }
    
    /* ========== RESPONSIVE GRIDS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    /* ========== TABLES ========== */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -16px;
      padding: 0 16px;
      border-radius: 16px;
    }
    
    .table-wrapper table {
      min-width: 500px;
      width: 100%;
    }
    
    .table-wrapper th,
    .table-wrapper td {
      padding: 12px 10px;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .table-wrapper th {
      background: rgba(139, 92, 246, 0.04);
      font-weight: 600;
      color: #475569;
    }
    
    .table-wrapper tr:hover td {
      background: rgba(139, 92, 246, 0.02);
    }
    
    /* ========== FUNNEL VISUALIZATION ========== */
    .funnel-step {
      padding: 12px 16px;
      border-radius: 12px;
      text-align: center;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
    }
    
    .funnel-step:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }
    
    .funnel-step .step-value {
      font-size: 24px;
      font-weight: 700;
      color: #7c3aed;
    }
    
    .funnel-step .step-label {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
    }
    
    /* ========== CHART CONTAINERS ========== */
    .chart-container {
      height: 200px;
      position: relative;
    }

    /* ========== DESKTOP STYLES ========== */
    @media (min-width: 768px) {
      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #ebeff5 30%, #e4e9f2 60%, #edf0f7 100%);
      }
      
      .bottom-nav {
        display: none !important;
      }
      
      .main-content {
        margin-left: 232px !important;
        padding: 24px 32px;
        padding-bottom: 32px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
      
      .chart-container {
        height: 280px;
      }
      
      .funnel-step .step-value {
        font-size: 28px;
      }
      
      .table-wrapper {
        margin: 0;
        padding: 0;
      }
      
      .table-wrapper th,
      .table-wrapper td {
        padding: 14px 16px;
        font-size: 14px;
      }
    }
    
    @media (min-width: 1200px) {
      .main-content {
        max-width: 1400px;
      }
    }
    
    /* ========== ACTION BUTTONS ========== */
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .action-btn:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.2);
    }
    
    .action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    /* ========== BADGES ========== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .badge-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }
    
    .badge-warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }
    
    .badge-info {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
    }
    
    .badge-purple {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      color: #5b21b6;
    }
    
    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.3s ease forwards;
    }
    
    /* ========== TABS ========== */
    .tab-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 500;
      font-size: 14px;
      color: #64748b;
      background: transparent;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .tab-btn:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
    }
  </style>
</head>
<body class="overflow-x-hidden">

<div class="floating-orb orb-1"></div>
<div class="floating-orb orb-2"></div>
<div class="floating-orb orb-3"></div>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
  <div class="glass-modal rounded-3xl p-6 md:p-8 max-w-md w-full">
    <div class="text-center mb-6 md:mb-8">
      <div class="w-14 h-14 md:w-16 md:h-16 glass-card rounded-2xl flex items-center justify-center mx-auto mb-4"><span class="text-2xl md:text-3xl">üöÄ</span></div>
      <h2 class="text-xl md:text-2xl font-bold text-gray-800">Xush kelibsiz!</h2>
      <p class="text-gray-500 mt-2 text-sm md:text-base">Admin panelga kirish</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <input type="text" id="username" class="w-full px-4 py-3 rounded-xl glass-input text-gray-700 text-base" placeholder="Login" required autocomplete="username">
      <input type="password" id="password" class="w-full px-4 py-3 rounded-xl glass-input text-gray-700 text-base" placeholder="Parol" required autocomplete="current-password">
      <button class="w-full py-3 rounded-xl glass-btn text-white font-semibold">Kirish</button>
      <p id="loginError" class="text-red-500 text-center text-sm hidden">Noto'g'ri login yoki parol</p>
    </form>
  </div>
</div>

<!-- Media Picker Modal -->
<div id="mediaPickerModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
    <div class="p-6 border-b border-white/30 flex justify-between items-center">
      <h2 class="font-bold text-xl text-gray-800">üìÅ Media kutubxonasi</h2>
      <button onclick="closeModal('mediaPickerModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6">
      <div class="flex gap-2 mb-4 flex-wrap">
        <button onclick="filterMediaPicker('all')" class="px-4 py-2 rounded-xl glass-card text-sm font-medium">Hammasi</button>
        <button onclick="filterMediaPicker('video')" class="px-4 py-2 rounded-xl glass-card text-sm text-blue-600">üìπ Video</button>
        <button onclick="filterMediaPicker('photo')" class="px-4 py-2 rounded-xl glass-card text-sm text-green-600">üñº Rasm</button>
        <button onclick="filterMediaPicker('audio')" class="px-4 py-2 rounded-xl glass-card text-sm text-orange-600">üéµ Audio</button>
      </div>
      <div id="mediaPickerList" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[50vh] overflow-y-auto scrollbar-thin"></div>
      <p id="mediaPickerEmpty" class="text-center text-gray-400 py-8 hidden">Media topilmadi</p>
    </div>
  </div>
</div>

<!-- User Modal -->
<div id="userModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üë§ Foydalanuvchi</h2>
      <button onclick="closeModal('userModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div id="userModalContent" class="p-6"></div>
  </div>
</div>

<!-- Lesson Modal -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[200] hidden p-2 sm:p-4">
  <div class="glass-modal rounded-2xl sm:rounded-3xl w-full max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-4 sm:p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-2xl sm:rounded-t-3xl z-10">
      <h2 class="font-bold text-lg sm:text-xl text-gray-800" id="lessonModalTitle">üìö Dars</h2>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full glass-card flex items-center justify-center text-lg">‚úï</button>
    </div>
    <div class="p-4 sm:p-6 space-y-4 sm:space-y-5">
      <input type="hidden" id="lessonId">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Dars nomi</label>
        <input type="text" id="lessonTitle" class="w-full px-4 py-3 rounded-xl glass-input">
      </div>
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Matn</label>
        <textarea id="lessonContent" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none"></textarea>
      </div>
      <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
          <label class="text-sm font-medium">üìπ Video</label>
          <button onclick="openMediaPicker('video', 'lessonVideo')" class="px-4 py-2 rounded-xl glass-btn text-white text-sm w-full sm:w-auto">üìÅ Kutubxonadan</button>
        </div>
        <input type="text" id="lessonVideo" class="w-full px-3 py-2 sm:px-4 sm:py-3 rounded-xl glass-input font-mono text-xs" placeholder="Video File ID">
      </div>
      <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
          <label class="text-sm font-medium">üñº Rasm</label>
          <button onclick="openMediaPicker('photo', 'lessonImage')" class="px-4 py-2 rounded-xl glass-btn-success text-white text-sm w-full sm:w-auto">üìÅ Kutubxonadan</button>
        </div>
        <input type="text" id="lessonImage" class="w-full px-3 py-2 sm:px-4 sm:py-3 rounded-xl glass-input font-mono text-xs" placeholder="Image File ID">
      </div>
      <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
          <label class="text-sm font-medium">üé§ Audio</label>
          <button onclick="openMediaPicker('audio', 'lessonAudio')" class="px-4 py-2 rounded-xl glass-btn text-white text-sm w-full sm:w-auto">üìÅ Kutubxonadan</button>
        </div>
        <input type="text" id="lessonAudio" class="w-full px-3 py-2 sm:px-4 sm:py-3 rounded-xl glass-input font-mono text-xs" placeholder="Audio File ID">
      </div>
      <div class="glass-card rounded-xl sm:rounded-2xl p-4 sm:p-5">
        <label class="text-sm font-medium mb-3 block">‚è± Keyingi darsga o'tish vaqti</label>
        <div class="space-y-2">
          <label class="flex items-center gap-3 cursor-pointer p-2 sm:p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="delayType" id="delayImmediate" value="immediate" checked onchange="toggleDelayInput()" class="w-5 h-5 accent-violet-500">
            <span class="font-medium text-sm sm:text-base">üöÄ Darhol yuborilsin</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer p-2 sm:p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="delayType" id="delayTimed" value="timed" onchange="toggleDelayInput()" class="w-5 h-5 accent-violet-500">
            <span class="font-medium text-sm sm:text-base">‚è∞ Vaqt belgilash</span>
          </label>
          <div id="delayInputDiv" class="hidden pl-4 sm:pl-8 pt-2">
            <div class="flex gap-2 sm:gap-3">
              <input type="number" id="lessonDelayValue" class="w-20 sm:w-24 px-3 py-2 sm:px-4 sm:py-3 rounded-xl glass-input" value="24" min="1">
              <select id="lessonDelayUnit" class="flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-xl glass-input">
                <option value="hours" selected>Soat</option>
                <option value="days">Kun</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3 p-3 sm:p-4 glass-card rounded-xl">
        <input type="checkbox" id="lessonShowBtn" checked class="w-5 h-5 accent-violet-500">
        <label class="font-medium text-sm sm:text-base">"Ko'rib bo'ldim" tugmasini ko'rsatish</label>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Tugma matni</label>
        <input type="text" id="lessonBtnText" class="w-full px-4 py-3 rounded-xl glass-input" value="Videoni ko'rib bo'ldim ‚úÖ">
      </div>
      <button onclick="saveLesson()" class="w-full py-3 sm:py-4 rounded-xl glass-btn text-white font-semibold text-base sm:text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800" id="custdevModalTitle">üìù Savol</h2>
      <button onclick="closeModal('custdevModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Savol matni</label>
        <textarea id="custdevText" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none"></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-gray-600 mb-2 block">Qaysi darsdan keyin</label>
          <input type="number" id="custdevLesson" class="w-full px-4 py-3 rounded-xl glass-input" value="1" min="1">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-600 mb-2 block">Turi</label>
          <select id="custdevType" class="w-full px-4 py-3 rounded-xl glass-input" onchange="toggleCustdevOptions()">
            <option value="buttons">Tugmalar</option>
            <option value="text">Matn</option>
          </select>
        </div>
      </div>
      <div id="custdevOptionsDiv">
        <label class="text-sm font-medium text-gray-600 mb-2 block">Javob variantlari</label>
        <textarea id="custdevOptions" rows="4" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="16-22&#10;23-30&#10;31-40"></textarea>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Bazada saqlash (field_name)</label>
        <input type="text" id="custdevField" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="age_group">
      </div>
      <button onclick="saveCustDev()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Pitch Modal -->
<div id="pitchModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üé¨ Darsdan keyingi xabar</h2>
      <button onclick="closeModal('pitchModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Matn</label>
        <textarea id="pitchText" rows="4" class="w-full px-4 py-3 rounded-xl glass-input resize-none"></textarea>
      </div>
      <div class="glass-card rounded-2xl p-5">
        <div class="flex justify-between items-center mb-3">
          <label class="text-sm font-medium">üìπ Video</label>
          <button onclick="openMediaPicker('video', 'pitchVideo')" class="px-4 py-2 rounded-xl glass-btn text-white text-sm">üìÅ Kutubxonadan</button>
        </div>
        <input type="text" id="pitchVideo" class="w-full px-4 py-3 rounded-xl glass-input font-mono text-xs">
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="glass-card rounded-2xl p-4">
          <label class="text-sm font-medium mb-2 block">üñº Rasm</label>
          <input type="text" id="pitchImage" class="w-full px-3 py-2 rounded-lg glass-input font-mono text-xs">
        </div>
        <div class="glass-card rounded-2xl p-4">
          <label class="text-sm font-medium mb-2 block">üé§ Audio</label>
          <input type="text" id="pitchAudio" class="w-full px-3 py-2 rounded-lg glass-input font-mono text-xs">
        </div>
      </div>
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Kutish (soat)</label>
        <input type="number" id="pitchDelay" class="w-full px-4 py-3 rounded-xl glass-input" value="2">
      </div>
      <button onclick="savePitch()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Create/Edit Funnel Modal -->
<div id="funnelModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800" id="funnelModalTitle">üéØ Yangi varonka</h2>
      <button onclick="closeModal('funnelModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="funnelId">
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Varonka nomi *</label>
        <input type="text" id="funnelName" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="SMM Pro Kurs">
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Slug (URL uchun) *</label>
        <div class="flex items-center gap-2">
          <span class="text-gray-400 text-sm">t.me/bot?start=</span>
          <input type="text" id="funnelSlug" class="flex-1 px-4 py-3 rounded-xl glass-input font-mono" placeholder="smm-pro" oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '')">
        </div>
        <p class="text-xs text-gray-400 mt-1">Faqat kichik harflar, raqamlar va chiziqcha (-)</p>
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Tavsif</label>
        <textarea id="funnelDescription" rows="2" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="Bu varonka haqida qisqa ma'lumot"></textarea>
      </div>
      
      <div class="flex items-center gap-3 p-4 glass rounded-xl">
        <input type="checkbox" id="funnelIsDefault" class="w-5 h-5 accent-violet-500">
        <div>
          <label for="funnelIsDefault" class="font-medium cursor-pointer">Default varonka</label>
          <p class="text-xs text-gray-500">/start bosilganda shu varonka ishga tushadi</p>
        </div>
      </div>
      
      <button onclick="saveFunnel()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Funnel Lesson Modal -->
<div id="funnelLessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[60] hidden">
  <div class="glass-modal rounded-3xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-white/30 flex justify-between items-center">
      <h2 class="font-bold text-xl text-gray-800" id="funnelLessonModalTitle">üìö Dars qo'shish</h2>
      <button onclick="closeModal('funnelLessonModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="funnelLessonId">
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Dars raqami *</label>
        <input type="number" id="funnelLessonNumber" class="w-full px-4 py-3 rounded-xl glass-input" min="1" value="1">
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Dars sarlavhasi *</label>
        <input type="text" id="funnelLessonTitle" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="SMM nima?">
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Dars matni</label>
        <textarea id="funnelLessonContent" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="Dars matni..."></textarea>
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Video (file_id)</label>
        <input type="text" id="funnelLessonVideo" class="w-full px-4 py-3 rounded-xl glass-input font-mono text-sm" placeholder="Video file_id">
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Delay (soat)</label>
        <input type="number" id="funnelLessonDelay" class="w-full px-4 py-3 rounded-xl glass-input" value="0" min="0">
        <p class="text-xs text-gray-400 mt-1">0 = darhol yuboriladi</p>
      </div>
      
      <button onclick="saveFunnelLesson()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Funnel CustDev Modal -->
<div id="funnelCustDevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[60] hidden">
  <div class="glass-modal rounded-3xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-white/30 flex justify-between items-center">
      <h2 class="font-bold text-xl text-gray-800">üìù CustDev savol qo'shish</h2>
      <button onclick="closeModal('funnelCustDevModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Savol matni *</label>
        <textarea id="funnelCustDevQuestion" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="Yoshingiz nechada?"></textarea>
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Qaysi darsdan keyin?</label>
        <input type="number" id="funnelCustDevAfterLesson" class="w-full px-4 py-3 rounded-xl glass-input" value="1" min="1">
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Savol turi</label>
        <select id="funnelCustDevType" class="w-full px-4 py-3 rounded-xl glass-input">
          <option value="text">Matn (foydalanuvchi yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      
      <div id="funnelCustDevOptionsDiv" class="hidden">
        <label class="text-sm font-medium text-gray-600 mb-2 block">Tugma variantlari (har qator - bitta tugma)</label>
        <textarea id="funnelCustDevOptions" rows="4" class="w-full px-4 py-3 rounded-xl glass-input resize-none font-mono text-sm" placeholder="18-25&#10;26-35&#10;36-45&#10;46+"></textarea>
      </div>
      
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Field nomi (ixtiyoriy)</label>
        <input type="text" id="funnelCustDevField" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="age_group">
        <p class="text-xs text-gray-400 mt-1">Javob user profilida shu nom bilan saqlanadi</p>
      </div>
      
      <button onclick="saveFunnelCustDev()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Funnel Detail Modal -->
<div id="funnelDetailModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl z-10">
      <div>
        <h2 class="font-bold text-xl text-gray-800" id="funnelDetailTitle">üéØ Varonka</h2>
        <p class="text-sm text-gray-500" id="funnelDetailSlug">t.me/bot?start=slug</p>
      </div>
      <button onclick="closeModal('funnelDetailModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6">
      <!-- Tabs -->
      <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <button onclick="showFunnelTab('lessons')" id="funnel-tab-lessons" class="px-4 py-2 rounded-xl bg-violet-500 text-white font-medium whitespace-nowrap">üìö Darslar</button>
        <button onclick="showFunnelTab('custdev')" id="funnel-tab-custdev" class="px-4 py-2 rounded-xl glass-card font-medium whitespace-nowrap">üìù CustDev</button>
        <button onclick="showFunnelTab('pitch')" id="funnel-tab-pitch" class="px-4 py-2 rounded-xl glass-card font-medium whitespace-nowrap">üé¨ Pitch</button>
        <button onclick="showFunnelTab('settings')" id="funnel-tab-settings" class="px-4 py-2 rounded-xl glass-card font-medium whitespace-nowrap">‚öôÔ∏è Sozlamalar</button>
        <button onclick="showFunnelTab('stats')" id="funnel-tab-stats" class="px-4 py-2 rounded-xl glass-card font-medium whitespace-nowrap">üìä Statistika</button>
      </div>
      
      <!-- Lessons Tab -->
      <div id="funnel-content-lessons">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-lg">üìö Darslar</h3>
          <button onclick="addFunnelLesson()" class="px-4 py-2 rounded-xl glass-btn text-white text-sm">+ Dars qo'shish</button>
        </div>
        <div id="funnelLessonsList" class="space-y-2">
          <p class="text-gray-400 text-center py-4">Darslar yuklanmoqda...</p>
        </div>
      </div>
      
      <!-- CustDev Tab -->
      <div id="funnel-content-custdev" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-lg">üìù CustDev savollari</h3>
          <button onclick="addFunnelCustDev()" class="px-4 py-2 rounded-xl glass-btn text-white text-sm">+ Savol qo'shish</button>
        </div>
        <div id="funnelCustDevList" class="space-y-2">
          <p class="text-gray-400 text-center py-4">Savollar yuklanmoqda...</p>
        </div>
      </div>
      
      <!-- Pitch Tab -->
      <div id="funnel-content-pitch" class="hidden">
        <h3 class="font-bold text-lg mb-4">üé¨ Pitch sozlamalari</h3>
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-gray-600 mb-2 block">Qaysi darsdan keyin pitch yuborilsin?</label>
            <input type="number" id="funnelPitchAfterLesson" class="w-full px-4 py-3 rounded-xl glass-input" value="4" min="1">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600 mb-2 block">Pitch matni</label>
            <textarea id="funnelPitchText" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="Maxsus taklif!"></textarea>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600 mb-2 block">Pitch video (file_id)</label>
            <input type="text" id="funnelPitchVideo" class="w-full px-4 py-3 rounded-xl glass-input font-mono text-sm" placeholder="Video file_id">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600 mb-2 block">Pitch delay (soat)</label>
            <input type="number" id="funnelPitchDelay" class="w-full px-4 py-3 rounded-xl glass-input" value="2" min="0">
          </div>
          <button onclick="saveFunnelPitch()" class="w-full py-3 rounded-xl glass-btn text-white font-medium">üíæ Pitch saqlash</button>
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="funnel-content-settings" class="hidden">
        <h3 class="font-bold text-lg mb-4">‚öôÔ∏è Varonka sozlamalari</h3>
        <div class="space-y-4">
          <!-- Kanal sozlamalari -->
          <div class="glass rounded-2xl p-4">
            <h4 class="font-medium mb-3">üì¢ Kanal sozlamalari</h4>
            <div class="space-y-3">
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">Premium kanal ID</label>
                <input type="text" id="funnelPremiumChannelId" class="w-full px-4 py-3 rounded-xl glass-input font-mono" placeholder="-1001234567890">
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">Bepul kanal ID (majburiy obuna)</label>
                <input type="text" id="funnelFreeChannelId" class="w-full px-4 py-3 rounded-xl glass-input font-mono" placeholder="-1001234567890">
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">Bepul kanal linki</label>
                <input type="text" id="funnelFreeChannelLink" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="https://t.me/channel">
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">Obuna nechanchi darsdan oldin talab qilinsin?</label>
                <input type="number" id="funnelRequireSubBefore" class="w-full px-4 py-3 rounded-xl glass-input" value="0" min="0">
                <p class="text-xs text-gray-400 mt-1">0 = talab qilinmaydi</p>
              </div>
            </div>
          </div>
          
          <!-- To'lov tizimlari -->
          <div class="glass rounded-2xl p-4">
            <h4 class="font-medium mb-3">üí≥ To'lov tizimlari</h4>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="funnelPaymeEnabled" class="w-5 h-5 accent-blue-500">
                <label for="funnelPaymeEnabled" class="font-medium cursor-pointer">üí≥ Payme</label>
              </div>
              <div class="flex items-center gap-3">
                <input type="checkbox" id="funnelClickEnabled" class="w-5 h-5 accent-green-500">
                <label for="funnelClickEnabled" class="font-medium cursor-pointer">üí† Click</label>
              </div>
              <p class="text-xs text-gray-400">Tanlangan to'lov tizimlari tugmalari foydalanuvchiga ko'rsatiladi</p>
            </div>
          </div>
          
          <!-- Narxlar -->
          <div class="glass rounded-2xl p-4">
            <h4 class="font-medium mb-3">üí∞ Narxlar (so'm)</h4>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-500">1 oylik</label>
                <input type="number" id="funnelPrice1m" class="w-full px-3 py-2 rounded-xl glass-input" placeholder="97000">
              </div>
              <div>
                <label class="text-xs text-gray-500">3 oylik</label>
                <input type="number" id="funnelPrice3m" class="w-full px-3 py-2 rounded-xl glass-input" placeholder="247000">
              </div>
              <div>
                <label class="text-xs text-gray-500">6 oylik</label>
                <input type="number" id="funnelPrice6m" class="w-full px-3 py-2 rounded-xl glass-input" placeholder="447000">
              </div>
              <div>
                <label class="text-xs text-gray-500">12 oylik</label>
                <input type="number" id="funnelPrice12m" class="w-full px-3 py-2 rounded-xl glass-input" placeholder="797000">
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-2">Bo'sh qoldirilsa, umumiy narxlar ishlatiladi</p>
          </div>
          
          <button onclick="saveFunnelSettings()" class="w-full py-3 rounded-xl glass-btn text-white font-medium">üíæ Sozlamalarni saqlash</button>
        </div>
      </div>
      
      <!-- Stats Tab -->
      <div id="funnel-content-stats" class="hidden">
        <h3 class="font-bold text-lg mb-4">üìä Statistika</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="glass rounded-2xl p-4 text-center">
            <p class="text-2xl font-bold text-violet-600" id="funnelStatTotal">0</p>
            <p class="text-xs text-gray-500">Jami userlar</p>
          </div>
          <div class="glass rounded-2xl p-4 text-center">
            <p class="text-2xl font-bold text-blue-600" id="funnelStatActive">0</p>
            <p class="text-xs text-gray-500">Aktiv</p>
          </div>
          <div class="glass rounded-2xl p-4 text-center">
            <p class="text-2xl font-bold text-green-600" id="funnelStatPaid">0</p>
            <p class="text-xs text-gray-500">To'lagan</p>
          </div>
          <div class="glass rounded-2xl p-4 text-center">
            <p class="text-2xl font-bold text-orange-600" id="funnelStatConversion">0%</p>
            <p class="text-xs text-gray-500">Konversiya</p>
          </div>
        </div>
        <div id="funnelLessonStats" class="glass rounded-2xl p-4">
          <p class="text-gray-400 text-center">Darslar bo'yicha statistika</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Broadcast Modal -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üì® Xabar yuborish (Broadcast)</h2>
      <button onclick="closeModal('broadcastModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <!-- Audience Selection -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üéØ Kimga yuborish</h4>
        
        <!-- Quick filters -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button onclick="setBroadcastQuickFilter('all')" id="bf-all" class="px-4 py-2 rounded-xl glass text-sm font-medium bf-active">üë• Hammaga</button>
          <button onclick="setBroadcastQuickFilter('paid')" id="bf-paid" class="px-4 py-2 rounded-xl glass text-sm font-medium">üíé Premium</button>
          <button onclick="setBroadcastQuickFilter('free')" id="bf-free" class="px-4 py-2 rounded-xl glass text-sm font-medium">üÜì Free</button>
          <button onclick="setBroadcastQuickFilter('custom')" id="bf-custom" class="px-4 py-2 rounded-xl glass text-sm font-medium">‚öôÔ∏è Maxsus filter</button>
        </div>
        
        <!-- Advanced filters (hidden by default) -->
        <div id="broadcastAdvancedFilters" class="hidden space-y-4 pt-4 border-t border-gray-200">
          <div class="grid grid-cols-2 gap-4">
            <!-- Status filter -->
            <div>
              <label class="text-sm font-medium text-gray-600 mb-2 block">üìä Status</label>
              <select id="bfStatus" class="w-full px-4 py-3 rounded-xl glass-input">
                <option value="all">Hammasi</option>
                <option value="paid">üíé Faqat Premium</option>
                <option value="free">üÜì Faqat Free</option>
              </select>
            </div>
            
            <!-- Lesson filter -->
            <div>
              <label class="text-sm font-medium text-gray-600 mb-2 block">üìö Dars bo'yicha</label>
              <select id="bfLesson" class="w-full px-4 py-3 rounded-xl glass-input">
                <option value="all">Barcha darslar</option>
                <option value="0">0-dars (yangi)</option>
                <option value="1">1-dars</option>
                <option value="2">2-dars</option>
                <option value="3">3-dars</option>
                <option value="4">4-dars</option>
                <option value="completed">‚úÖ Darslarni tugatgan</option>
              </select>
            </div>
            
            <!-- CustDev filter -->
            <div>
              <label class="text-sm font-medium text-gray-600 mb-2 block">üìù CustDev</label>
              <select id="bfCustdev" class="w-full px-4 py-3 rounded-xl glass-input">
                <option value="all">Hammasi</option>
                <option value="completed">‚úÖ To'ldirgan</option>
                <option value="not">‚è≥ To'ldirmagan</option>
              </select>
            </div>
            
            <!-- Date filter -->
            <div>
              <label class="text-sm font-medium text-gray-600 mb-2 block">üìÖ Ro'yxatdan o'tgan</label>
              <select id="bfDate" class="w-full px-4 py-3 rounded-xl glass-input">
                <option value="all">Barcha vaqt</option>
                <option value="today">Bugun</option>
                <option value="week">Shu hafta</option>
                <option value="month">Shu oy</option>
                <option value="old">1 oydan oldin</option>
              </select>
            </div>
          </div>
          
          <!-- Age group filter -->
          <div>
            <label class="text-sm font-medium text-gray-600 mb-2 block">üë§ Yosh guruhi</label>
            <div class="flex flex-wrap gap-2">
              <label class="flex items-center gap-2 px-3 py-2 rounded-lg glass cursor-pointer">
                <input type="checkbox" id="bfAge-all" checked onchange="toggleAgeFilter(this)" class="accent-violet-500"> Hammasi
              </label>
              <label class="flex items-center gap-2 px-3 py-2 rounded-lg glass cursor-pointer">
                <input type="checkbox" class="bfAge accent-violet-500" value="16-22"> 16-22
              </label>
              <label class="flex items-center gap-2 px-3 py-2 rounded-lg glass cursor-pointer">
                <input type="checkbox" class="bfAge accent-violet-500" value="23-30"> 23-30
              </label>
              <label class="flex items-center gap-2 px-3 py-2 rounded-lg glass cursor-pointer">
                <input type="checkbox" class="bfAge accent-violet-500" value="31-40"> 31-40
              </label>
              <label class="flex items-center gap-2 px-3 py-2 rounded-lg glass cursor-pointer">
                <input type="checkbox" class="bfAge accent-violet-500" value="40+"> 40+
              </label>
            </div>
          </div>
        </div>
        
        <!-- Audience count -->
        <div class="mt-4 p-3 rounded-xl bg-violet-50 flex justify-between items-center">
          <span class="text-sm text-gray-600">Tanlangan auditoriya:</span>
          <span id="broadcastAudienceCount" class="font-bold text-violet-700">0 ta</span>
        </div>
      </div>
      
      <!-- Message Content -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">‚úâÔ∏è Xabar matni</h4>
        <textarea id="broadcastText" rows="5" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="Salom {{ism}}! Sizga maxsus taklif..."></textarea>
        
        <div class="mt-3 p-3 rounded-xl bg-blue-50">
          <p class="text-xs font-semibold text-blue-700 mb-2">üìù O'zgaruvchilar:</p>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
            <div class="bg-white/70 rounded-lg p-2 cursor-pointer hover:bg-white" onclick="insertVar('{{fio}}')"><code class="text-violet-600">{{fio}}</code> - To'liq ism</div>
            <div class="bg-white/70 rounded-lg p-2 cursor-pointer hover:bg-white" onclick="insertVar('{{ism}}')"><code class="text-violet-600">{{ism}}</code> - Ism</div>
            <div class="bg-white/70 rounded-lg p-2 cursor-pointer hover:bg-white" onclick="insertVar('{{telefon}}')"><code class="text-violet-600">{{telefon}}</code> - Telefon</div>
            <div class="bg-white/70 rounded-lg p-2 cursor-pointer hover:bg-white" onclick="insertVar('{{dars}}')"><code class="text-violet-600">{{dars}}</code> - Dars</div>
          </div>
        </div>
      </div>
      
      <!-- Media -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üìé Media (ixtiyoriy)</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-500 mb-2 block">üñº Rasm</label>
            <div class="flex gap-2">
              <input type="text" id="broadcastPhoto" class="flex-1 px-4 py-3 rounded-xl glass-input" placeholder="URL yoki File ID">
              <button onclick="openMediaPicker('photo', 'broadcastPhoto')" class="px-4 py-3 rounded-xl glass-btn text-white text-sm">üìÅ</button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-500 mb-2 block">üìπ Video</label>
            <div class="flex gap-2">
              <input type="text" id="broadcastVideo" class="flex-1 px-4 py-3 rounded-xl glass-input" placeholder="File ID">
              <button onclick="openMediaPicker('video', 'broadcastVideo')" class="px-4 py-3 rounded-xl glass-btn text-white text-sm">üìÅ</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Buttons -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üîò Tugma qo'shish (ixtiyoriy)</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-500 mb-2 block">Tugma matni</label>
            <input type="text" id="broadcastBtnText" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="Batafsil ‚Üí">
          </div>
          <div>
            <label class="text-sm text-gray-500 mb-2 block">Tugma URL</label>
            <input type="text" id="broadcastBtnUrl" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="https://...">
          </div>
        </div>
      </div>
      
      <!-- Schedule -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">‚è∞ Qachon yuborish</h4>
        <div class="space-y-3">
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="broadcastSchedule" value="now" checked class="w-5 h-5 accent-violet-500">
            <span class="font-medium">üöÄ Hozir yuborish</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="broadcastSchedule" value="scheduled" class="w-5 h-5 accent-violet-500" onchange="toggleScheduleInput()">
            <span class="font-medium">üìÖ Vaqt belgilash</span>
          </label>
          <div id="broadcastScheduleDiv" class="hidden pl-8">
            <input type="datetime-local" id="broadcastScheduleTime" class="px-4 py-3 rounded-xl glass-input">
          </div>
        </div>
      </div>
      
      <!-- Result -->
      <div id="broadcastResult" class="hidden p-4 rounded-xl"></div>
      
      <!-- Action buttons -->
      <div class="flex gap-3">
        <button onclick="previewBroadcast()" class="flex-1 py-4 rounded-xl glass text-gray-700 font-semibold">üëÅ Ko'rish</button>
        <button onclick="sendBroadcast()" id="broadcastBtn" class="flex-1 py-4 rounded-xl glass-btn-success text-white font-semibold text-lg">üì§ Yuborish</button>
      </div>
    </div>
  </div>
</div>

<!-- Buyer Detail Modal -->
<div id="buyerModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üë§ Xaridor ma'lumotlari</h2>
      <button onclick="closeModal('buyerModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <!-- User Info -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üìã Asosiy ma'lumotlar</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500">üë§ Ism</p>
            <p id="buyerName" class="font-medium">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üì± Telefon</p>
            <p id="buyerPhone" class="font-medium">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üí¨ Username</p>
            <p id="buyerUsername" class="font-medium">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üÜî Telegram ID</p>
            <p id="buyerTelegramId" class="font-medium">-</p>
          </div>
        </div>
      </div>
      
      <!-- Payment Info -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üí≥ To'lov ma'lumotlari</h4>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500">üí∞ Summa</p>
            <p id="buyerAmount" class="font-bold text-green-600">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üè¶ To'lov usuli</p>
            <p id="buyerMethod" class="font-medium">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üìÖ To'lov sanasi</p>
            <p id="buyerPaymentDate" class="font-medium">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">‚úÖ Holat</p>
            <p id="buyerStatus" class="font-medium">-</p>
          </div>
        </div>
      </div>
      
      <!-- Time Analysis -->
      <div class="glass-card rounded-2xl p-5 bg-gradient-to-r from-violet-500/10 to-purple-500/10">
        <h4 class="font-semibold mb-4 flex items-center gap-2">‚è± Vaqt tahlili</h4>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-xs text-gray-500">üì• Ro'yxatdan o'tgan</p>
            <p id="buyerRegistered" class="font-medium text-sm">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">üí≥ Sotib olgan</p>
            <p id="buyerPurchased" class="font-medium text-sm">-</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">‚è≥ Ketgan vaqt</p>
            <p id="buyerTimeToPurchase" class="font-bold text-lg text-violet-600">-</p>
          </div>
        </div>
      </div>
      
      <!-- CustDev Data -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2">üìä CustDev javoblari</h4>
        <div id="buyerCustdevData" class="space-y-3">
          <p class="text-gray-400 text-center">Ma'lumot yo'q</p>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="flex gap-3">
        <a id="buyerTelegramLink" href="#" target="_blank" class="flex-1 px-4 py-3 rounded-xl glass-btn text-white text-center font-medium">üí¨ Telegram'da yozish</a>
        <button onclick="closeModal('buyerModal')" class="px-6 py-3 rounded-xl glass text-gray-700 font-medium">Yopish</button>
      </div>
    </div>
  </div>
</div>

<!-- Post-Lesson Flow Modal -->
<div id="postLessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üéØ Darsdan keyingi oqim</h2>
      <button onclick="closeModal('postLessonModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <!-- 1. Tabriklov -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2"><span class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm">1</span> Tabriklov xabari</h4>
        <textarea id="plCongrats" rows="3" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="üéâ Tabriklayman! Barcha bepul darslarni tugatdingiz!"></textarea>
        <p class="text-xs text-gray-400 mt-2">‚ö° Darhol yuboriladi</p>
      </div>
      
      <!-- 2. Pitch -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2"><span class="w-8 h-8 rounded-full bg-violet-500 text-white flex items-center justify-center text-sm">2</span> Pitch xabari</h4>
        <div class="space-y-3">
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plPitchType" value="immediate" onchange="togglePlPitchDelay()" class="w-5 h-5 accent-violet-500">
            <span class="font-medium">üöÄ Darhol yuborilsin</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plPitchType" value="timed" checked onchange="togglePlPitchDelay()" class="w-5 h-5 accent-violet-500">
            <span class="font-medium">‚è∞ Vaqt belgilash</span>
          </label>
          <div id="plPitchDelayDiv" class="pl-8 flex gap-3">
            <input type="number" id="plPitchDelay" class="w-24 px-4 py-3 rounded-xl glass-input" value="2" min="1">
            <span class="py-3 text-gray-600">soatdan keyin</span>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">üìù Pitch matni va media "Pitch xabar" bo'limidan sozlanadi</p>
      </div>
      
      <!-- 3. To'lov -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2"><span class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm">3</span> To'lov tugmalari</h4>
        <div class="space-y-3">
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plSalesType" value="immediate" onchange="togglePlSalesDelay()" class="w-5 h-5 accent-blue-500">
            <span class="font-medium">üöÄ Darhol yuborilsin (pitch bilan birga)</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plSalesType" value="timed" checked onchange="togglePlSalesDelay()" class="w-5 h-5 accent-blue-500">
            <span class="font-medium">‚è∞ Vaqt belgilash</span>
          </label>
          <div id="plSalesDelayDiv" class="pl-8 flex gap-3">
            <input type="number" id="plSalesDelay" class="w-24 px-4 py-3 rounded-xl glass-input" value="1" min="1">
            <span class="py-3 text-gray-600">soat (pitch dan keyin)</span>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">üìù To'lov matni "To'lov xabari" bo'limidan sozlanadi</p>
      </div>
      
      <!-- 4. Soft Attack -->
      <div class="glass-card rounded-2xl p-5">
        <h4 class="font-semibold mb-4 flex items-center gap-2"><span class="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center text-sm">4</span> Eslatma (Soft Attack)</h4>
        <div class="space-y-3">
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plSoftType" value="disabled" onchange="togglePlSoftDelay()" class="w-5 h-5 accent-orange-500">
            <span class="font-medium">‚ùå Yuborilmasin</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/30">
            <input type="radio" name="plSoftType" value="timed" checked onchange="togglePlSoftDelay()" class="w-5 h-5 accent-orange-500">
            <span class="font-medium">‚è∞ Vaqt belgilash</span>
          </label>
          <div id="plSoftDelayDiv" class="pl-8 flex gap-3">
            <input type="number" id="plSoftDelay" class="w-24 px-4 py-3 rounded-xl glass-input" value="24" min="1">
            <span class="py-3 text-gray-600">soat (to'lov dan keyin)</span>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">‚ö†Ô∏è Faqat to'lamagan foydalanuvchilarga yuboriladi</p>
      </div>
      
      <button onclick="savePostLessonFlow()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Sales Message Modal -->
<div id="salesMessageModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üí≥ To'lov xabari</h2>
      <button onclick="closeModal('salesMessageModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Xabar matni</label>
        <textarea id="salesText" rows="5" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="SMM PRO KURSGA TAKLIF!"></textarea>
      </div>
      <div class="glass-card rounded-2xl p-4">
        <p class="text-sm font-semibold text-violet-700 mb-2">üìù O'zgaruvchilar:</p>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-white/50 rounded-lg p-2"><code class="text-violet-600">{{ism}}</code> - Faqat ism</div>
          <div class="bg-white/50 rounded-lg p-2"><code class="text-violet-600">{{price}}</code> - Narx</div>
        </div>
      </div>
      <p class="text-xs text-gray-400">üí° Payme va Click tugmalari avtomatik qo'shiladi</p>
      <button onclick="saveSalesMessage()" class="w-full py-4 rounded-xl glass-btn-success text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Soft Attack Modal -->
<div id="softAttackModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="glass-modal rounded-3xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto scrollbar-thin">
    <div class="p-6 border-b border-white/30 flex justify-between items-center sticky top-0 glass-modal rounded-t-3xl">
      <h2 class="font-bold text-xl text-gray-800">üîî Eslatma xabari</h2>
      <button onclick="closeModal('softAttackModal')" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>
    </div>
    <div class="p-6 space-y-5">
      <div>
        <label class="text-sm font-medium text-gray-600 mb-2 block">Xabar matni</label>
        <textarea id="softAttackText" rows="5" class="w-full px-4 py-3 rounded-xl glass-input resize-none" placeholder="ü§î Hali qaror qilmadingizmi?"></textarea>
      </div>
      <div class="glass-card rounded-2xl p-4">
        <p class="text-sm font-semibold text-violet-700 mb-2">üìù O'zgaruvchilar:</p>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="bg-white/50 rounded-lg p-2"><code class="text-violet-600">{{ism}}</code> - Faqat ism</div>
          <div class="bg-white/50 rounded-lg p-2"><code class="text-violet-600">{{price}}</code> - Narx</div>
        </div>
      </div>
      <p class="text-xs text-gray-400">‚ö†Ô∏è Faqat to'lamagan foydalanuvchilarga yuboriladi. Payme va Click tugmalari avtomatik qo'shiladi.</p>
      <button onclick="saveSoftAttack()" class="w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Saqlash</button>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden min-h-screen">
  <div class="flex">
    <!-- Desktop Sidebar -->
    <aside class="desktop-sidebar">
      <div class="sidebar-logo">
        <span>üöÄ</span>
      </div>
      
      <nav class="sidebar-nav">
        <button type="button" data-action="show-tab" data-id="stats" id="tab-stats" class="sidebar-item active" title="Statistika">
          <span class="sidebar-icon">üìä</span>
          <span class="sidebar-label">Statistika</span>
        </button>
        <button type="button" data-action="show-tab" data-id="funnels" id="tab-funnels" class="sidebar-item" title="Varonkalar">
          <span class="sidebar-icon">üéØ</span>
          <span class="sidebar-label">Varonkalar</span>
        </button>
        <button type="button" data-action="show-tab" data-id="payments" id="tab-payments" class="sidebar-item" title="To'lovlar">
          <span class="sidebar-icon">üí∞</span>
          <span class="sidebar-label">To'lovlar</span>
        </button>
        <button type="button" data-action="show-tab" data-id="users" id="tab-users" class="sidebar-item" title="Foydalanuvchilar">
          <span class="sidebar-icon">üë•</span>
          <span class="sidebar-label">Userlar</span>
        </button>
        
        <div class="sidebar-divider"></div>
        
        <button type="button" data-action="show-tab" data-id="lessons" id="tab-lessons" class="sidebar-item" title="Darslar">
          <span class="sidebar-icon">üìö</span>
          <span class="sidebar-label">Darslar</span>
        </button>
        <button type="button" data-action="show-tab" data-id="media" id="tab-media" class="sidebar-item" title="Media">
          <span class="sidebar-icon">üìÅ</span>
          <span class="sidebar-label">Media</span>
        </button>
        <button type="button" data-action="show-tab" data-id="custdev" id="tab-custdev" class="sidebar-item" title="CustDev">
          <span class="sidebar-icon">üìù</span>
          <span class="sidebar-label">CustDev</span>
        </button>
        <button type="button" data-action="show-tab" data-id="feedback" id="tab-feedback" class="sidebar-item" title="Fikrlar">
          <span class="sidebar-icon">üí¨</span>
          <span class="sidebar-label">Fikrlar</span>
        </button>
        
        <div class="sidebar-divider"></div>
        
        <button type="button" data-action="show-tab" data-id="settings" id="tab-settings" class="sidebar-item" title="Sozlamalar">
          <span class="sidebar-icon">‚öôÔ∏è</span>
          <span class="sidebar-label">Sozlamalar</span>
        </button>
      </nav>
      
      <button type="button" onclick="logout()" class="sidebar-item sidebar-logout" title="Chiqish">
        <span class="sidebar-icon">üö™</span>
        <span class="sidebar-label">Chiqish</span>
      </button>
    </aside>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
      <button type="button" data-action="show-tab" data-id="stats" id="mob-tab-stats" class="active">
        <span class="icon">üìä</span>
        <span>Statistika</span>
      </button>
      <button type="button" data-action="show-tab" data-id="payments" id="mob-tab-payments">
        <span class="icon">üí∞</span>
        <span>To'lovlar</span>
      </button>
      <button type="button" data-action="show-tab" data-id="users" id="mob-tab-users">
        <span class="icon">üë•</span>
        <span>Userlar</span>
      </button>
      <button type="button" data-action="show-tab" data-id="settings" id="mob-tab-settings">
        <span class="icon">‚öôÔ∏è</span>
        <span>Sozlamalar</span>
      </button>
      <button type="button" onclick="toggleMobileMenu()" id="mob-tab-more">
        <span class="icon">‚ò∞</span>
        <span>Ko'proq</span>
      </button>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay fixed inset-0 bg-black/30 z-50 hidden" onclick="closeMobileMenu()"></div>
    
    <!-- Mobile Slide Menu -->
    <div id="mobileSlideMenu" class="mobile-sidebar fixed left-0 top-0 bottom-0 w-64 glass z-50 p-4">
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 glass-card rounded-xl flex items-center justify-center"><span class="text-xl">üöÄ</span></div>
          <span class="font-bold text-gray-800">Menu</span>
        </div>
        <button type="button" onclick="closeMobileMenu()" class="w-8 h-8 rounded-lg glass-card flex items-center justify-center cursor-pointer">‚úï</button>
      </div>
      <nav class="space-y-2">
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="stats"><span>üìä</span> Statistika</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="funnels"><span>üéØ</span> Varonkalar</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="payments"><span>üí∞</span> To'lovlar</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="users"><span>üë•</span> Foydalanuvchilar</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="lessons"><span>üìö</span> Darslar</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="media"><span>üìÅ</span> Media</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="custdev"><span>üìù</span> CustDev</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="feedback"><span>üí¨</span> Feedbacklar</button>
        <button type="button" class="mobile-nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-left cursor-pointer" data-tab="settings"><span>‚öôÔ∏è</span> Sozlamalar</button>
        <hr class="my-4 border-white/30">
        <button type="button" onclick="openBroadcastModal(); closeMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-btn-success text-white text-left cursor-pointer"><span>üì®</span> Xabar yuborish</button>
        <button type="button" onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl glass-card text-red-500 text-left cursor-pointer"><span>üö™</span> Chiqish</button>
      </nav>
    </div>

    <!-- Main Content -->
    <main class="main-content flex-1 min-h-screen">
      <header class="flex justify-between items-center mb-4 md:mb-8">
        <div>
          <h1 class="text-xl md:text-3xl font-bold text-gray-800">Dashboard</h1>
          <p class="text-gray-500 text-xs md:text-base mt-1" id="currentDate"></p>
        </div>
        <div class="flex gap-2 md:gap-3">
          <button type="button" onclick="openBroadcastModal()" class="hidden md:flex px-6 py-3 rounded-2xl glass-btn-success text-white font-medium items-center gap-2 cursor-pointer"><span>üì®</span> Xabar</button>
          <button onclick="loadAll()" class="w-10 h-10 md:w-12 md:h-12 rounded-xl md:rounded-2xl glass-card flex items-center justify-center text-lg md:text-xl">üîÑ</button>
        </div>
      </header>

      <!-- Stats -->
      <div id="content-stats">
        <div class="stats-grid grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-white text-2xl">üë•</div>
              <div><p class="text-gray-500 text-sm">Jami</p><p id="totalUsers" class="text-3xl font-bold gradient-text">0</p></div>
            </div>
          </div>
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center text-white text-2xl">üíé</div>
              <div><p class="text-gray-500 text-sm">Premium</p><p id="paidUsers" class="text-3xl font-bold gradient-text-green">0</p></div>
            </div>
          </div>
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white text-2xl">üíµ</div>
              <div><p class="text-gray-500 text-sm">Oylik</p><p id="monthlyRevenue" class="text-xl font-bold gradient-text-blue">0</p></div>
            </div>
          </div>
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white text-2xl">üìà</div>
              <div><p class="text-gray-500 text-sm">Bugun</p><p id="todayUsers" class="text-3xl font-bold text-orange-500">+0</p></div>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-3xl p-6 mb-8">
          <h2 class="font-bold text-xl text-gray-800 mb-6">üìä Funnel</h2>
          <div id="funnelStats" class="grid grid-cols-3 md:grid-cols-6 gap-3"></div>
        </div>
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="glass-card rounded-3xl p-6"><h2 class="font-bold text-lg text-gray-800 mb-4">üìà Obunachi</h2><canvas id="subscribersChart"></canvas></div>
          <div class="glass-card rounded-3xl p-6"><h2 class="font-bold text-lg text-gray-800 mb-4">üí∞ Daromad</h2><canvas id="revenueChart"></canvas></div>
        </div>
      </div>

      <!-- Funnels / Varonkalar -->
      <div id="content-funnels" class="hidden">
        <div class="glass-card rounded-3xl p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="font-bold text-2xl text-gray-800">üéØ Varonkalar</h2>
              <p class="text-gray-500 text-sm mt-1">Ko'p varonkali sotish tizimi</p>
            </div>
            <button onclick="openCreateFunnelModal()" class="px-6 py-3 rounded-2xl glass-btn text-white font-medium">+ Yangi varonka</button>
          </div>
          
          <!-- Funnels list -->
          <div id="funnelsList" class="space-y-4">
            <div class="text-center py-12 text-gray-400">
              <span class="text-5xl mb-4 block">üéØ</span>
              <p>Varonkalar yuklanmoqda...</p>
            </div>
          </div>
        </div>
        
        <!-- How it works -->
        <div class="glass-card rounded-3xl p-6">
          <h3 class="font-bold text-lg mb-4">üí° Qanday ishlaydi?</h3>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-3xl mb-2">1Ô∏è‚É£</div>
              <p class="font-medium">Varonka yarating</p>
              <p class="text-sm text-gray-500 mt-1">Nom, slug (URL uchun), va asosiy sozlamalarni kiriting</p>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-3xl mb-2">2Ô∏è‚É£</div>
              <p class="font-medium">Darslar qo'shing</p>
              <p class="text-sm text-gray-500 mt-1">Har bir varonkaga o'z darslarini, CustDev savollarini qo'shing</p>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-3xl mb-2">3Ô∏è‚É£</div>
              <p class="font-medium">Link ulashing</p>
              <p class="text-sm text-gray-500 mt-1">t.me/bot?start=slug - har bir varonkaning o'z linki</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Payments -->
      <div id="content-payments" class="hidden">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-6"><p class="text-gray-500 text-sm mb-1">Bugun</p><p id="payToday" class="text-2xl font-bold gradient-text-green">0</p><p id="payTodayCount" class="text-xs text-gray-400">0 ta</p></div>
          <div class="glass-card rounded-3xl p-6"><p class="text-gray-500 text-sm mb-1">Hafta</p><p id="payWeek" class="text-2xl font-bold gradient-text-blue">0</p><p id="payWeekCount" class="text-xs text-gray-400">0 ta</p></div>
          <div class="glass-card rounded-3xl p-6"><p class="text-gray-500 text-sm mb-1">Oy</p><p id="payMonth" class="text-2xl font-bold gradient-text">0</p><p id="payMonthCount" class="text-xs text-gray-400">0 ta</p></div>
          <div class="glass-card rounded-3xl p-6"><p class="text-gray-500 text-sm mb-1">Yil</p><p id="payYear" class="text-2xl font-bold text-orange-500">0</p><p id="payYearCount" class="text-xs text-gray-400">0 ta</p></div>
        </div>
        
        <!-- Payment Charts -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üí≥ To'lov usullari</h3>
            <div class="h-48"><canvas id="paymentMethodChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5 md:col-span-2">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üìà Oylik daromad trendi</h3>
            <div class="h-48"><canvas id="monthlyTrendChart"></canvas></div>
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-6 border-l-4 border-blue-500"><div class="flex items-center gap-4"><span class="text-3xl">üí≥</span><div><p class="text-gray-500 text-sm">Payme</p><p id="paymeTotal" class="text-2xl font-bold text-blue-600">0</p><p id="paymeCount" class="text-xs text-gray-400">0 ta</p></div></div></div>
          <div class="glass-card rounded-3xl p-6 border-l-4 border-green-500"><div class="flex items-center gap-4"><span class="text-3xl">üí†</span><div><p class="text-gray-500 text-sm">Click</p><p id="clickTotal" class="text-2xl font-bold text-green-600">0</p><p id="clickCount" class="text-xs text-gray-400">0 ta</p></div></div></div>
        </div>
        <div class="glass-card rounded-3xl overflow-hidden">
          <div class="px-6 py-4 border-b border-white/30"><h2 class="font-bold text-lg">üí≥ Oxirgi to'lovlar</h2></div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm min-w-[600px]"><thead class="bg-white/30"><tr><th class="px-4 py-3 text-left text-xs">Sana</th><th class="px-4 py-3 text-left text-xs">Foydalanuvchi</th><th class="px-4 py-3 text-left text-xs">Summa</th><th class="px-4 py-3 text-left text-xs">Manba</th><th class="px-4 py-3 text-left text-xs">Status</th></tr></thead><tbody id="paymentsTable" class="divide-y divide-white/20"></tbody></table>
          </div>
        </div>
        
        <!-- Buyer Analytics Section -->
        <div class="glass-card rounded-3xl p-6 mt-6">
          <h2 class="font-bold text-lg mb-6">üìä Sotib olganlar tahlili</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Avg Time to Purchase -->
            <div class="glass rounded-2xl p-5 text-center">
              <p class="text-sm text-gray-500 mb-2">‚è± O'rtacha sotib olish vaqti</p>
              <p id="avgTimeToPurchase" class="text-2xl font-bold text-violet-600">-</p>
              <p class="text-xs text-gray-400 mt-1">Start dan to'lovgacha</p>
            </div>
            
            <!-- Fastest Purchase -->
            <div class="glass rounded-2xl p-5 text-center">
              <p class="text-sm text-gray-500 mb-2">üöÄ Eng tez sotib olgan</p>
              <p id="fastestPurchase" class="text-2xl font-bold text-green-600">-</p>
              <p class="text-xs text-gray-400 mt-1">Minimum vaqt</p>
            </div>
            
            <!-- Slowest Purchase -->
            <div class="glass rounded-2xl p-5 text-center">
              <p class="text-sm text-gray-500 mb-2">üê¢ Eng sekin sotib olgan</p>
              <p id="slowestPurchase" class="text-2xl font-bold text-orange-600">-</p>
              <p class="text-xs text-gray-400 mt-1">Maksimum vaqt</p>
            </div>
            
            <!-- Conversion Rate -->
            <div class="glass rounded-2xl p-5 text-center">
              <p class="text-sm text-gray-500 mb-2">üìà Konversiya</p>
              <p id="conversionRate" class="text-2xl font-bold text-blue-600">-</p>
              <p class="text-xs text-gray-400 mt-1">Sotib olish foizi</p>
            </div>
          </div>
          
          <!-- Buyer CustDev Analysis -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Age Distribution of Buyers -->
            <div class="glass rounded-2xl p-5">
              <h3 class="font-semibold text-sm mb-4">üë§ Yoshlar bo'yicha (sotib olganlar)</h3>
              <div id="buyerAgeStats" class="space-y-2"></div>
            </div>
            
            <!-- Occupation of Buyers -->
            <div class="glass rounded-2xl p-5">
              <h3 class="font-semibold text-sm mb-4">üíº Kasblar bo'yicha (sotib olganlar)</h3>
              <div id="buyerOccupationStats" class="space-y-2"></div>
            </div>
            
            <!-- Problems of Buyers -->
            <div class="glass rounded-2xl p-5">
              <h3 class="font-semibold text-sm mb-4">üéØ Muammolar (sotib olganlar)</h3>
              <div id="buyerProblemStats" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users -->
      <div id="content-users" class="hidden">
        <!-- User Charts -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üë• Premium vs Free</h3>
            <div class="h-48"><canvas id="userTypeChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üìö Darslar bo'yicha</h3>
            <div class="h-48"><canvas id="lessonDistChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üìà Haftalik o'sish</h3>
            <div class="h-48"><canvas id="weeklyGrowthChart"></canvas></div>
          </div>
        </div>
        
        <div class="glass-card rounded-3xl overflow-hidden">
          <div class="px-6 py-4 border-b border-white/30">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
              <h2 class="font-bold text-lg">üë• Foydalanuvchilar <span id="usersFilteredCount" class="text-sm font-normal text-gray-500"></span></h2>
              <div class="flex gap-3">
                <button onclick="exportExcel()" class="px-4 py-2 rounded-xl glass-btn-success text-white text-sm">üì• Excel</button>
                <input type="text" id="searchInput" placeholder="üîç Ism, telefon, username..." class="px-4 py-2 rounded-xl glass-input w-64" onkeyup="applyFilters()">
              </div>
            </div>
            <!-- Filters -->
            <div class="flex flex-wrap gap-2">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">Status:</span>
                <button onclick="setFilter('status', 'all')" id="filter-status-all" class="px-3 py-1.5 rounded-lg glass text-xs font-medium filter-btn-active">Hammasi</button>
                <button onclick="setFilter('status', 'paid')" id="filter-status-paid" class="px-3 py-1.5 rounded-lg glass text-xs font-medium">üíé Premium</button>
                <button onclick="setFilter('status', 'free')" id="filter-status-free" class="px-3 py-1.5 rounded-lg glass text-xs font-medium">üÜì Free</button>
              </div>
              <div class="w-px bg-gray-300 mx-2"></div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">CustDev:</span>
                <button onclick="setFilter('custdev', 'all')" id="filter-custdev-all" class="px-3 py-1.5 rounded-lg glass text-xs font-medium filter-btn-active">Hammasi</button>
                <button onclick="setFilter('custdev', 'done')" id="filter-custdev-done" class="px-3 py-1.5 rounded-lg glass text-xs font-medium">‚úÖ Javob bergan</button>
                <button onclick="setFilter('custdev', 'pending')" id="filter-custdev-pending" class="px-3 py-1.5 rounded-lg glass text-xs font-medium">‚è≥ Kutilmoqda</button>
              </div>
              <div class="w-px bg-gray-300 mx-2"></div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">Dars:</span>
                <select id="filter-lesson" onchange="applyFilters()" class="px-3 py-1.5 rounded-lg glass text-xs">
                  <option value="all">Hammasi</option>
                  <option value="0">0-dars</option>
                  <option value="1">1-dars</option>
                  <option value="2">2-dars</option>
                  <option value="3">3-dars</option>
                  <option value="4">4-dars</option>
                  <option value="5+">5+ dars</option>
                </select>
              </div>
              <div class="w-px bg-gray-300 mx-2"></div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">Saralash:</span>
                <select id="filter-sort" onchange="applyFilters()" class="px-3 py-1.5 rounded-lg glass text-xs">
                  <option value="newest">Yangi ‚Üí Eski</option>
                  <option value="oldest">Eski ‚Üí Yangi</option>
                  <option value="name">Ism bo'yicha</option>
                  <option value="lesson-high">Dars: Ko'p ‚Üí Kam</option>
                  <option value="lesson-low">Dars: Kam ‚Üí Ko'p</option>
                </select>
              </div>
              <div class="w-px bg-gray-300 mx-2"></div>
              <button onclick="resetAllFilters()" class="px-3 py-1.5 rounded-lg glass text-xs font-medium text-red-500 hover:bg-red-50">üîÑ Tozalash</button>
            </div>
          </div>
          <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
            <table class="w-full text-sm min-w-[700px]"><thead class="bg-white/30 sticky top-0"><tr><th class="px-3 py-3 text-left text-xs">Ism</th><th class="px-3 py-3 text-left text-xs">Telefon</th><th class="px-3 py-3 text-left text-xs">Dars</th><th class="px-3 py-3 text-left text-xs">Status</th><th class="px-3 py-3 text-left text-xs">CustDev</th><th class="px-3 py-3 text-left text-xs">Sana</th></tr></thead><tbody id="usersTable" class="divide-y divide-white/20"></tbody></table>
          </div>
        </div>
      </div>

      <!-- Lessons -->
      <div id="content-lessons" class="hidden">
        <div class="glass-card rounded-2xl md:rounded-3xl overflow-hidden">
          <div class="px-4 py-3 md:px-6 md:py-4 border-b border-white/30 flex justify-between items-center">
            <h2 class="font-bold text-base md:text-lg">üìö Darslar</h2>
            <button onclick="addLesson()" class="px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl glass-btn text-white font-medium text-sm md:text-base">+ Yangi dars</button>
          </div>
          <div id="lessonsList" class="divide-y divide-white/20"></div>
        </div>
      </div>

      <!-- Media -->
      <div id="content-media" class="hidden">
        <div class="glass-card rounded-3xl p-6">
          <h2 class="font-bold text-xl mb-6">üìÅ Media kutubxonasi</h2>
          <div class="glass rounded-2xl p-5 mb-6">
            <p class="font-semibold text-violet-700 mb-3">üí° Qanday ishlaydi:</p>
            <ol class="text-sm text-gray-600 space-y-1">
              <li>1. Botga video/rasm/audio yuboring</li>
              <li>2. Izoh yozing: "1-dars video"</li>
              <li>3. "üìÅ Kutubxonadan" tugmasini bosing</li>
            </ol>
          </div>
          <div class="flex gap-2 mb-6 flex-wrap">
            <button onclick="loadMedia('all')" class="px-4 py-2 rounded-xl glass-card font-medium text-sm">Hammasi</button>
            <button onclick="loadMedia('video')" class="px-4 py-2 rounded-xl glass-card text-sm text-blue-600">üìπ Video</button>
            <button onclick="loadMedia('photo')" class="px-4 py-2 rounded-xl glass-card text-sm text-green-600">üñº Rasm</button>
            <button onclick="loadMedia('audio')" class="px-4 py-2 rounded-xl glass-card text-sm text-orange-600">üéµ Audio</button>
          </div>
          <div id="mediaList" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
          <p id="mediaEmpty" class="text-center text-gray-400 py-12 hidden">Media topilmadi</p>
        </div>
      </div>

      <!-- CustDev -->
      <div id="content-custdev" class="hidden">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-5">
            <p class="text-gray-500 text-sm mb-1">Jami savollar</p>
            <p id="custdevTotalQ" class="text-2xl font-bold gradient-text">0</p>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <p class="text-gray-500 text-sm mb-1">Javob berganlar</p>
            <p id="custdevAnswered" class="text-2xl font-bold gradient-text-green">0</p>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <p class="text-gray-500 text-sm mb-1">Javob bermagan</p>
            <p id="custdevNotAnswered" class="text-2xl font-bold text-orange-500">0</p>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <p class="text-gray-500 text-sm mb-1">Konversiya</p>
            <p id="custdevConversion" class="text-2xl font-bold gradient-text-blue">0%</p>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üìä Yosh guruhi</h3>
            <div class="h-48"><canvas id="ageChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üíº Kasb/Faoliyat</h3>
            <div class="h-48"><canvas id="occupationChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üí∞ Daromad</h3>
            <div class="h-48"><canvas id="incomeChart"></canvas></div>
          </div>
          <div class="glass-card rounded-3xl p-5">
            <h3 class="font-semibold text-gray-700 mb-4 text-center">üíµ Byudjet</h3>
            <div class="h-48"><canvas id="budgetChart"></canvas></div>
          </div>
        </div>
        
        <div class="glass-card rounded-3xl overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-white/30 flex justify-between items-center">
            <h2 class="font-bold text-lg">üìù CustDev Savollar</h2>
            <button onclick="addCustDev()" class="px-6 py-3 rounded-2xl glass-btn text-white font-medium">+ Yangi savol</button>
          </div>
          <div id="custdevList" class="divide-y divide-white/20"></div>
        </div>
        <div class="glass-card rounded-3xl p-6">
          <h3 class="font-bold text-lg mb-6">üìä CustDev Statistikasi (Batafsil)</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="custdevStats"></div>
        </div>
      </div>

      <!-- Feedback -->
      <div id="content-feedback" class="hidden">
        <!-- Feedback Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white text-2xl">üëç</div>
              <div>
                <p class="text-gray-500 text-sm">Yoqdi</p>
                <p id="feedbackLiked" class="text-3xl font-bold text-green-600">0</p>
              </div>
            </div>
          </div>
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-red-400 to-rose-500 flex items-center justify-center text-white text-2xl">üëé</div>
              <div>
                <p class="text-gray-500 text-sm">Yoqmadi</p>
                <p id="feedbackDisliked" class="text-3xl font-bold text-red-600">0</p>
              </div>
            </div>
          </div>
          <div class="glass-card rounded-3xl p-6">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-white text-2xl">üí¨</div>
              <div>
                <p class="text-gray-500 text-sm">Jami</p>
                <p id="feedbackTotal" class="text-3xl font-bold gradient-text">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Feedback List -->
        <div class="glass-card rounded-3xl p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h3 class="font-bold text-xl">üí¨ Foydalanuvchi Feedbacklari</h3>
              <p class="text-gray-500 text-sm mt-1">"Yo'q" degan odamlarning sababalari</p>
            </div>
            <div class="flex gap-2">
              <select id="feedbackFilter" onchange="filterFeedback()" class="px-4 py-2 rounded-xl glass-input">
                <option value="all">Hammasi</option>
                <option value="liked">üëç Yoqdi</option>
                <option value="disliked">üëé Yoqmadi</option>
              </select>
              <button onclick="loadFeedback()" class="px-4 py-2 rounded-xl glass-card">üîÑ</button>
            </div>
          </div>
          
          <div class="space-y-3" id="feedbackList">
            <p class="text-gray-500 text-center py-8">Yuklanmoqda...</p>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div id="content-settings" class="hidden">
        <!-- Settings Tabs -->
        <div class="glass-card rounded-3xl p-2 mb-6">
          <div class="flex gap-2">
            <button onclick="showSettingsTab('channel')" id="settings-tab-channel" class="flex-1 py-3 px-6 rounded-2xl font-medium transition-all bg-violet-500 text-white">
              üì¢ Kanal va Obuna
            </button>
            <button onclick="showSettingsTab('messages')" id="settings-tab-messages" class="flex-1 py-3 px-6 rounded-2xl font-medium transition-all text-gray-600 hover:bg-gray-100">
              üìù Xabarlar
            </button>
          </div>
        </div>

        <!-- TAB 1: Kanal va Obuna -->
        <div id="settings-content-channel">
          <!-- Channel Settings -->
          <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="font-bold text-xl">üì¢ Premium kanal</h3>
                <p class="text-gray-500 text-sm mt-1">To'lov qilganlarga kirish uchun</p>
              </div>
            </div>
            
            <div class="glass rounded-2xl p-5">
              <label class="text-sm font-medium text-gray-600 mb-3 block">ü§ñ Kanal ID</label>
              <div class="flex gap-3">
                <input type="text" id="premiumChannelId" class="flex-1 px-4 py-3 rounded-xl glass-input text-lg font-mono" placeholder="-1001234567890">
                <button onclick="saveChannelId()" class="px-6 py-3 rounded-xl glass-btn text-white font-medium">üíæ Saqlash</button>
              </div>
              <div class="mt-3 p-3 bg-blue-50 rounded-xl text-sm">
                <p class="font-medium text-blue-800 mb-1">üìå Kanal ID qanday olinadi?</p>
                <ol class="text-blue-600 space-y-1">
                  <li>1. @userinfobot ga boring</li>
                  <li>2. Kanalingizdan biror xabarni forward qiling</li>
                  <li>3. Bot kanal ID ni ko'rsatadi (masalan: -1001234567890)</li>
                </ol>
              </div>
              <div class="mt-3 p-3 bg-green-50 rounded-xl text-sm">
                <p class="text-green-700">‚úÖ <b>Bu yerda saqlasangiz bas!</b> Render.com o'zgartirish shart emas.</p>
              </div>
            </div>
            <input type="hidden" id="premiumChannelLink" value="">
          </div>
          
          <!-- Free Channel Settings -->
          <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="font-bold text-xl">üÜì Bepul kanal (Majburiy obuna)</h3>
                <p class="text-gray-500 text-sm mt-1">2-darsdan keyin obuna bo'lishi shart</p>
              </div>
            </div>
            
            <div class="glass rounded-2xl p-5 space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">ü§ñ Bepul kanal ID</label>
                <input type="text" id="freeChannelId" class="w-full px-4 py-3 rounded-xl glass-input font-mono" placeholder="-1001234567890">
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">üîó Kanal havolasi</label>
                <input type="text" id="freeChannelLink" class="w-full px-4 py-3 rounded-xl glass-input" placeholder="https://t.me/your_channel">
              </div>
              <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">üìö Nechanchi darsdan oldin obuna talab qilinsin?</label>
                <select id="requireSubBeforeLesson" class="w-full px-4 py-3 rounded-xl glass-input">
                  <option value="2">2-darsdan oldin</option>
                  <option value="3" selected>3-darsdan oldin</option>
                  <option value="4">4-darsdan oldin</option>
                </select>
              </div>
              <button onclick="saveFreeChannel()" class="w-full py-3 rounded-xl glass-btn-success text-white font-medium">üíæ Saqlash</button>
            </div>
            
            <div class="mt-4 p-4 bg-yellow-50 rounded-xl">
              <p class="text-yellow-800 text-sm">
                <b>‚ö†Ô∏è Muhim:</b> Bot kanalingizda <b>admin</b> bo'lishi kerak (faqat "foydalanuvchilarni qo'shish" huquqi yetarli). 
                Aks holda obunani tekshira olmaydi.
              </p>
            </div>
          </div>
          
          <!-- Subscription Plans -->
          <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="font-bold text-xl">üí∞ Obuna narxlari</h3>
                <p class="text-gray-500 text-sm mt-1">Har bir reja narxini o'zgartiring va saqlang</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="subscriptionPlansGrid">
              <!-- Plans will be loaded here -->
            </div>
            
            <button onclick="saveAllPlans()" class="mt-4 w-full py-4 rounded-xl glass-btn text-white font-semibold text-lg">üíæ Barcha narxlarni saqlash</button>
          </div>
          <input type="hidden" id="basePriceInput" value="0">
          <input type="hidden" id="autoCalculatePrices" value="false">
        </div>

        <!-- TAB 2: Xabarlar - PROGREV FLOW -->
        <div id="settings-content-messages" class="hidden">
          
          <!-- ========== PROGREV FLOW - VISUAL FUNNEL ========== -->
          <div class="glass-card rounded-3xl p-6 mb-6 overflow-hidden">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="font-bold text-xl">üéØ Sotuvga olib boruvchi Progrev Flow</h3>
                <p class="text-gray-500 text-sm mt-1">4-dars tugagandan keyin avtomatik yuboriladi</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-3 py-1.5 rounded-full bg-green-100 text-green-700 text-xs font-medium">‚úÖ Faol</span>
                <button onclick="openFlowSettingsModal()" class="px-4 py-2 rounded-xl glass-btn text-white text-sm">‚öôÔ∏è Vaqtlarni sozlash</button>
              </div>
            </div>
            
            <!-- Visual Flow -->
            <div class="relative">
              <!-- Trigger -->
              <div class="flex items-center gap-4 mb-2">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white shadow-lg">
                  <span class="text-xl">üéì</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gray-100 border-2 border-gray-300">
                  <p class="font-bold text-gray-800">TRIGGER: 4-Dars ko'rildi</p>
                  <p class="text-sm text-gray-500">Foydalanuvchi oxirgi bepul darsni tugatganda</p>
                </div>
              </div>
              
              <!-- Arrow -->
              <div class="ml-6 h-8 border-l-2 border-dashed border-violet-300 flex items-center">
                <span class="ml-4 text-xs text-gray-400 bg-white px-2">‚ö° Darhol</span>
              </div>
              
              <!-- Step 1: Congrats -->
              <div class="flex items-center gap-4 mb-2 group cursor-pointer" onclick="openCongratsModal()">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                  <span class="font-bold">1</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 group-hover:border-green-400 transition-colors">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-bold text-green-800">üéâ Tabriklov xabari</p>
                      <p class="text-sm text-green-600 mt-1">"Tabriklayman! Barcha darslarni muvaffaqiyatli tugatdingiz..."</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-green-200 text-green-700">Darhol</span>
                  </div>
                  <div class="mt-3 flex items-center gap-2">
                    <span class="text-xs text-gray-400">üìä Open rate: ~95%</span>
                    <button class="text-xs text-violet-600 hover:underline">‚úèÔ∏è Tahrirlash</button>
                  </div>
                </div>
              </div>
              
              <!-- Arrow with delay -->
              <div class="ml-6 h-12 border-l-2 border-dashed border-violet-300 flex items-center">
                <div class="ml-4 flex items-center gap-2">
                  <span class="text-lg">‚è±Ô∏è</span>
                  <div class="px-3 py-1.5 rounded-full bg-violet-100 border border-violet-300">
                    <span class="text-sm font-medium text-violet-700" id="flowPitchDelay">1 soat</span>
                  </div>
                  <span class="text-xs text-gray-400">kutish</span>
                </div>
              </div>
              
              <!-- Step 2: Pitch Video -->
              <div class="flex items-center gap-4 mb-2 group cursor-pointer" onclick="openPitchModal()">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                  <span class="font-bold">2</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-violet-50 to-purple-50 border-2 border-violet-200 group-hover:border-violet-400 transition-colors">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-bold text-violet-800">üé¨ Video Pitch</p>
                      <p class="text-sm text-violet-600 mt-1" id="pitchTextPreview">"Maxsus video xabar! To'liq kursga tayyormisiz?"</p>
                      <div class="flex items-center gap-2 mt-2">
                        <span class="text-xs px-2 py-0.5 rounded bg-violet-200 text-violet-700">üìπ Video</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-violet-200 text-violet-700">üñº Rasm</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-green-200 text-green-700">‚úÖ O'rnatilgan</span>
                      </div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-violet-200 text-violet-700" id="flowPitchDelayBadge">+1 soat</span>
                  </div>
                  <div class="mt-3 flex items-center gap-2">
                    <span class="text-xs text-gray-400">üìä CTR: ~45%</span>
                    <button class="text-xs text-violet-600 hover:underline">‚úèÔ∏è Tahrirlash</button>
                    <button class="text-xs text-blue-600 hover:underline">üëÅ Preview</button>
                  </div>
                </div>
              </div>
              
              <!-- Arrow with delay -->
              <div class="ml-6 h-12 border-l-2 border-dashed border-blue-300 flex items-center">
                <div class="ml-4 flex items-center gap-2">
                  <span class="text-lg">‚è±Ô∏è</span>
                  <div class="px-3 py-1.5 rounded-full bg-blue-100 border border-blue-300">
                    <span class="text-sm font-medium text-blue-700" id="flowSalesDelay">3 soat</span>
                  </div>
                  <span class="text-xs text-gray-400">kutish</span>
                </div>
              </div>
              
              <!-- Step 3: Sales CTA -->
              <div class="flex items-center gap-4 mb-2 group cursor-pointer" onclick="openSalesMessageModal()">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                  <span class="font-bold">3</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 group-hover:border-blue-400 transition-colors">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-bold text-blue-800">üí≥ To'lov taklifi</p>
                      <p class="text-sm text-blue-600 mt-1" id="salesTextPreview">"SMM PRO KURSGA TAKLIF!"</p>
                      <div class="flex items-center gap-2 mt-2">
                        <span class="text-xs px-2 py-0.5 rounded bg-green-200 text-green-700">üí≥ Payme</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-blue-200 text-blue-700">üíé Click</span>
                      </div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-blue-200 text-blue-700" id="flowSalesDelayBadge">+3 soat</span>
                  </div>
                  <div class="mt-3 flex items-center gap-2">
                    <span class="text-xs text-gray-400">üìä Conversion: ~12%</span>
                    <button class="text-xs text-violet-600 hover:underline">‚úèÔ∏è Tahrirlash</button>
                  </div>
                </div>
              </div>
              
              <!-- Conditional branch -->
              <div class="ml-6 h-8 border-l-2 border-dashed border-orange-300 flex items-center">
                <div class="ml-4 flex items-center gap-2">
                  <span class="text-lg">‚ùì</span>
                  <span class="text-xs text-orange-600 font-medium">Agar 24 soat ichida TO'LAMASA</span>
                </div>
              </div>
              
              <!-- Step 4: Soft Attack -->
              <div class="flex items-center gap-4 mb-2 group cursor-pointer" onclick="openSoftAttackModal()">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-400 to-amber-500 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                  <span class="font-bold">4</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 group-hover:border-orange-400 transition-colors">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-bold text-orange-800">üîî Soft Reminder</p>
                      <p class="text-sm text-orange-600 mt-1" id="softAttackTextPreview">"Hali qaror qilmadingizmi? Chegirma tugamoqda!"</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-orange-200 text-orange-700" id="flowSoftDelayBadge">+24 soat</span>
                  </div>
                  <div class="mt-3 flex items-center gap-2">
                    <span class="text-xs text-gray-400">üìä Recovery: ~8%</span>
                    <button class="text-xs text-violet-600 hover:underline">‚úèÔ∏è Tahrirlash</button>
                    <label class="flex items-center gap-1 text-xs">
                      <input type="checkbox" id="softAttackEnabled" checked class="rounded">
                      <span class="text-gray-500">Faol</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Success outcome -->
              <div class="ml-6 h-8 border-l-2 border-dashed border-green-400"></div>
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-lg">
                  <span class="text-xl">üéØ</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-400">
                  <p class="font-bold text-green-800">‚úÖ TO'LOV QILDI ‚Üí Premium kanalga kirish</p>
                  <p class="text-sm text-green-600">Avtomatik invite link yuboriladi</p>
                </div>
              </div>
            </div>
            
            <!-- Quick Test -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-medium text-gray-700">üß™ Test rejimi</p>
                  <p class="text-xs text-gray-500">O'zingizga darhol yuborish (kutmasdan)</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="testFullFlow()" class="px-4 py-2 rounded-xl bg-gradient-to-r from-violet-500 to-purple-600 text-white text-sm font-medium hover:shadow-lg transition-shadow">
                    üöÄ To'liq Flow
                  </button>
                  <button onclick="testPitch()" class="px-4 py-2 rounded-xl glass text-gray-700 text-sm">üì§ Pitch</button>
                  <button onclick="testSales()" class="px-4 py-2 rounded-xl glass text-gray-700 text-sm">üí≥ To'lov</button>
                  <button onclick="testSoftAttack()" class="px-4 py-2 rounded-xl glass text-gray-700 text-sm">üîî Eslatma</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ========== OBUNA ESLATMALARI ========== -->
          <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
              <div>
                <h3 class="font-bold text-xl">‚è∞ Obuna eslatmalari</h3>
                <p class="text-gray-500 text-sm mt-1">Premium obuna tugashidan oldin yuboriladi</p>
              </div>
              <button onclick="saveReminders()" class="px-6 py-3 rounded-2xl glass-btn text-white font-medium">üíæ Saqlash</button>
            </div>
            
            <!-- Timeline -->
            <div class="relative">
              <!-- Day 5 -->
              <div class="flex gap-4 mb-4">
                <div class="flex flex-col items-center">
                  <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center font-bold border-2 border-yellow-300">5</div>
                  <div class="w-0.5 h-full bg-yellow-200 mt-2"></div>
                </div>
                <div class="flex-1 glass rounded-2xl p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-yellow-700">üìÖ 5 kun oldin</span>
                    <span class="text-xs text-gray-400">Yumshoq eslatma</span>
                  </div>
                  <textarea id="reminder_5d" rows="2" class="w-full px-4 py-3 rounded-xl glass-input text-sm" placeholder="Hurmatli {{ism}}, obunangiz tugashiga 5 kun qoldi..."></textarea>
                </div>
              </div>
              
              <!-- Day 3 -->
              <div class="flex gap-4 mb-4">
                <div class="flex flex-col items-center">
                  <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold border-2 border-orange-300">3</div>
                  <div class="w-0.5 h-full bg-orange-200 mt-2"></div>
                </div>
                <div class="flex-1 glass rounded-2xl p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-orange-700">‚ö†Ô∏è 3 kun oldin</span>
                    <span class="text-xs text-gray-400">O'rtacha urgency</span>
                  </div>
                  <textarea id="reminder_3d" rows="2" class="w-full px-4 py-3 rounded-xl glass-input text-sm" placeholder="{{ism}}, obunangiz 3 kun ichida tugaydi..."></textarea>
                </div>
              </div>
              
              <!-- Day 1 -->
              <div class="flex gap-4 mb-4">
                <div class="flex flex-col items-center">
                  <div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold border-2 border-red-300">1</div>
                  <div class="w-0.5 h-full bg-red-200 mt-2"></div>
                </div>
                <div class="flex-1 glass rounded-2xl p-4 border-l-4 border-red-400">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-red-700">üö® ERTAGA tugaydi!</span>
                    <span class="text-xs text-red-500 font-medium">Yuqori urgency</span>
                  </div>
                  <textarea id="reminder_1d" rows="2" class="w-full px-4 py-3 rounded-xl glass-input text-sm" placeholder="DIQQAT {{ism}}! Obunangiz ERTAGA tugaydi!"></textarea>
                </div>
              </div>
              
              <!-- Expired -->
              <div class="flex gap-4">
                <div class="flex flex-col items-center">
                  <div class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center font-bold border-2 border-gray-300">‚ùå</div>
                </div>
                <div class="flex-1 glass rounded-2xl p-4 bg-gray-50">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-gray-700">Obuna tugadi</span>
                    <span class="text-xs text-gray-400">Kanaldan chiqariladi</span>
                  </div>
                  <textarea id="reminder_expired" rows="2" class="w-full px-4 py-3 rounded-xl glass-input text-sm" placeholder="{{ism}}, obunangiz tugadi. Qayta obuna bo'lish uchun..."></textarea>
                </div>
              </div>
            </div>
            
            <p class="mt-4 text-xs text-gray-500">
              O'zgaruvchilar: 
              <code class="bg-violet-100 text-violet-700 px-1.5 py-0.5 rounded">{{ism}}</code>
              <code class="bg-violet-100 text-violet-700 px-1.5 py-0.5 rounded ml-1">{{fio}}</code>
              <code class="bg-violet-100 text-violet-700 px-1.5 py-0.5 rounded ml-1">{{tugash_sanasi}}</code>
            </p>
          </div>
          
          <!-- ========== STATISTIKA ========== -->
          <div class="glass-card rounded-3xl p-6">
            <h3 class="font-bold text-xl mb-4">üìä Progrev statistikasi</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="glass rounded-2xl p-4 text-center">
                <p class="text-3xl font-bold text-violet-600" id="statPitchSent">0</p>
                <p class="text-xs text-gray-500 mt-1">Pitch yuborildi</p>
              </div>
              <div class="glass rounded-2xl p-4 text-center">
                <p class="text-3xl font-bold text-blue-600" id="statSalesSent">0</p>
                <p class="text-xs text-gray-500 mt-1">To'lov taklifi</p>
              </div>
              <div class="glass rounded-2xl p-4 text-center">
                <p class="text-3xl font-bold text-green-600" id="statConversions">0</p>
                <p class="text-xs text-gray-500 mt-1">Sotib oldi</p>
              </div>
              <div class="glass rounded-2xl p-4 text-center">
                <p class="text-3xl font-bold text-orange-600" id="statConvRate">0%</p>
                <p class="text-xs text-gray-500 mt-1">Konversiya</p>
              </div>
            </div>
          </div>
          
        </div><!-- END settings-content-messages -->
      </div><!-- END content-settings -->
    </main>
  </div>
</div>

<script>
let auth = '';
let allUsers = [];
let allLessons = [];
let allPayments = [];
let allCustDev = [];
let allMedia = [];
let pitchData = {};
let sChart, rChart;
let ageChart, occupationChart, incomeChart, budgetChart;
let userTypeChart, lessonDistChart, weeklyGrowthChart;
let paymentMethodChart, monthlyTrendChart;
let mediaPickerTarget = null;
let mediaPickerType = null;
let userFilters = { status: 'all', custdev: 'all', lesson: 'all', sort: 'newest' };

document.getElementById('currentDate').textContent = new Date().toLocaleDateString('uz-UZ', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});

const saved = localStorage.getItem('adminAuth');
if (saved) { auth = saved; showDashboard(); }

document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', {headers: {Authorization: auth}});
    if (r.ok) { localStorage.setItem('adminAuth', auth); showDashboard(); }
    else document.getElementById('loginError').classList.remove('hidden');
  } catch(err) { document.getElementById('loginError').classList.remove('hidden'); }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadAll();
}

function logout() { localStorage.removeItem('adminAuth'); location.reload(); }

function showTab(t) {
  document.querySelectorAll('[id^="content-"]').forEach(function(e) { e.classList.add('hidden'); });
  document.querySelectorAll('[id^="tab-"]').forEach(function(e) { e.classList.remove('active'); });
  document.querySelectorAll('[id^="mob-tab-"]').forEach(function(e) { e.classList.remove('active'); });
  
  document.getElementById('content-' + t).classList.remove('hidden');
  
  // Desktop tab
  var desktopTab = document.getElementById('tab-' + t);
  if (desktopTab) desktopTab.classList.add('active');
  
  // Mobile tab
  var mobileTab = document.getElementById('mob-tab-' + t);
  if (mobileTab) mobileTab.classList.add('active');
  
  if (t === 'media') loadMedia('all');
  
  // Scroll to top on mobile
  window.scrollTo(0, 0);
}

// Mobile menu functions
function toggleMobileMenu() {
  document.getElementById('mobileMenuOverlay').classList.toggle('hidden');
  document.getElementById('mobileSlideMenu').classList.toggle('active');
}

function closeMobileMenu() {
  document.getElementById('mobileMenuOverlay').classList.add('hidden');
  document.getElementById('mobileSlideMenu').classList.remove('active');
}

// Settings sub-tabs
function showSettingsTab(tab) {
  // Hide all settings content
  document.getElementById('settings-content-channel').classList.add('hidden');
  document.getElementById('settings-content-messages').classList.add('hidden');
  
  // Reset tab styles
  document.getElementById('settings-tab-channel').classList.remove('bg-violet-500', 'text-white');
  document.getElementById('settings-tab-channel').classList.add('text-gray-600', 'hover:bg-gray-100');
  document.getElementById('settings-tab-messages').classList.remove('bg-violet-500', 'text-white');
  document.getElementById('settings-tab-messages').classList.add('text-gray-600', 'hover:bg-gray-100');
  
  // Show selected tab
  document.getElementById('settings-content-' + tab).classList.remove('hidden');
  document.getElementById('settings-tab-' + tab).classList.remove('text-gray-600', 'hover:bg-gray-100');
  document.getElementById('settings-tab-' + tab).classList.add('bg-violet-500', 'text-white');
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function fmtDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('uz-UZ'); }
function fmtDateTime(d) { if (!d) return '-'; var x = new Date(d); return x.toLocaleDateString('uz-UZ') + ' ' + x.toLocaleTimeString('uz-UZ', {hour: '2-digit', minute: '2-digit'}); }
function fmtMoney(t) { return Math.round(t / 100).toLocaleString('uz-UZ') + " so'm"; }
function getMediaIcon(t) { var icons = {video: 'üìπ', photo: 'üñº', voice: 'üé§', audio: 'üéµ', video_note: '‚≠ï'}; return icons[t] || 'üìÑ'; }

async function loadMedia(type) {
  try {
    var url = type === 'all' ? '/api/media' : '/api/media/' + type;
    allMedia = await (await fetch(url, {headers: {Authorization: auth}})).json();
    var el = document.getElementById('mediaCountInfo'); if (el) el.textContent = allMedia.length;
    if (!allMedia.length) {
      document.getElementById('mediaList').innerHTML = '';
      document.getElementById('mediaEmpty').classList.remove('hidden');
      return;
    }
    document.getElementById('mediaEmpty').classList.add('hidden');
    var html = '';
    for (var i = 0; i < allMedia.length; i++) {
      var m = allMedia[i];
      var caption = m.caption ? '<p class="text-xs text-gray-700 mt-1 truncate">üìù ' + m.caption + '</p>' : '<p class="text-xs text-gray-400 mt-1 italic">Izoh yoq</p>';
      html += '<div class="glass-card rounded-2xl p-4">' +
        '<div class="flex justify-between items-start mb-3">' +
          '<span class="text-3xl">' + getMediaIcon(m.file_type) + '</span>' +
          '<div class="flex gap-1">' +
            '<button type="button" data-action="edit-media" data-id="' + m.id + '" class="action-btn w-9 h-9 rounded-lg glass flex items-center justify-center text-base hover:bg-violet-100">‚úèÔ∏è</button>' +
            '<button type="button" data-action="delete-media" data-id="' + m.id + '" class="action-btn w-9 h-9 rounded-lg glass flex items-center justify-center text-base text-red-500 hover:bg-red-100">üóëÔ∏è</button>' +
          '</div>' +
        '</div>' +
        '<p class="font-medium text-sm truncate">' + (m.file_name || m.file_type) + '</p>' + caption +
        '<button type="button" data-action="copy-file" data-id="' + m.file_id + '" class="action-btn mt-3 w-full py-2 rounded-xl glass text-xs font-medium hover:bg-white/50">üìã Nusxalash</button>' +
      '</div>';
    }
    document.getElementById('mediaList').innerHTML = html;
  } catch(e) { console.error('loadMedia error:', e); }
}

function copyFileId(f) { navigator.clipboard.writeText(f); alert('‚úÖ Nusxalandi!'); }

function copyUserInfo(tid) {
  var u = allUsers.find(function(x) { return String(x.telegram_id) === String(tid); });
  if (!u) return;
  
  var info = 'üë§ ' + (u.full_name || '-') + '\n';
  info += 'üì± ' + (u.phone || '-') + '\n';
  info += 'üì≤ ' + (u.username ? '@' + u.username : '-') + '\n';
  info += 'üÜî ' + u.telegram_id + '\n';
  info += 'üìä ' + (u.is_paid ? 'Premium' : 'Free') + '\n';
  info += 'üìö ' + (u.current_lesson || 0) + '-dars\n';
  info += '\nüìù CustDev:\n';
  if (u.age_group) info += '‚Ä¢ Yosh: ' + u.age_group + '\n';
  if (u.occupation) info += '‚Ä¢ Kasb: ' + u.occupation + '\n';
  if (u.income_level) info += '‚Ä¢ Daromad: ' + u.income_level + '\n';
  if (u.previous_courses) info += '‚Ä¢ Oldin kurs: ' + u.previous_courses + '\n';
  if (u.budget_range) info += '‚Ä¢ Byudjet: ' + u.budget_range + '\n';
  if (u.main_problem) info += '‚Ä¢ Muammo: ' + u.main_problem + '\n';
  if (u.goal) info += '‚Ä¢ Maqsad: ' + u.goal + '\n';
  
  navigator.clipboard.writeText(info);
  alert('‚úÖ Ma\'lumotlar nusxalandi!');
}

async function editMediaCaption(id) {
  var m = allMedia.find(function(x) { return x.id === id; });
  var n = prompt('üìù Izoh:', m ? m.caption || '' : '');
  if (n === null) return;
  try {
    await fetch('/api/media/' + id, {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify({caption: n})});
    loadMedia('all');
  } catch(e) { alert('Xatolik'); }
}

async function deleteMediaItem(id) {
  if (!confirm('O\'chirmoqchimisiz?')) return;
  try { await fetch('/api/media/' + id, {method: 'DELETE', headers: {Authorization: auth}}); loadMedia('all'); } catch(e) { alert('Xatolik'); }
}

function openMediaPicker(type, target) {
  mediaPickerTarget = target;
  mediaPickerType = type;
  loadMediaPicker(type);
  openModal('mediaPickerModal');
}

async function loadMediaPicker(type) {
  try {
    var url = type === 'all' ? '/api/media' : '/api/media/' + type;
    var media = await (await fetch(url, {headers: {Authorization: auth}})).json();
    if (!media.length) {
      document.getElementById('mediaPickerList').innerHTML = '';
      document.getElementById('mediaPickerEmpty').classList.remove('hidden');
      return;
    }
    document.getElementById('mediaPickerEmpty').classList.add('hidden');
    var html = '';
    for (var i = 0; i < media.length; i++) {
      var m = media[i];
      var cap = m.caption ? '<p class="text-xs text-gray-600 truncate mt-1">üìù ' + m.caption + '</p>' : '';
      html += '<div class="glass-card rounded-2xl p-4 cursor-pointer hover:scale-105 transition" onclick="selectMedia(\'' + m.file_id + '\')"><div class="text-center"><span class="text-4xl">' + getMediaIcon(m.file_type) + '</span><p class="font-medium text-sm mt-3 truncate">' + (m.file_name || m.file_type) + '</p>' + cap + '</div></div>';
    }
    document.getElementById('mediaPickerList').innerHTML = html;
  } catch(e) { console.error(e); }
}

function filterMediaPicker(t) { loadMediaPicker(t); }
function selectMedia(f) { if (mediaPickerTarget) document.getElementById(mediaPickerTarget).value = f; closeModal('mediaPickerModal'); }

async function loadAll() {
  await Promise.all([loadStats(), loadUsers(), loadPayments(), loadLessons(), loadCustDev(), loadFeedback(), loadPitch(), loadMedia('all'), loadPrice(), loadChannelLink(), loadChannelId(), loadFreeChannel(), loadSubscriptionPlans(), loadReminders(), loadFunnels()]);
  await loadPostLessonFlow();
}

async function loadStats() {
  try {
    var d = await (await fetch('/api/stats', {headers: {Authorization: auth}})).json();
    document.getElementById('totalUsers').textContent = d.total_users || 0;
    document.getElementById('paidUsers').textContent = d.paid_users || 0;
    document.getElementById('monthlyRevenue').textContent = fmtMoney(d.monthly_revenue || 0);
    document.getElementById('todayUsers').textContent = '+' + (d.today_users || 0);
    var el = document.getElementById('usersCountInfo'); if (el) el.textContent = d.total_users || 0;
    
    var fn = {0: 'Yangi', 1: 'Start', 2: '1-Dars', 3: 'CustDev', 4: '2-Dars', 5: 'CustDev', 6: '3-Dars', 7: 'CustDev', 8: '4-Dars', 9: 'Pitch', 10: 'Sotish', 11: 'Premium'};
    var funnelHtml = '';
    var fd = d.funnel_distribution || [];
    for (var i = 0; i < fd.length; i++) {
      funnelHtml += '<div class="glass-card rounded-2xl p-4 text-center"><p class="text-xs text-gray-500 mb-1">' + (fn[fd[i].funnel_step] || fd[i].funnel_step) + '</p><p class="text-2xl font-bold gradient-text">' + fd[i].count + '</p></div>';
    }
    document.getElementById('funnelStats').innerHTML = funnelHtml;
    
    var pa = await (await fetch('/api/payments/analytics', {headers: {Authorization: auth}})).json();
    document.getElementById('payToday').textContent = fmtMoney(pa.today && pa.today.amount || 0);
    document.getElementById('payTodayCount').textContent = (pa.today && pa.today.count || 0) + ' ta';
    document.getElementById('payWeek').textContent = fmtMoney(pa.week && pa.week.amount || 0);
    document.getElementById('payWeekCount').textContent = (pa.week && pa.week.count || 0) + ' ta';
    document.getElementById('payMonth').textContent = fmtMoney(pa.month && pa.month.amount || 0);
    document.getElementById('payMonthCount').textContent = (pa.month && pa.month.count || 0) + ' ta';
    document.getElementById('payYear').textContent = fmtMoney(pa.year && pa.year.amount || 0);
    document.getElementById('payYearCount').textContent = (pa.year && pa.year.count || 0) + ' ta';
    document.getElementById('paymeTotal').textContent = fmtMoney(pa.payme && pa.payme.amount || 0);
    document.getElementById('paymeCount').textContent = (pa.payme && pa.payme.count || 0) + ' ta';
    document.getElementById('clickTotal').textContent = fmtMoney(pa.click && pa.click.amount || 0);
    document.getElementById('clickCount').textContent = (pa.click && pa.click.count || 0) + ' ta';
    
    // Payment Method Chart
    var paymeAmt = pa.payme && pa.payme.amount || 0;
    var clickAmt = pa.click && pa.click.amount || 0;
    
    if (paymentMethodChart) paymentMethodChart.destroy();
    var pmCtx = document.getElementById('paymentMethodChart');
    if (pmCtx) {
      paymentMethodChart = new Chart(pmCtx, {
        type: 'doughnut',
        data: {
          labels: ['Payme', 'Click'],
          datasets: [{
            data: [paymeAmt / 100, clickAmt / 100],
            backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } }
          }
        }
      });
    }
    
    // Monthly Trend Chart
    if (monthlyTrendChart) monthlyTrendChart.destroy();
    var mtCtx = document.getElementById('monthlyTrendChart');
    if (mtCtx && pa.daily) {
      var dailyRev = (pa.daily || []).slice(-30).reverse();
      monthlyTrendChart = new Chart(mtCtx, {
        type: 'bar',
        data: {
          labels: dailyRev.map(function(d) { return d.date ? d.date.slice(5) : ''; }),
          datasets: [{
            data: dailyRev.map(function(d) { return d.amount / 100; }),
            backgroundColor: 'rgba(139, 92, 246, 0.6)',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } }
        }
      });
    }
    
    var sub = await (await fetch('/api/subscribers/daily', {headers: {Authorization: auth}})).json();
    if (sChart) sChart.destroy();
    var dl = (sub.daily || []).reverse().slice(-14);
    sChart = new Chart(document.getElementById('subscribersChart'), {
      type: 'line',
      data: {
        labels: dl.map(function(x) { return x.date ? x.date.slice(5, 10) : ''; }),
        datasets: [{data: dl.map(function(x) { return x.count; }), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', tension: 0.4, fill: true, borderWidth: 3, pointRadius: 0}]
      },
      options: {responsive: true, plugins: {legend: {display: false}}, scales: {x: {grid: {display: false}}, y: {grid: {color: 'rgba(0,0,0,0.05)'}}}}
    });
    
    if (rChart) rChart.destroy();
    var dr = (pa.daily || []).reverse().slice(-14);
    rChart = new Chart(document.getElementById('revenueChart'), {
      type: 'line',
      data: {
        labels: dr.map(function(x) { return x.date ? x.date.slice(5, 10) : ''; }),
        datasets: [{data: dr.map(function(x) { return x.amount / 100; }), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, fill: true, borderWidth: 3, pointRadius: 0}]
      },
      options: {responsive: true, plugins: {legend: {display: false}}, scales: {x: {grid: {display: false}}, y: {grid: {color: 'rgba(0,0,0,0.05)'}}}}
    });
  } catch(e) { console.error(e); }
}

async function loadUsers() {
  try {
    allUsers = await (await fetch('/api/users', {headers: {Authorization: auth}})).json();
    applyFilters();
    renderUserCharts();
  } catch(e) { console.error(e); }
}

function renderUserCharts() {
  // Premium vs Free chart
  var paid = 0, free = 0;
  for (var i = 0; i < allUsers.length; i++) {
    if (allUsers[i].is_paid) paid++; else free++;
  }
  
  if (userTypeChart) userTypeChart.destroy();
  var ctx1 = document.getElementById('userTypeChart');
  if (ctx1) {
    userTypeChart = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['Premium', 'Free'],
        datasets: [{
          data: [paid, free],
          backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(156, 163, 175, 0.5)'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } }
        }
      }
    });
  }
  
  // Lesson distribution chart
  var lessonDist = {};
  for (var j = 0; j < allUsers.length; j++) {
    var lesson = allUsers[j].current_lesson || 0;
    lessonDist[lesson] = (lessonDist[lesson] || 0) + 1;
  }
  var lessonLabels = Object.keys(lessonDist).sort(function(a,b) { return a - b; });
  var lessonData = lessonLabels.map(function(k) { return lessonDist[k]; });
  
  if (lessonDistChart) lessonDistChart.destroy();
  var ctx2 = document.getElementById('lessonDistChart');
  if (ctx2) {
    lessonDistChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: lessonLabels.map(function(l) { return l + '-dars'; }),
        datasets: [{
          data: lessonData,
          backgroundColor: 'rgba(139, 92, 246, 0.7)',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } }
      }
    });
  }
  
  // Weekly growth chart (last 7 days)
  var weeklyData = {};
  var today = new Date();
  for (var d = 6; d >= 0; d--) {
    var date = new Date(today);
    date.setDate(date.getDate() - d);
    var key = date.toISOString().slice(0, 10);
    weeklyData[key] = 0;
  }
  for (var u = 0; u < allUsers.length; u++) {
    if (allUsers[u].created_at) {
      var userDate = allUsers[u].created_at.slice(0, 10);
      if (weeklyData.hasOwnProperty(userDate)) {
        weeklyData[userDate]++;
      }
    }
  }
  
  if (weeklyGrowthChart) weeklyGrowthChart.destroy();
  var ctx3 = document.getElementById('weeklyGrowthChart');
  if (ctx3) {
    weeklyGrowthChart = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: Object.keys(weeklyData).map(function(d) { return d.slice(5); }),
        datasets: [{
          data: Object.values(weeklyData),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: '#f59e0b'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } }
      }
    });
  }
}

function renderUsers(u) {
  var html = '';
  for (var i = 0; i < u.length; i++) {
    var x = u[i];
    var status = x.is_paid ? '<span class="px-3 py-1 rounded-full bg-gradient-to-r from-emerald-400 to-green-500 text-white text-xs">Premium</span>' : '<span class="px-3 py-1 rounded-full glass text-xs">Free</span>';
    html += '<tr class="hover:bg-white/30 cursor-pointer transition" onclick="showUser(\'' + x.telegram_id + '\')"><td class="px-6 py-4 font-medium">' + (x.full_name || '-') + '</td><td class="px-6 py-4 text-gray-500">' + (x.phone || '-') + '</td><td class="px-6 py-4"><span class="px-3 py-1 rounded-full glass text-xs">' + (x.current_lesson || 0) + '/' + (allLessons.length || 4) + '</span></td><td class="px-6 py-4">' + status + '</td><td class="px-6 py-4 text-xl">' + (x.age_group ? '‚úÖ' : '‚è≥') + '</td><td class="px-6 py-4 text-gray-500">' + fmtDate(x.created_at) + '</td></tr>';
  }
  document.getElementById('usersTable').innerHTML = html;
}

function setFilter(type, value) {
  userFilters[type] = value;
  // Update button states
  document.querySelectorAll('[id^="filter-' + type + '-"]').forEach(function(btn) {
    btn.classList.remove('filter-btn-active');
  });
  var activeBtn = document.getElementById('filter-' + type + '-' + value);
  if (activeBtn) activeBtn.classList.add('filter-btn-active');
  applyFilters();
}

function applyFilters() {
  var q = document.getElementById('searchInput').value.toLowerCase();
  var lessonFilter = document.getElementById('filter-lesson').value;
  var sortBy = document.getElementById('filter-sort').value;
  
  var filtered = allUsers.filter(function(u) {
    // Text search
    var matchesSearch = (u.full_name || '').toLowerCase().indexOf(q) >= 0 || 
                        (u.phone || '').indexOf(q) >= 0 || 
                        (u.username || '').toLowerCase().indexOf(q) >= 0;
    if (!matchesSearch) return false;
    
    // Status filter
    if (userFilters.status === 'paid' && !u.is_paid) return false;
    if (userFilters.status === 'free' && u.is_paid) return false;
    
    // CustDev filter
    var hasCustdev = u.age_group || u.occupation || u.income_level || u.main_problem || u.goal;
    if (userFilters.custdev === 'done' && !hasCustdev) return false;
    if (userFilters.custdev === 'pending' && hasCustdev) return false;
    
    // Lesson filter
    if (lessonFilter !== 'all') {
      var userLesson = u.current_lesson || 0;
      if (lessonFilter === '5+') {
        if (userLesson < 5) return false;
      } else {
        if (userLesson !== parseInt(lessonFilter)) return false;
      }
    }
    
    return true;
  });
  
  // Sort
  filtered.sort(function(a, b) {
    switch(sortBy) {
      case 'newest':
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      case 'oldest':
        return new Date(a.created_at || 0) - new Date(b.created_at || 0);
      case 'name':
        return (a.full_name || '').localeCompare(b.full_name || '');
      case 'lesson-high':
        return (b.current_lesson || 0) - (a.current_lesson || 0);
      case 'lesson-low':
        return (a.current_lesson || 0) - (b.current_lesson || 0);
      default:
        return 0;
    }
  });
  
  document.getElementById('usersFilteredCount').textContent = '(' + filtered.length + ' / ' + allUsers.length + ')';
  renderUsers(filtered);
}

function filterUsers() {
  applyFilters();
}

function resetAllFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('filter-lesson').value = 'all';
  document.getElementById('filter-sort').value = 'newest';
  userFilters = { status: 'all', custdev: 'all', lesson: 'all', sort: 'newest' };
  
  // Reset button styles
  document.querySelectorAll('[id^="filter-status-"], [id^="filter-custdev-"]').forEach(function(btn) {
    btn.classList.remove('filter-btn-active');
  });
  document.getElementById('filter-status-all').classList.add('filter-btn-active');
  document.getElementById('filter-custdev-all').classList.add('filter-btn-active');
  
  applyFilters();
}

function showUser(tid) {
  var u = allUsers.find(function(x) { return String(x.telegram_id) === String(tid); });
  if (!u) return;
  
  var html = '';
  
  // Basic Info
  html += '<div class="grid grid-cols-2 gap-4 text-sm mb-6">';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üë§ Ism</p><p class="font-semibold">' + (u.full_name || '-') + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üì± Telefon</p><p class="font-semibold">' + (u.phone || '-') + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üì≤ Username</p><p class="font-semibold">' + (u.username ? '@' + u.username : '-') + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üÜî Telegram ID</p><p class="font-mono text-xs">' + u.telegram_id + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üìä Status</p><p class="font-semibold">' + (u.is_paid ? 'üíé Premium' : 'üÜì Free') + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üìö Joriy dars</p><p class="font-semibold">' + (u.current_lesson || 0) + '-dars</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üìÖ Qo\'shilgan</p><p class="font-semibold">' + fmtDateTime(u.created_at) + '</p></div>';
  html += '<div class="glass rounded-2xl p-4"><p class="text-xs text-gray-500 mb-1">üîÑ Funnel Step</p><p class="font-semibold">' + (u.funnel_step || 0) + '</p></div>';
  html += '</div>';
  
  // CustDev Info
  html += '<h3 class="font-bold mb-4 text-lg">üìù CustDev Ma\'lumotlari</h3>';
  
  var hasCustdev = u.age_group || u.occupation || u.income_level || u.main_problem || u.goal || u.previous_courses || u.budget_range;
  
  if (hasCustdev) {
    html += '<div class="space-y-3">';
    
    if (u.age_group) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üìä</span><p class="text-xs text-gray-500">Yosh guruhi</p></div><p class="font-medium">' + u.age_group + '</p></div>';
    }
    
    if (u.occupation) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üíº</span><p class="text-xs text-gray-500">Kasb / Faoliyat</p></div><p class="font-medium">' + u.occupation + '</p></div>';
    }
    
    if (u.income_level) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üí∞</span><p class="text-xs text-gray-500">Daromad darajasi</p></div><p class="font-medium">' + u.income_level + '</p></div>';
    }
    
    if (u.previous_courses) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üìö</span><p class="text-xs text-gray-500">Oldin kurs o\'qiganmi</p></div><p class="font-medium">' + u.previous_courses + '</p></div>';
    }
    
    if (u.budget_range) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üíµ</span><p class="text-xs text-gray-500">Byudjet</p></div><p class="font-medium">' + u.budget_range + '</p></div>';
    }
    
    if (u.main_problem) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üò∞</span><p class="text-xs text-gray-500">Asosiy muammo</p></div><p class="font-medium text-gray-700">' + u.main_problem + '</p></div>';
    }
    
    if (u.goal) {
      html += '<div class="glass rounded-2xl p-4"><div class="flex items-center gap-2 mb-1"><span class="text-lg">üéØ</span><p class="text-xs text-gray-500">Maqsad</p></div><p class="font-medium text-gray-700">' + u.goal + '</p></div>';
    }
    
    html += '</div>';
  } else {
    html += '<div class="glass rounded-2xl p-6 text-center text-gray-400"><span class="text-3xl mb-2 block">‚è≥</span>CustDev ma\'lumotlari hali yo\'q</div>';
  }
  
  // Actions
  html += '<div class="mt-6 pt-4 border-t border-gray-200 flex gap-3">';
  html += '<a href="https://t.me/' + (u.username || '') + '" target="_blank" class="flex-1 py-3 rounded-xl glass-btn text-white text-center font-medium ' + (u.username ? '' : 'opacity-50 pointer-events-none') + '">üí¨ Telegram</a>';
  html += '<button onclick="copyUserInfo(\'' + u.telegram_id + '\')" class="flex-1 py-3 rounded-xl glass text-gray-700 font-medium">üìã Nusxalash</button>';
  html += '</div>';
  
  document.getElementById('userModalContent').innerHTML = html;
  openModal('userModal');
}

function exportExcel() {
  if (!allUsers.length) return alert('Ma\'lumot yo\'q');
  var h = ['Ism', 'Telefon', 'Username', 'Telegram ID', 'Status', 'Dars', 'Yosh', 'Kasb', 'Daromad', 'Sana'];
  var rows = allUsers.map(function(u) {
    return [u.full_name || '', u.phone || '', u.username || '', u.telegram_id, u.is_paid ? 'Premium' : 'Free', u.current_lesson || 0, u.age_group || '', u.occupation || '', u.income_level || '', fmtDate(u.created_at)];
  });
  var csv = '\uFEFF' + h.join(',') + '\n';
  rows.forEach(function(row) {
    csv += row.map(function(c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(',') + '\n';
  });
  var b = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(b);
  a.download = 'users_' + fmtDate(new Date()) + '.csv';
  a.click();
}

async function loadPayments() {
  try {
    allPayments = await (await fetch('/api/payments', {headers: {Authorization: auth}})).json();
    var html = '';
    var items = allPayments.slice(0, 20);
    for (var i = 0; i < items.length; i++) {
      var x = items[i];
      var provider;
      if (x.payment_method === 'payme') {
        provider = '<span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs">üí≥ Payme</span>';
      } else if (x.payment_method === 'click') {
        provider = '<span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs">üí† Click</span>';
      } else {
        provider = '<span class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-xs">‚ùì -</span>';
      }
      var status = x.state === 'performed' ? '‚úÖ' : (x.state === 'created' ? '‚è≥' : 'üîò');
      html += '<tr onclick="openBuyerModal(' + i + ')" class="hover:bg-white/30 transition cursor-pointer"><td class="px-6 py-4 text-gray-500">' + fmtDateTime(x.created_at) + '</td><td class="px-6 py-4 font-medium">' + (x.full_name || x.telegram_id) + '</td><td class="px-6 py-4 font-bold gradient-text-green">' + fmtMoney(x.amount || 0) + '</td><td class="px-6 py-4">' + provider + '</td><td class="px-6 py-4 text-xl">' + status + '</td></tr>';
    }
    document.getElementById('paymentsTable').innerHTML = html || '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    
    // Load buyer analytics
    loadBuyerAnalytics();
  } catch(e) { console.error(e); }
}

// ============ Buyer Modal Functions ============
async function openBuyerModal(index) {
  var payment = allPayments[index];
  if (!payment) return;
  
  // Find user data
  var user = allUsers.find(function(u) { return String(u.telegram_id) === String(payment.telegram_id); });
  
  // Basic info
  document.getElementById('buyerName').textContent = payment.full_name || user?.full_name || '-';
  document.getElementById('buyerPhone').textContent = user?.phone || '-';
  document.getElementById('buyerUsername').textContent = user?.username ? '@' + user.username : '-';
  document.getElementById('buyerTelegramId').textContent = payment.telegram_id || '-';
  
  // Payment info
  document.getElementById('buyerAmount').textContent = fmtMoney(payment.amount || 0);
  document.getElementById('buyerMethod').textContent = payment.payment_method === 'payme' ? 'üí≥ Payme' : (payment.payment_method === 'click' ? 'üí† Click' : '‚ùì Noma\'lum');
  document.getElementById('buyerPaymentDate').textContent = fmtDateTime(payment.created_at);
  document.getElementById('buyerStatus').textContent = payment.state === 'performed' ? '‚úÖ To\'langan' : '‚è≥ Kutilmoqda';
  
  // Time analysis
  var regDate = user?.created_at ? new Date(user.created_at) : null;
  var payDate = payment.created_at ? new Date(payment.created_at) : null;
  
  document.getElementById('buyerRegistered').textContent = regDate ? fmtDateTime(regDate) : '-';
  document.getElementById('buyerPurchased').textContent = payDate ? fmtDateTime(payDate) : '-';
  
  if (regDate && payDate) {
    var diffMs = payDate - regDate;
    document.getElementById('buyerTimeToPurchase').textContent = formatTimeDiff(diffMs);
  } else {
    document.getElementById('buyerTimeToPurchase').textContent = '-';
  }
  
  // CustDev data
  var custdevHtml = '';
  if (user && (user.age_group || user.occupation || user.income_level || user.main_problem || user.goal)) {
    custdevHtml += '<div class="grid grid-cols-2 gap-3">';
    if (user.age_group) custdevHtml += '<div class="glass rounded-xl p-3"><p class="text-xs text-gray-400">üë§ Yosh</p><p class="font-medium">' + user.age_group + '</p></div>';
    if (user.occupation) custdevHtml += '<div class="glass rounded-xl p-3"><p class="text-xs text-gray-400">üíº Kasb</p><p class="font-medium">' + user.occupation + '</p></div>';
    if (user.income_level) custdevHtml += '<div class="glass rounded-xl p-3"><p class="text-xs text-gray-400">üí∞ Daromad</p><p class="font-medium">' + user.income_level + '</p></div>';
    if (user.main_problem) custdevHtml += '<div class="glass rounded-xl p-3 col-span-2"><p class="text-xs text-gray-400">üò∞ Muammo</p><p class="font-medium">' + user.main_problem + '</p></div>';
    if (user.goal) custdevHtml += '<div class="glass rounded-xl p-3 col-span-2"><p class="text-xs text-gray-400">üéØ Maqsad</p><p class="font-medium">' + user.goal + '</p></div>';
    custdevHtml += '</div>';
  } else {
    custdevHtml = '<p class="text-gray-400 text-center">CustDev ma\'lumotlari yo\'q</p>';
  }
  document.getElementById('buyerCustdevData').innerHTML = custdevHtml;
  
  // Telegram link
  var tgLink = user?.username ? 'https://t.me/' + user.username : 'tg://user?id=' + payment.telegram_id;
  document.getElementById('buyerTelegramLink').href = tgLink;
  
  openModal('buyerModal');
}

function formatTimeDiff(ms) {
  if (ms < 0) return '-';
  
  var seconds = Math.floor(ms / 1000);
  var minutes = Math.floor(seconds / 60);
  var hours = Math.floor(minutes / 60);
  var days = Math.floor(hours / 24);
  
  if (days > 0) {
    return days + ' kun ' + (hours % 24) + ' soat';
  } else if (hours > 0) {
    return hours + ' soat ' + (minutes % 60) + ' daqiqa';
  } else if (minutes > 0) {
    return minutes + ' daqiqa';
  } else {
    return seconds + ' soniya';
  }
}

async function loadBuyerAnalytics() {
  try {
    // Get buyer analytics from API
    var analytics = await (await fetch('/api/payments/buyer-analytics', {headers: {Authorization: auth}})).json();
    
    // Time to purchase stats
    if (analytics.avgTimeToPurchase !== undefined) {
      document.getElementById('avgTimeToPurchase').textContent = formatTimeDiff(analytics.avgTimeToPurchase);
    }
    if (analytics.fastestPurchase !== undefined) {
      document.getElementById('fastestPurchase').textContent = formatTimeDiff(analytics.fastestPurchase);
    }
    if (analytics.slowestPurchase !== undefined) {
      document.getElementById('slowestPurchase').textContent = formatTimeDiff(analytics.slowestPurchase);
    }
    if (analytics.conversionRate !== undefined) {
      document.getElementById('conversionRate').textContent = analytics.conversionRate.toFixed(1) + '%';
    }
    
    // Age distribution
    var ageHtml = '';
    var ageData = analytics.buyersByAge || {};
    Object.keys(ageData).forEach(function(age) {
      ageHtml += '<div class="flex justify-between items-center text-sm"><span>' + age + '</span><span class="font-bold text-violet-600">' + ageData[age] + '</span></div>';
    });
    document.getElementById('buyerAgeStats').innerHTML = ageHtml || '<p class="text-gray-400 text-xs text-center">Ma\'lumot yo\'q</p>';
    
    // Occupation distribution
    var occHtml = '';
    var occData = analytics.buyersByOccupation || {};
    Object.keys(occData).forEach(function(occ) {
      occHtml += '<div class="flex justify-between items-center text-sm"><span class="truncate mr-2">' + occ + '</span><span class="font-bold text-violet-600">' + occData[occ] + '</span></div>';
    });
    document.getElementById('buyerOccupationStats').innerHTML = occHtml || '<p class="text-gray-400 text-xs text-center">Ma\'lumot yo\'q</p>';
    
    // Problem distribution
    var probHtml = '';
    var probData = analytics.buyersByProblem || {};
    Object.keys(probData).forEach(function(prob) {
      probHtml += '<div class="flex justify-between items-center text-sm"><span class="truncate mr-2">' + prob + '</span><span class="font-bold text-violet-600">' + probData[prob] + '</span></div>';
    });
    document.getElementById('buyerProblemStats').innerHTML = probHtml || '<p class="text-gray-400 text-xs text-center">Ma\'lumot yo\'q</p>';
    
  } catch(e) { 
    console.error('Buyer analytics error:', e);
  }
}

async function loadLessons() {
  try {
    allLessons = await (await fetch('/api/lessons', {headers: {Authorization: auth}})).json();
    var el = document.getElementById('lessonsCountInfo'); if (el) el.textContent = allLessons.length;
    var html = '';
    for (var i = 0; i < allLessons.length; i++) {
      var l = allLessons[i];
      var h = l.delay_hours || 0;
      var dt;
      if (h === 0) dt = 'üöÄ Darhol';
      else if (h >= 24 && h % 24 === 0) dt = '‚è∞ ' + (h / 24) + ' kun';
      else dt = '‚è∞ ' + h + ' soat';
      html += '<div class="p-4 hover:bg-white/30 transition border-b border-white/10">' +
        '<div class="flex justify-between items-start gap-3">' +
          '<div class="flex-1 min-w-0">' +
            '<p class="font-bold text-gray-800 text-sm md:text-base">' + l.lesson_number + '-DARS: ' + l.title + '</p>' +
            '<div class="flex flex-wrap gap-2 mt-2">' +
              '<span class="px-2 py-1 rounded-full glass text-xs">' + dt + '</span>' +
              (l.video_file_id ? '<span class="text-sm">üìπ</span>' : '') +
              (l.image_file_id ? '<span class="text-sm">üñº</span>' : '') +
              (l.show_watched_button !== false ? '<span class="text-sm">üîò</span>' : '') +
            '</div>' +
          '</div>' +
          '<div class="flex gap-2 flex-shrink-0">' +
            '<button type="button" data-action="edit-lesson" data-id="' + l.lesson_number + '" class="action-btn w-12 h-12 rounded-xl glass-card flex items-center justify-center text-xl hover:bg-violet-100 active:bg-violet-200">‚úèÔ∏è</button>' +
            '<button type="button" data-action="delete-lesson" data-id="' + l.lesson_number + '" class="action-btn w-12 h-12 rounded-xl glass-card flex items-center justify-center text-xl text-red-500 hover:bg-red-100 active:bg-red-200">üóëÔ∏è</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }
    document.getElementById('lessonsList').innerHTML = html || '<p class="p-6 text-gray-400 text-center">Darslar yo\'q</p>';
  } catch(e) { console.error('loadLessons error:', e); }
}

function addLesson() {
  document.getElementById('lessonModalTitle').textContent = '‚ûï Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonContent').value = '';
  document.getElementById('lessonVideo').value = '';
  document.getElementById('lessonImage').value = '';
  document.getElementById('lessonAudio').value = '';
  document.getElementById('delayImmediate').checked = true;
  document.getElementById('lessonDelayValue').value = '24';
  document.getElementById('lessonDelayUnit').value = 'hours';
  toggleDelayInput();
  document.getElementById('lessonShowBtn').checked = true;
  document.getElementById('lessonBtnText').value = 'Videoni ko\'rib bo\'ldim ‚úÖ';
  openModal('lessonModal');
}

function editLesson(n) {
  var l = allLessons.find(function(x) { return x.lesson_number === n; });
  if (!l) return;
  document.getElementById('lessonModalTitle').textContent = '‚úèÔ∏è ' + n + '-Dars';
  document.getElementById('lessonId').value = n;
  document.getElementById('lessonTitle').value = l.title || '';
  document.getElementById('lessonContent').value = l.content || '';
  document.getElementById('lessonVideo').value = l.video_file_id || '';
  document.getElementById('lessonImage').value = l.image_file_id || '';
  document.getElementById('lessonAudio').value = l.audio_file_id || '';
  
  var h = l.delay_hours || 0;
  if (h === 0) {
    document.getElementById('delayImmediate').checked = true;
    document.getElementById('lessonDelayValue').value = '24';
    document.getElementById('lessonDelayUnit').value = 'hours';
  } else {
    document.getElementById('delayTimed').checked = true;
    if (h % 24 === 0 && h >= 24) {
      document.getElementById('lessonDelayValue').value = h / 24;
      document.getElementById('lessonDelayUnit').value = 'days';
    } else {
      document.getElementById('lessonDelayValue').value = h;
      document.getElementById('lessonDelayUnit').value = 'hours';
    }
  }
  toggleDelayInput();
  
  document.getElementById('lessonShowBtn').checked = l.show_watched_button !== false;
  document.getElementById('lessonBtnText').value = l.watched_button_text || 'Videoni ko\'rib bo\'ldim ‚úÖ';
  openModal('lessonModal');
}

function toggleDelayInput() {
  var isImmediate = document.getElementById('delayImmediate').checked;
  document.getElementById('delayInputDiv').classList.toggle('hidden', isImmediate);
}

function getDelayHours() {
  if (document.getElementById('delayImmediate').checked) return 0;
  var v = parseInt(document.getElementById('lessonDelayValue').value) || 1;
  return document.getElementById('lessonDelayUnit').value === 'days' ? v * 24 : v;
}

async function saveLesson() {
  var id = document.getElementById('lessonId').value;
  var data = {
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonContent').value,
    video_file_id: document.getElementById('lessonVideo').value || null,
    image_file_id: document.getElementById('lessonImage').value || null,
    audio_file_id: document.getElementById('lessonAudio').value || null,
    delay_hours: getDelayHours(),
    show_watched_button: document.getElementById('lessonShowBtn').checked,
    watched_button_text: document.getElementById('lessonBtnText').value
  };
  try {
    var r;
    if (id) {
      r = await fetch('/api/lessons/' + id, {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    } else {
      r = await fetch('/api/lessons', {method: 'POST', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    }
    var res = await r.json();
    if (!r.ok) throw new Error(res.error || 'Xatolik');
    closeModal('lessonModal');
    await loadLessons();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå ' + e.message); }
}

async function deleteLesson(n) {
  if (!confirm(n + '-darsni o\'chirmoqchimisiz?')) return;
  try { await fetch('/api/lessons/' + n, {method: 'DELETE', headers: {Authorization: auth}}); loadLessons(); }
  catch(e) { alert('Xatolik'); }
}

async function loadCustDev() {
  try {
    allCustDev = await (await fetch('/api/custdev', {headers: {Authorization: auth}})).json();
    var el = document.getElementById('custdevCountInfo'); if (el) el.textContent = allCustDev.length;
    document.getElementById('custdevTotalQ').textContent = allCustDev.length;
    
    // Calculate answered users
    var answered = 0;
    var notAnswered = 0;
    for (var i = 0; i < allUsers.length; i++) {
      if (allUsers[i].age_group || allUsers[i].occupation || allUsers[i].income_level || allUsers[i].main_problem || allUsers[i].goal) {
        answered++;
      } else {
        notAnswered++;
      }
    }
    document.getElementById('custdevAnswered').textContent = answered;
    document.getElementById('custdevNotAnswered').textContent = notAnswered;
    var conversion = allUsers.length > 0 ? Math.round((answered / allUsers.length) * 100) : 0;
    document.getElementById('custdevConversion').textContent = conversion + '%';
    
    if (!allCustDev.length) {
      document.getElementById('custdevList').innerHTML = '<p class="p-6 text-gray-400 text-center">Savollar yo\'q</p>';
      return;
    }
    
    var g = {};
    for (var i = 0; i < allCustDev.length; i++) {
      var q = allCustDev[i];
      var k = q.after_lesson || 1;
      if (!g[k]) g[k] = [];
      g[k].push(q);
    }
    
    var html = '';
    var keys = Object.keys(g).sort(function(a, b) { return Number(a) - Number(b); });
    for (var j = 0; j < keys.length; j++) {
      var key = keys[j];
      html += '<div class="p-4"><p class="text-xs font-semibold text-violet-600 mb-3">üìö ' + key + '-darsdan keyin</p>';
      for (var m = 0; m < g[key].length; m++) {
        var qq = g[key][m];
        var o = '';
        if (qq.question_type === 'buttons' && qq.options) {
          try {
            var parsed = typeof qq.options === 'string' ? JSON.parse(qq.options) : qq.options;
            o = 'Tugmalar: ' + parsed.join(', ');
          } catch(e) { o = 'Tugmalar'; }
        } else { o = 'Matn'; }
        html += '<div class="p-4 glass rounded-2xl mb-2 flex justify-between items-start"><div class="flex-1"><p class="font-medium">' + (qq.question_text.length > 60 ? qq.question_text.slice(0, 60) + '...' : qq.question_text) + '</p><p class="text-xs text-gray-500 mt-1">' + o + (qq.field_name ? ' ‚Üí ' + qq.field_name : '') + '</p></div><div class="flex gap-2 ml-3"><button type="button" data-action="edit-custdev" data-id="' + qq.id + '" class="action-btn w-10 h-10 rounded-lg glass flex items-center justify-center text-base hover:bg-violet-100">‚úèÔ∏è</button><button type="button" data-action="delete-custdev" data-id="' + qq.id + '" class="action-btn w-10 h-10 rounded-lg glass flex items-center justify-center text-base text-red-500 hover:bg-red-100">üóëÔ∏è</button></div></div>';
      }
      html += '</div>';
    }
    document.getElementById('custdevList').innerHTML = html;
    
    var st = {};
    var fields = ['age_group', 'occupation', 'income_level', 'main_problem', 'previous_courses', 'budget_range', 'goal'];
    for (var f = 0; f < fields.length; f++) {
      st[fields[f]] = {};
      for (var u = 0; u < allUsers.length; u++) {
        if (allUsers[u][fields[f]]) {
          var val = allUsers[u][fields[f]];
          st[fields[f]][val] = (st[fields[f]][val] || 0) + 1;
        }
      }
    }
    var fn = {
      age_group: 'üìä Yosh guruhi', 
      occupation: 'üíº Kasb/Faoliyat', 
      income_level: 'üí∞ Daromad darajasi',
      main_problem: 'üò∞ Asosiy muammo',
      previous_courses: 'üìö Oldin kurs o\'qiganmi',
      budget_range: 'üíµ Byudjet',
      goal: 'üéØ Maqsad'
    };
    var statsHtml = '';
    for (var ff = 0; ff < fields.length; ff++) {
      var field = fields[ff];
      var entries = Object.entries(st[field]).sort(function(a, b) { return b[1] - a[1]; });
      if (!entries.length) continue;
      
      var total = entries.reduce(function(sum, e) { return sum + e[1]; }, 0);
      statsHtml += '<div class="glass rounded-2xl p-5"><div class="flex justify-between items-center mb-4"><p class="font-semibold text-gray-700">' + (fn[field] || field) + '</p><span class="text-xs text-gray-400">' + total + ' ta javob</span></div><div class="max-h-48 overflow-y-auto scrollbar-thin pr-2">';
      
      for (var e = 0; e < entries.length; e++) {
        var percent = Math.round((entries[e][1] / total) * 100);
        var barColor = e === 0 ? 'from-violet-400 to-purple-500' : (e === 1 ? 'from-emerald-400 to-green-500' : 'from-blue-400 to-cyan-500');
        var displayText = entries[e][0].length > 50 ? entries[e][0].slice(0, 50) + '...' : entries[e][0];
        statsHtml += '<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span class="text-gray-600 truncate mr-2" title="' + entries[e][0].replace(/"/g, '&quot;') + '">' + displayText + '</span><span class="font-bold gradient-text whitespace-nowrap">' + entries[e][1] + ' <span class="text-gray-400 font-normal">(' + percent + '%)</span></span></div><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-gradient-to-r ' + barColor + ' h-2 rounded-full transition-all" style="width: ' + percent + '%"></div></div></div>';
      }
      statsHtml += '</div></div>';
    }
    if (!statsHtml) statsHtml = '<div class="col-span-full text-center text-gray-400 py-8">CustDev ma\'lumotlari yo\'q</div>';
    document.getElementById('custdevStats').innerHTML = statsHtml;
    
    // Render CustDev Charts
    renderCustDevCharts(st);
  } catch(e) { console.error(e); }
}

// ============ Feedback Functions ============
var allFeedback = [];

async function loadFeedback() {
  try {
    allFeedback = await (await fetch('/api/feedback', {headers: {Authorization: auth}})).json();
    renderFeedback();
    
    // Load stats
    var stats = await (await fetch('/api/feedback/stats', {headers: {Authorization: auth}})).json();
    var liked = 0, disliked = 0;
    for (var i = 0; i < stats.length; i++) {
      if (stats[i].feedback_type === 'liked') liked = parseInt(stats[i].count);
      if (stats[i].feedback_type === 'disliked') disliked = parseInt(stats[i].count);
    }
    document.getElementById('feedbackLiked').textContent = liked;
    document.getElementById('feedbackDisliked').textContent = disliked;
    document.getElementById('feedbackTotal').textContent = liked + disliked;
  } catch(e) { console.error(e); }
}

function renderFeedback() {
  var filter = document.getElementById('feedbackFilter').value;
  var filtered = allFeedback;
  
  if (filter === 'liked') {
    filtered = allFeedback.filter(function(f) { return f.feedback_type === 'liked'; });
  } else if (filter === 'disliked') {
    filtered = allFeedback.filter(function(f) { return f.feedback_type === 'disliked'; });
  }
  
  if (!filtered.length) {
    document.getElementById('feedbackList').innerHTML = '<p class="text-gray-500 text-center py-8">Feedback yo\'q</p>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var f = filtered[i];
    var isLiked = f.feedback_type === 'liked';
    var bgClass = isLiked ? 'bg-green-50 border-green-200 hover:bg-green-100' : 'bg-red-50 border-red-200 hover:bg-red-100';
    var iconClass = isLiked ? 'üëç' : 'üëé';
    var date = new Date(f.created_at).toLocaleDateString('uz-UZ') + ' ' + new Date(f.created_at).toLocaleTimeString('uz-UZ', {hour: '2-digit', minute: '2-digit'});
    
    html += '<div class="p-4 rounded-2xl border cursor-pointer transition-all ' + bgClass + '" onclick=\'showFeedbackUserCard(' + JSON.stringify(f).replace(/'/g, "\\'") + ')\'>';
    html += '<div class="flex justify-between items-start">';
    html += '<div class="flex items-start gap-3">';
    html += '<span class="text-2xl">' + iconClass + '</span>';
    html += '<div>';
    html += '<p class="font-medium">' + (f.full_name || 'Nomsiz') + '</p>';
    html += '<p class="text-sm text-gray-500">@' + (f.username || '-') + ' | ' + (f.phone || '-') + '</p>';
    if (f.feedback_text && f.feedback_text !== 'Bepul darslar yoqdi') {
      html += '<p class="mt-2 p-2 bg-white rounded-lg text-gray-700">"' + f.feedback_text + '"</p>';
    }
    html += '</div>';
    html += '</div>';
    html += '<div class="text-right">';
    html += '<span class="text-xs text-gray-400">' + date + '</span>';
    html += '<p class="text-xs text-violet-500 mt-1">üëÜ Batafsil</p>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
  }
  
  document.getElementById('feedbackList').innerHTML = html;
}

function showFeedbackUserCard(feedback) {
  // Find full user data
  var user = allUsers.find(function(u) { return u.telegram_id == feedback.telegram_id; });
  
  var html = '<div class="space-y-4">';
  
  // User avatar and basic info
  html += '<div class="flex items-center gap-4 p-4 glass rounded-2xl">';
  html += '<div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold">';
  html += (feedback.full_name || 'N').charAt(0).toUpperCase();
  html += '</div>';
  html += '<div class="flex-1">';
  html += '<h3 class="font-bold text-xl">' + (feedback.full_name || 'Nomsiz') + '</h3>';
  html += '<p class="text-gray-500">@' + (feedback.username || 'username yo\'q') + '</p>';
  html += '</div>';
  html += '<div class="text-right">';
  if (feedback.feedback_type === 'liked') {
    html += '<span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-medium">üëç Yoqdi</span>';
  } else {
    html += '<span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-sm font-medium">üëé Yoqmadi</span>';
  }
  html += '</div>';
  html += '</div>';
  
  // Feedback text
  if (feedback.feedback_text && feedback.feedback_text !== 'Bepul darslar yoqdi') {
    html += '<div class="p-4 glass rounded-2xl">';
    html += '<p class="text-sm text-gray-500 mb-2">üí¨ Sababi:</p>';
    html += '<p class="text-lg font-medium text-gray-800">"' + feedback.feedback_text + '"</p>';
    html += '</div>';
  }
  
  // Contact info
  html += '<div class="grid grid-cols-2 gap-3">';
  html += '<div class="p-4 glass rounded-2xl">';
  html += '<p class="text-xs text-gray-500 mb-1">üì± Telefon</p>';
  html += '<p class="font-medium">' + (feedback.phone || 'Yo\'q') + '</p>';
  html += '</div>';
  html += '<div class="p-4 glass rounded-2xl">';
  html += '<p class="text-xs text-gray-500 mb-1">üÜî Telegram ID</p>';
  html += '<p class="font-medium font-mono">' + feedback.telegram_id + '</p>';
  html += '</div>';
  html += '</div>';
  
  // User stats (if available)
  if (user) {
    html += '<div class="grid grid-cols-3 gap-3">';
    html += '<div class="p-3 glass rounded-xl text-center">';
    html += '<p class="text-2xl font-bold text-violet-600">' + (user.current_lesson || 0) + '</p>';
    html += '<p class="text-xs text-gray-500">Dars</p>';
    html += '</div>';
    html += '<div class="p-3 glass rounded-xl text-center">';
    html += '<p class="text-2xl font-bold ' + (user.is_paid ? 'text-green-600' : 'text-gray-400') + '">' + (user.is_paid ? 'üíé' : 'üÜì') + '</p>';
    html += '<p class="text-xs text-gray-500">' + (user.is_paid ? 'Premium' : 'Free') + '</p>';
    html += '</div>';
    html += '<div class="p-3 glass rounded-xl text-center">';
    html += '<p class="text-2xl font-bold text-blue-600">' + (user.funnel_step || 0) + '</p>';
    html += '<p class="text-xs text-gray-500">Funnel</p>';
    html += '</div>';
    html += '</div>';
    
    // Additional user info
    if (user.age_group || user.occupation || user.income_level) {
      html += '<div class="p-4 glass rounded-2xl">';
      html += '<p class="text-sm text-gray-500 mb-3">üìä CustDev ma\'lumotlari:</p>';
      html += '<div class="space-y-2">';
      if (user.age_group) html += '<p><span class="text-gray-500">Yosh:</span> <span class="font-medium">' + user.age_group + '</span></p>';
      if (user.occupation) html += '<p><span class="text-gray-500">Kasb:</span> <span class="font-medium">' + user.occupation + '</span></p>';
      if (user.income_level) html += '<p><span class="text-gray-500">Daromad:</span> <span class="font-medium">' + user.income_level + '</span></p>';
      if (user.main_problem) html += '<p><span class="text-gray-500">Muammo:</span> <span class="font-medium">' + user.main_problem + '</span></p>';
      html += '</div>';
      html += '</div>';
    }
    
    // Registration date
    html += '<div class="p-3 glass rounded-xl text-center">';
    html += '<p class="text-xs text-gray-500">Ro\'yxatdan o\'tgan: ' + new Date(user.created_at).toLocaleDateString('uz-UZ') + '</p>';
    html += '</div>';
  }
  
  // Feedback date
  html += '<div class="p-3 bg-gray-100 rounded-xl text-center">';
  html += '<p class="text-xs text-gray-500">Feedback vaqti: ' + new Date(feedback.created_at).toLocaleString('uz-UZ') + '</p>';
  html += '</div>';
  
  // Action buttons
  html += '<div class="flex gap-2">';
  html += '<a href="https://t.me/' + (feedback.username || '') + '" target="_blank" class="flex-1 py-3 rounded-xl glass-btn text-white text-center font-medium">üí¨ Telegram</a>';
  html += '<button onclick="closeCustomModal()" class="flex-1 py-3 rounded-xl glass text-gray-700 font-medium">Yopish</button>';
  html += '</div>';
  
  html += '</div>';
  
  showCustomModal('üë§ ' + (feedback.full_name || 'Foydalanuvchi'), html);
}

function filterFeedback() {
  renderFeedback();
}

function renderCustDevCharts(st) {
  var chartColors = [
    'rgba(139, 92, 246, 0.8)',
    'rgba(16, 185, 129, 0.8)',
    'rgba(59, 130, 246, 0.8)',
    'rgba(245, 158, 11, 0.8)',
    'rgba(239, 68, 68, 0.8)',
    'rgba(168, 85, 247, 0.8)'
  ];
  
  // Age Chart
  if (ageChart) ageChart.destroy();
  var ageCtx = document.getElementById('ageChart');
  if (ageCtx && st.age_group) {
    var ageData = Object.entries(st.age_group).sort(function(a,b) { return b[1] - a[1]; });
    ageChart = new Chart(ageCtx, {
      type: 'doughnut',
      data: {
        labels: ageData.map(function(e) { return e[0]; }),
        datasets: [{
          data: ageData.map(function(e) { return e[1]; }),
          backgroundColor: chartColors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } } }
      }
    });
  }
  
  // Occupation Chart
  if (occupationChart) occupationChart.destroy();
  var occCtx = document.getElementById('occupationChart');
  if (occCtx && st.occupation) {
    var occData = Object.entries(st.occupation).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 5);
    occupationChart = new Chart(occCtx, {
      type: 'bar',
      data: {
        labels: occData.map(function(e) { return e[0].length > 12 ? e[0].slice(0, 12) + '...' : e[0]; }),
        datasets: [{
          data: occData.map(function(e) { return e[1]; }),
          backgroundColor: 'rgba(16, 185, 129, 0.7)',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, y: { grid: { display: false } } }
      }
    });
  }
  
  // Income Chart
  if (incomeChart) incomeChart.destroy();
  var incCtx = document.getElementById('incomeChart');
  if (incCtx && st.income_level) {
    var incData = Object.entries(st.income_level).sort(function(a,b) { return b[1] - a[1]; });
    incomeChart = new Chart(incCtx, {
      type: 'doughnut',
      data: {
        labels: incData.map(function(e) { return e[0]; }),
        datasets: [{
          data: incData.map(function(e) { return e[1]; }),
          backgroundColor: chartColors.slice().reverse(),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } } }
      }
    });
  }
  
  // Budget Chart
  if (budgetChart) budgetChart.destroy();
  var budCtx = document.getElementById('budgetChart');
  if (budCtx && st.budget_range) {
    var budData = Object.entries(st.budget_range).sort(function(a,b) { return b[1] - a[1]; });
    budgetChart = new Chart(budCtx, {
      type: 'pie',
      data: {
        labels: budData.map(function(e) { return e[0]; }),
        datasets: [{
          data: budData.map(function(e) { return e[1]; }),
          backgroundColor: chartColors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } } }
      }
    });
  }
}

function toggleCustdevOptions() {
  document.getElementById('custdevOptionsDiv').style.display = document.getElementById('custdevType').value === 'buttons' ? 'block' : 'none';
}

function addCustDev() {
  document.getElementById('custdevModalTitle').textContent = '‚ûï Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevText').value = '';
  document.getElementById('custdevLesson').value = '1';
  document.getElementById('custdevType').value = 'buttons';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevField').value = '';
  document.getElementById('custdevOptionsDiv').style.display = 'block';
  openModal('custdevModal');
}

function editCustDev(id) {
  var q = allCustDev.find(function(x) { return x.id === id; });
  if (!q) return;
  document.getElementById('custdevModalTitle').textContent = '‚úèÔ∏è Savol';
  document.getElementById('custdevId').value = id;
  document.getElementById('custdevText').value = q.question_text;
  document.getElementById('custdevLesson').value = q.after_lesson || 1;
  document.getElementById('custdevType').value = q.question_type || 'buttons';
  var ot = '';
  if (q.options) {
    try {
      var p = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
      ot = p.join('\n');
    } catch(e) {}
  }
  document.getElementById('custdevOptions').value = ot;
  document.getElementById('custdevField').value = q.field_name || '';
  document.getElementById('custdevOptionsDiv').style.display = q.question_type === 'buttons' ? 'block' : 'none';
  openModal('custdevModal');
}

async function saveCustDev() {
  var id = document.getElementById('custdevId').value;
  var opts = document.getElementById('custdevOptions').value.split('\n').map(function(x) { return x.trim(); }).filter(Boolean);
  var data = {
    question_text: document.getElementById('custdevText').value,
    after_lesson: parseInt(document.getElementById('custdevLesson').value) || 1,
    question_type: document.getElementById('custdevType').value,
    options: document.getElementById('custdevType').value === 'buttons' ? opts : null,
    field_name: document.getElementById('custdevField').value || null
  };
  try {
    if (id) {
      await fetch('/api/custdev/' + id, {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    } else {
      await fetch('/api/custdev', {method: 'POST', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    }
    closeModal('custdevModal');
    loadCustDev();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå Xatolik'); }
}

async function deleteCustDev(id) {
  if (!confirm('O\'chirmoqchimisiz?')) return;
  try { await fetch('/api/custdev/' + id, {method: 'DELETE', headers: {Authorization: auth}}); loadCustDev(); }
  catch(e) { alert('Xatolik'); }
}

async function loadPitch() {
  try {
    pitchData = await (await fetch('/api/pitch', {headers: {Authorization: auth}})).json() || {};
    var el = document.getElementById('pitchTextPreview');
    if (el) {
      el.innerHTML = '"' + ((pitchData.text || '').slice(0, 50) + (pitchData.text && pitchData.text.length > 50 ? '...' : '') || 'Maxsus video xabar!') + '"';
    }
  } catch(e) { console.error(e); }
}

// ============ Price Functions ============
async function loadPrice() {
  try {
    var d = await (await fetch('/api/settings/price', {headers: {Authorization: auth}})).json();
    subscriptionPrice = d.price || 9700000;
    // Element yo'q bo'lsa xato chiqmasin
  } catch(e) { console.error(e); }
}

function formatPriceDisplay(sum) {
  return sum.toLocaleString('uz-UZ') + " so'm";
}

function setQuickPrice(sum) {
  // Element yo'q bo'lsa xato chiqmasin
}

// subscriptionPrice event listener o'chirildi - element yo'q

async function saveSubscriptionPrice() {
  // Bu funksiya endi ishlatilmaydi - subscription plans orqali boshqariladi
  console.log('saveSubscriptionPrice is deprecated - use subscription plans');
}

// ============ Channel Link Functions ============
async function loadChannelLink() {
  try {
    var d = await (await fetch('/api/settings/channel', {headers: {Authorization: auth}})).json();
    document.getElementById('premiumChannelLink').value = d.channel_link || '';
    document.getElementById('premiumChannelId').value = d.channel_id || '';
  } catch(e) { console.error(e); }
}

async function saveChannelLink() {
  var link = document.getElementById('premiumChannelLink').value.trim();
  
  try {
    var r = await fetch('/api/settings/channel', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({channel_link: link})
    });
    var d = await r.json();
    if (d.success) {
      alert('‚úÖ Kanal havolasi saqlandi!');
    } else {
      alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
    }
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

// ============ Channel ID Functions ============
async function loadChannelId() {
  // Already loaded in loadChannelLink
}

async function saveChannelId() {
  var channelId = document.getElementById('premiumChannelId').value.trim();
  
  try {
    var r = await fetch('/api/settings/channel', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({channel_id: channelId})
    });
    var d = await r.json();
    if (d.success) {
      alert('‚úÖ Kanal ID saqlandi! Endi bot avtomatik invite link yaratadi.\n\n‚ö†Ô∏è Render.com dagi PREMIUM_CHANNEL_ID o\'zgartirish SHART EMAS - dashboard sozlamasi ustunlik qiladi.');
    } else {
      alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
    }
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

// ============ Free Channel Functions ============
async function loadFreeChannel() {
  try {
    // Load from bot_messages (same as other settings)
    var idRes = await fetch('/api/messages/free_channel_id', {headers: {Authorization: auth}});
    var linkRes = await fetch('/api/messages/free_channel_link', {headers: {Authorization: auth}});
    var lessonRes = await fetch('/api/messages/require_subscription_before_lesson', {headers: {Authorization: auth}});
    
    if (idRes.ok) {
      var id = await idRes.json();
      document.getElementById('freeChannelId').value = id.text || '';
    }
    
    if (linkRes.ok) {
      var link = await linkRes.json();
      document.getElementById('freeChannelLink').value = link.text || '';
    }
    
    if (lessonRes.ok) {
      var lesson = await lessonRes.json();
      document.getElementById('requireSubBeforeLesson').value = lesson.text || '3';
    }
    
    console.log('‚úÖ Free channel settings loaded');
  } catch(e) { 
    console.error('loadFreeChannel error:', e); 
  }
}

async function saveFreeChannel() {
  var channelId = document.getElementById('freeChannelId').value.trim();
  var channelLink = document.getElementById('freeChannelLink').value.trim();
  var beforeLesson = document.getElementById('requireSubBeforeLesson').value;
  
  if (!channelId || !channelLink) {
    alert('‚ö†Ô∏è Kanal ID va havolasini kiriting!');
    return;
  }
  
  try {
    // Save to bot_messages (same as other settings)
    var r1 = await fetch('/api/messages/free_channel_id', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: channelId})
    });
    
    var r2 = await fetch('/api/messages/free_channel_link', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: channelLink})
    });
    
    var r3 = await fetch('/api/messages/require_subscription_before_lesson', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: beforeLesson})
    });
    
    if (r1.ok && r2.ok && r3.ok) {
      alert('‚úÖ Bepul kanal sozlamalari saqlandi!\n\n' + beforeLesson + '-darsdan oldin obuna bo\'lish talab qilinadi.');
    } else {
      alert('‚ùå Saqlashda xatolik');
    }
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

// ============ Subscription Plans Functions ============
var subscriptionPlans = [];

async function loadSubscriptionPlans() {
  try {
    subscriptionPlans = await (await fetch('/api/subscription-plans', {headers: {Authorization: auth}})).json();
    renderSubscriptionPlans();
  } catch(e) { console.error(e); }
}

function renderSubscriptionPlans() {
  var grid = document.getElementById('subscriptionPlansGrid');
  
  grid.innerHTML = subscriptionPlans.map(function(plan) {
    var priceSum = plan.price / 100;
    var discountBadge = plan.discount_percent > 0 
      ? '<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">-' + plan.discount_percent + '%</span>'
      : '';
    var activeClass = plan.is_active ? 'border-green-400' : 'border-gray-300 opacity-60';
    
    return '<div class="glass rounded-2xl p-5 relative border-2 ' + activeClass + '">' +
      discountBadge +
      '<h4 class="font-bold text-lg mb-3">' + plan.name + '</h4>' +
      '<div class="space-y-3">' +
        '<div><label class="text-xs text-gray-500">Narx (so\'m)</label>' +
        '<input type="number" id="price_' + plan.id + '" value="' + priceSum + '" class="w-full px-3 py-2 rounded-lg glass-input text-xl font-bold"></div>' +
        '<div><label class="text-xs text-gray-500">Muddat (kun)</label>' +
        '<input type="number" id="duration_' + plan.id + '" value="' + plan.duration_days + '" class="w-full px-3 py-2 rounded-lg glass-input"></div>' +
        '<div><label class="text-xs text-gray-500">Chegirma (%)</label>' +
        '<input type="number" id="discount_' + plan.id + '" value="' + plan.discount_percent + '" min="0" max="99" class="w-full px-3 py-2 rounded-lg glass-input"></div>' +
        '<div class="flex items-center gap-2 mt-2">' +
          '<input type="checkbox" id="active_' + plan.id + '" ' + (plan.is_active ? 'checked' : '') + ' class="w-4 h-4">' +
          '<label for="active_' + plan.id + '" class="text-sm">Faol</label>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

// Save all plans at once
async function saveAllPlans() {
  try {
    for (var plan of subscriptionPlans) {
      var priceEl = document.getElementById('price_' + plan.id);
      var durationEl = document.getElementById('duration_' + plan.id);
      var discountEl = document.getElementById('discount_' + plan.id);
      var activeEl = document.getElementById('active_' + plan.id);
      
      if (priceEl) {
        var data = {
          name: plan.name,
          price: parseInt(priceEl.value) * 100,
          duration_days: parseInt(durationEl?.value) || plan.duration_days,
          discount_percent: parseInt(discountEl?.value) || 0,
          is_active: activeEl?.checked ?? plan.is_active
        };
        
        await fetch('/api/subscription-plans/' + plan.id, {
          method: 'PUT',
          headers: {Authorization: auth, 'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
      }
    }
    alert('‚úÖ Barcha narxlar saqlandi!');
    loadSubscriptionPlans();
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

// Legacy functions (not used anymore but kept for compatibility)
function updateBasePriceAndRecalculate() {}
function updatePlanDiscountAndRecalculate() {}
function toggleAutoCalculate() {}
function recalculatePrices() {}
async function savePlanSilent(planId, data) {
  var plan = subscriptionPlans.find(function(p) { return p.id === planId; });
  if (!plan) return;
  
  var updateData = {
    name: plan.name,
    price: data.price !== undefined ? data.price : plan.price,
    duration_days: data.duration_days !== undefined ? data.duration_days : plan.duration_days,
    discount_percent: data.discount_percent !== undefined ? data.discount_percent : plan.discount_percent,
    is_active: data.is_active !== undefined ? data.is_active : plan.is_active
  };
  
  try {
    await fetch('/api/subscription-plans/' + planId, {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify(updateData)
    });
  } catch(e) { 
    console.error('savePlanSilent error:', e);
  }
}

async function updatePlanPrice(planId, sumValue) {
  var tiyin = parseInt(sumValue) * 100;
  await savePlan(planId, {price: tiyin});
}

async function updatePlanDuration(planId, days) {
  await savePlan(planId, {duration_days: parseInt(days)});
}

async function togglePlanActive(planId, isActive) {
  await savePlan(planId, {is_active: isActive});
}

async function savePlan(planId, data) {
  var plan = subscriptionPlans.find(function(p) { return p.id === planId; });
  if (!plan) return;
  
  var updateData = {
    name: plan.name,
    price: data.price !== undefined ? data.price : plan.price,
    duration_days: data.duration_days !== undefined ? data.duration_days : plan.duration_days,
    discount_percent: data.discount_percent !== undefined ? data.discount_percent : plan.discount_percent,
    is_active: data.is_active !== undefined ? data.is_active : plan.is_active
  };
  
  try {
    await fetch('/api/subscription-plans/' + planId, {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify(updateData)
    });
    loadSubscriptionPlans();
  } catch(e) { 
    alert('‚ùå Xatolik: ' + e.message); 
  }
}

// ============ Subscription Reminders Functions ============
async function loadReminders() {
  try {
    var d = await (await fetch('/api/subscription-reminders', {headers: {Authorization: auth}})).json();
    document.getElementById('reminder_5d').value = d.reminder_5d || '';
    document.getElementById('reminder_3d').value = d.reminder_3d || '';
    document.getElementById('reminder_1d').value = d.reminder_1d || '';
    document.getElementById('reminder_expired').value = d.reminder_expired || '';
  } catch(e) { console.error(e); }
}

async function saveReminders() {
  var data = {
    reminder_5d: document.getElementById('reminder_5d').value,
    reminder_3d: document.getElementById('reminder_3d').value,
    reminder_1d: document.getElementById('reminder_1d').value,
    reminder_expired: document.getElementById('reminder_expired').value
  };
  
  try {
    var r = await fetch('/api/subscription-reminders', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    var d = await r.json();
    if (d.success) {
      alert('‚úÖ Eslatmalar saqlandi!');
    } else {
      alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
    }
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

function openPitchModal() {
  document.getElementById('pitchText').value = pitchData.text || '';
  document.getElementById('pitchVideo').value = pitchData.video_file_id || '';
  document.getElementById('pitchImage').value = pitchData.image_file_id || '';
  document.getElementById('pitchAudio').value = pitchData.audio_file_id || '';
  document.getElementById('pitchDelay').value = pitchData.delay_hours || 2;
  openModal('pitchModal');
}

async function savePitch() {
  var data = {
    text: document.getElementById('pitchText').value,
    video_file_id: document.getElementById('pitchVideo').value || null,
    image_file_id: document.getElementById('pitchImage').value || null,
    audio_file_id: document.getElementById('pitchAudio').value || null,
    delay_hours: parseInt(document.getElementById('pitchDelay').value) || 2
  };
  try {
    await fetch('/api/pitch', {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    closeModal('pitchModal');
    loadPitch();
    loadPostLessonFlow();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå Xatolik'); }
}

// ============ Post-Lesson Flow ============
var postLessonData = {};
var botMessages = {};
var subscriptionPrice = 9700000; // tiyin

async function loadPostLessonFlow() {
  try {
    // Load bot messages
    botMessages = await (await fetch('/api/bot-messages', {headers: {Authorization: auth}})).json() || {};
    
    // Update delay info display - use explicit checks for 0
    var pitchDelay = (pitchData.delay_hours !== null && pitchData.delay_hours !== undefined) ? pitchData.delay_hours : 2;
    var salesDelay = (botMessages.sales_delay !== null && botMessages.sales_delay !== undefined) ? botMessages.sales_delay : 1;
    var softDelay = (botMessages.soft_attack_delay !== null && botMessages.soft_attack_delay !== undefined) ? botMessages.soft_attack_delay : 24;
    
    // Format delay text
    var pitchText = pitchDelay === 0 ? 'üöÄ Darhol' : '+' + pitchDelay + ' soatdan keyin';
    var salesText = salesDelay === 0 ? 'üöÄ Darhol (pitch bilan)' : '+' + salesDelay + ' soat (pitch dan keyin)';
    var softText = softDelay < 0 || botMessages.soft_attack_disabled ? '‚ùå O\'chirilgan' : '+' + softDelay + ' soat (to\'lamagan bo\'lsa)';
    
    // Safely update elements - check if they exist first
    var el1 = document.getElementById('pitchDelayInfo');
    var el2 = document.getElementById('salesDelayInfo');
    var el3 = document.getElementById('softAttackDelayInfo');
    var el4 = document.getElementById('salesPreview');
    var el5 = document.getElementById('softAttackPreview');
    
    if (el1) el1.textContent = pitchText;
    if (el2) el2.textContent = salesText;
    if (el3) el3.textContent = softText;
    
    // Update previews
    var salesTextMsg = botMessages.sales_pitch || 'SMM PRO KURSGA TAKLIF!';
    if (el4) el4.innerHTML = '<p><strong>Matn:</strong> ' + (salesTextMsg.length > 100 ? salesTextMsg.slice(0, 100) + '...' : salesTextMsg) + '</p><p class="mt-2 text-gray-500">üí≥ Payme | üí† Click tugmalari avtomatik qo\'shiladi</p>';
    
    var softTextMsg = botMessages.soft_attack || 'ü§î Hali qaror qilmadingizmi?';
    if (el5) el5.innerHTML = '<p><strong>Matn:</strong> ' + (softTextMsg.length > 100 ? softTextMsg.slice(0, 100) + '...' : softTextMsg) + '</p><p class="mt-2 text-gray-500">‚ö†Ô∏è To\'lamagan foydalanuvchilarga yuboriladi</p>';
    
  } catch(e) { console.error(e); }
}

function openPostLessonModal() {
  document.getElementById('plCongrats').value = botMessages.post_lesson_congrats || 'üéâ Tabriklayman! Barcha bepul darslarni tugatdingiz!\n\nTez orada maxsus taklif yuboraman...';
  
  // Use explicit checks to handle 0 values correctly
  var pitchDelay = (pitchData.delay_hours !== null && pitchData.delay_hours !== undefined) ? pitchData.delay_hours : 2;
  var salesDelay = (botMessages.sales_delay !== null && botMessages.sales_delay !== undefined) ? botMessages.sales_delay : 1;
  var softDelay = (botMessages.soft_attack_delay !== null && botMessages.soft_attack_delay !== undefined) ? botMessages.soft_attack_delay : 24;
  
  // Set input values (show default if 0)
  document.getElementById('plPitchDelay').value = pitchDelay === 0 ? 2 : pitchDelay;
  document.getElementById('plSalesDelay').value = salesDelay === 0 ? 1 : salesDelay;
  document.getElementById('plSoftDelay').value = softDelay < 0 ? 24 : (softDelay === 0 ? 24 : softDelay);
  
  // Set radio buttons based on delay values
  if (pitchDelay === 0) {
    document.querySelector('input[name="plPitchType"][value="immediate"]').checked = true;
    document.getElementById('plPitchDelayDiv').classList.add('hidden');
  } else {
    document.querySelector('input[name="plPitchType"][value="timed"]').checked = true;
    document.getElementById('plPitchDelayDiv').classList.remove('hidden');
  }
  
  if (salesDelay === 0) {
    document.querySelector('input[name="plSalesType"][value="immediate"]').checked = true;
    document.getElementById('plSalesDelayDiv').classList.add('hidden');
  } else {
    document.querySelector('input[name="plSalesType"][value="timed"]').checked = true;
    document.getElementById('plSalesDelayDiv').classList.remove('hidden');
  }
  
  if (softDelay < 0 || botMessages.soft_attack_disabled) {
    document.querySelector('input[name="plSoftType"][value="disabled"]').checked = true;
    document.getElementById('plSoftDelayDiv').classList.add('hidden');
  } else {
    document.querySelector('input[name="plSoftType"][value="timed"]').checked = true;
    document.getElementById('plSoftDelayDiv').classList.remove('hidden');
  }
  
  openModal('postLessonModal');
}

function togglePlPitchDelay() {
  var isImmediate = document.querySelector('input[name="plPitchType"]:checked').value === 'immediate';
  document.getElementById('plPitchDelayDiv').classList.toggle('hidden', isImmediate);
}

function togglePlSalesDelay() {
  var isImmediate = document.querySelector('input[name="plSalesType"]:checked').value === 'immediate';
  document.getElementById('plSalesDelayDiv').classList.toggle('hidden', isImmediate);
}

function togglePlSoftDelay() {
  var isDisabled = document.querySelector('input[name="plSoftType"]:checked').value === 'disabled';
  document.getElementById('plSoftDelayDiv').classList.toggle('hidden', isDisabled);
}

async function savePostLessonFlow() {
  var pitchType = document.querySelector('input[name="plPitchType"]:checked').value;
  var salesType = document.querySelector('input[name="plSalesType"]:checked').value;
  var softType = document.querySelector('input[name="plSoftType"]:checked').value;
  
  var pitchDelay = pitchType === 'immediate' ? 0 : parseInt(document.getElementById('plPitchDelay').value) || 2;
  var salesDelay = salesType === 'immediate' ? 0 : parseInt(document.getElementById('plSalesDelay').value) || 1;
  var softDelay = softType === 'disabled' ? -1 : parseInt(document.getElementById('plSoftDelay').value) || 24;
  
  var data = {
    post_lesson_congrats: document.getElementById('plCongrats').value,
    sales_delay: salesDelay,
    soft_attack_delay: softDelay,
    soft_attack_disabled: softType === 'disabled'
  };
  
  // Also update pitch delay
  var pitchDelayData = {
    text: pitchData.text || '',
    video_file_id: pitchData.video_file_id || null,
    image_file_id: pitchData.image_file_id || null,
    audio_file_id: pitchData.audio_file_id || null,
    delay_hours: pitchDelay
  };
  
  try {
    await fetch('/api/bot-messages', {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    await fetch('/api/pitch', {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(pitchDelayData)});
    closeModal('postLessonModal');
    loadPitch();
    loadPostLessonFlow();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå Xatolik'); }
}

function openSalesMessageModal() {
  document.getElementById('salesText').value = botMessages.sales_pitch || 'SMM PRO KURSGA TAKLIF!\n\n‚úÖ 50+ video darslar\n‚úÖ Amaliy mashqlar\n‚úÖ 24/7 qo\'llab-quvvatlash\n\nNarx: {{price}}\n\nTo\'lov usulini tanlang:';
  openModal('salesMessageModal');
}

async function saveSalesMessage() {
  var data = { sales_pitch: document.getElementById('salesText').value };
  try {
    await fetch('/api/bot-messages', {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    closeModal('salesMessageModal');
    loadPostLessonFlow();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå Xatolik'); }
}

function openSoftAttackModal() {
  document.getElementById('softAttackText').value = botMessages.soft_attack || 'ü§î Hali qaror qilmadingizmi?\n\nKurs haqida savollaringiz bo\'lsa yozing!\n\nYoki hoziroq ro\'yxatdan o\'ting:';
  openModal('softAttackModal');
}

async function saveSoftAttack() {
  var data = { soft_attack: document.getElementById('softAttackText').value };
  try {
    await fetch('/api/bot-messages', {method: 'PUT', headers: {Authorization: auth, 'Content-Type': 'application/json'}, body: JSON.stringify(data)});
    closeModal('softAttackModal');
    loadPostLessonFlow();
    alert('‚úÖ Saqlandi!');
  } catch(e) { alert('‚ùå Xatolik'); }
}

// ============ Test Functions ============
async function testPitch() {
  if (!confirm('Pitch xabarini o\'zingizga yuborishni xohlaysizmi?')) return;
  try {
    var r = await fetch('/api/test/pitch', {method: 'POST', headers: {Authorization: auth}});
    var d = await r.json();
    if (d.success) alert('‚úÖ Pitch xabari yuborildi! Telegram ni tekshiring.');
    else alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
  } catch(e) { alert('‚ùå Xatolik: ' + e.message); }
}

async function testSales() {
  if (!confirm('To\'lov tugmalarini o\'zingizga yuborishni xohlaysizmi?')) return;
  try {
    var r = await fetch('/api/test/sales', {method: 'POST', headers: {Authorization: auth}});
    var d = await r.json();
    if (d.success) alert('‚úÖ To\'lov tugmalari yuborildi! Telegram ni tekshiring.');
    else alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
  } catch(e) { alert('‚ùå Xatolik: ' + e.message); }
}

async function testSoftAttack() {
  if (!confirm('Eslatma xabarini o\'zingizga yuborishni xohlaysizmi?')) return;
  try {
    var r = await fetch('/api/test/soft-attack', {method: 'POST', headers: {Authorization: auth}});
    var d = await r.json();
    if (d.success) alert('‚úÖ Eslatma xabari yuborildi! Telegram ni tekshiring.');
    else alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
  } catch(e) { alert('‚ùå Xatolik: ' + e.message); }
}

async function testFullFlow() {
  if (!confirm('To\'liq Progrev Flow ni o\'zingizga yuborishni xohlaysizmi?\n\n1. Tabriklov\n2. 3 sek ‚Üí Pitch\n3. 3 sek ‚Üí To\'lov\n4. 3 sek ‚Üí Eslatma')) return;
  try {
    var r = await fetch('/api/test/full-flow', {method: 'POST', headers: {Authorization: auth}});
    var d = await r.json();
    if (d.success) alert('‚úÖ To\'liq flow yuborildi! Telegram ni tekshiring.');
    else alert('‚ùå Xatolik: ' + (d.error || 'Unknown'));
  } catch(e) { alert('‚ùå Xatolik: ' + e.message); }
}

function openFlowSettingsModal() {
  var html = '<div class="space-y-4">' +
    // Pitch delay
    '<div class="glass rounded-xl p-4">' +
      '<label class="font-medium text-gray-700 mb-3 block">üé¨ Pitch yuborish vaqti (4-darsdan keyin)</label>' +
      '<div class="flex gap-2 items-center">' +
        '<select id="flowPitchType" class="px-3 py-2 rounded-xl glass-input" onchange="toggleFlowDelayInput(\'pitch\')">' +
          '<option value="instant">‚ö° Darhol</option>' +
          '<option value="seconds">Sekund</option>' +
          '<option value="minutes" selected>Minut</option>' +
          '<option value="hours">Soat</option>' +
        '</select>' +
        '<input type="number" id="flowPitchValue" class="w-24 px-3 py-2 rounded-xl glass-input" value="5" min="1">' +
        '<span id="flowPitchUnit" class="text-gray-500 text-sm">minut</span>' +
      '</div>' +
    '</div>' +
    // Sales delay
    '<div class="glass rounded-xl p-4">' +
      '<label class="font-medium text-gray-700 mb-3 block">üí≥ To\'lov taklifi (Pitch dan keyin)</label>' +
      '<div class="flex gap-2 items-center">' +
        '<select id="flowSalesType" class="px-3 py-2 rounded-xl glass-input" onchange="toggleFlowDelayInput(\'sales\')">' +
          '<option value="instant">‚ö° Darhol</option>' +
          '<option value="seconds">Sekund</option>' +
          '<option value="minutes" selected>Minut</option>' +
          '<option value="hours">Soat</option>' +
        '</select>' +
        '<input type="number" id="flowSalesValue" class="w-24 px-3 py-2 rounded-xl glass-input" value="3" min="1">' +
        '<span id="flowSalesUnit" class="text-gray-500 text-sm">minut</span>' +
      '</div>' +
    '</div>' +
    // Soft attack delay
    '<div class="glass rounded-xl p-4">' +
      '<label class="font-medium text-gray-700 mb-3 block">üîî Soft Eslatma (to\'lamasa)</label>' +
      '<div class="flex gap-2 items-center">' +
        '<select id="flowSoftType" class="px-3 py-2 rounded-xl glass-input" onchange="toggleFlowDelayInput(\'soft\')">' +
          '<option value="instant">‚ö° Darhol</option>' +
          '<option value="seconds">Sekund</option>' +
          '<option value="minutes">Minut</option>' +
          '<option value="hours" selected>Soat</option>' +
        '</select>' +
        '<input type="number" id="flowSoftValue" class="w-24 px-3 py-2 rounded-xl glass-input" value="24" min="1">' +
        '<span id="flowSoftUnit" class="text-gray-500 text-sm">soat</span>' +
      '</div>' +
      '<label class="flex items-center gap-2 mt-3">' +
        '<input type="checkbox" id="flowSoftEnabled" checked class="rounded">' +
        '<span class="text-sm text-gray-600">Soft eslatma faol</span>' +
      '</label>' +
    '</div>' +
    '<button onclick="saveFlowSettings()" class="w-full py-3 rounded-xl glass-btn text-white font-medium">üíæ Saqlash</button>' +
  '</div>';
  
  showCustomModal('‚öôÔ∏è Progrev Flow vaqtlari', html);
}

function toggleFlowDelayInput(type) {
  var selectEl = document.getElementById('flow' + type.charAt(0).toUpperCase() + type.slice(1) + 'Type');
  var valueEl = document.getElementById('flow' + type.charAt(0).toUpperCase() + type.slice(1) + 'Value');
  var unitEl = document.getElementById('flow' + type.charAt(0).toUpperCase() + type.slice(1) + 'Unit');
  
  if (selectEl.value === 'instant') {
    valueEl.style.display = 'none';
    unitEl.textContent = '';
  } else {
    valueEl.style.display = 'block';
    var units = {seconds: 'sekund', minutes: 'minut', hours: 'soat'};
    unitEl.textContent = units[selectEl.value] || '';
  }
}

function convertToMinutes(type, value) {
  if (type === 'instant') return 0;
  if (type === 'seconds') return value / 60;
  if (type === 'minutes') return value;
  if (type === 'hours') return value * 60;
  return value;
}

function formatDelay(minutes) {
  if (minutes === 0) return 'Darhol';
  if (minutes < 1) return Math.round(minutes * 60) + ' sek';
  if (minutes < 60) return Math.round(minutes) + ' min';
  return Math.round(minutes / 60) + ' soat';
}

async function saveFlowSettings() {
  var pitchType = document.getElementById('flowPitchType').value;
  var pitchValue = parseInt(document.getElementById('flowPitchValue').value) || 0;
  var pitchMinutes = convertToMinutes(pitchType, pitchValue);
  
  var salesType = document.getElementById('flowSalesType').value;
  var salesValue = parseInt(document.getElementById('flowSalesValue').value) || 0;
  var salesMinutes = convertToMinutes(salesType, salesValue);
  
  var softType = document.getElementById('flowSoftType').value;
  var softValue = parseInt(document.getElementById('flowSoftValue').value) || 0;
  var softMinutes = convertToMinutes(softType, softValue);
  
  var softEnabled = document.getElementById('flowSoftEnabled').checked;
  
  try {
    // Save as minutes to database
    await fetch('/api/messages/pitch_delay_minutes', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: String(pitchMinutes)})
    });
    await fetch('/api/messages/sales_delay_minutes', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: String(salesMinutes)})
    });
    await fetch('/api/messages/soft_attack_delay_minutes', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: String(softMinutes)})
    });
    await fetch('/api/messages/soft_attack_disabled', {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({text: String(!softEnabled)})
    });
    
    closeCustomModal();
    alert('‚úÖ Vaqtlar saqlandi!');
    
    // Update UI
    try {
      document.getElementById('flowPitchDelay').textContent = formatDelay(pitchMinutes);
      document.getElementById('flowPitchDelayBadge').textContent = '+' + formatDelay(pitchMinutes);
      document.getElementById('flowSalesDelay').textContent = formatDelay(salesMinutes);
      document.getElementById('flowSalesDelayBadge').textContent = '+' + formatDelay(salesMinutes);
      document.getElementById('flowSoftDelayBadge').textContent = '+' + formatDelay(softMinutes);
    } catch(e) {}
    
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

function openCongratsModal() {
  openModal('congratsModal');
}

var customModalEl = null;
function showCustomModal(title, content) {
  if (customModalEl) customModalEl.remove();
  
  customModalEl = document.createElement('div');
  customModalEl.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
  customModalEl.innerHTML = '<div class="glass-modal rounded-3xl p-6 max-w-md w-full mx-4">' +
    '<div class="flex justify-between items-center mb-6">' +
      '<h2 class="font-bold text-xl">' + title + '</h2>' +
      '<button onclick="closeCustomModal()" class="w-10 h-10 rounded-full glass-card flex items-center justify-center">‚úï</button>' +
    '</div>' +
    content +
  '</div>';
  document.body.appendChild(customModalEl);
}

function closeCustomModal() {
  if (customModalEl) {
    customModalEl.remove();
    customModalEl = null;
  }
}

// ============ Broadcast Functions ============
var broadcastFilter = 'all';

function setBroadcastQuickFilter(filter) {
  broadcastFilter = filter;
  
  // Update button styles
  document.querySelectorAll('[id^="bf-"]').forEach(function(btn) {
    btn.classList.remove('bf-active', 'bg-violet-100', 'text-violet-700');
  });
  document.getElementById('bf-' + filter).classList.add('bf-active', 'bg-violet-100', 'text-violet-700');
  
  // Show/hide advanced filters
  var advFilters = document.getElementById('broadcastAdvancedFilters');
  if (filter === 'custom') {
    advFilters.classList.remove('hidden');
  } else {
    advFilters.classList.add('hidden');
  }
  
  // Update audience count
  updateBroadcastAudienceCount();
}

function toggleAgeFilter(checkbox) {
  if (checkbox.checked) {
    document.querySelectorAll('.bfAge').forEach(function(cb) { cb.checked = false; });
  }
  updateBroadcastAudienceCount();
}

function toggleScheduleInput() {
  var isScheduled = document.querySelector('input[name="broadcastSchedule"]:checked').value === 'scheduled';
  document.getElementById('broadcastScheduleDiv').classList.toggle('hidden', !isScheduled);
}

function insertVar(varText) {
  var textarea = document.getElementById('broadcastText');
  var start = textarea.selectionStart;
  var end = textarea.selectionEnd;
  var text = textarea.value;
  textarea.value = text.substring(0, start) + varText + text.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + varText.length;
}

function updateBroadcastAudienceCount() {
  var count = getBroadcastFilteredUsers().length;
  document.getElementById('broadcastAudienceCount').textContent = count + ' ta';
}

function getBroadcastFilteredUsers() {
  var filtered = allUsers.slice();
  
  if (broadcastFilter === 'paid') {
    filtered = filtered.filter(function(u) { return u.is_paid; });
  } else if (broadcastFilter === 'free') {
    filtered = filtered.filter(function(u) { return !u.is_paid; });
  } else if (broadcastFilter === 'custom') {
    // Status
    var status = document.getElementById('bfStatus').value;
    if (status === 'paid') filtered = filtered.filter(function(u) { return u.is_paid; });
    else if (status === 'free') filtered = filtered.filter(function(u) { return !u.is_paid; });
    
    // Lesson
    var lesson = document.getElementById('bfLesson').value;
    if (lesson !== 'all') {
      if (lesson === 'completed') {
        var totalLessons = allLessons.length || 4;
        filtered = filtered.filter(function(u) { return (u.current_lesson || 0) >= totalLessons; });
      } else {
        filtered = filtered.filter(function(u) { return (u.current_lesson || 0) === parseInt(lesson); });
      }
    }
    
    // CustDev
    var custdev = document.getElementById('bfCustdev').value;
    if (custdev === 'completed') {
      filtered = filtered.filter(function(u) { return u.age_group || u.occupation || u.main_problem; });
    } else if (custdev === 'not') {
      filtered = filtered.filter(function(u) { return !u.age_group && !u.occupation && !u.main_problem; });
    }
    
    // Date
    var dateFilter = document.getElementById('bfDate').value;
    if (dateFilter !== 'all') {
      var now = new Date();
      filtered = filtered.filter(function(u) {
        var created = new Date(u.created_at);
        if (dateFilter === 'today') return created.toDateString() === now.toDateString();
        if (dateFilter === 'week') return (now - created) < 7 * 24 * 60 * 60 * 1000;
        if (dateFilter === 'month') return (now - created) < 30 * 24 * 60 * 60 * 1000;
        if (dateFilter === 'old') return (now - created) > 30 * 24 * 60 * 60 * 1000;
        return true;
      });
    }
    
    // Age groups
    var ageAll = document.getElementById('bfAge-all').checked;
    if (!ageAll) {
      var selectedAges = [];
      document.querySelectorAll('.bfAge:checked').forEach(function(cb) { selectedAges.push(cb.value); });
      if (selectedAges.length > 0) {
        filtered = filtered.filter(function(u) { return selectedAges.includes(u.age_group); });
      }
    }
  }
  
  return filtered;
}

function previewBroadcast() {
  var text = document.getElementById('broadcastText').value;
  if (!text.trim()) return alert('Xabar yozing!');
  
  var filtered = getBroadcastFilteredUsers();
  var sample = filtered[0];
  if (!sample) return alert('Tanlangan auditoriyada foydalanuvchi topilmadi!');
  
  // Replace variables
  var previewText = text
    .replace(/\{\{fio\}\}/gi, sample.full_name || "do'st")
    .replace(/\{\{ism\}\}/gi, (sample.full_name || "do'st").split(' ')[0])
    .replace(/\{\{telefon\}\}/gi, sample.phone || '')
    .replace(/\{\{dars\}\}/gi, String(sample.current_lesson || 0));
  
  alert('üëÅ Ko\'rinishi (' + filtered.length + ' ta foydalanuvchiga yuboriladi):\n\n' + previewText);
}

async function sendBroadcast() {
  var text = document.getElementById('broadcastText').value;
  if (!text.trim()) return alert('Xabar yozing!');
  
  var filtered = getBroadcastFilteredUsers();
  if (filtered.length === 0) return alert('Tanlangan auditoriyada foydalanuvchi topilmadi!');
  
  if (!confirm('üì§ ' + filtered.length + ' ta foydalanuvchiga xabar yuboriladi. Davom etasizmi?')) return;
  
  var btn = document.getElementById('broadcastBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Yuborilmoqda...';
  
  var filters = {
    filter: broadcastFilter,
    status: document.getElementById('bfStatus')?.value || 'all',
    lesson: document.getElementById('bfLesson')?.value || 'all',
    custdev: document.getElementById('bfCustdev')?.value || 'all',
    date: document.getElementById('bfDate')?.value || 'all'
  };
  
  try {
    var r = await fetch('/api/broadcast', {
      method: 'POST',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({
        text: text,
        filters: filters,
        photo: document.getElementById('broadcastPhoto').value || null,
        video: document.getElementById('broadcastVideo').value || null,
        button_text: document.getElementById('broadcastBtnText').value || null,
        button_url: document.getElementById('broadcastBtnUrl').value || null
      })
    });
    var d = await r.json();
    var res = document.getElementById('broadcastResult');
    res.className = 'p-4 rounded-xl glass bg-green-50';
    res.innerHTML = '‚úÖ Yuborildi: <strong>' + d.sent + '</strong> ta | ‚ùå Xato: <strong>' + d.failed + '</strong> ta';
    res.classList.remove('hidden');
  } catch(e) {
    var res = document.getElementById('broadcastResult');
    res.className = 'p-4 rounded-xl glass bg-red-50 text-red-700';
    res.textContent = '‚ùå Xatolik: ' + e.message;
    res.classList.remove('hidden');
  }
  btn.disabled = false;
  btn.textContent = 'üì§ Yuborish';
}

// Initialize broadcast audience count when modal opens
function openBroadcastModal() {
  broadcastFilter = 'all';
  document.querySelectorAll('[id^="bf-"]').forEach(function(btn) {
    btn.classList.remove('bf-active', 'bg-violet-100', 'text-violet-700');
  });
  document.getElementById('bf-all').classList.add('bf-active', 'bg-violet-100', 'text-violet-700');
  document.getElementById('broadcastAdvancedFilters').classList.add('hidden');
  document.getElementById('broadcastText').value = '';
  document.getElementById('broadcastPhoto').value = '';
  document.getElementById('broadcastVideo').value = '';
  document.getElementById('broadcastBtnText').value = '';
  document.getElementById('broadcastBtnUrl').value = '';
  document.getElementById('broadcastResult').classList.add('hidden');
  updateBroadcastAudienceCount();
  openModal('broadcastModal');
}

// Close modals on background click
document.querySelectorAll('[id$="Modal"]').forEach(function(m) {
  m.onclick = function(e) { if (e.target === m) closeModal(m.id); };
});

// Auto refresh stats
setInterval(function() {
  if (!document.getElementById('dashboard').classList.contains('hidden')) loadStats();
}, 60000);

// ============ MULTI-FUNNEL FUNCTIONS ============
var allFunnels = [];
var currentFunnelId = null;
var currentFunnelData = null;

async function loadFunnels() {
  try {
    allFunnels = await (await fetch('/api/funnels', {headers: {Authorization: auth}})).json();
    renderFunnelsList();
  } catch(e) {
    console.error('loadFunnels error:', e);
    document.getElementById('funnelsList').innerHTML = '<p class="text-red-500 text-center py-4">Xatolik: ' + e.message + '</p>';
  }
}

function renderFunnelsList() {
  if (!allFunnels.length) {
    document.getElementById('funnelsList').innerHTML = `
      <div class="text-center py-12">
        <span class="text-5xl mb-4 block">üéØ</span>
        <p class="text-gray-500 mb-4">Hali varonkalar yo'q</p>
        <button onclick="openCreateFunnelModal()" class="px-6 py-3 rounded-xl glass-btn text-white">+ Birinchi varonka yaratish</button>
      </div>
    `;
    return;
  }
  
  var html = '';
  for (var i = 0; i < allFunnels.length; i++) {
    var f = allFunnels[i];
    var defaultBadge = f.is_default ? '<span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs ml-2">Default</span>' : '';
    var activeBadge = f.is_active ? '' : '<span class="px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs ml-2">O\'chirilgan</span>';
    
    html += '<div class="glass-card rounded-2xl p-4 flex justify-between items-center">' +
      '<div class="flex-1">' +
        '<div class="flex items-center">' +
          '<h3 class="font-bold text-lg">' + f.name + '</h3>' + defaultBadge + activeBadge +
        '</div>' +
        '<p class="text-sm text-gray-500 mt-1">üîó t.me/bot?start=' + f.slug + '</p>' +
        (f.description ? '<p class="text-xs text-gray-400 mt-1">' + f.description + '</p>' : '') +
      '</div>' +
      '<div class="flex gap-2">' +
        '<button type="button" data-action="open-funnel" data-id="' + f.id + '" class="w-10 h-10 rounded-xl glass flex items-center justify-center hover:bg-violet-100">üëÅÔ∏è</button>' +
        '<button type="button" data-action="edit-funnel" data-id="' + f.id + '" class="w-10 h-10 rounded-xl glass flex items-center justify-center hover:bg-blue-100">‚úèÔ∏è</button>' +
        '<button type="button" data-action="delete-funnel" data-id="' + f.id + '" class="w-10 h-10 rounded-xl glass flex items-center justify-center hover:bg-red-100 text-red-500">üóëÔ∏è</button>' +
      '</div>' +
    '</div>';
  }
  document.getElementById('funnelsList').innerHTML = html;
}

function openCreateFunnelModal() {
  document.getElementById('funnelModalTitle').textContent = 'üéØ Yangi varonka';
  document.getElementById('funnelId').value = '';
  document.getElementById('funnelName').value = '';
  document.getElementById('funnelSlug').value = '';
  document.getElementById('funnelDescription').value = '';
  document.getElementById('funnelIsDefault').checked = false;
  openModal('funnelModal');
}

function editFunnel(id) {
  var f = allFunnels.find(function(x) { return x.id === id; });
  if (!f) return;
  
  document.getElementById('funnelModalTitle').textContent = '‚úèÔ∏è Varonkani tahrirlash';
  document.getElementById('funnelId').value = f.id;
  document.getElementById('funnelName').value = f.name || '';
  document.getElementById('funnelSlug').value = f.slug || '';
  document.getElementById('funnelDescription').value = f.description || '';
  document.getElementById('funnelIsDefault').checked = f.is_default;
  openModal('funnelModal');
}

async function saveFunnel() {
  var id = document.getElementById('funnelId').value;
  var data = {
    name: document.getElementById('funnelName').value.trim(),
    slug: document.getElementById('funnelSlug').value.trim(),
    description: document.getElementById('funnelDescription').value.trim(),
    is_default: document.getElementById('funnelIsDefault').checked
  };
  
  if (!data.name || !data.slug) {
    alert('‚ö†Ô∏è Nom va slug majburiy!');
    return;
  }
  
  try {
    var url = id ? '/api/funnels/' + id : '/api/funnels';
    var method = id ? 'PUT' : 'POST';
    
    var r = await fetch(url, {
      method: method,
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    
    if (r.ok) {
      closeModal('funnelModal');
      loadFunnels();
      alert('‚úÖ Varonka saqlandi!');
    } else {
      var err = await r.json();
      alert('‚ùå Xatolik: ' + (err.error || 'Unknown'));
    }
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

async function deleteFunnel(id) {
  if (!confirm('üóëÔ∏è Bu varonkani o\'chirmoqchimisiz? Barcha darslar va savollar ham o\'chadi!')) return;
  
  try {
    await fetch('/api/funnels/' + id, {method: 'DELETE', headers: {Authorization: auth}});
    loadFunnels();
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

async function openFunnel(id) {
  currentFunnelId = id;
  currentFunnelData = allFunnels.find(function(x) { return x.id === id; });
  
  if (!currentFunnelData) return;
  
  document.getElementById('funnelDetailTitle').textContent = 'üéØ ' + currentFunnelData.name;
  document.getElementById('funnelDetailSlug').textContent = 't.me/bot?start=' + currentFunnelData.slug;
  
  openModal('funnelDetailModal');
  showFunnelTab('lessons');
  loadFunnelLessons();
}

function showFunnelTab(tab) {
  // Hide all tabs
  document.querySelectorAll('[id^="funnel-content-"]').forEach(function(e) { e.classList.add('hidden'); });
  document.querySelectorAll('[id^="funnel-tab-"]').forEach(function(e) { 
    e.classList.remove('bg-violet-500', 'text-white');
    e.classList.add('glass-card');
  });
  
  // Show selected tab
  document.getElementById('funnel-content-' + tab).classList.remove('hidden');
  document.getElementById('funnel-tab-' + tab).classList.remove('glass-card');
  document.getElementById('funnel-tab-' + tab).classList.add('bg-violet-500', 'text-white');
  
  // Load content
  if (tab === 'lessons') loadFunnelLessons();
  if (tab === 'custdev') loadFunnelCustDev();
  if (tab === 'pitch') loadFunnelPitch();
  if (tab === 'settings') loadFunnelSettings();
  if (tab === 'stats') loadFunnelStats();
}

async function loadFunnelLessons() {
  if (!currentFunnelId) return;
  
  try {
    var lessons = await (await fetch('/api/funnels/' + currentFunnelId + '/lessons', {headers: {Authorization: auth}})).json();
    
    if (!lessons.length) {
      document.getElementById('funnelLessonsList').innerHTML = '<p class="text-gray-400 text-center py-4">Darslar yo\'q</p>';
      return;
    }
    
    var html = '';
    for (var i = 0; i < lessons.length; i++) {
      var l = lessons[i];
      html += '<div class="glass rounded-xl p-3 flex justify-between items-center">' +
        '<div>' +
          '<p class="font-medium">' + l.lesson_number + '-dars: ' + l.title + '</p>' +
          '<p class="text-xs text-gray-500">' + (l.delay_hours === 0 ? 'Darhol' : l.delay_hours + ' soat') + '</p>' +
        '</div>' +
        '<div class="flex gap-1">' +
          '<button type="button" data-action="edit-funnel-lesson" data-funnel="' + currentFunnelId + '" data-lesson="' + l.lesson_number + '" class="w-8 h-8 rounded-lg glass flex items-center justify-center text-sm">‚úèÔ∏è</button>' +
          '<button type="button" data-action="delete-funnel-lesson" data-funnel="' + currentFunnelId + '" data-lesson="' + l.lesson_number + '" class="w-8 h-8 rounded-lg glass flex items-center justify-center text-sm text-red-500">üóëÔ∏è</button>' +
        '</div>' +
      '</div>';
    }
    document.getElementById('funnelLessonsList').innerHTML = html;
  } catch(e) {
    document.getElementById('funnelLessonsList').innerHTML = '<p class="text-red-500 text-center py-4">Xatolik</p>';
  }
}

function addFunnelLesson() {
  document.getElementById('funnelLessonModalTitle').textContent = 'üìö Yangi dars qo\'shish';
  document.getElementById('funnelLessonId').value = '';
  document.getElementById('funnelLessonNumber').value = '';
  document.getElementById('funnelLessonTitle').value = '';
  document.getElementById('funnelLessonContent').value = '';
  document.getElementById('funnelLessonVideo').value = '';
  document.getElementById('funnelLessonDelay').value = '0';
  openModal('funnelLessonModal');
}

function editFunnelLessonModal(funnelId, lessonNum) {
  // Find lesson data from loaded lessons
  fetch('/api/funnels/' + funnelId + '/lessons', {headers: {Authorization: auth}})
    .then(r => r.json())
    .then(lessons => {
      var l = lessons.find(function(x) { return x.lesson_number === lessonNum; });
      if (!l) return;
      
      document.getElementById('funnelLessonModalTitle').textContent = '‚úèÔ∏è ' + lessonNum + '-darsni tahrirlash';
      document.getElementById('funnelLessonId').value = lessonNum;
      document.getElementById('funnelLessonNumber').value = l.lesson_number;
      document.getElementById('funnelLessonTitle').value = l.title || '';
      document.getElementById('funnelLessonContent').value = l.content || '';
      document.getElementById('funnelLessonVideo').value = l.video_file_id || '';
      document.getElementById('funnelLessonDelay').value = l.delay_hours || 0;
      openModal('funnelLessonModal');
    });
}

async function saveFunnelLesson() {
  var num = parseInt(document.getElementById('funnelLessonNumber').value);
  var title = document.getElementById('funnelLessonTitle').value.trim();
  
  if (!num || !title) {
    alert('‚ö†Ô∏è Dars raqami va sarlavhasi majburiy!');
    return;
  }
  
  try {
    await fetch('/api/funnels/' + currentFunnelId + '/lessons/' + num, {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({
        title: title,
        content: document.getElementById('funnelLessonContent').value || '',
        video_file_id: document.getElementById('funnelLessonVideo').value || null,
        delay_hours: parseInt(document.getElementById('funnelLessonDelay').value) || 0
      })
    });
    closeModal('funnelLessonModal');
    loadFunnelLessons();
    alert('‚úÖ Dars saqlandi!');
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

async function deleteFunnelLesson(funnelId, lessonNum) {
  if (!confirm('Bu darsni o\'chirmoqchimisiz?')) return;
  
  try {
    await fetch('/api/funnels/' + funnelId + '/lessons/' + lessonNum, {
      method: 'DELETE', 
      headers: {Authorization: auth}
    });
    loadFunnelLessons();
  } catch(e) {
    alert('‚ùå Xatolik');
  }
}

async function loadFunnelCustDev() {
  if (!currentFunnelId) return;
  
  try {
    var questions = await (await fetch('/api/funnels/' + currentFunnelId + '/custdev', {headers: {Authorization: auth}})).json();
    
    if (!questions.length) {
      document.getElementById('funnelCustDevList').innerHTML = '<p class="text-gray-400 text-center py-4">Savollar yo\'q. "Savol qo\'shish" tugmasini bosing.</p>';
      return;
    }
    
    var html = '';
    for (var i = 0; i < questions.length; i++) {
      var q = questions[i];
      html += '<div class="glass rounded-xl p-3 flex justify-between items-center">' +
        '<div>' +
          '<p class="font-medium">' + (q.question_text.length > 50 ? q.question_text.slice(0, 50) + '...' : q.question_text) + '</p>' +
          '<p class="text-xs text-gray-500">' + q.after_lesson + '-darsdan keyin | ' + q.question_type + (q.field_name ? ' ‚Üí ' + q.field_name : '') + '</p>' +
        '</div>' +
        '<button type="button" data-action="delete-funnel-custdev" data-id="' + q.id + '" class="w-8 h-8 rounded-lg glass flex items-center justify-center text-sm text-red-500">üóëÔ∏è</button>' +
      '</div>';
    }
    document.getElementById('funnelCustDevList').innerHTML = html;
  } catch(e) {
    document.getElementById('funnelCustDevList').innerHTML = '<p class="text-red-500 text-center py-4">Xatolik: ' + e.message + '</p>';
  }
}

function addFunnelCustDev() {
  document.getElementById('funnelCustDevQuestion').value = '';
  document.getElementById('funnelCustDevAfterLesson').value = '1';
  document.getElementById('funnelCustDevType').value = 'text';
  document.getElementById('funnelCustDevOptions').value = '';
  document.getElementById('funnelCustDevField').value = '';
  document.getElementById('funnelCustDevOptionsDiv').classList.add('hidden');
  openModal('funnelCustDevModal');
}

// Toggle options visibility
document.addEventListener('change', function(e) {
  if (e.target.id === 'funnelCustDevType') {
    var optDiv = document.getElementById('funnelCustDevOptionsDiv');
    if (e.target.value === 'buttons') {
      optDiv.classList.remove('hidden');
    } else {
      optDiv.classList.add('hidden');
    }
  }
});

async function saveFunnelCustDev() {
  var question = document.getElementById('funnelCustDevQuestion').value.trim();
  if (!question) {
    alert('‚ö†Ô∏è Savol matni majburiy!');
    return;
  }
  
  var type = document.getElementById('funnelCustDevType').value;
  var options = null;
  
  if (type === 'buttons') {
    var optText = document.getElementById('funnelCustDevOptions').value.trim();
    if (optText) {
      options = optText.split('\n').map(function(s) { return s.trim(); }).filter(function(s) { return s; });
    }
  }
  
  try {
    await fetch('/api/funnels/' + currentFunnelId + '/custdev', {
      method: 'POST',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({
        question_text: question,
        after_lesson: parseInt(document.getElementById('funnelCustDevAfterLesson').value) || 1,
        question_type: type,
        options: options,
        field_name: document.getElementById('funnelCustDevField').value.trim() || null
      })
    });
    closeModal('funnelCustDevModal');
    loadFunnelCustDev();
    alert('‚úÖ Savol qo\'shildi!');
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

async function deleteFunnelCustDev(id) {
  if (!confirm('Bu savolni o\'chirmoqchimisiz?')) return;
  
  try {
    await fetch('/api/funnels/' + currentFunnelId + '/custdev/' + id, {
      method: 'DELETE',
      headers: {Authorization: auth}
    });
    loadFunnelCustDev();
  } catch(e) {
    alert('‚ùå Xatolik');
  }
}

function loadFunnelPitch() {
  if (!currentFunnelData) return;
  
  document.getElementById('funnelPitchAfterLesson').value = currentFunnelData.pitch_after_lesson || 4;
  document.getElementById('funnelPitchText').value = currentFunnelData.pitch_text || '';
  document.getElementById('funnelPitchVideo').value = currentFunnelData.pitch_video_file_id || '';
  document.getElementById('funnelPitchDelay').value = currentFunnelData.pitch_delay_hours || 2;
}

async function saveFunnelPitch() {
  try {
    await fetch('/api/funnels/' + currentFunnelId, {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify({
        pitch_after_lesson: parseInt(document.getElementById('funnelPitchAfterLesson').value) || 4,
        pitch_text: document.getElementById('funnelPitchText').value,
        pitch_video_file_id: document.getElementById('funnelPitchVideo').value || null,
        pitch_delay_hours: parseInt(document.getElementById('funnelPitchDelay').value) || 2
      })
    });
    alert('‚úÖ Pitch saqlandi!');
    loadFunnels(); // Refresh main list
  } catch(e) {
    alert('‚ùå Xatolik');
  }
}

function loadFunnelSettings() {
  if (!currentFunnelData) return;
  
  document.getElementById('funnelPremiumChannelId').value = currentFunnelData.premium_channel_id || '';
  document.getElementById('funnelFreeChannelId').value = currentFunnelData.free_channel_id || '';
  document.getElementById('funnelFreeChannelLink').value = currentFunnelData.free_channel_link || '';
  document.getElementById('funnelRequireSubBefore').value = currentFunnelData.require_subscription_before_lesson || 0;
  
  // Payment settings
  document.getElementById('funnelPaymeEnabled').checked = currentFunnelData.payme_enabled !== false;
  document.getElementById('funnelClickEnabled').checked = currentFunnelData.click_enabled !== false;
  
  // Prices
  document.getElementById('funnelPrice1m').value = currentFunnelData.price_1m ? currentFunnelData.price_1m / 100 : '';
  document.getElementById('funnelPrice3m').value = currentFunnelData.price_3m ? currentFunnelData.price_3m / 100 : '';
  document.getElementById('funnelPrice6m').value = currentFunnelData.price_6m ? currentFunnelData.price_6m / 100 : '';
  document.getElementById('funnelPrice12m').value = currentFunnelData.price_12m ? currentFunnelData.price_12m / 100 : '';
}

async function saveFunnelSettings() {
  try {
    var data = {
      premium_channel_id: document.getElementById('funnelPremiumChannelId').value || null,
      free_channel_id: document.getElementById('funnelFreeChannelId').value || null,
      free_channel_link: document.getElementById('funnelFreeChannelLink').value || null,
      require_subscription_before_lesson: parseInt(document.getElementById('funnelRequireSubBefore').value) || 0,
      payme_enabled: document.getElementById('funnelPaymeEnabled').checked,
      click_enabled: document.getElementById('funnelClickEnabled').checked
    };
    
    // Add prices if set (convert to tiyin)
    var p1 = document.getElementById('funnelPrice1m').value;
    var p3 = document.getElementById('funnelPrice3m').value;
    var p6 = document.getElementById('funnelPrice6m').value;
    var p12 = document.getElementById('funnelPrice12m').value;
    
    if (p1) data.price_1m = parseInt(p1) * 100;
    if (p3) data.price_3m = parseInt(p3) * 100;
    if (p6) data.price_6m = parseInt(p6) * 100;
    if (p12) data.price_12m = parseInt(p12) * 100;
    
    await fetch('/api/funnels/' + currentFunnelId, {
      method: 'PUT',
      headers: {Authorization: auth, 'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    
    // Update local data
    Object.assign(currentFunnelData, data);
    
    alert('‚úÖ Sozlamalar saqlandi!');
    loadFunnels();
  } catch(e) {
    alert('‚ùå Xatolik: ' + e.message);
  }
}

async function loadFunnelStats() {
  if (!currentFunnelId) return;
  
  try {
    var stats = await (await fetch('/api/funnels/' + currentFunnelId + '/stats', {headers: {Authorization: auth}})).json();
    
    document.getElementById('funnelStatTotal').textContent = stats.total_users || 0;
    document.getElementById('funnelStatActive').textContent = stats.active_users || 0;
    document.getElementById('funnelStatPaid').textContent = stats.paid_users || 0;
    
    var conversion = stats.total_users > 0 ? Math.round((stats.paid_users / stats.total_users) * 100) : 0;
    document.getElementById('funnelStatConversion').textContent = conversion + '%';
    
    // Lesson stats
    if (stats.lessonStats && stats.lessonStats.length) {
      var html = '<h4 class="font-medium mb-2">Darslar bo\'yicha</h4><div class="space-y-1">';
      for (var i = 0; i < stats.lessonStats.length; i++) {
        var ls = stats.lessonStats[i];
        html += '<div class="flex justify-between text-sm"><span>' + ls.current_lesson + '-dars</span><span class="font-medium">' + ls.user_count + ' user</span></div>';
      }
      html += '</div>';
      document.getElementById('funnelLessonStats').innerHTML = html;
    }
  } catch(e) {
    console.error('loadFunnelStats error:', e);
  }
}

// ========== GLOBAL EVENT DELEGATION ==========
// Bu barcha dinamik yaratilgan tugmalarni ishlashini ta'minlaydi
document.addEventListener('click', function(e) {
  // Mobile slide menu buttons
  var mobileNavBtn = e.target.closest('.mobile-nav-btn');
  if (mobileNavBtn) {
    e.preventDefault();
    var tab = mobileNavBtn.getAttribute('data-tab');
    if (tab) {
      showTab(tab);
      closeMobileMenu();
    }
    return;
  }
  
  // Data-action buttons
  var target = e.target.closest('[data-action]');
  if (!target) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  var action = target.getAttribute('data-action');
  var id = target.getAttribute('data-id');
  
  console.log('Action clicked:', action, 'ID:', id);
  
  switch(action) {
    // Lessons
    case 'edit-lesson':
      editLesson(parseInt(id));
      break;
    case 'delete-lesson':
      deleteLesson(parseInt(id));
      break;
    // CustDev
    case 'edit-custdev':
      editCustDev(parseInt(id));
      break;
    case 'delete-custdev':
      deleteCustDev(parseInt(id));
      break;
    // Media
    case 'edit-media':
      editMediaCaption(parseInt(id));
      break;
    case 'delete-media':
      deleteMediaItem(parseInt(id));
      break;
    case 'copy-file':
      copyFileId(id);
      break;
    // Funnels
    case 'open-funnel':
      openFunnel(parseInt(id));
      break;
    case 'edit-funnel':
      editFunnel(parseInt(id));
      break;
    case 'delete-funnel':
      deleteFunnel(parseInt(id));
      break;
    case 'edit-funnel-lesson':
      var funnelId = parseInt(target.getAttribute('data-funnel'));
      var lessonNum = parseInt(target.getAttribute('data-lesson'));
      editFunnelLessonModal(funnelId, lessonNum);
      break;
    case 'delete-funnel-lesson':
      var funnelId2 = parseInt(target.getAttribute('data-funnel'));
      var lessonNum2 = parseInt(target.getAttribute('data-lesson'));
      deleteFunnelLesson(funnelId2, lessonNum2);
      break;
    case 'delete-funnel-custdev':
      deleteFunnelCustDev(parseInt(id));
      break;
    // Navigation
    case 'show-tab':
      showTab(id);
      if (id === 'funnels') loadFunnels();
      break;
    case 'open-modal':
      openModal(id);
      break;
    case 'close-modal':
      closeModal(id);
      break;
  }
});

// Touch optimization
document.addEventListener('touchstart', function(){}, {passive: true});
</script>
</body>
</html>
