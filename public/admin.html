<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); min-height: 100vh; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }

    /* Sidebar - Collapsible */
    .sidebar { width: 70px; background: linear-gradient(180deg, #fff 0%, #fafaff 100%); border-right: 1px solid #e5e7eb; box-shadow: 2px 0 8px rgba(99,102,241,0.05); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
    .sidebar.expanded { width: 200px; }
    .sidebar-item { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; font-size: 20px; gap: 12px; white-space: nowrap; }
    .sidebar.expanded .sidebar-item { width: 100%; justify-content: flex-start; padding: 0 16px; }
    .sidebar-item:hover { background: #f3f4f6; color: #6366f1; transform: scale(1.02); }
    .sidebar-item.active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
    .sidebar-label { display: none; font-size: 13px; font-weight: 500; }
    .sidebar.expanded .sidebar-label { display: block; }
    .sidebar-toggle { width: 24px; height: 24px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 12px; }
    .sidebar-toggle:hover { background: #e5e7eb; }

    /* Cards */
    .card { background: #fff; border-radius: 16px; border: 1px solid rgba(99,102,241,0.08); box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: all 0.25s ease; }
    .card-hover:hover { box-shadow: 0 8px 30px rgba(99,102,241,0.12); transform: translateY(-3px); border-color: rgba(99,102,241,0.15); }

    /* Stat card with icon */
    .stat-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    /* Table */
    .table-row { border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.15s ease; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover { background: linear-gradient(90deg, #f8faff 0%, #fff 100%); }

    /* Badge */
    .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
    .badge-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1d4ed8; }
    .badge-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #c2410c; }
    .badge-yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309; }
    .badge-red { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }

    /* Button */
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 14px rgba(99,102,241,0.35); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.45); }
    .btn-secondary { background: #fff; color: #374151; border: 1px solid #e5e7eb; }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; transform: translateY(-1px); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; box-shadow: 0 4px 14px rgba(239,68,68,0.35); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.45); }

    /* Input */
    .input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; transition: all 0.2s; background: #fafafa; }
    .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99,102,241,0.1); background: #fff; }
    .input::placeholder { color: #9ca3af; }

    /* Modal */
    .modal-overlay { background: rgba(17,24,39,0.4); backdrop-filter: blur(8px); }
    .modal-content { background: #fff; border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-lg { max-width: 800px; }

    /* Activity item */
    .activity-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

    /* Tab */
    .tab { padding: 10px 18px; border-radius: 10px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.25s ease; }
    .tab:hover { background: #f3f4f6; color: #4b5563; }
    .tab.active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }

    /* Chart container */
    .chart-container { position: relative; height: 200px; }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; }

    /* Hide scrollbar for mobile nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile bottom nav */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0 !important; padding: 12px !important; padding-bottom: 80px !important; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none; }

      /* Typography */
      h1 { font-size: 1.25rem !important; }
      h2 { font-size: 1.125rem !important; }
      h3 { font-size: 1rem !important; }

      /* Cards */
      .card { border-radius: 12px; }

      /* Stat cards */
      .stat-icon { width: 40px !important; height: 40px !important; font-size: 18px !important; }

      /* Buttons */
      .btn { padding: 8px 14px; font-size: 13px; }
      .btn-primary { padding: 10px 16px; }

      /* Inputs */
      .input { padding: 10px 12px; font-size: 14px; }

      /* Tables */
      .overflow-x-auto { -webkit-overflow-scrolling: touch; }

      /* Tab buttons */
      .tab { padding: 8px 12px; font-size: 12px; }

      /* Chart containers */
      .chart-container { height: 180px !important; }

      /* Modals */
      .modal-content { margin: 12px; border-radius: 16px; max-height: calc(100vh - 100px); }

      /* Grid adjustments */
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      .grid-cols-3 { grid-template-columns: 1fr !important; }
      .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }

      /* Stats row */
      .stats-grid { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }

      /* Flexbox adjustments */
      .flex-col-mobile { flex-direction: column !important; align-items: stretch !important; }

      /* Text sizes */
      .text-3xl { font-size: 1.5rem !important; }
      .text-2xl { font-size: 1.25rem !important; }

      /* Spacing */
      .gap-6 { gap: 12px !important; }
      .p-5 { padding: 12px !important; }
      .mb-6 { margin-bottom: 12px !important; }
    }

    /* Small mobile screens */
    @media (max-width: 480px) {
      .main-content { padding: 8px !important; }
      .card { border-radius: 10px; }
      .stat-icon { width: 36px !important; height: 36px !important; font-size: 16px !important; border-radius: 10px !important; }
      .text-3xl { font-size: 1.25rem !important; }
      .text-2xl { font-size: 1.125rem !important; }
      .tab { padding: 6px 10px; font-size: 11px; }
      .btn { padding: 6px 10px; font-size: 12px; }
    }

    /* Tablet screens */
    @media (min-width: 769px) and (max-width: 1024px) {
      .right-panel { width: 240px !important; }
      .main-content { margin-right: 240px; }
    }

    /* Large screens */
    @media (min-width: 1280px) {
      .right-panel { width: 320px; }
    }

    .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #eee; padding: 8px 8px; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); }
    .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 4px; border-radius: 10px; color: #9ca3af; font-size: 9px; transition: all 0.2s; }
    .mobile-nav-item.active { color: #6366f1; background: #eef2ff; }
    .mobile-nav-item:active { transform: scale(0.95); }

    /* File ID Input */
    .file-id-input { font-family: monospace; font-size: 12px; background: #f9fafb; }

    /* Funnel Visualization */
    .funnel-container { position: relative; }
    .funnel-step {
      position: relative;
      margin: 0 auto;
      padding: 8px 12px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .funnel-step:hover { transform: scale(1.02); }
    .funnel-step::before {
      content: '';
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      border-radius: 4px;
      z-index: -1;
    }
    .funnel-label { font-size: 11px; font-weight: 500; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .funnel-count { font-size: 14px; font-weight: 700; color: #fff; }
    .funnel-pct { font-size: 10px; color: rgba(255,255,255,0.8); }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 z-50">
  <div class="card p-8 w-full max-w-sm mx-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <span class="text-3xl">üöÄ</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
      <p class="text-gray-500 text-sm mt-1">Tizimga kirish</p>
    </div>
    <form id="loginForm">
      <input type="text" id="username" class="input mb-3" placeholder="Login" required>
      <input type="password" id="password" class="input mb-4" placeholder="Parol" required>
      <button type="submit" class="btn btn-primary w-full">Kirish</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden">Login yoki parol xato</p>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden flex min-h-screen">

  <!-- Left Sidebar -->
  <aside id="sidebar" class="sidebar fixed left-0 top-0 bottom-0 flex flex-col items-center py-6 z-40">
    <div class="flex items-center gap-3 mb-6 px-3">
      <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg font-bold flex-shrink-0">F</div>
      <span class="sidebar-label text-lg font-bold text-gray-800">Funnel</span>
    </div>

    <nav class="flex flex-col gap-2 flex-1 w-full px-3">
      <div class="sidebar-item active" data-tab="overview" title="Umumiy"><span>üìä</span><span class="sidebar-label">Umumiy</span></div>
      <div class="sidebar-item" data-tab="users" title="Foydalanuvchilar"><span>üë•</span><span class="sidebar-label">Foydalanuvchilar</span></div>
      <div class="sidebar-item" data-tab="payments" title="To'lovlar"><span>üí≥</span><span class="sidebar-label">To'lovlar</span></div>
      <div class="sidebar-item" data-tab="lessons" title="Darslar"><span>üìö</span><span class="sidebar-label">Darslar</span></div>
      <div class="sidebar-item" data-tab="library" title="Kutubxona"><span>üìñ</span><span class="sidebar-label">Kutubxona</span></div>
      <div class="sidebar-item" data-tab="progrev" title="Progrevlar"><span>üî•</span><span class="sidebar-label">Progrevlar</span></div>
      <div class="sidebar-item" data-tab="custdev" title="CustDev"><span>üìù</span><span class="sidebar-label">CustDev</span></div>
      <div class="sidebar-item" data-tab="settings" title="Sozlamalar"><span>‚öôÔ∏è</span><span class="sidebar-label">Sozlamalar</span></div>
    </nav>

    <div class="px-3 w-full space-y-2">
      <div class="sidebar-toggle mx-auto" onclick="toggleSidebar()" title="Menyuni kengaytirish">
        <span id="sidebarToggleIcon">‚Üí</span>
      </div>
      <div class="sidebar-item text-red-400" onclick="logout()" title="Chiqish"><span>üö™</span><span class="sidebar-label">Chiqish</span></div>
    </div>
  </aside>

  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="overview"><span class="text-lg">üìä</span>Umumiy</div>
    <div class="mobile-nav-item" data-tab="users"><span class="text-lg">üë•</span>Userlar</div>
    <div class="mobile-nav-item" data-tab="payments"><span class="text-lg">üí≥</span>To'lov</div>
    <div class="mobile-nav-item" data-tab="lessons"><span class="text-lg">üìö</span>Darslar</div>
    <div class="mobile-nav-item" onclick="toggleMobileMenu()"><span class="text-lg">‚ò∞</span>Ko'proq</div>
  </nav>

  <!-- Mobile Menu Modal -->
  <div id="mobileMenuModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="toggleMobileMenu()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transform transition-transform duration-300">
      <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
      <h3 class="font-semibold text-gray-800 mb-4">Qo'shimcha menyu</h3>
      <div class="grid grid-cols-3 gap-4">
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('library'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìñ</span>
          <span class="text-xs text-gray-600">Kutubxona</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('progrev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üî•</span>
          <span class="text-xs text-gray-600">Progrevlar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('custdev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìù</span>
          <span class="text-xs text-gray-600">CustDev</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('settings'); toggleMobileMenu();">
          <span class="text-2xl mb-2">‚öôÔ∏è</span>
          <span class="text-xs text-gray-600">Sozlamalar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-red-50 cursor-pointer hover:bg-red-100 transition-colors" onclick="logout()">
          <span class="text-2xl mb-2">üö™</span>
          <span class="text-xs text-red-600">Chiqish</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content flex-1 ml-[70px] p-6 pb-24 md:pb-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <p class="text-gray-500 text-sm" id="currentDate"></p>
      </div>
      <div class="flex gap-3">
        <button onclick="openBroadcastModal()" class="btn btn-primary flex items-center gap-2">
          <span>üì®</span> Xabar yuborish
        </button>
        <button onclick="loadAll()" class="btn btn-secondary">üîÑ</button>
      </div>
    </header>

    <!-- Overview Tab -->
    <div id="tab-overview">

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-indigo-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600">üë•</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Jami userlar</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-800" id="statTotalUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-green-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">üíé</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">To'lagan</p>
              <p class="text-xl sm:text-2xl font-bold text-green-600" id="statPaidUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-blue-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-blue-100 to-cyan-100 text-blue-600">üí∞</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Daromad</p>
              <p class="text-xl sm:text-2xl font-bold text-blue-600" id="statRevenue">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-orange-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-orange-100 to-amber-100 text-orange-600">üìà</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Konversiya</p>
              <p class="text-xl sm:text-2xl font-bold text-orange-600" id="statConversion">0%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="card p-5 lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-3xl font-bold text-gray-800" id="totalRevenueDisplay">0 so'm</p>
            </div>
            <div class="flex gap-2">
              <button class="tab active" data-period="week">Hafta</button>
              <button class="tab" data-period="month">Oy</button>
              <button class="tab" data-period="year">Yil</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <!-- User Types -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">Foydalanuvchilar</h3>
          <div class="chart-container h-[180px]">
            <canvas id="userTypeChart"></canvas>
          </div>
          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Aktiv</span>
              <span class="font-medium" id="activeUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> To'lagan</span>
              <span class="font-medium" id="paidUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span> Tugatgan</span>
              <span class="font-medium" id="completedUsersCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscriber Growth Chart -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <p class="text-gray-500 text-sm">Yangi obunachilar</p>
            <p class="text-2xl font-bold text-gray-800" id="subscriberGrowthTitle">Haftalik o'sish</p>
            <p class="text-sm text-gray-400 mt-1" id="growthComparison">Bu davr: <span class="text-indigo-600 font-medium" id="currentPeriodCount">0</span> | O'tgan davr: <span class="text-gray-600 font-medium" id="prevPeriodCount">0</span></p>
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
            <div id="growthIndicator" class="flex items-center gap-1 text-green-600 font-semibold text-lg">
              <span id="growthArrow">‚Üë</span>
              <span id="growthPercent">0%</span>
            </div>
            <div class="flex gap-1 sm:gap-2 flex-wrap">
              <button class="tab text-xs sm:text-sm px-2 sm:px-4 active" data-growth-period="day">Kun</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="week">Hafta</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="month">Oy</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="year">Yil</button>
            </div>
          </div>
        </div>
        <div class="flex gap-4 mb-2 text-xs">
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Bu davr</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-300"></span> O'tgan davr</div>
        </div>
        <div class="chart-container h-[250px]">
          <canvas id="subscriberGrowthChart"></canvas>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Users -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi foydalanuvchilar</h3>
            <button onclick="showTab('users')" class="text-indigo-600 text-sm font-medium">Barchasi ‚Üí</button>
          </div>
          <div id="recentUsersList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Recent Payments -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi to'lovlar</h3>
            <button onclick="showTab('payments')" class="text-indigo-600 text-sm font-medium">Barchasi ‚Üí</button>
          </div>
          <div id="recentPaymentsList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <div class="flex flex-col lg:flex-row justify-between gap-4 mb-4">
            <h3 class="font-semibold text-gray-800 text-lg">üë• Foydalanuvchilar <span class="text-gray-400 font-normal" id="filteredUsersCount"></span></h3>
            <div class="flex gap-2 items-center flex-wrap">
              <input type="text" id="userSearch" class="input py-2 px-3 w-48" placeholder="üîç Ism, telefon..." oninput="applyUserFilters()">
              <button onclick="toggleAdvancedFilters()" class="btn btn-secondary btn-sm flex items-center gap-1">
                <span>üéõÔ∏è</span> <span id="advFilterLabel">Filtrlar</span>
              </button>
              <button onclick="exportUsers()" class="btn btn-secondary btn-sm" title="Eksport">üì•</button>
            </div>
          </div>

          <!-- Advanced Filters Panel -->
          <div id="advancedFiltersPanel" class="hidden bg-gray-50 rounded-xl p-4 space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <!-- Status Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Status</label>
                <select id="userStatusFilter" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="free">Free</option>
                  <option value="paid">Premium</option>
                </select>
              </div>

              <!-- Lesson Range -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (dan)</label>
                <input type="number" id="filterLessonFrom" class="input py-2 text-sm" min="0" placeholder="0" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (gacha)</label>
                <input type="number" id="filterLessonTo" class="input py-2 text-sm" min="0" placeholder="10" onchange="applyUserFilters()">
              </div>

              <!-- Registration Date -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Ro'yxatdan o'tish</label>
                <select id="filterRegDate" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="today">Bugun</option>
                  <option value="week">Bu hafta</option>
                  <option value="month">Bu oy</option>
                  <option value="custom">Tanlash...</option>
                </select>
              </div>

              <!-- Phone Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Telefon</label>
                <select id="filterPhone" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="has">Bor</option>
                  <option value="no">Yo'q</option>
                </select>
              </div>

              <!-- Funnel Step -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Funnel bosqich</label>
                <select id="filterFunnelStep" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="0">0 - Yangi</option>
                  <option value="1">1-4 - CustDev</option>
                  <option value="5">5 - Darsda</option>
                  <option value="8">8+ - Tugagan</option>
                </select>
              </div>
            </div>

            <!-- Custom Date Range (hidden by default) -->
            <div id="customDateRange" class="hidden grid grid-cols-2 gap-3 max-w-sm">
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Boshlanish</label>
                <input type="date" id="filterDateFrom" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Tugash</label>
                <input type="date" id="filterDateTo" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
            </div>

            <div class="flex gap-2">
              <button onclick="resetUserFilters()" class="btn btn-secondary btn-sm">üîÑ Tozalash</button>
              <span class="text-sm text-gray-500 flex items-center" id="activeFiltersInfo"></span>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dars</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-100 flex justify-center gap-2" id="usersPagination"></div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="tab-payments" class="hidden">
      <!-- Payment Status Tabs -->
      <div class="flex gap-2 mb-4">
        <button class="tab active" data-payment-status="completed" onclick="filterPayments('completed')">‚úÖ To'langan</button>
        <button class="tab" data-payment-status="pending" onclick="filterPayments('pending')">‚è≥ Jarayonda</button>
        <button class="tab" data-payment-status="cancelled" onclick="filterPayments('cancelled')">‚ùå Bekor qilingan</button>
        <button class="tab" data-payment-status="all" onclick="filterPayments('all')">üìã Barchasi</button>
      </div>

      <!-- Payment Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Bugun</p>
          <p class="text-2xl font-bold text-green-600" id="payToday">0</p>
          <p class="text-xs text-gray-400" id="payTodayCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Hafta</p>
          <p class="text-2xl font-bold text-blue-600" id="payWeek">0</p>
          <p class="text-xs text-gray-400" id="payWeekCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Oy</p>
          <p class="text-2xl font-bold text-indigo-600" id="payMonth">0</p>
          <p class="text-xs text-gray-400" id="payMonthCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami</p>
          <p class="text-2xl font-bold text-gray-800" id="payTotal">0</p>
          <p class="text-xs text-gray-400" id="payTotalCount">0 ta</p>
        </div>
      </div>

      <!-- Payment Status Summary -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="card p-4 border-l-4 border-green-500">
          <p class="text-sm text-gray-500">To'langan</p>
          <p class="text-xl font-bold text-green-600" id="payCompletedCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-yellow-500">
          <p class="text-sm text-gray-500">Jarayonda</p>
          <p class="text-xl font-bold text-yellow-600" id="payPendingCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-red-500">
          <p class="text-sm text-gray-500">Bekor qilingan</p>
          <p class="text-xl font-bold text-red-600" id="payCancelledCount">0</p>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <h3 class="font-semibold text-gray-800 text-lg">üí≥ To'lovlar tarixi</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summa</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reja</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tizim</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lessons Tab -->
    <div id="tab-lessons" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">üìö Darslar</h3>
          <button onclick="openLessonModal()" class="btn btn-primary">+ Yangi dars</button>
        </div>
        <div id="lessonsList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- Lesson Progress Stats -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">üìä Darslar bo'yicha statistika</h3>
        <div id="lessonProgressStats" class="space-y-3">
          <p class="text-gray-400 text-center">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Media ID Info -->
      <div class="card mt-6 p-5 bg-blue-50 border-blue-200">
        <h3 class="font-semibold text-blue-800 mb-2">üí° Media ID olish</h3>
        <p class="text-sm text-blue-600">
          Telegram botga video/audio/fayl/video xabar yuboring - bot sizga File ID beradi.
          O'sha ID ni darsga joylashtirsangiz, foydalanuvchilarga o'sha media yuboriladi.
        </p>
      </div>
    </div>

    <!-- Library Tab (Darslar kutubxonasi) -->
    <div id="tab-library" class="hidden">

      <!-- Media Library Section (Botga yuborilgan fayllar) -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üìÅ Media kutubxonasi</h3>
            <p class="text-sm text-gray-500">Botga yuborilgan barcha media fayllar</p>
          </div>
          <div class="flex gap-2">
            <select id="mediaTypeFilter" class="input text-sm" onchange="loadMediaLibrary()">
              <option value="all">Barchasi</option>
              <option value="video">üé¨ Video</option>
              <option value="photo">üñº Rasm</option>
              <option value="voice">üé§ Ovozli</option>
              <option value="audio">üéµ Audio</option>
              <option value="video_note">‚ö™ Video xabar</option>
            </select>
            <button onclick="loadMediaLibrary()" class="btn btn-secondary text-sm">üîÑ</button>
          </div>
        </div>

        <!-- Media Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-4">
          <div class="bg-indigo-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Jami</p>
            <p class="text-lg font-bold text-indigo-600" id="mediaStatsTotal">0</p>
          </div>
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video</p>
            <p class="text-lg font-bold text-blue-600" id="mediaStatsVideo">0</p>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Rasm</p>
            <p class="text-lg font-bold text-green-600" id="mediaStatsPhoto">0</p>
          </div>
          <div class="bg-orange-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Audio</p>
            <p class="text-lg font-bold text-orange-600" id="mediaStatsAudio">0</p>
          </div>
          <div class="bg-purple-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video xabar</p>
            <p class="text-lg font-bold text-purple-600" id="mediaStatsVideoNote">0</p>
          </div>
        </div>

        <div id="mediaLibraryList" class="space-y-2 max-h-[400px] overflow-y-auto">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>

        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-800">üí° <strong>Yangi media qo'shish:</strong> Botga istalgan media (video, rasm, audio) yuboring - avtomatik kutubxonaga qo'shiladi!</p>
        </div>
      </div>

      <!-- Darslar kutubxonasi -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üìñ Darslar kutubxonasi</h3>
            <p class="text-sm text-gray-500">Barcha darslarning ID lari va tafsilotlari</p>
          </div>
          <button onclick="copyAllLessonIds()" class="btn btn-secondary text-sm">
            üìã Barcha ID larni nusxalash
          </button>
        </div>

        <div id="libraryLessonsList" class="space-y-3">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Quick Reference -->
      <div class="card p-5 bg-gradient-to-br from-indigo-50 to-purple-50">
        <h3 class="font-semibold text-indigo-800 mb-4">üìå Tez ma'lumot</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Jami darslar</p>
            <p class="text-2xl font-bold text-indigo-600" id="libraryTotalLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Video bilan</p>
            <p class="text-2xl font-bold text-green-600" id="libraryVideoLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Audio bilan</p>
            <p class="text-2xl font-bold text-orange-600" id="libraryAudioLessons">0</p>
          </div>
        </div>
      </div>

      <!-- Usage Guide -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">üí° Foydalanish bo'yicha</h3>
        <div class="space-y-3 text-sm text-gray-600">
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">1</span>
            <p><strong>ID nusxalash:</strong> Istalgan dars ID sini bosib nusxalang</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">2</span>
            <p><strong>Media qo'shish:</strong> Botga video/audio yuboring, File ID oling</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">3</span>
            <p><strong>Test qilish:</strong> Admin paneldan darsni test sifatida yuborib ko'ring</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Progrev Tab (Pitch/Sales/Soft Attack) -->
    <div id="tab-progrev" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Pitch Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üé¨ Pitch (Asosiy taklif)</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
              <input type="number" id="pitchAfterLesson" class="input" value="4" min="1">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - darsdan keyin qancha vaqt o'tib yuboriladi</label>
              <input type="number" id="pitchDelayMinutes" class="input" value="120" min="0">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Feedback savoli matni (caption)</label>
              <textarea id="pitchText" class="input h-24 resize-none" placeholder="Bepul darslar yoqdimi? ü§î"></textarea>
              <p class="text-xs text-gray-400 mt-1">Media bilan birga ko'rsatiladi yoki alohida matn sifatida</p>
            </div>

            <div class="p-4 bg-indigo-50 rounded-lg space-y-4">
              <div>
                <label class="text-sm font-medium text-indigo-800 mb-2 block">üìé Media turi</label>
                <select id="pitchMediaType" class="input" onchange="togglePitchMediaFields()">
                  <option value="none">üìù Faqat matn (mediasiz)</option>
                  <option value="video">üé¨ Video</option>
                  <option value="audio">üé§ Ovozli xabar (voice)</option>
                  <option value="image">üñºÔ∏è Rasm</option>
                  <option value="video_note">‚ö™ Video xabar (dumaloq)</option>
                </select>
              </div>

              <div id="pitchMediaVideoField" class="hidden">
                <label class="text-sm text-gray-600 mb-1 block">Video File ID</label>
                <input type="text" id="pitchVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
                <p class="text-xs text-gray-400 mt-1">Botga video yuboring va file_id ni oling</p>
              </div>

              <div id="pitchMediaAudioField" class="hidden">
                <label class="text-sm text-gray-600 mb-1 block">Audio/Voice File ID</label>
                <input type="text" id="pitchAudioFileId" class="input file-id-input" placeholder="AwACAgIAAxk...">
                <p class="text-xs text-gray-400 mt-1">Botga ovozli xabar yuboring va file_id ni oling</p>
              </div>

              <div id="pitchMediaImageField" class="hidden">
                <label class="text-sm text-gray-600 mb-1 block">Rasm File ID</label>
                <input type="text" id="pitchImageFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
                <p class="text-xs text-gray-400 mt-1">Botga rasm yuboring va file_id ni oling</p>
              </div>

              <div id="pitchMediaVideoNoteField" class="hidden">
                <label class="text-sm text-gray-600 mb-1 block">Video Note File ID (dumaloq video)</label>
                <input type="text" id="pitchVideoNoteFileId" class="input file-id-input" placeholder="DQACAgIAAxk...">
                <p class="text-xs text-gray-400 mt-1">Botga dumaloq video xabar yuboring va file_id ni oling</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Sales Pitch Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí∞ Sales Pitch (Narxlar xabari)</h3>
          <p class="text-xs text-gray-400 mb-3">Feedback "Ha" javobidan keyin yoki dars tugaganida ko'rsatiladi</p>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - pitchdan keyin</label>
              <input type="number" id="salesDelayMinutes" class="input" value="60" min="0">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sales matn sarlavhasi</label>
              <textarea id="salesPitchText" class="input h-32 resize-none" placeholder="üéì SMM PRO KURSGA TAKLIF!

Obuna turini tanlang:"></textarea>
              <p class="text-xs text-gray-400 mt-1">Bu matn narxlar ro'yxati bilan birga ko'rsatiladi</p>
            </div>
          </div>
        </div>

        <!-- Soft Attack Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üî• Soft Attack (Oxirgi taklif)</h3>
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <input type="checkbox" id="softAttackDisabled" class="w-5 h-5 accent-red-600">
              <label class="text-sm text-gray-600">O'chirilgan</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - sales pitchdan keyin</label>
              <input type="number" id="softAttackDelayMinutes" class="input" value="1440" min="0">
              <p class="text-xs text-gray-400 mt-1">1440 daqiqa = 24 soat</p>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Soft attack matni</label>
              <textarea id="softAttackText" class="input h-32 resize-none" placeholder="Oxirgi taklif matni..."></textarea>
            </div>
          </div>
        </div>

        <!-- Lesson Completion Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üì∫ Dars ko'rish tugmasi</h3>
          <p class="text-xs text-gray-400 mb-3">Har bir darsdan keyin ko'rsatiladigan matnlar (default qiymatlar)</p>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Tugmadan oldingi matn</label>
              <input type="text" id="watchedMessageDefault" class="input" placeholder="Videoni ko'rib bo'lganingizdan keyin tugmani bosing:">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Tugma matni</label>
              <input type="text" id="watchedButtonDefault" class="input" placeholder="‚úÖ Videoni ko'rib bo'ldim">
            </div>
          </div>
        </div>

        <!-- Congrats Message -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üéâ Tabrik xabari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Barcha darslar tugaganidan keyin</label>
              <textarea id="congratsText" class="input h-32 resize-none" placeholder="üéâ Tabriklayman! Barcha bepul darslarni tugatdingiz!"></textarea>
            </div>
          </div>
        </div>

      </div>

      <!-- Feedback Flow Section -->
      <div class="card p-5 mt-6">
        <h3 class="font-semibold text-gray-800 mb-4">üí¨ Feedback Flow (Fikr olish va sotuvga o'tish)</h3>
        <p class="text-sm text-gray-500 mb-4">4-darsdan keyin darhol foydalanuvchi fikrini oling va javobga qarab sotuvga o'ting</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Feedback Question -->
          <div class="space-y-4">
            <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg">
              <input type="checkbox" id="feedbackEnabled" class="w-5 h-5 accent-indigo-600" checked>
              <label class="text-sm font-medium text-indigo-800">Feedback flow yoqilgan (darsdan keyin darhol so'raydi)</label>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">Feedback savoli</label>
              <textarea id="feedbackQuestion" class="input h-24 resize-none" placeholder="Bepul darslar yoqdimi? ü§î"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">üëç Ha tugmasi</label>
                <input type="text" id="feedbackYesBtn" class="input" value="üëç Ha, juda yoqdi!">
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">üëé Yo'q tugmasi</label>
                <input type="text" id="feedbackNoBtn" class="input" value="üòê Unchalik emas">
              </div>
            </div>
          </div>

          <!-- Feedback Responses -->
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">‚úÖ Ijobiy javobdan keyin (darhol sotuvga o'tadi)</label>
              <textarea id="feedbackYesResponse" class="input h-20 resize-none" placeholder="üéâ Ajoyib! Unda to'liq kursga taklif qilaman..."></textarea>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">‚ùå Salbiy javobdan keyin (sabab so'raydi)</label>
              <textarea id="feedbackNoResponse" class="input h-20 resize-none" placeholder="üòî Tushunaman. Iltimos, nimada kamchilik borligini yozing..."></textarea>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">üîÑ Salbiy feedbackdan keyin qancha vaqtda sotuvga o'tadi (daqiqa)</label>
              <input type="number" id="feedbackNoSalesDelay" class="input" value="30" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = darhol sabab yozganidan keyin</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Negative Feedback Follow-up -->
      <div class="card p-5 mt-6">
        <h3 class="font-semibold text-gray-800 mb-4">üîÑ Salbiy feedback follow-up</h3>
        <p class="text-sm text-gray-500 mb-4">Foydalanuvchi salbiy fikr bildirganidan keyin yuboriladi</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Follow-up xabar (sabab yozganidan keyin)</label>
              <textarea id="feedbackFollowup" class="input h-28 resize-none" placeholder="Rahmat fikringiz uchun! üôè

Biz doimo yaxshilanib boramiz. Shunday bo'lsa ham, to'liq kursda bunday muammolar yo'q - professional darajada tayyorlangan..."></textarea>
            </div>

            <div class="flex items-center gap-3">
              <input type="checkbox" id="feedbackFollowupShowPrices" class="w-5 h-5 accent-indigo-600" checked>
              <label class="text-sm text-gray-600">Follow-up bilan birga narxlarni ko'rsatish</label>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Maxsus chegirma taklifi (salbiy feedback uchun)</label>
              <textarea id="feedbackSpecialOffer" class="input h-20 resize-none" placeholder="üéÅ Sizga maxsus 20% chegirma! Faqat bugun amal qiladi..."></textarea>
            </div>
            <div class="flex items-center gap-3">
              <input type="checkbox" id="feedbackSpecialOfferEnabled" class="w-5 h-5 accent-orange-600">
              <label class="text-sm text-gray-600">Maxsus chegirma taklifini yoqish</label>
            </div>
          </div>
        </div>
      </div>

      <button onclick="saveProgrevSettings()" class="btn btn-primary mt-6">üíæ Progrev sozlamalarini saqlash</button>
    </div>

    <!-- CustDev Tab -->
    <div id="tab-custdev" class="hidden">
      <!-- CustDev Overview Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami savollar</p>
          <p class="text-2xl font-bold text-indigo-600" id="custdevTotalQuestions">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami javoblar</p>
          <p class="text-2xl font-bold text-green-600" id="custdevTotalAnswers">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Javob berganlar</p>
          <p class="text-2xl font-bold text-blue-600" id="custdevRespondents">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">O'rtacha javob</p>
          <p class="text-2xl font-bold text-orange-600" id="custdevAvgAnswers">0</p>
        </div>
      </div>

      <!-- CustDev Charts -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Yosh</p>
          <div class="chart-container h-[120px]">
            <canvas id="ageChart"></canvas>
          </div>
          <div id="ageChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Kasb</p>
          <div class="chart-container h-[120px]">
            <canvas id="occupationChart"></canvas>
          </div>
          <div id="occupationChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Daromad</p>
          <div class="chart-container h-[120px]">
            <canvas id="incomeChart"></canvas>
          </div>
          <div id="incomeChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Byudjet</p>
          <div class="chart-container h-[120px]">
            <canvas id="budgetChart"></canvas>
          </div>
          <div id="budgetChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
      </div>

      <!-- Questions List -->
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">üìù CustDev savollari</h3>
          <button onclick="openCustDevModal()" class="btn btn-primary">+ Yangi savol</button>
        </div>
        <div id="custdevList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- User Feedback Section -->
      <div class="card mt-6">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üí¨ Foydalanuvchi feedbacklari</h3>
            <p class="text-sm text-gray-400">Bepul darslar haqida fikrlar</p>
          </div>
          <div class="flex gap-2">
            <select id="feedbackFilter" class="input py-2 px-3 w-auto text-sm" onchange="filterFeedback()">
              <option value="all">Barchasi</option>
              <option value="liked">üëç Yoqdi</option>
              <option value="not_liked">üëé Yoqmadi</option>
              <option value="disliked_reason">üìù Sabablar</option>
            </select>
            <button onclick="loadFeedback()" class="btn btn-secondary text-sm">üîÑ Yangilash</button>
          </div>
        </div>

        <!-- Feedback Stats -->
        <div class="grid grid-cols-3 gap-4 p-5 border-b border-gray-100 bg-gray-50">
          <div class="text-center">
            <p class="text-2xl font-bold text-green-600" id="feedbackLikedCount">0</p>
            <p class="text-xs text-gray-500">üëç Yoqdi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-red-600" id="feedbackDislikedCount">0</p>
            <p class="text-xs text-gray-500">üëé Yoqmadi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-indigo-600" id="feedbackTotalCount">0</p>
            <p class="text-xs text-gray-500">Jami</p>
          </div>
        </div>

        <!-- Feedback List -->
        <div id="feedbackList" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Channel Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üì¢ Kanal sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Premium kanal ID</label>
              <input type="text" id="settingPremiumChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal ID</label>
              <input type="text" id="settingFreeChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal linki</label>
              <input type="text" id="settingFreeChannelLink" class="input" placeholder="https://t.me/channel">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Obuna talab qilinadigan dars (0 = talab qilinmaydi)</label>
              <input type="number" id="settingRequireSub" class="input" value="0" min="0">
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí∞ Narxlar (so'm)</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1 oylik</label>
              <input type="number" id="settingPrice1m" class="input" placeholder="97000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">3 oylik</label>
              <input type="number" id="settingPrice3m" class="input" placeholder="247000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">6 oylik</label>
              <input type="number" id="settingPrice6m" class="input" placeholder="447000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">12 oylik</label>
              <input type="number" id="settingPrice12m" class="input" placeholder="797000">
            </div>
          </div>
        </div>

        <!-- Payment Systems -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí≥ To'lov tizimlari</h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingPayme" class="w-5 h-5 accent-blue-600">
              <span class="text-lg">üí≥</span>
              <span class="font-medium">Payme</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingClick" class="w-5 h-5 accent-green-600">
              <span class="text-lg">üí†</span>
              <span class="font-medium">Click</span>
            </label>
          </div>
        </div>

        <!-- Admin Info -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üë§ Admin</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Admin Telegram ID</label>
              <input type="text" id="settingAdminId" class="input font-mono" placeholder="123456789">
            </div>
          </div>
        </div>

      </div>

      <button onclick="saveSettings()" class="btn btn-primary mt-6 w-full lg:w-auto">üíæ Sozlamalarni saqlash</button>
    </div>

  </main>

  <!-- Right Panel (Desktop only) -->
  <aside class="right-panel hidden lg:block w-80 p-6 border-l border-gray-100 bg-gradient-to-b from-white to-gray-50/50">

    <!-- Stats Card -->
    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 rounded-2xl p-5 text-white mb-6 shadow-lg shadow-indigo-500/25 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <p class="text-indigo-200 text-sm mb-1 relative">üí∞ Umumiy daromad</p>
      <p class="text-3xl font-bold mb-4 relative" id="rightPanelRevenue">0 so'm</p>
      <div class="flex justify-between text-sm relative">
        <span class="text-indigo-200">üìÖ Bu oy</span>
        <span class="font-semibold bg-white/20 px-2 py-0.5 rounded-full" id="rightPanelMonthRevenue">0</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-800">‚ö° So'nggi faoliyat</h3>
        <span class="text-xs text-indigo-500 font-medium">Live</span>
      </div>
      <div id="recentActivity" class="space-y-2 max-h-64 overflow-y-auto">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Lesson Funnel -->
    <div class="bg-gradient-to-br from-gray-50 to-indigo-50/30 rounded-xl p-4 -mx-2">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-sm">üìä</span>
        Darslar funneli
      </h3>
      <div id="lessonProgressPanel" class="funnel-container">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

  </aside>

</div>

<!-- Broadcast Modal (Advanced) -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6 max-h-[95vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">üì® Xabar yuborish</h3>
      <button onclick="closeModal('broadcastModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Target & Variables -->
      <div class="space-y-4">
        <!-- Target Selection -->
        <div class="bg-gray-50 rounded-xl p-4">
          <label class="text-sm font-medium text-gray-700 mb-2 block">üìç Kimga yuborish</label>
          <select id="broadcastTarget" class="input" onchange="toggleUserSelect(); updateRecipientCount()">
            <option value="all">Hammaga</option>
            <option value="paid">To'laganlarga (Premium)</option>
            <option value="free">To'lamaganlarga (Free)</option>
            <option value="active">Aktiv foydalanuvchilarga</option>
            <option value="lesson">Muayyan darsda bo'lganlarga</option>
            <option value="specific">Tanlangan foydalanuvchilarga</option>
          </select>

          <!-- Lesson Range (for lesson target) -->
          <div id="lessonRangeDiv" class="hidden mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500">Dars (dan)</label>
              <input type="number" id="broadcastLessonFrom" class="input py-2" min="0" value="1" onchange="updateRecipientCount()">
            </div>
            <div>
              <label class="text-xs text-gray-500">Dars (gacha)</label>
              <input type="number" id="broadcastLessonTo" class="input py-2" min="0" value="4" onchange="updateRecipientCount()">
            </div>
          </div>

          <!-- User Search (for specific) -->
          <div id="userSelectDiv" class="hidden mt-3">
            <input type="text" id="broadcastUserSearch" class="input mb-2" placeholder="üîç Ism yoki telefon..." oninput="searchBroadcastUsers()">
            <div id="broadcastUsersList" class="max-h-32 overflow-y-auto border rounded-lg p-2 space-y-1 bg-white"></div>
            <div class="mt-2">
              <p class="text-xs text-gray-500">Tanlangan: <span id="selectedUsersCount" class="font-medium text-indigo-600">0</span> ta</p>
              <div id="selectedUsersList" class="flex flex-wrap gap-1 mt-1"></div>
            </div>
          </div>

          <!-- Recipient Count -->
          <div class="mt-3 p-3 bg-indigo-50 rounded-lg">
            <p class="text-sm text-indigo-700">
              <span class="font-semibold" id="recipientCount">0</span> ta foydalanuvchiga yuboriladi
            </p>
          </div>
        </div>

        <!-- Variables Help -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100">
          <label class="text-sm font-medium text-amber-800 mb-2 block">üî§ O'zgaruvchilar (bosib qo'shing)</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" onclick="insertVariable('{{ism}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{ism}}</button>
            <button type="button" onclick="insertVariable('{{fio}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{fio}}</button>
            <button type="button" onclick="insertVariable('{{telefon}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{telefon}}</button>
            <button type="button" onclick="insertVariable('{{dars}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{dars}}</button>
          </div>
          <div class="mt-3 text-xs text-amber-600 space-y-1">
            <p><code class="bg-white px-1 rounded">{{ism}}</code> - Foydalanuvchi ismi</p>
            <p><code class="bg-white px-1 rounded">{{fio}}</code> - To'liq ism</p>
            <p><code class="bg-white px-1 rounded">{{telefon}}</code> - Telefon raqami</p>
            <p><code class="bg-white px-1 rounded">{{dars}}</code> - Hozirgi dars raqami</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Message Content -->
      <div class="space-y-4">
        <!-- Message Type -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">üìé Xabar turi</label>
          <select id="broadcastType" class="input" onchange="toggleBroadcastMedia()">
            <option value="text">üìù Faqat matn</option>
            <option value="photo">üñºÔ∏è Rasm + Matn</option>
            <option value="video">üé¨ Video + Matn</option>
            <option value="video_note">üîµ Video xabar (dumaloq)</option>
            <option value="voice">üé§ Ovozli xabar</option>
            <option value="audio">üéµ Audio fayl</option>
            <option value="document">üìÑ Hujjat</option>
          </select>
        </div>

        <!-- Media File ID -->
        <div id="broadcastMediaDiv" class="hidden">
          <label class="text-sm font-medium text-gray-700 mb-2 block">üîó Media File ID</label>
          <input type="text" id="broadcastMediaId" class="input file-id-input" placeholder="File ID ni kiriting...">
          <p class="text-xs text-gray-400 mt-1">üí° Botga media yuboring - avtomatik ID olasiz</p>
        </div>

        <!-- Message Text -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">‚úèÔ∏è Xabar matni</label>
          <textarea id="broadcastText" class="input h-36 resize-none" placeholder="Salom, {{ism}}! üëã&#10;&#10;Xabaringizni yozing..." oninput="updatePreview()"></textarea>
          <div class="flex justify-between mt-1">
            <p class="text-xs text-gray-400">HTML teglar qo'llab-quvvatlanadi: &lt;b&gt;, &lt;i&gt;, &lt;a&gt;</p>
            <p class="text-xs text-gray-400"><span id="charCount">0</span> belgi</p>
          </div>
        </div>

        <!-- Button -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">üîò Tugma (ixtiyoriy)</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="broadcastBtnText" class="input" placeholder="Tugma matni" oninput="updatePreview()">
            <input type="text" id="broadcastBtnUrl" class="input" placeholder="https://..." oninput="updatePreview()">
          </div>
        </div>

        <!-- Preview -->
        <div class="bg-gray-900 rounded-xl p-4">
          <label class="text-xs font-medium text-gray-400 mb-2 block">üëÅ Oldindan ko'rish</label>
          <div id="broadcastPreview" class="bg-indigo-600/20 rounded-lg p-3 text-white text-sm">
            <p class="text-gray-300 italic">Xabar matni bu yerda ko'rinadi...</p>
          </div>
          <div id="previewButton" class="hidden mt-2">
            <div class="inline-block bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
              <span id="previewBtnText">Tugma</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex flex-col sm:flex-row gap-3">
      <button onclick="sendBroadcast()" class="btn btn-primary flex-1 flex items-center justify-center gap-2">
        <span>üì§</span> Yuborish
      </button>
      <button onclick="previewBroadcast()" class="btn btn-secondary flex items-center justify-center gap-2">
        <span>üëÅ</span> Test (o'zimga)
      </button>
      <button onclick="closeModal('broadcastModal')" class="btn btn-secondary">Bekor qilish</button>
    </div>

    <!-- Progress Indicator -->
    <div id="broadcastProgress" class="hidden mt-4">
      <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
        <div id="broadcastProgressBar" class="bg-indigo-600 h-full transition-all duration-300" style="width: 0%"></div>
      </div>
      <p class="text-sm text-gray-500 mt-2 text-center">
        <span id="broadcastSent">0</span> / <span id="broadcastTotal">0</span> yuborildi
      </p>
    </div>
  </div>
</div>

<!-- Lesson Modal (with Media IDs) -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="lessonModalTitle">üìö Yangi dars</h3>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>
    <form id="lessonForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <input type="hidden" id="lessonId">

      <!-- Basic Info -->
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Dars raqami</label>
            <input type="number" id="lessonNumber" class="input" required min="1">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (soat)</label>
            <input type="number" id="lessonDelay" class="input" value="24" min="0">
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Sarlavha</label>
          <input type="text" id="lessonTitle" class="input" required>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Matn</label>
          <textarea id="lessonText" class="input h-40 resize-none"></textarea>
        </div>
      </div>

      <!-- Media IDs -->
      <div class="space-y-4">
        <div class="p-3 bg-blue-50 rounded-lg mb-4">
          <p class="text-sm text-blue-700">üí° Botga media yuboring - File ID oling. O'sha ID ni qo'ying.</p>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">üé¨ Video File ID</label>
          <input type="text" id="lessonVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üîµ Video xabar File ID (dumaloq)</label>
          <input type="text" id="lessonVideoNoteFileId" class="input file-id-input" placeholder="DQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üéµ Audio File ID</label>
          <input type="text" id="lessonAudioFileId" class="input file-id-input" placeholder="CQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üìé Fayl File ID</label>
          <input type="text" id="lessonDocumentFileId" class="input file-id-input" placeholder="BQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üñº Rasm File ID</label>
          <input type="text" id="lessonPhotoFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
        </div>
      </div>

      <div class="lg:col-span-2">
        <button type="submit" class="btn btn-primary w-full">üíæ Saqlash</button>
      </div>
    </form>
  </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">üë§ Foydalanuvchi ma'lumotlari</h3>
      <button onclick="closeModal('userDetailModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- User Info -->
      <div>
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-2xl font-bold" id="userDetailAvatar">U</div>
          <div>
            <p class="text-xl font-bold text-gray-800" id="userDetailName">-</p>
            <p class="text-gray-500" id="userDetailUsername">-</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telegram ID</span>
            <span class="font-mono font-medium" id="userDetailTgId">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telefon</span>
            <span class="font-medium" id="userDetailPhone">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Hozirgi dars</span>
            <span class="badge badge-blue" id="userDetailLesson">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Status</span>
            <span id="userDetailStatus">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Ro'yxatdan o'tgan</span>
            <span class="font-medium" id="userDetailCreated">-</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-4 flex gap-2">
          <button onclick="sendMessageToUser()" class="btn btn-primary btn-sm flex-1">üì® Xabar yuborish</button>
        </div>
      </div>

      <!-- CustDev Answers -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">üìù CustDev javoblari</h4>
        <div id="userDetailCustdev" class="space-y-3">
          <p class="text-gray-400 text-center py-4">Javoblar yo'q</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Question Stats Modal -->
<div id="custdevStatsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevStatsTitle">üìä Savol statistikasi</h3>
      <button onclick="closeModal('custdevStatsModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chart -->
      <div>
        <div class="chart-container h-[250px]">
          <canvas id="questionStatsChart"></canvas>
        </div>
      </div>

      <!-- Answers List -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">Javoblar ro'yxati</h4>
        <div id="questionAnswersList" class="max-h-[300px] overflow-y-auto space-y-2">
          <p class="text-gray-400">Yuklanmoqda...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevModalTitle">üìù Yangi savol</h3>
      <button onclick="closeModal('custdevModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>
    <form id="custdevForm" class="space-y-4">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
        <input type="number" id="custdevAfterLesson" class="input" value="1" min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
        <textarea id="custdevQuestion" class="input h-24 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Javob turi</label>
        <select id="custdevType" class="input" onchange="toggleCustdevOptions()">
          <option value="text">Matn (yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      <div id="custdevOptionsDiv" class="hidden">
        <label class="text-sm text-gray-600 mb-1 block">Variantlar (har qator - bitta)</label>
        <textarea id="custdevOptions" class="input h-24 resize-none font-mono" placeholder="18-25&#10;26-35&#10;36-45"></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Field nomi (statistika uchun)</label>
        <input type="text" id="custdevFieldName" class="input" placeholder="age, income, occupation...">
        <p class="text-xs text-gray-400 mt-1">Masalan: age, income, occupation, budget</p>
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let auth = '';
let allUsers = [];
let allPayments = [];
let allLessons = [];
let allCustDev = [];
let allFeedback = [];
let currentPage = 1;
const perPage = 20;
let paymentFilter = 'completed';
let selectedBroadcastUsers = new Set();
let custdevAnswers = {};

// Charts
let revenueChart, userTypeChart, subscriberGrowthChart;
let ageChart, occupationChart, incomeChart, budgetChart;
let questionStatsChart;

// ========== INITIALIZATION ==========
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('uz-UZ', {
  year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
});

const saved = localStorage.getItem('adminAuth');
if (saved) { auth = saved; showDashboard(); }

// Login
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', { headers: { Authorization: auth } });
    if (r.ok) { localStorage.setItem('adminAuth', auth); showDashboard(); }
    else document.getElementById('loginError').classList.remove('hidden');
  } catch(e) { document.getElementById('loginError').classList.remove('hidden'); }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadAll();
}

function logout() {
  localStorage.removeItem('adminAuth');
  location.reload();
}

function toggleMobileMenu() {
  const modal = document.getElementById('mobileMenuModal');
  modal.classList.toggle('hidden');
}

// ========== SIDEBAR TOGGLE ==========
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  const icon = document.getElementById('sidebarToggleIcon');

  sidebar.classList.toggle('expanded');
  const isExpanded = sidebar.classList.contains('expanded');

  icon.textContent = isExpanded ? '‚Üê' : '‚Üí';
  mainContent.style.marginLeft = isExpanded ? '200px' : '70px';

  localStorage.setItem('sidebarExpanded', isExpanded);
}

// Initialize sidebar state from localStorage
(function initSidebar() {
  const isExpanded = localStorage.getItem('sidebarExpanded') === 'true';
  if (isExpanded) {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const icon = document.getElementById('sidebarToggleIcon');
    if (sidebar && mainContent && icon) {
      sidebar.classList.add('expanded');
      icon.textContent = '‚Üê';
      mainContent.style.marginLeft = '200px';
    }
  }
})();

// ========== ADVANCED USER FILTERS ==========
let advancedFiltersVisible = false;

function toggleAdvancedFilters() {
  advancedFiltersVisible = !advancedFiltersVisible;
  const panel = document.getElementById('advancedFiltersPanel');
  const label = document.getElementById('advFilterLabel');
  panel.classList.toggle('hidden', !advancedFiltersVisible);
  label.textContent = advancedFiltersVisible ? 'Yopish' : 'Filtrlar';
}

function applyUserFilters() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const status = document.getElementById('userStatusFilter').value;
  const lessonFrom = parseInt(document.getElementById('filterLessonFrom')?.value) || 0;
  const lessonTo = parseInt(document.getElementById('filterLessonTo')?.value) || 999;
  const regDate = document.getElementById('filterRegDate')?.value || 'all';
  const phone = document.getElementById('filterPhone')?.value || 'all';
  const funnelStep = document.getElementById('filterFunnelStep')?.value || 'all';

  // Show/hide custom date range
  const customDateDiv = document.getElementById('customDateRange');
  if (customDateDiv) {
    customDateDiv.classList.toggle('hidden', regDate !== 'custom');
  }

  let filtered = allUsers.filter(u => {
    // Search filter
    if (search) {
      const searchMatch = (u.full_name || '').toLowerCase().includes(search) ||
                         (u.username || '').toLowerCase().includes(search) ||
                         (u.phone || '').includes(search) ||
                         String(u.telegram_id).includes(search);
      if (!searchMatch) return false;
    }

    // Status filter
    if (status === 'paid' && !u.is_paid) return false;
    if (status === 'free' && u.is_paid) return false;

    // Lesson range filter
    const lesson = u.current_lesson || 0;
    if (lesson < lessonFrom || lesson > lessonTo) return false;

    // Phone filter
    if (phone === 'has' && !u.phone) return false;
    if (phone === 'no' && u.phone) return false;

    // Funnel step filter
    if (funnelStep !== 'all') {
      const step = parseInt(funnelStep);
      if (step === 1 && (u.funnel_step < 1 || u.funnel_step > 4)) return false;
      if (step === 5 && (u.funnel_step < 5 || u.funnel_step > 7)) return false;
      if (step === 8 && u.funnel_step < 8) return false;
      if (step === 0 && u.funnel_step !== 0) return false;
    }

    // Date filter
    if (regDate !== 'all' && regDate !== 'custom') {
      const created = new Date(u.created_at);
      const now = new Date();
      if (regDate === 'today') {
        if (created.toDateString() !== now.toDateString()) return false;
      } else if (regDate === 'week') {
        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
        if (created < weekAgo) return false;
      } else if (regDate === 'month') {
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        if (created < monthAgo) return false;
      }
    } else if (regDate === 'custom') {
      const fromDate = document.getElementById('filterDateFrom')?.value;
      const toDate = document.getElementById('filterDateTo')?.value;
      const created = new Date(u.created_at);
      if (fromDate && created < new Date(fromDate)) return false;
      if (toDate && created > new Date(toDate + 'T23:59:59')) return false;
    }

    return true;
  });

  // Update filtered count
  document.getElementById('filteredUsersCount').textContent = `(${filtered.length} ta)`;

  // Update active filters info
  let activeCount = 0;
  if (search) activeCount++;
  if (status !== 'all') activeCount++;
  if (lessonFrom > 0 || lessonTo < 999) activeCount++;
  if (regDate !== 'all') activeCount++;
  if (phone !== 'all') activeCount++;
  if (funnelStep !== 'all') activeCount++;

  const infoEl = document.getElementById('activeFiltersInfo');
  if (infoEl) {
    infoEl.textContent = activeCount > 0 ? `${activeCount} ta filtr faol` : '';
  }

  // Render filtered results
  renderFilteredUsers(filtered);
}

function renderFilteredUsers(filtered) {
  const start = (currentPage - 1) * perPage;
  const paginated = filtered.slice(start, start + perPage);

  const tbody = document.getElementById('usersTableBody');
  if (!paginated.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Foydalanuvchilar topilmadi</td></tr>';
    return;
  }

  tbody.innerHTML = paginated.map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">üëÅ</button>
      </td>
    </tr>
  `).join('');

  // Pagination
  const totalPages = Math.ceil(filtered.length / perPage);
  const pagination = document.getElementById('usersPagination');
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHTML = '';
  for (let i = 1; i <= Math.min(totalPages, 10); i++) {
    paginationHTML += `<button onclick="currentPage=${i}; applyUserFilters()" class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm">${i}</button>`;
  }
  pagination.innerHTML = paginationHTML;
}

function resetUserFilters() {
  document.getElementById('userSearch').value = '';
  document.getElementById('userStatusFilter').value = 'all';
  if (document.getElementById('filterLessonFrom')) document.getElementById('filterLessonFrom').value = '';
  if (document.getElementById('filterLessonTo')) document.getElementById('filterLessonTo').value = '';
  if (document.getElementById('filterRegDate')) document.getElementById('filterRegDate').value = 'all';
  if (document.getElementById('filterPhone')) document.getElementById('filterPhone').value = 'all';
  if (document.getElementById('filterFunnelStep')) document.getElementById('filterFunnelStep').value = 'all';
  if (document.getElementById('filterDateFrom')) document.getElementById('filterDateFrom').value = '';
  if (document.getElementById('filterDateTo')) document.getElementById('filterDateTo').value = '';
  currentPage = 1;
  applyUserFilters();
}

function exportUsers() {
  // Export filtered users to CSV
  const search = document.getElementById('userSearch').value.toLowerCase();
  let filtered = allUsers;
  if (search) {
    filtered = allUsers.filter(u =>
      (u.full_name || '').toLowerCase().includes(search) ||
      (u.phone || '').includes(search)
    );
  }

  const csv = [
    ['ID', 'Ism', 'Username', 'Telefon', 'Dars', 'Status', 'Sana'].join(','),
    ...filtered.map(u => [
      u.telegram_id,
      `"${u.full_name || ''}"`,
      `"${u.username || ''}"`,
      u.phone || '',
      u.current_lesson || 0,
      u.is_paid ? 'Premium' : 'Free',
      u.created_at?.split('T')[0] || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
}

// ========== BROADCAST ENHANCEMENTS ==========
function insertVariable(variable) {
  const textarea = document.getElementById('broadcastText');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  textarea.value = text.substring(0, start) + variable + text.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
  updatePreview();
}

function updatePreview() {
  const text = document.getElementById('broadcastText').value || '';
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;

  // Update char count
  document.getElementById('charCount').textContent = text.length;

  // Preview with sample data
  let preview = text
    .replace(/\{\{ism\}\}/gi, 'Ali')
    .replace(/\{\{fio\}\}/gi, 'Ali Valiyev')
    .replace(/\{\{telefon\}\}/gi, '+998901234567')
    .replace(/\{\{dars\}\}/gi, '3')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/&lt;b&gt;/g, '<b>')
    .replace(/&lt;\/b&gt;/g, '</b>')
    .replace(/&lt;i&gt;/g, '<i>')
    .replace(/&lt;\/i&gt;/g, '</i>')
    .replace(/\n/g, '<br>');

  document.getElementById('broadcastPreview').innerHTML = preview || '<p class="text-gray-300 italic">Xabar matni bu yerda ko\'rinadi...</p>';

  // Preview button
  const previewBtn = document.getElementById('previewButton');
  if (btnText && btnUrl) {
    document.getElementById('previewBtnText').textContent = btnText;
    previewBtn.classList.remove('hidden');
  } else {
    previewBtn.classList.add('hidden');
  }
}

function updateRecipientCount() {
  const target = document.getElementById('broadcastTarget').value;
  let count = 0;

  // Show/hide lesson range div
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }

  if (target === 'all') {
    count = allUsers.length;
  } else if (target === 'paid') {
    count = allUsers.filter(u => u.is_paid).length;
  } else if (target === 'free') {
    count = allUsers.filter(u => !u.is_paid).length;
  } else if (target === 'active') {
    count = allUsers.filter(u => u.current_lesson > 0 && !u.is_paid).length;
  } else if (target === 'lesson') {
    const from = parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0;
    const to = parseInt(document.getElementById('broadcastLessonTo')?.value) || 999;
    count = allUsers.filter(u => u.current_lesson >= from && u.current_lesson <= to).length;
  } else if (target === 'specific') {
    count = selectedBroadcastUsers.length;
  }

  document.getElementById('recipientCount').textContent = count;
}

async function previewBroadcast() {
  // Send test message to admin
  const text = document.getElementById('broadcastText').value;
  if (!text) {
    alert('Xabar matnini kiriting');
    return;
  }

  try {
    await fetch('/api/broadcast/test', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        type: document.getElementById('broadcastType').value,
        media_id: document.getElementById('broadcastMediaId').value,
        button: {
          text: document.getElementById('broadcastBtnText').value,
          url: document.getElementById('broadcastBtnUrl').value
        }
      })
    });
    alert('‚úÖ Test xabar yuborildi (o\'zingizga)');
  } catch (e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.sidebar-item[data-tab], .mobile-nav-item[data-tab]').forEach(item => {
  item.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

// ========== REVENUE PERIOD TABS ==========
let currentRevenuePeriod = 'week';
document.querySelectorAll('button[data-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentRevenuePeriod = this.dataset.period;
    renderRevenueChart(currentRevenuePeriod);
  });
});

// ========== SUBSCRIBER GROWTH PERIOD TABS ==========
let currentGrowthPeriod = 'day';
document.querySelectorAll('button[data-growth-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-growth-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentGrowthPeriod = this.dataset.growthPeriod;
    renderSubscriberGrowthChart(currentGrowthPeriod);
  });
});

function showTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');

  document.querySelectorAll('.sidebar-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.sidebar-item[data-tab="' + tab + '"]')?.classList.add('active');

  document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.mobile-nav-item[data-tab="' + tab + '"]')?.classList.add('active');

  // Load tab-specific data
  if (tab === 'progrev') loadProgrevSettings();
  if (tab === 'custdev') loadFeedback();
  if (tab === 'settings') loadSettingsForm();
}

async function loadSettingsForm() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    // Channel settings
    document.getElementById('settingPremiumChannel').value = data.premium_channel_id || '';
    document.getElementById('settingFreeChannel').value = data.free_channel_id || '';
    document.getElementById('settingFreeChannelLink').value = data.free_channel_link || '';
    document.getElementById('settingRequireSub').value = data.require_subscription_before_lesson || 0;

    // Payment settings - FIXED: load saved values
    document.getElementById('settingPayme').checked = data.payme_enabled !== false;
    document.getElementById('settingClick').checked = data.click_enabled !== false;

    // Price settings
    if (data.price_1m) document.getElementById('settingPrice1m').value = Math.round(data.price_1m / 100);
    if (data.price_3m) document.getElementById('settingPrice3m').value = Math.round(data.price_3m / 100);
    if (data.price_6m) document.getElementById('settingPrice6m').value = Math.round(data.price_6m / 100);
    if (data.price_12m) document.getElementById('settingPrice12m').value = Math.round(data.price_12m / 100);

  } catch(e) { console.error('loadSettingsForm error:', e); }
}

// ========== LOAD DATA ==========
async function loadAll() {
  await Promise.all([loadStats(), loadUsers(), loadPayments(), loadLessons(), loadCustDev(), loadCustdevAnswers(), loadFeedback(), loadSettingsForm(), loadMediaLibrary()]);
  renderCharts();
}

async function loadStats() {
  try {
    const stats = await (await fetch('/api/stats', { headers: { Authorization: auth } })).json();

    document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('statPaidUsers').textContent = stats.paidUsers || 0;
    document.getElementById('statRevenue').textContent = fmtMoney(stats.totalRevenue || 0);

    const conv = stats.totalUsers > 0 ? Math.round((stats.paidUsers / stats.totalUsers) * 100) : 0;
    document.getElementById('statConversion').textContent = conv + '%';

    document.getElementById('rightPanelRevenue').textContent = fmtMoney(stats.totalRevenue || 0);
    document.getElementById('rightPanelMonthRevenue').textContent = fmtMoney(stats.monthRevenue || 0);
    document.getElementById('totalRevenueDisplay').textContent = fmtMoney(stats.totalRevenue || 0);

    document.getElementById('activeUsersCount').textContent = stats.activeUsers || 0;
    document.getElementById('paidUsersCount').textContent = stats.paidUsers || 0;
    document.getElementById('completedUsersCount').textContent = stats.completedUsers || 0;

  } catch(e) { console.error('loadStats error:', e); }
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users', { headers: { Authorization: auth } })).json();
    allUsers = data;
    renderUsers();
    renderRecentUsers();
    renderRecentActivity();
  } catch(e) { console.error('loadUsers error:', e); }
}

async function loadPayments() {
  try {
    const data = await (await fetch('/api/payments?all=true', { headers: { Authorization: auth } })).json();
    allPayments = data;
    renderPayments();
    renderRecentPayments();
    renderPaymentStats();
  } catch(e) { console.error('loadPayments error:', e); }
}

async function loadLessons() {
  try {
    const data = await (await fetch('/api/lessons', { headers: { Authorization: auth } })).json();
    allLessons = data.sort((a, b) => a.lesson_number - b.lesson_number);
    renderLessons();
    renderLessonProgress();
    renderLibrary();
  } catch(e) { console.error('loadLessons error:', e); }
}

async function loadCustDev() {
  try {
    const data = await (await fetch('/api/custdev', { headers: { Authorization: auth } })).json();
    allCustDev = data;
    renderCustDev();
  } catch(e) { console.error('loadCustDev error:', e); }
}

async function loadCustdevAnswers() {
  try {
    const data = await (await fetch('/api/custdev/answers', { headers: { Authorization: auth } })).json();
    custdevAnswers = data;
    renderCustDevStats();
  } catch(e) { console.error('loadCustdevAnswers error:', e); }
}

async function loadFeedback() {
  try {
    const response = await fetch('/api/feedback', { headers: { Authorization: auth } });
    if (!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    const data = await response.json();
    allFeedback = Array.isArray(data) ? data : [];
    renderFeedback();
  } catch(e) {
    console.error('loadFeedback error:', e);
    const container = document.getElementById('feedbackList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

// ========== MEDIA LIBRARY ==========
let allMedia = [];

async function loadMediaLibrary() {
  try {
    const filterType = document.getElementById('mediaTypeFilter')?.value || 'all';
    const url = filterType === 'all' ? '/api/media' : '/api/media/' + filterType;
    const data = await (await fetch(url, { headers: { Authorization: auth } })).json();
    allMedia = Array.isArray(data) ? data : [];
    renderMediaLibrary();
  } catch(e) {
    console.error('loadMediaLibrary error:', e);
    const container = document.getElementById('mediaLibraryList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

function renderMediaLibrary() {
  const container = document.getElementById('mediaLibraryList');
  if (!container) return;

  // Calculate stats
  const videoCount = allMedia.filter(m => m.file_type === 'video').length;
  const photoCount = allMedia.filter(m => m.file_type === 'photo').length;
  const audioCount = allMedia.filter(m => m.file_type === 'audio' || m.file_type === 'voice').length;
  const videoNoteCount = allMedia.filter(m => m.file_type === 'video_note').length;

  document.getElementById('mediaStatsTotal').textContent = allMedia.length;
  document.getElementById('mediaStatsVideo').textContent = videoCount;
  document.getElementById('mediaStatsPhoto').textContent = photoCount;
  document.getElementById('mediaStatsAudio').textContent = audioCount;
  document.getElementById('mediaStatsVideoNote').textContent = videoNoteCount;

  if (!allMedia.length) {
    container.innerHTML = `<div class="p-8 text-center text-gray-400">
      <p class="mb-2">Hali media yo'q</p>
      <p class="text-xs">Botga video, rasm yoki audio yuboring - bu yerda ko'rinadi</p>
    </div>`;
    return;
  }

  container.innerHTML = allMedia.map(m => {
    const time = timeAgo(m.created_at);

    // Get icon and color based on type
    let icon = 'üìé';
    let color = 'gray';
    let typeName = m.file_type;

    if (m.file_type === 'video') { icon = 'üé¨'; color = 'blue'; typeName = 'Video'; }
    else if (m.file_type === 'photo') { icon = 'üñº'; color = 'green'; typeName = 'Rasm'; }
    else if (m.file_type === 'voice') { icon = 'üé§'; color = 'orange'; typeName = 'Ovozli'; }
    else if (m.file_type === 'audio') { icon = 'üéµ'; color = 'orange'; typeName = 'Audio'; }
    else if (m.file_type === 'video_note') { icon = '‚ö™'; color = 'purple'; typeName = 'Video xabar'; }

    const caption = m.caption ? m.caption.slice(0, 50) + (m.caption.length > 50 ? '...' : '') : '';
    const fileName = m.file_name || 'Nomsiz';

    return \`
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <span class="text-2xl">\${icon}</span>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="badge badge-\${color} text-xs">\${typeName}</span>
              <span class="text-xs text-gray-400">\${time}</span>
            </div>
            <p class="text-sm font-medium text-gray-700 truncate" title="\${fileName}">\${fileName}</p>
            \${caption ? \`<p class="text-xs text-gray-500 truncate">\${caption}</p>\` : ''}
          </div>
        </div>
        <div class="flex items-center gap-2 ml-2">
          <button onclick="copyMediaId('\${m.file_id}')" class="btn btn-secondary text-xs px-2 py-1" title="File ID nusxalash">
            üìã
          </button>
          <button onclick="editMediaCaption(\${m.id}, '\${(m.caption || '').replace(/'/g, "\\\\'")}', '\${m.file_id}')" class="btn btn-secondary text-xs px-2 py-1" title="Izoh o'zgartirish">
            ‚úèÔ∏è
          </button>
          <button onclick="deleteMediaItem(\${m.id})" class="btn btn-danger text-xs px-2 py-1" title="O'chirish">
            üóë
          </button>
        </div>
      </div>
    \`;
  }).join('');
}

function copyMediaId(fileId) {
  navigator.clipboard.writeText(fileId).then(() => {
    showToast('‚úÖ File ID nusxalandi!');
  }).catch(e => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = fileId;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('‚úÖ File ID nusxalandi!');
  });
}

function editMediaCaption(id, currentCaption, fileId) {
  const newCaption = prompt('Yangi izoh kiriting:', currentCaption);
  if (newCaption === null) return; // cancelled

  fetch('/api/media/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', Authorization: auth },
    body: JSON.stringify({ caption: newCaption })
  })
  .then(r => r.json())
  .then(() => {
    showToast('‚úÖ Izoh saqlandi!');
    loadMediaLibrary();
  })
  .catch(e => {
    showToast('‚ùå Xatolik: ' + e.message);
  });
}

async function deleteMediaItem(id) {
  if (!confirm('Bu media faylni o\\'chirishni xohlaysizmi?')) return;

  try {
    await fetch('/api/media/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    showToast('‚úÖ Media o\\'chirildi!');
    loadMediaLibrary();
  } catch(e) {
    showToast('‚ùå Xatolik: ' + e.message);
  }
}

function renderFeedback() {
  const container = document.getElementById('feedbackList');
  const filter = document.getElementById('feedbackFilter')?.value || 'all';

  // Filter feedbacks
  let filteredFeedback = allFeedback;
  if (filter !== 'all') {
    filteredFeedback = allFeedback.filter(f => f.feedback_type === filter);
  }

  // Update stats
  const liked = allFeedback.filter(f => f.feedback_type === 'liked').length;
  const notLiked = allFeedback.filter(f => f.feedback_type === 'not_liked' || f.feedback_type === 'disliked_reason').length;

  document.getElementById('feedbackLikedCount').textContent = liked;
  document.getElementById('feedbackDislikedCount').textContent = notLiked;
  document.getElementById('feedbackTotalCount').textContent = allFeedback.length;

  if (!filteredFeedback.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Feedback yo\'q<br><span class="text-xs">Bu yerda 4-darsdan keyin "Yoqdi/Yoqmadi" bosgan foydalanuvchilar ko\'rinadi</span></div>';
    return;
  }

  container.innerHTML = filteredFeedback.map(f => {
    const time = timeAgo(f.created_at);
    const name = f.full_name || f.username || 'Noma\'lum';

    let typeIcon = 'üí¨';
    let typeBadge = 'badge-gray';
    let typeText = 'Feedback';

    if (f.feedback_type === 'liked') {
      typeIcon = 'üëç';
      typeBadge = 'badge-green';
      typeText = 'Yoqdi';
    } else if (f.feedback_type === 'not_liked') {
      typeIcon = 'üëé';
      typeBadge = 'badge-red';
      typeText = 'Yoqmadi';
    } else if (f.feedback_type === 'disliked_reason') {
      typeIcon = 'üìù';
      typeBadge = 'badge-orange';
      typeText = 'Sabab';
    }

    return `
      <div class="p-4 hover:bg-gray-50 transition-colors">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-lg flex-shrink-0">
            ${typeIcon}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap mb-1">
              <span class="font-medium text-gray-800">${name}</span>
              <span class="badge ${typeBadge}">${typeText}</span>
              <span class="text-xs text-gray-400">${time}</span>
            </div>
            ${f.feedback_text ? `
              <p class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 mt-2">${f.feedback_text}</p>
            ` : ''}
            <div class="flex items-center gap-3 mt-2 text-xs text-gray-400">
              ${f.phone ? `<span>üì± ${f.phone}</span>` : ''}
              <span>ID: ${f.telegram_id}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function filterFeedback() {
  renderFeedback();
}

function togglePitchMediaFields() {
  const mediaType = document.getElementById('pitchMediaType').value;

  // Hide all media fields
  document.getElementById('pitchMediaVideoField').classList.add('hidden');
  document.getElementById('pitchMediaAudioField').classList.add('hidden');
  document.getElementById('pitchMediaImageField').classList.add('hidden');
  document.getElementById('pitchMediaVideoNoteField').classList.add('hidden');

  // Show selected field
  if (mediaType === 'video') {
    document.getElementById('pitchMediaVideoField').classList.remove('hidden');
  } else if (mediaType === 'audio') {
    document.getElementById('pitchMediaAudioField').classList.remove('hidden');
  } else if (mediaType === 'image') {
    document.getElementById('pitchMediaImageField').classList.remove('hidden');
  } else if (mediaType === 'video_note') {
    document.getElementById('pitchMediaVideoNoteField').classList.remove('hidden');
  }
}

async function loadProgrevSettings() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    document.getElementById('pitchAfterLesson').value = data.pitch_after_lesson || 4;
    document.getElementById('pitchDelayMinutes').value = data.pitch_delay_minutes || 0;
    document.getElementById('pitchText').value = data.pitch_text || '';
    document.getElementById('pitchVideoFileId').value = data.pitch_video_file_id || '';
    document.getElementById('pitchAudioFileId').value = data.pitch_audio_file_id || '';
    document.getElementById('pitchImageFileId').value = data.pitch_image_file_id || '';
    document.getElementById('pitchVideoNoteFileId').value = data.pitch_video_note_file_id || '';

    // Determine media type from file IDs
    let mediaType = 'none';
    if (data.pitch_video_file_id) mediaType = 'video';
    else if (data.pitch_audio_file_id) mediaType = 'audio';
    else if (data.pitch_image_file_id) mediaType = 'image';
    else if (data.pitch_video_note_file_id) mediaType = 'video_note';
    if (data.pitch_media_type) mediaType = data.pitch_media_type;
    document.getElementById('pitchMediaType').value = mediaType;
    togglePitchMediaFields();

    document.getElementById('salesDelayMinutes').value = data.sales_delay_minutes || 0;
    document.getElementById('salesPitchText').value = data.sales_pitch || '';

    document.getElementById('softAttackDisabled').checked = data.soft_attack_disabled || false;
    document.getElementById('softAttackDelayMinutes').value = data.soft_attack_delay_minutes || 1440;
    document.getElementById('softAttackText').value = data.soft_attack_text || '';

    document.getElementById('congratsText').value = data.congrats_text || '';

    // Lesson completion defaults
    document.getElementById('watchedMessageDefault').value = data.watched_message_default || '';
    document.getElementById('watchedButtonDefault').value = data.watched_button_default || '';

    // Feedback flow settings
    document.getElementById('feedbackEnabled').checked = data.feedback_enabled !== false;
    document.getElementById('feedbackQuestion').value = data.feedback_question || 'Bepul darslar yoqdimi? ü§î';
    document.getElementById('feedbackYesBtn').value = data.feedback_yes_btn || 'üëç Ha, juda yoqdi!';
    document.getElementById('feedbackNoBtn').value = data.feedback_no_btn || 'üòê Unchalik emas';
    document.getElementById('feedbackYesResponse').value = data.feedback_yes_response || 'üéâ Ajoyib! Unda to\'liq kursga taklif qilaman...';
    document.getElementById('feedbackNoResponse').value = data.feedback_no_response || 'üòî Tushunaman. Iltimos, nimada kamchilik borligini yozing...';
    document.getElementById('feedbackNoSalesDelay').value = data.feedback_no_sales_delay || 30;
    document.getElementById('feedbackFollowup').value = data.feedback_followup || '';
    document.getElementById('feedbackFollowupShowPrices').checked = data.feedback_followup_show_prices !== false;
    document.getElementById('feedbackSpecialOffer').value = data.feedback_special_offer || '';
    document.getElementById('feedbackSpecialOfferEnabled').checked = data.feedback_special_offer_enabled || false;
  } catch(e) { console.error('loadProgrevSettings error:', e); }
}

// ========== RENDER FUNCTIONS ==========
function renderUsers() {
  // Use new advanced filter system
  applyUserFilters();
}

function goToPage(page) {
  currentPage = page;
  applyUserFilters();
}

function searchUsers() {
  // Deprecated - use applyUserFilters instead
  applyUserFilters();
}

function searchUsersOld() {
  const query = document.getElementById('userSearch').value.toLowerCase();
  if (!query) { renderUsers(); return; }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  );

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = filtered.slice(0, 20).map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">üëÅ</button>
      </td>
    </tr>
  `).join('');
}

function renderRecentUsers() {
  const recent = allUsers.slice(0, 5);
  const container = document.getElementById('recentUsersList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">Foydalanuvchilar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(u => `
    <div class="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50" onclick="openUserDetail(${u.telegram_id})">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
        ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${u.current_lesson || 0}-dars</p>
      </div>
      ${u.is_paid ? '<span class="badge badge-green">üíé</span>' : ''}
    </div>
  `).join('');
}

function filterPayments(status) {
  paymentFilter = status;

  document.querySelectorAll('[data-payment-status]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.paymentStatus === status);
  });

  renderPayments();
}

function renderPayments() {
  const tbody = document.getElementById('paymentsTableBody');

  let filtered = allPayments;
  if (paymentFilter !== 'all') {
    filtered = allPayments.filter(p => p.status === paymentFilter);
  }

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.slice(0, 50).map(p => {
    let statusBadge = '';
    if (p.status === 'completed') statusBadge = '<span class="badge badge-green">To\'langan</span>';
    else if (p.status === 'pending') statusBadge = '<span class="badge badge-yellow">Jarayonda</span>';
    else if (p.status === 'cancelled' || p.status === 'failed') statusBadge = '<span class="badge badge-red">Bekor</span>';
    else statusBadge = `<span class="badge badge-gray">${p.status || '-'}</span>`;

    return `
      <tr class="table-row">
        <td class="px-5 py-4 text-gray-500 text-sm">${fmtDateTime(p.created_at)}</td>
        <td class="px-5 py-4">
          <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
          <p class="text-xs text-gray-400">ID: ${p.telegram_id || '-'}</p>
        </td>
        <td class="px-5 py-4 font-semibold ${p.status === 'completed' ? 'text-green-600' : 'text-gray-600'}">${fmtMoney(p.amount)}</td>
        <td class="px-5 py-4"><span class="badge badge-blue">${p.plan || '-'}</span></td>
        <td class="px-5 py-4">${statusBadge}</td>
        <td class="px-5 py-4 text-gray-500">${p.payment_system || '-'}</td>
      </tr>
    `;
  }).join('');
}

function renderRecentPayments() {
  const recent = allPayments.filter(p => p.status === 'completed').slice(0, 5);
  const container = document.getElementById('recentPaymentsList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">To\'lovlar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(p => `
    <div class="flex items-center gap-3 p-4">
      <div class="activity-icon bg-green-100 text-green-600">üí∞</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${fmtDate(p.created_at)}</p>
      </div>
      <p class="font-semibold text-green-600">${fmtMoney(p.amount)}</p>
    </div>
  `).join('');
}

function renderPaymentStats() {
  const completed = allPayments.filter(p => p.status === 'completed');
  const pending = allPayments.filter(p => p.status === 'pending');
  const cancelled = allPayments.filter(p => p.status === 'cancelled' || p.status === 'failed');

  document.getElementById('payCompletedCount').textContent = completed.length;
  document.getElementById('payPendingCount').textContent = pending.length;
  document.getElementById('payCancelledCount').textContent = cancelled.length;

  const now = new Date();
  const today = completed.filter(p => new Date(p.created_at).toDateString() === now.toDateString());
  const week = completed.filter(p => (now - new Date(p.created_at)) < 7 * 24 * 60 * 60 * 1000);
  const month = completed.filter(p => (now - new Date(p.created_at)) < 30 * 24 * 60 * 60 * 1000);

  const sum = arr => arr.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('payToday').textContent = fmtMoney(sum(today));
  document.getElementById('payTodayCount').textContent = today.length + ' ta';
  document.getElementById('payWeek').textContent = fmtMoney(sum(week));
  document.getElementById('payWeekCount').textContent = week.length + ' ta';
  document.getElementById('payMonth').textContent = fmtMoney(sum(month));
  document.getElementById('payMonthCount').textContent = month.length + ' ta';
  document.getElementById('payTotal').textContent = fmtMoney(sum(completed));
  document.getElementById('payTotalCount').textContent = completed.length + ' ta';
}

function renderLessons() {
  const container = document.getElementById('lessonsList');

  if (!allLessons.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Darslar yo\'q. Yangi dars qo\'shing!</div>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const hasMedia = l.video_file_id || l.video_note_file_id || l.audio_file_id || l.document_file_id || l.photo_file_id;
    const mediaIcons = [];
    if (l.video_file_id) mediaIcons.push('üé¨');
    if (l.video_note_file_id) mediaIcons.push('üîµ');
    if (l.audio_file_id) mediaIcons.push('üéµ');
    if (l.document_file_id) mediaIcons.push('üìé');
    if (l.photo_file_id) mediaIcons.push('üñº');

    return `
      <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
        <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
          ${l.lesson_number}
        </div>
        <div class="flex-1">
          <p class="font-medium text-gray-800">${l.title}</p>
          <p class="text-sm text-gray-400">
            ${l.delay_hours || 0} soat keyin
            ${mediaIcons.length ? ' ‚Ä¢ ' + mediaIcons.join(' ') : ''}
          </p>
        </div>
        <button onclick="editLesson(${l.id})" class="btn btn-secondary text-sm">‚úèÔ∏è</button>
        <button onclick="deleteLesson(${l.id})" class="btn bg-red-50 text-red-600 text-sm">üóëÔ∏è</button>
      </div>
    `;
  }).join('');
}

// ========== LIBRARY (Darslar kutubxonasi) ==========
function renderLibrary() {
  const container = document.getElementById('libraryLessonsList');
  if (!container) return;

  // Update stats
  const videoCount = allLessons.filter(l => l.video_file_id || l.video_note_file_id).length;
  const audioCount = allLessons.filter(l => l.audio_file_id).length;

  document.getElementById('libraryTotalLessons').textContent = allLessons.length;
  document.getElementById('libraryVideoLessons').textContent = videoCount;
  document.getElementById('libraryAudioLessons').textContent = audioCount;

  if (!allLessons.length) {
    container.innerHTML = '<p class="text-gray-400 text-center py-8">Darslar yo\'q</p>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const mediaInfo = [];
    if (l.video_file_id) mediaInfo.push({ type: 'Video', id: l.video_file_id, icon: 'üé¨', color: 'indigo' });
    if (l.video_note_file_id) mediaInfo.push({ type: 'Video xabar', id: l.video_note_file_id, icon: 'üîµ', color: 'blue' });
    if (l.audio_file_id) mediaInfo.push({ type: 'Audio', id: l.audio_file_id, icon: 'üéµ', color: 'orange' });
    if (l.document_file_id) mediaInfo.push({ type: 'Fayl', id: l.document_file_id, icon: 'üìé', color: 'gray' });
    if (l.photo_file_id) mediaInfo.push({ type: 'Rasm', id: l.photo_file_id, icon: 'üñº', color: 'green' });

    const mediaHtml = mediaInfo.map(m => `
      <div class="flex items-center gap-2 bg-${m.color}-50 rounded-lg px-3 py-2">
        <span>${m.icon}</span>
        <span class="text-xs text-${m.color}-600 font-medium">${m.type}:</span>
        <code class="text-xs bg-${m.color}-100 px-2 py-0.5 rounded cursor-pointer hover:bg-${m.color}-200 transition-colors max-w-[200px] truncate" onclick="copyToClipboard('${m.id}')" title="${m.id}">${m.id.substring(0, 25)}...</code>
      </div>
    `).join('');

    return `
      <div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between gap-4 mb-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
              ${l.lesson_number}
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">${l.title}</h4>
              <p class="text-xs text-gray-400">ID: <code class="bg-gray-100 px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200" onclick="copyToClipboard('${l.id}')">${l.id}</code></p>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="testSendLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Test yuborish">
              üì§ Test
            </button>
            <button onclick="editLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Tahrirlash">
              ‚úèÔ∏è
            </button>
          </div>
        </div>

        <div class="text-sm text-gray-600 mb-3 line-clamp-2">${l.text ? l.text.substring(0, 150) + (l.text.length > 150 ? '...' : '') : '<span class="text-gray-400 italic">Matn yo\'q</span>'}</div>

        ${mediaInfo.length ? `
          <div class="border-t border-gray-100 pt-3">
            <p class="text-xs text-gray-400 mb-2 font-medium">Media fayllari:</p>
            <div class="flex flex-wrap gap-2">
              ${mediaHtml}
            </div>
          </div>
        ` : '<p class="text-xs text-gray-400 italic">Media fayl biriktirilmagan</p>'}

        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400">
          <span>‚è± ${l.delay_hours || 0} soat keyin</span>
          ${l.button_text ? `<span>üîò ${l.button_text}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast('Nusxalandi! ‚úÖ');
  }).catch(() => {
    // Fallback
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('Nusxalandi! ‚úÖ');
  });
}

function copyAllLessonIds() {
  const ids = allLessons.map(l => `${l.lesson_number}-dars (ID: ${l.id}): ${l.title}`).join('\n');
  copyToClipboard(ids);
}

async function testSendLesson(lessonId) {
  if (!confirm('Bu darsni o\'zingizga test sifatida yubormoqchimisiz?')) return;

  try {
    const res = await fetch('/api/lessons/' + lessonId + '/test', {
      method: 'POST',
      headers: { Authorization: auth }
    });
    if (res.ok) {
      showToast('Dars yuborildi! Telegram ni tekshiring üì±');
    } else {
      showToast('Xatolik yuz berdi ‚ùå', 'error');
    }
  } catch(e) {
    showToast('Xatolik: ' + e.message, 'error');
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-20 md:bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

function renderLessonProgress() {
  const lessonCounts = {};
  allUsers.forEach(u => {
    const lesson = u.current_lesson || 0;
    lessonCounts[lesson] = (lessonCounts[lesson] || 0) + 1;
  });

  const maxUsers = Math.max(...Object.values(lessonCounts), 1);
  const totalUsers = allUsers.length || 1;

  const statsContainer = document.getElementById('lessonProgressStats');
  const panelContainer = document.getElementById('lessonProgressPanel');

  // Standard bar chart for stats section
  const statsHtml = allLessons.slice(0, 10).map(l => {
    const count = lessonCounts[l.lesson_number] || 0;
    const pct = Math.round((count / maxUsers) * 100);
    return `
      <div class="flex items-center gap-3">
        <span class="w-16 text-sm text-gray-600">${l.lesson_number}-dars</span>
        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-indigo-500 rounded-full" style="width: ${pct}%"></div>
        </div>
        <span class="w-12 text-sm text-gray-600 text-right">${count}</span>
      </div>
    `;
  }).join('');

  statsContainer.innerHTML = statsHtml || '<p class="text-gray-400 text-center">Ma\'lumot yo\'q</p>';

  // Visual funnel for right panel
  const funnelColors = ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#eef2ff', '#f5f3ff'];
  const lessons = allLessons.slice(0, 7);

  if (!lessons.length) {
    panelContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">Ma\'lumot yo\'q</p>';
    return;
  }

  // Calculate cumulative users (users at lesson N or higher)
  const cumulativeCounts = lessons.map((l, idx) => {
    let count = 0;
    lessons.slice(idx).forEach(lesson => {
      count += lessonCounts[lesson.lesson_number] || 0;
    });
    return { lesson: l, count };
  });

  const funnelHtml = cumulativeCounts.map((item, idx) => {
    const count = item.count;
    const lesson = item.lesson;
    const widthPct = Math.max(30, 100 - (idx * 12));
    const pct = Math.round((count / totalUsers) * 100);
    const bgColor = funnelColors[idx % funnelColors.length];
    const textColor = idx < 3 ? '#fff' : '#4338ca';

    return `
      <div class="funnel-step" style="width: ${widthPct}%; background: ${bgColor}; margin-bottom: 2px;">
        <div class="flex justify-between items-center">
          <span style="font-size: 11px; font-weight: 500; color: ${textColor}">${lesson.lesson_number}-dars</span>
          <span style="font-size: 12px; font-weight: 700; color: ${textColor}">${count}</span>
        </div>
        <div style="font-size: 10px; color: ${idx < 3 ? 'rgba(255,255,255,0.7)' : '#6366f1'}">${pct}% foydalanuvchi</div>
      </div>
    `;
  }).join('');

  // Add drop-off stats
  let dropOffHtml = '';
  if (cumulativeCounts.length > 1) {
    const dropOff = cumulativeCounts[0].count - cumulativeCounts[cumulativeCounts.length - 1].count;
    const conversionRate = Math.round((cumulativeCounts[cumulativeCounts.length - 1].count / Math.max(cumulativeCounts[0].count, 1)) * 100);
    dropOffHtml = `
      <div class="mt-3 p-2 bg-gray-50 rounded-lg text-center">
        <div class="text-xs text-gray-500">Konversiya</div>
        <div class="text-lg font-bold text-indigo-600">${conversionRate}%</div>
      </div>
    `;
  }

  panelContainer.innerHTML = funnelHtml + dropOffHtml;
}

function renderCustDev() {
  const container = document.getElementById('custdevList');

  if (!allCustDev.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Savollar yo\'q. Yangi savol qo\'shing!</div>';
    return;
  }

  container.innerHTML = allCustDev.map(q => `
    <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
      <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
        ${q.after_lesson}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${q.question_text}</p>
        <p class="text-sm text-gray-400">
          ${q.question_type === 'buttons' ? 'Tugmalar' : 'Matn'}
          ‚Ä¢ ${q.answer_count || 0} javob
          ${q.field_name ? ' ‚Ä¢ ' + q.field_name : ''}
        </p>
      </div>
      <button onclick="openQuestionStats(${q.id})" class="btn btn-secondary text-sm">üìä</button>
      <button onclick="editCustDev(${q.id})" class="btn btn-secondary text-sm">‚úèÔ∏è</button>
      <button onclick="deleteCustDev(${q.id})" class="btn bg-red-50 text-red-600 text-sm">üóëÔ∏è</button>
    </div>
  `).join('');
}

function renderCustDevStats() {
  // Count stats
  const totalQuestions = allCustDev.length;
  const totalAnswers = Object.values(custdevAnswers).reduce((sum, arr) => sum + arr.length, 0);
  const respondents = new Set();
  Object.values(custdevAnswers).forEach(answers => {
    answers.forEach(a => respondents.add(a.telegram_id));
  });
  const avgAnswers = respondents.size > 0 ? (totalAnswers / respondents.size).toFixed(1) : 0;

  document.getElementById('custdevTotalQuestions').textContent = totalQuestions;
  document.getElementById('custdevTotalAnswers').textContent = totalAnswers;
  document.getElementById('custdevRespondents').textContent = respondents.size;
  document.getElementById('custdevAvgAnswers').textContent = avgAnswers;

  // Render charts with field data
  renderCustDevCharts();
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');

  const activities = [
    ...allUsers.slice(0, 5).map(u => ({ type: 'user', data: u, date: new Date(u.created_at) })),
    ...allPayments.filter(p => p.status === 'completed').slice(0, 5).map(p => ({ type: 'payment', data: p, date: new Date(p.created_at) }))
  ].sort((a, b) => b.date - a.date).slice(0, 5);

  if (!activities.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">Faoliyat yo\'q</div></div>';
    return;
  }

  const timeAgo = (date) => {
    const mins = Math.floor((Date.now() - date) / 60000);
    if (mins < 1) return 'hozirgina';
    if (mins < 60) return mins + ' min oldin';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + ' soat oldin';
    return Math.floor(hours / 24) + ' kun oldin';
  };

  container.innerHTML = activities.map(a => {
    const getName = (d) => d.full_name || d.username || 'Foydalanuvchi';
    const time = timeAgo(a.date);
    if (a.type === 'user') {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600">üë§</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-gray-400">Yangi foydalanuvchi ‚Ä¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
        </div>
      `;
    } else {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">üí∞</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-green-600 font-medium">${fmtMoney(a.data.amount)} ‚Ä¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-green-400 rounded-full"></span>
        </div>
      `;
    }
  }).join('');
}

// ========== CHARTS ==========
function renderCharts() {
  renderRevenueChart(currentRevenuePeriod);
  renderUserTypeChart();
  renderCustDevCharts();
  renderSubscriberGrowthChart(currentGrowthPeriod);
}

function renderRevenueChart(period = 'week') {
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;

  const now = new Date();
  const completedPayments = allPayments.filter(p => p.status === 'completed');

  let labels = [];
  let data = [];
  let periodTotal = 0;

  if (period === 'week') {
    // Last 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      const dayName = days[d.getDay()];
      dailyData[key] = { label: dayName, amount: 0 };
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) {
        dailyData[key].amount += (p.amount || 0);
      }
    });

    Object.values(dailyData).forEach(d => {
      labels.push(d.label);
      data.push(d.amount / 100);
      periodTotal += d.amount;
    });

  } else if (period === 'month') {
    // Current month by days (1-31)
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const dailyData = {};

    for (let i = 1; i <= Math.min(now.getDate(), daysInMonth); i++) {
      dailyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        const day = date.getDate();
        dailyData[day] = (dailyData[day] || 0) + (p.amount || 0);
      }
    });

    Object.entries(dailyData).forEach(([day, amount]) => {
      labels.push(day);
      data.push(amount / 100);
      periodTotal += amount;
    });

  } else if (period === 'year') {
    // Months of current year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getFullYear() === now.getFullYear()) {
        monthlyData[date.getMonth()] = (monthlyData[date.getMonth()] || 0) + (p.amount || 0);
      }
    });

    Object.entries(monthlyData).forEach(([month, amount]) => {
      labels.push(months[parseInt(month)]);
      data.push(amount / 100);
      periodTotal += amount;
    });
  }

  // Update display
  document.getElementById('totalRevenueDisplay').textContent = fmtMoney(periodTotal);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: '#6366f1',
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { grid: { color: '#f3f4f6' }, ticks: { callback: v => v >= 1000 ? (v/1000) + 'K' : v } }
      }
    }
  });
}

function renderSubscriberGrowthChart(period = 'day') {
  const ctx = document.getElementById('subscriberGrowthChart')?.getContext('2d');
  if (!ctx) return;

  const now = new Date();
  let labels = [];
  let data = [];
  let prevData = [];
  let periodLabels = { day: 'Kunlik', week: 'Haftalik', month: 'Oylik', year: 'Yillik' };

  document.getElementById('subscriberGrowthTitle').textContent = periodLabels[period] + ' o\'sish';

  if (period === 'day') {
    // Last 24 hours by hour (current) and previous 24 hours
    const hourlyData = {};
    const prevHourlyData = {};

    for (let i = 23; i >= 0; i--) {
      const h = new Date(now);
      h.setHours(h.getHours() - i, 0, 0, 0);
      const key = h.getHours();
      hourlyData[23 - i] = { hour: key, count: 0 };
      prevHourlyData[23 - i] = { hour: key, count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const diffHours = (now - date) / (1000 * 60 * 60);

      if (diffHours <= 24) {
        const hourIndex = Math.floor(23 - diffHours);
        if (hourIndex >= 0 && hourlyData[hourIndex]) hourlyData[hourIndex].count++;
      } else if (diffHours <= 48) {
        const hourIndex = Math.floor(23 - (diffHours - 24));
        if (hourIndex >= 0 && prevHourlyData[hourIndex]) prevHourlyData[hourIndex].count++;
      }
    });

    Object.values(hourlyData).forEach((d, i) => {
      labels.push(d.hour + ':00');
      data.push(d.count);
      prevData.push(prevHourlyData[i]?.count || 0);
    });

  } else if (period === 'week') {
    // Last 7 days (current) and previous 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};
    const prevDailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      dailyData[key] = { label: days[d.getDay()], count: 0 };

      const pd = new Date(now);
      pd.setDate(pd.getDate() - i - 7);
      const prevKey = pd.toISOString().split('T')[0];
      prevDailyData[prevKey] = { label: days[pd.getDay()], count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) dailyData[key].count++;
      if (prevDailyData[key]) prevDailyData[key].count++;
    });

    const prevValues = Object.values(prevDailyData);
    Object.values(dailyData).forEach((d, i) => {
      labels.push(d.label);
      data.push(d.count);
      prevData.push(prevValues[i]?.count || 0);
    });

  } else if (period === 'month') {
    // Current month by days vs previous month
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
    const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
    const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();

    const dailyData = {};
    const prevDailyData = {};
    const maxDays = Math.min(now.getDate(), daysInMonth);

    for (let i = 1; i <= maxDays; i++) {
      dailyData[i] = 0;
      prevDailyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const day = date.getDate();

      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        if (dailyData[day] !== undefined) dailyData[day]++;
      } else if (date.getMonth() === prevMonth && date.getFullYear() === prevYear && day <= maxDays) {
        if (prevDailyData[day] !== undefined) prevDailyData[day]++;
      }
    });

    Object.entries(dailyData).forEach(([day, count]) => {
      labels.push(day);
      data.push(count);
      prevData.push(prevDailyData[day] || 0);
    });

  } else if (period === 'year') {
    // Current year months vs previous year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};
    const prevMonthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
      prevMonthlyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const month = date.getMonth();

      if (date.getFullYear() === now.getFullYear() && month <= now.getMonth()) {
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      } else if (date.getFullYear() === now.getFullYear() - 1 && month <= now.getMonth()) {
        prevMonthlyData[month] = (prevMonthlyData[month] || 0) + 1;
      }
    });

    Object.entries(monthlyData).forEach(([month, count]) => {
      labels.push(months[parseInt(month)]);
      data.push(count);
      prevData.push(prevMonthlyData[month] || 0);
    });
  }

  // Calculate totals and growth percentage
  const currentTotal = data.reduce((a, b) => a + b, 0);
  const previousTotal = prevData.reduce((a, b) => a + b, 0);

  let growthPercent = 0;
  if (previousTotal > 0) {
    growthPercent = Math.round(((currentTotal - previousTotal) / previousTotal) * 100);
  } else if (currentTotal > 0) {
    growthPercent = 100;
  }

  // Update comparison text
  document.getElementById('currentPeriodCount').textContent = currentTotal;
  document.getElementById('prevPeriodCount').textContent = previousTotal;

  const indicator = document.getElementById('growthIndicator');
  const arrow = document.getElementById('growthArrow');
  const percent = document.getElementById('growthPercent');

  if (growthPercent >= 0) {
    indicator.className = 'flex items-center gap-1 text-green-600 font-semibold text-lg';
    arrow.textContent = '‚Üë';
    percent.textContent = '+' + growthPercent + '%';
  } else {
    indicator.className = 'flex items-center gap-1 text-red-600 font-semibold text-lg';
    arrow.textContent = '‚Üì';
    percent.textContent = growthPercent + '%';
  }

  if (subscriberGrowthChart) subscriberGrowthChart.destroy();

  subscriberGrowthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Bu davr',
          data,
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#6366f1',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        },
        {
          label: 'O\'tgan davr',
          data: prevData,
          borderColor: '#d1d5db',
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.4,
          pointRadius: 3,
          pointBackgroundColor: '#d1d5db',
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: {
          grid: { color: '#f3f4f6' },
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

function renderUserTypeChart() {
  const ctx = document.getElementById('userTypeChart')?.getContext('2d');
  if (!ctx) return;

  const active = allUsers.filter(u => !u.is_paid && !u.lessons_completed).length;
  const paid = allUsers.filter(u => u.is_paid).length;
  const completed = allUsers.filter(u => u.lessons_completed && !u.is_paid).length;

  if (userTypeChart) userTypeChart.destroy();

  userTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Aktiv', 'To\'lagan', 'Tugatgan'],
      datasets: [{
        data: [active, paid, completed],
        backgroundColor: ['#6366f1', '#22c55e', '#e5e7eb'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: { legend: { display: false } }
    }
  });
}

function renderCustDevCharts() {
  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Map various field_name values to chart keys
  const fieldNameMap = {
    // English variations
    'age': 'age', 'age_group': 'age', 'yosh': 'age',
    'occupation': 'occupation', 'kasb': 'occupation', 'job': 'occupation',
    'income': 'income', 'income_level': 'income', 'daromad': 'income',
    'budget': 'budget', 'budget_range': 'budget', 'byudjet': 'budget'
  };

  // Group answers by mapped field_name
  const fieldData = {};
  allCustDev.forEach(q => {
    if (q.field_name && custdevAnswers[q.id]) {
      const answers = custdevAnswers[q.id];
      const mappedField = fieldNameMap[q.field_name.toLowerCase()] || q.field_name;
      if (!fieldData[mappedField]) fieldData[mappedField] = {};

      answers.forEach(a => {
        const value = a.answer_text || 'Boshqa';
        fieldData[mappedField][value] = (fieldData[mappedField][value] || 0) + 1;
      });
    }
  });

  // Render charts for each field
  ['age', 'occupation', 'income', 'budget'].forEach((field, idx) => {
    const ctx = document.getElementById(field + 'Chart')?.getContext('2d');
    if (!ctx) return;

    const data = fieldData[field] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window[field + 'ChartInstance']) window[field + 'ChartInstance'].destroy();

    window[field + 'ChartInstance'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { display: false } }
      }
    });

    // Render legend
    const legendContainer = document.getElementById(field + 'ChartLegend');
    if (legendContainer && labels.length) {
      legendContainer.innerHTML = labels.slice(0, 4).map((label, i) => `
        <div class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full" style="background: ${colors[i % colors.length]}"></span>
          <span class="truncate">${label}: ${values[i]}</span>
        </div>
      `).join('');
    }
  });
}

// ========== MODALS ==========
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ========== USER DETAIL ==========
async function openUserDetail(telegramId) {
  const user = allUsers.find(u => u.telegram_id == telegramId);
  if (!user) return;

  const displayName = user.full_name || user.username || 'Foydalanuvchi';
  document.getElementById('userDetailAvatar').textContent = displayName.charAt(0).toUpperCase();
  document.getElementById('userDetailName').textContent = displayName;
  document.getElementById('userDetailUsername').textContent = user.username ? '@' + user.username : 'username yo\'q';
  document.getElementById('userDetailTgId').textContent = user.telegram_id;
  document.getElementById('userDetailPhone').textContent = user.phone || '-';
  document.getElementById('userDetailLesson').textContent = (user.current_lesson || 0) + '-dars';
  document.getElementById('userDetailStatus').innerHTML = user.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>';
  document.getElementById('userDetailCreated').textContent = fmtDateTime(user.created_at);

  // Load user's custdev answers
  try {
    const answers = await (await fetch('/api/users/' + telegramId + '/custdev', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('userDetailCustdev');

    if (!answers || !answers.length) {
      container.innerHTML = '<p class="text-gray-400 text-center py-4">Javoblar yo\'q</p>';
    } else {
      container.innerHTML = answers.map(a => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500 mb-1">${a.question_text}</p>
          <p class="font-medium text-gray-800">${a.answer_text}</p>
        </div>
      `).join('');
    }
  } catch(e) {
    document.getElementById('userDetailCustdev').innerHTML = '<p class="text-red-400 text-center py-4">Xatolik</p>';
  }

  // Store current user for sending message
  window.currentUserTgId = telegramId;
  openModal('userDetailModal');
}

function sendMessageToUser() {
  closeModal('userDetailModal');
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  const user = allUsers.find(u => u.telegram_id == window.currentUserTgId);
  if (user) {
    selectedBroadcastUsers.add(user.telegram_id);
    updateSelectedUsersList();
  }
}

// ========== BROADCAST ==========
function openBroadcastModal() {
  selectedBroadcastUsers.clear();
  document.getElementById('broadcastTarget').value = 'all';
  document.getElementById('broadcastType').value = 'text';
  document.getElementById('broadcastText').value = '';
  document.getElementById('broadcastMediaId').value = '';
  document.getElementById('broadcastBtnText').value = '';
  document.getElementById('broadcastBtnUrl').value = '';
  document.getElementById('broadcastProgress')?.classList.add('hidden');
  document.getElementById('charCount').textContent = '0';
  toggleUserSelect();
  toggleBroadcastMedia();
  updateRecipientCount();
  updatePreview();
  openModal('broadcastModal');
}

function toggleUserSelect() {
  const target = document.getElementById('broadcastTarget').value;
  document.getElementById('userSelectDiv').classList.toggle('hidden', target !== 'specific');
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }
}

function toggleBroadcastMedia() {
  const type = document.getElementById('broadcastType').value;
  document.getElementById('broadcastMediaDiv').classList.toggle('hidden', type === 'text');
}

function searchBroadcastUsers() {
  const query = document.getElementById('broadcastUserSearch').value.toLowerCase();
  const container = document.getElementById('broadcastUsersList');

  if (!query) {
    container.innerHTML = '<p class="text-gray-400 text-sm">Qidirish...</p>';
    return;
  }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  ).slice(0, 10);

  container.innerHTML = filtered.map(u => `
    <div class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="toggleBroadcastUser(${u.telegram_id})">
      <input type="checkbox" ${selectedBroadcastUsers.has(u.telegram_id) ? 'checked' : ''} class="pointer-events-none">
      <span class="text-sm">${u.full_name || u.username || 'User'}</span>
      <span class="text-xs text-gray-400">${u.phone || u.telegram_id}</span>
    </div>
  `).join('') || '<p class="text-gray-400 text-sm">Topilmadi</p>';
}

function toggleBroadcastUser(telegramId) {
  if (selectedBroadcastUsers.has(telegramId)) {
    selectedBroadcastUsers.delete(telegramId);
  } else {
    selectedBroadcastUsers.add(telegramId);
  }
  searchBroadcastUsers();
  updateSelectedUsersList();
}

function updateSelectedUsersList() {
  document.getElementById('selectedUsersCount').textContent = selectedBroadcastUsers.size;

  const container = document.getElementById('selectedUsersList');
  container.innerHTML = Array.from(selectedBroadcastUsers).map(id => {
    const user = allUsers.find(u => u.telegram_id == id);
    return `
      <span class="badge badge-blue flex items-center gap-1">
        ${user?.full_name || user?.username || id}
        <button onclick="toggleBroadcastUser(${id})" class="ml-1">√ó</button>
      </span>
    `;
  }).join('');
}

async function sendBroadcast() {
  const target = document.getElementById('broadcastTarget').value;
  const type = document.getElementById('broadcastType').value;
  const text = document.getElementById('broadcastText').value;
  const mediaId = document.getElementById('broadcastMediaId').value;
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;

  if (!text.trim() && type === 'text') {
    alert('Xabar matni bo\'sh');
    return;
  }

  if (type !== 'text' && type !== 'video_note' && !mediaId.trim()) {
    alert('Media File ID kiriting');
    return;
  }

  if (target === 'specific' && selectedBroadcastUsers.size === 0) {
    alert('Kamida bitta foydalanuvchi tanlang');
    return;
  }

  // Get recipient count
  const recipientCount = parseInt(document.getElementById('recipientCount').textContent) || 0;
  if (recipientCount === 0) {
    alert('Yuborish uchun foydalanuvchi yo\'q');
    return;
  }

  // Confirm before sending
  if (!confirm(`${recipientCount} ta foydalanuvchiga xabar yuboriladi. Davom etasizmi?`)) {
    return;
  }

  // Show progress
  const progressDiv = document.getElementById('broadcastProgress');
  const progressBar = document.getElementById('broadcastProgressBar');
  const sentSpan = document.getElementById('broadcastSent');
  const totalSpan = document.getElementById('broadcastTotal');

  progressDiv.classList.remove('hidden');
  totalSpan.textContent = recipientCount;
  sentSpan.textContent = '0';
  progressBar.style.width = '0%';

  try {
    const body = {
      target,
      type,
      text,
      media_id: mediaId || null,
      button: btnText && btnUrl ? { text: btnText, url: btnUrl } : null,
      user_ids: target === 'specific' ? Array.from(selectedBroadcastUsers) : null,
      lesson_from: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0 : null,
      lesson_to: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonTo')?.value) || 999 : null
    };

    const res = await fetch('/api/broadcast/advanced', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const result = await res.json();

    // Complete progress
    progressBar.style.width = '100%';
    sentSpan.textContent = result.sent || 0;

    if (res.ok) {
      setTimeout(() => {
        progressDiv.classList.add('hidden');
        alert(`‚úÖ Xabar yuborildi!\n\nüì§ ${result.sent || 0} ta muvaffaqiyatli\n‚ùå ${result.failed || 0} ta xato`);
        closeModal('broadcastModal');

        // Reset form
        document.getElementById('broadcastText').value = '';
        document.getElementById('broadcastMediaId').value = '';
        document.getElementById('broadcastBtnText').value = '';
        document.getElementById('broadcastBtnUrl').value = '';
        selectedBroadcastUsers.clear();
        updateRecipientCount();
      }, 500);
    } else {
      progressDiv.classList.add('hidden');
      alert('Xatolik: ' + (result.error || 'Noma\'lum xato'));
    }
  } catch(e) {
    progressDiv.classList.add('hidden');
    alert('Xatolik: ' + e.message);
  }
}

// ========== LESSONS ==========
function openLessonModal() {
  document.getElementById('lessonModalTitle').textContent = 'üìö Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonNumber').value = allLessons.length + 1;
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonText').value = '';
  document.getElementById('lessonDelay').value = 24;
  document.getElementById('lessonVideoFileId').value = '';
  document.getElementById('lessonVideoNoteFileId').value = '';
  document.getElementById('lessonAudioFileId').value = '';
  document.getElementById('lessonDocumentFileId').value = '';
  document.getElementById('lessonPhotoFileId').value = '';
  openModal('lessonModal');
}

function editLesson(id) {
  const lesson = allLessons.find(l => l.id === id);
  if (!lesson) return;

  document.getElementById('lessonModalTitle').textContent = '‚úèÔ∏è Darsni tahrirlash';
  document.getElementById('lessonId').value = lesson.id;
  document.getElementById('lessonNumber').value = lesson.lesson_number;
  document.getElementById('lessonTitle').value = lesson.title;
  document.getElementById('lessonText').value = lesson.content || lesson.text || '';
  document.getElementById('lessonDelay').value = lesson.delay_hours || 0;
  document.getElementById('lessonVideoFileId').value = lesson.video_file_id || '';
  document.getElementById('lessonVideoNoteFileId').value = lesson.video_note_file_id || '';
  document.getElementById('lessonAudioFileId').value = lesson.audio_file_id || '';
  document.getElementById('lessonDocumentFileId').value = lesson.document_file_id || '';
  document.getElementById('lessonPhotoFileId').value = lesson.photo_file_id || '';
  openModal('lessonModal');
}

document.getElementById('lessonForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('lessonId').value;
  const data = {
    lesson_number: parseInt(document.getElementById('lessonNumber').value),
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonText').value,
    delay_hours: parseInt(document.getElementById('lessonDelay').value) || 0,
    video_file_id: document.getElementById('lessonVideoFileId').value || null,
    video_note_file_id: document.getElementById('lessonVideoNoteFileId').value || null,
    audio_file_id: document.getElementById('lessonAudioFileId').value || null,
    document_file_id: document.getElementById('lessonDocumentFileId').value || null,
    photo_file_id: document.getElementById('lessonPhotoFileId').value || null
  };

  try {
    const url = id ? '/api/lessons/' + id : '/api/lessons';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('lessonModal');
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteLesson(id) {
  if (!confirm('Darsni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/lessons/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== CUSTDEV ==========
function openCustDevModal() {
  document.getElementById('custdevModalTitle').textContent = 'üìù Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevAfterLesson').value = 1;
  document.getElementById('custdevQuestion').value = '';
  document.getElementById('custdevType').value = 'text';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevFieldName').value = '';
  document.getElementById('custdevOptionsDiv').classList.add('hidden');
  openModal('custdevModal');
}

function editCustDev(id) {
  const q = allCustDev.find(c => c.id === id);
  if (!q) return;

  document.getElementById('custdevModalTitle').textContent = '‚úèÔ∏è Savolni tahrirlash';
  document.getElementById('custdevId').value = q.id;
  document.getElementById('custdevAfterLesson').value = q.after_lesson;
  document.getElementById('custdevQuestion').value = q.question_text;
  document.getElementById('custdevType').value = q.question_type;
  document.getElementById('custdevOptions').value = q.options ? q.options.join('\n') : '';
  document.getElementById('custdevFieldName').value = q.field_name || '';
  toggleCustdevOptions();
  openModal('custdevModal');
}

function toggleCustdevOptions() {
  const type = document.getElementById('custdevType').value;
  document.getElementById('custdevOptionsDiv').classList.toggle('hidden', type !== 'buttons');
}

document.getElementById('custdevForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('custdevId').value;
  const type = document.getElementById('custdevType').value;
  const optionsText = document.getElementById('custdevOptions').value;

  const data = {
    after_lesson: parseInt(document.getElementById('custdevAfterLesson').value),
    question_text: document.getElementById('custdevQuestion').value,
    question_type: type,
    options: type === 'buttons' ? optionsText.split('\n').filter(o => o.trim()) : null,
    field_name: document.getElementById('custdevFieldName').value || null
  };

  try {
    const url = id ? '/api/custdev/' + id : '/api/custdev';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('custdevModal');
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteCustDev(id) {
  if (!confirm('Savolni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/custdev/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

async function openQuestionStats(questionId) {
  const question = allCustDev.find(q => q.id === questionId);
  if (!question) return;

  document.getElementById('custdevStatsTitle').textContent = 'üìä ' + question.question_text.substring(0, 50) + '...';

  // Get answers for this question
  const answers = custdevAnswers[questionId] || [];

  // Count answers
  const answerCounts = {};
  answers.forEach(a => {
    const value = a.answer_text || 'Boshqa';
    answerCounts[value] = (answerCounts[value] || 0) + 1;
  });

  const labels = Object.keys(answerCounts);
  const values = Object.values(answerCounts);
  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Render chart
  const ctx = document.getElementById('questionStatsChart')?.getContext('2d');
  if (ctx) {
    if (questionStatsChart) questionStatsChart.destroy();

    questionStatsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // Render answers list
  const listContainer = document.getElementById('questionAnswersList');
  listContainer.innerHTML = labels.map((label, i) => `
    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full" style="background: ${colors[i % colors.length]}"></span>
        <span class="font-medium">${label}</span>
      </div>
      <span class="text-gray-600">${values[i]} (${Math.round(values[i] / answers.length * 100)}%)</span>
    </div>
  `).join('') || '<p class="text-gray-400">Javoblar yo\'q</p>';

  openModal('custdevStatsModal');
}

// ========== PROGREV SETTINGS ==========
async function saveProgrevSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pitch_after_lesson: parseInt(document.getElementById('pitchAfterLesson').value) || 4,
        pitch_delay_minutes: parseInt(document.getElementById('pitchDelayMinutes').value) || 0,
        pitch_text: document.getElementById('pitchText').value,
        pitch_media_type: document.getElementById('pitchMediaType').value,
        // Only send the file ID for the selected media type, clear others
        pitch_video_file_id: document.getElementById('pitchMediaType').value === 'video' ? document.getElementById('pitchVideoFileId').value : null,
        pitch_audio_file_id: document.getElementById('pitchMediaType').value === 'audio' ? document.getElementById('pitchAudioFileId').value : null,
        pitch_image_file_id: document.getElementById('pitchMediaType').value === 'image' ? document.getElementById('pitchImageFileId').value : null,
        pitch_video_note_file_id: document.getElementById('pitchMediaType').value === 'video_note' ? document.getElementById('pitchVideoNoteFileId').value : null,
        sales_delay_minutes: parseInt(document.getElementById('salesDelayMinutes').value) || 0,
        sales_pitch: document.getElementById('salesPitchText').value,
        soft_attack_disabled: document.getElementById('softAttackDisabled').checked,
        soft_attack_delay_minutes: parseInt(document.getElementById('softAttackDelayMinutes').value) || 1440,
        soft_attack_text: document.getElementById('softAttackText').value,
        congrats_text: document.getElementById('congratsText').value,
        // Lesson completion defaults
        watched_message_default: document.getElementById('watchedMessageDefault').value,
        watched_button_default: document.getElementById('watchedButtonDefault').value,
        // Feedback flow settings
        feedback_enabled: document.getElementById('feedbackEnabled').checked,
        feedback_question: document.getElementById('feedbackQuestion').value,
        feedback_yes_btn: document.getElementById('feedbackYesBtn').value,
        feedback_no_btn: document.getElementById('feedbackNoBtn').value,
        feedback_yes_response: document.getElementById('feedbackYesResponse').value,
        feedback_no_response: document.getElementById('feedbackNoResponse').value,
        feedback_no_sales_delay: parseInt(document.getElementById('feedbackNoSalesDelay').value) || 30,
        feedback_followup: document.getElementById('feedbackFollowup').value,
        feedback_followup_show_prices: document.getElementById('feedbackFollowupShowPrices').checked,
        feedback_special_offer: document.getElementById('feedbackSpecialOffer').value,
        feedback_special_offer_enabled: document.getElementById('feedbackSpecialOfferEnabled').checked
      })
    });

    alert('‚úÖ Progrev sozlamalari saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== SETTINGS ==========
async function saveSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        premium_channel_id: document.getElementById('settingPremiumChannel').value,
        free_channel_id: document.getElementById('settingFreeChannel').value,
        free_channel_link: document.getElementById('settingFreeChannelLink').value,
        require_subscription_before_lesson: parseInt(document.getElementById('settingRequireSub').value) || 0,
        payme_enabled: document.getElementById('settingPayme').checked,
        click_enabled: document.getElementById('settingClick').checked,
        price_1m: parseInt(document.getElementById('settingPrice1m').value) * 100 || null,
        price_3m: parseInt(document.getElementById('settingPrice3m').value) * 100 || null,
        price_6m: parseInt(document.getElementById('settingPrice6m').value) * 100 || null,
        price_12m: parseInt(document.getElementById('settingPrice12m').value) * 100 || null
      })
    });

    alert('‚úÖ Sozlamalar saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== HELPERS ==========
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const now = new Date();
  const date = new Date(dateStr);
  const seconds = Math.floor((now - date) / 1000);

  if (seconds < 60) return 'hozirgina';
  if (seconds < 3600) return Math.floor(seconds / 60) + ' daqiqa oldin';
  if (seconds < 86400) return Math.floor(seconds / 3600) + ' soat oldin';
  if (seconds < 604800) return Math.floor(seconds / 86400) + ' kun oldin';
  return fmtDate(dateStr);
}

function fmtMoney(tiyin) {
  const som = Math.round(tiyin / 100);
  return som.toLocaleString('uz-UZ') + ' so\'m';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
}

function fmtDateTime(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}
</script>

</body>
</html>
