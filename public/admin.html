<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { background: #f5f6fa; min-height: 100vh; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #ccc; }

    /* Sidebar */
    .sidebar { width: 70px; background: #fff; border-right: 1px solid #eee; }
    .sidebar-item { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: all 0.2s; cursor: pointer; font-size: 20px; }
    .sidebar-item:hover { background: #f3f4f6; color: #6366f1; }
    .sidebar-item.active { background: #eef2ff; color: #6366f1; }

    /* Cards */
    .card { background: #fff; border-radius: 16px; border: 1px solid #f0f0f0; }
    .card-hover:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.05); transform: translateY(-2px); transition: all 0.2s; }

    /* Stat card with icon */
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

    /* Table */
    .table-row { border-bottom: 1px solid #f5f5f5; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover { background: #fafafa; }

    /* Badge */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-blue { background: #dbeafe; color: #2563eb; }
    .badge-orange { background: #ffedd5; color: #ea580c; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }

    /* Button */
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .btn-primary { background: #6366f1; color: #fff; }
    .btn-primary:hover { background: #4f46e5; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e5e7eb; }

    /* Input */
    .input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s; }
    .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }

    /* Modal */
    .modal-overlay { background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); }
    .modal-content { background: #fff; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }

    /* Activity item */
    .activity-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }

    /* Tab */
    .tab { padding: 8px 16px; border-radius: 8px; font-weight: 500; color: #6b7280; cursor: pointer; transition: all 0.2s; }
    .tab:hover { background: #f3f4f6; }
    .tab.active { background: #6366f1; color: #fff; }

    /* Chart container */
    .chart-container { position: relative; height: 200px; }

    /* Hide scrollbar for mobile nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile bottom nav */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0 !important; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none; }
    }
    .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #eee; padding: 8px 16px; z-index: 50; }
    .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px; border-radius: 10px; color: #9ca3af; font-size: 10px; }
    .mobile-nav-item.active { color: #6366f1; background: #eef2ff; }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 z-50">
  <div class="card p-8 w-full max-w-sm mx-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <span class="text-3xl">ğŸš€</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
      <p class="text-gray-500 text-sm mt-1">Tizimga kirish</p>
    </div>
    <form id="loginForm">
      <input type="text" id="username" class="input mb-3" placeholder="Login" required>
      <input type="password" id="password" class="input mb-4" placeholder="Parol" required>
      <button type="submit" class="btn btn-primary w-full">Kirish</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden">Login yoki parol xato</p>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden flex min-h-screen">

  <!-- Left Sidebar -->
  <aside class="sidebar fixed left-0 top-0 bottom-0 flex flex-col items-center py-6 z-40">
    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg font-bold mb-8">F</div>

    <nav class="flex flex-col gap-2 flex-1">
      <div class="sidebar-item active" data-tab="overview" title="Umumiy">ğŸ“Š</div>
      <div class="sidebar-item" data-tab="users" title="Foydalanuvchilar">ğŸ‘¥</div>
      <div class="sidebar-item" data-tab="payments" title="To'lovlar">ğŸ’³</div>
      <div class="sidebar-item" data-tab="lessons" title="Darslar">ğŸ“š</div>
      <div class="sidebar-item" data-tab="custdev" title="CustDev">ğŸ“</div>
      <div class="sidebar-item" data-tab="settings" title="Sozlamalar">âš™ï¸</div>
    </nav>

    <div class="sidebar-item text-red-400" onclick="logout()" title="Chiqish">ğŸšª</div>
  </aside>

  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="overview"><span class="text-lg">ğŸ“Š</span>Umumiy</div>
    <div class="mobile-nav-item" data-tab="users"><span class="text-lg">ğŸ‘¥</span>Userlar</div>
    <div class="mobile-nav-item" data-tab="payments"><span class="text-lg">ğŸ’³</span>To'lov</div>
    <div class="mobile-nav-item" data-tab="lessons"><span class="text-lg">ğŸ“š</span>Darslar</div>
    <div class="mobile-nav-item" data-tab="settings"><span class="text-lg">âš™ï¸</span>Sozlama</div>
  </nav>

  <!-- Main Content -->
  <main class="main-content flex-1 ml-[70px] p-6 pb-24 md:pb-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <p class="text-gray-500 text-sm" id="currentDate"></p>
      </div>
      <div class="flex gap-3">
        <button onclick="openBroadcastModal()" class="btn btn-primary flex items-center gap-2">
          <span>ğŸ“¨</span> Xabar yuborish
        </button>
        <button onclick="loadAll()" class="btn btn-secondary">ğŸ”„</button>
      </div>
    </header>

    <!-- Overview Tab -->
    <div id="tab-overview">

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5 card-hover">
          <div class="flex items-center gap-4">
            <div class="stat-icon bg-indigo-100">ğŸ‘¥</div>
            <div>
              <p class="text-gray-500 text-sm">Jami userlar</p>
              <p class="text-2xl font-bold text-gray-800" id="statTotalUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover">
          <div class="flex items-center gap-4">
            <div class="stat-icon bg-green-100">ğŸ’</div>
            <div>
              <p class="text-gray-500 text-sm">To'lagan</p>
              <p class="text-2xl font-bold text-green-600" id="statPaidUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover">
          <div class="flex items-center gap-4">
            <div class="stat-icon bg-blue-100">ğŸ’°</div>
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-2xl font-bold text-blue-600" id="statRevenue">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover">
          <div class="flex items-center gap-4">
            <div class="stat-icon bg-orange-100">ğŸ“ˆ</div>
            <div>
              <p class="text-gray-500 text-sm">Konversiya</p>
              <p class="text-2xl font-bold text-orange-600" id="statConversion">0%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="card p-5 lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-3xl font-bold text-gray-800" id="totalRevenueDisplay">0 so'm</p>
            </div>
            <div class="flex gap-2">
              <button class="tab active" data-period="week">Hafta</button>
              <button class="tab" data-period="month">Oy</button>
              <button class="tab" data-period="year">Yil</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <!-- User Types -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">Foydalanuvchilar</h3>
          <div class="chart-container h-[180px]">
            <canvas id="userTypeChart"></canvas>
          </div>
          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Aktiv</span>
              <span class="font-medium" id="activeUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> To'lagan</span>
              <span class="font-medium" id="paidUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span> Tugatgan</span>
              <span class="font-medium" id="completedUsersCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Recent Users -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi foydalanuvchilar</h3>
            <button onclick="showTab('users')" class="text-indigo-600 text-sm font-medium">Barchasi â†’</button>
          </div>
          <div id="recentUsersList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Recent Payments -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi to'lovlar</h3>
            <button onclick="showTab('payments')" class="text-indigo-600 text-sm font-medium">Barchasi â†’</button>
          </div>
          <div id="recentPaymentsList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

      </div>

    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between gap-4">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ‘¥ Foydalanuvchilar</h3>
          <div class="flex gap-2">
            <select id="userStatusFilter" class="input py-2 px-3 w-auto" onchange="loadUsers()">
              <option value="all">Barchasi</option>
              <option value="active">Aktiv</option>
              <option value="paid">To'lagan</option>
              <option value="completed">Tugatgan</option>
            </select>
            <input type="text" id="userSearch" class="input py-2 px-3 w-48" placeholder="ğŸ” Qidirish..." oninput="searchUsers()">
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dars</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="5" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-100 flex justify-center gap-2" id="usersPagination"></div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="tab-payments" class="hidden">
      <!-- Payment Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Bugun</p>
          <p class="text-2xl font-bold text-green-600" id="payToday">0</p>
          <p class="text-xs text-gray-400" id="payTodayCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Hafta</p>
          <p class="text-2xl font-bold text-blue-600" id="payWeek">0</p>
          <p class="text-xs text-gray-400" id="payWeekCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Oy</p>
          <p class="text-2xl font-bold text-indigo-600" id="payMonth">0</p>
          <p class="text-xs text-gray-400" id="payMonthCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami</p>
          <p class="text-2xl font-bold text-gray-800" id="payTotal">0</p>
          <p class="text-xs text-gray-400" id="payTotalCount">0 ta</p>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ’³ To'lovlar tarixi</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summa</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reja</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tizim</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="5" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lessons Tab -->
    <div id="tab-lessons" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ“š Darslar</h3>
          <button onclick="openLessonModal()" class="btn btn-primary">+ Yangi dars</button>
        </div>
        <div id="lessonsList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- Lesson Progress Stats -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">ğŸ“Š Darslar bo'yicha statistika</h3>
        <div id="lessonProgressStats" class="space-y-3">
          <p class="text-gray-400 text-center">Yuklanmoqda...</p>
        </div>
      </div>
    </div>

    <!-- CustDev Tab -->
    <div id="tab-custdev" class="hidden">
      <!-- CustDev Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5 chart-container h-[150px]">
          <p class="text-gray-500 text-sm mb-2">Yosh</p>
          <canvas id="ageChart"></canvas>
        </div>
        <div class="card p-5 chart-container h-[150px]">
          <p class="text-gray-500 text-sm mb-2">Kasb</p>
          <canvas id="occupationChart"></canvas>
        </div>
        <div class="card p-5 chart-container h-[150px]">
          <p class="text-gray-500 text-sm mb-2">Daromad</p>
          <canvas id="incomeChart"></canvas>
        </div>
        <div class="card p-5 chart-container h-[150px]">
          <p class="text-gray-500 text-sm mb-2">Byudjet</p>
          <canvas id="budgetChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ“ CustDev savollari</h3>
          <button onclick="openCustDevModal()" class="btn btn-primary">+ Yangi savol</button>
        </div>
        <div id="custdevList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Channel Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ“¢ Kanal sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Premium kanal ID</label>
              <input type="text" id="settingPremiumChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal ID</label>
              <input type="text" id="settingFreeChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal linki</label>
              <input type="text" id="settingFreeChannelLink" class="input" placeholder="https://t.me/channel">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Obuna talab qilinadigan dars</label>
              <input type="number" id="settingRequireSub" class="input" value="0" min="0">
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ’° Narxlar (so'm)</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1 oylik</label>
              <input type="number" id="settingPrice1m" class="input" placeholder="97000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">3 oylik</label>
              <input type="number" id="settingPrice3m" class="input" placeholder="247000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">6 oylik</label>
              <input type="number" id="settingPrice6m" class="input" placeholder="447000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">12 oylik</label>
              <input type="number" id="settingPrice12m" class="input" placeholder="797000">
            </div>
          </div>
        </div>

        <!-- Pitch Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ¬ Pitch sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
              <input type="number" id="settingPitchAfter" class="input" value="4" min="1">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Pitch matni</label>
              <textarea id="settingPitchText" class="input h-24 resize-none" placeholder="Maxsus taklif matni..."></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Pitch delay (daqiqa)</label>
              <input type="number" id="settingPitchDelay" class="input" value="120" min="0">
            </div>
          </div>
        </div>

        <!-- Payment Systems -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ’³ To'lov tizimlari</h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingPayme" class="w-5 h-5 accent-blue-600" checked>
              <span class="text-lg">ğŸ’³</span>
              <span class="font-medium">Payme</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingClick" class="w-5 h-5 accent-green-600" checked>
              <span class="text-lg">ğŸ’ </span>
              <span class="font-medium">Click</span>
            </label>
          </div>
        </div>

      </div>

      <button onclick="saveSettings()" class="btn btn-primary mt-6 w-full lg:w-auto">ğŸ’¾ Sozlamalarni saqlash</button>
    </div>

  </main>

  <!-- Right Panel (Desktop only) -->
  <aside class="right-panel hidden lg:block w-80 p-6 border-l border-gray-200 bg-white">

    <!-- Stats Card -->
    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white mb-6">
      <p class="text-indigo-200 text-sm mb-1">Umumiy daromad</p>
      <p class="text-3xl font-bold mb-4" id="rightPanelRevenue">0 so'm</p>
      <div class="flex justify-between text-sm">
        <span class="text-indigo-200">Bu oy</span>
        <span class="font-medium" id="rightPanelMonthRevenue">0</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
      <h3 class="font-semibold text-gray-800 mb-4">So'nggi faoliyat</h3>
      <div id="recentActivity" class="space-y-3">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Lesson Progress -->
    <div>
      <h3 class="font-semibold text-gray-800 mb-4">Darslar progress</h3>
      <div id="lessonProgressPanel" class="space-y-3">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

  </aside>

</div>

<!-- Broadcast Modal -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">ğŸ“¨ Xabar yuborish</h3>
      <button onclick="closeModal('broadcastModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Kimga</label>
        <select id="broadcastTarget" class="input">
          <option value="all">Hammaga</option>
          <option value="paid">To'laganlarga</option>
          <option value="free">To'lamaganlarga</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Xabar matni</label>
        <textarea id="broadcastText" class="input h-32 resize-none" placeholder="Xabar yozing..."></textarea>
      </div>
      <button onclick="sendBroadcast()" class="btn btn-primary w-full">Yuborish</button>
    </div>
  </div>
</div>

<!-- Lesson Modal -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="lessonModalTitle">ğŸ“š Yangi dars</h3>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <form id="lessonForm" class="space-y-4">
      <input type="hidden" id="lessonId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Dars raqami</label>
        <input type="number" id="lessonNumber" class="input" required min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Sarlavha</label>
        <input type="text" id="lessonTitle" class="input" required>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Matn</label>
        <textarea id="lessonText" class="input h-32 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Delay (soat)</label>
        <input type="number" id="lessonDelay" class="input" value="24" min="0">
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevModalTitle">ğŸ“ Yangi savol</h3>
      <button onclick="closeModal('custdevModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <form id="custdevForm" class="space-y-4">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
        <input type="number" id="custdevAfterLesson" class="input" value="1" min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
        <textarea id="custdevQuestion" class="input h-24 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Javob turi</label>
        <select id="custdevType" class="input" onchange="toggleCustdevOptions()">
          <option value="text">Matn (yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      <div id="custdevOptionsDiv" class="hidden">
        <label class="text-sm text-gray-600 mb-1 block">Variantlar (har qator - bitta)</label>
        <textarea id="custdevOptions" class="input h-24 resize-none font-mono" placeholder="18-25&#10;26-35&#10;36-45"></textarea>
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let auth = '';
let allUsers = [];
let allPayments = [];
let allLessons = [];
let allCustDev = [];
let currentPage = 1;
const perPage = 20;

// Charts
let revenueChart, userTypeChart;
let ageChart, occupationChart, incomeChart, budgetChart;

// ========== INITIALIZATION ==========
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('uz-UZ', {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
});

const saved = localStorage.getItem('adminAuth');
if (saved) { auth = saved; showDashboard(); }

// Login
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', { headers: { Authorization: auth } });
    if (r.ok) { localStorage.setItem('adminAuth', auth); showDashboard(); }
    else document.getElementById('loginError').classList.remove('hidden');
  } catch(e) { document.getElementById('loginError').classList.remove('hidden'); }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadAll();
}

function logout() {
  localStorage.removeItem('adminAuth');
  location.reload();
}

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.sidebar-item[data-tab], .mobile-nav-item[data-tab]').forEach(item => {
  item.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

function showTab(tab) {
  // Hide all tabs
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');

  // Update sidebar
  document.querySelectorAll('.sidebar-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.sidebar-item[data-tab="' + tab + '"]')?.classList.add('active');

  // Update mobile nav
  document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.mobile-nav-item[data-tab="' + tab + '"]')?.classList.add('active');
}

// ========== LOAD DATA ==========
async function loadAll() {
  await Promise.all([loadStats(), loadUsers(), loadPayments(), loadLessons(), loadCustDev()]);
  renderCharts();
}

async function loadStats() {
  try {
    const stats = await (await fetch('/api/stats', { headers: { Authorization: auth } })).json();

    // Main stats
    document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('statPaidUsers').textContent = stats.paidUsers || 0;
    document.getElementById('statRevenue').textContent = fmtMoney(stats.totalRevenue || 0);

    const conv = stats.totalUsers > 0 ? Math.round((stats.paidUsers / stats.totalUsers) * 100) : 0;
    document.getElementById('statConversion').textContent = conv + '%';

    // Right panel
    document.getElementById('rightPanelRevenue').textContent = fmtMoney(stats.totalRevenue || 0);
    document.getElementById('rightPanelMonthRevenue').textContent = fmtMoney(stats.monthRevenue || 0);
    document.getElementById('totalRevenueDisplay').textContent = fmtMoney(stats.totalRevenue || 0);

    // User type counts
    document.getElementById('activeUsersCount').textContent = stats.activeUsers || 0;
    document.getElementById('paidUsersCount').textContent = stats.paidUsers || 0;
    document.getElementById('completedUsersCount').textContent = stats.completedUsers || 0;

  } catch(e) { console.error('loadStats error:', e); }
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users', { headers: { Authorization: auth } })).json();
    allUsers = data;
    renderUsers();
    renderRecentUsers();
    renderRecentActivity();
  } catch(e) { console.error('loadUsers error:', e); }
}

async function loadPayments() {
  try {
    const data = await (await fetch('/api/payments', { headers: { Authorization: auth } })).json();
    allPayments = data;
    renderPayments();
    renderRecentPayments();
    renderPaymentStats();
  } catch(e) { console.error('loadPayments error:', e); }
}

async function loadLessons() {
  try {
    const data = await (await fetch('/api/lessons', { headers: { Authorization: auth } })).json();
    allLessons = data.sort((a, b) => a.lesson_number - b.lesson_number);
    renderLessons();
    renderLessonProgress();
  } catch(e) { console.error('loadLessons error:', e); }
}

async function loadCustDev() {
  try {
    const data = await (await fetch('/api/custdev', { headers: { Authorization: auth } })).json();
    allCustDev = data;
    renderCustDev();
  } catch(e) { console.error('loadCustDev error:', e); }
}

// ========== RENDER FUNCTIONS ==========
function renderUsers() {
  const filter = document.getElementById('userStatusFilter').value;
  let filtered = allUsers;

  if (filter === 'active') filtered = allUsers.filter(u => !u.is_paid && u.current_lesson > 0);
  else if (filter === 'paid') filtered = allUsers.filter(u => u.is_paid);
  else if (filter === 'completed') filtered = allUsers.filter(u => u.lessons_completed);

  const start = (currentPage - 1) * perPage;
  const paginated = filtered.slice(start, start + perPage);

  const tbody = document.getElementById('usersTableBody');
  if (!paginated.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-gray-400">Foydalanuvchilar topilmadi</td></tr>';
    return;
  }

  tbody.innerHTML = paginated.map(u => `
    <tr class="table-row">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.first_name || 'U').charAt(0)}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.first_name || ''} ${u.last_name || ''}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">ğŸ’ Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
    </tr>
  `).join('');

  // Pagination
  const totalPages = Math.ceil(filtered.length / perPage);
  const pagination = document.getElementById('usersPagination');
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHtml = '';
  for (let i = 1; i <= totalPages; i++) {
    paginationHtml += `<button onclick="goToPage(${i})" class="w-10 h-10 rounded-lg ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'}">${i}</button>`;
  }
  pagination.innerHTML = paginationHtml;
}

function goToPage(page) {
  currentPage = page;
  renderUsers();
}

function searchUsers() {
  const query = document.getElementById('userSearch').value.toLowerCase();
  if (!query) { renderUsers(); return; }

  const filtered = allUsers.filter(u =>
    (u.first_name || '').toLowerCase().includes(query) ||
    (u.last_name || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query)
  );

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = filtered.slice(0, 20).map(u => `
    <tr class="table-row">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.first_name || 'U').charAt(0)}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.first_name || ''} ${u.last_name || ''}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">ğŸ’ Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
    </tr>
  `).join('');
}

function renderRecentUsers() {
  const recent = allUsers.slice(0, 5);
  const container = document.getElementById('recentUsersList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">Foydalanuvchilar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(u => `
    <div class="flex items-center gap-3 p-4">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
        ${(u.first_name || 'U').charAt(0)}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${u.first_name || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${u.current_lesson || 0}-dars</p>
      </div>
      ${u.is_paid ? '<span class="badge badge-green">ğŸ’</span>' : ''}
    </div>
  `).join('');
}

function renderPayments() {
  const tbody = document.getElementById('paymentsTableBody');

  if (!allPayments.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = allPayments.slice(0, 50).map(p => `
    <tr class="table-row">
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(p.created_at)}</td>
      <td class="px-5 py-4">
        <p class="font-medium text-gray-800">${p.first_name || ''} ${p.last_name || ''}</p>
      </td>
      <td class="px-5 py-4 font-semibold text-green-600">${fmtMoney(p.amount)}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${p.plan || '-'}</span></td>
      <td class="px-5 py-4 text-gray-500">${p.payment_system || '-'}</td>
    </tr>
  `).join('');
}

function renderRecentPayments() {
  const recent = allPayments.slice(0, 5);
  const container = document.getElementById('recentPaymentsList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">To\'lovlar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(p => `
    <div class="flex items-center gap-3 p-4">
      <div class="activity-icon bg-green-100 text-green-600">ğŸ’°</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${p.first_name || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${fmtDate(p.created_at)}</p>
      </div>
      <p class="font-semibold text-green-600">${fmtMoney(p.amount)}</p>
    </div>
  `).join('');
}

function renderPaymentStats() {
  const now = new Date();
  const today = allPayments.filter(p => new Date(p.created_at).toDateString() === now.toDateString());
  const week = allPayments.filter(p => (now - new Date(p.created_at)) < 7 * 24 * 60 * 60 * 1000);
  const month = allPayments.filter(p => (now - new Date(p.created_at)) < 30 * 24 * 60 * 60 * 1000);

  const sum = arr => arr.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('payToday').textContent = fmtMoney(sum(today));
  document.getElementById('payTodayCount').textContent = today.length + ' ta';
  document.getElementById('payWeek').textContent = fmtMoney(sum(week));
  document.getElementById('payWeekCount').textContent = week.length + ' ta';
  document.getElementById('payMonth').textContent = fmtMoney(sum(month));
  document.getElementById('payMonthCount').textContent = month.length + ' ta';
  document.getElementById('payTotal').textContent = fmtMoney(sum(allPayments));
  document.getElementById('payTotalCount').textContent = allPayments.length + ' ta';
}

function renderLessons() {
  const container = document.getElementById('lessonsList');

  if (!allLessons.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Darslar yo\'q. Yangi dars qo\'shing!</div>';
    return;
  }

  container.innerHTML = allLessons.map(l => `
    <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
      <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
        ${l.lesson_number}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${l.title}</p>
        <p class="text-sm text-gray-400">${l.delay_hours || 0} soat keyin yuboriladi</p>
      </div>
      <button onclick="editLesson(${l.id})" class="btn btn-secondary text-sm">âœï¸</button>
      <button onclick="deleteLesson(${l.id})" class="btn bg-red-50 text-red-600 text-sm">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

function renderLessonProgress() {
  // Users by lesson
  const lessonCounts = {};
  allUsers.forEach(u => {
    const lesson = u.current_lesson || 0;
    lessonCounts[lesson] = (lessonCounts[lesson] || 0) + 1;
  });

  const maxUsers = Math.max(...Object.values(lessonCounts), 1);

  // Progress stats
  const statsContainer = document.getElementById('lessonProgressStats');
  const panelContainer = document.getElementById('lessonProgressPanel');

  const html = allLessons.slice(0, 10).map(l => {
    const count = lessonCounts[l.lesson_number] || 0;
    const pct = Math.round((count / maxUsers) * 100);
    return `
      <div class="flex items-center gap-3">
        <span class="w-16 text-sm text-gray-600">${l.lesson_number}-dars</span>
        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-indigo-500 rounded-full" style="width: ${pct}%"></div>
        </div>
        <span class="w-12 text-sm text-gray-600 text-right">${count}</span>
      </div>
    `;
  }).join('');

  statsContainer.innerHTML = html || '<p class="text-gray-400 text-center">Ma\'lumot yo\'q</p>';
  panelContainer.innerHTML = html || '<p class="text-gray-400 text-center text-sm">Ma\'lumot yo\'q</p>';
}

function renderCustDev() {
  const container = document.getElementById('custdevList');

  if (!allCustDev.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Savollar yo\'q. Yangi savol qo\'shing!</div>';
    return;
  }

  container.innerHTML = allCustDev.map(q => `
    <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
      <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
        ${q.after_lesson}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${q.question_text}</p>
        <p class="text-sm text-gray-400">${q.question_type === 'buttons' ? 'Tugmalar' : 'Matn'} â€¢ ${q.answer_count || 0} javob</p>
      </div>
      <button onclick="editCustDev(${q.id})" class="btn btn-secondary text-sm">âœï¸</button>
      <button onclick="deleteCustDev(${q.id})" class="btn bg-red-50 text-red-600 text-sm">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');

  // Combine users and payments, sort by date
  const activities = [
    ...allUsers.slice(0, 5).map(u => ({ type: 'user', data: u, date: new Date(u.created_at) })),
    ...allPayments.slice(0, 5).map(p => ({ type: 'payment', data: p, date: new Date(p.created_at) }))
  ].sort((a, b) => b.date - a.date).slice(0, 5);

  if (!activities.length) {
    container.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">Faoliyat yo\'q</div>';
    return;
  }

  container.innerHTML = activities.map(a => {
    if (a.type === 'user') {
      return `
        <div class="flex items-center gap-3">
          <div class="activity-icon bg-blue-100 text-blue-600">ğŸ‘¤</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${a.data.first_name || 'Yangi user'}</p>
            <p class="text-xs text-gray-400">Qo'shildi</p>
          </div>
        </div>
      `;
    } else {
      return `
        <div class="flex items-center gap-3">
          <div class="activity-icon bg-green-100 text-green-600">ğŸ’°</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${a.data.first_name || 'To\'lov'}</p>
            <p class="text-xs text-gray-400">${fmtMoney(a.data.amount)}</p>
          </div>
        </div>
      `;
    }
  }).join('');
}

// ========== CHARTS ==========
function renderCharts() {
  renderRevenueChart();
  renderUserTypeChart();
  renderCustDevCharts();
}

function renderRevenueChart() {
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;

  // Group payments by month
  const monthlyData = {};
  const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];

  allPayments.forEach(p => {
    const date = new Date(p.created_at);
    const key = months[date.getMonth()];
    monthlyData[key] = (monthlyData[key] || 0) + (p.amount || 0);
  });

  const labels = months.slice(0, new Date().getMonth() + 1);
  const data = labels.map(m => (monthlyData[m] || 0) / 100);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: '#6366f1',
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { grid: { color: '#f3f4f6' }, ticks: { callback: v => v >= 1000 ? (v/1000) + 'K' : v } }
      }
    }
  });
}

function renderUserTypeChart() {
  const ctx = document.getElementById('userTypeChart')?.getContext('2d');
  if (!ctx) return;

  const active = allUsers.filter(u => !u.is_paid && !u.lessons_completed).length;
  const paid = allUsers.filter(u => u.is_paid).length;
  const completed = allUsers.filter(u => u.lessons_completed && !u.is_paid).length;

  if (userTypeChart) userTypeChart.destroy();

  userTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Aktiv', 'To\'lagan', 'Tugatgan'],
      datasets: [{
        data: [active, paid, completed],
        backgroundColor: ['#6366f1', '#22c55e', '#e5e7eb'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: { legend: { display: false } }
    }
  });
}

function renderCustDevCharts() {
  // Get CustDev answers and create charts
  const answers = {};
  allUsers.forEach(u => {
    if (u.custdev_answers) {
      try {
        const parsed = typeof u.custdev_answers === 'string' ? JSON.parse(u.custdev_answers) : u.custdev_answers;
        Object.entries(parsed).forEach(([key, value]) => {
          if (!answers[key]) answers[key] = {};
          answers[key][value] = (answers[key][value] || 0) + 1;
        });
      } catch(e) {}
    }
  });

  // Create mini pie charts for age, occupation, income, budget
  ['age', 'occupation', 'income', 'budget'].forEach(field => {
    const ctx = document.getElementById(field + 'Chart')?.getContext('2d');
    if (!ctx) return;

    const data = answers[field] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window[field + 'Chart']) window[field + 'Chart'].destroy();

    window[field + 'Chart'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { display: false } }
      }
    });
  });
}

// ========== MODALS ==========
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function openBroadcastModal() { openModal('broadcastModal'); }

async function sendBroadcast() {
  const target = document.getElementById('broadcastTarget').value;
  const text = document.getElementById('broadcastText').value;

  if (!text.trim()) { alert('Xabar matni bo\'sh'); return; }

  try {
    const res = await fetch('/api/broadcast', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({ target, text })
    });

    if (res.ok) {
      alert('âœ… Xabar yuborildi!');
      closeModal('broadcastModal');
      document.getElementById('broadcastText').value = '';
    } else {
      alert('Xatolik yuz berdi');
    }
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// Lessons
function openLessonModal() {
  document.getElementById('lessonModalTitle').textContent = 'ğŸ“š Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonNumber').value = allLessons.length + 1;
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonText').value = '';
  document.getElementById('lessonDelay').value = 24;
  openModal('lessonModal');
}

function editLesson(id) {
  const lesson = allLessons.find(l => l.id === id);
  if (!lesson) return;

  document.getElementById('lessonModalTitle').textContent = 'âœï¸ Darsni tahrirlash';
  document.getElementById('lessonId').value = lesson.id;
  document.getElementById('lessonNumber').value = lesson.lesson_number;
  document.getElementById('lessonTitle').value = lesson.title;
  document.getElementById('lessonText').value = lesson.text || '';
  document.getElementById('lessonDelay').value = lesson.delay_hours || 0;
  openModal('lessonModal');
}

document.getElementById('lessonForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('lessonId').value;
  const data = {
    lesson_number: parseInt(document.getElementById('lessonNumber').value),
    title: document.getElementById('lessonTitle').value,
    text: document.getElementById('lessonText').value,
    delay_hours: parseInt(document.getElementById('lessonDelay').value) || 0
  };

  try {
    const url = id ? '/api/lessons/' + id : '/api/lessons';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('lessonModal');
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteLesson(id) {
  if (!confirm('Darsni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/lessons/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// CustDev
function openCustDevModal() {
  document.getElementById('custdevModalTitle').textContent = 'ğŸ“ Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevAfterLesson').value = 1;
  document.getElementById('custdevQuestion').value = '';
  document.getElementById('custdevType').value = 'text';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevOptionsDiv').classList.add('hidden');
  openModal('custdevModal');
}

function editCustDev(id) {
  const q = allCustDev.find(c => c.id === id);
  if (!q) return;

  document.getElementById('custdevModalTitle').textContent = 'âœï¸ Savolni tahrirlash';
  document.getElementById('custdevId').value = q.id;
  document.getElementById('custdevAfterLesson').value = q.after_lesson;
  document.getElementById('custdevQuestion').value = q.question_text;
  document.getElementById('custdevType').value = q.question_type;
  document.getElementById('custdevOptions').value = q.options ? q.options.join('\n') : '';
  toggleCustdevOptions();
  openModal('custdevModal');
}

function toggleCustdevOptions() {
  const type = document.getElementById('custdevType').value;
  document.getElementById('custdevOptionsDiv').classList.toggle('hidden', type !== 'buttons');
}

document.getElementById('custdevForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('custdevId').value;
  const type = document.getElementById('custdevType').value;
  const optionsText = document.getElementById('custdevOptions').value;

  const data = {
    after_lesson: parseInt(document.getElementById('custdevAfterLesson').value),
    question_text: document.getElementById('custdevQuestion').value,
    question_type: type,
    options: type === 'buttons' ? optionsText.split('\n').filter(o => o.trim()) : null
  };

  try {
    const url = id ? '/api/custdev/' + id : '/api/custdev';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('custdevModal');
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteCustDev(id) {
  if (!confirm('Savolni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/custdev/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== SETTINGS ==========
async function saveSettings() {
  try {
    // Save channel settings
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        premium_channel_id: document.getElementById('settingPremiumChannel').value,
        free_channel_id: document.getElementById('settingFreeChannel').value,
        free_channel_link: document.getElementById('settingFreeChannelLink').value,
        require_subscription_before_lesson: parseInt(document.getElementById('settingRequireSub').value) || 0,
        payme_enabled: document.getElementById('settingPayme').checked,
        click_enabled: document.getElementById('settingClick').checked,
        price_1m: parseInt(document.getElementById('settingPrice1m').value) * 100 || null,
        price_3m: parseInt(document.getElementById('settingPrice3m').value) * 100 || null,
        price_6m: parseInt(document.getElementById('settingPrice6m').value) * 100 || null,
        price_12m: parseInt(document.getElementById('settingPrice12m').value) * 100 || null,
        pitch_after_lesson: parseInt(document.getElementById('settingPitchAfter').value) || 4,
        pitch_text: document.getElementById('settingPitchText').value,
        pitch_delay_minutes: parseInt(document.getElementById('settingPitchDelay').value) || 120
      })
    });

    alert('âœ… Sozlamalar saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== HELPERS ==========
function fmtMoney(tiyin) {
  const som = Math.round(tiyin / 100);
  return som.toLocaleString('uz-UZ') + ' so\'m';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
}
</script>

</body>
</html>
