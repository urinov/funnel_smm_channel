<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    :root {
      --glass-bg: rgba(255, 255, 255, 0.55);
      --glass-strong: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.35);
      --ink: #0b1220;
      --muted: #6b7280;
      --accent: #5b7cfa;
      --accent-2: #7e5cff;
      --accent-3: #12b981;
      --pill: rgba(255,255,255,0.7);
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.18);
      --shadow-soft: 0 12px 28px rgba(15, 23, 42, 0.12);
      --mobile-nav-h: 96px;
    }
    body {
      background:
        radial-gradient(800px 500px at 10% -10%, rgba(255,255,255,0.9) 0%, rgba(236,240,255,0.9) 45%, rgba(217,225,247,0.95) 100%),
        linear-gradient(135deg, #eaf0ff 0%, #f7f9ff 45%, #edf3ff 100%);
      min-height: 100vh;
      color: var(--ink);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }

    /* Sidebar - Collapsible */
    .sidebar { width: 70px; background: var(--glass-bg); border-right: 1px solid var(--glass-border); box-shadow: 8px 0 30px rgba(15,23,42,0.08); transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; backdrop-filter: blur(18px); }
    .sidebar.expanded { width: 200px; }
    .sidebar-item { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; font-size: 20px; gap: 12px; white-space: nowrap; }
    .sidebar.expanded .sidebar-item { width: 100%; justify-content: flex-start; padding: 0 16px; }
    .sidebar-item:hover { background: rgba(255,255,255,0.75); color: var(--accent); transform: translateY(-1px); box-shadow: 0 10px 18px rgba(15,23,42,0.10); }
    .sidebar-item.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #fff; box-shadow: 0 8px 20px rgba(91,124,250,0.35); }
    .sidebar-label { display: none; font-size: 13px; font-weight: 500; }
    .sidebar.expanded .sidebar-label { display: block; }
    .sidebar-toggle { width: 24px; height: 24px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 12px; }
    .sidebar-toggle:hover { background: #e5e7eb; }

    /* Cards */
    .card { background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--glass-border); box-shadow: var(--shadow-soft); transition: all 0.25s ease; backdrop-filter: blur(16px); }
    .card-hover:hover { box-shadow: 0 18px 40px rgba(15,23,42,0.16); transform: translateY(-4px); border-color: rgba(255,255,255,0.55); }
    .hero-card { position: relative; overflow: hidden; }
    .hero-card::after {
      content: '';
      position: absolute;
      inset: -40% -20% auto auto;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 60%);
      pointer-events: none;
    }

    /* Stat card with icon */
    .stat-icon { width: 52px; height: 52px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(15,23,42,0.12); background: rgba(255,255,255,0.75); }

    /* Table */
    .table-row { border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.15s ease; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover { background: linear-gradient(90deg, rgba(255,255,255,0.75) 0%, rgba(255,255,255,0.95) 100%); }

    /* Badge */
    .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
    .badge-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1d4ed8; }
    .badge-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #c2410c; }
    .badge-yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309; }
    .badge-red { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }
    .badge-purple { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); color: #7c3aed; }

    /* Button */
    .btn { padding: 10px 20px; border-radius: 14px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: 1px solid rgba(255,255,255,0.4); background: var(--glass-strong); backdrop-filter: blur(12px); }
    .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #fff; box-shadow: 0 14px 30px rgba(91,124,250,0.35); border: none; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 18px 34px rgba(91,124,250,0.45); }
    .btn-secondary { background: var(--glass-strong); color: #1f2937; border: 1px solid var(--glass-border); box-shadow: 0 10px 24px rgba(15,23,42,0.08); }
    .btn-secondary:hover { background: rgba(255,255,255,0.95); border-color: rgba(255,255,255,0.65); transform: translateY(-1px); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; box-shadow: 0 4px 14px rgba(239,68,68,0.35); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.45); }

    /* Input */
    .input { width: 100%; padding: 12px 16px; border: 1px solid rgba(255,255,255,0.55); border-radius: 16px; font-size: 14px; transition: all 0.2s; background: rgba(255,255,255,0.7); box-shadow: inset 0 1px 2px rgba(15,23,42,0.08); backdrop-filter: blur(10px); }
    .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99,102,241,0.1); background: #fff; }
    .input::placeholder { color: #9ca3af; }

    /* Modal */
    .modal-overlay { background: rgba(15,23,42,0.35); backdrop-filter: blur(16px); }
    .modal-content { background: var(--glass-strong); border-radius: 28px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 28px 60px rgba(15,23,42,0.25); border: 1px solid var(--glass-border); backdrop-filter: blur(18px); }
    .modal-lg { max-width: 800px; }

    /* Activity item */
    .activity-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

    /* Tab */
    .tab { padding: 10px 18px; border-radius: 999px; font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.25s ease; background: var(--pill); border: 1px solid rgba(255,255,255,0.6); backdrop-filter: blur(10px); }
    .tab:hover { background: rgba(255,255,255,0.95); color: #2f3644; transform: translateY(-1px); box-shadow: 0 10px 18px rgba(15,23,42,0.12); }
    .tab.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #fff; box-shadow: 0 12px 24px rgba(91,124,250,0.35); }

    /* Chart container */
    .chart-container { position: relative; height: 200px; }
    .chart-bleed { position: relative; }

    /* KPI cards */
    .kpi-card { position: relative; overflow: hidden; }
    .kpi-card::after {
      content: '';
      position: absolute;
      inset: auto -20% -40% auto;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(88,101,242,0.18) 0%, rgba(88,101,242,0) 70%);
      pointer-events: none;
    }
    .kpi-grid .kpi-card:nth-child(1) { border-color: rgba(88,101,242,0.18); }
    .kpi-grid .kpi-card:nth-child(2) { border-color: rgba(34,197,94,0.18); }
    .kpi-grid .kpi-card:nth-child(3) { border-color: rgba(14,165,233,0.18); }
    .kpi-grid .kpi-card:nth-child(4) { border-color: rgba(249,115,22,0.18); }
    .kpi-grid .kpi-card:nth-child(1) .stat-icon { background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); color: #4f46e5; }
    .kpi-grid .kpi-card:nth-child(2) .stat-icon { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #16a34a; }
    .kpi-grid .kpi-card:nth-child(3) .stat-icon { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); color: #0284c7; }
    .kpi-grid .kpi-card:nth-child(4) .stat-icon { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #ea580c; }

    /* Right panel (desktop) */
    .right-panel { background: rgba(255,255,255,0.45); border-left: 1px solid var(--glass-border); backdrop-filter: blur(18px); }
    .right-panel .card { border-radius: 22px; background: var(--glass-strong); }
    .right-panel .card:first-child { box-shadow: 0 22px 46px rgba(15,23,42,0.16); }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; }

    /* Hide scrollbar for mobile nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile bottom nav */
    @media (max-width: 900px) {
      body { overflow-x: hidden; }
      #dashboard { overflow-x: hidden; }
      #sidebar { display: none !important; }
      .main-content { margin-left: 0 !important; margin-right: 0 !important; padding: 12px !important; padding-bottom: 80px !important; max-width: 100vw; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none !important; }
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0 !important; padding: 12px !important; padding-bottom: 80px !important; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none; }

      /* Typography */
      h1 { font-size: 1.25rem !important; }
      h2 { font-size: 1.125rem !important; }
      h3 { font-size: 1rem !important; }

      /* Cards */
      .card { border-radius: 12px; }

      /* Stat cards */
      .stat-icon { width: 40px !important; height: 40px !important; font-size: 18px !important; }

      /* Buttons */
      .btn { padding: 8px 14px; font-size: 13px; }
      .btn-primary { padding: 10px 16px; }

      /* Inputs */
      .input { padding: 10px 12px; font-size: 14px; }

      /* Tables */
      .overflow-x-auto { -webkit-overflow-scrolling: touch; }

      /* Tab buttons */
      .tab { padding: 8px 12px; font-size: 12px; }

      /* Chart containers */
      .chart-container { height: 180px !important; }

      /* Modals */
      .modal-content { margin: 12px; border-radius: 16px; max-height: calc(100vh - 100px); }

      /* Grid adjustments */
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      .grid-cols-3 { grid-template-columns: 1fr !important; }
      .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }

      /* Stats row */
      .stats-grid { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }

      /* Flexbox adjustments */
      .flex-col-mobile { flex-direction: column !important; align-items: stretch !important; }

      /* Text sizes */
      .text-3xl { font-size: 1.5rem !important; }
      .text-2xl { font-size: 1.25rem !important; }

      /* Spacing */
      .gap-6 { gap: 12px !important; }
      .p-5 { padding: 12px !important; }
      .mb-6 { margin-bottom: 12px !important; }

      /* Mobile visual language */
      body { background: radial-gradient(700px 480px at 10% -10%, rgba(255,255,255,0.9) 0%, rgba(236,242,255,0.95) 60%, rgba(221,230,250,0.98) 100%); }
      .card { border-radius: 20px !important; box-shadow: 0 14px 30px rgba(15,23,42,0.12) !important; backdrop-filter: blur(16px); }
      .btn { border-radius: 16px !important; }
      .tab { border-radius: 999px !important; }
      .tab:active { transform: scale(0.98); }
      .btn:active { transform: scale(0.98); }
      .mobile-nav-item:active { transform: scale(0.96); }
      .btn-primary { box-shadow: 0 14px 26px rgba(91,124,250,0.38) !important; }
      .main-content > header { background: var(--glass-strong); border-radius: 20px; padding: 12px; box-shadow: 0 12px 24px rgba(15,23,42,0.12); border: 1px solid var(--glass-border); backdrop-filter: blur(14px); }
      .main-content > header .btn-primary { width: 100%; justify-content: center; }

      /* Charts full-bleed */
      .chart-bleed { width: calc(100% + 24px); margin-left: -12px; }
      .chart-bleed canvas { border-radius: 16px; }

      /* Tabs row */
      .tab-row { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap !important; }
      .tab-row::-webkit-scrollbar { display: none; }

      /* Responsive tables -> cards */
      .overflow-x-auto { overflow-x: visible; }
      table.responsive-table { width: 100%; }
      table.responsive-table thead { display: none; }
      table.responsive-table tbody { display: block; }
      table.responsive-table tbody tr { display: block; background: #fff; border: 1px solid rgba(15,23,42,0.08); border-radius: 14px; padding: 10px 12px; margin-bottom: 10px; box-shadow: 0 6px 16px rgba(15,23,42,0.06); }
      table.responsive-table tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 6px 0; border: none; }
      table.responsive-table tbody tr td::before {
        content: attr(data-label);
        font-size: 10px;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      table.responsive-table tbody tr td:last-child { justify-content: flex-end; }
      table.responsive-table tbody tr td:first-child { font-weight: 600; }
      table.responsive-table tbody tr td:first-child::before { display: none; }
      table.responsive-table tbody tr td .badge { font-size: 10px; padding: 4px 8px; }
      table.responsive-table tbody tr td button { border-radius: 10px; }

      /* Bottom spacing so content is readable above nav */
      .main-content {
        padding-bottom: calc(var(--mobile-nav-h) + 120px + env(safe-area-inset-bottom)) !important;
        scroll-padding-bottom: calc(var(--mobile-nav-h) + 120px + env(safe-area-inset-bottom));
      }
      .mobile-nav { padding-bottom: calc(8px + env(safe-area-inset-bottom)); }

      /* Modal readability above browser/nav bars */
      .modal-content { max-height: calc(100vh - 120px); padding-bottom: calc(120px + env(safe-area-inset-bottom)); }

      /* Section readability */
      .card { padding: 14px !important; }
      .card .text-gray-500 { color: #6b7280 !important; }
      .card .text-gray-400 { color: #94a3b8 !important; }
      .text-sm { font-size: 13px !important; }
      .text-xs { font-size: 11px !important; }

      /* Glass sections */
      .bg-gray-50 { background: rgba(255,255,255,0.6) !important; }
      .bg-white { background: rgba(255,255,255,0.75) !important; }
      .bg-indigo-50 { background: rgba(227,235,255,0.8) !important; }
      .bg-blue-50 { background: rgba(224,242,255,0.8) !important; }
      .bg-orange-50 { background: rgba(255,237,213,0.8) !important; }
      .bg-green-50 { background: rgba(220,252,231,0.8) !important; }

      /* Lists spacing */
      #recentUsersList > div,
      #recentPaymentsList > div,
      #lessonsList > div {
        padding: 12px !important;
      }

      /* Tabs row: larger touch targets */
      .tab { padding: 8px 14px !important; }

      /* Keep cards separated at the bottom */
      .mb-6 { margin-bottom: 16px !important; }
    }

    /* Small mobile screens */
    @media (max-width: 480px) {
      .main-content { padding: 8px !important; }
      .card { border-radius: 10px; }
      .stat-icon { width: 36px !important; height: 36px !important; font-size: 16px !important; border-radius: 10px !important; }
      .text-3xl { font-size: 1.25rem !important; }
      .text-2xl { font-size: 1.125rem !important; }
      .tab { padding: 6px 10px; font-size: 11px; }
      .btn { padding: 6px 10px; font-size: 12px; }
    }

    /* Tablet screens */
    @media (min-width: 769px) and (max-width: 1024px) {
      .right-panel { width: 240px !important; }
      .main-content { margin-right: 240px; }
    }

    /* Large screens */
    @media (min-width: 1280px) {
      .right-panel { width: 320px; }
    }

    .mobile-nav { display: none; position: fixed; bottom: 12px; left: 12px; right: 12px; height: var(--mobile-nav-h); background: rgba(255,255,255,0.7); border: 1px solid var(--glass-border); padding: 8px; z-index: 50; box-shadow: var(--shadow); border-radius: 22px; backdrop-filter: blur(18px); }
    .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px 6px; border-radius: 16px; color: #64748b; font-size: 10px; transition: all 0.2s; }
    .mobile-nav-item.active { color: #fff; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); box-shadow: 0 10px 20px rgba(91,124,250,0.35); }
    .mobile-nav-item:active { transform: scale(0.95); }

    /* File ID Input */
    .file-id-input { font-family: monospace; font-size: 12px; background: #f9fafb; }

    /* Funnel Visualization */
    .funnel-container { position: relative; }
    .funnel-step {
      position: relative;
      margin: 0 auto;
      padding: 8px 12px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .funnel-step:hover { transform: scale(1.02); }
    .funnel-step::before {
      content: '';
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      border-radius: 4px;
      z-index: -1;
    }
    .funnel-label { font-size: 11px; font-weight: 500; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .funnel-count { font-size: 14px; font-weight: 700; color: #fff; }
    .funnel-pct { font-size: 10px; color: rgba(255,255,255,0.8); }

    /* Conversations */
    .conv-users-list { max-height: 72vh; overflow-y: auto; }
    .conv-user-item { width: 100%; text-align: left; padding: 12px 14px; border-bottom: 1px solid rgba(15,23,42,0.06); transition: background 0.18s ease; }
    .conv-user-item:hover { background: rgba(255,255,255,0.75); }
    .conv-user-item.active { background: linear-gradient(90deg, rgba(91,124,250,0.13) 0%, rgba(91,124,250,0.04) 100%); border-left: 3px solid var(--accent); padding-left: 11px; }
    .conv-avatar { width: 38px; height: 38px; border-radius: 999px; background: linear-gradient(135deg, #dbe7ff 0%, #cdd9ff 100%); color: #3f5ee6; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
    .tg-chat-shell { border: 1px solid rgba(15,23,42,0.08); border-radius: 18px; overflow: hidden; background: rgba(255,255,255,0.7); }
    .tg-chat-head { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-bottom: 1px solid rgba(15,23,42,0.08); background: rgba(255,255,255,0.9); }
    .tg-chat-body { max-height: 72vh; overflow-y: auto; padding: 14px; background: radial-gradient(circle at 20% 10%, rgba(224,255,214,0.6) 0%, rgba(195,232,183,0.65) 50%, rgba(180,218,170,0.7) 100%); }
    .tg-bubble-row { display: flex; margin-bottom: 8px; }
    .tg-bubble-row.user { justify-content: flex-end; }
    .tg-bubble { max-width: 78%; border-radius: 18px; padding: 9px 12px 8px; box-shadow: 0 2px 8px rgba(15,23,42,0.08); word-break: break-word; background: #fff; border-bottom-left-radius: 6px; }
    .tg-bubble.user { background: #d9f8c5; border-bottom-right-radius: 6px; }
    .tg-bubble.action { background: #ecf1ff; border: 1px solid rgba(91,124,250,0.2); }
    .tg-meta { font-size: 11px; color: #6b7280; display: flex; justify-content: flex-end; gap: 8px; margin-top: 5px; }
    .tg-tag { display: inline-flex; align-items: center; font-size: 10px; border-radius: 999px; padding: 2px 7px; margin-bottom: 4px; background: rgba(255,255,255,0.72); color: #475569; border: 1px solid rgba(15,23,42,0.08); }

    /* Progrev UI polish */
    .progrev-flow-card {
      border: 1px solid rgba(91,124,250,0.18);
      background: linear-gradient(135deg, rgba(255,255,255,0.92) 0%, rgba(241,245,255,0.86) 100%);
      box-shadow: 0 14px 30px rgba(15,23,42,0.08);
    }
    .progrev-flow-track { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .progrev-flow-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;
      border: 1px solid transparent;
    }
    .progrev-flow-arrow { color: #94a3b8; font-weight: 700; }
    .flow-green { background: #d9fbe7; color: #166534; border-color: #b4eccd; }
    .flow-blue { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
    .flow-purple { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
    .flow-orange { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
    .flow-red { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

    .progrev-editor-card {
      border: 1px solid rgba(99,102,241,0.24);
      border-radius: 20px;
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(245,247,255,0.88) 100%);
      box-shadow: 0 16px 34px rgba(15,23,42,0.08);
    }
    .format-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
    .format-btn {
      min-width: 42px;
      height: 36px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.28);
      background: rgba(255,255,255,0.92);
      color: #1f2937;
      font-size: 13px;
      font-weight: 600;
      transition: all .18s ease;
    }
    .format-btn:hover {
      border-color: rgba(99,102,241,0.45);
      background: #fff;
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(99,102,241,0.15);
    }
    .format-btn.wide { min-width: auto; padding: 0 12px; }

    .emoji-bank-shell {
      margin-top: 12px;
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 16px;
      background: rgba(255,255,255,0.68);
      padding: 10px;
    }
    .emoji-bank-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .emoji-bank-refresh {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.28);
      background: #fff;
      color: #475569;
      transition: all .18s ease;
    }
    .emoji-bank-refresh:hover {
      border-color: rgba(99,102,241,0.45);
      color: #4338ca;
      transform: translateY(-1px);
    }
    #emojiBankProgrevList { gap: 10px; }
    #emojiBankProgrevList .emoji-chip {
      border: 1px solid rgba(203,213,225,0.75);
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      transition: all .18s ease;
    }
    #emojiBankProgrevList .emoji-chip:hover {
      border-color: rgba(99,102,241,0.36);
      box-shadow: 0 10px 18px rgba(15,23,42,0.08);
      transform: translateY(-1px);
    }
    #emojiBankProgrevList .emoji-main-btn {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(226,232,240,1);
      background: #fff;
      padding: 8px 6px;
    }
    #emojiBankProgrevList .emoji-trash-btn {
      padding: 2px 8px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      color: #dc2626;
      background: #fff;
      font-size: 12px;
    }
    #emojiBankProgrevList .emoji-trash-btn:hover { background: #fef2f2; border-color: #fca5a5; }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 z-50">
  <div class="card p-8 w-full max-w-sm mx-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <span class="text-3xl">üöÄ</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
      <p class="text-gray-500 text-sm mt-1">Tizimga kirish</p>
    </div>
    <form id="loginForm">
      <input type="text" id="username" class="input mb-3" placeholder="Login" required>
      <input type="password" id="password" class="input mb-4" placeholder="Parol" required>
      <button type="submit" class="btn btn-primary w-full">Kirish</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden">Login yoki parol xato</p>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden flex min-h-screen">

  <!-- Left Sidebar -->
  <aside id="sidebar" class="sidebar fixed left-0 top-0 bottom-0 flex flex-col items-center py-6 z-40">
    <div class="flex items-center gap-3 mb-6 px-3">
      <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg font-bold flex-shrink-0">F</div>
      <span class="sidebar-label text-lg font-bold text-gray-800">Funnel</span>
    </div>

    <nav class="flex flex-col gap-2 flex-1 w-full px-3">
      <div class="sidebar-item active" data-tab="overview" title="Umumiy"><span>üìä</span><span class="sidebar-label">Umumiy</span></div>
      <div class="sidebar-item" data-tab="analytics" title="Analitika"><span>üìà</span><span class="sidebar-label">Analitika</span></div>
      <div class="sidebar-item" data-tab="users" title="Foydalanuvchilar"><span>üë•</span><span class="sidebar-label">Foydalanuvchilar</span></div>
      <div class="sidebar-item" data-tab="conversations" title="Suhbatlar"><span>üí¨</span><span class="sidebar-label">Suhbatlar</span></div>
      <div class="sidebar-item" data-tab="payments" title="To'lovlar"><span>üí≥</span><span class="sidebar-label">To'lovlar</span></div>
      <div class="sidebar-item" data-tab="referrals" title="Referallar"><span>üîó</span><span class="sidebar-label">Referallar</span></div>
      <div class="sidebar-item" data-tab="lessons" title="Darslar"><span>üìö</span><span class="sidebar-label">Darslar</span></div>
      <div class="sidebar-item" data-tab="library" title="Kutubxona"><span>üìñ</span><span class="sidebar-label">Kutubxona</span></div>
      <div class="sidebar-item" data-tab="progrev" title="Progrevlar"><span>üî•</span><span class="sidebar-label">Progrevlar</span></div>
      <div class="sidebar-item" data-tab="custdev" title="CustDev"><span>üìù</span><span class="sidebar-label">CustDev</span></div>
      <div class="sidebar-item" data-tab="renewal" title="Uzaytirish"><span>üîÅ</span><span class="sidebar-label">Uzaytirish</span></div>
      <div class="sidebar-item" data-tab="promo" title="Promo kodlar"><span>üéüÔ∏è</span><span class="sidebar-label">Promo kodlar</span></div>
      <div class="sidebar-item" data-tab="audit" title="Audit Log"><span>üìã</span><span class="sidebar-label">Audit Log</span></div>
      <div class="sidebar-item" data-tab="settings" title="Sozlamalar"><span>‚öôÔ∏è</span><span class="sidebar-label">Sozlamalar</span></div>
    </nav>

    <div class="px-3 w-full space-y-2">
      <div class="sidebar-toggle mx-auto" onclick="toggleSidebar()" title="Menyuni kengaytirish">
        <span id="sidebarToggleIcon">‚Üí</span>
      </div>
      <div class="sidebar-item text-red-400" onclick="logout()" title="Chiqish"><span>üö™</span><span class="sidebar-label">Chiqish</span></div>
    </div>
  </aside>

  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="overview"><span class="text-lg">üìä</span>Umumiy</div>
    <div class="mobile-nav-item" data-tab="users"><span class="text-lg">üë•</span>Userlar</div>
    <div class="mobile-nav-item" data-tab="payments"><span class="text-lg">üí≥</span>To'lov</div>
    <div class="mobile-nav-item" data-tab="lessons"><span class="text-lg">üìö</span>Darslar</div>
    <div class="mobile-nav-item" onclick="toggleMobileMenu()"><span class="text-lg">‚ò∞</span>Ko'proq</div>
  </nav>

  <!-- Mobile Menu Modal -->
  <div id="mobileMenuModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="toggleMobileMenu()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transform transition-transform duration-300">
      <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
      <h3 class="font-semibold text-gray-800 mb-4">Qo'shimcha menyu</h3>
      <div class="grid grid-cols-3 gap-4">
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('library'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìñ</span>
          <span class="text-xs text-gray-600">Kutubxona</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('progrev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üî•</span>
          <span class="text-xs text-gray-600">Progrevlar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('custdev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìù</span>
          <span class="text-xs text-gray-600">CustDev</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('analytics'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìà</span>
          <span class="text-xs text-gray-600">Analitika</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('conversations'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üí¨</span>
          <span class="text-xs text-gray-600">Suhbatlar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('referrals'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üîó</span>
          <span class="text-xs text-gray-600">Referallar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('renewal'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üîÅ</span>
          <span class="text-xs text-gray-600">Uzaytirish</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('promo'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üéüÔ∏è</span>
          <span class="text-xs text-gray-600">Promokod</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('audit'); toggleMobileMenu();">
          <span class="text-2xl mb-2">üìã</span>
          <span class="text-xs text-gray-600">Audit Log</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('settings'); toggleMobileMenu();">
          <span class="text-2xl mb-2">‚öôÔ∏è</span>
          <span class="text-xs text-gray-600">Sozlamalar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-red-50 cursor-pointer hover:bg-red-100 transition-colors" onclick="logout()">
          <span class="text-2xl mb-2">üö™</span>
          <span class="text-xs text-red-600">Chiqish</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content flex-1 ml-[70px] p-6 pb-24 md:pb-6">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <p class="text-gray-500 text-sm" id="currentDate"></p>
      </div>
      <div class="flex flex-wrap gap-2 w-full sm:w-auto">
        <button onclick="openBroadcastModal()" class="btn btn-primary flex items-center gap-2">
          <span>üì®</span> Xabar yuborish
        </button>
        <button onclick="loadAll()" class="btn btn-secondary">üîÑ</button>
      </div>
    </header>

    <!-- Overview Tab -->
    <div id="tab-overview">

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6 kpi-grid">
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-indigo-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600">üë•</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Jami userlar</p>
              <p class="text-xl sm:text-2xl font-bold text-gray-800" id="statTotalUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-green-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">üíé</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">To'lagan</p>
              <p class="text-xl sm:text-2xl font-bold text-green-600" id="statPaidUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-blue-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-blue-100 to-cyan-100 text-blue-600">üí∞</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Daromad</p>
              <p class="text-xl sm:text-2xl font-bold text-blue-600" id="statRevenue">0</p>
            </div>
          </div>
        </div>
        <div class="card p-3 sm:p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute top-0 right-0 w-16 sm:w-20 h-16 sm:h-20 bg-orange-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-2 sm:gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-orange-100 to-amber-100 text-orange-600">üìà</div>
            <div class="min-w-0">
              <p class="text-gray-400 text-[10px] sm:text-xs uppercase tracking-wide font-medium truncate">Konversiya</p>
              <p class="text-xl sm:text-2xl font-bold text-orange-600" id="statConversion">0%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Today's Quick Stats -->
      <div class="card hero-card p-4 sm:p-5 mb-4 sm:mb-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <p class="text-indigo-200 text-sm">üìÖ Bugungi statistika</p>
            <p class="text-2xl sm:text-3xl font-bold" id="todayDateText"></p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="px-3 py-1 bg-white/20 rounded-full text-sm" id="todayTimeRange">00:00 - 23:59</span>
          </div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
          <div class="bg-white/10 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-indigo-200 text-xs uppercase tracking-wide">Yangi userlar</p>
            <p class="text-2xl sm:text-3xl font-bold" id="todayNewUsers">0</p>
            <p class="text-xs text-indigo-200 mt-1" id="todayNewUsersChange">O'tgan kunga nisbatan</p>
          </div>
          <div class="bg-white/10 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-indigo-200 text-xs uppercase tracking-wide">To'lovlar</p>
            <p class="text-2xl sm:text-3xl font-bold" id="todayPayments">0</p>
            <p class="text-xs text-indigo-200 mt-1" id="todayPaymentsAmount">0 so'm</p>
          </div>
          <div class="bg-white/10 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-indigo-200 text-xs uppercase tracking-wide">Dars ko'rganlar</p>
            <p class="text-2xl sm:text-3xl font-bold" id="todayLessonsWatched">0</p>
            <p class="text-xs text-indigo-200 mt-1">Bugun aktiv</p>
          </div>
          <div class="bg-white/10 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-indigo-200 text-xs uppercase tracking-wide">Feedback</p>
            <p class="text-2xl sm:text-3xl font-bold" id="todayFeedback">0</p>
            <p class="text-xs text-indigo-200 mt-1" id="todayFeedbackPositive">0 ijobiy</p>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="card p-5 lg:col-span-2">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-3xl font-bold text-gray-800" id="totalRevenueDisplay">0 so'm</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="tab active" data-period="week">Hafta</button>
              <button class="tab" data-period="month">Oy</button>
              <button class="tab" data-period="year">Yil</button>
            </div>
          </div>
          <div class="chart-container chart-bleed">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <!-- User Types -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">Foydalanuvchilar</h3>
          <div class="chart-container h-[180px]">
            <canvas id="userTypeChart"></canvas>
          </div>
          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Aktiv</span>
              <span class="font-medium" id="activeUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> To'lagan</span>
              <span class="font-medium" id="paidUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span> Tugatgan</span>
              <span class="font-medium" id="completedUsersCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscriber Growth Chart -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <p class="text-gray-500 text-sm">Yangi obunachilar</p>
            <p class="text-2xl font-bold text-gray-800" id="subscriberGrowthTitle">Haftalik o'sish</p>
            <p class="text-sm text-gray-400 mt-1" id="growthComparison">Bu davr: <span class="text-indigo-600 font-medium" id="currentPeriodCount">0</span> | O'tgan davr: <span class="text-gray-600 font-medium" id="prevPeriodCount">0</span></p>
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
            <div id="growthIndicator" class="flex items-center gap-1 text-green-600 font-semibold text-lg">
              <span id="growthArrow">‚Üë</span>
              <span id="growthPercent">0%</span>
            </div>
            <div class="flex gap-1 sm:gap-2 flex-wrap tab-row">
              <button class="tab text-xs sm:text-sm px-2 sm:px-4 active" data-growth-period="day">Kun</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="week">Hafta</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="month">Oy</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="year">Yil</button>
            </div>
          </div>
        </div>
        <div class="flex gap-4 mb-2 text-xs">
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Bu davr</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-300"></span> O'tgan davr</div>
        </div>
        <div class="chart-container chart-bleed h-[250px]">
          <canvas id="subscriberGrowthChart"></canvas>
        </div>
      </div>

      <!-- Source & Referral Stats Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Traffic Sources -->
        <div class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800">üìç Trafik manbalari</h3>
            <button onclick="openModal('sourceLinkModal')" class="text-sm text-indigo-600 font-medium hover:text-indigo-800">+ Link yaratish</button>
          </div>
          <div id="sourceStatsContainer">
            <div class="text-center text-gray-400 py-4">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Referral Stats -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üîó Referal tizimi</h3>
          <div id="referralStatsContainer">
            <div class="text-center text-gray-400 py-4">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Users -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h3 class="font-semibold text-gray-800">So'nggi foydalanuvchilar</h3>
            <button onclick="showTab('users')" class="text-indigo-600 text-sm font-medium">Barchasi ‚Üí</button>
          </div>
          <div id="recentUsersList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Recent Payments -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h3 class="font-semibold text-gray-800">So'nggi to'lovlar</h3>
            <button onclick="showTab('payments')" class="text-indigo-600 text-sm font-medium">Barchasi ‚Üí</button>
          </div>
          <div id="recentPaymentsList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <div class="flex flex-col lg:flex-row justify-between gap-4 mb-4">
            <h3 class="font-semibold text-gray-800 text-lg">üë• Foydalanuvchilar <span class="text-gray-400 font-normal" id="filteredUsersCount"></span></h3>
            <div class="flex gap-2 items-center flex-wrap">
              <input type="text" id="userSearch" class="input py-2 px-3 w-full sm:w-48" placeholder="üîç Ism, telefon..." oninput="applyUserFilters()">
              <button onclick="toggleAdvancedFilters()" class="btn btn-secondary btn-sm flex items-center gap-1">
                <span>üéõÔ∏è</span> <span id="advFilterLabel">Filtrlar</span>
              </button>
              <button onclick="exportUsers()" class="btn btn-secondary btn-sm" title="Eksport">üì•</button>
            </div>
          </div>

          <!-- Advanced Filters Panel -->
          <div id="advancedFiltersPanel" class="hidden bg-gray-50 rounded-xl p-4 space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <!-- Status Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Status</label>
                <select id="userStatusFilter" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="free">Free</option>
                  <option value="paid">Premium</option>
                  <option value="paid_not_joined">To'lagan (kanalda emas)</option>
                </select>
              </div>

              <!-- Lesson Range -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (dan)</label>
                <input type="number" id="filterLessonFrom" class="input py-2 text-sm" min="0" placeholder="0" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (gacha)</label>
                <input type="number" id="filterLessonTo" class="input py-2 text-sm" min="0" placeholder="10" onchange="applyUserFilters()">
              </div>

              <!-- Registration Date -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Ro'yxatdan o'tish</label>
                <select id="filterRegDate" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="today">Bugun</option>
                  <option value="week">Bu hafta</option>
                  <option value="month">Bu oy</option>
                  <option value="custom">Tanlash...</option>
                </select>
              </div>

              <!-- Phone Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Telefon</label>
                <select id="filterPhone" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="has">Bor</option>
                  <option value="no">Yo'q</option>
                </select>
              </div>

              <!-- Funnel Step -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Funnel bosqich</label>
                <select id="filterFunnelStep" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="0">0 - Yangi</option>
                  <option value="1">1-4 - CustDev</option>
                  <option value="5">5 - Darsda</option>
                  <option value="8">8+ - Tugagan</option>
                </select>
              </div>
            </div>

            <!-- Custom Date Range (hidden by default) -->
            <div id="customDateRange" class="hidden grid grid-cols-2 gap-3 max-w-sm">
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Boshlanish</label>
                <input type="date" id="filterDateFrom" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Tugash</label>
                <input type="date" id="filterDateTo" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
            </div>

            <div class="flex gap-2">
              <button onclick="resetUserFilters()" class="btn btn-secondary btn-sm">üîÑ Tozalash</button>
              <span class="text-sm text-gray-500 flex items-center" id="activeFiltersInfo"></span>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full responsive-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dars</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-100 flex justify-center gap-2" id="usersPagination"></div>
      </div>
    </div>

    <!-- Conversations Tab -->
    <div id="tab-conversations" class="hidden">
      <div class="card p-4">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-3 border border-gray-100 rounded-xl bg-white/70">
            <div class="px-3 py-3 border-b border-gray-100">
              <p class="text-sm font-semibold text-gray-700">üí¨ Chats</p>
              <div class="flex gap-2 mt-2">
                <input id="convSearch" type="text" class="input py-2 px-3" placeholder="Search chat..." oninput="renderConversationUsers()">
                <button onclick="loadConversations()" class="btn btn-secondary btn-sm">üîÑ</button>
              </div>
            </div>
            <div id="convUsersList" class="conv-users-list">
              <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
            </div>
          </div>

          <div class="xl:col-span-6 tg-chat-shell">
            <div class="tg-chat-head">
              <div class="conv-avatar" id="convHeaderAvatar">U</div>
              <div class="min-w-0">
                <p class="font-semibold text-gray-800 truncate" id="convSelectedUser">User tanlang</p>
                <p class="text-xs text-gray-500 truncate" id="convSelectedUserMeta">Chat tarixini ko'rish uchun chapdan user tanlang</p>
              </div>
            </div>
            <div id="convMessagesList" class="tg-chat-body">
              <div class="text-center text-gray-500">Chap tomondan userni tanlang</div>
            </div>
            <div class="border-t border-gray-100 bg-white/85 p-3 space-y-2">
              <div id="convReplyToBar" class="hidden text-xs bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-2 text-indigo-700">
                <div class="flex items-center justify-between gap-2">
                  <div class="truncate">
                    ‚Ü™ Javob beriladigan xabar: <span id="convReplyToText"></span>
                  </div>
                  <button class="text-indigo-600" onclick="clearConversationReplyTo()">‚úï</button>
                </div>
              </div>

              <div class="flex flex-wrap gap-1">
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('b')" title="Bold"><b>B</b></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('i')" title="Italic"><i>I</i></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('u')" title="Underline"><u>U</u></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('s')" title="Strike"><s>S</s></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('spoiler')" title="Spoiler">üôà</button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('blockquote')" title="Quote">‚ùù ‚ùû</button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('code')" title="Code">{ }</button>
                <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplate()" title="Link">üîó</button>
                <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplate()" title="Custom Emoji">‚ú®</button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <input id="convStickerFileId" class="input py-2 px-3" placeholder="Sticker file_id (ixtiyoriy)">
                <div class="flex items-center gap-2">
                  <select id="convParseMode" class="input py-2 px-3">
                    <option value="HTML">HTML (tavsiya)</option>
                    <option value="MarkdownV2">MarkdownV2</option>
                  </select>
                  <label class="text-xs text-gray-600 flex items-center gap-1">
                    <input type="checkbox" id="convDisablePreview"> Link preview off
                  </label>
                </div>
              </div>

              <div class="flex items-end gap-2">
                <textarea id="convReplyInput" class="input min-h-[44px] max-h-[140px] resize-y" placeholder="Type your message... (HTML format ham mumkin)" onkeydown="handleConvReplyKey(event)"></textarea>
                <button id="convReplyBtn" onclick="sendConversationReply()" class="btn btn-primary">üì®</button>
              </div>
            </div>
          </div>

          <div class="xl:col-span-3 border border-gray-100 rounded-xl bg-white/70 p-4">
            <p class="text-sm font-semibold text-gray-700 mb-3">User info</p>
            <div class="space-y-2 text-sm">
              <div><span class="text-gray-400">Ism:</span> <span id="convInfoName" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Username:</span> <span id="convInfoUsername" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Telegram ID:</span> <span id="convInfoTgId" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Telefon:</span> <span id="convInfoPhone" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Dars:</span> <span id="convInfoLesson" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Status:</span> <span id="convInfoStatus" class="text-gray-700">-</span></div>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-100">
              <p class="text-xs text-gray-400 mb-2">Quick actions</p>
              <div class="flex flex-col gap-2">
                <button onclick="insertQuickReply('Assalomu alaykum! Xabaringiz uchun rahmat üôå')" class="btn btn-secondary btn-sm text-left">Salomlashish</button>
                <button onclick="insertQuickReply('Rahmat, tekshirib sizga tez orada javob beraman.')" class="btn btn-secondary btn-sm text-left">Standart javob</button>
              </div>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-100">
              <div class="flex items-center justify-between gap-2 mb-2">
                <p class="text-xs text-gray-400">Custom emoji bank</p>
                <button onclick="loadCustomEmojiLibrary(true)" class="btn btn-secondary btn-sm">üîÑ</button>
              </div>
              <div id="emojiBankCount" class="text-xs text-gray-500 mb-2">0 ta emoji</div>
              <div id="emojiBankList" class="max-h-[260px] overflow-y-auto space-y-1">
                <div class="text-xs text-gray-400">Yuklanmoqda...</div>
              </div>
              <p class="text-[11px] text-gray-400 mt-2">Emoji ustiga bossangiz, aktiv matn maydoniga qo'shiladi.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="tab-payments" class="hidden">
      <!-- Payment Status Tabs -->
      <div class="flex flex-wrap gap-2 mb-4 tab-row">
        <button class="tab active" data-payment-status="completed" onclick="filterPayments('completed')">‚úÖ To'langan</button>
        <button class="tab" data-payment-status="pending" onclick="filterPayments('pending')">‚è≥ Jarayonda</button>
        <button class="tab" data-payment-status="cancelled" onclick="filterPayments('cancelled')">‚ùå Bekor qilingan</button>
        <button class="tab" data-payment-status="all" onclick="filterPayments('all')">üìã Barchasi</button>
      </div>

      <!-- Payment Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 kpi-grid">
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Bugun</p>
          <p class="text-2xl font-bold text-green-600" id="payToday">0</p>
          <p class="text-xs text-gray-400" id="payTodayCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Hafta</p>
          <p class="text-2xl font-bold text-blue-600" id="payWeek">0</p>
          <p class="text-xs text-gray-400" id="payWeekCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Oy</p>
          <p class="text-2xl font-bold text-indigo-600" id="payMonth">0</p>
          <p class="text-xs text-gray-400" id="payMonthCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Jami</p>
          <p class="text-2xl font-bold text-gray-800" id="payTotal">0</p>
          <p class="text-xs text-gray-400" id="payTotalCount">0 ta</p>
        </div>
      </div>

      <!-- Payment Status Summary -->
      <div class="grid grid-cols-3 gap-4 mb-6 kpi-grid">
        <div class="card p-4 border-l-4 border-green-500 kpi-card">
          <p class="text-sm text-gray-500">To'langan</p>
          <p class="text-xl font-bold text-green-600" id="payCompletedCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-yellow-500 kpi-card">
          <p class="text-sm text-gray-500">Jarayonda</p>
          <p class="text-xl font-bold text-yellow-600" id="payPendingCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-red-500 kpi-card">
          <p class="text-sm text-gray-500">Bekor qilingan</p>
          <p class="text-xl font-bold text-red-600" id="payCancelledCount">0</p>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <h3 class="font-semibold text-gray-800 text-lg">üí≥ To'lovlar tarixi</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full responsive-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summa</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reja</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tizim</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Premium kanal</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="7" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lessons Tab -->
    <div id="tab-lessons" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <h3 class="font-semibold text-gray-800 text-lg">üìö Darslar</h3>
          <button onclick="openLessonModal()" class="btn btn-primary">+ Yangi dars</button>
        </div>
        <div id="lessonsList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- Lesson Progress Stats -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">üìä Darslar bo'yicha statistika</h3>
        <div id="lessonProgressStats" class="space-y-3">
          <p class="text-gray-400 text-center">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Media ID Info -->
      <div class="card mt-6 p-5 bg-blue-50 border-blue-200">
        <h3 class="font-semibold text-blue-800 mb-2">üí° Media ID olish</h3>
        <p class="text-sm text-blue-600">
          Telegram botga video/audio/fayl/video xabar yuboring - bot sizga File ID beradi.
          O'sha ID ni darsga joylashtirsangiz, foydalanuvchilarga o'sha media yuboriladi.
        </p>
      </div>
    </div>

    <!-- Library Tab (Darslar kutubxonasi) -->
    <div id="tab-library" class="hidden">

      <!-- Media Library Section (Botga yuborilgan fayllar) -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üìÅ Media kutubxonasi</h3>
            <p class="text-sm text-gray-500">Botga yuborilgan barcha media fayllar</p>
          </div>
          <div class="flex flex-wrap gap-2 w-full sm:w-auto">
            <select id="mediaTypeFilter" class="input text-sm w-full sm:w-auto" onchange="loadMediaLibrary()">
              <option value="all">Barchasi</option>
              <option value="video">üé¨ Video</option>
              <option value="photo">üñº Rasm</option>
              <option value="voice">üé§ Ovozli</option>
              <option value="audio">üéµ Audio</option>
              <option value="video_note">‚ö™ Video xabar</option>
            </select>
            <button onclick="loadMediaLibrary()" class="btn btn-secondary text-sm w-full sm:w-auto">üîÑ</button>
          </div>
        </div>

        <!-- Media Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-4">
          <div class="bg-indigo-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Jami</p>
            <p class="text-lg font-bold text-indigo-600" id="mediaStatsTotal">0</p>
          </div>
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video</p>
            <p class="text-lg font-bold text-blue-600" id="mediaStatsVideo">0</p>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Rasm</p>
            <p class="text-lg font-bold text-green-600" id="mediaStatsPhoto">0</p>
          </div>
          <div class="bg-orange-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Audio</p>
            <p class="text-lg font-bold text-orange-600" id="mediaStatsAudio">0</p>
          </div>
          <div class="bg-purple-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video xabar</p>
            <p class="text-lg font-bold text-purple-600" id="mediaStatsVideoNote">0</p>
          </div>
        </div>

        <div id="mediaLibraryList" class="space-y-2 max-h-[400px] overflow-y-auto">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>

        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-800">üí° <strong>Yangi media qo'shish:</strong> Botga istalgan media (video, rasm, audio) yuboring - avtomatik kutubxonaga qo'shiladi!</p>
        </div>
      </div>

      <!-- Darslar kutubxonasi -->
      <div class="card p-5 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üìñ Darslar kutubxonasi</h3>
            <p class="text-sm text-gray-500">Barcha darslarning ID lari va tafsilotlari</p>
          </div>
          <button onclick="copyAllLessonIds()" class="btn btn-secondary text-sm">
            üìã Barcha ID larni nusxalash
          </button>
        </div>

        <div id="libraryLessonsList" class="space-y-3">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Quick Reference -->
      <div class="card p-5 bg-gradient-to-br from-indigo-50 to-purple-50">
        <h3 class="font-semibold text-indigo-800 mb-4">üìå Tez ma'lumot</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Jami darslar</p>
            <p class="text-2xl font-bold text-indigo-600" id="libraryTotalLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Video bilan</p>
            <p class="text-2xl font-bold text-green-600" id="libraryVideoLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Audio bilan</p>
            <p class="text-2xl font-bold text-orange-600" id="libraryAudioLessons">0</p>
          </div>
        </div>
      </div>

      <!-- Usage Guide -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">üí° Foydalanish bo'yicha</h3>
        <div class="space-y-3 text-sm text-gray-600">
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">1</span>
            <p><strong>ID nusxalash:</strong> Istalgan dars ID sini bosib nusxalang</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">2</span>
            <p><strong>Media qo'shish:</strong> Botga video/audio yuboring, File ID oling</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">3</span>
            <p><strong>Test qilish:</strong> Admin paneldan darsni test sifatida yuborib ko'ring</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Progrev Tab (Pitch/Sales/Soft Attack) -->
    <div id="tab-progrev" class="hidden">

      <!-- Flow Visual Guide -->
      <div class="card progrev-flow-card p-4 mb-6">
        <h3 class="font-semibold text-gray-800 mb-3">üìä Progrev ketma-ketligi</h3>
        <div class="progrev-flow-track">
          <span class="progrev-flow-pill flow-green">1. Tabrik</span>
          <span class="progrev-flow-arrow">‚Üí</span>
          <span class="progrev-flow-pill flow-blue">2. Feedback savoli</span>
          <span class="progrev-flow-arrow">‚Üí</span>
          <span class="progrev-flow-pill flow-purple">3. Ha: Kurs haqida</span>
          <span class="progrev-flow-arrow">‚Üí</span>
          <span class="progrev-flow-pill flow-orange">4. Sales Pitch</span>
          <span class="progrev-flow-arrow">‚Üí</span>
          <span class="progrev-flow-pill flow-red">5. Soft Attack</span>
        </div>
        <p class="text-xs text-gray-500 mt-2">Yo'q javobida: Sabab so'rash ‚Üí Follow-up ‚Üí (ixtiyoriy) Chegirmali taklif</p>
      </div>

      <!-- Universal Progrev Formatter -->
      <div class="card progrev-editor-card p-4 mb-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
          <h3 class="font-semibold text-gray-800 text-sm">‚úçÔ∏è Progrev matn formatlash</h3>
          <p id="progrevActiveEditorLabel" class="text-xs text-gray-500">Maydon tanlanmagan</p>
        </div>
        <div class="format-toolbar">
          <button class="format-btn" onclick="applyProgrevFormat('b')" title="Bold"><b>B</b></button>
          <button class="format-btn" onclick="applyProgrevFormat('i')" title="Italic"><i>I</i></button>
          <button class="format-btn" onclick="applyProgrevFormat('u')" title="Underline"><u>U</u></button>
          <button class="format-btn" onclick="applyProgrevFormat('s')" title="Strike"><s>S</s></button>
          <button class="format-btn" onclick="applyProgrevFormat('spoiler')" title="Spoiler">üôà</button>
          <button class="format-btn wide" onclick="applyProgrevFormat('blockquote')" title="Quote">‚ùù Quote</button>
          <button class="format-btn wide" onclick="applyProgrevFormat('blockquote_expand')" title="Expandable quote (bosganda ochiladi)">üìñ Expand Quote</button>
          <button class="format-btn" onclick="applyProgrevFormat('code')" title="Code">{ }</button>
          <button class="format-btn" onclick="applyProgrevFormat('link')" title="Link">üîó</button>
          <button class="format-btn" onclick="applyProgrevFormat('emoji')" title="Custom emoji">‚ú®</button>
        </div>
        <p class="text-xs text-gray-400 mt-2">Qaysi maydonga yozayotgan bo'lsangiz, tugma o'sha maydonga ishlaydi. `Expand Quote` Telegramda bosilganda ochiladi.</p>
        <div class="emoji-bank-shell">
          <div class="emoji-bank-head">
            <p class="text-xs text-gray-500">Custom emoji bank (Progrev)</p>
            <button onclick="loadCustomEmojiLibrary(true)" class="emoji-bank-refresh" title="Emoji bankni yangilash">üîÑ</button>
          </div>
          <div id="emojiBankProgrevCount" class="text-xs text-gray-500 mb-2">0 ta emoji</div>
          <div id="emojiBankProgrevList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
            <div class="text-xs text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

      <!-- Step 1: Congrats -->
      <div class="card p-5 mb-4 border-l-4 border-green-500">
        <h3 class="font-semibold text-gray-800 mb-2">1Ô∏è‚É£ Tabrik xabari</h3>
        <p class="text-xs text-gray-500 mb-3">Barcha darslar tugaganidan keyin</p>
        <textarea id="congratsText" class="input h-24 resize-none" placeholder="üéâ Tabriklayman! Barcha bepul darslarni tugatdingiz!"></textarea>
      </div>

      <!-- Start Messages -->
      <div class="card p-5 mb-4 border-l-4 border-indigo-500">
        <h3 class="font-semibold text-gray-800 mb-2">üÜï Start xabarlari</h3>
        <p class="text-xs text-gray-500 mb-3">/start bosilganda yuboriladigan birinchi xabarlar</p>

        <div class="flex flex-wrap gap-1 mb-3">
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','b')"><b>B</b></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','i')"><i>I</i></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','u')"><u>U</u></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','s')"><s>S</s></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','spoiler')">üôà Spoiler</button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','blockquote')">‚ùù Quote</button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','code')">{ }</button>
          <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplateTo('startWelcomeText')">üîó Link</button>
          <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplateTo('startWelcomeText')">‚ú® Emoji</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Welcome xabari (`welcome`)</label>
            <textarea id="startWelcomeText" class="input h-36 resize-none" placeholder="üéâ Assalomu alaykum!..."></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Ism so'rash xabari (`ask_name`)</label>
            <textarea id="startAskNameText" class="input h-36 resize-none" placeholder="üë§ Iltimos, ism-familiyangizni kiriting:"></textarea>
            <div class="flex flex-wrap gap-1 mt-2">
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','b')"><b>B</b></button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','i')"><i>I</i></button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','spoiler')">üôà</button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','blockquote')">‚ùù</button>
              <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplateTo('startAskNameText')">üîó</button>
              <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplateTo('startAskNameText')">‚ú®</button>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Bu maydonlar HTML parse mode bilan yuboriladi. `&lt;tg-spoiler&gt;`, `&lt;blockquote&gt;`, `&lt;tg-emoji ...&gt;` ishlaydi.</p>
      </div>

      <!-- Step 2: Feedback Question -->
      <div class="card p-5 mb-4 border-l-4 border-blue-500">
        <h3 class="font-semibold text-gray-800 mb-2">2Ô∏è‚É£ Feedback savoli</h3>
        <p class="text-xs text-gray-500 mb-3">Darslar yoqdimi so'rash</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg mb-3">
              <input type="checkbox" id="feedbackEnabled" class="w-5 h-5 accent-blue-600" checked>
              <label class="text-sm font-medium text-blue-800">Feedback flow yoqilgan</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - tabrikdan keyin</label>
              <input type="number" id="pitchDelayMinutes" class="input" value="0" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = darhol</p>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
            <textarea id="feedbackQuestion" class="input h-20 resize-none" placeholder="Bepul darslar yoqdimi? ü§î"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input type="text" id="feedbackYesBtn" class="input text-sm" value="üëç Ha, juda yoqdi!" placeholder="Ha tugmasi">
              <input type="text" id="feedbackNoBtn" class="input text-sm" value="üòê Unchalik emas" placeholder="Yo'q tugmasi">
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Positive Response - Course Info -->
      <div class="card p-5 mb-4 border-l-4 border-purple-500">
        <h3 class="font-semibold text-gray-800 mb-2">3Ô∏è‚É£ ‚úÖ "Ha" javobidan keyin - Kurs haqida</h3>
        <p class="text-xs text-gray-500 mb-3">Pullik kurs haqida ma'lumot + tugma ‚Üí Sales Pitch ga o'tish</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Kurs haqida matn</label>
            <textarea id="pitchInfoText" class="input h-32 resize-none" placeholder="üéâ Ajoyib tanlov!

To'liq kursda sizni kutmoqda:
‚úÖ 50+ dars
‚úÖ Amaliy topshiriqlar
‚úÖ Sertifikat

Hoziroq ro'yxatdan o'ting! üëá"></textarea>
            <div class="mt-2">
              <label class="text-sm text-gray-600 mb-1 block">Tugma matni</label>
              <input type="text" id="pitchInfoBtn" class="input" value="üöÄ Kursga yozilish" placeholder="Tugma matni">
            </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg space-y-3">
            <label class="text-sm font-medium text-purple-800 block">üìé Media (ixtiyoriy)</label>
            <select id="pitchMediaType" class="input" onchange="togglePitchMediaFields()">
              <option value="none">üìù Faqat matn</option>
              <option value="video">üé¨ Video</option>
              <option value="audio">üé§ Ovozli xabar</option>
              <option value="image">üñºÔ∏è Rasm</option>
              <option value="video_note">‚ö™ Dumaloq video</option>
            </select>
            <div id="pitchMediaVideoField" class="hidden">
              <input type="text" id="pitchVideoFileId" class="input file-id-input text-sm" placeholder="Video File ID">
            </div>
            <div id="pitchMediaAudioField" class="hidden">
              <input type="text" id="pitchAudioFileId" class="input file-id-input text-sm" placeholder="Audio File ID">
            </div>
            <div id="pitchMediaImageField" class="hidden">
              <input type="text" id="pitchImageFileId" class="input file-id-input text-sm" placeholder="Rasm File ID">
            </div>
            <div id="pitchMediaVideoNoteField" class="hidden">
              <input type="text" id="pitchVideoNoteFileId" class="input file-id-input text-sm" placeholder="Video Note File ID">
            </div>
            <p class="text-xs text-gray-500">Botga media yuboring va File ID ni oling</p>
          </div>
        </div>
      </div>

      <!-- Step 3b: Negative Response -->
      <div class="card p-5 mb-4 border-l-4 border-red-400">
        <h3 class="font-semibold text-gray-800 mb-2">3Ô∏è‚É£ ‚ùå "Yo'q" javobidan keyin</h3>
        <p class="text-xs text-gray-500 mb-3">Sabab so'rash va follow-up</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sabab so'rash xabari</label>
              <textarea id="feedbackNoResponse" class="input h-20 resize-none" placeholder="üòî Tushunaman. Iltimos, nimada kamchilik borligini yozing..."></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Follow-up xabar (sabab yozganidan keyin)</label>
              <textarea id="feedbackFollowup" class="input h-20 resize-none" placeholder="Rahmat fikringiz uchun! üôè Biz doimo yaxshilanib boramiz..."></textarea>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
              <input type="checkbox" id="feedbackSpecialOfferEnabled" class="w-5 h-5 accent-orange-600">
              <label class="text-sm font-medium text-orange-800">Maxsus 20% chegirma taklifi</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Chegirma xabari</label>
              <textarea id="feedbackSpecialOffer" class="input h-16 resize-none" placeholder="üéÅ Sizga maxsus 20% chegirma!"></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sales Pitch ga o'tish (daqiqa)</label>
              <input type="number" id="feedbackNoSalesDelay" class="input" value="30" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = follow-up dan keyin darhol</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Sales Pitch -->
      <div class="card p-5 mb-4 border-l-4 border-orange-500">
        <h3 class="font-semibold text-gray-800 mb-2">4Ô∏è‚É£ Sales Pitch (Narxlar)</h3>
        <p class="text-xs text-gray-500 mb-3">"Kursga yozilish" tugmasi bosilgandan keyin</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Sales matn sarlavhasi</label>
            <textarea id="salesPitchText" class="input h-28 resize-none" placeholder="üéì SMM PRO KURSGA TAKLIF!

Obuna turini tanlang:"></textarea>
            <p class="text-xs text-gray-400 mt-1">Narxlar avtomatik qo'shiladi</p>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - feedback yo'q bo'lsa</label>
            <input type="number" id="salesDelayMinutes" class="input" value="0" min="0">
            <p class="text-xs text-gray-400 mt-1">Agar feedback o'chirilgan bo'lsa, tabrikdan keyin</p>
          </div>
        </div>
      </div>

      <!-- Step 5: Soft Attack -->
      <div class="card p-5 mb-4 border-l-4 border-red-500">
        <h3 class="font-semibold text-gray-800 mb-2">5Ô∏è‚É£ Soft Attack (Oxirgi taklif)</h3>
        <p class="text-xs text-gray-500 mb-3">Sotib olmagan foydalanuvchilarga</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" id="softAttackDisabled" class="w-5 h-5 accent-red-600">
              <label class="text-sm text-gray-600">O'chirilgan</label>
            </div>
            <label class="text-sm text-gray-600 mb-1 block">Soft attack matni</label>
            <textarea id="softAttackText" class="input h-24 resize-none" placeholder="ü§î Hali qaror qilmadingizmi?

Kurs haqida savollaringiz bo'lsa yozing!"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - sales pitchdan keyin</label>
            <input type="number" id="softAttackDelayMinutes" class="input" value="1440" min="0">
            <p class="text-xs text-gray-400 mt-1">1440 daqiqa = 24 soat</p>
          </div>
        </div>
      </div>

      <!-- Lesson Completion Settings -->
      <div class="card p-5 mb-4">
        <h3 class="font-semibold text-gray-800 mb-2">üì∫ Dars ko'rish tugmasi (default)</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Tugmadan oldingi matn</label>
            <input type="text" id="watchedMessageDefault" class="input" placeholder="Videoni ko'rib bo'lganingizdan keyin tugmani bosing:">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Tugma matni</label>
            <input type="text" id="watchedButtonDefault" class="input" placeholder="‚úÖ Videoni ko'rib bo'ldim">
          </div>
        </div>
      </div>

      <button onclick="saveProgrevSettings()" class="btn btn-primary">üíæ Progrev sozlamalarini saqlash</button>
    </div>

    <!-- CustDev Tab -->
    <div id="tab-custdev" class="hidden">
      <!-- CustDev Header with Export -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <h2 class="text-xl font-bold text-gray-800">CustDev ma'lumotlari</h2>
        <button onclick="exportCustDevAnswers()" class="btn btn-secondary">üì• Javoblarni eksport qilish (CSV)</button>
      </div>

      <!-- CustDev Overview Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami savollar</p>
          <p class="text-2xl font-bold text-indigo-600" id="custdevTotalQuestions">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami javoblar</p>
          <p class="text-2xl font-bold text-green-600" id="custdevTotalAnswers">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Javob berganlar</p>
          <p class="text-2xl font-bold text-blue-600" id="custdevRespondents">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">O'rtacha javob</p>
          <p class="text-2xl font-bold text-orange-600" id="custdevAvgAnswers">0</p>
        </div>
      </div>

      <!-- CustDev Charts -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Yosh</p>
          <div class="chart-container h-[120px]">
            <canvas id="ageChart"></canvas>
          </div>
          <div id="ageChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Kasb</p>
          <div class="chart-container h-[120px]">
            <canvas id="occupationChart"></canvas>
          </div>
          <div id="occupationChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Daromad</p>
          <div class="chart-container h-[120px]">
            <canvas id="incomeChart"></canvas>
          </div>
          <div id="incomeChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Byudjet</p>
          <div class="chart-container h-[120px]">
            <canvas id="budgetChart"></canvas>
          </div>
          <div id="budgetChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
      </div>

      <!-- Questions List -->
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <h3 class="font-semibold text-gray-800 text-lg">üìù CustDev savollari</h3>
          <button onclick="openCustDevModal()" class="btn btn-primary">+ Yangi savol</button>
        </div>
        <div id="custdevList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- User Feedback Section -->
      <div class="card mt-6">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">üí¨ Foydalanuvchi feedbacklari</h3>
            <p class="text-sm text-gray-400">Bepul darslar haqida fikrlar</p>
          </div>
          <div class="flex flex-wrap gap-2 w-full sm:w-auto">
            <select id="feedbackFilter" class="input py-2 px-3 w-full sm:w-auto text-sm" onchange="filterFeedback()">
              <option value="all">Barchasi</option>
              <option value="liked">üëç Yoqdi</option>
              <option value="not_liked">üëé Yoqmadi</option>
              <option value="disliked_reason">üìù Sabablar</option>
            </select>
            <button onclick="loadFeedback()" class="btn btn-secondary text-sm w-full sm:w-auto">üîÑ Yangilash</button>
          </div>
        </div>

        <!-- Feedback Stats -->
        <div class="grid grid-cols-3 gap-4 p-5 border-b border-gray-100 bg-gray-50">
          <div class="text-center">
            <p class="text-2xl font-bold text-green-600" id="feedbackLikedCount">0</p>
            <p class="text-xs text-gray-500">üëç Yoqdi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-red-600" id="feedbackDislikedCount">0</p>
            <p class="text-xs text-gray-500">üëé Yoqmadi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-indigo-600" id="feedbackTotalCount">0</p>
            <p class="text-xs text-gray-500">Jami</p>
          </div>
        </div>

        <!-- Feedback List -->
        <div id="feedbackList" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-renewal" class="hidden">
      <div class="card p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800">üîÅ Uzaytirish eslatmalari</h3>
            <p class="text-sm text-gray-500">10/5/3/1 kun qolganda yuboriladigan matnlar. To'lov summalari xabarda tugmalar orqali avtomatik chiqadi.</p>
          </div>
          <button onclick="loadRenewalSettings()" class="btn btn-secondary btn-sm">üîÑ Yangilash</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">10 kun oldin</label>
            <textarea id="renewalReminder10d" class="input h-28 resize-none" placeholder="10 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">5 kun oldin</label>
            <textarea id="renewalReminder5d" class="input h-28 resize-none" placeholder="5 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">3 kun oldin</label>
            <textarea id="renewalReminder3d" class="input h-28 resize-none" placeholder="3 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">1 kun oldin</label>
            <textarea id="renewalReminder1d" class="input h-28 resize-none" placeholder="1 kun oldin yuboriladigan xabar"></textarea>
          </div>
        </div>

        <div class="mt-4">
          <label class="text-sm text-gray-600 mb-1 block">Obuna tugagandan keyin</label>
          <textarea id="renewalReminderExpired" class="input h-28 resize-none" placeholder="Obuna tugagandan keyingi xabar"></textarea>
        </div>

        <button onclick="saveRenewalSettings()" class="btn btn-primary mt-5">üíæ Uzaytirish sozlamalarini saqlash</button>
      </div>
    </div>

    <!-- Promo Codes Tab -->
    <div id="tab-promo" class="hidden">
      <div class="card p-5 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-gray-800">üéüÔ∏è Promo kodlar</h3>
          <button onclick="showCreatePromoModal()" class="btn btn-primary btn-sm">+ Yangi kod</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">Kod</th>
                <th class="pb-3">Chegirma</th>
                <th class="pb-3">Ishlatilgan</th>
                <th class="pb-3">Limit</th>
                <th class="pb-3">Amal qilish</th>
                <th class="pb-3">Holat</th>
                <th class="pb-3"></th>
              </tr>
            </thead>
            <tbody id="promoCodesTable">
              <tr><td colspan="7" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Create Promo Modal -->
    <div id="promoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
        <h3 class="font-semibold text-lg mb-4">üéüÔ∏è Yangi promo kod</h3>

        <div class="space-y-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Kod *</label>
            <input type="text" id="promoCode" class="input uppercase" placeholder="YANGIOBUNA50" maxlength="20">
          </div>

          <div>
            <label class="text-sm text-gray-600 mb-1 block">Chegirma foizi *</label>
            <input type="number" id="promoDiscount" class="input" placeholder="50" min="1" max="100">
          </div>

          <div>
            <label class="text-sm text-gray-600 mb-1 block">Maksimal ishlatish soni (bo'sh = cheksiz)</label>
            <input type="number" id="promoMaxUses" class="input" placeholder="100" min="1">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Boshlanish sanasi</label>
              <input type="date" id="promoValidFrom" class="input">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Tugash sanasi</label>
              <input type="date" id="promoValidUntil" class="input">
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-600 mb-1 block">Minimal tarif</label>
            <select id="promoMinPlan" class="input">
              <option value="">Barcha tariflar</option>
              <option value="1month">1 oylik</option>
              <option value="3month">3 oylik</option>
              <option value="6month">6 oylik</option>
              <option value="1year">12 oylik</option>
            </select>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="closePromoModal()" class="btn btn-secondary flex-1">Bekor qilish</button>
          <button onclick="createPromoCode()" class="btn btn-primary flex-1">Yaratish</button>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics" class="hidden">
      <!-- Funnel Diagnostics -->
      <div class="card p-5 mb-6">
        <div class="flex items-center justify-between gap-3 mb-4">
          <h3 class="font-semibold text-gray-800">üß≠ Funnel Diagnostika</h3>
          <div class="text-xs text-gray-500">Qayerda yiqilyapti va nima qilish kerak</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <div class="p-3 bg-indigo-50 rounded-xl">
            <div class="text-xs text-gray-500">Umumiy CR</div>
            <div class="text-xl font-bold text-indigo-600" id="diagOverallCR">-</div>
          </div>
          <div class="p-3 bg-red-50 rounded-xl">
            <div class="text-xs text-gray-500">Eng katta yo'qotish</div>
            <div class="text-sm font-semibold text-red-600" id="diagBiggestDrop">-</div>
          </div>
          <div class="p-3 bg-amber-50 rounded-xl">
            <div class="text-xs text-gray-500">Pitchdan checkoutsiz</div>
            <div class="text-xl font-bold text-amber-600" id="diagStuckUsers">-</div>
          </div>
          <div class="p-3 bg-green-50 rounded-xl">
            <div class="text-xs text-gray-500">Asosiy tavsiya</div>
            <div class="text-sm font-semibold text-green-700" id="diagNextAction">-</div>
          </div>
        </div>

        <div class="overflow-x-auto mb-4">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-2">Bosqich</th>
                <th class="pb-2">User</th>
                <th class="pb-2">Prev dan</th>
                <th class="pb-2">Start dan</th>
              </tr>
            </thead>
            <tbody id="diagFunnelTable">
              <tr><td colspan="4" class="py-3 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>

        <div id="diagAlerts" class="space-y-2">
          <div class="text-sm text-gray-400">Diagnostika yuklanmoqda...</div>
        </div>
      </div>

      <!-- Revenue & Growth Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí∞ Daromad (so'nggi 30 kun)</h3>
          <div class="chart-container"><canvas id="analyticsRevenueChart"></canvas></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üìà Obunalar o'sishi</h3>
          <div class="chart-container"><canvas id="analyticsSubscribersChart"></canvas></div>
        </div>
      </div>

      <!-- Source Analytics -->
      <div class="card p-5 mb-6">
        <h3 class="font-semibold text-gray-800 mb-4">üåê Trafik manbalari</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <canvas id="sourcesPieChart" height="250"></canvas>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="pb-3">Manba</th>
                  <th class="pb-3">Userlar</th>
                  <th class="pb-3">To'lagan</th>
                  <th class="pb-3">Konversiya</th>
                </tr>
              </thead>
              <tbody id="sourcesTable">
                <tr><td colspan="4" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Buyer Journey Analytics -->
      <div class="card p-5 mb-6">
        <h3 class="font-semibold text-gray-800 mb-4">üõí Xaridor statistikasi</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div class="text-center p-4 bg-blue-50 rounded-xl">
            <div class="text-2xl font-bold text-blue-600" id="buyerAvgLesson">-</div>
            <div class="text-xs text-gray-500">Jami xaridorlar</div>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-xl">
            <div class="text-2xl font-bold text-green-600" id="buyerAvgDays">-</div>
            <div class="text-xs text-gray-500">O'rtacha kun (sotib olish)</div>
          </div>
          <div class="text-center p-4 bg-purple-50 rounded-xl">
            <div class="text-2xl font-bold text-purple-600" id="buyerConversion">-</div>
            <div class="text-xs text-gray-500">Konversiya</div>
          </div>
          <div class="text-center p-4 bg-orange-50 rounded-xl">
            <div class="text-2xl font-bold text-orange-600" id="buyerAvgCheck">-</div>
            <div class="text-xs text-gray-500">Eng tez xarid</div>
          </div>
        </div>
        <p class="text-xs text-gray-400 mb-2">Xaridorlar yosh guruhi bo'yicha:</p>
        <div class="chart-container h-[150px]"><canvas id="buyerFunnelChart"></canvas></div>
      </div>

      <!-- Inactivity Stats -->
      <div class="card p-5">
        <h3 class="font-semibold text-gray-800 mb-4">‚è∞ Faolsizlik eslatmalari</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="text-center p-4 bg-gray-50 rounded-xl">
            <div class="text-2xl font-bold text-gray-700" id="inactTotalDeliveries">-</div>
            <div class="text-xs text-gray-500">Yuborilgan darslar</div>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-xl">
            <div class="text-2xl font-bold text-green-600" id="inactWatched">-</div>
            <div class="text-xs text-gray-500">Ko'rilgan</div>
          </div>
          <div class="text-center p-4 bg-yellow-50 rounded-xl">
            <div class="text-2xl font-bold text-yellow-600" id="inactReminder1">-</div>
            <div class="text-xs text-gray-500">1-eslatma</div>
          </div>
          <div class="text-center p-4 bg-orange-50 rounded-xl">
            <div class="text-2xl font-bold text-orange-600" id="inactReminder2">-</div>
            <div class="text-xs text-gray-500">2-eslatma</div>
          </div>
          <div class="text-center p-4 bg-blue-50 rounded-xl">
            <div class="text-2xl font-bold text-blue-600" id="inactWatchedAfter">-</div>
            <div class="text-xs text-gray-500">Eslatmadan keyin</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Referrals Tab -->
    <div id="tab-referrals" class="hidden">
      <!-- Referral Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-blue-600" id="refTotalReferrals">-</div>
          <div class="text-sm text-gray-500">Jami referallar</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-green-600" id="refQualified">-</div>
          <div class="text-sm text-gray-500">Faol (qualified)</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-purple-600" id="refDiscountsUsed">-</div>
          <div class="text-sm text-gray-500">Chegirma olgan</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-orange-600" id="refActiveReferrers">-</div>
          <div class="text-sm text-gray-500">Faol referrerlar</div>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card p-5 mb-6">
        <h3 class="font-semibold text-gray-800 mb-4">üèÜ Top Referrerlar</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">#</th>
                <th class="pb-3">Foydalanuvchi</th>
                <th class="pb-3">Taklif qilgan</th>
                <th class="pb-3">Chegirma</th>
              </tr>
            </thead>
            <tbody id="referralLeaderboard">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invite Links -->
      <div class="card p-5">
        <h3 class="font-semibold text-gray-800 mb-4">üîó Taklifnoma linklari</h3>
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="text-center p-3 bg-blue-50 rounded-xl">
            <div class="text-xl font-bold text-blue-600" id="inviteTotal">-</div>
            <div class="text-xs text-gray-500">Jami yaratilgan</div>
          </div>
          <div class="text-center p-3 bg-green-50 rounded-xl">
            <div class="text-xl font-bold text-green-600" id="inviteUsed">-</div>
            <div class="text-xs text-gray-500">Ishlatilgan</div>
          </div>
          <div class="text-center p-3 bg-gray-50 rounded-xl">
            <div class="text-xl font-bold text-gray-600" id="inviteUnused">-</div>
            <div class="text-xs text-gray-500">Ishlatilmagan</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Log Tab -->
    <div id="tab-audit" class="hidden">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
          <h3 class="font-semibold text-gray-800">üìã Audit Log (Tekshiruv jurnali)</h3>
          <div class="flex gap-2 flex-wrap">
            <select id="auditActionFilter" class="input w-40" onchange="loadAuditLogs()">
              <option value="">Barcha harakatlar</option>
              <option value="PAYMENT_COMPLETED">To'lovlar</option>
              <option value="USER_CREATED">Yangi userlar</option>
              <option value="SETTINGS_CHANGED">Sozlamalar</option>
              <option value="SECURITY_">Xavfsizlik</option>
            </select>
            <input type="date" id="auditDateFilter" class="input w-40" onchange="loadAuditLogs()">
            <button onclick="exportAuditLogs()" class="btn btn-secondary btn-sm">üì• Export</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">Vaqt</th>
                <th class="pb-3">Harakat</th>
                <th class="pb-3">Foydalanuvchi</th>
                <th class="pb-3">Maqsad</th>
                <th class="pb-3">Tafsilotlar</th>
              </tr>
            </thead>
            <tbody id="auditLogsTable">
              <tr><td colspan="5" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-center mt-4 gap-2">
          <button onclick="loadAuditLogs(auditOffset - 50)" class="btn btn-secondary btn-sm" id="auditPrevBtn" disabled>‚Üê Oldingi</button>
          <span class="px-4 py-2 text-sm text-gray-500" id="auditPageInfo">1-50</span>
          <button onclick="loadAuditLogs(auditOffset + 50)" class="btn btn-secondary btn-sm" id="auditNextBtn">Keyingi ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Channel Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üì¢ Kanal sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Premium kanal ID</label>
              <input type="text" id="settingPremiumChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal ID</label>
              <input type="text" id="settingFreeChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal linki</label>
              <input type="text" id="settingFreeChannelLink" class="input" placeholder="https://t.me/channel">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Obuna so'raladigan darsdan keyin (0 = talab qilinmaydi)</label>
              <input type="number" id="settingRequireSub" class="input" value="0" min="0">
            </div>
          </div>

          <!-- Subscription bypass settings -->
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" id="settingSubBypassEnabled" class="w-4 h-4 rounded">
              <label class="text-sm text-gray-700">Obuna tekshiruvi o'tkazib yuborish</label>
            </div>
            <p class="text-xs text-gray-500 mb-3">Agar foydalanuvchi bir necha marta urinib ko'rsa va o'xshamasa, keyingi darsga o'tkazib yuborish</p>
            <div class="flex items-center gap-2">
              <input type="number" id="settingSubBypassAttempts" class="input w-20" value="3" min="1" max="10">
              <span class="text-sm text-gray-600">ta urinishdan keyin o'tkazish</span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí∞ Narxlar (so'm)</h3>
          <p class="text-xs text-gray-500 mb-4">1 oylik narxni kiriting - 3/6/12 oylik avtomatik chegirma bilan hisoblanadi</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1 oylik <span class="text-blue-600 font-medium">(asosiy)</span></label>
              <input type="number" id="settingPrice1m" class="input" placeholder="97000" oninput="calculateDiscountedPrices()">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">3 oylik <span class="text-green-600 font-medium">(-10%)</span></label>
              <input type="number" id="settingPrice3m" class="input bg-gray-100" placeholder="247000" readonly>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">6 oylik <span class="text-green-600 font-medium">(-25%)</span></label>
              <input type="number" id="settingPrice6m" class="input bg-gray-100" placeholder="447000" readonly>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">12 oylik <span class="text-green-600 font-medium">(-40%)</span></label>
              <input type="number" id="settingPrice12m" class="input bg-gray-100" placeholder="797000" readonly>
            </div>
          </div>
        </div>

        <!-- Payment Systems -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üí≥ To'lov tizimlari</h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingPayme" class="w-5 h-5 accent-blue-600">
              <span class="text-lg">üí≥</span>
              <span class="font-medium">Payme</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingClick" class="w-5 h-5 accent-green-600">
              <span class="text-lg">üí†</span>
              <span class="font-medium">Click</span>
            </label>
          </div>
        </div>

        <!-- Inactivity Reminders -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">‚è∞ Dars eslatmalari</h3>
          <p class="text-xs text-gray-500 mb-4">Darsni ko'rmagan userlarga avtomatik eslatma yuborish</p>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingInactivityEnabled" class="w-5 h-5 accent-orange-600">
              <span class="font-medium">Eslatmalarni yoqish</span>
            </label>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1-eslatma matni (1 soatdan keyin)</label>
              <textarea id="settingInactivityReminder1" class="input min-h-[60px]" placeholder="Hey! Darsni hali ko'rmadingizmi?"></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">2-eslatma matni (3 soatdan keyin)</label>
              <textarea id="settingInactivityReminder2" class="input min-h-[60px]" placeholder="Dars sizni kutmoqda!"></textarea>
            </div>
          </div>
        </div>

        <!-- Referral System -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üîó Referal tizimi</h3>
          <p class="text-xs text-gray-500 mb-4">Userlar do'stlarini taklif qilib chegirma olishlari mumkin</p>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingReferralEnabled" class="w-5 h-5 accent-green-600">
              <span class="font-medium">Referal tizimini yoqish</span>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">Kerakli referallar soni</label>
                <input type="number" id="settingReferralCount" class="input" value="3" min="1">
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">Chegirma foizi (%)</label>
                <input type="number" id="settingReferralDiscount" class="input" value="50" min="1" max="100">
              </div>
            </div>

            <!-- Referral Offer (24h after sales pitch) -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">üì¨ Referal taklif xabari (to'lov qilmaganlarga)</h4>
              <p class="text-xs text-gray-500 mb-3">User to'lov sahifasini ko'rganidan keyin bir muncha vaqt o'tsa, maxsus referal taklif xabari yuboriladi</p>

              <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 mb-3">
                <input type="checkbox" id="settingReferralOfferEnabled" class="w-5 h-5 accent-green-600">
                <span class="font-medium">Referal taklif xabarini yoqish</span>
              </label>

              <div class="mb-3">
                <label class="text-sm text-gray-600 mb-1 block">Necha soatdan keyin yuborish</label>
                <input type="number" id="settingReferralOfferDelay" class="input" value="24" min="1" max="168">
                <p class="text-xs text-gray-400 mt-1">Masalan: 24 = to'lov sahifasidan 24 soat o'tgach</p>
              </div>

              <div>
                <label class="text-sm text-gray-600 mb-1 block">Taklif xabari matni</label>
                <textarea id="settingReferralOfferMessage" class="input" rows="4" placeholder="Xabar matnini kiriting...">üéÅ <b>Sizga maxsus taklif!</b>

Hozirgi tariflarni <b>{{chegirma}}% chegirmada</b> olishingiz mumkin!

Buning uchun <b>{{kerakli_odam}} ta do'stingizni</b> referal havolangiz orqali chaqiring.

Ular birinchi darsni ko'rishni boshlashganda siz chegirmaga ega bo'lasiz! üéâ</textarea>
                <p class="text-xs text-gray-400 mt-1">O'zgaruvchilar: {{ism}}, {{chegirma}}, {{kerakli_odam}}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin Info -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">üë§ Admin</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Admin Telegram ID</label>
              <input type="text" id="settingAdminId" class="input font-mono" placeholder="123456789">
            </div>
          </div>
        </div>

      </div>

      <button onclick="saveSettings()" class="btn btn-primary mt-6 w-full lg:w-auto">üíæ Sozlamalarni saqlash</button>
    </div>

  </main>

  <!-- Right Panel (Desktop only) -->
  <aside class="right-panel hidden lg:block w-80 p-6 border-l border-gray-100 bg-gradient-to-b from-white to-gray-50/50">

    <!-- Stats Card -->
    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 rounded-2xl p-5 text-white mb-6 shadow-lg shadow-indigo-500/25 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <p class="text-indigo-200 text-sm mb-1 relative">üí∞ Umumiy daromad</p>
      <p class="text-3xl font-bold mb-4 relative" id="rightPanelRevenue">0 so'm</p>
      <div class="flex justify-between text-sm relative">
        <span class="text-indigo-200">üìÖ Bu oy</span>
        <span class="font-semibold bg-white/20 px-2 py-0.5 rounded-full" id="rightPanelMonthRevenue">0</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-800">‚ö° So'nggi faoliyat</h3>
        <span class="text-xs text-indigo-500 font-medium">Live</span>
      </div>
      <div id="recentActivity" class="space-y-2 max-h-64 overflow-y-auto">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Lesson Funnel -->
    <div class="bg-gradient-to-br from-gray-50 to-indigo-50/30 rounded-xl p-4 -mx-2">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-sm">üìä</span>
        Darslar funneli
      </h3>
      <div id="lessonProgressPanel" class="funnel-container">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

  </aside>

</div>

<!-- Source Link Generator Modal -->
<div id="sourceLinkModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6 max-w-md w-full">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">üîó Trafik linki yaratish</h3>
      <button onclick="closeModal('sourceLinkModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">‚úï</button>
    </div>

    <div class="space-y-4">
      <!-- Quick Source Buttons -->
      <div>
        <label class="text-sm font-medium text-gray-700 mb-2 block">Tezkor tanlash:</label>
        <div class="flex flex-wrap gap-2">
          <button onclick="setSourceName('instagram')" class="px-3 py-1.5 text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90">üì∏ Instagram</button>
          <button onclick="setSourceName('telegram')" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:opacity-90">üì± Telegram</button>
          <button onclick="setSourceName('facebook')" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:opacity-90">üë§ Facebook</button>
          <button onclick="setSourceName('youtube')" class="px-3 py-1.5 text-sm bg-red-500 text-white rounded-lg hover:opacity-90">üé¨ YouTube</button>
          <button onclick="setSourceName('tiktok')" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-lg hover:opacity-90">üéµ TikTok</button>
        </div>
      </div>

      <!-- Custom Source Input -->
      <div>
        <label class="text-sm font-medium text-gray-700 mb-2 block">Yoki o'zingiz yozing:</label>
        <input type="text" id="sourceNameInput" class="input" placeholder="Masalan: instagram, telegram_kanal, reklama1..." oninput="generateSourceLink()">
        <p class="text-xs text-gray-400 mt-1">Faqat lotin harflari, raqamlar va _ ishlatiladi</p>
      </div>

      <!-- Generated Link -->
      <div id="generatedLinkContainer" class="hidden">
        <label class="text-sm font-medium text-gray-700 mb-2 block">Tayyor havola:</label>
        <div class="flex gap-2">
          <input type="text" id="generatedSourceLink" class="input font-mono text-sm flex-1" readonly>
          <button onclick="copySourceLink()" class="btn btn-primary px-4">üìã</button>
        </div>
        <p class="text-xs text-green-600 mt-2" id="sourceLinkCopied" style="display:none">‚úì Nusxalandi!</p>
      </div>

      <!-- Instructions -->
      <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
        <p class="font-medium mb-2">üìù Qanday ishlaydi:</p>
        <ol class="list-decimal list-inside space-y-1 text-xs">
          <li>Manba nomini tanlang yoki yozing</li>
          <li>Havolani nusxalang</li>
          <li>Reklama yoki postda shu havolani qo'ying</li>
          <li>Dashboard'da statistikani kuzating</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Broadcast Modal (Advanced) -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6 max-h-[95vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">üì® Xabar yuborish</h3>
      <button onclick="closeModal('broadcastModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Target & Variables -->
      <div class="space-y-4">
        <!-- Target Selection -->
        <div class="bg-gray-50 rounded-xl p-4">
          <label class="text-sm font-medium text-gray-700 mb-2 block">üìç Kimga yuborish</label>
          <select id="broadcastTarget" class="input" onchange="toggleUserSelect(); updateRecipientCount()">
            <option value="all">Hammaga</option>
            <option value="paid">To'laganlarga (Premium)</option>
            <option value="free">To'lamaganlarga (Free)</option>
            <option value="active">Aktiv foydalanuvchilarga</option>
            <option value="lesson">Muayyan darsda bo'lganlarga</option>
            <option value="specific">Tanlangan foydalanuvchilarga</option>
          </select>

          <!-- Lesson Range (for lesson target) -->
          <div id="lessonRangeDiv" class="hidden mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500">Dars (dan)</label>
              <input type="number" id="broadcastLessonFrom" class="input py-2" min="0" value="1" onchange="updateRecipientCount()">
            </div>
            <div>
              <label class="text-xs text-gray-500">Dars (gacha)</label>
              <input type="number" id="broadcastLessonTo" class="input py-2" min="0" value="4" onchange="updateRecipientCount()">
            </div>
          </div>

          <!-- User Search (for specific) -->
          <div id="userSelectDiv" class="hidden mt-3">
            <input type="text" id="broadcastUserSearch" class="input mb-2" placeholder="üîç Ism yoki telefon..." oninput="searchBroadcastUsers()">
            <div id="broadcastUsersList" class="max-h-32 overflow-y-auto border rounded-lg p-2 space-y-1 bg-white"></div>
            <div class="mt-2">
              <p class="text-xs text-gray-500">Tanlangan: <span id="selectedUsersCount" class="font-medium text-indigo-600">0</span> ta</p>
              <div id="selectedUsersList" class="flex flex-wrap gap-1 mt-1"></div>
            </div>
          </div>

          <!-- Recipient Count -->
          <div class="mt-3 p-3 bg-indigo-50 rounded-lg">
            <p class="text-sm text-indigo-700">
              <span class="font-semibold" id="recipientCount">0</span> ta foydalanuvchiga yuboriladi
            </p>
          </div>
        </div>

        <!-- Variables Help -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100">
          <label class="text-sm font-medium text-amber-800 mb-2 block">üî§ O'zgaruvchilar (bosib qo'shing)</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" onclick="insertVariable('{{ism}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{ism}}</button>
            <button type="button" onclick="insertVariable('{{fio}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{fio}}</button>
            <button type="button" onclick="insertVariable('{{telefon}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{telefon}}</button>
            <button type="button" onclick="insertVariable('{{dars}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{dars}}</button>
          </div>
          <div class="mt-3 text-xs text-amber-600 space-y-1">
            <p><code class="bg-white px-1 rounded">{{ism}}</code> - Foydalanuvchi ismi</p>
            <p><code class="bg-white px-1 rounded">{{fio}}</code> - To'liq ism</p>
            <p><code class="bg-white px-1 rounded">{{telefon}}</code> - Telefon raqami</p>
            <p><code class="bg-white px-1 rounded">{{dars}}</code> - Hozirgi dars raqami</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Message Content -->
      <div class="space-y-4">
        <!-- Message Type -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">üìé Xabar turi</label>
          <select id="broadcastType" class="input" onchange="toggleBroadcastMedia()">
            <option value="text">üìù Faqat matn</option>
            <option value="photo">üñºÔ∏è Rasm + Matn</option>
            <option value="video">üé¨ Video + Matn</option>
            <option value="video_note">üîµ Video xabar (dumaloq)</option>
            <option value="voice">üé§ Ovozli xabar</option>
            <option value="audio">üéµ Audio fayl</option>
            <option value="document">üìÑ Hujjat</option>
          </select>
        </div>

        <!-- Media File ID -->
        <div id="broadcastMediaDiv" class="hidden">
          <label class="text-sm font-medium text-gray-700 mb-2 block">üîó Media File ID</label>
          <input type="text" id="broadcastMediaId" class="input file-id-input" placeholder="File ID ni kiriting...">
          <p class="text-xs text-gray-400 mt-1">üí° Botga media yuboring - avtomatik ID olasiz</p>
        </div>

        <!-- Message Text -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">‚úèÔ∏è Xabar matni</label>
          <div class="flex flex-wrap gap-1 mb-2">
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('b')"><b>B</b></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('i')"><i>I</i></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('u')"><u>U</u></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('s')"><s>S</s></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('spoiler')">üôà Spoiler</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('blockquote')">‚ùù Quote</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('blockquote_expand')">üìñ Expand Quote</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('code')">{ }</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('link')">üîó Link</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('emoji')">‚ú® Emoji</button>
          </div>
          <textarea id="broadcastText" class="input h-36 resize-none" placeholder="Salom, {{ism}}! üëã&#10;&#10;Xabaringizni yozing..." oninput="updatePreview()"></textarea>
          <div class="flex justify-between mt-1">
            <p class="text-xs text-gray-400">HTML teglar: &lt;b&gt;, &lt;i&gt;, &lt;tg-spoiler&gt;, &lt;blockquote expandable&gt;, &lt;tg-emoji&gt;</p>
            <p class="text-xs text-gray-400"><span id="charCount">0</span> belgi</p>
          </div>
        </div>

        <!-- Button -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">üîò Tugma (ixtiyoriy)</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="broadcastBtnText" class="input" placeholder="Tugma matni" oninput="updatePreview()">
            <input type="text" id="broadcastBtnUrl" class="input" placeholder="https://..." oninput="updatePreview()">
          </div>
        </div>

        <!-- Preview -->
        <div class="bg-gray-900 rounded-xl p-4">
          <label class="text-xs font-medium text-gray-400 mb-2 block">üëÅ Oldindan ko'rish</label>
          <div id="broadcastPreview" class="bg-indigo-600/20 rounded-lg p-3 text-white text-sm">
            <p class="text-gray-300 italic">Xabar matni bu yerda ko'rinadi...</p>
          </div>
          <div id="previewButton" class="hidden mt-2">
            <div class="inline-block bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
              <span id="previewBtnText">Tugma</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex flex-col sm:flex-row gap-3">
      <button onclick="sendBroadcast()" class="btn btn-primary flex-1 flex items-center justify-center gap-2">
        <span>üì§</span> Yuborish
      </button>
      <button onclick="previewBroadcast()" class="btn btn-secondary flex items-center justify-center gap-2">
        <span>üëÅ</span> Test (o'zimga)
      </button>
      <button onclick="closeModal('broadcastModal')" class="btn btn-secondary">Bekor qilish</button>
    </div>

    <!-- Progress Indicator -->
    <div id="broadcastProgress" class="hidden mt-4">
      <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
        <div id="broadcastProgressBar" class="bg-indigo-600 h-full transition-all duration-300" style="width: 0%"></div>
      </div>
      <p class="text-sm text-gray-500 mt-2 text-center">
        <span id="broadcastSent">0</span> / <span id="broadcastTotal">0</span> yuborildi
      </p>
    </div>
  </div>
</div>

<!-- Lesson Modal (with Media IDs) -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="lessonModalTitle">üìö Yangi dars</h3>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>
    <form id="lessonForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <input type="hidden" id="lessonId">

      <!-- Basic Info -->
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Dars raqami</label>
            <input type="number" id="lessonNumber" class="input" required min="1">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (soat)</label>
            <input type="number" id="lessonDelay" class="input" value="24" min="0">
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Sarlavha</label>
          <input type="text" id="lessonTitle" class="input" required>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Matn</label>
          <textarea id="lessonText" class="input h-40 resize-none"></textarea>
        </div>
      </div>

      <!-- Media IDs -->
      <div class="space-y-4">
        <div class="p-3 bg-blue-50 rounded-lg mb-4">
          <p class="text-sm text-blue-700">üí° Botga media yuboring - File ID oling. O'sha ID ni qo'ying.</p>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">üé¨ Video File ID</label>
          <input type="text" id="lessonVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üîµ Video xabar File ID (dumaloq)</label>
          <input type="text" id="lessonVideoNoteFileId" class="input file-id-input" placeholder="DQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üéµ Audio File ID</label>
          <input type="text" id="lessonAudioFileId" class="input file-id-input" placeholder="CQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üìé Fayl File ID</label>
          <input type="text" id="lessonDocumentFileId" class="input file-id-input" placeholder="BQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">üñº Rasm File ID</label>
          <input type="text" id="lessonPhotoFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
        </div>
      </div>

      <div class="lg:col-span-2">
        <button type="submit" class="btn btn-primary w-full">üíæ Saqlash</button>
      </div>
    </form>
  </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">üë§ Foydalanuvchi ma'lumotlari</h3>
      <button onclick="closeModal('userDetailModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- User Info -->
      <div>
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-2xl font-bold" id="userDetailAvatar">U</div>
          <div>
            <p class="text-xl font-bold text-gray-800" id="userDetailName">-</p>
            <p class="text-gray-500" id="userDetailUsername">-</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telegram ID</span>
            <span class="font-mono font-medium" id="userDetailTgId">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telefon</span>
            <span class="font-medium" id="userDetailPhone">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Hozirgi dars</span>
            <span class="badge badge-blue" id="userDetailLesson">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Status</span>
            <span id="userDetailStatus">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Ro'yxatdan o'tgan</span>
            <span class="font-medium" id="userDetailCreated">-</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-4 flex gap-2">
          <button onclick="sendMessageToUser()" class="btn btn-primary btn-sm flex-1">üì® Xabar yuborish</button>
        </div>
      </div>

      <!-- CustDev Answers -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">üìù CustDev javoblari</h4>
        <div id="userDetailCustdev" class="space-y-3">
          <p class="text-gray-400 text-center py-4">Javoblar yo'q</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Question Stats Modal -->
<div id="custdevStatsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevStatsTitle">üìä Savol statistikasi</h3>
      <button onclick="closeModal('custdevStatsModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chart -->
      <div>
        <div class="chart-container h-[250px]">
          <canvas id="questionStatsChart"></canvas>
        </div>
      </div>

      <!-- Answers List -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">Javoblar ro'yxati</h4>
        <div id="questionAnswersList" class="max-h-[300px] overflow-y-auto space-y-2">
          <p class="text-gray-400">Yuklanmoqda...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevModalTitle">üìù Yangi savol</h3>
      <button onclick="closeModal('custdevModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">‚úï</button>
    </div>
    <form id="custdevForm" class="space-y-4">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
        <input type="number" id="custdevAfterLesson" class="input" value="1" min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
        <textarea id="custdevQuestion" class="input h-24 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Javob turi</label>
        <select id="custdevType" class="input" onchange="toggleCustdevOptions()">
          <option value="text">Matn (yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      <div id="custdevOptionsDiv" class="hidden">
        <label class="text-sm text-gray-600 mb-1 block">Variantlar (har qator - bitta)</label>
        <textarea id="custdevOptions" class="input h-24 resize-none font-mono" placeholder="18-25&#10;26-35&#10;36-45"></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Field nomi (statistika uchun)</label>
        <input type="text" id="custdevFieldName" class="input" placeholder="age, income, occupation...">
        <p class="text-xs text-gray-400 mt-1">Masalan: age, income, occupation, budget</p>
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let auth = '';
let tgInitData = '';
let allUsers = [];
let allPayments = [];
let allLessons = [];
let allCustDev = [];
let allFeedback = [];
let allConversations = [];
let customEmojiLibrary = [];
let unicodeEmojiLibrary = [];
let emojiLottieInstances = [];
const emojiTgsDataCache = new Map();
let selectedConversationUserId = null;
let selectedReplyToMessageId = null;
let selectedReplyToSnippet = '';
let activeProgrevEditorId = null;
let currentPage = 1;
const perPage = 20;
let paymentFilter = 'completed';
let selectedBroadcastUsers = new Set();
let custdevAnswers = {};

// Charts
let revenueChart, userTypeChart, subscriberGrowthChart;
let ageChart, occupationChart, incomeChart, budgetChart;
let questionStatsChart;

// ========== INITIALIZATION ==========
const isMobile = () => window.matchMedia('(max-width: 768px)').matches;
const chartTickFont = () => ({ size: isMobile() ? 10 : 12, family: 'Inter' });
const chartLayoutPadding = () => isMobile() ? { left: 6, right: 6, top: 6, bottom: 20 } : { left: 0, right: 0, top: 0, bottom: 0 };
const chartMaxXTicks = () => isMobile() ? 5 : 12;
const chartGridColor = () => isMobile() ? 'rgba(148,163,184,0.25)' : 'rgba(148,163,184,0.2)';
const chartTextColor = () => '#64748b';
const chartAccent = () => '#5b7cfa';
const chartAccentSoft = () => 'rgba(91,124,250,0.16)';
const chartMuted = () => 'rgba(148,163,184,0.7)';
const nativeFetch = window.fetch.bind(window);

window.fetch = function(input, init = {}) {
  const url = typeof input === 'string' ? input : (input?.url || '');
  const isApiRequest = url.startsWith('/api/') || url.includes('/api/');
  if (!isApiRequest) return nativeFetch(input, init);

  const nextInit = { ...init };
  const headers = new Headers(nextInit.headers || (input instanceof Request ? input.headers : undefined));
  if (auth) headers.set('Authorization', auth);
  if (tgInitData) headers.set('X-Telegram-Init-Data', tgInitData);
  nextInit.headers = headers;

  return nativeFetch(input, nextInit);
};

document.getElementById('currentDate').textContent = new Date().toLocaleDateString('uz-UZ', {
  year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
});

function blockAccess(message) {
  const title = document.querySelector('#loginModal h1');
  const subtitle = document.querySelector('#loginModal p.text-gray-500');
  const form = document.getElementById('loginForm');
  const error = document.getElementById('loginError');

  if (title) title.textContent = 'Ruxsat yo\'q';
  if (subtitle) subtitle.textContent = 'Bu sahifa faqat admin uchun';
  if (form) {
    form.classList.add('opacity-60', 'pointer-events-none');
    form.querySelectorAll('input, button').forEach((el) => {
      el.disabled = true;
    });
  }
  if (error) {
    error.textContent = message || 'Kirish rad etildi';
    error.classList.remove('hidden');
  }
}

async function initAuth() {
  const tgWebApp = window.Telegram?.WebApp;
  if (tgWebApp?.initData) {
    tgInitData = tgWebApp.initData;
    try {
      tgWebApp.ready();
      tgWebApp.expand();
    } catch (_) {}

    try {
      const r = await fetch('/api/auth/telegram-webapp');
      if (!r.ok) throw new Error('forbidden');
      showDashboard();
      return;
    } catch (e) {
      blockAccess('Siz admin emassiz. WebApp yopildi.');
      return;
    }
  }

  const saved = localStorage.getItem('adminAuth');
  if (saved) {
    auth = saved;
    showDashboard();
  }
}
initAuth();

// Login
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', { headers: { Authorization: auth } });
    if (r.ok) { localStorage.setItem('adminAuth', auth); showDashboard(); }
    else document.getElementById('loginError').classList.remove('hidden');
  } catch(e) { document.getElementById('loginError').classList.remove('hidden'); }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  watchResponsiveTables();
  loadAll();
}

function logout() {
  localStorage.removeItem('adminAuth');
  location.reload();
}

function toggleMobileMenu() {
  const modal = document.getElementById('mobileMenuModal');
  modal.classList.toggle('hidden');
}

// ========== RESPONSIVE TABLE LABELS ==========
function applyTableLabels() {
  document.querySelectorAll('table.responsive-table').forEach(table => {
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      Array.from(tr.children).forEach((cell, i) => {
        if (cell.tagName && cell.tagName.toLowerCase() === 'td' && headers[i]) {
          cell.setAttribute('data-label', headers[i]);
        }
      });
    });
  });
}

function watchResponsiveTables() {
  applyTableLabels();
  document.querySelectorAll('table.responsive-table tbody').forEach(tbody => {
    const observer = new MutationObserver(() => applyTableLabels());
    observer.observe(tbody, { childList: true });
  });
}

// ========== SIDEBAR TOGGLE ==========
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  const icon = document.getElementById('sidebarToggleIcon');

  sidebar.classList.toggle('expanded');
  const isExpanded = sidebar.classList.contains('expanded');

  icon.textContent = isExpanded ? '‚Üê' : '‚Üí';
  mainContent.style.marginLeft = isExpanded ? '200px' : '70px';

  localStorage.setItem('sidebarExpanded', isExpanded);
}

// Initialize sidebar state from localStorage
(function initSidebar() {
  const isExpanded = localStorage.getItem('sidebarExpanded') === 'true';
  if (isExpanded) {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const icon = document.getElementById('sidebarToggleIcon');
    if (sidebar && mainContent && icon) {
      sidebar.classList.add('expanded');
      icon.textContent = '‚Üê';
      mainContent.style.marginLeft = '200px';
    }
  }
})();

// ========== ADVANCED USER FILTERS ==========
let advancedFiltersVisible = false;

function toggleAdvancedFilters() {
  advancedFiltersVisible = !advancedFiltersVisible;
  const panel = document.getElementById('advancedFiltersPanel');
  const label = document.getElementById('advFilterLabel');
  panel.classList.toggle('hidden', !advancedFiltersVisible);
  label.textContent = advancedFiltersVisible ? 'Yopish' : 'Filtrlar';
}

function applyUserFilters() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const status = document.getElementById('userStatusFilter').value;
  const lessonFrom = parseInt(document.getElementById('filterLessonFrom')?.value) || 0;
  const lessonTo = parseInt(document.getElementById('filterLessonTo')?.value) || 999;
  const regDate = document.getElementById('filterRegDate')?.value || 'all';
  const phone = document.getElementById('filterPhone')?.value || 'all';
  const funnelStep = document.getElementById('filterFunnelStep')?.value || 'all';

  // Show/hide custom date range
  const customDateDiv = document.getElementById('customDateRange');
  if (customDateDiv) {
    customDateDiv.classList.toggle('hidden', regDate !== 'custom');
  }

  let filtered = allUsers.filter(u => {
    // Search filter
    if (search) {
      const searchMatch = (u.full_name || '').toLowerCase().includes(search) ||
                         (u.username || '').toLowerCase().includes(search) ||
                         (u.phone || '').includes(search) ||
                         String(u.telegram_id).includes(search);
      if (!searchMatch) return false;
    }

    // Status filter
    if (status === 'paid' && !u.is_paid) return false;
    if (status === 'free' && u.is_paid) return false;
    if (status === 'paid_not_joined' && (!u.is_paid || u.joined_premium_channel)) return false;

    // Lesson range filter
    const lesson = u.current_lesson || 0;
    if (lesson < lessonFrom || lesson > lessonTo) return false;

    // Phone filter
    if (phone === 'has' && !u.phone) return false;
    if (phone === 'no' && u.phone) return false;

    // Funnel step filter
    if (funnelStep !== 'all') {
      const step = parseInt(funnelStep);
      if (step === 1 && (u.funnel_step < 1 || u.funnel_step > 4)) return false;
      if (step === 5 && (u.funnel_step < 5 || u.funnel_step > 7)) return false;
      if (step === 8 && u.funnel_step < 8) return false;
      if (step === 0 && u.funnel_step !== 0) return false;
    }

    // Date filter
    if (regDate !== 'all' && regDate !== 'custom') {
      const created = new Date(u.created_at);
      const now = new Date();
      if (regDate === 'today') {
        if (created.toDateString() !== now.toDateString()) return false;
      } else if (regDate === 'week') {
        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
        if (created < weekAgo) return false;
      } else if (regDate === 'month') {
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        if (created < monthAgo) return false;
      }
    } else if (regDate === 'custom') {
      const fromDate = document.getElementById('filterDateFrom')?.value;
      const toDate = document.getElementById('filterDateTo')?.value;
      const created = new Date(u.created_at);
      if (fromDate && created < new Date(fromDate)) return false;
      if (toDate && created > new Date(toDate + 'T23:59:59')) return false;
    }

    return true;
  });

  // Update filtered count
  document.getElementById('filteredUsersCount').textContent = `(${filtered.length} ta)`;

  // Update active filters info
  let activeCount = 0;
  if (search) activeCount++;
  if (status !== 'all') activeCount++;
  if (lessonFrom > 0 || lessonTo < 999) activeCount++;
  if (regDate !== 'all') activeCount++;
  if (phone !== 'all') activeCount++;
  if (funnelStep !== 'all') activeCount++;

  const infoEl = document.getElementById('activeFiltersInfo');
  if (infoEl) {
    infoEl.textContent = activeCount > 0 ? `${activeCount} ta filtr faol` : '';
  }

  // Render filtered results
  renderFilteredUsers(filtered);
}

function renderFilteredUsers(filtered) {
  const start = (currentPage - 1) * perPage;
  const paginated = filtered.slice(start, start + perPage);

  const tbody = document.getElementById('usersTableBody');
  if (!paginated.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Foydalanuvchilar topilmadi</td></tr>';
    return;
  }

  tbody.innerHTML = paginated.map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid
          ? (u.joined_premium_channel
              ? '<span class="badge badge-green">Premium</span>'
              : '<span class="badge badge-orange" title="To\'lagan, lekin kanalga qo\'shilmagan">To\'lagan ‚ùå</span>')
          : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <div class="flex gap-1">
          <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm" title="Ko'rish">üëÅ</button>
          <button onclick="event.stopPropagation(); deleteUser(${u.telegram_id}, '${(u.full_name || u.username || 'User').replace(/'/g, "\\'")}')" class="btn btn-sm bg-red-50 text-red-600 hover:bg-red-100" title="O'chirish">üóëÔ∏è</button>
        </div>
      </td>
    </tr>
  `).join('');

  // Pagination
  const totalPages = Math.ceil(filtered.length / perPage);
  const pagination = document.getElementById('usersPagination');
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHTML = '';
  for (let i = 1; i <= Math.min(totalPages, 10); i++) {
    paginationHTML += `<button onclick="currentPage=${i}; applyUserFilters()" class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm">${i}</button>`;
  }
  pagination.innerHTML = paginationHTML;
}

function resetUserFilters() {
  document.getElementById('userSearch').value = '';
  document.getElementById('userStatusFilter').value = 'all';
  if (document.getElementById('filterLessonFrom')) document.getElementById('filterLessonFrom').value = '';
  if (document.getElementById('filterLessonTo')) document.getElementById('filterLessonTo').value = '';
  if (document.getElementById('filterRegDate')) document.getElementById('filterRegDate').value = 'all';
  if (document.getElementById('filterPhone')) document.getElementById('filterPhone').value = 'all';
  if (document.getElementById('filterFunnelStep')) document.getElementById('filterFunnelStep').value = 'all';
  if (document.getElementById('filterDateFrom')) document.getElementById('filterDateFrom').value = '';
  if (document.getElementById('filterDateTo')) document.getElementById('filterDateTo').value = '';
  currentPage = 1;
  applyUserFilters();
}

function exportUsers() {
  // Export filtered users to CSV
  const search = document.getElementById('userSearch').value.toLowerCase();
  let filtered = allUsers;
  if (search) {
    filtered = allUsers.filter(u =>
      (u.full_name || '').toLowerCase().includes(search) ||
      (u.phone || '').includes(search)
    );
  }

  const csv = [
    ['ID', 'Ism', 'Username', 'Telefon', 'Dars', 'Status', 'Sana'].join(','),
    ...filtered.map(u => [
      u.telegram_id,
      `"${u.full_name || ''}"`,
      `"${u.username || ''}"`,
      u.phone || '',
      u.current_lesson || 0,
      u.is_paid ? 'Premium' : 'Free',
      u.created_at?.split('T')[0] || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
}

// ========== BROADCAST ENHANCEMENTS ==========
function insertVariable(variable) {
  const textarea = document.getElementById('broadcastText');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  textarea.value = text.substring(0, start) + variable + text.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
  updatePreview();
}

function applyBroadcastFormat(kind) {
  if (kind === 'link') {
    insertLinkTemplateTo('broadcastText');
    updatePreview();
    return;
  }
  if (kind === 'emoji') {
    insertCustomEmojiTemplateTo('broadcastText');
    updatePreview();
    return;
  }
  wrapTextareaSelection('broadcastText', kind);
  updatePreview();
}

function updatePreview() {
  const text = document.getElementById('broadcastText').value || '';
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;

  // Update char count
  document.getElementById('charCount').textContent = text.length;

  // Preview with sample data
  let preview = text
    .replace(/\{\{ism\}\}/gi, 'Ali')
    .replace(/\{\{fio\}\}/gi, 'Ali Valiyev')
    .replace(/\{\{telefon\}\}/gi, '+998901234567')
    .replace(/\{\{dars\}\}/gi, '3')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/&lt;b&gt;/g, '<b>')
    .replace(/&lt;\/b&gt;/g, '</b>')
    .replace(/&lt;i&gt;/g, '<i>')
    .replace(/&lt;\/i&gt;/g, '</i>')
    .replace(/\n/g, '<br>');

  document.getElementById('broadcastPreview').innerHTML = preview || '<p class="text-gray-300 italic">Xabar matni bu yerda ko\'rinadi...</p>';

  // Preview button
  const previewBtn = document.getElementById('previewButton');
  if (btnText && btnUrl) {
    document.getElementById('previewBtnText').textContent = btnText;
    previewBtn.classList.remove('hidden');
  } else {
    previewBtn.classList.add('hidden');
  }
}

function updateRecipientCount() {
  const target = document.getElementById('broadcastTarget').value;
  let count = 0;

  // Show/hide lesson range div
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }

  if (target === 'all') {
    count = allUsers.length;
  } else if (target === 'paid') {
    count = allUsers.filter(u => u.is_paid).length;
  } else if (target === 'free') {
    count = allUsers.filter(u => !u.is_paid).length;
  } else if (target === 'active') {
    count = allUsers.filter(u => u.current_lesson > 0 && !u.is_paid).length;
  } else if (target === 'lesson') {
    const from = parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0;
    const to = parseInt(document.getElementById('broadcastLessonTo')?.value) || 999;
    count = allUsers.filter(u => u.current_lesson >= from && u.current_lesson <= to).length;
  } else if (target === 'specific') {
    count = selectedBroadcastUsers.length;
  }

  document.getElementById('recipientCount').textContent = count;
}

async function previewBroadcast() {
  // Send test message to admin
  const text = document.getElementById('broadcastText').value;
  if (!text) {
    alert('Xabar matnini kiriting');
    return;
  }

  try {
    await fetch('/api/broadcast/test', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        type: document.getElementById('broadcastType').value,
        media_id: document.getElementById('broadcastMediaId').value,
        button: {
          text: document.getElementById('broadcastBtnText').value,
          url: document.getElementById('broadcastBtnUrl').value
        }
      })
    });
    alert('‚úÖ Test xabar yuborildi (o\'zingizga)');
  } catch (e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.sidebar-item[data-tab], .mobile-nav-item[data-tab]').forEach(item => {
  item.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

// ========== REVENUE PERIOD TABS ==========
let currentRevenuePeriod = 'week';
document.querySelectorAll('button[data-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentRevenuePeriod = this.dataset.period;
    renderRevenueChart(currentRevenuePeriod);
  });
});

// ========== SUBSCRIBER GROWTH PERIOD TABS ==========
let currentGrowthPeriod = 'day';
document.querySelectorAll('button[data-growth-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-growth-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentGrowthPeriod = this.dataset.growthPeriod;
    renderSubscriberGrowthChart(currentGrowthPeriod);
  });
});

function showTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');

  document.querySelectorAll('.sidebar-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.sidebar-item[data-tab="' + tab + '"]')?.classList.add('active');

  document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.mobile-nav-item[data-tab="' + tab + '"]')?.classList.add('active');

  // Load tab-specific data
  if (tab === 'progrev') {
    loadProgrevSettings();
    initProgrevFormatEditors();
    loadCustomEmojiLibrary();
  }
  if (tab === 'custdev') loadFeedback();
  if (tab === 'conversations') {
    loadConversations();
    loadCustomEmojiLibrary();
  }
  if (tab === 'renewal') loadRenewalSettings();
  if (tab === 'settings') loadSettingsForm();
  if (tab === 'analytics') loadAnalyticsData();
  if (tab === 'referrals') loadReferralData();
  if (tab === 'audit') loadAuditLogs();
}

async function loadSettingsForm() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    // Channel settings
    document.getElementById('settingPremiumChannel').value = data.premium_channel_id || '';
    document.getElementById('settingFreeChannel').value = data.free_channel_id || '';
    document.getElementById('settingFreeChannelLink').value = data.free_channel_link || '';
    document.getElementById('settingRequireSub').value = data.require_subscription_before_lesson || 0;

    // Subscription bypass settings
    document.getElementById('settingSubBypassEnabled').checked = data.subscription_bypass_enabled === 'true';
    document.getElementById('settingSubBypassAttempts').value = data.subscription_bypass_attempts || 3;

    // Payment settings - FIXED: load saved values
    document.getElementById('settingPayme').checked = data.payme_enabled !== false;
    document.getElementById('settingClick').checked = data.click_enabled !== false;

    // Price settings - load and calculate discounts
    if (data.price_1m) {
      document.getElementById('settingPrice1m').value = Math.round(data.price_1m / 100);
      // Auto-calculate discounted prices for display
      calculateDiscountedPrices();
    }
    // Also show saved values if different (for backward compatibility)
    if (data.price_3m) document.getElementById('settingPrice3m').value = Math.round(data.price_3m / 100);
    if (data.price_6m) document.getElementById('settingPrice6m').value = Math.round(data.price_6m / 100);
    if (data.price_12m) document.getElementById('settingPrice12m').value = Math.round(data.price_12m / 100);

    // Inactivity reminder settings
    document.getElementById('settingInactivityEnabled').checked = data.inactivity_reminder_enabled === 'true';
    document.getElementById('settingInactivityReminder1').value = data.inactivity_reminder_1 || '';
    document.getElementById('settingInactivityReminder2').value = data.inactivity_reminder_2 || '';

    // Referral system settings
    document.getElementById('settingReferralEnabled').checked = data.referral_enabled === 'true';
    document.getElementById('settingReferralCount').value = data.referral_required_count || 3;
    document.getElementById('settingReferralDiscount').value = data.referral_discount_percent || 50;

    // Referral offer settings
    document.getElementById('settingReferralOfferEnabled').checked = data.referral_offer_enabled === 'true';
    document.getElementById('settingReferralOfferDelay').value = data.referral_offer_delay_hours || 24;
    document.getElementById('settingReferralOfferMessage').value = data.referral_offer_message || '';

  } catch(e) { console.error('loadSettingsForm error:', e); }
}

// ========== PROMO CODES ==========
let promoCodes = [];

async function loadPromoCodes() {
  try {
    promoCodes = await (await fetch('/api/promo-codes', { headers: { Authorization: auth } })).json();
    renderPromoCodes();
  } catch(e) {
    console.error('loadPromoCodes error:', e);
  }
}

function renderPromoCodes() {
  const tbody = document.getElementById('promoCodesTable');
  if (!promoCodes || promoCodes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-400">Promo kodlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = promoCodes.map(p => {
    const isActive = p.is_active;
    const isExpired = p.valid_until && new Date(p.valid_until) < new Date();
    const limitReached = p.max_uses && p.current_uses >= p.max_uses;

    let status = 'badge-green';
    let statusText = 'Faol';
    if (!isActive) { status = 'badge-gray'; statusText = 'O\'chirilgan'; }
    else if (isExpired) { status = 'badge-red'; statusText = 'Muddati o\'tgan'; }
    else if (limitReached) { status = 'badge-orange'; statusText = 'Limit tugagan'; }

    const validUntil = p.valid_until ? new Date(p.valid_until).toLocaleDateString('uz') : 'Cheksiz';

    return `
      <tr class="table-row">
        <td class="py-3 font-mono font-semibold">${p.code}</td>
        <td class="py-3">${p.discount_percent}%</td>
        <td class="py-3">${p.current_uses || 0}</td>
        <td class="py-3">${p.max_uses || '‚àû'}</td>
        <td class="py-3">${validUntil}</td>
        <td class="py-3"><span class="badge ${status}">${statusText}</span></td>
        <td class="py-3">
          <button onclick="togglePromoCode(${p.id}, ${!p.is_active})" class="text-sm ${p.is_active ? 'text-red-500' : 'text-green-500'} hover:underline">
            ${p.is_active ? "O'chirish" : 'Yoqish'}
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

function showCreatePromoModal() {
  document.getElementById('promoModal').classList.remove('hidden');
  document.getElementById('promoModal').classList.add('flex');
  document.getElementById('promoCode').value = '';
  document.getElementById('promoDiscount').value = '';
  document.getElementById('promoMaxUses').value = '';
  document.getElementById('promoValidFrom').value = '';
  document.getElementById('promoValidUntil').value = '';
  document.getElementById('promoMinPlan').value = '';
}

function closePromoModal() {
  document.getElementById('promoModal').classList.add('hidden');
  document.getElementById('promoModal').classList.remove('flex');
}

async function createPromoCode() {
  const code = document.getElementById('promoCode').value.trim().toUpperCase();
  const discountPercent = parseInt(document.getElementById('promoDiscount').value);
  const maxUses = document.getElementById('promoMaxUses').value ? parseInt(document.getElementById('promoMaxUses').value) : null;
  const validFrom = document.getElementById('promoValidFrom').value || null;
  const validUntil = document.getElementById('promoValidUntil').value || null;
  const minPlan = document.getElementById('promoMinPlan').value || null;

  if (!code || !discountPercent) {
    return alert('Kod va chegirma foizini kiriting');
  }

  if (discountPercent < 1 || discountPercent > 100) {
    return alert('Chegirma 1-100% orasida bo\'lishi kerak');
  }

  try {
    const res = await fetch('/api/promo-codes', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, discountPercent, maxUses, validFrom, validUntil, minPlan })
    });

    const data = await res.json();
    if (data.error) {
      return alert('Xatolik: ' + data.error);
    }

    closePromoModal();
    await loadPromoCodes();
    alert('Promo kod yaratildi!');
  } catch(e) {
    alert('Xatolik: ' + e.message);
  }
}

async function togglePromoCode(id, isActive) {
  try {
    await fetch('/api/promo-codes/' + id, {
      method: 'PUT',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_active: isActive })
    });
    await loadPromoCodes();
  } catch(e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== LOAD DATA ==========
async function loadAll() {
  await Promise.all([loadStats(), loadUsers(), loadPayments(), loadLessons(), loadCustDev(), loadCustdevAnswers(), loadFeedback(), loadConversations(), loadCustomEmojiLibrary(), loadRenewalSettings(), loadSettingsForm(), loadMediaLibrary(), loadPromoCodes()]);
  renderCharts();
  renderTodayStats();
}

async function loadStats() {
  try {
    const stats = await (await fetch('/api/stats', { headers: { Authorization: auth } })).json();

    document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('statPaidUsers').textContent = stats.paidUsers || 0;
    document.getElementById('statRevenue').textContent = fmtMoney(stats.totalRevenue || 0);

    const conv = stats.totalUsers > 0 ? Math.round((stats.paidUsers / stats.totalUsers) * 100) : 0;
    document.getElementById('statConversion').textContent = conv + '%';

    document.getElementById('rightPanelRevenue').textContent = fmtMoney(stats.totalRevenue || 0);
    document.getElementById('rightPanelMonthRevenue').textContent = fmtMoney(stats.monthRevenue || 0);
    document.getElementById('totalRevenueDisplay').textContent = fmtMoney(stats.totalRevenue || 0);

    document.getElementById('activeUsersCount').textContent = stats.activeUsers || 0;
    document.getElementById('paidUsersCount').textContent = stats.paidUsers || 0;
    document.getElementById('completedUsersCount').textContent = stats.completedUsers || 0;

    // Load source and referral stats
    loadSourceStats();
    loadReferralStats();

  } catch(e) { console.error('loadStats error:', e); }
}

async function loadSourceStats() {
  try {
    const data = await (await fetch('/api/analytics/sources', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('sourceStatsContainer');

    if (!data.sources || data.sources.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-400 py-4">Hozircha ma\'lumot yo\'q</div>';
      return;
    }

    const total = data.sources.reduce((sum, s) => sum + s.total_users, 0);

    container.innerHTML = '<div class="space-y-3">' + data.sources.map(source => {
      const percent = total > 0 ? Math.round((source.total_users / total) * 100) : 0;
      const sourceName = source.source === 'direct' ? 'üåê Direct (havolasiz)' :
                         source.source === 'instagram' ? 'üì∏ Instagram' :
                         source.source === 'telegram' ? 'üì± Telegram' :
                         source.source === 'facebook' ? 'üë§ Facebook' :
                         source.source === 'youtube' ? 'üé¨ YouTube' :
                         source.source === 'tiktok' ? 'üéµ TikTok' :
                         'üîó ' + source.source;

      return `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2 min-w-0">
            <span class="text-sm truncate">${sourceName}</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs text-gray-400">${source.paid_users} to'lagan</span>
            <span class="text-sm font-medium">${source.total_users}</span>
            <span class="text-xs text-gray-400">(${percent}%)</span>
          </div>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2">
          <div class="bg-indigo-500 h-2 rounded-full" style="width: ${percent}%"></div>
        </div>
      `;
    }).join('') + '</div>';

  } catch(e) {
    console.error('loadSourceStats error:', e);
    document.getElementById('sourceStatsContainer').innerHTML = '<div class="text-center text-red-400 py-4">Xatolik</div>';
  }
}

async function loadReferralStats() {
  try {
    const data = await (await fetch('/api/analytics/referrals', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('referralStatsContainer');

    const stats = data.stats || { total_referrers: 0, total_referrals: 0, qualified_referrals: 0, discounts_used: 0 };
    const leaderboard = data.leaderboard || [];

    let html = `
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-indigo-600">${stats.total_referrers}</p>
          <p class="text-xs text-gray-500">Taklif qilganlar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-green-600">${stats.qualified_referrals}</p>
          <p class="text-xs text-gray-500">Faol referallar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-blue-600">${stats.total_referrals}</p>
          <p class="text-xs text-gray-500">Jami referallar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-orange-600">${stats.discounts_used}</p>
          <p class="text-xs text-gray-500">Chegirma olganlar</p>
        </div>
      </div>
    `;

    if (leaderboard.length > 0) {
      html += `
        <p class="text-sm font-medium text-gray-600 mb-2">üèÜ Top referalchilar:</p>
        <div class="space-y-2">
          ${leaderboard.slice(0, 5).map((u, i) => `
            <div class="flex items-center justify-between text-sm">
              <span>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1) + '.'} ${u.full_name || u.username || u.telegram_id}</span>
              <span class="font-medium text-indigo-600">${u.referral_count} ta</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    container.innerHTML = html;

  } catch(e) {
    console.error('loadReferralStats error:', e);
    document.getElementById('referralStatsContainer').innerHTML = '<div class="text-center text-red-400 py-4">Xatolik</div>';
  }
}

function renderTodayStats() {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  // Set today's date text
  const dateEl = document.getElementById('todayDateText');
  if (dateEl) {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    dateEl.textContent = today.toLocaleDateString('uz-UZ', options);
  }

  // Calculate today's new users
  const todayUsers = allUsers.filter(u => {
    if (!u.created_at) return false;
    return u.created_at.split('T')[0] === todayStr;
  });
  const todayNewUsersEl = document.getElementById('todayNewUsers');
  if (todayNewUsersEl) todayNewUsersEl.textContent = todayUsers.length;

  // Calculate yesterday for comparison
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  const yesterdayUsers = allUsers.filter(u => {
    if (!u.created_at) return false;
    return u.created_at.split('T')[0] === yesterdayStr;
  });

  const changeEl = document.getElementById('todayNewUsersChange');
  if (changeEl) {
    const diff = todayUsers.length - yesterdayUsers.length;
    if (diff > 0) changeEl.innerHTML = '<span class="text-green-300">‚Üë ' + diff + '</span> kechaga nisbatan';
    else if (diff < 0) changeEl.innerHTML = '<span class="text-red-300">‚Üì ' + Math.abs(diff) + '</span> kechaga nisbatan';
    else changeEl.textContent = 'Kecha bilan teng';
  }

  // Calculate today's payments
  const todayPayments = allPayments.filter(p => {
    if (!p.created_at || p.status !== 'completed') return false;
    return p.created_at.split('T')[0] === todayStr;
  });
  const todayPaymentsEl = document.getElementById('todayPayments');
  if (todayPaymentsEl) todayPaymentsEl.textContent = todayPayments.length;

  const todayPaymentsAmount = todayPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
  const todayPaymentsAmountEl = document.getElementById('todayPaymentsAmount');
  if (todayPaymentsAmountEl) todayPaymentsAmountEl.textContent = fmtMoney(todayPaymentsAmount);

  // Calculate active users today (users with activity today)
  const todayActiveUsers = allUsers.filter(u => {
    if (!u.last_activity) return false;
    return u.last_activity.split('T')[0] === todayStr;
  });
  const todayLessonsWatchedEl = document.getElementById('todayLessonsWatched');
  if (todayLessonsWatchedEl) todayLessonsWatchedEl.textContent = todayActiveUsers.length;

  // Calculate today's feedback
  const todayFeedbackList = allFeedback.filter(f => {
    if (!f.created_at) return false;
    return f.created_at.split('T')[0] === todayStr;
  });
  const todayFeedbackEl = document.getElementById('todayFeedback');
  if (todayFeedbackEl) todayFeedbackEl.textContent = todayFeedbackList.length;

  const todayPositive = todayFeedbackList.filter(f => f.feedback_type === 'liked').length;
  const todayPositiveEl = document.getElementById('todayFeedbackPositive');
  if (todayPositiveEl) todayPositiveEl.textContent = todayPositive + ' ijobiy';
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users', { headers: { Authorization: auth } })).json();
    allUsers = data;
    renderUsers();
    renderRecentUsers();
    renderRecentActivity();
  } catch(e) { console.error('loadUsers error:', e); }
}

async function loadPayments() {
  try {
    const data = await (await fetch('/api/payments?all=true', { headers: { Authorization: auth } })).json();
    allPayments = data;
    renderPayments();
    renderRecentPayments();
    renderPaymentStats();
  } catch(e) { console.error('loadPayments error:', e); }
}

async function loadLessons() {
  try {
    const data = await (await fetch('/api/lessons', { headers: { Authorization: auth } })).json();
    allLessons = data.sort((a, b) => a.lesson_number - b.lesson_number);
    renderLessons();
    renderLessonProgress();
    renderLibrary();
  } catch(e) { console.error('loadLessons error:', e); }
}

async function loadCustDev() {
  try {
    const data = await (await fetch('/api/custdev', { headers: { Authorization: auth } })).json();
    allCustDev = data;
    renderCustDev();
  } catch(e) { console.error('loadCustDev error:', e); }
}

async function loadCustdevAnswers() {
  try {
    const data = await (await fetch('/api/custdev/answers', { headers: { Authorization: auth } })).json();
    custdevAnswers = data;
    renderCustDevStats();
  } catch(e) { console.error('loadCustdevAnswers error:', e); }
}

async function loadFeedback() {
  try {
    const response = await fetch('/api/feedback', { headers: { Authorization: auth } });
    if (!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    const data = await response.json();
    allFeedback = Array.isArray(data) ? data : [];
    renderFeedback();
  } catch(e) {
    console.error('loadFeedback error:', e);
    const container = document.getElementById('feedbackList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

async function loadConversations() {
  try {
    const response = await fetch('/api/conversations?limit=500', { headers: { Authorization: auth } });
    if (!response.ok) throw new Error('API error: ' + response.status);
    const data = await response.json();
    allConversations = Array.isArray(data) ? data : [];
    renderConversationUsers();
  } catch (e) {
    console.error('loadConversations error:', e);
    const usersContainer = document.getElementById('convUsersList');
    const messagesContainer = document.getElementById('convMessagesList');
    if (usersContainer) usersContainer.innerHTML = '<div class="p-4 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    if (messagesContainer) messagesContainer.innerHTML = '<div class="p-4 text-center text-red-500">Xatolik: ' + e.message + '</div>';
  }
}

async function loadCustomEmojiLibrary(forceRefresh = false) {
  const listEl = document.getElementById('emojiBankList');
  const countEl = document.getElementById('emojiBankCount');
  const progrevListEl = document.getElementById('emojiBankProgrevList');
  const progrevCountEl = document.getElementById('emojiBankProgrevCount');
  try {
    const refreshFlag = forceRefresh ? '1' : '0';
    const [customResp, unicodeResp] = await Promise.all([
      fetch('/api/custom-emojis?limit=400&refresh=' + refreshFlag, { headers: { Authorization: auth } }),
      fetch('/api/unicode-emojis?limit=4000&top=180', { headers: { Authorization: auth } })
    ]);
    if (!customResp.ok) throw new Error('Custom emoji API error: ' + customResp.status);
    if (!unicodeResp.ok) throw new Error('Unicode emoji API error: ' + unicodeResp.status);
    const customData = await customResp.json();
    const unicodeData = await unicodeResp.json();
    customEmojiLibrary = Array.isArray(customData) ? customData : [];
    unicodeEmojiLibrary = Array.isArray(unicodeData) ? unicodeData : [];
    renderCustomEmojiLibrary();
  } catch (e) {
    console.error('loadCustomEmojiLibrary error:', e);
    customEmojiLibrary = [];
    unicodeEmojiLibrary = [];
    if (countEl) countEl.textContent = '0 ta emoji';
    if (listEl) listEl.innerHTML = '<div class="text-xs text-red-500">Emoji bank yuklanmadi</div>';
    if (progrevCountEl) progrevCountEl.textContent = '0 ta emoji';
    if (progrevListEl) progrevListEl.innerHTML = '<div class="text-xs text-red-500">Emoji bank yuklanmadi</div>';
  }
}

function renderCustomEmojiLibrary() {
  clearEmojiLottiePreviews();
  renderCustomEmojiBankInto('emojiBankList', 'emojiBankCount', false);
  renderCustomEmojiBankInto('emojiBankProgrevList', 'emojiBankProgrevCount', true);
  initEmojiLottiePreviews();
}

function clearEmojiLottiePreviews() {
  emojiLottieInstances.forEach((inst) => {
    try { inst.destroy(); } catch (_) {}
  });
  emojiLottieInstances = [];
}

async function initEmojiLottiePreviews() {
  if (typeof window.lottie === 'undefined' || typeof window.pako === 'undefined') return;
  const targets = Array.from(document.querySelectorAll('[data-emoji-tgs-file-id]'));
  for (const container of targets) {
    const fileId = String(container.dataset.emojiTgsFileId || '').trim();
    if (!fileId || container.dataset.emojiLoaded === '1') continue;

    try {
      let animationData = emojiTgsDataCache.get(fileId);
      if (!animationData) {
        const response = await fetch('/api/telegram-file/' + encodeURIComponent(fileId), { headers: { Authorization: auth } });
        if (!response.ok) throw new Error('TGS load failed');
        const ab = await response.arrayBuffer();
        const uint8 = new Uint8Array(ab);
        const jsonText = window.pako.ungzip(uint8, { to: 'string' });
        animationData = JSON.parse(jsonText);
        emojiTgsDataCache.set(fileId, animationData);
      }

      container.innerHTML = '';
      const inst = window.lottie.loadAnimation({
        container,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        animationData
      });
      emojiLottieInstances.push(inst);
      container.dataset.emojiLoaded = '1';
    } catch (e) {
      // fallback text saqlanadi
      container.dataset.emojiLoaded = '0';
    }
  }
}

function renderCustomEmojiBankInto(listId, countId, compact = false) {
  const listEl = document.getElementById(listId);
  const countEl = document.getElementById(countId);
  if (!listEl) return;

  const customItems = (Array.isArray(customEmojiLibrary) ? customEmojiLibrary : [])
    .map((item) => {
      const id = String(item?.custom_emoji_id || '').replace(/\D/g, '');
      if (!id) return null;
      return { ...item, _kind: 'custom', _emojiId: id };
    })
    .filter(Boolean);

  const unicodeItems = (Array.isArray(unicodeEmojiLibrary) ? unicodeEmojiLibrary : [])
    .map((item) => {
      const emoji = String(item?.emoji || '').trim();
      if (!emoji) return null;
      return { ...item, _kind: 'unicode', _unicodeEmoji: emoji };
    })
    .filter(Boolean);

  const items = [...customItems, ...unicodeItems].sort((a, b) => {
    const ad = new Date(a.last_seen_at || 0).getTime();
    const bd = new Date(b.last_seen_at || 0).getTime();
    return bd - ad;
  });

  if (countEl) countEl.textContent = `${items.length} ta emoji`;

  if (!items.length) {
    listEl.innerHTML = '<div class="text-xs text-gray-400">Hozircha custom emoji topilmadi</div>';
    return;
  }

  listEl.innerHTML = items.map((item) => {
    const isUnicode = item._kind === 'unicode';
    const emojiId = item._emojiId || '';
    const unicodeChar = String(item._unicodeEmoji || 'üôÇ');
    const emojiChar = isUnicode ? unicodeChar : String(item.emoji_char || '‚ú®').slice(0, 2);
    // Video custom emoji: file_id bilan video preview.
    // Animated TGS custom emoji: lottie bilan jonli render, bo'lmasa text fallback.
    const mediaFileId = isUnicode ? '' : (item.is_video ? (item.file_id || '') : (item.thumb_file_id || ''));
    const previewSrc = mediaFileId ? `/api/telegram-file/${encodeURIComponent(mediaFileId)}` : '';
    const badge = isUnicode ? 'unicode' : (item.is_video ? 'video anim' : (item.is_animated ? 'anim (live)' : 'static'));
    const seen = Number(item.seen_count || 0);

    const fallbackHtml = `<div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-base">${escapeHtml(emojiChar)}</div>`;
    let previewHtml = fallbackHtml;
    if (previewSrc) {
      if (item.is_video) {
        previewHtml = `<video src="${previewSrc}" autoplay muted loop playsinline class="w-8 h-8 rounded-lg object-cover bg-gray-100" onerror="this.outerHTML='${escapeJsString(fallbackHtml)}'"></video>`;
      } else if (!item.is_animated) {
        previewHtml = `<img src="${previewSrc}" alt="${escapeHtml(emojiChar)}" class="w-8 h-8 rounded-lg object-cover bg-gray-100" loading="lazy" onerror="this.outerHTML='${escapeJsString(fallbackHtml)}'" />`;
      }
    }
    if (!isUnicode && item.is_animated && !item.is_video && item.file_id) {
      previewHtml = `<div data-emoji-tgs-file-id="${escapeHtml(item.file_id)}" class="w-8 h-8 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">${escapeHtml(emojiChar)}</div>`;
    }

    if (compact) {
      const removeBtn = `<button type="button" class="emoji-trash-btn"
             onclick="removeEmojiFromLibrary('${isUnicode ? 'unicode' : 'custom'}', '${escapeJsString(isUnicode ? unicodeChar : emojiId)}', event)" title="Emoji o'chirish">üóë</button>`;
      return `
        <div class="emoji-chip">
          <button type="button" class="emoji-main-btn"
            onclick="${isUnicode ? `insertUnicodeEmojiFromLibrary('${escapeJsString(unicodeChar)}')` : `insertCustomEmojiFromLibrary('${emojiId}')`}"
            title="${escapeHtml(isUnicode ? emojiChar : emojiId)}">
            <div class="flex items-center gap-2 justify-center">
              ${previewHtml}
              <span class="text-sm font-semibold text-gray-700">${escapeHtml(emojiChar)}</span>
            </div>
          </button>
          <div class="mt-2 flex justify-end">${removeBtn}</div>
        </div>
      `;
    }

    const removeBtn = `<button type="button" class="ml-2 px-2 py-1 rounded-md border border-red-200 text-red-500 hover:bg-red-50 hover:border-red-300 text-xs"
           onclick="removeEmojiFromLibrary('${isUnicode ? 'unicode' : 'custom'}', '${escapeJsString(isUnicode ? unicodeChar : emojiId)}', event)">üóë</button>`;
    return `
      <div class="w-full rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 px-2 py-2">
        <button type="button" class="w-full text-left"
          onclick="${isUnicode ? `insertUnicodeEmojiFromLibrary('${escapeJsString(unicodeChar)}')` : `insertCustomEmojiFromLibrary('${emojiId}')`}">
          <div class="flex items-center gap-2">
            ${previewHtml}
            <div class="min-w-0 flex-1">
              <p class="text-xs font-medium text-gray-700 truncate">${escapeHtml(emojiChar)} ‚Ä¢ ${escapeHtml(isUnicode ? 'unicode' : emojiId)}</p>
              <p class="text-[11px] text-gray-500">${escapeHtml(badge)} ‚Ä¢ ishlatilgan: ${seen}</p>
            </div>
          </div>
        </button>
        <div class="mt-2 flex justify-end">${removeBtn}</div>
      </div>
    `;
  }).join('');

}

function renderConversationUsers() {
  const usersContainer = document.getElementById('convUsersList');
  if (!usersContainer) return;

  const byUser = new Map();
  allConversations.forEach(m => {
    const current = byUser.get(m.telegram_id);
    if (!current) {
      byUser.set(m.telegram_id, m);
    } else {
      const oldTime = new Date(current.created_at).getTime();
      const newTime = new Date(m.created_at).getTime();
      if (newTime > oldTime) byUser.set(m.telegram_id, m);
    }
  });

  const query = (document.getElementById('convSearch')?.value || '').toLowerCase().trim();
  const users = Array.from(byUser.values())
    .filter(u => {
      if (!query) return true;
      const name = (u.full_name || '').toLowerCase();
      const username = (u.username || '').toLowerCase();
      const tg = String(u.telegram_id || '');
      return name.includes(query) || username.includes(query) || tg.includes(query);
    })
    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  if (!users.length) {
    usersContainer.innerHTML = '<div class="p-4 text-center text-gray-400">Suhbatlar topilmadi</div>';
    return;
  }

  usersContainer.innerHTML = users.map(u => {
    const name = u.full_name || u.username || ('User ' + u.telegram_id);
    const username = u.username ? '@' + u.username : '';
    const initial = (name || 'U').charAt(0).toUpperCase();
    const activeClass = String(selectedConversationUserId) === String(u.telegram_id) ? 'active' : '';
    const preview = getConversationPreview(u);
    return `
      <button class="conv-user-item ${activeClass}" onclick="openConversationUser(${u.telegram_id})">
        <div class="flex items-start gap-3">
          <div class="conv-avatar">${escapeHtml(initial)}</div>
          <div class="min-w-0 flex-1">
            <p class="font-medium text-gray-800 truncate">${escapeHtml(name)}</p>
            <p class="text-xs text-gray-400 truncate">${escapeHtml(username)} ‚Ä¢ ${u.telegram_id}</p>
            <p class="text-xs text-gray-500 mt-1 truncate">${escapeHtml(preview)}</p>
          </div>
          <span class="text-[10px] text-gray-400">${timeAgo(u.created_at)}</span>
        </div>
      </button>
    `;
  }).join('');

  if (!selectedConversationUserId && users[0]) {
    openConversationUser(users[0].telegram_id);
  }
}

async function openConversationUser(telegramId) {
  selectedConversationUserId = telegramId;
  renderConversationUsers();

  const header = document.getElementById('convSelectedUser');
  const headerMeta = document.getElementById('convSelectedUserMeta');
  const headerAvatar = document.getElementById('convHeaderAvatar');
  const messagesContainer = document.getElementById('convMessagesList');
  if (!messagesContainer) return;

  try {
    const res = await fetch('/api/conversations/' + telegramId + '?limit=400', { headers: { Authorization: auth } });
    if (!res.ok) throw new Error('API error: ' + res.status);
    const rows = await res.json();
    const messages = Array.isArray(rows) ? rows : [];

    const user = allUsers.find(u => String(u.telegram_id) === String(telegramId));
    const userName = user?.full_name || user?.username || ('User ' + telegramId);
    if (header) header.textContent = userName;
    if (headerAvatar) headerAvatar.textContent = (userName || 'U').charAt(0).toUpperCase();
    fillConversationUserInfo(user || { telegram_id: telegramId, username: null, phone: null, current_lesson: 0, is_paid: false, full_name: userName });

    if (!messages.length) {
      messagesContainer.innerHTML = '<div class="text-center text-gray-400">Xabarlar yoq</div>';
      return;
    }

    const latest = messages[0];
    const latestMeta = normalizeMessageMeta(latest.meta);
    if (headerMeta) {
      const username = user?.username ? '@' + user.username : 'username yoq';
      const lesson = latestMeta.current_lesson ?? '-';
      const funnel = latestMeta.funnel_step ?? '-';
      headerMeta.textContent = `${username} ‚Ä¢ ID ${telegramId} ‚Ä¢ dars ${lesson} ‚Ä¢ step ${funnel}`;
    }

    const timeline = messages.slice().reverse();
    messagesContainer.innerHTML = timeline
      .map((m, idx) => {
        const metaObj = normalizeMessageMeta(m.meta);
        const text = formatConversationMessage(m, metaObj);
        const mediaPreview = buildMediaPreviewHtml(m, metaObj);
        const isAction = m.message_type === 'callback';
        const isOutgoing = m.message_type === 'admin_outgoing';
        const isBotOutgoing = String(m.message_type || '').startsWith('bot_outgoing_');
        const isIncomingUser = !isOutgoing && !isBotOutgoing;
        const rowClass = isOutgoing ? 'user' : 'incoming';
        const bubbleClass = isOutgoing ? 'user' : '';
        const tag = isOutgoing
          ? 'üßë‚Äçüíº admin'
          : (isBotOutgoing ? 'ü§ñ bot' : (isAction ? 'üîò button' : (m.message_type || 'text')));
        const stepInfo = `d:${metaObj.current_lesson ?? '-'} s:${metaObj.funnel_step ?? '-'}`;
        let replyContext = '';
        if (isIncomingUser) {
          for (let i = idx - 1; i >= 0; i--) {
            const prev = timeline[i];
            const prevType = String(prev.message_type || '');
            if (prevType === 'admin_outgoing' || prevType.startsWith('bot_outgoing_')) {
              const prevText = formatConversationMessage(prev, normalizeMessageMeta(prev.meta));
              replyContext = prevText ? prevText.slice(0, 90) : '';
              break;
            }
          }
        }
        const messageId = metaObj.message_id || null;
        return `
          <div class="tg-bubble-row ${rowClass}">
            <div class="tg-bubble ${bubbleClass} ${isAction ? 'action' : ''}" ${messageId ? `data-message-id="${messageId}" onclick="setConversationReplyTo(${messageId}, '${escapeJsString(text.slice(0, 120))}')"` : ''} style="${messageId ? 'cursor:pointer;' : ''}">
              <span class="tg-tag">${escapeHtml(tag)}</span>
              ${replyContext ? `<p class="text-[11px] text-gray-500 mb-1">‚Ü™ Javob berilgan xabar: ${escapeHtml(replyContext)}</p>` : ''}
              <p class="text-sm text-gray-800 whitespace-pre-wrap break-words">${escapeHtml(text)}</p>
              ${mediaPreview}
              <div class="tg-meta">
                <span>${escapeHtml(stepInfo)}</span>
                <span>${fmtDateTime(m.created_at).split(' ')[1] || fmtDateTime(m.created_at)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  } catch (e) {
    console.error('openConversationUser error:', e);
    messagesContainer.innerHTML = '<div class="text-center text-red-500">Xatolik: ' + e.message + '</div>';
  }
}

function fillConversationUserInfo(user) {
  const set = (id, v) => {
    const el = document.getElementById(id);
    if (el) el.textContent = v ?? '-';
  };
  set('convInfoName', user.full_name || user.username || '-');
  set('convInfoUsername', user.username ? '@' + user.username : '-');
  set('convInfoTgId', user.telegram_id || '-');
  set('convInfoPhone', user.phone || '-');
  set('convInfoLesson', (user.current_lesson ?? 0) + '-dars');
  set('convInfoStatus', user.is_paid ? 'Premium' : 'Free');
}

function handleConvReplyKey(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendConversationReply();
  }
}

async function sendConversationReply() {
  if (!selectedConversationUserId) {
    alert('Avval user tanlang');
    return;
  }
  const input = document.getElementById('convReplyInput');
  const stickerInput = document.getElementById('convStickerFileId');
  const parseModeSelect = document.getElementById('convParseMode');
  const disablePreviewEl = document.getElementById('convDisablePreview');
  const btn = document.getElementById('convReplyBtn');
  const text = (input?.value || '').trim();
  const stickerFileId = (stickerInput?.value || '').trim();
  let parseMode = (parseModeSelect?.value || 'HTML');
  const hasHtmlTags = /<[^>]+>/.test(text);
  if (parseMode === 'MarkdownV2' && hasHtmlTags) {
    parseMode = 'HTML';
    if (parseModeSelect) parseModeSelect.value = 'HTML';
  }
  const disableLinkPreview = !!disablePreviewEl?.checked;
  if (!text && !stickerFileId) return;

  try {
    if (btn) btn.disabled = true;
    const res = await fetch('/api/conversations/' + selectedConversationUserId + '/reply', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        sticker_file_id: stickerFileId,
        parse_mode: parseMode,
        disable_link_preview: disableLinkPreview,
        reply_to_message_id: selectedReplyToMessageId || null
      })
    });
    if (!res.ok) {
      const payload = await res.json().catch(() => ({}));
      throw new Error(payload.error || ('API error: ' + res.status));
    }
    if (input) input.value = '';
    if (stickerInput) stickerInput.value = '';
    clearConversationReplyTo();
    await loadConversations();
    await openConversationUser(selectedConversationUserId);
  } catch (e) {
    alert('Xatolik: ' + e.message);
  } finally {
    if (btn) btn.disabled = false;
  }
}

function insertQuickReply(text) {
  const input = document.getElementById('convReplyInput');
  if (!input) return;
  input.value = text;
  input.focus();
}

function setConversationReplyTo(messageId, snippet) {
  selectedReplyToMessageId = Number(messageId) || null;
  selectedReplyToSnippet = snippet || '';
  const bar = document.getElementById('convReplyToBar');
  const textEl = document.getElementById('convReplyToText');
  if (bar) bar.classList.remove('hidden');
  if (textEl) textEl.textContent = selectedReplyToSnippet;
}

function clearConversationReplyTo() {
  selectedReplyToMessageId = null;
  selectedReplyToSnippet = '';
  const bar = document.getElementById('convReplyToBar');
  const textEl = document.getElementById('convReplyToText');
  if (bar) bar.classList.add('hidden');
  if (textEl) textEl.textContent = '';
}

function wrapReplySelection(kind) {
  wrapTextareaSelection('convReplyInput', kind);
}

function wrapTextareaSelection(textareaId, kind) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const start = input.selectionStart ?? 0;
  const end = input.selectionEnd ?? 0;
  const selected = input.value.slice(start, end) || 'text';
  const map = {
    b: ['<b>', '</b>'],
    i: ['<i>', '</i>'],
    u: ['<u>', '</u>'],
    s: ['<s>', '</s>'],
    spoiler: ['<tg-spoiler>', '</tg-spoiler>'],
    blockquote: ['<blockquote>', '</blockquote>'],
    blockquote_expand: ['<blockquote expandable>', '</blockquote>'],
    code: ['<code>', '</code>']
  };
  const pair = map[kind];
  if (!pair) return;
  const [open, close] = pair;
  const insert = open + selected + close;
  input.value = input.value.slice(0, start) + insert + input.value.slice(end);
  const pos = start + insert.length;
  input.focus();
  input.setSelectionRange(pos, pos);
}

function initProgrevFormatEditors() {
  const container = document.getElementById('tab-progrev');
  if (!container) return;
  const fields = container.querySelectorAll('textarea, input[type="text"]');
  fields.forEach((el) => {
    if (el.dataset.progrevFormatBound === '1') return;
    el.dataset.progrevFormatBound = '1';
    el.addEventListener('focus', () => setActiveProgrevEditor(el.id));
    el.addEventListener('click', () => setActiveProgrevEditor(el.id));
  });
}

function setActiveProgrevEditor(editorId) {
  activeProgrevEditorId = editorId || null;
  const label = document.getElementById('progrevActiveEditorLabel');
  if (!label) return;
  if (!activeProgrevEditorId) {
    label.textContent = 'Maydon tanlanmagan';
    return;
  }
  const el = document.getElementById(activeProgrevEditorId);
  const fieldLabel = el?.closest('div')?.querySelector('label')?.textContent?.trim() || activeProgrevEditorId;
  label.textContent = `Aktiv maydon: ${fieldLabel}`;
}

function applyProgrevFormat(kind) {
  if (!activeProgrevEditorId) {
    alert("Avval biror matn maydonini tanlang");
    return;
  }
  if (kind === 'link') {
    insertLinkTemplateTo(activeProgrevEditorId);
    return;
  }
  if (kind === 'emoji') {
    insertCustomEmojiTemplateTo(activeProgrevEditorId);
    return;
  }
  wrapTextareaSelection(activeProgrevEditorId, kind);
}

function insertLinkTemplate() {
  insertLinkTemplateTo('convReplyInput');
}

function insertCustomEmojiTemplate() {
  insertCustomEmojiTemplateTo('convReplyInput');
}

function insertLinkTemplateTo(textareaId) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const text = '<a href="https://example.com">Link text</a>';
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0, start) + text + input.value.slice(end);
  input.focus();
}

function insertCustomEmojiTemplateTo(textareaId) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const text = '<tg-emoji emoji-id="5368324170671202286">‚ú®</tg-emoji>';
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0, start) + text + input.value.slice(end);
  input.focus();
}

function insertCustomEmojiFromLibrary(customEmojiId) {
  const safeId = String(customEmojiId || '').replace(/\D/g, '');
  if (!safeId) return;
  const tag = `<tg-emoji emoji-id="${safeId}">‚ú®</tg-emoji>`;
  insertTextIntoBestEditor(tag);
}

function insertUnicodeEmojiFromLibrary(emojiChar) {
  const safeEmoji = String(emojiChar || '').trim();
  if (!safeEmoji) return;
  insertTextIntoBestEditor(safeEmoji);
}

async function removeEmojiFromLibrary(kind, value, event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }

  const safeKind = String(kind || '').trim();
  if (safeKind !== 'custom' && safeKind !== 'unicode') return;

  const rawValue = String(value || '').trim();
  const safeValue = safeKind === 'custom' ? rawValue.replace(/\D/g, '') : rawValue;
  if (!safeValue) return;

  const label = safeKind === 'custom' ? `ID: ${safeValue}` : `Emoji: ${safeValue}`;
  const confirmed = confirm(`Emoji o'chirilsinmi?\n${label}`);
  if (!confirmed) return;

  try {
    const endpoint = safeKind === 'custom'
      ? '/api/custom-emojis/' + encodeURIComponent(safeValue)
      : '/api/unicode-emojis/' + encodeURIComponent(safeValue);
    const res = await fetch(endpoint, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || ('API error: ' + res.status));

    if (safeKind === 'custom') {
      customEmojiLibrary = (Array.isArray(customEmojiLibrary) ? customEmojiLibrary : [])
        .filter((item) => String(item?.custom_emoji_id || '').replace(/\D/g, '') !== safeValue);
    } else {
      unicodeEmojiLibrary = (Array.isArray(unicodeEmojiLibrary) ? unicodeEmojiLibrary : [])
        .filter((item) => String(item?.emoji || '').trim() !== safeValue);
    }

    renderCustomEmojiLibrary();
    showToast('Emoji o\'chirildi');
  } catch (e) {
    console.error('removeEmojiFromLibrary error:', e);
    showToast('O\'chirishda xatolik: ' + e.message, 'error');
  }
}

function insertTextIntoBestEditor(text) {
  const active = document.activeElement;
  const isTextInput = active && (
    active.tagName === 'TEXTAREA' ||
    (active.tagName === 'INPUT' && (active.type === 'text' || active.type === 'search'))
  );

  if (isTextInput && typeof active.value === 'string') {
    const start = active.selectionStart ?? active.value.length;
    const end = active.selectionEnd ?? active.value.length;
    active.value = active.value.slice(0, start) + text + active.value.slice(end);
    active.focus();
    return;
  }

  if (activeProgrevEditorId) {
    const target = document.getElementById(activeProgrevEditorId);
    if (target && typeof target.value === 'string') {
      const start = target.selectionStart ?? target.value.length;
      const end = target.selectionEnd ?? target.value.length;
      target.value = target.value.slice(0, start) + text + target.value.slice(end);
      target.focus();
      return;
    }
  }

  const convInput = document.getElementById('convReplyInput');
  if (convInput) {
    const start = convInput.selectionStart ?? convInput.value.length;
    const end = convInput.selectionEnd ?? convInput.value.length;
    convInput.value = convInput.value.slice(0, start) + text + convInput.value.slice(end);
    convInput.focus();
  }
}

function normalizeMessageMeta(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  try { return JSON.parse(meta); } catch { return {}; }
}

function formatConversationMessage(message, metaObj) {
  if (message.message_type === 'callback') {
    return `Tugma bosildi: ${humanizeCallbackData(message.text_content || 'callback')}`;
  }
  if (message.message_type === 'admin_outgoing') {
    return message.text_content || '';
  }
  if (message.message_type === 'bot_outgoing_video') return message.text_content || 'üé¨ Video yuborildi';
  if (message.message_type === 'bot_outgoing_photo') return message.text_content || 'üñº Rasm yuborildi';
  if (message.message_type === 'bot_outgoing_voice') return message.text_content || 'üé§ Ovozli xabar yuborildi';
  if (message.message_type === 'bot_outgoing_audio') return message.text_content || 'üéµ Audio yuborildi';
  if (message.message_type === 'bot_outgoing_video_note') return message.text_content || 'üîµ Video note yuborildi';
  if (message.message_type === 'bot_outgoing_document') return message.text_content || 'üìé Hujjat yuborildi';
  if (message.message_type === 'bot_outgoing_sticker') return message.text_content || 'üé≠ Sticker yuborildi';
  if (message.message_type === 'bot_outgoing_text') return message.text_content || '';
  if (message.message_type === 'admin_outgoing_sticker') return 'üé≠ Siz sticker yubordingiz';
  if (message.message_type === 'contact') {
    return `Kontakt yuborildi: ${message.text_content || ''}`.trim();
  }
  if (message.text_content) {
    return message.text_content;
  }
  return `(${message.message_type || 'event'})`;
}

function getConversationPreview(message) {
  if (!message) return '';
  if (message.message_type === 'callback') return 'Tugma: ' + humanizeCallbackData(message.text_content || '');
  if (message.message_type === 'admin_outgoing') return 'Siz: ' + (message.text_content || '');
  if (message.message_type === 'admin_outgoing_sticker') return 'Siz: sticker yubordingiz';
  if (message.message_type && message.message_type.startsWith('bot_outgoing_')) return formatConversationMessage(message, {});
  if (message.text_content) return message.text_content;
  return '(' + (message.message_type || 'event') + ')';
}

function humanizeCallbackData(data) {
  const raw = String(data || '');
  let m;

  if ((m = raw.match(/^watched_(\d+)$/))) return `${m[1]}-dars: "ko'rib bo'ldim"`;
  if ((m = raw.match(/^watched_funnel_(\d+)_(\d+)$/))) return `Funnel ${m[1]}, ${m[2]}-dars ko'rildi`;
  if ((m = raw.match(/^cd_(\d+)_(.+)$/))) return `CustDev savol ${m[1]} javobi: ${decodeURIComponentSafe(m[2])}`;
  if ((m = raw.match(/^fcd_(\d+)_(\d+)_(\d+)_(.+)$/))) return `Funnel CustDev javobi: ${decodeURIComponentSafe(m[4])}`;
  if ((m = raw.match(/^check_subscription_?(\d*)$/))) return `Obuna tekshirish${m[1] ? ` (${m[1]}-dars)` : ''}`;
  if ((m = raw.match(/^check_funnel_sub_(\d+)_(\d+)$/))) return `Funnel obuna tekshirish (funnel ${m[1]}, lesson ${m[2]})`;
  if (raw === 'feedback_yes') return 'Feedback: Ha, yoqdi';
  if (raw === 'feedback_no') return 'Feedback: Yoqmadi';
  if ((m = raw.match(/^plan_(.+)$/))) return `Tarif tanlandi: ${m[1]}`;
  if ((m = raw.match(/^extend_(.+)$/))) return `Obuna uzaytirish tarifi: ${m[1]}`;
  if ((m = raw.match(/^discount_plan_(\d+)_(.+)$/))) return `${m[1]}% chegirma tarifi: ${m[2]}`;
  if ((m = raw.match(/^resume_[lf]:(.+)$/))) return `Davom etish: ${m[1]}`;
  if (raw === 'question') return 'Savolim bor tugmasi';
  if (raw === 'back_to_plans') return 'Tariflarga qaytish';
  if (raw === 'cancel_extend') return 'Uzaytirishni bekor qilish';
  return raw;
}

function decodeURIComponentSafe(value) {
  try { return decodeURIComponent(value); } catch { return value; }
}

function escapeJsString(value) {
  return String(value || '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\n/g, ' ')
    .replace(/\r/g, ' ');
}

function buildMediaPreviewHtml(message, metaObj) {
  const type = String(message?.message_type || '');
  const fileRef = metaObj?.file_ref || metaObj?.file_id || metaObj?.sticker_file_id;
  if (!fileRef) return '';

  const src = '/api/telegram-file/' + encodeURIComponent(fileRef);

  if (type.includes('photo')) {
    return `<div class="mt-2">
      <img src="${src}" alt="preview" class="rounded-xl border border-gray-200 max-h-[220px] object-cover" loading="lazy" />
    </div>`;
  }

  if (type.includes('video') && !type.includes('video_note')) {
    return `<div class="mt-2">
      <video src="${src}" controls preload="metadata" class="rounded-xl border border-gray-200 max-h-[260px] w-full bg-black/80"></video>
    </div>`;
  }

  if (type.includes('video_note')) {
    return `<div class="mt-2">
      <video src="${src}" controls preload="metadata" class="rounded-full border border-gray-200 w-[180px] h-[180px] bg-black/80 object-cover"></video>
    </div>`;
  }

  if (type.includes('audio') || type.includes('voice')) {
    return `<div class="mt-2">
      <audio src="${src}" controls preload="metadata" class="w-full"></audio>
    </div>`;
  }

  if (type.includes('document')) {
    return `<div class="mt-2 text-xs">
      <a href="${src}" target="_blank" class="text-indigo-600 underline">üìé Hujjatni ochish</a>
    </div>`;
  }

  if (type.includes('sticker')) {
    return `<div class="mt-2">
      <img src="${src}" alt="sticker" class="max-h-[180px] max-w-[180px] rounded-lg border border-gray-200" loading="lazy" />
    </div>`;
  }

  return '';
}

// ========== MEDIA LIBRARY ==========
let allMedia = [];

async function loadMediaLibrary() {
  try {
    const filterType = document.getElementById('mediaTypeFilter')?.value || 'all';
    const url = filterType === 'all' ? '/api/media' : '/api/media/' + filterType;
    const data = await (await fetch(url, { headers: { Authorization: auth } })).json();
    allMedia = Array.isArray(data) ? data : [];
    renderMediaLibrary();
  } catch(e) {
    console.error('loadMediaLibrary error:', e);
    const container = document.getElementById('mediaLibraryList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

function renderMediaLibrary() {
  const container = document.getElementById('mediaLibraryList');
  if (!container) return;

  // Calculate stats
  const videoCount = allMedia.filter(m => m.file_type === 'video').length;
  const photoCount = allMedia.filter(m => m.file_type === 'photo').length;
  const audioCount = allMedia.filter(m => m.file_type === 'audio' || m.file_type === 'voice').length;
  const videoNoteCount = allMedia.filter(m => m.file_type === 'video_note').length;

  document.getElementById('mediaStatsTotal').textContent = allMedia.length;
  document.getElementById('mediaStatsVideo').textContent = videoCount;
  document.getElementById('mediaStatsPhoto').textContent = photoCount;
  document.getElementById('mediaStatsAudio').textContent = audioCount;
  document.getElementById('mediaStatsVideoNote').textContent = videoNoteCount;

  if (!allMedia.length) {
    container.innerHTML = `<div class="p-8 text-center text-gray-400">
      <p class="mb-2">Hali media yo'q</p>
      <p class="text-xs">Botga video, rasm yoki audio yuboring - bu yerda ko'rinadi</p>
    </div>`;
    return;
  }

  container.innerHTML = allMedia.map(m => {
    const time = timeAgo(m.created_at);

    // Get icon and color based on type
    let icon = 'üìé';
    let color = 'gray';
    let typeName = m.file_type;

    if (m.file_type === 'video') { icon = 'üé¨'; color = 'blue'; typeName = 'Video'; }
    else if (m.file_type === 'photo') { icon = 'üñº'; color = 'green'; typeName = 'Rasm'; }
    else if (m.file_type === 'voice') { icon = 'üé§'; color = 'orange'; typeName = 'Ovozli'; }
    else if (m.file_type === 'audio') { icon = 'üéµ'; color = 'orange'; typeName = 'Audio'; }
    else if (m.file_type === 'video_note') { icon = '‚ö™'; color = 'purple'; typeName = 'Video xabar'; }

    const caption = m.caption ? m.caption.slice(0, 50) + (m.caption.length > 50 ? '...' : '') : '';
    const fileName = m.file_name || 'Nomsiz';
    const safeCaption = (m.caption || '').replace(/'/g, "\\'");

    return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">' +
      '<div class="flex items-center gap-3 flex-1 min-w-0">' +
        '<span class="text-2xl">' + icon + '</span>' +
        '<div class="flex-1 min-w-0">' +
          '<div class="flex items-center gap-2">' +
            '<span class="badge badge-' + color + ' text-xs">' + typeName + '</span>' +
            '<span class="text-xs text-gray-400">' + time + '</span>' +
          '</div>' +
          '<p class="text-sm font-medium text-gray-700 truncate" title="' + fileName + '">' + fileName + '</p>' +
          (caption ? '<p class="text-xs text-gray-500 truncate">' + caption + '</p>' : '') +
        '</div>' +
      '</div>' +
      '<div class="flex items-center gap-2 ml-2">' +
        '<button onclick="copyMediaId(\'' + m.file_id + '\')" class="btn btn-secondary text-xs px-2 py-1" title="File ID nusxalash">üìã</button>' +
        '<button onclick="editMediaCaption(' + m.id + ', \'' + safeCaption + '\', \'' + m.file_id + '\')" class="btn btn-secondary text-xs px-2 py-1" title="Izoh o\'zgartirish">‚úèÔ∏è</button>' +
        '<button onclick="deleteMediaItem(' + m.id + ')" class="btn btn-danger text-xs px-2 py-1" title="O\'chirish">üóë</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function copyMediaId(fileId) {
  navigator.clipboard.writeText(fileId).then(() => {
    showToast('‚úÖ File ID nusxalandi!');
  }).catch(e => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = fileId;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('‚úÖ File ID nusxalandi!');
  });
}

function editMediaCaption(id, currentCaption, fileId) {
  const newCaption = prompt('Yangi izoh kiriting:', currentCaption);
  if (newCaption === null) return; // cancelled

  fetch('/api/media/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', Authorization: auth },
    body: JSON.stringify({ caption: newCaption })
  })
  .then(r => r.json())
  .then(() => {
    showToast('‚úÖ Izoh saqlandi!');
    loadMediaLibrary();
  })
  .catch(e => {
    showToast('‚ùå Xatolik: ' + e.message);
  });
}

async function deleteMediaItem(id) {
  if (!confirm("Bu media faylni o'chirishni xohlaysizmi?")) return;

  try {
    await fetch('/api/media/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    showToast("‚úÖ Media o'chirildi!");
    loadMediaLibrary();
  } catch(e) {
    showToast('‚ùå Xatolik: ' + e.message);
  }
}

function renderFeedback() {
  const container = document.getElementById('feedbackList');
  const filter = document.getElementById('feedbackFilter')?.value || 'all';

  // Filter feedbacks
  let filteredFeedback = allFeedback;
  if (filter !== 'all') {
    filteredFeedback = allFeedback.filter(f => f.feedback_type === filter);
  }

  // Update stats
  const liked = allFeedback.filter(f => f.feedback_type === 'liked').length;
  const notLiked = allFeedback.filter(f => f.feedback_type === 'not_liked' || f.feedback_type === 'disliked_reason').length;

  document.getElementById('feedbackLikedCount').textContent = liked;
  document.getElementById('feedbackDislikedCount').textContent = notLiked;
  document.getElementById('feedbackTotalCount').textContent = allFeedback.length;

  if (!filteredFeedback.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Feedback yo\'q<br><span class="text-xs">Bu yerda 4-darsdan keyin "Yoqdi/Yoqmadi" bosgan foydalanuvchilar ko\'rinadi</span></div>';
    return;
  }

  container.innerHTML = filteredFeedback.map(f => {
    const time = timeAgo(f.created_at);
    const name = f.full_name || f.username || 'Noma\'lum';

    let typeIcon = 'üí¨';
    let typeBadge = 'badge-gray';
    let typeText = 'Feedback';

    if (f.feedback_type === 'liked') {
      typeIcon = 'üëç';
      typeBadge = 'badge-green';
      typeText = 'Yoqdi';
    } else if (f.feedback_type === 'not_liked') {
      typeIcon = 'üëé';
      typeBadge = 'badge-red';
      typeText = 'Yoqmadi';
    } else if (f.feedback_type === 'disliked_reason') {
      typeIcon = 'üìù';
      typeBadge = 'badge-orange';
      typeText = 'Sabab';
    }

    return `
      <div class="p-4 hover:bg-gray-50 transition-colors">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-lg flex-shrink-0">
            ${typeIcon}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap mb-1">
              <span class="font-medium text-gray-800">${name}</span>
              <span class="badge ${typeBadge}">${typeText}</span>
              <span class="text-xs text-gray-400">${time}</span>
            </div>
            ${f.feedback_text ? `
              <p class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 mt-2">${f.feedback_text}</p>
            ` : ''}
            <div class="flex items-center gap-3 mt-2 text-xs text-gray-400">
              ${f.phone ? `<span>üì± ${f.phone}</span>` : ''}
              <span>ID: ${f.telegram_id}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function filterFeedback() {
  renderFeedback();
}

function togglePitchMediaFields() {
  const mediaType = document.getElementById('pitchMediaType').value;

  // Hide all media fields
  document.getElementById('pitchMediaVideoField').classList.add('hidden');
  document.getElementById('pitchMediaAudioField').classList.add('hidden');
  document.getElementById('pitchMediaImageField').classList.add('hidden');
  document.getElementById('pitchMediaVideoNoteField').classList.add('hidden');

  // Show selected field
  if (mediaType === 'video') {
    document.getElementById('pitchMediaVideoField').classList.remove('hidden');
  } else if (mediaType === 'audio') {
    document.getElementById('pitchMediaAudioField').classList.remove('hidden');
  } else if (mediaType === 'image') {
    document.getElementById('pitchMediaImageField').classList.remove('hidden');
  } else if (mediaType === 'video_note') {
    document.getElementById('pitchMediaVideoNoteField').classList.remove('hidden');
  }
}

async function loadProgrevSettings() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    // Start messages
    document.getElementById('startWelcomeText').value = data.welcome || '';
    document.getElementById('startAskNameText').value = data.ask_name || '';

    // Step 1: Congrats
    document.getElementById('congratsText').value = data.congrats_text || '';

    // Step 2: Feedback question
    document.getElementById('feedbackEnabled').checked = data.feedback_enabled !== false;
    document.getElementById('pitchDelayMinutes').value = data.pitch_delay_minutes || 0;
    document.getElementById('feedbackQuestion').value = data.feedback_question || 'Bepul darslar yoqdimi? ü§î';
    document.getElementById('feedbackYesBtn').value = data.feedback_yes_btn || 'üëç Ha, juda yoqdi!';
    document.getElementById('feedbackNoBtn').value = data.feedback_no_btn || 'üòê Unchalik emas';

    // Step 3: Pitch info (after "Ha")
    document.getElementById('pitchInfoText').value = data.pitch_info_text || 'üéâ Ajoyib tanlov!\n\nTo\'liq kursda sizni kutmoqda:\n‚úÖ 50+ dars\n‚úÖ Amaliy topshiriqlar\n‚úÖ Sertifikat\n\nHoziroq ro\'yxatdan o\'ting! üëá';
    document.getElementById('pitchInfoBtn').value = data.pitch_info_btn || 'üöÄ Kursga yozilish';

    // Pitch media
    document.getElementById('pitchVideoFileId').value = data.pitch_video_file_id || '';
    document.getElementById('pitchAudioFileId').value = data.pitch_audio_file_id || '';
    document.getElementById('pitchImageFileId').value = data.pitch_image_file_id || '';
    document.getElementById('pitchVideoNoteFileId').value = data.pitch_video_note_file_id || '';
    let mediaType = 'none';
    if (data.pitch_video_file_id) mediaType = 'video';
    else if (data.pitch_audio_file_id) mediaType = 'audio';
    else if (data.pitch_image_file_id) mediaType = 'image';
    else if (data.pitch_video_note_file_id) mediaType = 'video_note';
    if (data.pitch_media_type) mediaType = data.pitch_media_type;
    document.getElementById('pitchMediaType').value = mediaType;
    togglePitchMediaFields();

    // Step 3b: Negative response
    document.getElementById('feedbackNoResponse').value = data.feedback_no_response || 'üòî Tushunaman. Iltimos, nimada kamchilik borligini yozing...';
    document.getElementById('feedbackFollowup').value = data.feedback_followup || '';
    document.getElementById('feedbackSpecialOfferEnabled').checked = data.feedback_special_offer_enabled || false;
    document.getElementById('feedbackSpecialOffer').value = data.feedback_special_offer || '';
    document.getElementById('feedbackNoSalesDelay').value = data.feedback_no_sales_delay || 30;

    // Step 4: Sales pitch
    document.getElementById('salesPitchText').value = data.sales_pitch || '';
    document.getElementById('salesDelayMinutes').value = data.sales_delay_minutes || 0;

    // Step 5: Soft attack
    document.getElementById('softAttackDisabled').checked = data.soft_attack_disabled || false;
    document.getElementById('softAttackText').value = data.soft_attack_text || '';
    document.getElementById('softAttackDelayMinutes').value = data.soft_attack_delay_minutes || 1440;

    // Lesson completion defaults
    document.getElementById('watchedMessageDefault').value = data.watched_message_default || '';
    document.getElementById('watchedButtonDefault').value = data.watched_button_default || '';
  } catch(e) { console.error('loadProgrevSettings error:', e); }
}

// ========== RENDER FUNCTIONS ==========
function renderUsers() {
  // Use new advanced filter system
  applyUserFilters();
}

function goToPage(page) {
  currentPage = page;
  applyUserFilters();
}

function searchUsers() {
  // Deprecated - use applyUserFilters instead
  applyUserFilters();
}

function searchUsersOld() {
  const query = document.getElementById('userSearch').value.toLowerCase();
  if (!query) { renderUsers(); return; }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  );

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = filtered.slice(0, 20).map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid
          ? (u.joined_premium_channel
              ? '<span class="badge badge-green">Premium</span>'
              : '<span class="badge badge-orange" title="To\'lagan, lekin kanalga qo\'shilmagan">To\'lagan ‚ùå</span>')
          : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">üëÅ</button>
      </td>
    </tr>
  `).join('');
}

function renderRecentUsers() {
  const recent = allUsers.slice(0, 5);
  const container = document.getElementById('recentUsersList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">Foydalanuvchilar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(u => `
    <div class="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50" onclick="openUserDetail(${u.telegram_id})">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
        ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${u.current_lesson || 0}-dars</p>
      </div>
      ${u.is_paid ? '<span class="badge badge-green">üíé</span>' : ''}
    </div>
  `).join('');
}

function filterPayments(status) {
  paymentFilter = status;

  document.querySelectorAll('[data-payment-status]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.paymentStatus === status);
  });

  renderPayments();
}

function renderPayments() {
  const tbody = document.getElementById('paymentsTableBody');

  let filtered = allPayments;
  if (paymentFilter !== 'all') {
    filtered = allPayments.filter(p => p.status === paymentFilter);
  }

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.slice(0, 50).map(p => {
    let statusBadge = '';
    if (p.status === 'completed') statusBadge = '<span class="badge badge-green">To\'langan</span>';
    else if (p.status === 'pending') statusBadge = '<span class="badge badge-yellow">Jarayonda</span>';
    else if (p.status === 'cancelled' || p.status === 'failed') statusBadge = '<span class="badge badge-red">Bekor</span>';
    else statusBadge = `<span class="badge badge-gray">${p.status || '-'}</span>`;

    let channelStatus = '<span class="text-gray-400">-</span>';
    if (p.status === 'completed') {
      channelStatus = p.joined_premium_channel
        ? '<span class="badge badge-green">Qo\'shilgan</span>'
        : '<span class="badge badge-orange">Qo\'shilmagan</span>';
    }

    return `
      <tr class="table-row">
        <td class="px-5 py-4 text-gray-500 text-sm">${fmtDateTime(p.created_at)}</td>
        <td class="px-5 py-4">
          <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
          <p class="text-xs text-gray-400">ID: ${p.telegram_id || '-'}</p>
        </td>
        <td class="px-5 py-4 font-semibold ${p.status === 'completed' ? 'text-green-600' : 'text-gray-600'}">${fmtMoney(p.amount)}</td>
        <td class="px-5 py-4"><span class="badge badge-blue">${p.plan || '-'}</span></td>
        <td class="px-5 py-4">${statusBadge}</td>
        <td class="px-5 py-4 text-gray-500">${p.payment_system || '-'}</td>
        <td class="px-5 py-4">${channelStatus}</td>
      </tr>
    `;
  }).join('');
}

function renderRecentPayments() {
  const recent = allPayments.filter(p => p.status === 'completed').slice(0, 5);
  const container = document.getElementById('recentPaymentsList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">To\'lovlar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(p => `
    <div class="flex items-center gap-3 p-4">
      <div class="activity-icon bg-green-100 text-green-600">üí∞</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${fmtDate(p.created_at)}</p>
      </div>
      <p class="font-semibold text-green-600">${fmtMoney(p.amount)}</p>
    </div>
  `).join('');
}

function renderPaymentStats() {
  const completed = allPayments.filter(p => p.status === 'completed');
  const pending = allPayments.filter(p => p.status === 'pending');
  const cancelled = allPayments.filter(p => p.status === 'cancelled' || p.status === 'failed');

  document.getElementById('payCompletedCount').textContent = completed.length;
  document.getElementById('payPendingCount').textContent = pending.length;
  document.getElementById('payCancelledCount').textContent = cancelled.length;

  const now = new Date();
  const today = completed.filter(p => new Date(p.created_at).toDateString() === now.toDateString());
  const week = completed.filter(p => (now - new Date(p.created_at)) < 7 * 24 * 60 * 60 * 1000);
  const month = completed.filter(p => (now - new Date(p.created_at)) < 30 * 24 * 60 * 60 * 1000);

  const sum = arr => arr.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('payToday').textContent = fmtMoney(sum(today));
  document.getElementById('payTodayCount').textContent = today.length + ' ta';
  document.getElementById('payWeek').textContent = fmtMoney(sum(week));
  document.getElementById('payWeekCount').textContent = week.length + ' ta';
  document.getElementById('payMonth').textContent = fmtMoney(sum(month));
  document.getElementById('payMonthCount').textContent = month.length + ' ta';
  document.getElementById('payTotal').textContent = fmtMoney(sum(completed));
  document.getElementById('payTotalCount').textContent = completed.length + ' ta';
}

function renderLessons() {
  const container = document.getElementById('lessonsList');

  if (!allLessons.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Darslar yo\'q. Yangi dars qo\'shing!</div>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const hasMedia = l.video_file_id || l.video_note_file_id || l.audio_file_id || l.document_file_id || l.photo_file_id;
    const mediaIcons = [];
    if (l.video_file_id) mediaIcons.push('üé¨');
    if (l.video_note_file_id) mediaIcons.push('üîµ');
    if (l.audio_file_id) mediaIcons.push('üéµ');
    if (l.document_file_id) mediaIcons.push('üìé');
    if (l.photo_file_id) mediaIcons.push('üñº');

    return `
      <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
        <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
          ${l.lesson_number}
        </div>
        <div class="flex-1">
          <p class="font-medium text-gray-800">${l.title}</p>
          <p class="text-sm text-gray-400">
            ${l.delay_hours || 0} soat keyin
            ${mediaIcons.length ? ' ‚Ä¢ ' + mediaIcons.join(' ') : ''}
          </p>
        </div>
        <button onclick="editLesson(${l.id})" class="btn btn-secondary text-sm">‚úèÔ∏è</button>
        <button onclick="deleteLesson(${l.id})" class="btn bg-red-50 text-red-600 text-sm">üóëÔ∏è</button>
      </div>
    `;
  }).join('');
}

// ========== LIBRARY (Darslar kutubxonasi) ==========
function renderLibrary() {
  const container = document.getElementById('libraryLessonsList');
  if (!container) return;

  // Update stats
  const videoCount = allLessons.filter(l => l.video_file_id || l.video_note_file_id).length;
  const audioCount = allLessons.filter(l => l.audio_file_id).length;

  document.getElementById('libraryTotalLessons').textContent = allLessons.length;
  document.getElementById('libraryVideoLessons').textContent = videoCount;
  document.getElementById('libraryAudioLessons').textContent = audioCount;

  if (!allLessons.length) {
    container.innerHTML = '<p class="text-gray-400 text-center py-8">Darslar yo\'q</p>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const mediaInfo = [];
    if (l.video_file_id) mediaInfo.push({ type: 'Video', id: l.video_file_id, icon: 'üé¨', color: 'indigo' });
    if (l.video_note_file_id) mediaInfo.push({ type: 'Video xabar', id: l.video_note_file_id, icon: 'üîµ', color: 'blue' });
    if (l.audio_file_id) mediaInfo.push({ type: 'Audio', id: l.audio_file_id, icon: 'üéµ', color: 'orange' });
    if (l.document_file_id) mediaInfo.push({ type: 'Fayl', id: l.document_file_id, icon: 'üìé', color: 'gray' });
    if (l.photo_file_id) mediaInfo.push({ type: 'Rasm', id: l.photo_file_id, icon: 'üñº', color: 'green' });

    const mediaHtml = mediaInfo.map(m => `
      <div class="flex items-center gap-2 bg-${m.color}-50 rounded-lg px-3 py-2">
        <span>${m.icon}</span>
        <span class="text-xs text-${m.color}-600 font-medium">${m.type}:</span>
        <code class="text-xs bg-${m.color}-100 px-2 py-0.5 rounded cursor-pointer hover:bg-${m.color}-200 transition-colors max-w-[200px] truncate" onclick="copyToClipboard('${m.id}')" title="${m.id}">${m.id.substring(0, 25)}...</code>
      </div>
    `).join('');

    return `
      <div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between gap-4 mb-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
              ${l.lesson_number}
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">${l.title}</h4>
              <p class="text-xs text-gray-400">ID: <code class="bg-gray-100 px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200" onclick="copyToClipboard('${l.id}')">${l.id}</code></p>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="testSendLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Test yuborish">
              üì§ Test
            </button>
            <button onclick="editLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Tahrirlash">
              ‚úèÔ∏è
            </button>
          </div>
        </div>

        <div class="text-sm text-gray-600 mb-3 line-clamp-2">${l.text ? l.text.substring(0, 150) + (l.text.length > 150 ? '...' : '') : '<span class="text-gray-400 italic">Matn yo\'q</span>'}</div>

        ${mediaInfo.length ? `
          <div class="border-t border-gray-100 pt-3">
            <p class="text-xs text-gray-400 mb-2 font-medium">Media fayllari:</p>
            <div class="flex flex-wrap gap-2">
              ${mediaHtml}
            </div>
          </div>
        ` : '<p class="text-xs text-gray-400 italic">Media fayl biriktirilmagan</p>'}

        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400">
          <span>‚è± ${l.delay_hours || 0} soat keyin</span>
          ${l.button_text ? `<span>üîò ${l.button_text}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast('Nusxalandi! ‚úÖ');
  }).catch(() => {
    // Fallback
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('Nusxalandi! ‚úÖ');
  });
}

function copyAllLessonIds() {
  const ids = allLessons.map(l => `${l.lesson_number}-dars (ID: ${l.id}): ${l.title}`).join('\n');
  copyToClipboard(ids);
}

async function testSendLesson(lessonId) {
  if (!confirm('Bu darsni o\'zingizga test sifatida yubormoqchimisiz?')) return;

  try {
    const res = await fetch('/api/lessons/' + lessonId + '/test', {
      method: 'POST',
      headers: { Authorization: auth }
    });
    if (res.ok) {
      showToast('Dars yuborildi! Telegram ni tekshiring üì±');
    } else {
      showToast('Xatolik yuz berdi ‚ùå', 'error');
    }
  } catch(e) {
    showToast('Xatolik: ' + e.message, 'error');
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-20 md:bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

function renderLessonProgress() {
  const lessonCounts = {};
  allUsers.forEach(u => {
    const lesson = u.current_lesson || 0;
    lessonCounts[lesson] = (lessonCounts[lesson] || 0) + 1;
  });

  const maxUsers = Math.max(...Object.values(lessonCounts), 1);
  const totalUsers = allUsers.length || 1;

  const statsContainer = document.getElementById('lessonProgressStats');
  const panelContainer = document.getElementById('lessonProgressPanel');

  // Standard bar chart for stats section
  const statsHtml = allLessons.slice(0, 10).map(l => {
    const count = lessonCounts[l.lesson_number] || 0;
    const pct = Math.round((count / maxUsers) * 100);
    return `
      <div class="flex items-center gap-3">
        <span class="w-16 text-sm text-gray-600">${l.lesson_number}-dars</span>
        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-indigo-500 rounded-full" style="width: ${pct}%"></div>
        </div>
        <span class="w-12 text-sm text-gray-600 text-right">${count}</span>
      </div>
    `;
  }).join('');

  statsContainer.innerHTML = statsHtml || '<p class="text-gray-400 text-center">Ma\'lumot yo\'q</p>';

  // Visual funnel for right panel
  const funnelColors = ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#eef2ff', '#f5f3ff'];
  const lessons = allLessons.slice(0, 7);

  if (!lessons.length) {
    panelContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">Ma\'lumot yo\'q</p>';
    return;
  }

  // Calculate cumulative users (users at lesson N or higher)
  const cumulativeCounts = lessons.map((l, idx) => {
    let count = 0;
    lessons.slice(idx).forEach(lesson => {
      count += lessonCounts[lesson.lesson_number] || 0;
    });
    return { lesson: l, count };
  });

  const funnelHtml = cumulativeCounts.map((item, idx) => {
    const count = item.count;
    const lesson = item.lesson;
    const widthPct = Math.max(30, 100 - (idx * 12));
    const pct = Math.round((count / totalUsers) * 100);
    const bgColor = funnelColors[idx % funnelColors.length];
    const textColor = idx < 3 ? '#fff' : '#4338ca';

    return `
      <div class="funnel-step" style="width: ${widthPct}%; background: ${bgColor}; margin-bottom: 2px;">
        <div class="flex justify-between items-center">
          <span style="font-size: 11px; font-weight: 500; color: ${textColor}">${lesson.lesson_number}-dars</span>
          <span style="font-size: 12px; font-weight: 700; color: ${textColor}">${count}</span>
        </div>
        <div style="font-size: 10px; color: ${idx < 3 ? 'rgba(255,255,255,0.7)' : '#6366f1'}">${pct}% foydalanuvchi</div>
      </div>
    `;
  }).join('');

  // Add drop-off stats
  let dropOffHtml = '';
  if (cumulativeCounts.length > 1) {
    const dropOff = cumulativeCounts[0].count - cumulativeCounts[cumulativeCounts.length - 1].count;
    const conversionRate = Math.round((cumulativeCounts[cumulativeCounts.length - 1].count / Math.max(cumulativeCounts[0].count, 1)) * 100);
    dropOffHtml = `
      <div class="mt-3 p-2 bg-gray-50 rounded-lg text-center">
        <div class="text-xs text-gray-500">Konversiya</div>
        <div class="text-lg font-bold text-indigo-600">${conversionRate}%</div>
      </div>
    `;
  }

  panelContainer.innerHTML = funnelHtml + dropOffHtml;
}

function renderCustDev() {
  const container = document.getElementById('custdevList');

  if (!allCustDev.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Savollar yo\'q. Yangi savol qo\'shing!</div>';
    return;
  }

  container.innerHTML = allCustDev.map(q => `
    <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
      <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
        ${q.after_lesson}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${q.question_text}</p>
        <p class="text-sm text-gray-400">
          ${q.question_type === 'buttons' ? 'Tugmalar' : 'Matn'}
          ‚Ä¢ ${q.answer_count || 0} javob
          ${q.field_name ? ' ‚Ä¢ ' + q.field_name : ''}
        </p>
      </div>
      <button onclick="openQuestionStats(${q.id})" class="btn btn-secondary text-sm">üìä</button>
      <button onclick="editCustDev(${q.id})" class="btn btn-secondary text-sm">‚úèÔ∏è</button>
      <button onclick="deleteCustDev(${q.id})" class="btn bg-red-50 text-red-600 text-sm">üóëÔ∏è</button>
    </div>
  `).join('');
}

function renderCustDevStats() {
  // Count stats
  const totalQuestions = allCustDev.length;
  const totalAnswers = Object.values(custdevAnswers).reduce((sum, arr) => sum + arr.length, 0);
  const respondents = new Set();
  Object.values(custdevAnswers).forEach(answers => {
    answers.forEach(a => respondents.add(a.telegram_id));
  });
  const avgAnswers = respondents.size > 0 ? (totalAnswers / respondents.size).toFixed(1) : 0;

  document.getElementById('custdevTotalQuestions').textContent = totalQuestions;
  document.getElementById('custdevTotalAnswers').textContent = totalAnswers;
  document.getElementById('custdevRespondents').textContent = respondents.size;
  document.getElementById('custdevAvgAnswers').textContent = avgAnswers;

  // Render charts with field data
  renderCustDevCharts();
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');

  const activities = [
    ...allUsers.slice(0, 5).map(u => ({ type: 'user', data: u, date: new Date(u.created_at) })),
    ...allPayments.filter(p => p.status === 'completed').slice(0, 5).map(p => ({ type: 'payment', data: p, date: new Date(p.created_at) }))
  ].sort((a, b) => b.date - a.date).slice(0, 5);

  if (!activities.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">Faoliyat yo\'q</div></div>';
    return;
  }

  const timeAgo = (date) => {
    const mins = Math.floor((Date.now() - date) / 60000);
    if (mins < 1) return 'hozirgina';
    if (mins < 60) return mins + ' min oldin';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + ' soat oldin';
    return Math.floor(hours / 24) + ' kun oldin';
  };

  container.innerHTML = activities.map(a => {
    const getName = (d) => d.full_name || d.username || 'Foydalanuvchi';
    const time = timeAgo(a.date);
    if (a.type === 'user') {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600">üë§</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-gray-400">Yangi foydalanuvchi ‚Ä¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
        </div>
      `;
    } else {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">üí∞</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-green-600 font-medium">${fmtMoney(a.data.amount)} ‚Ä¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-green-400 rounded-full"></span>
        </div>
      `;
    }
  }).join('');
}

// ========== CHARTS ==========
function renderCharts() {
  renderRevenueChart(currentRevenuePeriod);
  renderUserTypeChart();
  renderCustDevCharts();
  renderSubscriberGrowthChart(currentGrowthPeriod);
}

function renderRevenueChart(period = 'week') {
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;

  const now = new Date();
  const completedPayments = allPayments.filter(p => p.status === 'completed');

  let labels = [];
  let data = [];
  let periodTotal = 0;

  if (period === 'week') {
    // Last 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      const dayName = days[d.getDay()];
      dailyData[key] = { label: dayName, amount: 0 };
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) {
        dailyData[key].amount += (p.amount || 0);
      }
    });

    Object.values(dailyData).forEach(d => {
      labels.push(d.label);
      data.push(d.amount / 100);
      periodTotal += d.amount;
    });

  } else if (period === 'month') {
    // Current month by days (1-31)
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const dailyData = {};

    for (let i = 1; i <= Math.min(now.getDate(), daysInMonth); i++) {
      dailyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        const day = date.getDate();
        dailyData[day] = (dailyData[day] || 0) + (p.amount || 0);
      }
    });

    Object.entries(dailyData).forEach(([day, amount]) => {
      labels.push(day);
      data.push(amount / 100);
      periodTotal += amount;
    });

  } else if (period === 'year') {
    // Months of current year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getFullYear() === now.getFullYear()) {
        monthlyData[date.getMonth()] = (monthlyData[date.getMonth()] || 0) + (p.amount || 0);
      }
    });

    Object.entries(monthlyData).forEach(([month, amount]) => {
      labels.push(months[parseInt(month)]);
      data.push(amount / 100);
      periodTotal += amount;
    });
  }

  // Update display
  document.getElementById('totalRevenueDisplay').textContent = fmtMoney(periodTotal);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: chartAccent(),
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: chartLayoutPadding() },
      plugins: { legend: { display: false } },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: true,
            maxTicksLimit: chartMaxXTicks(),
            autoSkipPadding: isMobile() ? 18 : 6,
            maxRotation: isMobile() ? 45 : 0,
            minRotation: isMobile() ? 45 : 0,
            font: chartTickFont(),
            color: chartTextColor()
          }
        },
        y: {
          grid: { color: chartGridColor() },
          ticks: {
            callback: v => v >= 1000 ? (v/1000) + 'K' : v,
            font: chartTickFont(),
            color: chartTextColor(),
            padding: 8
          }
        }
      }
    }
  });
}

function renderSubscriberGrowthChart(period = 'day') {
  const ctx = document.getElementById('subscriberGrowthChart')?.getContext('2d');
  if (!ctx) return;

  const now = new Date();
  let labels = [];
  let data = [];
  let prevData = [];
  let periodLabels = { day: 'Kunlik', week: 'Haftalik', month: 'Oylik', year: 'Yillik' };

  document.getElementById('subscriberGrowthTitle').textContent = periodLabels[period] + ' o\'sish';

  if (period === 'day') {
    // Last 24 hours by hour (current) and previous 24 hours
    const hourlyData = {};
    const prevHourlyData = {};

    for (let i = 23; i >= 0; i--) {
      const h = new Date(now);
      h.setHours(h.getHours() - i, 0, 0, 0);
      const key = h.getHours();
      hourlyData[23 - i] = { hour: key, count: 0 };
      prevHourlyData[23 - i] = { hour: key, count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const diffHours = (now - date) / (1000 * 60 * 60);

      if (diffHours <= 24) {
        const hourIndex = Math.floor(23 - diffHours);
        if (hourIndex >= 0 && hourlyData[hourIndex]) hourlyData[hourIndex].count++;
      } else if (diffHours <= 48) {
        const hourIndex = Math.floor(23 - (diffHours - 24));
        if (hourIndex >= 0 && prevHourlyData[hourIndex]) prevHourlyData[hourIndex].count++;
      }
    });

    Object.values(hourlyData).forEach((d, i) => {
      labels.push(d.hour + ':00');
      data.push(d.count);
      prevData.push(prevHourlyData[i]?.count || 0);
    });

  } else if (period === 'week') {
    // Last 7 days (current) and previous 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};
    const prevDailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      dailyData[key] = { label: days[d.getDay()], count: 0 };

      const pd = new Date(now);
      pd.setDate(pd.getDate() - i - 7);
      const prevKey = pd.toISOString().split('T')[0];
      prevDailyData[prevKey] = { label: days[pd.getDay()], count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) dailyData[key].count++;
      if (prevDailyData[key]) prevDailyData[key].count++;
    });

    const prevValues = Object.values(prevDailyData);
    Object.values(dailyData).forEach((d, i) => {
      labels.push(d.label);
      data.push(d.count);
      prevData.push(prevValues[i]?.count || 0);
    });

  } else if (period === 'month') {
    // Current month by days vs previous month
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
    const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
    const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();

    const dailyData = {};
    const prevDailyData = {};
    const maxDays = Math.min(now.getDate(), daysInMonth);

    for (let i = 1; i <= maxDays; i++) {
      dailyData[i] = 0;
      prevDailyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const day = date.getDate();

      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        if (dailyData[day] !== undefined) dailyData[day]++;
      } else if (date.getMonth() === prevMonth && date.getFullYear() === prevYear && day <= maxDays) {
        if (prevDailyData[day] !== undefined) prevDailyData[day]++;
      }
    });

    Object.entries(dailyData).forEach(([day, count]) => {
      labels.push(day);
      data.push(count);
      prevData.push(prevDailyData[day] || 0);
    });

  } else if (period === 'year') {
    // Current year months vs previous year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};
    const prevMonthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
      prevMonthlyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const month = date.getMonth();

      if (date.getFullYear() === now.getFullYear() && month <= now.getMonth()) {
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      } else if (date.getFullYear() === now.getFullYear() - 1 && month <= now.getMonth()) {
        prevMonthlyData[month] = (prevMonthlyData[month] || 0) + 1;
      }
    });

    Object.entries(monthlyData).forEach(([month, count]) => {
      labels.push(months[parseInt(month)]);
      data.push(count);
      prevData.push(prevMonthlyData[month] || 0);
    });
  }

  // Calculate totals and growth percentage
  const currentTotal = data.reduce((a, b) => a + b, 0);
  const previousTotal = prevData.reduce((a, b) => a + b, 0);

  let growthPercent = 0;
  if (previousTotal > 0) {
    growthPercent = Math.round(((currentTotal - previousTotal) / previousTotal) * 100);
  } else if (currentTotal > 0) {
    growthPercent = 100;
  }

  // Update comparison text
  document.getElementById('currentPeriodCount').textContent = currentTotal;
  document.getElementById('prevPeriodCount').textContent = previousTotal;

  const indicator = document.getElementById('growthIndicator');
  const arrow = document.getElementById('growthArrow');
  const percent = document.getElementById('growthPercent');

  if (growthPercent >= 0) {
    indicator.className = 'flex items-center gap-1 text-green-600 font-semibold text-lg';
    arrow.textContent = '‚Üë';
    percent.textContent = '+' + growthPercent + '%';
  } else {
    indicator.className = 'flex items-center gap-1 text-red-600 font-semibold text-lg';
    arrow.textContent = '‚Üì';
    percent.textContent = growthPercent + '%';
  }

  if (subscriberGrowthChart) subscriberGrowthChart.destroy();

  subscriberGrowthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Bu davr',
          data,
          borderColor: chartAccent(),
          backgroundColor: chartAccentSoft(),
          fill: true,
          tension: 0.4,
          pointRadius: isMobile() ? 2 : 4,
          pointHoverRadius: isMobile() ? 3 : 5,
          borderWidth: isMobile() ? 2 : 3,
          pointBackgroundColor: chartAccent(),
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        },
        {
          label: 'O\'tgan davr',
          data: prevData,
          borderColor: chartMuted(),
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.4,
          pointRadius: isMobile() ? 1.5 : 3,
          pointHoverRadius: isMobile() ? 2.5 : 4,
          borderWidth: isMobile() ? 2 : 3,
          pointBackgroundColor: chartMuted(),
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: chartLayoutPadding() },
      plugins: { legend: { display: false } },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: true,
            maxTicksLimit: chartMaxXTicks(),
            autoSkipPadding: isMobile() ? 18 : 6,
            maxRotation: isMobile() ? 45 : 0,
            minRotation: isMobile() ? 45 : 0,
            font: chartTickFont(),
            color: chartTextColor()
          }
        },
        y: {
          grid: { color: chartGridColor() },
          beginAtZero: true,
          ticks: { stepSize: 1, font: chartTickFont(), color: chartTextColor(), padding: 6 }
        }
      }
    }
  });
}

function renderUserTypeChart() {
  const ctx = document.getElementById('userTypeChart')?.getContext('2d');
  if (!ctx) return;

  const active = allUsers.filter(u => !u.is_paid && !u.lessons_completed).length;
  const paid = allUsers.filter(u => u.is_paid).length;
  const completed = allUsers.filter(u => u.lessons_completed && !u.is_paid).length;

  if (userTypeChart) userTypeChart.destroy();

  userTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Aktiv', 'To\'lagan', 'Tugatgan'],
      datasets: [{
        data: [active, paid, completed],
        backgroundColor: [chartAccent(), '#12b981', 'rgba(148,163,184,0.35)'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: isMobile() ? '68%' : '70%',
      plugins: { legend: { display: false } }
    }
  });
}

function renderCustDevCharts() {
  const colors = [chartAccent(), '#12b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Map various field_name values to chart keys
  const fieldNameMap = {
    // English variations
    'age': 'age', 'age_group': 'age', 'yosh': 'age',
    'occupation': 'occupation', 'kasb': 'occupation', 'job': 'occupation',
    'income': 'income', 'income_level': 'income', 'daromad': 'income',
    'budget': 'budget', 'budget_range': 'budget', 'byudjet': 'budget'
  };

  // Group answers by mapped field_name
  const fieldData = {};
  allCustDev.forEach(q => {
    if (q.field_name && custdevAnswers[q.id]) {
      const answers = custdevAnswers[q.id];
      const mappedField = fieldNameMap[q.field_name.toLowerCase()] || q.field_name;
      if (!fieldData[mappedField]) fieldData[mappedField] = {};

      answers.forEach(a => {
        const value = a.answer_text || 'Boshqa';
        fieldData[mappedField][value] = (fieldData[mappedField][value] || 0) + 1;
      });
    }
  });

  // Render charts for each field
  ['age', 'occupation', 'income', 'budget'].forEach((field, idx) => {
    const ctx = document.getElementById(field + 'Chart')?.getContext('2d');
    if (!ctx) return;

    const data = fieldData[field] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window[field + 'ChartInstance']) window[field + 'ChartInstance'].destroy();

    window[field + 'ChartInstance'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: isMobile() ? '62%' : '60%',
        plugins: { legend: { display: false } }
      }
    });

    // Render legend
    const legendContainer = document.getElementById(field + 'ChartLegend');
    if (legendContainer && labels.length) {
      legendContainer.innerHTML = labels.slice(0, 4).map((label, i) => `
        <div class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full" style="background: ${colors[i % colors.length]}"></span>
          <span class="truncate">${label}: ${values[i]}</span>
        </div>
      `).join('');
    }
  });
}

// ========== MODALS ==========
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  // Load bot username for source link modal
  if (id === 'sourceLinkModal') {
    loadBotUsername();
  }
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ========== SOURCE LINK GENERATOR ==========
let botUsername = '';

async function loadBotUsername() {
  try {
    if (!botUsername) {
      const botInfo = await (await fetch('/api/bot-info', { headers: { Authorization: auth } })).json();
      botUsername = botInfo.username || 'your_bot';
    }
  } catch(e) {
    console.error('loadBotUsername error:', e);
  }
}

function setSourceName(name) {
  document.getElementById('sourceNameInput').value = name;
  generateSourceLink();
}

function generateSourceLink() {
  const sourceName = document.getElementById('sourceNameInput').value.trim();
  const container = document.getElementById('generatedLinkContainer');
  const linkInput = document.getElementById('generatedSourceLink');

  // Clean source name: only allow letters, numbers, underscore
  const cleanSource = sourceName.toLowerCase().replace(/[^a-z0-9_]/g, '');

  if (!cleanSource) {
    container.classList.add('hidden');
    return;
  }

  const link = `https://t.me/${botUsername || 'your_bot'}?start=_${cleanSource}`;
  linkInput.value = link;
  container.classList.remove('hidden');
  document.getElementById('sourceLinkCopied').style.display = 'none';
}

function copySourceLink() {
  const linkInput = document.getElementById('generatedSourceLink');
  linkInput.select();
  document.execCommand('copy');
  document.getElementById('sourceLinkCopied').style.display = 'block';
  setTimeout(() => {
    document.getElementById('sourceLinkCopied').style.display = 'none';
  }, 2000);
}

// ========== DELETE USER ==========
async function deleteUser(telegramId, userName) {
  if (!confirm(`"${userName}" ni o'chirmoqchimisiz?\n\nBu foydalanuvchining barcha ma'lumotlari o'chiriladi:\n- To'lovlar\n- Obunalar\n- Dars javoblari\n- Referral ma'lumotlari\n\nBu amalni qaytarib bo'lmaydi!`)) {
    return;
  }

  try {
    const res = await fetch(`/api/users/${telegramId}`, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });

    const data = await res.json();
    if (data.success) {
      showToast('Foydalanuvchi o\'chirildi', 'success');
      // Remove from local array
      allUsers = allUsers.filter(u => u.telegram_id !== telegramId);
      // Re-render
      applyUserFilters();
      loadStats();
    } else {
      showToast('Xatolik: ' + (data.error || 'Noma\'lum xatolik'), 'error');
    }
  } catch (e) {
    showToast('Xatolik: ' + e.message, 'error');
  }
}

// ========== USER DETAIL ==========
async function openUserDetail(telegramId) {
  const user = allUsers.find(u => u.telegram_id == telegramId);
  if (!user) return;

  const displayName = user.full_name || user.username || 'Foydalanuvchi';
  document.getElementById('userDetailAvatar').textContent = displayName.charAt(0).toUpperCase();
  document.getElementById('userDetailName').textContent = displayName;
  document.getElementById('userDetailUsername').textContent = user.username ? '@' + user.username : 'username yo\'q';
  document.getElementById('userDetailTgId').textContent = user.telegram_id;
  document.getElementById('userDetailPhone').textContent = user.phone || '-';
  document.getElementById('userDetailLesson').textContent = (user.current_lesson || 0) + '-dars';
  document.getElementById('userDetailStatus').innerHTML = user.is_paid
    ? (user.joined_premium_channel
        ? '<span class="badge badge-green">Premium</span> <span class="text-green-600 text-xs">‚úì Kanalda</span>'
        : '<span class="badge badge-orange">To\'lagan</span> <span class="text-red-500 text-xs">‚úó Kanalda emas</span>')
    : '<span class="badge badge-gray">Free</span>';
  document.getElementById('userDetailCreated').textContent = fmtDateTime(user.created_at);

  // Load user's custdev answers
  try {
    const answers = await (await fetch('/api/users/' + telegramId + '/custdev', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('userDetailCustdev');

    if (!answers || !answers.length) {
      container.innerHTML = '<p class="text-gray-400 text-center py-4">Javoblar yo\'q</p>';
    } else {
      container.innerHTML = answers.map(a => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500 mb-1">${a.question_text}</p>
          <p class="font-medium text-gray-800">${a.answer_text}</p>
        </div>
      `).join('');
    }
  } catch(e) {
    document.getElementById('userDetailCustdev').innerHTML = '<p class="text-red-400 text-center py-4">Xatolik</p>';
  }

  // Store current user for sending message
  window.currentUserTgId = telegramId;
  openModal('userDetailModal');
}

function sendMessageToUser() {
  closeModal('userDetailModal');
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  const user = allUsers.find(u => u.telegram_id == window.currentUserTgId);
  if (user) {
    selectedBroadcastUsers.add(user.telegram_id);
    updateSelectedUsersList();
  }
}

// ========== BROADCAST ==========
function openBroadcastModal() {
  selectedBroadcastUsers.clear();
  document.getElementById('broadcastTarget').value = 'all';
  document.getElementById('broadcastType').value = 'text';
  document.getElementById('broadcastText').value = '';
  document.getElementById('broadcastMediaId').value = '';
  document.getElementById('broadcastBtnText').value = '';
  document.getElementById('broadcastBtnUrl').value = '';
  document.getElementById('broadcastProgress')?.classList.add('hidden');
  document.getElementById('charCount').textContent = '0';
  toggleUserSelect();
  toggleBroadcastMedia();
  updateRecipientCount();
  updatePreview();
  openModal('broadcastModal');
}

function toggleUserSelect() {
  const target = document.getElementById('broadcastTarget').value;
  document.getElementById('userSelectDiv').classList.toggle('hidden', target !== 'specific');
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }
}

function toggleBroadcastMedia() {
  const type = document.getElementById('broadcastType').value;
  document.getElementById('broadcastMediaDiv').classList.toggle('hidden', type === 'text');
}

function searchBroadcastUsers() {
  const query = document.getElementById('broadcastUserSearch').value.toLowerCase();
  const container = document.getElementById('broadcastUsersList');

  if (!query) {
    container.innerHTML = '<p class="text-gray-400 text-sm">Qidirish...</p>';
    return;
  }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  ).slice(0, 10);

  container.innerHTML = filtered.map(u => `
    <div class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="toggleBroadcastUser(${u.telegram_id})">
      <input type="checkbox" ${selectedBroadcastUsers.has(u.telegram_id) ? 'checked' : ''} class="pointer-events-none">
      <span class="text-sm">${u.full_name || u.username || 'User'}</span>
      <span class="text-xs text-gray-400">${u.phone || u.telegram_id}</span>
    </div>
  `).join('') || '<p class="text-gray-400 text-sm">Topilmadi</p>';
}

function toggleBroadcastUser(telegramId) {
  if (selectedBroadcastUsers.has(telegramId)) {
    selectedBroadcastUsers.delete(telegramId);
  } else {
    selectedBroadcastUsers.add(telegramId);
  }
  searchBroadcastUsers();
  updateSelectedUsersList();
}

function updateSelectedUsersList() {
  document.getElementById('selectedUsersCount').textContent = selectedBroadcastUsers.size;

  const container = document.getElementById('selectedUsersList');
  container.innerHTML = Array.from(selectedBroadcastUsers).map(id => {
    const user = allUsers.find(u => u.telegram_id == id);
    return `
      <span class="badge badge-blue flex items-center gap-1">
        ${user?.full_name || user?.username || id}
        <button onclick="toggleBroadcastUser(${id})" class="ml-1">√ó</button>
      </span>
    `;
  }).join('');
}

async function sendBroadcast() {
  const target = document.getElementById('broadcastTarget').value;
  const type = document.getElementById('broadcastType').value;
  const text = document.getElementById('broadcastText').value;
  const mediaId = document.getElementById('broadcastMediaId').value;
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;

  if (!text.trim() && type === 'text') {
    alert('Xabar matni bo\'sh');
    return;
  }

  if (type !== 'text' && type !== 'video_note' && !mediaId.trim()) {
    alert('Media File ID kiriting');
    return;
  }

  if (target === 'specific' && selectedBroadcastUsers.size === 0) {
    alert('Kamida bitta foydalanuvchi tanlang');
    return;
  }

  // Get recipient count
  const recipientCount = parseInt(document.getElementById('recipientCount').textContent) || 0;
  if (recipientCount === 0) {
    alert('Yuborish uchun foydalanuvchi yo\'q');
    return;
  }

  // Confirm before sending
  if (!confirm(`${recipientCount} ta foydalanuvchiga xabar yuboriladi. Davom etasizmi?`)) {
    return;
  }

  // Show progress
  const progressDiv = document.getElementById('broadcastProgress');
  const progressBar = document.getElementById('broadcastProgressBar');
  const sentSpan = document.getElementById('broadcastSent');
  const totalSpan = document.getElementById('broadcastTotal');

  progressDiv.classList.remove('hidden');
  totalSpan.textContent = recipientCount;
  sentSpan.textContent = '0';
  progressBar.style.width = '0%';

  try {
    const body = {
      target,
      type,
      text,
      media_id: mediaId || null,
      button: btnText && btnUrl ? { text: btnText, url: btnUrl } : null,
      user_ids: target === 'specific' ? Array.from(selectedBroadcastUsers) : null,
      lesson_from: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0 : null,
      lesson_to: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonTo')?.value) || 999 : null
    };

    const res = await fetch('/api/broadcast/advanced', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const result = await res.json();

    // Complete progress
    progressBar.style.width = '100%';
    sentSpan.textContent = result.sent || 0;

    if (res.ok) {
      setTimeout(() => {
        progressDiv.classList.add('hidden');
        alert(`‚úÖ Xabar yuborildi!\n\nüì§ ${result.sent || 0} ta muvaffaqiyatli\n‚ùå ${result.failed || 0} ta xato`);
        closeModal('broadcastModal');

        // Reset form
        document.getElementById('broadcastText').value = '';
        document.getElementById('broadcastMediaId').value = '';
        document.getElementById('broadcastBtnText').value = '';
        document.getElementById('broadcastBtnUrl').value = '';
        selectedBroadcastUsers.clear();
        updateRecipientCount();
      }, 500);
    } else {
      progressDiv.classList.add('hidden');
      alert('Xatolik: ' + (result.error || 'Noma\'lum xato'));
    }
  } catch(e) {
    progressDiv.classList.add('hidden');
    alert('Xatolik: ' + e.message);
  }
}

// ========== LESSONS ==========
function openLessonModal() {
  document.getElementById('lessonModalTitle').textContent = 'üìö Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonNumber').value = allLessons.length + 1;
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonText').value = '';
  document.getElementById('lessonDelay').value = 24;
  document.getElementById('lessonVideoFileId').value = '';
  document.getElementById('lessonVideoNoteFileId').value = '';
  document.getElementById('lessonAudioFileId').value = '';
  document.getElementById('lessonDocumentFileId').value = '';
  document.getElementById('lessonPhotoFileId').value = '';
  openModal('lessonModal');
}

function editLesson(id) {
  const lesson = allLessons.find(l => l.id === id);
  if (!lesson) return;

  document.getElementById('lessonModalTitle').textContent = '‚úèÔ∏è Darsni tahrirlash';
  document.getElementById('lessonId').value = lesson.id;
  document.getElementById('lessonNumber').value = lesson.lesson_number;
  document.getElementById('lessonTitle').value = lesson.title;
  document.getElementById('lessonText').value = lesson.content || lesson.text || '';
  document.getElementById('lessonDelay').value = lesson.delay_hours || 0;
  document.getElementById('lessonVideoFileId').value = lesson.video_file_id || '';
  document.getElementById('lessonVideoNoteFileId').value = lesson.video_note_file_id || '';
  document.getElementById('lessonAudioFileId').value = lesson.audio_file_id || '';
  document.getElementById('lessonDocumentFileId').value = lesson.document_file_id || '';
  document.getElementById('lessonPhotoFileId').value = lesson.photo_file_id || '';
  openModal('lessonModal');
}

document.getElementById('lessonForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('lessonId').value;
  const data = {
    lesson_number: parseInt(document.getElementById('lessonNumber').value),
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonText').value,
    delay_hours: parseInt(document.getElementById('lessonDelay').value) || 0,
    video_file_id: document.getElementById('lessonVideoFileId').value || null,
    video_note_file_id: document.getElementById('lessonVideoNoteFileId').value || null,
    audio_file_id: document.getElementById('lessonAudioFileId').value || null,
    document_file_id: document.getElementById('lessonDocumentFileId').value || null,
    photo_file_id: document.getElementById('lessonPhotoFileId').value || null
  };

  try {
    const url = id ? '/api/lessons/' + id : '/api/lessons';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('lessonModal');
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteLesson(id) {
  if (!confirm('Darsni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/lessons/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== CUSTDEV ==========
function openCustDevModal() {
  document.getElementById('custdevModalTitle').textContent = 'üìù Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevAfterLesson').value = 1;
  document.getElementById('custdevQuestion').value = '';
  document.getElementById('custdevType').value = 'text';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevFieldName').value = '';
  document.getElementById('custdevOptionsDiv').classList.add('hidden');
  openModal('custdevModal');
}

function editCustDev(id) {
  const q = allCustDev.find(c => c.id === id);
  if (!q) return;

  document.getElementById('custdevModalTitle').textContent = '‚úèÔ∏è Savolni tahrirlash';
  document.getElementById('custdevId').value = q.id;
  document.getElementById('custdevAfterLesson').value = q.after_lesson;
  document.getElementById('custdevQuestion').value = q.question_text;
  document.getElementById('custdevType').value = q.question_type;
  document.getElementById('custdevOptions').value = q.options ? q.options.join('\n') : '';
  document.getElementById('custdevFieldName').value = q.field_name || '';
  toggleCustdevOptions();
  openModal('custdevModal');
}

function toggleCustdevOptions() {
  const type = document.getElementById('custdevType').value;
  document.getElementById('custdevOptionsDiv').classList.toggle('hidden', type !== 'buttons');
}

document.getElementById('custdevForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('custdevId').value;
  const type = document.getElementById('custdevType').value;
  const optionsText = document.getElementById('custdevOptions').value;

  const data = {
    after_lesson: parseInt(document.getElementById('custdevAfterLesson').value),
    question_text: document.getElementById('custdevQuestion').value,
    question_type: type,
    options: type === 'buttons' ? optionsText.split('\n').filter(o => o.trim()) : null,
    field_name: document.getElementById('custdevFieldName').value || null
  };

  try {
    const url = id ? '/api/custdev/' + id : '/api/custdev';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('custdevModal');
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteCustDev(id) {
  if (!confirm('Savolni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/custdev/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

async function openQuestionStats(questionId) {
  const question = allCustDev.find(q => q.id === questionId);
  if (!question) return;

  document.getElementById('custdevStatsTitle').textContent = 'üìä ' + question.question_text.substring(0, 50) + '...';

  // Get answers for this question
  const answers = custdevAnswers[questionId] || [];

  // Count answers
  const answerCounts = {};
  answers.forEach(a => {
    const value = a.answer_text || 'Boshqa';
    answerCounts[value] = (answerCounts[value] || 0) + 1;
  });

  const labels = Object.keys(answerCounts);
  const values = Object.values(answerCounts);
  const colors = [chartAccent(), '#12b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Render chart
  const ctx = document.getElementById('questionStatsChart')?.getContext('2d');
  if (ctx) {
    if (questionStatsChart) questionStatsChart.destroy();

    questionStatsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { boxWidth: 8, font: chartTickFont(), color: chartTextColor() }
          }
        }
      }
    });
  }

  // Render answers list
  const listContainer = document.getElementById('questionAnswersList');
  listContainer.innerHTML = labels.map((label, i) => `
    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full" style="background: ${colors[i % colors.length]}"></span>
        <span class="font-medium">${label}</span>
      </div>
      <span class="text-gray-600">${values[i]} (${Math.round(values[i] / answers.length * 100)}%)</span>
    </div>
  `).join('') || '<p class="text-gray-400">Javoblar yo\'q</p>';

  openModal('custdevStatsModal');
}

// ========== PROGREV SETTINGS ==========
async function saveProgrevSettings() {
  try {
    const mediaType = document.getElementById('pitchMediaType').value;
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        // Start messages
        welcome: document.getElementById('startWelcomeText').value,
        ask_name: document.getElementById('startAskNameText').value,
        // Step 1: Congrats
        congrats_text: document.getElementById('congratsText').value,
        // Step 2: Feedback question
        feedback_enabled: document.getElementById('feedbackEnabled').checked,
        pitch_delay_minutes: parseInt(document.getElementById('pitchDelayMinutes').value) || 0,
        feedback_question: document.getElementById('feedbackQuestion').value,
        feedback_yes_btn: document.getElementById('feedbackYesBtn').value,
        feedback_no_btn: document.getElementById('feedbackNoBtn').value,
        // Step 3: Pitch info (after "Ha")
        pitch_info_text: document.getElementById('pitchInfoText').value,
        pitch_info_btn: document.getElementById('pitchInfoBtn').value,
        pitch_media_type: mediaType,
        pitch_video_file_id: mediaType === 'video' ? document.getElementById('pitchVideoFileId').value : null,
        pitch_audio_file_id: mediaType === 'audio' ? document.getElementById('pitchAudioFileId').value : null,
        pitch_image_file_id: mediaType === 'image' ? document.getElementById('pitchImageFileId').value : null,
        pitch_video_note_file_id: mediaType === 'video_note' ? document.getElementById('pitchVideoNoteFileId').value : null,
        // Step 3b: Negative response
        feedback_no_response: document.getElementById('feedbackNoResponse').value,
        feedback_followup: document.getElementById('feedbackFollowup').value,
        feedback_special_offer_enabled: document.getElementById('feedbackSpecialOfferEnabled').checked,
        feedback_special_offer: document.getElementById('feedbackSpecialOffer').value,
        feedback_no_sales_delay: parseInt(document.getElementById('feedbackNoSalesDelay').value) || 30,
        // Step 4: Sales pitch
        sales_pitch: document.getElementById('salesPitchText').value,
        sales_delay_minutes: parseInt(document.getElementById('salesDelayMinutes').value) || 0,
        // Step 5: Soft attack
        soft_attack_disabled: document.getElementById('softAttackDisabled').checked,
        soft_attack_text: document.getElementById('softAttackText').value,
        soft_attack_delay_minutes: parseInt(document.getElementById('softAttackDelayMinutes').value) || 1440,
        // Lesson completion defaults
        watched_message_default: document.getElementById('watchedMessageDefault').value,
        watched_button_default: document.getElementById('watchedButtonDefault').value
      })
    });

    alert('‚úÖ Progrev sozlamalari saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== SETTINGS ==========

async function loadRenewalSettings() {
  try {
    const data = await (await fetch('/api/subscription-reminders', { headers: { Authorization: auth } })).json();
    document.getElementById('renewalReminder10d').value = data.reminder_10d || '';
    document.getElementById('renewalReminder5d').value = data.reminder_5d || '';
    document.getElementById('renewalReminder3d').value = data.reminder_3d || '';
    document.getElementById('renewalReminder1d').value = data.reminder_1d || '';
    document.getElementById('renewalReminderExpired').value = data.reminder_expired || '';
  } catch (e) {
    console.error('loadRenewalSettings error:', e);
  }
}

async function saveRenewalSettings() {
  try {
    await fetch('/api/subscription-reminders', {
      method: 'PUT',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        reminder_10d: document.getElementById('renewalReminder10d').value,
        reminder_5d: document.getElementById('renewalReminder5d').value,
        reminder_3d: document.getElementById('renewalReminder3d').value,
        reminder_1d: document.getElementById('renewalReminder1d').value,
        reminder_expired: document.getElementById('renewalReminderExpired').value
      })
    });

    alert('‚úÖ Uzaytirish eslatmalari saqlandi!');
  } catch (e) {
    alert('Xatolik: ' + e.message);
  }
}

// Auto-calculate 3/6/12 month prices with discounts
function calculateDiscountedPrices() {
  const price1m = parseInt(document.getElementById('settingPrice1m').value) || 0;
  if (price1m > 0) {
    // Automatic discounts: 3 months = 10%, 6 months = 25%, 12 months = 40%
    document.getElementById('settingPrice3m').value = Math.round(price1m * 3 * 0.90);
    document.getElementById('settingPrice6m').value = Math.round(price1m * 6 * 0.75);
    document.getElementById('settingPrice12m').value = Math.round(price1m * 12 * 0.60);
  }
}

async function saveSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        premium_channel_id: document.getElementById('settingPremiumChannel').value,
        free_channel_id: document.getElementById('settingFreeChannel').value,
        free_channel_link: document.getElementById('settingFreeChannelLink').value,
        require_subscription_before_lesson: parseInt(document.getElementById('settingRequireSub').value) || 0,
        subscription_bypass_enabled: document.getElementById('settingSubBypassEnabled').checked ? 'true' : 'false',
        subscription_bypass_attempts: parseInt(document.getElementById('settingSubBypassAttempts').value) || 3,
        payme_enabled: document.getElementById('settingPayme').checked,
        click_enabled: document.getElementById('settingClick').checked,
        price_1m: parseInt(document.getElementById('settingPrice1m').value) * 100 || null,
        // 3/6/12 month prices are auto-calculated on server with discounts
        // Inactivity reminder settings
        inactivity_reminder_enabled: document.getElementById('settingInactivityEnabled').checked ? 'true' : 'false',
        inactivity_reminder_1: document.getElementById('settingInactivityReminder1').value,
        inactivity_reminder_2: document.getElementById('settingInactivityReminder2').value,
        // Referral system settings
        referral_enabled: document.getElementById('settingReferralEnabled').checked ? 'true' : 'false',
        referral_required_count: document.getElementById('settingReferralCount').value,
        referral_discount_percent: document.getElementById('settingReferralDiscount').value,
        // Referral offer settings
        referral_offer_enabled: document.getElementById('settingReferralOfferEnabled').checked ? 'true' : 'false',
        referral_offer_delay_hours: document.getElementById('settingReferralOfferDelay').value,
        referral_offer_message: document.getElementById('settingReferralOfferMessage').value
      })
    });

    alert('‚úÖ Sozlamalar saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== ANALYTICS TAB ==========
let analyticsCharts = {};
let auditOffset = 0;

async function loadAnalyticsData() {
  try {
    // Load all analytics data in parallel
    const [revenueData, subscribersData, sourcesData, buyerData, inactivityData, funnelDiagData] = await Promise.all([
      fetch('/api/analytics/revenue?days=30', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/subscribers/daily?days=30', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/analytics/sources', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/analytics/buyers', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/analytics/inactivity', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/analytics/funnel-diagnostics', { headers: { Authorization: auth } }).then(r => r.json())
    ]);

    // Render revenue chart
    renderAnalyticsRevenueChart(revenueData);

    // Render subscribers chart
    renderSubscribersChart(subscribersData);

    // Render sources table and pie chart
    renderSourcesAnalytics(sourcesData);

    // Render buyer journey stats
    renderBuyerAnalytics(buyerData);

    // Render inactivity stats
    renderInactivityStats(inactivityData);

    // Render funnel diagnostics
    renderFunnelDiagnostics(funnelDiagData);

  } catch(e) {
    console.error('loadAnalyticsData error:', e);
  }
}

function renderAnalyticsRevenueChart(data) {
  const ctx = document.getElementById('analyticsRevenueChart');
  if (!ctx) return;

  if (analyticsCharts.revenue) {
    analyticsCharts.revenue.destroy();
  }

  const labels = data.map(d => {
    const date = new Date(d.date);
    return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
  });

  const values = data.map(d => Math.round((d.revenue || 0) / 100));

  analyticsCharts.revenue = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Daromad',
        data: values,
        borderColor: '#5b7cfa',
        backgroundColor: 'rgba(91, 124, 250, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v.toLocaleString() + " so'm" }
        }
      }
    }
  });
}

function renderSubscribersChart(data) {
  const ctx = document.getElementById('analyticsSubscribersChart');
  if (!ctx) return;

  if (analyticsCharts.subscribers) {
    analyticsCharts.subscribers.destroy();
  }

  const labels = data.map(d => {
    const date = new Date(d.date);
    return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
  });

  const newUsers = data.map(d => d.new_users || 0);
  const paidUsers = data.map(d => d.new_paid || 0);

  analyticsCharts.subscribers = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Yangi userlar',
          data: newUsers,
          backgroundColor: 'rgba(91, 124, 250, 0.7)',
          borderRadius: 4
        },
        {
          label: "To'lagan",
          data: paidUsers,
          backgroundColor: 'rgba(34, 197, 94, 0.7)',
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderSourcesAnalytics(data) {
  const tableBody = document.getElementById('sourcesTable');
  const ctx = document.getElementById('sourcesPieChart');

  if (!data.sources || data.sources.length === 0) {
    if (tableBody) tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Ma\'lumot yo\'q</td></tr>';
    return;
  }

  // Render table
  if (tableBody) {
    tableBody.innerHTML = data.sources.map(s => {
      const conv = s.total_users > 0 ? Math.round((s.paid_users / s.total_users) * 100) : 0;
      const sourceName = getSourceName(s.source);
      return `
        <tr class="border-b border-gray-100">
          <td class="py-3">${sourceName}</td>
          <td class="py-3 font-medium">${s.total_users}</td>
          <td class="py-3 text-green-600">${s.paid_users}</td>
          <td class="py-3"><span class="badge ${conv > 10 ? 'badge-green' : conv > 5 ? 'badge-yellow' : 'badge-gray'}">${conv}%</span></td>
        </tr>
      `;
    }).join('');
  }

  // Render pie chart
  if (ctx) {
    if (analyticsCharts.sources) {
      analyticsCharts.sources.destroy();
    }

    const colors = ['#5b7cfa', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];

    analyticsCharts.sources = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: data.sources.map(s => getSourceName(s.source)),
        datasets: [{
          data: data.sources.map(s => s.total_users),
          backgroundColor: colors.slice(0, data.sources.length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' }
        }
      }
    });
  }
}

function getSourceName(source) {
  const names = {
    'direct': 'üåê Direct',
    'instagram': 'üì∏ Instagram',
    'telegram': 'üì± Telegram',
    'facebook': 'üë§ Facebook',
    'youtube': 'üé¨ YouTube',
    'tiktok': 'üéµ TikTok'
  };
  return names[source] || ('üîó ' + source);
}

function renderBuyerAnalytics(data) {
  // Total buyers
  document.getElementById('buyerAvgLesson').textContent = data.totalBuyers || '0';

  // avgTimeToPurchase is in milliseconds, convert to days
  const avgDays = data.avgTimeToPurchase ? (data.avgTimeToPurchase / (1000 * 60 * 60 * 24)).toFixed(1) : '-';
  document.getElementById('buyerAvgDays').textContent = avgDays;

  // Conversion rate
  document.getElementById('buyerConversion').textContent = data.conversionRate ? data.conversionRate.toFixed(1) + '%' : '0%';

  // Fastest purchase in days
  const fastestDays = data.fastestPurchase ? (data.fastestPurchase / (1000 * 60 * 60 * 24)).toFixed(1) : '-';
  document.getElementById('buyerAvgCheck').textContent = fastestDays + ' kun';

  // Render buyer demographics chart (by age group)
  const ctx = document.getElementById('buyerFunnelChart');
  if (ctx) {
    if (analyticsCharts.buyerFunnel) {
      analyticsCharts.buyerFunnel.destroy();
    }

    const ageData = data.buyersByAge || {};
    const hasAgeData = Object.keys(ageData).length > 0;

    if (hasAgeData) {
      analyticsCharts.buyerFunnel = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(ageData),
          datasets: [{
            label: 'Xaridorlar soni',
            data: Object.values(ageData),
            backgroundColor: ['#5b7cfa', '#8b5cf6', '#f59e0b', '#22c55e', '#ef4444'],
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }
  }
}

function renderInactivityStats(data) {
  document.getElementById('inactTotalDeliveries').textContent = data.total_deliveries || '-';
  document.getElementById('inactWatched').textContent = data.watched || '-';
  document.getElementById('inactReminder1').textContent = data.reminder_1_sent || '-';
  document.getElementById('inactReminder2').textContent = data.reminder_2_sent || '-';
  document.getElementById('inactWatchedAfter').textContent = data.watched_after_reminder || '-';
}

function renderFunnelDiagnostics(data) {
  const summary = data?.summary || {};
  const stages = Array.isArray(data?.stages) ? data.stages : [];
  const alerts = Array.isArray(data?.alerts) ? data.alerts : [];
  const biggestDrop = data?.biggestDrop || null;

  const overallCrEl = document.getElementById('diagOverallCR');
  const biggestDropEl = document.getElementById('diagBiggestDrop');
  const stuckEl = document.getElementById('diagStuckUsers');
  const nextActionEl = document.getElementById('diagNextAction');
  const tableBody = document.getElementById('diagFunnelTable');
  const alertsWrap = document.getElementById('diagAlerts');

  if (overallCrEl) overallCrEl.textContent = (summary.overallConversion ?? 0) + '%';
  if (biggestDropEl) {
    biggestDropEl.textContent = biggestDrop
      ? `${biggestDrop.from} -> ${biggestDrop.to} (${biggestDrop.dropCount} user)`
      : '-';
  }
  if (stuckEl) stuckEl.textContent = summary.pitchWithoutCheckout ?? 0;
  if (nextActionEl) nextActionEl.textContent = data?.nextAction || '-';

  if (tableBody) {
    if (!stages.length) {
      tableBody.innerHTML = '<tr><td colspan="4" class="py-3 text-center text-gray-400">Ma\'lumot yo\'q</td></tr>';
    } else {
      tableBody.innerHTML = stages.map((s) => `
        <tr class="border-b border-gray-100">
          <td class="py-2">${s.label}</td>
          <td class="py-2 font-semibold">${s.count}</td>
          <td class="py-2">${(s.fromPrev ?? 0)}%</td>
          <td class="py-2">${(s.fromStart ?? 0)}%</td>
        </tr>
      `).join('');
    }
  }

  if (alertsWrap) {
    if (!alerts.length) {
      alertsWrap.innerHTML = '<div class="text-sm text-green-700 bg-green-50 border border-green-100 rounded-lg px-3 py-2">Hozircha kritik signal yo\'q.</div>';
    } else {
      alertsWrap.innerHTML = alerts.map((a) => {
        const tone = a.level === 'high'
          ? 'bg-red-50 border-red-100 text-red-700'
          : a.level === 'medium'
            ? 'bg-amber-50 border-amber-100 text-amber-700'
            : 'bg-blue-50 border-blue-100 text-blue-700';
        return `
          <div class="border rounded-lg px-3 py-2 ${tone}">
            <div class="font-semibold text-sm">${a.title}</div>
            <div class="text-xs mt-1">${a.detail}</div>
          </div>
        `;
      }).join('');
    }
  }
}

// ========== REFERRALS TAB ==========
async function loadReferralData() {
  try {
    const [referralData, inviteData] = await Promise.all([
      fetch('/api/analytics/referrals', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/invite-links', { headers: { Authorization: auth } }).then(r => r.json())
    ]);

    // Render referral stats
    const stats = referralData.stats || {};
    document.getElementById('refTotalReferrals').textContent = stats.total_referrals || 0;
    document.getElementById('refQualified').textContent = stats.qualified_referrals || 0;
    document.getElementById('refDiscountsUsed').textContent = stats.discounts_used || 0;
    document.getElementById('refActiveReferrers').textContent = stats.total_referrers || 0;

    // Render leaderboard
    const leaderboard = referralData.leaderboard || [];
    const tbody = document.getElementById('referralLeaderboard');
    if (leaderboard.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Hozircha referallar yo\'q</td></tr>';
    } else {
      tbody.innerHTML = leaderboard.map((u, i) => {
        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
        const discount = u.referral_discount_used ? '<span class="badge badge-green">Oldi</span>' : '<span class="badge badge-gray">-</span>';
        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 font-medium">${medal}</td>
            <td class="py-3">${escapeHtml(u.full_name || u.username || u.telegram_id)}</td>
            <td class="py-3 text-center font-bold text-indigo-600">${u.referral_count}</td>
            <td class="py-3">${discount}</td>
          </tr>
        `;
      }).join('');
    }

    // Render invite links stats
    const links = inviteData.links || [];
    const totalLinks = links.length;
    const usedLinks = links.filter(l => l.is_used).length;
    document.getElementById('inviteTotal').textContent = totalLinks;
    document.getElementById('inviteUsed').textContent = usedLinks;
    document.getElementById('inviteUnused').textContent = totalLinks - usedLinks;

  } catch(e) {
    console.error('loadReferralData error:', e);
  }
}

// ========== AUDIT LOG TAB ==========
async function loadAuditLogs(offset = 0) {
  auditOffset = Math.max(0, offset);

  try {
    const action = document.getElementById('auditActionFilter').value;
    const date = document.getElementById('auditDateFilter').value;

    let url = `/api/audit-logs?limit=50&offset=${auditOffset}`;
    if (action) url += '&action=' + encodeURIComponent(action);
    if (date) url += '&startDate=' + date + '&endDate=' + date;

    const logs = await fetch(url, { headers: { Authorization: auth } }).then(r => r.json());

    const tbody = document.getElementById('auditLogsTable');

    if (!logs || logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">Log topilmadi</td></tr>';
      document.getElementById('auditPrevBtn').disabled = true;
      document.getElementById('auditNextBtn').disabled = true;
      document.getElementById('auditPageInfo').textContent = '0';
      return;
    }

    tbody.innerHTML = logs.map(log => {
      const time = new Date(log.timestamp).toLocaleString('uz-UZ', {
        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
      });
      const actionBadge = getAuditActionBadge(log.action);
      const details = log.details ? JSON.stringify(log.details).slice(0, 50) : '-';

      return `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-3 text-xs text-gray-500">${time}</td>
          <td class="py-3">${actionBadge}</td>
          <td class="py-3 text-sm">${escapeHtml(log.user || '-')}</td>
          <td class="py-3 text-sm">${escapeHtml(log.target || '-')}</td>
          <td class="py-3 text-xs text-gray-400 truncate max-w-[200px]">${escapeHtml(details)}</td>
        </tr>
      `;
    }).join('');

    // Update pagination
    document.getElementById('auditPrevBtn').disabled = auditOffset === 0;
    document.getElementById('auditNextBtn').disabled = logs.length < 50;
    document.getElementById('auditPageInfo').textContent = `${auditOffset + 1}-${auditOffset + logs.length}`;

  } catch(e) {
    console.error('loadAuditLogs error:', e);
    document.getElementById('auditLogsTable').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-400">Xatolik yuz berdi</td></tr>';
  }
}

function getAuditActionBadge(action) {
  const badges = {
    'PAYMENT_COMPLETED': '<span class="badge badge-green">To\'lov</span>',
    'PAYMENT_CREATED': '<span class="badge badge-blue">To\'lov yaratildi</span>',
    'PAYMENT_FAILED': '<span class="badge badge-red">To\'lov xato</span>',
    'USER_CREATED': '<span class="badge badge-blue">Yangi user</span>',
    'USER_UPDATED': '<span class="badge badge-yellow">User yangilandi</span>',
    'SETTINGS_CHANGED': '<span class="badge badge-orange">Sozlama</span>',
    'SECURITY_SUSPICIOUS': '<span class="badge badge-red">Xavfsizlik</span>',
    'SECURITY_RATE_LIMIT': '<span class="badge badge-orange">Rate limit</span>',
    'SUBSCRIPTION_CREATED': '<span class="badge badge-green">Obuna</span>',
    'REFERRAL_CREATED': '<span class="badge badge-blue">Referal</span>',
    'BROADCAST_SENT': '<span class="badge badge-purple">Xabar</span>'
  };
  return badges[action] || `<span class="badge badge-gray">${action}</span>`;
}

async function exportCustDevAnswers() {
  try {
    const answers = await fetch('/api/custdev/answers', { headers: { Authorization: auth } }).then(r => r.json());

    if (!answers || answers.length === 0) {
      alert('Eksport qilish uchun javob topilmadi');
      return;
    }

    // Get all unique question IDs
    const questions = [...new Set(answers.map(a => a.question_id))];

    // Get question texts
    const questionsData = await fetch('/api/custdev', { headers: { Authorization: auth } }).then(r => r.json());
    const questionMap = {};
    questionsData.forEach(q => { questionMap[q.id] = q.question; });

    // Build CSV with user info and their answers
    const userAnswers = {};
    answers.forEach(a => {
      if (!userAnswers[a.telegram_id]) {
        userAnswers[a.telegram_id] = { telegram_id: a.telegram_id };
      }
      userAnswers[a.telegram_id]['q_' + a.question_id] = a.answer;
    });

    const headers = ['Telegram ID', ...questions.map(qId => questionMap[qId] || 'Savol ' + qId)];
    const rows = Object.values(userAnswers).map(u => {
      return [u.telegram_id, ...questions.map(qId => u['q_' + qId] || '')];
    });

    const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'custdev_answers_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();

  } catch(e) {
    console.error('exportCustDevAnswers error:', e);
    alert('Eksport xatosi: ' + e.message);
  }
}

async function exportAuditLogs() {
  try {
    const action = document.getElementById('auditActionFilter').value;
    const date = document.getElementById('auditDateFilter').value;

    let url = '/api/audit-logs?limit=10000';
    if (action) url += '&action=' + encodeURIComponent(action);
    if (date) url += '&startDate=' + date + '&endDate=' + date;

    const logs = await fetch(url, { headers: { Authorization: auth } }).then(r => r.json());

    if (!logs || logs.length === 0) {
      alert('Eksport qilish uchun log topilmadi');
      return;
    }

    // Convert to CSV
    const headers = ['Vaqt', 'Harakat', 'Foydalanuvchi', 'Maqsad', 'Tafsilotlar'];
    const rows = logs.map(log => [
      log.timestamp,
      log.action,
      log.user || '',
      log.target || '',
      log.details ? JSON.stringify(log.details) : ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'audit_logs_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();

  } catch(e) {
    console.error('exportAuditLogs error:', e);
    alert('Eksport xatosi: ' + e.message);
  }
}

// ========== HELPERS ==========
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const now = new Date();
  const date = new Date(dateStr);
  const seconds = Math.floor((now - date) / 1000);

  if (seconds < 60) return 'hozirgina';
  if (seconds < 3600) return Math.floor(seconds / 60) + ' daqiqa oldin';
  if (seconds < 86400) return Math.floor(seconds / 3600) + ' soat oldin';
  if (seconds < 604800) return Math.floor(seconds / 86400) + ' kun oldin';
  return fmtDate(dateStr);
}

function fmtMoney(tiyin) {
  const som = Math.round(tiyin / 100);
  return som.toLocaleString('uz-UZ') + ' so\'m';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
}

function fmtDateTime(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>

</body>
</html>
