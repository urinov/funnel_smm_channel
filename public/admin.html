<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin panel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,400,0,0" rel="stylesheet">
  <style>
    * { font-family: 'Public Sans', sans-serif; box-sizing: border-box; }
    :root {
      /* ═══ SPACING SCALE (4px base) ═══ */
      --space-0: 0;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;

      /* ═══ TYPOGRAPHY ═══ */
      --text-xs: 0.75rem;
      --text-sm: 0.8125rem;
      --text-base: 0.875rem;
      --text-lg: 1rem;
      --text-xl: 1.125rem;
      --text-2xl: 1.25rem;
      --text-3xl: 1.5rem;
      --text-4xl: 1.875rem;
      --font-normal: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;
      --font-extrabold: 800;

      /* ═══ COLORS ═══ */
      --primary-50: #EEF2FF;
      --primary-100: #E0E7FF;
      --primary-500: #6366F1;
      --primary-600: #4F46E5;
      --primary-700: #4338CA;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;

      /* Semantic colors */
      --success-50: #ECFDF5;
      --success-500: #10B981;
      --success-600: #059669;
      --warning-50: #FFFBEB;
      --warning-500: #F59E0B;
      --warning-600: #D97706;
      --error-50: #FEF2F2;
      --error-500: #EF4444;
      --error-600: #DC2626;
      --info-50: #EFF6FF;
      --info-500: #3B82F6;

      /* Semantic aliases */
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-600);
      --text-tertiary: var(--gray-500);
      --text-muted: var(--gray-400);
      --surface-primary: #FFFFFF;
      --surface-secondary: var(--gray-50);
      --border-default: var(--gray-200);
      --border-strong: var(--gray-300);

      /* ═══ SHADOWS ═══ */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-primary: 0 4px 14px rgba(99, 102, 241, 0.25);

      /* ═══ RADII ═══ */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --radius-2xl: 16px;
      --radius-3xl: 20px;
      --radius-full: 9999px;

      /* ═══ TRANSITIONS ═══ */
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-out: cubic-bezier(0, 0, 0.2, 1);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);

      /* ═══ Z-INDEX ═══ */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-fixed: 300;
      --z-modal-backdrop: 400;
      --z-modal: 500;
      --z-tooltip: 700;
      --z-toast: 800;

      /* Legacy variables (for compatibility) */
      --glass-bg: #ffffff;
      --glass-strong: #ffffff;
      --glass-border: #e6e8f0;
      --ink: #1A1A2E;
      --muted: #6B7280;
      --accent: #6366F1;
      --accent-2: #8B5CF6;
      --accent-3: #22C55E;
      --accent-pink: #F472B6;
      --pill: #F5F3FF;
      --shadow: 0 12px 28px rgba(99, 102, 241, 0.15);
      --shadow-soft: 0 4px 18px rgba(99, 102, 241, 0.08);
      --mobile-nav-h: 72px;
      --gradient-primary: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%);
      --gradient-pink: linear-gradient(135deg, #F472B6 0%, #EC4899 100%);
    }

    /* ═══ ACCESSIBILITY ═══ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    :focus-visible { outline: 2px solid var(--primary-500); outline-offset: 2px; border-radius: var(--radius-sm); }
    body {
      background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 50%, #EEF2FF 100%);
      min-height: 100vh;
      color: var(--ink);
      font-size: 14px;
    }
    .material-symbols-outlined { font-size: 18px; line-height: 1; vertical-align: middle; }
    .ui-btn-icon { display: inline-flex; align-items: center; gap: 6px; }
    .skeleton {
      border-radius: 8px;
      background: linear-gradient(90deg, #f1f2f7 0%, #f8f9fc 40%, #f1f2f7 100%);
      background-size: 200% 100%;
      animation: skeletonPulse 1.2s linear infinite;
    }
    @keyframes skeletonPulse {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d7d9e3; border-radius: 6px; }
    ::-webkit-scrollbar-thumb:hover { background: #b8bcc9; }

    /* Sidebar - Modern Purple Gradient */
    .sidebar { width: 80px; background: var(--gradient-primary); border-right: none; box-shadow: 4px 0 24px rgba(99, 102, 241, 0.15); transition: width 0.28s ease; overflow: hidden; }
    .sidebar.expanded { width: 200px; }
    .sidebar-item { width: 52px; height: 52px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8) !important; transition: all 0.25s ease; cursor: pointer; font-size: 20px; gap: 12px; white-space: nowrap; margin-bottom: 8px; }
    .sidebar.expanded .sidebar-item { width: 100%; justify-content: flex-start; padding: 0 16px; }
    .sidebar-item:hover { background: rgba(255,255,255,0.2); color: #ffffff !important; transform: scale(1.02); }
    .sidebar-item:hover .sidebar-label { color: #ffffff !important; }
    .sidebar-item:hover .material-symbols-outlined { color: #ffffff !important; }
    .sidebar-item.active { background: #ffffff; color: #6366F1 !important; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; }
    .sidebar-item.active .sidebar-label { color: #6366F1 !important; }
    .sidebar-item.active .material-symbols-outlined { color: #6366F1 !important; }
    .sidebar-label { display: none; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); }
    .sidebar.expanded .sidebar-label { display: block; }
    .sidebar-item .material-symbols-outlined { color: rgba(255,255,255,0.8); }
    .sidebar-toggle { width: 28px; height: 28px; border-radius: 8px; background: rgba(255,255,255,0.2); color: #ffffff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 12px; backdrop-filter: blur(10px); }
    .sidebar-toggle:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

    /* Sidebar Tooltips */
    .sidebar-item { position: relative; }
    .sidebar-item[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      left: calc(100% + 12px);
      top: 50%;
      transform: translateY(-50%);
      background: var(--gray-800);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-lg);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--duration-fast) var(--ease-default);
      z-index: var(--z-tooltip);
      box-shadow: var(--shadow-lg);
    }
    .sidebar:not(.expanded) .sidebar-item[data-tooltip]:hover::after { opacity: 1; }

    /* Toast Notifications */
    .toast-container { position: fixed; top: var(--space-4); right: var(--space-4); z-index: var(--z-toast); display: flex; flex-direction: column; gap: var(--space-2); pointer-events: none; }
    .toast {
      display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) var(--space-4);
      background: var(--surface-primary); border: 1px solid var(--border-default); border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg); pointer-events: auto; min-width: 280px; max-width: 400px;
      animation: toastSlideIn 0.3s var(--ease-out);
    }
    .toast.toast-success { border-left: 4px solid var(--success-500); }
    .toast.toast-error { border-left: 4px solid var(--error-500); }
    .toast.toast-warning { border-left: 4px solid var(--warning-500); }
    .toast.toast-info { border-left: 4px solid var(--info-500); }
    .toast-icon { width: 24px; height: 24px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast-success .toast-icon { background: var(--success-50); color: var(--success-600); }
    .toast-error .toast-icon { background: var(--error-50); color: var(--error-600); }
    .toast-warning .toast-icon { background: var(--warning-50); color: var(--warning-600); }
    .toast-info .toast-icon { background: var(--info-50); color: var(--info-500); }
    .toast-content { flex: 1; }
    .toast-title { font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--text-primary); }
    .toast-message { font-size: var(--text-xs); color: var(--text-tertiary); margin-top: 2px; }
    .toast-close { width: 28px; height: 28px; border-radius: var(--radius-md); border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--duration-fast); }
    .toast-close:hover { background: var(--gray-100); color: var(--text-secondary); }
    @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastSlideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    .toast.removing { animation: toastSlideOut 0.2s var(--ease-default) forwards; }

    /* Skeleton Loading */
    .skeleton-pulse { background: linear-gradient(90deg, var(--gray-100) 0%, var(--gray-50) 50%, var(--gray-100) 100%); background-size: 200% 100%; animation: skeletonPulse 1.5s ease-in-out infinite; border-radius: var(--radius-lg); }
    .skeleton-card { padding: var(--space-5); }
    .skeleton-card .skeleton-icon { width: 48px; height: 48px; border-radius: var(--radius-xl); margin-bottom: var(--space-4); }
    .skeleton-card .skeleton-label { width: 100px; height: 12px; margin-bottom: var(--space-2); }
    .skeleton-card .skeleton-value { width: 80px; height: 28px; margin-bottom: var(--space-1); }
    .skeleton-card .skeleton-subtitle { width: 120px; height: 12px; }

    /* Error State */
    .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-12) var(--space-6); text-align: center; }
    .error-state-icon { width: 64px; height: 64px; border-radius: var(--radius-full); background: var(--error-50); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-4); }
    .error-state-icon .material-symbols-outlined { font-size: 32px; color: var(--error-500); }
    .error-state-title { font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary); margin-bottom: var(--space-2); }
    .error-state-message { font-size: var(--text-sm); color: var(--text-tertiary); margin-bottom: var(--space-4); max-width: 280px; }

    /* Empty State */
    .empty-state-modern { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-12) var(--space-6); text-align: center; }
    .empty-state-modern-icon { width: 56px; height: 56px; border-radius: var(--radius-full); background: var(--gray-100); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-3); }
    .empty-state-modern-icon .material-symbols-outlined { font-size: 28px; color: var(--text-muted); }
    .empty-state-modern-title { font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-primary); margin-bottom: var(--space-1); }
    .empty-state-modern-message { font-size: var(--text-xs); color: var(--text-tertiary); }

    /* Data Freshness Indicator */
    .freshness-indicator { display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xs); color: var(--text-tertiary); }
    .freshness-dot { width: 8px; height: 8px; border-radius: var(--radius-full); background: var(--success-500); }
    .freshness-dot.stale { background: var(--warning-500); }
    .freshness-dot.pulse { animation: freshnessPulse 2s ease-in-out; }
    @keyframes freshnessPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

    /* Cards */
    .card { background: #fff; border-radius: 20px; border: 1px solid rgba(0,0,0,0.04); box-shadow: 0 2px 12px rgba(0,0,0,0.04); transition: all 0.3s ease; }
    .card-hover:hover { box-shadow: 0 12px 40px rgba(99,102,241,0.12); transform: translateY(-4px); border-color: #6366F1; }
    .hero-card { position: relative; overflow: hidden; }
    .hero-card::after {
      content: '';
      position: absolute;
      inset: -40% -20% auto auto;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 60%);
      pointer-events: none;
    }

    /* Stat card with icon */
    .stat-icon { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 24px rgba(99,102,241,0.2); background: var(--gradient-primary); color: #fff !important; }
    .stat-icon .material-symbols-outlined { color: #fff !important; font-size: 26px; }

    /* Table */
    .table-row { border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.15s ease; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover { background: #f7f7fb; }

    /* Badge */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0; text-transform: none; }
    .badge-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
    .badge-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1d4ed8; }
    .badge-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #c2410c; }
    .badge-yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309; }
    .badge-red { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }
    .badge-purple { background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); color: #6366F1; }
    .badge-pink { background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%); color: #EC4899; }

    /* Button */
    .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; transition: all 0.2s ease; cursor: pointer; border: 1px solid #dddce3; background: #fff; color: #49465a; font-family: 'Plus Jakarta Sans', 'Public Sans', sans-serif; }
    .btn-primary { background: var(--gradient-primary); color: #fff !important; box-shadow: 0 4px 14px rgba(99,102,241,0.32); border-color: transparent; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(99,102,241,0.4); color: #fff !important; }
    .btn-secondary { background: #fff; color: #374151 !important; border: 1px solid #dedde5; box-shadow: none; }
    .btn-secondary:hover { background: #f3f4f6; border-color: #9ca3af; transform: none; color: #111827 !important; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; box-shadow: 0 4px 14px rgba(239,68,68,0.35); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.45); }

    /* Input */
    .input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 14px; transition: all 0.2s; background: #fff; box-shadow: none; }
    .input:hover { border-color: #6366F1; }
    .input:focus { outline: none; border-color: #6366F1; box-shadow: 0 0 0 3px rgba(99,102,241,0.15); background: #fff; }
    .input:invalid { border-color: #ea5455; }
    select.input { appearance: none; background-image: linear-gradient(45deg, transparent 50%, #8d8a98 50%), linear-gradient(135deg, #8d8a98 50%, transparent 50%); background-position: calc(100% - 16px) calc(1em + 1px), calc(100% - 11px) calc(1em + 1px); background-size: 5px 5px, 5px 5px; background-repeat: no-repeat; }
    .input::placeholder { color: #9ca3af; }

    /* Modal */
    .modal-overlay { background: rgba(31,32,45,0.45); }
    .modal-content { background: #fff; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 26px rgba(31,32,45,0.2); border: 1px solid #e2e1e9; }
    .modal-lg { max-width: 800px; }

    /* Activity item */
    .activity-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

    /* Tab */
    .tab { padding: 10px 18px; border-radius: 12px; font-weight: 600; color: #6B7280; cursor: pointer; transition: all 0.2s ease; background: #fff; border: 1px solid #e5e7eb; }
    .tab:hover { background: #F5F3FF; color: #1A1A2E; transform: none; box-shadow: none; }
    .tab.active { background: var(--gradient-primary); color: #fff; border-color: transparent; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }

    /* Chart container */
    .chart-container { position: relative; height: 200px; }
    .chart-bleed { position: relative; }

    /* KPI cards */
    .kpi-card { position: relative; overflow: hidden; }
    .kpi-card::after {
      content: '';
      position: absolute;
      inset: auto -20% -40% auto;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(88,101,242,0.18) 0%, rgba(88,101,242,0) 70%);
      pointer-events: none;
    }
    .kpi-grid .kpi-card:nth-child(1) { border-color: rgba(99,102,241,0.15); }
    .kpi-grid .kpi-card:nth-child(2) { border-color: rgba(34,197,94,0.15); }
    .kpi-grid .kpi-card:nth-child(3) { border-color: rgba(244,114,182,0.15); }
    .kpi-grid .kpi-card:nth-child(4) { border-color: rgba(245,158,11,0.15); }
    .kpi-grid .kpi-card:nth-child(1) .stat-icon { background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); color: #fff; box-shadow: 0 8px 24px rgba(99,102,241,0.3); }
    .kpi-grid .kpi-card:nth-child(2) .stat-icon { background: linear-gradient(135deg, #22C55E 0%, #4ADE80 100%); color: #fff; box-shadow: 0 8px 24px rgba(34,197,94,0.3); }
    .kpi-grid .kpi-card:nth-child(3) .stat-icon { background: linear-gradient(135deg, #F472B6 0%, #EC4899 100%); color: #fff; box-shadow: 0 8px 24px rgba(244,114,182,0.3); }
    .kpi-grid .kpi-card:nth-child(4) .stat-icon { background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); color: #fff; box-shadow: 0 8px 24px rgba(245,158,11,0.3); }
    .insight-card { animation: fadeUp 0.45s ease both; }
    .insight-card:hover { transform: translateY(-2px); box-shadow: 0 16px 34px rgba(15,23,42,0.14); }
    .insight-card:nth-of-type(2) { animation-delay: 0.05s; }
    .insight-card:nth-of-type(3) { animation-delay: 0.1s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Right panel (desktop) */
    .right-panel { background: #f9f9fc; border-left: 1px solid #e7e7ef; }
    .right-panel .card { border-radius: 10px; background: #fff; }
    .right-panel .card:first-child { box-shadow: var(--shadow-soft); }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; }

    /* Hide scrollbar for mobile nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile bottom nav */
    @media (max-width: 900px) {
      body { overflow-x: hidden; }
      #dashboard { overflow-x: hidden; }
      #sidebar { display: none !important; }
      .main-content { margin-left: 0 !important; margin-right: 0 !important; padding: 12px !important; padding-bottom: 80px !important; max-width: 100vw; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none !important; }
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0 !important; padding: 12px !important; padding-bottom: 80px !important; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none; }

      /* Typography */
      h1 { font-size: 1.25rem !important; }
      h2 { font-size: 1.125rem !important; }
      h3 { font-size: 1rem !important; }

      /* Cards */
      .card { border-radius: 12px; }

      /* Stat cards */
      .stat-icon { width: 40px !important; height: 40px !important; font-size: 18px !important; }

      /* Buttons */
      .btn { padding: 8px 14px; font-size: 13px; }
      .btn-primary { padding: 10px 16px; }

      /* Inputs */
      .input { padding: 10px 12px; font-size: 14px; }

      /* Tables */
      .overflow-x-auto { -webkit-overflow-scrolling: touch; }

      /* Tab buttons */
      .tab { padding: 8px 12px; font-size: 12px; }

      /* Chart containers */
      .chart-container { height: 180px !important; }

      /* Modals */
      .modal-content { margin: 12px; border-radius: 16px; max-height: calc(100vh - 100px); }

      /* Grid adjustments */
      .grid-cols-2 { grid-template-columns: 1fr !important; }
      .grid-cols-3 { grid-template-columns: 1fr !important; }
      .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }

      /* Stats row */
      .stats-grid { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }

      /* Flexbox adjustments */
      .flex-col-mobile { flex-direction: column !important; align-items: stretch !important; }

      /* Text sizes */
      .text-3xl { font-size: 1.5rem !important; }
      .text-2xl { font-size: 1.25rem !important; }

      /* Spacing */
      .gap-6 { gap: 12px !important; }
      .p-5 { padding: 12px !important; }
      .mb-6 { margin-bottom: 12px !important; }

      /* Mobile visual language */
      body { background: #f4f5fa; }
      .card { border-radius: 12px !important; box-shadow: 0 6px 18px rgba(47,43,61,0.08) !important; }
      .btn { border-radius: 8px !important; }
      .tab { border-radius: 8px !important; }
      .tab:active { transform: scale(0.98); }
      .btn:active { transform: scale(0.98); }
      .mobile-nav-item:active { transform: scale(0.96); }
      .btn-primary { box-shadow: 0 6px 14px rgba(115,103,240,0.32) !important; }
      .main-content > header { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 4px 14px rgba(47,43,61,0.08); border: 1px solid #e7e7ef; }
      .main-content > header .btn-primary { width: 100%; justify-content: center; }

      /* Charts full-bleed */
      .chart-bleed { width: calc(100% + 24px); margin-left: -12px; }
      .chart-bleed canvas { border-radius: 16px; }

      /* Tabs row */
      .tab-row { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap !important; }
      .tab-row::-webkit-scrollbar { display: none; }

      /* Responsive tables -> cards */
      .overflow-x-auto { overflow-x: visible; }
      table.responsive-table { width: 100%; }
      table.responsive-table thead { display: none; }
      table.responsive-table tbody { display: block; }
      table.responsive-table tbody tr { display: block; background: #fff; border: 1px solid rgba(15,23,42,0.08); border-radius: 14px; padding: 10px 12px; margin-bottom: 10px; box-shadow: 0 6px 16px rgba(15,23,42,0.06); }
      table.responsive-table tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 6px 0; border: none; }
      table.responsive-table tbody tr td::before {
        content: attr(data-label);
        font-size: 10px;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      table.responsive-table tbody tr td:last-child { justify-content: flex-end; }
      table.responsive-table tbody tr td:first-child { font-weight: 600; }
      table.responsive-table tbody tr td:first-child::before { display: none; }
      table.responsive-table tbody tr td .badge { font-size: 10px; padding: 4px 8px; }
      table.responsive-table tbody tr td button { border-radius: 10px; }

      /* Bottom spacing so content is readable above nav */
      .main-content {
        padding-bottom: calc(var(--mobile-nav-h) + 120px + env(safe-area-inset-bottom)) !important;
        scroll-padding-bottom: calc(var(--mobile-nav-h) + 120px + env(safe-area-inset-bottom));
      }
      .mobile-nav { padding-bottom: calc(8px + env(safe-area-inset-bottom)); }

      /* Modal readability above browser/nav bars */
      .modal-content { max-height: calc(100vh - 120px); padding-bottom: calc(120px + env(safe-area-inset-bottom)); }

      /* Section readability */
      .card { padding: 14px !important; }
      .card .text-gray-500 { color: #6b7280 !important; }
      .card .text-gray-400 { color: #94a3b8 !important; }
      .text-sm { font-size: 13px !important; }
      .text-xs { font-size: 11px !important; }

      /* Glass sections */
      .bg-gray-50 { background: rgba(255,255,255,0.6) !important; }
      .bg-white { background: rgba(255,255,255,0.75) !important; }
      .bg-indigo-50 { background: rgba(227,235,255,0.8) !important; }
      .bg-blue-50 { background: rgba(224,242,255,0.8) !important; }
      .bg-orange-50 { background: rgba(255,237,213,0.8) !important; }
      .bg-green-50 { background: rgba(220,252,231,0.8) !important; }

      /* Lists spacing */
      #recentUsersList > div,
      #recentPaymentsList > div,
      #lessonsList > div {
        padding: 12px !important;
      }

      /* Tabs row: larger touch targets */
      .tab { padding: 8px 14px !important; }

      /* Keep cards separated at the bottom */
      .mb-6 { margin-bottom: 16px !important; }
    }

    /* Small mobile screens */
    @media (max-width: 480px) {
      .main-content { padding: 8px !important; }
      .card { border-radius: 10px; }
      .stat-icon { width: 36px !important; height: 36px !important; font-size: 16px !important; border-radius: 10px !important; }
      .text-3xl { font-size: 1.25rem !important; }
      .text-2xl { font-size: 1.125rem !important; }
      .tab { padding: 6px 10px; font-size: 11px; }
      .btn { padding: 6px 10px; font-size: 12px; }

      /* Hero banner mobile optimizations */
      .hero-floating-icon { display: none !important; }
      .hero-banner { padding: 20px !important; border-radius: 16px !important; }
      .hero-banner h2 { font-size: 1.5rem !important; margin-bottom: 8px !important; }
      .hero-banner p { font-size: 0.9375rem !important; margin-bottom: 12px !important; }
      .hero-quick-stats { gap: 8px !important; }
      .hero-quick-stats > div { padding: 6px 12px !important; font-size: 12px !important; }
    }

    /* Tablet screens */
    @media (min-width: 769px) and (max-width: 1024px) {
      .right-panel { width: 240px !important; }
      .main-content { margin-right: 240px; }
    }

    /* Large screens */
    @media (min-width: 1280px) {
      .right-panel { width: 320px; }
    }

    .mobile-nav { display: none; position: fixed; bottom: 12px; left: 12px; right: 12px; height: var(--mobile-nav-h); background: #fff; border: 1px solid rgba(0,0,0,0.06); padding: 8px; z-index: 50; box-shadow: 0 8px 32px rgba(0,0,0,0.12); border-radius: 20px; }
    .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 10px 6px; border-radius: 14px; color: #6B7280; font-size: 10px; font-weight: 500; transition: all 0.2s; }
    .mobile-nav-item.active { color: #fff; background: var(--gradient-primary); box-shadow: 0 6px 16px rgba(99,102,241,0.36); }
    .mobile-nav-item:active { transform: scale(0.95); }

    /* Accessible focus ring */
    button:focus-visible,
    .btn:focus-visible,
    .tab:focus-visible,
    .input:focus-visible,
    .sidebar-item:focus-visible,
    .mobile-nav-item:focus-visible {
      outline: 2px solid #a9a3f7;
      outline-offset: 2px;
    }

    /* Dense table mode */
    body.table-compact table th,
    body.table-compact table td {
      padding-top: 0.42rem !important;
      padding-bottom: 0.42rem !important;
      font-size: 12.5px !important;
      line-height: 1.25 !important;
    }
    body.table-compact .badge {
      padding: 2px 8px;
      font-size: 10.5px;
    }
    body.table-compact .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    /* Dark mode */
    body.theme-dark {
      background: #25293c;
      color: #d7d9e6;
    }
    body.theme-dark .card,
    body.theme-dark .sf-shell,
    body.theme-dark .sf-summary,
    body.theme-dark .sf-stat,
    body.theme-dark .sf-left,
    body.theme-dark .sf-detail-card,
    body.theme-dark .sf-payment-card,
    body.theme-dark .sf-mini-list,
    body.theme-dark .right-panel,
    body.theme-dark .main-content > header {
      background: #2f3349 !important;
      border-color: #44485f !important;
      color: #d7d9e6 !important;
      box-shadow: 0 8px 20px rgba(14,18,33,0.22) !important;
    }
    body.theme-dark .sf-workspace,
    body.theme-dark .tab,
    body.theme-dark .mobile-nav,
    body.theme-dark .btn-secondary,
    body.theme-dark .input {
      background: #25293c !important;
      border-color: #44485f !important;
      color: #d7d9e6 !important;
    }
    body.theme-dark .input::placeholder { color: #a7aac4; }
    body.theme-dark .tab.active,
    body.theme-dark .btn-primary,
    body.theme-dark .mobile-nav-item.active {
      background: #7367f0 !important;
      border-color: #7367f0 !important;
      color: #fff !important;
    }
    body.theme-dark .table-row:hover { background: #30344a; }
    body.theme-dark .diag-table-scroll table thead th,
    body.theme-dark .sf-dark-scroll table thead th { background: #25293c !important; color: #b7bad1 !important; }

    /* File ID Input */
    .file-id-input { font-family: monospace; font-size: 12px; background: #f9fafb; }

    /* Funnel Visualization */
    .funnel-container { position: relative; }
    .funnel-step {
      position: relative;
      margin: 0 auto;
      padding: 8px 12px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .funnel-step:hover { transform: scale(1.02); }
    .funnel-step::before {
      content: '';
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      border-radius: 4px;
      z-index: -1;
    }
    .funnel-label { font-size: 11px; font-weight: 500; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .funnel-count { font-size: 14px; font-weight: 700; color: #fff; }
    .funnel-pct { font-size: 10px; color: rgba(255,255,255,0.8); }

    .diag-list-row { display: flex; flex-direction: column; gap: 6px; padding: 10px 0; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .diag-list-row:last-child { border-bottom: 0; }
    .diag-list-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .diag-list-label { font-size: 13px; color: #334155; font-weight: 600; }
    .diag-list-meta { font-size: 11px; color: #64748b; white-space: nowrap; }
    .diag-progress { width: 100%; height: 6px; border-radius: 999px; background: rgba(148,163,184,0.24); overflow: hidden; }
    .diag-progress-fill { height: 100%; border-radius: 999px; transition: width 0.3s ease; }
    .diag-progress-fill.source { background: linear-gradient(90deg, #7367f0, #8c82f7); }
    .diag-progress-fill.lesson { background: linear-gradient(90deg, #06b6d4, #3b82f6); }
    .diag-progress-fill.activity { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .diag-progress-fill.method { background: linear-gradient(90deg, #f59e0b, #f97316); }
    .diag-section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }
    .diag-section-title h3 { font-size: 17px; font-weight: 700; letter-spacing: -0.01em; }
    .diag-muted { font-size: 12px; color: #64748b; }
    .diag-surface {
      background: linear-gradient(145deg, rgba(255,255,255,0.85), rgba(245,248,255,0.7));
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
    }
    .diag-chart-wrap { height: 230px; }
    .diag-table-scroll { max-height: 440px; overflow: auto; border-radius: 14px; border: 1px solid rgba(148,163,184,0.18); }
    .diag-table-scroll table thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(248,250,252,0.95);
      backdrop-filter: blur(6px);
    }
    .diag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid rgba(148,163,184,0.24);
      background: rgba(255,255,255,0.8);
      color: #475569;
    }
    .ref-analytics { --rx-bg: #eef7f6; --rx-card: #f8fffe; --rx-border: #d7ebe8; --rx-ink: #123234; --rx-muted: #638082; }
    .ref-analytics .card {
      background: var(--rx-card);
      border: 1px solid var(--rx-border);
      box-shadow: 0 10px 24px rgba(18,50,52,0.06);
    }
    .ref-analytics .diag-section-title h3 { color: var(--rx-ink); }
    .ref-analytics .diag-muted { color: var(--rx-muted); }
    .ref-analytics .diag-surface {
      background: linear-gradient(145deg, #fbfffe, #f2fbfa);
      border-color: #d5ebe7;
    }
    .sf-shell {
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e7e7ef;
      box-shadow: var(--shadow-soft);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sf-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 8px;
    }
    .sf-brand { font-size: 16px; font-weight: 700; letter-spacing: -0.01em; color: #2f2b3d; }
    .sf-top-pills {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f4f5fa;
      border-radius: 8px;
      padding: 4px;
    }
    .sf-pill {
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      color: #6f6b7d;
      border: 1px solid transparent;
    }
    .sf-pill.active {
      color: #fff;
      background: #7367f0;
      font-weight: 700;
    }
    .sf-actions { display: flex; align-items: center; gap: 8px; }
    .sf-mini-btn {
      border-radius: 8px;
      border: 1px solid #dddce4;
      background: #fff;
      color: #5d596c;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 700;
    }
    .sf-mini-btn.active, .sf-mini-btn:hover { border-color: #7367f0; color: #7367f0; }
    .sf-main-btn {
      border-radius: 8px;
      border: 1px solid #7367f0;
      background: #7367f0;
      color: #fff;
      padding: 8px 13px;
      font-size: 11px;
      font-weight: 700;
    }
    .sf-main-btn.light {
      border-color: #dddce4;
      background: #fff;
      color: #5d596c;
    }
    .sf-main-btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .sf-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .sf-title {
      font-size: 28px;
      line-height: 1;
      color: #2f2b3d;
      letter-spacing: -0.02em;
      font-weight: 700;
    }
    .sf-summary {
      border-radius: 10px;
      border: 1px solid #ecebf2;
      background: #f8f7fa;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .sf-stat {
      border-radius: 8px;
      border: 1px solid #e7e7ef;
      background: #fff;
      padding: 10px;
      min-height: 84px;
    }
    .sf-stat .k { font-size: 11px; color: #8d8a98; margin-bottom: 6px; }
    .sf-stat .v { font-size: 24px; line-height: 1; color: #2f2b3d; font-weight: 700; letter-spacing: -0.01em; }
    .sf-stat .v.sm { font-size: 16px; line-height: 1.25; }
    .sf-filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      padding: 2px 4px;
    }
    .sf-filter-label { font-size: 13px; color: #2f2b3d; font-weight: 700; margin-right: 4px; }
    .sf-chip {
      border-radius: 999px;
      border: 1px solid #dddce4;
      background: #fff;
      color: #5d596c;
      font-size: 11px;
      padding: 6px 10px;
      font-weight: 600;
    }
    .sf-workspace {
      background: #f8f7fa;
      border-radius: 12px;
      border: 1px solid #e9e8ef;
      padding: 12px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 10px;
      color: #6f6b7d;
    }
    .sf-left {
      border-radius: 10px;
      background: #fff;
      border: 1px solid #e7e7ef;
      padding: 10px;
      min-height: 520px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sf-left-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .sf-left-title { color: #2f2b3d; font-size: 15px; font-weight: 700; }
    .sf-right { display: flex; flex-direction: column; gap: 10px; min-width: 0; }
    .sf-detail-card {
      border-radius: 10px;
      background: #fff;
      border: 1px solid #e7e7ef;
      padding: 12px;
    }
    .sf-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .sf-label { font-size: 11px; font-weight: 700; color: #7b788a; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    .sf-mini-list {
      border-radius: 8px;
      background: #f8f7fa;
      border: 1px solid #ecebf2;
      padding: 8px;
    }
    .sf-payment-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; }
    .sf-payment-card {
      border-radius: 10px;
      border: 1px solid #e7e7ef;
      background: #fff;
      padding: 10px;
      color: #5d596c;
    }
    .sf-dark-scroll {
      border-color: #e7e7ef;
      background: #fff;
    }
    .sf-dark-scroll table thead th {
      background: #f8f7fa;
      color: #7b788a;
    }
    .sf-dark-scroll table tbody td { color: #5d596c; }
    @media (max-width: 1200px) {
      .sf-summary { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sf-workspace { grid-template-columns: 1fr; }
      .sf-left { min-height: 280px; }
      .sf-detail-grid, .sf-payment-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 900px) {
      .sf-topbar, .sf-header-row { flex-direction: column; align-items: flex-start; }
      .sf-title { font-size: 24px; }
      .sf-summary { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .diag-list-label { font-size: 12px; }
      .diag-list-meta { font-size: 10px; }
      #tab-analytics .overflow-x-auto { overflow-x: auto !important; }
      #tab-analytics table { min-width: 760px; }
      .diag-chart-wrap { height: 180px; }
      .diag-table-scroll { max-height: 360px; }
    }

    /* ═══ ANALYTICS ENHANCEMENTS ═══ */

    /* Mega Funnel Visualization */
    .analytics-mega-funnel {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .analytics-mega-funnel-title {
      font-size: 14px;
      font-weight: 700;
      color: #2f2b3d;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .analytics-funnel-stages {
      display: flex;
      align-items: stretch;
      gap: 8px;
    }
    .analytics-funnel-stage {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .analytics-funnel-bar {
      width: 100%;
      border-radius: 12px 12px 4px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 8px;
      min-height: 100px;
      transition: all 0.3s ease;
    }
    .analytics-funnel-stage:nth-child(1) .analytics-funnel-bar {
      background: linear-gradient(180deg, #6366F1 0%, #4F46E5 100%);
      height: 140px;
    }
    .analytics-funnel-stage:nth-child(2) .analytics-funnel-bar {
      background: linear-gradient(180deg, #8B5CF6 0%, #7C3AED 100%);
      height: 120px;
    }
    .analytics-funnel-stage:nth-child(3) .analytics-funnel-bar {
      background: linear-gradient(180deg, #A78BFA 0%, #8B5CF6 100%);
      height: 100px;
    }
    .analytics-funnel-stage:nth-child(4) .analytics-funnel-bar {
      background: linear-gradient(180deg, #C4B5FD 0%, #A78BFA 100%);
      height: 80px;
    }
    .analytics-funnel-stage:nth-child(5) .analytics-funnel-bar {
      background: linear-gradient(180deg, #22C55E 0%, #16A34A 100%);
      height: 60px;
    }
    .analytics-funnel-value {
      font-size: 18px;
      font-weight: 800;
      color: white;
      font-family: 'JetBrains Mono', monospace;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .analytics-funnel-percent {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.85);
      margin-top: 4px;
    }
    .analytics-funnel-label {
      margin-top: 8px;
      font-size: 11px;
      font-weight: 600;
      color: #5d596c;
      text-align: center;
    }
    .analytics-funnel-dropoff {
      position: absolute;
      right: -16px;
      top: 50%;
      transform: translateY(-50%);
      background: #fef2f2;
      color: #dc2626;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 6px;
      border-radius: 6px;
      z-index: 5;
      white-space: nowrap;
    }

    /* CR Heatmap */
    .analytics-heatmap {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e7e7ef;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .analytics-heatmap-header {
      padding: 14px 16px;
      background: #f8f7fa;
      border-bottom: 1px solid #e7e7ef;
      font-size: 13px;
      font-weight: 700;
      color: #2f2b3d;
    }
    .analytics-heatmap table {
      width: 100%;
      border-collapse: collapse;
    }
    .analytics-heatmap th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      color: #7b788a;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-bottom: 1px solid #e7e7ef;
    }
    .analytics-heatmap td {
      padding: 10px 12px;
      font-size: 12px;
      border-bottom: 1px solid #f4f5fa;
    }
    .analytics-heatmap tr:hover { background: #f8f7fa; }
    .heatmap-cell {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      text-align: center;
      min-width: 44px;
    }
    .heatmap-cell.excellent { background: rgba(34, 197, 94, 0.15); color: #15803d; }
    .heatmap-cell.good { background: rgba(34, 197, 94, 0.08); color: #22c55e; }
    .heatmap-cell.average { background: rgba(245, 158, 11, 0.12); color: #d97706; }
    .heatmap-cell.poor { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .heatmap-cell.critical { background: rgba(239, 68, 68, 0.18); color: #b91c1c; }
    .heatmap-source {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #2f2b3d;
    }
    .heatmap-source-icon {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    /* AI Insights Panel */
    .analytics-insights {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e7e7ef;
      padding: 16px;
      margin-bottom: 16px;
    }
    .analytics-insights-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .analytics-insights-title {
      font-size: 14px;
      font-weight: 700;
      color: #2f2b3d;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .analytics-insight-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: #f8f7fa;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 3px solid #7367f0;
      transition: all 0.2s ease;
    }
    .analytics-insight-card:hover {
      background: #f1f0fb;
      transform: translateX(2px);
    }
    .analytics-insight-card.critical { border-left-color: #ef4444; background: #fef2f2; }
    .analytics-insight-card.warning { border-left-color: #f59e0b; background: #fffbeb; }
    .analytics-insight-card.success { border-left-color: #22c55e; background: #f0fdf4; }
    .analytics-insight-card.info { border-left-color: #3b82f6; background: #eff6ff; }
    .analytics-insight-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(115, 103, 240, 0.1);
      color: #7367f0;
    }
    .analytics-insight-card.critical .analytics-insight-icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .analytics-insight-card.warning .analytics-insight-icon { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .analytics-insight-card.success .analytics-insight-icon { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
    .analytics-insight-content { flex: 1; }
    .analytics-insight-title { font-size: 13px; font-weight: 600; color: #2f2b3d; margin-bottom: 4px; }
    .analytics-insight-detail { font-size: 11px; color: #6f6b7d; margin-bottom: 6px; }
    .analytics-insight-action {
      font-size: 11px;
      color: #7367f0;
      background: rgba(115, 103, 240, 0.08);
      padding: 4px 10px;
      border-radius: 6px;
      display: inline-block;
    }

    /* High-Intent Quick Actions */
    .high-intent-quick-actions {
      display: flex;
      gap: 6px;
    }
    .high-intent-action {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: 1px solid #e7e7ef;
      color: #6f6b7d;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .high-intent-action:hover {
      border-color: #7367f0;
      color: #7367f0;
      background: rgba(115, 103, 240, 0.05);
    }
    .high-intent-action.primary {
      background: #7367f0;
      border-color: #7367f0;
      color: #fff;
    }
    .high-intent-action.primary:hover {
      background: #5d51e8;
    }

    @media (max-width: 768px) {
      .analytics-funnel-stages { flex-direction: column; gap: 6px; }
      .analytics-funnel-stage { flex-direction: row; align-items: center; }
      .analytics-funnel-bar {
        width: auto;
        height: auto !important;
        min-height: 40px;
        flex-direction: row;
        border-radius: 8px;
        padding: 10px 14px;
        gap: 8px;
      }
      .analytics-funnel-dropoff { position: static; transform: none; margin-left: 8px; }
      .analytics-funnel-label { margin-top: 0; margin-left: 12px; text-align: left; }
      .analytics-insight-card { padding: 10px; gap: 10px; }
      .analytics-insight-icon { width: 28px; height: 28px; }
    }

    /* Conversations */
    .conv-users-list { max-height: 72vh; overflow-y: auto; }
    .conv-user-item { width: 100%; text-align: left; padding: 12px 14px; border-bottom: 1px solid rgba(15,23,42,0.06); transition: background 0.18s ease; }
    .conv-user-item:hover { background: rgba(255,255,255,0.75); }
    .conv-user-item.active { background: linear-gradient(90deg, rgba(115,103,240,0.16) 0%, rgba(115,103,240,0.06) 100%); border-left: 3px solid var(--accent); padding-left: 11px; }
    .conv-avatar { width: 38px; height: 38px; border-radius: 999px; background: linear-gradient(135deg, #dbe7ff 0%, #cdd9ff 100%); color: #3f5ee6; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
    .tg-chat-shell { border: 1px solid rgba(15,23,42,0.08); border-radius: 18px; overflow: hidden; background: rgba(255,255,255,0.7); }
    .tg-chat-head { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-bottom: 1px solid rgba(15,23,42,0.08); background: rgba(255,255,255,0.9); }
    .tg-chat-body { max-height: 72vh; overflow-y: auto; padding: 14px; background: radial-gradient(circle at 20% 10%, rgba(224,255,214,0.6) 0%, rgba(195,232,183,0.65) 50%, rgba(180,218,170,0.7) 100%); }
    .tg-bubble-row { display: flex; margin-bottom: 8px; }
    .tg-bubble-row.user { justify-content: flex-end; }
    .tg-bubble { max-width: 78%; border-radius: 18px; padding: 9px 12px 8px; box-shadow: 0 2px 8px rgba(15,23,42,0.08); word-break: break-word; background: #fff; border-bottom-left-radius: 6px; }
    .tg-bubble.user { background: #d9f8c5; border-bottom-right-radius: 6px; }
    .tg-bubble.action { background: #f0eeff; border: 1px solid rgba(115,103,240,0.22); }
    .tg-meta { font-size: 11px; color: #6b7280; display: flex; justify-content: flex-end; gap: 8px; margin-top: 5px; }
    .tg-tag { display: inline-flex; align-items: center; font-size: 10px; border-radius: 999px; padding: 2px 7px; margin-bottom: 4px; background: rgba(255,255,255,0.72); color: #475569; border: 1px solid rgba(15,23,42,0.08); }

    /* Progrev UI polish */
    .progrev-flow-card {
      border: 1px solid rgba(115,103,240,0.2);
      background: linear-gradient(135deg, rgba(255,255,255,0.92) 0%, rgba(241,245,255,0.86) 100%);
      box-shadow: 0 14px 30px rgba(15,23,42,0.08);
    }
    .progrev-flow-track { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .progrev-flow-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;
      border: 1px solid transparent;
    }
    .progrev-flow-arrow { color: #94a3b8; font-weight: 700; }
    .flow-green { background: #d9fbe7; color: #166534; border-color: #b4eccd; }
    .flow-blue { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
    .flow-purple { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
    .flow-orange { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
    .flow-red { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

    .progrev-editor-card {
      border: 1px solid rgba(99,102,241,0.24);
      border-radius: 20px;
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(245,247,255,0.88) 100%);
      box-shadow: 0 16px 34px rgba(15,23,42,0.08);
    }
    .format-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
    .format-btn {
      min-width: 42px;
      height: 36px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.28);
      background: rgba(255,255,255,0.92);
      color: #1f2937;
      font-size: 13px;
      font-weight: 600;
      transition: all .18s ease;
    }
    .format-btn:hover {
      border-color: rgba(99,102,241,0.45);
      background: #fff;
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(99,102,241,0.15);
    }
    .format-btn.wide { min-width: auto; padding: 0 12px; }

    .emoji-bank-shell {
      margin-top: 12px;
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 16px;
      background: rgba(255,255,255,0.68);
      padding: 10px;
    }
    .emoji-bank-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .emoji-bank-refresh {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.28);
      background: #fff;
      color: #475569;
      transition: all .18s ease;
    }
    .emoji-bank-refresh:hover {
      border-color: rgba(99,102,241,0.45);
      color: #4338ca;
      transform: translateY(-1px);
    }
    #emojiBankProgrevList { gap: 10px; }
    #emojiBankProgrevList .emoji-chip {
      border: 1px solid rgba(203,213,225,0.75);
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      transition: all .18s ease;
    }
    #emojiBankProgrevList .emoji-chip:hover {
      border-color: rgba(99,102,241,0.36);
      box-shadow: 0 10px 18px rgba(15,23,42,0.08);
      transform: translateY(-1px);
    }
    #emojiBankProgrevList .emoji-main-btn {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(226,232,240,1);
      background: #fff;
      padding: 8px 6px;
    }
    #emojiBankProgrevList .emoji-trash-btn {
      padding: 2px 8px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      color: #dc2626;
      background: #fff;
      font-size: 12px;
    }
    #emojiBankProgrevList .emoji-trash-btn:hover { background: #fef2f2; border-color: #fca5a5; }

    .extra-nav { display: none; }
    .extra-nav.show { display: flex; }
    .table-sticky-first th:first-child,
    .table-sticky-first td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: inherit;
    }
    .table-settings-pop {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      min-width: 220px;
      background: #fff;
      border: 1px solid #e7e7ef;
      border-radius: 10px;
      box-shadow: 0 10px 26px rgba(31,32,45,0.16);
      padding: 10px;
      z-index: 30;
    }
    .table-settings-pop.hidden { display: none; }
    .table-settings-opt { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #5d596c; padding: 4px 2px; }
    .saved-view-chip {
      border: 1px solid #dddce4;
      background: #fff;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 600;
      color: #5d596c;
      cursor: pointer;
    }
    .saved-view-chip.active { background: #7367f0; border-color: #7367f0; color: #fff; }
    .global-hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      color: #7367f0;
      border: 1px solid rgba(115,103,240,0.35);
      cursor: help;
      background: rgba(115,103,240,0.08);
    }
    .sf-legend-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      background: #f3f4f6;
      cursor: help;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .sf-legend-badge:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      transform: translateY(-1px);
    }
    .sf-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .command-kbd {
      display: inline-flex;
      align-items: center;
      border: 1px solid #d8d7df;
      border-radius: 6px;
      padding: 1px 6px;
      font-size: 11px;
      background: #fff;
      color: #7b788a;
    }
    .cmd-overlay {
      position: fixed;
      inset: 0;
      background: rgba(18,20,32,0.5);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 10vh;
      z-index: 80;
    }
    .cmd-overlay.show { display: flex; }
    .cmd-modal {
      width: min(760px, calc(100vw - 24px));
      border-radius: 12px;
      background: #fff;
      border: 1px solid #e7e7ef;
      box-shadow: 0 20px 40px rgba(24,26,40,0.25);
      overflow: hidden;
    }
    .cmd-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f0f4;
      font-size: 13px;
      color: #4f4b61;
    }
    .cmd-item:hover, .cmd-item.active { background: #f4f5fa; color: #2f2b3d; }
    .notif-panel {
      position: fixed;
      top: 16px;
      right: 16px;
      width: min(360px, calc(100vw - 28px));
      background: #fff;
      border: 1px solid #e5e4ec;
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(20,22,36,0.18);
      z-index: 70;
      max-height: 70vh;
      overflow: hidden;
      display: none;
    }
    .notif-panel.show { display: block; }
    .notif-list { max-height: 56vh; overflow-y: auto; }
    .notif-item { padding: 10px 12px; border-bottom: 1px solid #f2f1f6; font-size: 12px; color: #5d596c; }
    .notif-dot { width: 7px; height: 7px; border-radius: 999px; background: #ea5455; display: inline-block; margin-left: 6px; }
    .notif-badge {
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      background: #ea5455;
      color: #fff;
      padding: 0 5px;
    }
    body.theme-dark .table-settings-pop,
    body.theme-dark .cmd-modal,
    body.theme-dark .notif-panel { background: #2f3349; border-color: #44485f; }
    body.theme-dark .cmd-item { border-color: #3d4158; color: #c6c9df; }
    body.theme-dark .cmd-item:hover, body.theme-dark .cmd-item.active { background: #25293c; }
    body.theme-dark .table-settings-opt,
    body.theme-dark .notif-item { color: #c6c9df; border-color: #3d4158; }
    body.theme-dark .command-kbd { background: #25293c; border-color: #44485f; color: #aeb2ce; }

    /* ===== Reboot Design (Light-Only) ===== */
    :root {
      --rb-bg: #eef3ff;
      --rb-bg-2: #f7f9ff;
      --rb-panel: #ffffff;
      --rb-panel-soft: #f8faff;
      --rb-border: #dbe5f7;
      --rb-text: #1a2340;
      --rb-muted: #6f7a99;
      --rb-primary: #2d6bff;
      --rb-primary-2: #4d8bff;
      --rb-accent: #14b8a6;
      --rb-warning: #f59e0b;
    }
    body {
      background:
        radial-gradient(900px 520px at -10% -20%, #d8e5ff 0%, rgba(216,229,255,0) 60%),
        radial-gradient(700px 400px at 110% -10%, #d7f0ff 0%, rgba(215,240,255,0) 55%),
        linear-gradient(140deg, var(--rb-bg) 0%, var(--rb-bg-2) 100%) !important;
      color: var(--rb-text) !important;
    }
    .card {
      background: linear-gradient(165deg, #ffffff 0%, #f9fbff 100%) !important;
      border: 1px solid var(--rb-border) !important;
      box-shadow: 0 12px 34px rgba(21,53,120,0.08) !important;
      border-radius: 18px !important;
    }
    .card.hero-card.bg-gradient-to-br {
      background: linear-gradient(to bottom right, #4f46e5, #7c3aed) !important;
      border: none !important;
    }
    .card.hero-card.bg-gradient-to-br * {
      color: inherit;
    }
    .card.hero-card .text-white { color: #ffffff !important; }
    .card.hero-card .text-white\/80 { color: rgba(255,255,255,0.8) !important; }
    .card.hero-card .text-white\/70 { color: rgba(255,255,255,0.7) !important; }
    .card.hero-card .text-white\/60 { color: rgba(255,255,255,0.6) !important; }
    .sidebar {
      width: 86px !important;
      background: linear-gradient(180deg, #f7faff 0%, #edf4ff 100%) !important;
      border-right: 1px solid #d8e4f8 !important;
      box-shadow: 10px 0 30px rgba(42,61,108,0.08) !important;
    }
    .sidebar.expanded { width: 262px !important; }
    .sidebar .sidebar-label { display: none !important; color: #2a3557 !important; font-weight: 700; }
    .sidebar.expanded .sidebar-label { display: block !important; }
    .sidebar-item {
      width: 100% !important;
      justify-content: flex-start !important;
      height: 44px !important;
      border-radius: 12px !important;
      padding: 0 14px !important;
      color: #3d4a6b !important;
      border: 1px solid transparent;
    }
    .sidebar-item .material-symbols-outlined {
      color: #5a6789 !important;
      font-size: 22px;
    }
    .sidebar-item:hover {
      background: #e3edff !important;
      color: #1a3fa8 !important;
      border-color: #c5d8ff;
    }
    .sidebar-item:hover .material-symbols-outlined {
      color: #1a3fa8 !important;
    }
    .sidebar-item:hover .sidebar-label {
      color: #1a3fa8 !important;
    }
    .sidebar-item.active {
      background: linear-gradient(135deg, #4f6af0 0%, #6366f1 100%) !important;
      border-color: transparent !important;
      color: #ffffff !important;
      box-shadow: 0 4px 12px rgba(79, 106, 240, 0.35);
    }
    .sidebar-item.active .material-symbols-outlined {
      color: #ffffff !important;
    }
    .sidebar-item.active .sidebar-label {
      color: #ffffff !important;
    }
    .sidebar-toggle { background: #dfe9fd !important; color: #2f4fa5 !important; }
    .main-content { margin-left: 262px !important; }
    .main-content > header {
      position: sticky;
      top: 12px;
      z-index: 20;
      border-radius: 18px !important;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(245,249,255,0.95) 100%) !important;
      border: 1px solid var(--rb-border) !important;
      padding: 14px 16px !important;
      box-shadow: 0 10px 26px rgba(44,77,152,0.1) !important;
    }
    .main-content > header h1,
    .text-gray-800,
    .text-gray-700,
    .text-gray-600 { color: var(--rb-text) !important; }
    .main-content > header p,
    .text-gray-500,
    .text-gray-400 { color: var(--rb-muted) !important; }
    .btn {
      border-radius: 11px !important;
      border: 1px solid #d4e1fb !important;
      background: #ffffff !important;
      color: #33456f !important;
    }
    .btn:hover { background: #f4f8ff !important; color: #1e3a5f !important; }
    .btn-primary {
      background: linear-gradient(135deg, var(--rb-primary) 0%, var(--rb-primary-2) 100%) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 9px 22px rgba(45,107,255,0.28) !important;
      font-weight: 700;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--rb-primary-2) 0%, var(--rb-primary) 100%) !important;
      color: #ffffff !important;
    }
    .input {
      background: #ffffff !important;
      border: 1px solid #d5e2fb !important;
      color: #223257 !important;
    }
    .input::placeholder { color: #8d9bbb !important; }
    .input:focus {
      border-color: rgba(45,107,255,0.55) !important;
      box-shadow: 0 0 0 3px rgba(45,107,255,0.16) !important;
    }
    .tab {
      background: #ffffff !important;
      border: 1px solid #d5e2fb !important;
      color: #415783 !important;
      border-radius: 10px !important;
    }
    .tab.active {
      background: linear-gradient(135deg, var(--rb-primary) 0%, var(--rb-primary-2) 100%) !important;
      color: #fff !important;
      border: none !important;
    }
    .table-row:hover { background: #f2f7ff !important; }
    table thead th {
      background: #f4f8ff !important;
      color: #60739e !important;
      border-bottom: 1px solid #d7e3fb !important;
    }
    table td { border-color: #e8efff !important; }
    .badge-blue { background: rgba(45,107,255,0.12) !important; color: #2557d6 !important; }
    .badge-green { background: rgba(20,184,166,0.16) !important; color: #0f887b !important; }
    .badge-orange { background: rgba(245,158,11,0.16) !important; color: #b26c05 !important; }
    .badge-red { background: rgba(239,68,68,0.14) !important; color: #be3535 !important; }
    .badge-gray { background: rgba(148,163,184,0.14) !important; color: #60708f !important; }
    .mobile-nav {
      background: rgba(255,255,255,0.95) !important;
      border-color: #d2def5 !important;
      backdrop-filter: blur(10px);
    }
    .mobile-nav-item { color: #4f628f !important; }
    .mobile-nav-item.active {
      background: linear-gradient(135deg, var(--rb-primary) 0%, var(--rb-primary-2) 100%) !important;
      color: #fff !important;
    }
    .sf-shell,
    .sf-summary,
    .sf-stat,
    .sf-left,
    .sf-detail-card,
    .sf-payment-card,
    .sf-mini-list,
    .sf-workspace {
      background: #ffffff !important;
      border-color: #dce6f8 !important;
      color: #2b3b63 !important;
      box-shadow: 0 8px 22px rgba(38,73,145,0.08) !important;
    }
    .sf-workspace { background: #f6f9ff !important; }
    .sf-label, .sf-filter-label { color: #5c719c !important; }
    .notif-panel,
    .cmd-modal,
    .table-settings-pop { background: #fff !important; border-color: #d7e4fb !important; }
    .cmd-item:hover, .cmd-item.active { background: #f4f8ff !important; }
    @media (max-width: 900px) {
      .main-content { margin-left: 0 !important; }
    }

    /* ===== Light Rebuild v3 (final visual system) ===== */
    :root {
      --lx-bg: #eff3fb;
      --lx-surface: #f8fbff;
      --lx-card: #ffffff;
      --lx-border: #dde5f2;
      --lx-ink: #101322;
      --lx-muted: #5e6883;
      --lx-primary: #2b3658;
      --lx-lime: #d8f21b;
      --lx-lime-ink: #1f2800;
    }
    body {
      background:
        radial-gradient(900px 480px at -12% -15%, #dce6fa 0%, rgba(220,230,250,0) 60%),
        radial-gradient(780px 420px at 112% -8%, #dff4fa 0%, rgba(223,244,250,0) 54%),
        linear-gradient(145deg, #edf2fb 0%, #f6f9ff 100%) !important;
      color: var(--lx-ink) !important;
    }
    .sidebar {
      width: 94px !important;
      background: rgba(248, 251, 255, 0.86) !important;
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--lx-border) !important;
      box-shadow: 10px 0 24px rgba(16, 19, 34, 0.04) !important;
    }
    .sidebar.expanded { width: 270px !important; }
    .sidebar-item {
      border-radius: 14px !important;
      color: #3f4d72 !important;
      margin-bottom: 6px;
    }
    .sidebar-item .material-symbols-outlined {
      color: #566085 !important;
    }
    .sidebar-item:hover {
      background: #e8eefb !important;
      color: #1a2d5c !important;
      border-color: transparent !important;
    }
    .sidebar-item:hover .material-symbols-outlined,
    .sidebar-item:hover .sidebar-label {
      color: #1a2d5c !important;
    }
    .sidebar-item.active {
      background: linear-gradient(120deg, #4f5fa0 0%, #5a6bb5 100%) !important;
      color: #ffffff !important;
      border-color: transparent !important;
      box-shadow: 0 8px 20px rgba(79, 95, 160, 0.35) !important;
    }
    .sidebar-item.active .material-symbols-outlined,
    .sidebar-item.active .sidebar-label {
      color: #ffffff !important;
    }
    .main-content {
      margin-left: 270px !important;
      padding: 24px 26px 110px !important;
    }
    .main-content > header {
      position: sticky;
      top: 12px;
      z-index: 30;
      border-radius: 20px !important;
      border: 1px solid var(--lx-border) !important;
      background: rgba(252, 254, 255, 0.88) !important;
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 28px rgba(32, 41, 72, 0.08) !important;
      padding: 16px 18px !important;
      margin-bottom: 18px !important;
    }
    .card {
      border-radius: 20px !important;
      border: 1px solid var(--lx-border) !important;
      background: linear-gradient(160deg, #ffffff 0%, #f9fcff 100%) !important;
      box-shadow: 0 12px 30px rgba(22, 30, 53, 0.07) !important;
    }
    .card.hero-card.bg-gradient-to-br {
      background: linear-gradient(to bottom right, #4f46e5, #7c3aed) !important;
      border: none !important;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(22, 30, 53, 0.11) !important;
    }
    .btn {
      border-radius: 12px !important;
      border: 1px solid #d6deee !important;
      background: #fff !important;
      color: #26345c !important;
      font-weight: 600;
    }
    .btn-primary {
      background: linear-gradient(120deg, var(--lx-primary) 0%, #1f2948 100%) !important;
      color: #f5f8ff !important;
      border: none !important;
      box-shadow: 0 10px 22px rgba(35, 47, 84, 0.34) !important;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(35, 47, 84, 0.4) !important;
      color: #ffffff !important;
    }
    .btn-secondary:hover { background: #f3f6fd !important; color: #1e3a5f !important; }
    .tab {
      border-radius: 999px !important;
      padding: 9px 16px !important;
      border: 1px solid #d8e1f0 !important;
      background: #fff !important;
      color: #4a5573 !important;
      font-weight: 700;
    }
    .tab.active {
      background: var(--lx-lime) !important;
      color: var(--lx-lime-ink) !important;
      border-color: #c8e218 !important;
      box-shadow: 0 6px 18px rgba(155, 179, 20, 0.32) !important;
    }
    .input {
      border-radius: 12px !important;
      border: 1px solid #d5dfef !important;
      background: #fff !important;
      color: #1d2b50 !important;
    }
    .input:focus {
      border-color: #8397bf !important;
      box-shadow: 0 0 0 3px rgba(99, 121, 166, 0.16) !important;
    }
    .kpi-card { border-radius: 20px !important; }
    .kpi-grid .kpi-card:nth-child(1) .stat-icon,
    .kpi-grid .kpi-card:nth-child(2) .stat-icon,
    .kpi-grid .kpi-card:nth-child(3) .stat-icon,
    .kpi-grid .kpi-card:nth-child(4) .stat-icon {
      border-radius: 14px !important;
      border: 1px solid #d8e1f0;
      background: #f1f6ff !important;
      color: #3b5998 !important;
    }
    .kpi-grid .kpi-card .stat-icon .material-symbols-outlined {
      color: #3b5998 !important;
    }
    .table-row:hover { background: #f4f8ff !important; }
    table thead th {
      background: #f5f8ff !important;
      color: #5b6788 !important;
      border-bottom: 1px solid #dce4f2 !important;
    }
    .mobile-nav {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid #dbe3f2 !important;
      box-shadow: 0 14px 30px rgba(19, 31, 63, 0.12) !important;
      backdrop-filter: blur(10px);
    }
    .mobile-nav-item.active {
      background: var(--lx-lime) !important;
      color: var(--lx-lime-ink) !important;
      box-shadow: none !important;
    }
    .notif-panel,
    .cmd-modal,
    .table-settings-pop {
      border-radius: 16px !important;
      border: 1px solid #dbe3f1 !important;
      box-shadow: 0 16px 34px rgba(16, 24, 48, 0.14) !important;
    }
    .command-kbd {
      border-radius: 8px !important;
      border: 1px solid #d8e2f1 !important;
      background: #f6f9ff !important;
      color: #5b6889 !important;
    }
    @media (max-width: 900px) {
      .main-content {
        margin-left: 0 !important;
        padding: 12px 12px calc(var(--mobile-nav-h) + 130px) !important;
      }
      .main-content > header {
        border-radius: 14px !important;
        padding: 12px !important;
      }
      .card { border-radius: 14px !important; }
      #tab-analytics .sf-topbar,
      #tab-analytics .sf-header-row,
      #tab-analytics .sf-filter-row {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      #tab-analytics .sf-summary {
        grid-template-columns: 1fr 1fr !important;
      }
      #tab-analytics .sf-actions {
        width: 100%;
        justify-content: space-between;
      }
      #tab-analytics .sf-main-btn,
      #tab-analytics .sf-mini-btn {
        flex: 1;
        text-align: center;
      }
      #tab-conversations .tg-chat-shell {
        min-height: 62vh;
      }
      #tab-conversations #convMessagesList {
        max-height: 42vh;
      }
      #tab-progrev .format-toolbar {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 6px;
      }
      #tab-progrev .format-btn.wide {
        grid-column: span 3;
      }
      #tab-progrev textarea,
      #tab-progrev input[type="text"],
      #tab-progrev input[type="number"] {
        font-size: 14px;
      }
      #tab-users .table-filter-summary,
      #tab-payments .table-filter-summary {
        width: 100%;
        justify-content: center;
      }
      .bulk-action-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .ux-quick-dock {
      position: fixed;
      right: 18px;
      bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 45;
      background: rgba(255, 255, 255, 0.88);
      backdrop-filter: blur(10px);
      border: 1px solid #d9e2f1;
      border-radius: 999px;
      box-shadow: 0 14px 30px rgba(17, 27, 50, 0.16);
      padding: 8px;
    }
    .ux-dock-chip {
      border: 1px solid #d7e0ef;
      background: #fff;
      color: #2e406c;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ux-dock-chip:hover { background: #eef3ff; }
    .ux-dock-chip.active {
      background: #d8f21b;
      border-color: #c8e218;
      color: #232c07;
    }
    .ux-shortcuts-modal {
      position: fixed;
      inset: 0;
      background: rgba(9, 14, 26, 0.48);
      z-index: 90;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .ux-shortcuts-modal.show { display: flex; }
    .ux-shortcuts-card {
      width: min(560px, 100%);
      border-radius: 18px;
      border: 1px solid #d9e2f1;
      background: #fff;
      box-shadow: 0 20px 40px rgba(11, 21, 44, 0.2);
      padding: 16px;
    }
    .ux-shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #eef2f8;
      font-size: 13px;
      color: #334266;
    }
    .ux-shortcut-row:last-child { border-bottom: 0; }
    .ux-kbd {
      border: 1px solid #d9e2f1;
      border-bottom-width: 2px;
      background: #f8faff;
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
      color: #4a5a7d;
      min-width: 64px;
      text-align: center;
    }
    .ux-loading .card {
      position: relative;
      overflow: hidden;
    }
    .ux-loading .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(110deg, rgba(255,255,255,0) 0%, rgba(225,233,248,0.52) 45%, rgba(255,255,255,0) 100%);
      transform: translateX(-100%);
      animation: uxShimmer 1.2s infinite;
      pointer-events: none;
      z-index: 1;
    }
    @keyframes uxShimmer {
      to { transform: translateX(100%); }
    }
    .ux-tab {
      display: grid;
      gap: 18px;
    }
    .ux-empty {
      border: 1px dashed #d8e2f0;
      border-radius: 14px;
      background: #f9fbff;
      padding: 16px;
      text-align: center;
      color: #6a7796;
      font-size: 13px;
      font-weight: 500;
    }
    .ux-density-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 10px;
      font-weight: 700;
      border: 1px solid #d7e0ef;
      background: #fff;
      color: #546483;
    }
    .tab-section-shell {
      display: grid;
      gap: 14px;
    }
    .tab-section-head {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border: 1px solid #dce5f3;
      border-radius: 16px;
      background: linear-gradient(150deg, #ffffff 0%, #f7faff 100%);
      box-shadow: 0 8px 22px rgba(20, 34, 63, 0.06);
    }
    .table-shell {
      border: 1px solid #dce5f3;
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 8px 24px rgba(15, 27, 53, 0.08);
    }
    .table-shell .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid #e6edf8;
      background: #fbfdff;
    }
    .table-meta {
      font-size: 12px;
      color: #637393;
      font-weight: 600;
    }
    .table-filter-summary {
      font-size: 12px;
      color: #4f6186;
      background: #eef4ff;
      border: 1px solid #d9e5fb;
      border-radius: 999px;
      padding: 6px 10px;
      min-height: 30px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .bulk-action-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 14px;
      background: #f4f8ff;
      border-bottom: 1px solid #dbe6fb;
    }
    .bulk-action-bar.show { display: flex; }
    .bulk-action-bar .count {
      font-size: 12px;
      font-weight: 700;
      color: #24355f;
    }
    .row-select {
      width: 16px;
      height: 16px;
      accent-color: #2f3d67;
      cursor: pointer;
    }
    .table-sticky-actions th[data-col="actions"],
    .table-sticky-actions td[data-col="actions"] {
      position: sticky;
      right: 0;
      z-index: 3;
      background: #fff;
      box-shadow: -6px 0 10px rgba(18, 28, 50, 0.04);
    }
    .table-sticky-actions tbody tr:hover td[data-col="actions"] { background: #f4f8ff; }
    @media (max-width: 1024px) {
      .ux-quick-dock { display: none !important; }
    }
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 z-50">
  <div class="card p-8 w-full max-w-sm mx-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <span class="text-3xl">🚀</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Admin panel</h1>
      <p class="text-gray-500 text-sm mt-1">Tizimga kirish</p>
    </div>
    <form id="loginForm">
      <input type="text" id="username" class="input mb-3" placeholder="Login" required>
      <input type="password" id="password" class="input mb-4" placeholder="Parol" required>
      <button type="submit" class="btn btn-primary w-full">Kirish</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden">Login yoki parol xato</p>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden flex min-h-screen">

  <!-- Left Sidebar - Icons Only Purple Gradient -->
  <aside id="sidebar" class="sidebar fixed left-0 top-0 bottom-0 flex flex-col items-center py-5 z-40">
    <!-- Logo & Toggle -->
    <div class="mb-6 flex flex-col items-center gap-3">
      <div class="sidebar-logo w-12 h-12 rounded-2xl flex items-center justify-center text-xl font-bold cursor-pointer transition-all hover:scale-105" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);">F</div>
      <button onclick="toggleSidebar()" class="sidebar-toggle" title="Menyuni kengaytirish" aria-label="Menyuni kengaytirish">
        <span class="material-symbols-outlined" style="font-size: 16px;" id="sidebarToggleIcon">chevron_right</span>
      </button>
    </div>

    <!-- Main Nav -->
    <nav class="flex flex-col gap-2 flex-1 w-full px-3 items-center overflow-y-auto overflow-x-hidden" aria-label="Asosiy navigatsiya">
      <div class="sidebar-item active" data-tab="overview" data-tooltip="Umumiy ko'rinish" aria-label="Umumiy ko'rinish"><span class="material-symbols-outlined" aria-hidden="true">dashboard</span><span class="sidebar-label">Umumiy</span></div>
      <div class="sidebar-item" data-tab="analytics" data-tooltip="Analitika" aria-label="Analitika"><span class="material-symbols-outlined" aria-hidden="true">analytics</span><span class="sidebar-label">Analitika</span></div>
      <div class="sidebar-item" data-tab="users" data-tooltip="Foydalanuvchilar" aria-label="Foydalanuvchilar"><span class="material-symbols-outlined" aria-hidden="true">group</span><span class="sidebar-label">Userlar</span></div>
      <div class="sidebar-item" data-tab="conversations" data-tooltip="Xabarlar" aria-label="Xabarlar"><span class="material-symbols-outlined" aria-hidden="true">chat</span><span class="sidebar-label">Xabarlar</span></div>
      <div class="sidebar-item" data-tab="payments" data-tooltip="To'lovlar" aria-label="To'lovlar"><span class="material-symbols-outlined" aria-hidden="true">payments</span><span class="sidebar-label">To'lovlar</span></div>
      <div class="sidebar-item" data-tab="lessons" data-tooltip="Darslar" aria-label="Darslar"><span class="material-symbols-outlined" aria-hidden="true">school</span><span class="sidebar-label">Darslar</span></div>
      <div class="sidebar-item" data-tab="library" data-tooltip="Kutubxona" aria-label="Kutubxona"><span class="material-symbols-outlined" aria-hidden="true">video_library</span><span class="sidebar-label">Kutubxona</span></div>
      <div class="sidebar-item" data-tab="progrev" data-tooltip="Progrev" aria-label="Progrev"><span class="material-symbols-outlined" aria-hidden="true">local_fire_department</span><span class="sidebar-label">Progrev</span></div>
      <div class="sidebar-item" data-tab="custdev" data-tooltip="CustDev" aria-label="CustDev"><span class="material-symbols-outlined" aria-hidden="true">psychology</span><span class="sidebar-label">CustDev</span></div>
      <div class="sidebar-item" data-tab="renewal" data-tooltip="Yangilash" aria-label="Yangilash"><span class="material-symbols-outlined" aria-hidden="true">autorenew</span><span class="sidebar-label">Yangilash</span></div>
      <div class="sidebar-item" data-tab="promo" data-tooltip="Promokodlar" aria-label="Promokodlar"><span class="material-symbols-outlined" aria-hidden="true">confirmation_number</span><span class="sidebar-label">Promokod</span></div>
      <div class="sidebar-item" data-tab="referrals" data-tooltip="Referallar" aria-label="Referallar"><span class="material-symbols-outlined" aria-hidden="true">share</span><span class="sidebar-label">Referallar</span></div>
      <div class="sidebar-item" data-tab="audit" data-tooltip="Audit" aria-label="Audit"><span class="material-symbols-outlined" aria-hidden="true">history</span><span class="sidebar-label">Audit</span></div>
    </nav>

    <!-- Divider -->
    <div class="w-10 h-px bg-white/20 my-4" aria-hidden="true"></div>

    <!-- Bottom Nav -->
    <div class="flex flex-col gap-2 w-full px-3 items-center">
      <div class="sidebar-item" data-tab="settings" data-tooltip="Sozlamalar" aria-label="Sozlamalar"><span class="material-symbols-outlined" aria-hidden="true">settings</span><span class="sidebar-label">Sozlamalar</span></div>
      <div class="sidebar-item" onclick="toggleNotificationsPanel()" data-tooltip="Bildirishnomalar" aria-label="Bildirishnomalar"><span class="material-symbols-outlined" aria-hidden="true">notifications</span><span class="sidebar-label">Xabarnoma</span></div>
      <div class="sidebar-item" onclick="logout()" data-tooltip="Chiqish" aria-label="Chiqish" style="color: #fca5a5;"><span class="material-symbols-outlined" aria-hidden="true">logout</span><span class="sidebar-label" style="color: #fca5a5;">Chiqish</span></div>
    </div>

    <!-- Divider -->
    <div class="w-10 h-px bg-white/20 my-4"></div>

    <!-- Profile Avatar -->
    <div class="w-11 h-11 rounded-full bg-gradient-to-br from-pink-400 to-pink-600 flex items-center justify-center text-white font-bold text-sm cursor-pointer hover:scale-110 transition-all border-2 border-white/30">A</div>
  </aside>

  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="overview"><span class="text-lg">📊</span>Umumiy</div>
    <div class="mobile-nav-item" data-tab="users"><span class="text-lg">👥</span>Userlar</div>
    <div class="mobile-nav-item" data-tab="payments"><span class="text-lg">💳</span>To'lov</div>
    <div class="mobile-nav-item" data-tab="lessons"><span class="text-lg">📚</span>Darslar</div>
    <div class="mobile-nav-item" onclick="toggleMobileMenu()"><span class="text-lg">☰</span>Ko'proq</div>
  </nav>

  <!-- Mobile Menu Modal -->
  <div id="mobileMenuModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="toggleMobileMenu()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transform transition-transform duration-300">
      <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
      <h3 class="font-semibold text-gray-800 mb-4">Qo'shimcha menyu</h3>
      <div class="grid grid-cols-3 gap-4">
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('library'); toggleMobileMenu();">
          <span class="text-2xl mb-2">📖</span>
          <span class="text-xs text-gray-600">Kutubxona</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('progrev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">🔥</span>
          <span class="text-xs text-gray-600">Progrevlar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('custdev'); toggleMobileMenu();">
          <span class="text-2xl mb-2">📝</span>
          <span class="text-xs text-gray-600">CustDev</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('analytics'); toggleMobileMenu();">
          <span class="text-2xl mb-2">📈</span>
          <span class="text-xs text-gray-600">Analitika</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('conversations'); toggleMobileMenu();">
          <span class="text-2xl mb-2">💬</span>
          <span class="text-xs text-gray-600">Suhbatlar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('referrals'); toggleMobileMenu();">
          <span class="text-2xl mb-2">🔗</span>
          <span class="text-xs text-gray-600">Referallar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('renewal'); toggleMobileMenu();">
          <span class="text-2xl mb-2">🔁</span>
          <span class="text-xs text-gray-600">Uzaytirish</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('promo'); toggleMobileMenu();">
          <span class="text-2xl mb-2">🎟️</span>
          <span class="text-xs text-gray-600">Promokod</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('audit'); toggleMobileMenu();">
          <span class="text-2xl mb-2">📋</span>
          <span class="text-xs text-gray-600">Audit Log</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-indigo-50 transition-colors" onclick="showTab('settings'); toggleMobileMenu();">
          <span class="text-2xl mb-2">⚙️</span>
          <span class="text-xs text-gray-600">Sozlamalar</span>
        </div>
        <div class="mobile-menu-item flex flex-col items-center p-4 rounded-xl bg-red-50 cursor-pointer hover:bg-red-100 transition-colors" onclick="logout()">
          <span class="text-2xl mb-2">🚪</span>
          <span class="text-xs text-red-600">Chiqish</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content flex-1 ml-[70px] p-6 pb-24 md:pb-6">

    <!-- Header - Modern Style -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <!-- Search Bar -->
      <div onclick="openCommandPalette()" class="flex items-center gap-3 bg-white px-5 py-3.5 rounded-2xl cursor-pointer transition-all hover:shadow-lg hover:border-indigo-500 border border-gray-100 min-w-[300px] md:min-w-[400px]" style="box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <span class="material-symbols-outlined text-gray-400">search</span>
        <span class="text-gray-400 font-medium flex-1">Qidirish...</span>
        <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded font-mono">⌘K</span>
      </div>

      <!-- Right Actions -->
      <div class="flex items-center gap-3">
        <!-- Theme Toggle -->
        <button onclick="toggleTheme()" class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:border-indigo-500 border border-gray-100 transition-all" style="box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <span class="material-symbols-outlined">dark_mode</span>
        </button>

        <!-- Notifications -->
        <button onclick="toggleNotificationsPanel()" class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:border-indigo-500 border border-gray-100 transition-all relative" style="box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <span class="material-symbols-outlined">notifications</span>
          <span id="notifBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-br from-pink-400 to-pink-600 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
        </button>

        <!-- Broadcast Button -->
        <button onclick="openBroadcastModal()" class="btn btn-primary flex items-center gap-2 px-5">
          <span class="material-symbols-outlined" style="font-size: 20px;">send</span>
          <span class="hidden sm:inline">Xabar yuborish</span>
        </button>

        <!-- Profile -->
        <div class="flex items-center gap-3 bg-white px-3 py-2 rounded-2xl border border-gray-100 cursor-pointer hover:border-indigo-500 transition-all" style="box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-sm" style="background: linear-gradient(135deg, #6366F1 0%, #A855F7 100%);">A</div>
          <div class="hidden md:block">
            <p class="text-sm font-semibold text-gray-800">Admin</p>
            <p class="text-xs text-gray-400">Administrator</p>
          </div>
          <span class="material-symbols-outlined text-gray-400 hidden md:block">expand_more</span>
        </div>
      </div>
    </header>

    <!-- Overview Tab -->
    <div id="tab-overview">

      <!-- Hero Banner -->
      <div class="hero-banner relative rounded-3xl p-8 md:p-10 mb-6 overflow-hidden" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 40%, #A855F7 70%, #D946EF 100%); box-shadow: 0 20px 60px rgba(99, 102, 241, 0.3);">
        <!-- Glow Effects -->
        <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-32 right-10 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>

        <!-- Floating Icons (hidden on mobile) -->
        <div class="hero-floating-icon absolute top-6 right-20 w-14 h-14 bg-white/15 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white animate-bounce" style="animation-duration: 3s;">
          <span class="material-symbols-outlined" style="font-size: 28px;">trending_up</span>
        </div>
        <div class="hero-floating-icon absolute top-16 right-8 w-12 h-12 bg-white/15 backdrop-blur-sm rounded-xl flex items-center justify-center text-white animate-bounce" style="animation-duration: 2.5s; animation-delay: 0.5s;">
          <span class="material-symbols-outlined" style="font-size: 24px;">group</span>
        </div>
        <div class="hero-floating-icon absolute bottom-6 right-32 w-12 h-12 bg-white/15 backdrop-blur-sm rounded-xl flex items-center justify-center text-white animate-bounce" style="animation-duration: 3.5s; animation-delay: 1s;">
          <span class="material-symbols-outlined" style="font-size: 24px;">bolt</span>
        </div>

        <!-- Content -->
        <div class="relative z-10 max-w-xl">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
              <span class="material-symbols-outlined text-white" style="font-size: 26px;">auto_awesome</span>
            </div>
            <span class="text-white/80 text-xs font-semibold uppercase tracking-widest">Boshqaruv Paneli</span>
          </div>

          <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-3" style="letter-spacing: -0.02em;">Xush kelibsiz, Admin!</h2>
          <p class="text-white/85 text-lg font-medium mb-5 leading-relaxed" id="heroBannerMessage">Bot ishlash holatida. Ma'lumotlar yuklanmoqda...</p>

          <!-- Quick Stats Badges -->
          <div class="hero-quick-stats flex flex-wrap gap-3">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-white text-sm font-semibold">
              <span class="material-symbols-outlined" style="font-size: 18px;">group</span>
              <span id="heroBannerUsers">0</span> foydalanuvchi
            </div>
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-white text-sm font-semibold">
              <span class="material-symbols-outlined" style="font-size: 18px;">trending_up</span>
              +<span id="heroBannerGrowth">0</span>% bugun
            </div>
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-white text-sm font-semibold">
              <span class="material-symbols-outlined" style="font-size: 18px;">bolt</span>
              <span id="heroBannerActive">0</span> faol hozir
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Stats - Modern Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 kpi-grid">
        <div class="card p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute -top-8 -right-8 w-32 h-32 rounded-full blur-3xl" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); opacity: 0.08;"></div>
          <div class="flex items-start justify-between mb-4 relative">
            <div class="stat-icon" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">
              <span class="material-symbols-outlined text-white" style="font-size: 26px;">group</span>
            </div>
            <div id="statTotalUsersGrowth" class="px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 hidden" style="background: rgba(34,197,94,0.12); color: #22C55E;">
              <span class="material-symbols-outlined" style="font-size: 14px;">trending_up</span>
              <span class="growth-value">0%</span>
            </div>
          </div>
          <p class="text-gray-500 text-xs uppercase tracking-wider font-semibold mb-1">Jami Foydalanuvchilar</p>
          <p class="text-2xl font-extrabold text-gray-800" id="statTotalUsers" style="letter-spacing: -0.02em;">0</p>
          <p class="text-gray-400 text-xs mt-1">Ro'yxatdan o'tgan</p>
        </div>

        <div class="card p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute -top-8 -right-8 w-32 h-32 rounded-full blur-3xl" style="background: linear-gradient(135deg, #22C55E 0%, #4ADE80 100%); opacity: 0.08;"></div>
          <div class="flex items-start justify-between mb-4 relative">
            <div class="stat-icon" style="background: linear-gradient(135deg, #22C55E 0%, #4ADE80 100%);">
              <span class="material-symbols-outlined text-white" style="font-size: 26px;">verified</span>
            </div>
            <div id="statPaidUsersGrowth" class="px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 hidden" style="background: rgba(34,197,94,0.12); color: #22C55E;">
              <span class="material-symbols-outlined" style="font-size: 14px;">trending_up</span>
              <span class="growth-value">0%</span>
            </div>
          </div>
          <p class="text-gray-500 text-xs uppercase tracking-wider font-semibold mb-1">Faol Obunachilar</p>
          <p class="text-2xl font-extrabold text-gray-800" id="statPaidUsers" style="letter-spacing: -0.02em;">0</p>
          <p class="text-gray-400 text-xs mt-1">Pullik a'zolar</p>
        </div>

        <div class="card p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute -top-8 -right-8 w-32 h-32 rounded-full blur-3xl" style="background: linear-gradient(135deg, #F472B6 0%, #EC4899 100%); opacity: 0.08;"></div>
          <div class="flex items-start justify-between mb-4 relative">
            <div class="stat-icon" style="background: linear-gradient(135deg, #F472B6 0%, #EC4899 100%);">
              <span class="material-symbols-outlined text-white" style="font-size: 26px;">payments</span>
            </div>
            <div id="statRevenueGrowth" class="px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 hidden" style="background: rgba(34,197,94,0.12); color: #22C55E;">
              <span class="material-symbols-outlined" style="font-size: 14px;">trending_up</span>
              <span class="growth-value">0%</span>
            </div>
          </div>
          <p class="text-gray-500 text-xs uppercase tracking-wider font-semibold mb-1">Oylik Daromad</p>
          <p class="text-2xl font-extrabold text-gray-800" id="statRevenue" style="letter-spacing: -0.02em;">0</p>
          <p class="text-gray-400 text-xs mt-1">Joriy oy</p>
        </div>

        <div class="card p-5 card-hover relative overflow-hidden kpi-card">
          <div class="absolute -top-8 -right-8 w-32 h-32 rounded-full blur-3xl" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); opacity: 0.08;"></div>
          <div class="flex items-start justify-between mb-4 relative">
            <div class="stat-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);">
              <span class="material-symbols-outlined text-white" style="font-size: 26px;">percent</span>
            </div>
            <div id="statConversionGrowth" class="px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1 hidden" style="background: rgba(34,197,94,0.12); color: #22C55E;">
              <span class="material-symbols-outlined" style="font-size: 14px;">trending_up</span>
              <span class="growth-value">0%</span>
            </div>
          </div>
          <p class="text-gray-500 text-xs uppercase tracking-wider font-semibold mb-1">Konversiya Darajasi</p>
          <p class="text-2xl font-extrabold text-gray-800" id="statConversion" style="letter-spacing: -0.02em;">0%</p>
          <p class="text-gray-400 text-xs mt-1">Userdan pullikka</p>
        </div>
      </div>

      <!-- Overview Control Strip -->
      <div class="card p-4 sm:p-5 mb-4 sm:mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-400">Platform holati</p>
            <h3 class="text-xl font-bold text-gray-800 mt-1" id="overviewHealthTitle">Monitoring faol</h3>
            <p class="text-sm text-gray-500 mt-1" id="overviewHealthMeta">Barcha modullar ishlash holatida.</p>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <span class="ux-density-pill">Paid ratio: <strong id="overviewPaidRatio">0%</strong></span>
            <span class="ux-density-pill">Active ratio: <strong id="overviewActiveRatio">0%</strong></span>
            <button onclick="showTab('analytics')" class="btn btn-secondary btn-sm">Analitikani ochish</button>
            <button onclick="loadAll()" class="btn btn-primary btn-sm">Tez yangilash</button>
          </div>
        </div>
      </div>

      <!-- Today's Quick Stats -->
      <div class="card hero-card p-4 sm:p-5 mb-4 sm:mb-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <p class="text-white/80 text-sm font-medium">📅 Bugungi statistika</p>
            <p class="text-2xl sm:text-3xl font-bold text-white" id="todayDateText"></p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="px-3 py-1 bg-white/20 rounded-full text-sm text-white" id="todayTimeRange">00:00 - 23:59</span>
          </div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
          <div class="bg-white/15 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-white/70 text-xs uppercase tracking-wide font-semibold">Yangi userlar</p>
            <p class="text-2xl sm:text-3xl font-bold text-white" id="todayNewUsers">0</p>
            <p class="text-xs text-white/60 mt-1" id="todayNewUsersChange">O'tgan kunga nisbatan</p>
          </div>
          <div class="bg-white/15 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-white/70 text-xs uppercase tracking-wide font-semibold">To'lovlar</p>
            <p class="text-2xl sm:text-3xl font-bold text-white" id="todayPayments">0</p>
            <p class="text-xs text-white/60 mt-1" id="todayPaymentsAmount">0 so'm</p>
          </div>
          <div class="bg-white/15 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-white/70 text-xs uppercase tracking-wide font-semibold">Dars ko'rganlar</p>
            <p class="text-2xl sm:text-3xl font-bold text-white" id="todayLessonsWatched">0</p>
            <p class="text-xs text-white/60 mt-1">Bugun aktiv</p>
          </div>
          <div class="bg-white/15 backdrop-blur rounded-xl p-3 sm:p-4">
            <p class="text-white/70 text-xs uppercase tracking-wide font-semibold">Feedback</p>
            <p class="text-2xl sm:text-3xl font-bold text-white" id="todayFeedback">0</p>
            <p class="text-xs text-white/60 mt-1" id="todayFeedbackPositive">0 ijobiy</p>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="card p-5 lg:col-span-2">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-3xl font-bold text-gray-800" id="totalRevenueDisplay">0 so'm</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="tab active" data-period="week">Hafta</button>
              <button class="tab" data-period="month">Oy</button>
              <button class="tab" data-period="year">Yil</button>
            </div>
          </div>
          <div class="chart-container chart-bleed">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <!-- User Types -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">Foydalanuvchilar</h3>
          <div class="chart-container h-[180px]">
            <canvas id="userTypeChart"></canvas>
          </div>
          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Aktiv</span>
              <span class="font-medium" id="activeUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> To'lagan</span>
              <span class="font-medium" id="paidUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span> Tugatgan</span>
              <span class="font-medium" id="completedUsersCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscriber Growth Chart -->
      <div class="card p-5 mb-6 insight-card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <p class="text-gray-500 text-sm">Yangi obunachilar</p>
            <p class="text-2xl font-bold text-gray-800" id="subscriberGrowthTitle">Haftalik o'sish</p>
            <p class="text-sm text-gray-400 mt-1" id="growthComparison">Bu davr: <span class="text-indigo-600 font-medium" id="currentPeriodCount">0</span> | O'tgan davr: <span class="text-gray-600 font-medium" id="prevPeriodCount">0</span></p>
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
            <div id="growthIndicator" class="flex items-center gap-1 text-green-600 font-semibold text-lg">
              <span id="growthArrow">↑</span>
              <span id="growthPercent">0%</span>
            </div>
            <div class="flex gap-1 sm:gap-2 flex-wrap tab-row">
              <button class="tab text-xs sm:text-sm px-2 sm:px-4 active" data-growth-period="day">Kun</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="week">Hafta</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="month">Oy</button>
              <button class="tab text-xs sm:text-sm px-2 sm:px-4" data-growth-period="year">Yil</button>
            </div>
          </div>
        </div>
        <div class="flex gap-4 mb-2 text-xs">
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Bu davr</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-300"></span> O'tgan davr</div>
        </div>
        <div class="chart-container chart-bleed" style="height: 250px; min-height: 250px;">
          <canvas id="subscriberGrowthChart" style="width: 100% !important; height: 100% !important;"></canvas>
        </div>
      </div>

      <!-- Source & Referral Stats Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Traffic Sources -->
        <div class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800">📍 Trafik manbalari</h3>
            <button onclick="openModal('sourceLinkModal')" class="text-sm text-indigo-600 font-medium hover:text-indigo-800">+ Link yaratish</button>
          </div>
          <div id="sourceStatsContainer">
            <div class="text-center text-gray-400 py-4">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Referral Stats -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">🔗 Referal tizimi</h3>
          <div id="referralStatsContainer">
            <div class="text-center text-gray-400 py-4">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Users -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h3 class="font-semibold text-gray-800">So'nggi foydalanuvchilar</h3>
            <button onclick="showTab('users')" class="text-indigo-600 text-sm font-medium">Barchasi →</button>
          </div>
          <div id="recentUsersList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Recent Payments -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h3 class="font-semibold text-gray-800">So'nggi to'lovlar</h3>
            <button onclick="showTab('payments')" class="text-indigo-600 text-sm font-medium">Barchasi →</button>
          </div>
          <div id="recentPaymentsList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="hidden">
      <div class="tab-section-shell">
        <div class="tab-section-head">
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-400">Foydalanuvchilar paneli</p>
            <h3 class="text-lg font-bold text-gray-800">Qidiruv, segmentlash va tez amallar</h3>
          </div>
          <div class="table-filter-summary" id="usersFilterSummary">Filtrlar: barchasi</div>
        </div>
      <div class="table-shell">
        <div class="p-5 border-b border-gray-100">
          <div class="flex flex-col lg:flex-row justify-between gap-4 mb-4">
            <h3 class="font-semibold text-gray-800 text-lg">👥 Foydalanuvchilar <span class="text-gray-400 font-normal" id="filteredUsersCount"></span></h3>
            <div class="flex gap-2 items-center flex-wrap">
              <input type="text" id="userSearch" class="input py-2 px-3 w-full sm:w-48" placeholder="🔍 Ism, telefon..." oninput="applyUserFilters()">
              <div class="flex items-center gap-1 flex-wrap" id="userSavedViews">
                <button class="saved-view-chip active" onclick="applyUsersSavedView('all')">Barchasi</button>
                <button class="saved-view-chip" onclick="applyUsersSavedView('high_intent')">Yuqori qiziqish</button>
                <button class="saved-view-chip" onclick="applyUsersSavedView('paid_not_joined')">To'lagan, kirmagan</button>
                <button class="saved-view-chip" onclick="applyUsersSavedView('inactive')">Nofaol</button>
              </div>
              <button onclick="toggleAdvancedFilters()" class="btn btn-secondary btn-sm flex items-center gap-1">
                <span>🎛️</span> <span id="advFilterLabel">Filtrlar</span>
              </button>
              <div class="relative">
                <button onclick="toggleTableSettings('users')" class="btn btn-secondary btn-sm ui-btn-icon"><span class="material-symbols-outlined">view_column</span> Ustunlar</button>
                <div id="usersTableSettings" class="table-settings-pop hidden"></div>
              </div>
              <button onclick="exportUsers()" class="btn btn-secondary btn-sm" title="Eksport">📥</button>
            </div>
          </div>

          <!-- Advanced Filters Panel -->
          <div id="advancedFiltersPanel" class="hidden bg-gray-50 rounded-xl p-4 space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <!-- Status Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Status</label>
                <select id="userStatusFilter" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="free">Free</option>
                  <option value="paid">Premium</option>
                  <option value="paid_not_joined">To'lagan (kanalda emas)</option>
                </select>
              </div>

              <!-- Lesson Range -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (dan)</label>
                <input type="number" id="filterLessonFrom" class="input py-2 text-sm" min="0" placeholder="0" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Dars (gacha)</label>
                <input type="number" id="filterLessonTo" class="input py-2 text-sm" min="0" placeholder="10" onchange="applyUserFilters()">
              </div>

              <!-- Registration Date -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Ro'yxatdan o'tish</label>
                <select id="filterRegDate" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="today">Bugun</option>
                  <option value="week">Bu hafta</option>
                  <option value="month">Bu oy</option>
                  <option value="custom">Tanlash...</option>
                </select>
              </div>

              <!-- Phone Filter -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Telefon</label>
                <select id="filterPhone" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="has">Bor</option>
                  <option value="no">Yo'q</option>
                </select>
              </div>

              <!-- Funnel Step -->
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Funnel bosqich</label>
                <select id="filterFunnelStep" class="input py-2 text-sm" onchange="applyUserFilters()">
                  <option value="all">Barchasi</option>
                  <option value="0">0 - Yangi</option>
                  <option value="1">1-4 - CustDev</option>
                  <option value="5">5 - Darsda</option>
                  <option value="8">8+ - Tugagan</option>
                </select>
              </div>
            </div>

            <!-- Custom Date Range (hidden by default) -->
            <div id="customDateRange" class="hidden grid grid-cols-2 gap-3 max-w-sm">
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Boshlanish</label>
                <input type="date" id="filterDateFrom" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
              <div>
                <label class="text-xs text-gray-500 mb-1 block">Tugash</label>
                <input type="date" id="filterDateTo" class="input py-2 text-sm" onchange="applyUserFilters()">
              </div>
            </div>

            <div class="flex gap-2">
              <button onclick="resetUserFilters()" class="btn btn-secondary btn-sm">🔄 Tozalash</button>
              <span class="text-sm text-gray-500 flex items-center" id="activeFiltersInfo"></span>
            </div>
          </div>
        </div>
        <div id="usersBulkActionBar" class="bulk-action-bar">
          <div class="count" id="usersBulkCount">0 ta user tanlangan</div>
          <div class="flex items-center gap-2">
            <button class="btn btn-secondary btn-sm" onclick="clearUsersSelection()">Tozalash</button>
            <button class="btn btn-primary btn-sm" onclick="bulkBroadcastSelectedUsers()">Xabar yuborish</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full responsive-table table-sticky-first table-sticky-actions" id="usersTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"><input id="usersSelectAllPage" type="checkbox" class="row-select" onchange="toggleSelectAllUsersPage(this.checked)" title="Sahifadagi barchani tanlash"></th>
                <th data-col="user" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th data-col="phone" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                <th data-col="lesson" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dars</th>
                <th data-col="status" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th data-col="date" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th data-col="actions" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="7" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-100 flex justify-center gap-2" id="usersPagination"></div>
      </div>
      </div>
    </div>

    <!-- Conversations Tab -->
    <div id="tab-conversations" class="hidden">
      <div class="card p-4">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
          <div class="xl:col-span-3 border border-gray-100 rounded-xl bg-white/70">
            <div class="px-3 py-3 border-b border-gray-100">
              <p class="text-sm font-semibold text-gray-700">💬 Suhbatlar</p>
              <div class="flex gap-2 mt-2">
                <input id="convSearch" type="text" class="input py-2 px-3" placeholder="Suhbat qidirish..." oninput="renderConversationUsers()">
                <button onclick="loadConversations()" class="btn btn-secondary btn-sm">🔄</button>
              </div>
            </div>
            <div id="convUsersList" class="conv-users-list">
              <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
            </div>
          </div>

          <div class="xl:col-span-6 tg-chat-shell">
            <div class="tg-chat-head">
              <div class="conv-avatar" id="convHeaderAvatar">U</div>
              <div class="min-w-0">
                <p class="font-semibold text-gray-800 truncate" id="convSelectedUser">User tanlang</p>
                <p class="text-xs text-gray-500 truncate" id="convSelectedUserMeta">Chat tarixini ko'rish uchun chapdan user tanlang</p>
              </div>
            </div>
            <div id="convMessagesList" class="tg-chat-body">
              <div class="text-center text-gray-500">Chap tomondan userni tanlang</div>
            </div>
            <div class="border-t border-gray-100 bg-white/85 p-3 space-y-2">
              <div id="convReplyToBar" class="hidden text-xs bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-2 text-indigo-700">
                <div class="flex items-center justify-between gap-2">
                  <div class="truncate">
                    ↪ Javob beriladigan xabar: <span id="convReplyToText"></span>
                  </div>
                  <button class="text-indigo-600" onclick="clearConversationReplyTo()">✕</button>
                </div>
              </div>

              <div class="flex flex-wrap gap-1">
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('b')" title="Bold"><b>B</b></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('i')" title="Italic"><i>I</i></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('u')" title="Underline"><u>U</u></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('s')" title="Strike"><s>S</s></button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('spoiler')" title="Spoiler">🙈</button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('blockquote')" title="Quote">❝ ❞</button>
                <button class="btn btn-secondary btn-sm" onclick="wrapReplySelection('code')" title="Code">{ }</button>
                <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplate()" title="Link">🔗</button>
                <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplate()" title="Custom Emoji">✨</button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <input id="convStickerFileId" class="input py-2 px-3" placeholder="Sticker file_id (ixtiyoriy)">
                <div class="flex items-center gap-2">
                  <select id="convParseMode" class="input py-2 px-3">
                    <option value="HTML">HTML (tavsiya)</option>
                    <option value="MarkdownV2">MarkdownV2</option>
                  </select>
                  <label class="text-xs text-gray-600 flex items-center gap-1">
                    <input type="checkbox" id="convDisablePreview"> Havola preview o'chirilgan
                  </label>
                </div>
              </div>

              <div class="flex items-end gap-2">
                <textarea id="convReplyInput" class="input min-h-[44px] max-h-[140px] resize-y" placeholder="Type your message... (HTML format ham mumkin)" onkeydown="handleConvReplyKey(event)"></textarea>
                <button id="convReplyBtn" onclick="sendConversationReply()" class="btn btn-primary">📨</button>
              </div>
            </div>
          </div>

          <div class="xl:col-span-3 border border-gray-100 rounded-xl bg-white/70 p-4">
            <p class="text-sm font-semibold text-gray-700 mb-3">User info</p>
            <div class="space-y-2 text-sm">
              <div><span class="text-gray-400">Ism:</span> <span id="convInfoName" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Username:</span> <span id="convInfoUsername" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Telegram ID:</span> <span id="convInfoTgId" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Telefon:</span> <span id="convInfoPhone" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Dars:</span> <span id="convInfoLesson" class="text-gray-700">-</span></div>
              <div><span class="text-gray-400">Status:</span> <span id="convInfoStatus" class="text-gray-700">-</span></div>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-100">
              <p class="text-xs text-gray-400 mb-2">Tez amallar</p>
              <div class="flex flex-col gap-2">
                <button onclick="insertQuickReply('Assalomu alaykum! Xabaringiz uchun rahmat 🙌')" class="btn btn-secondary btn-sm text-left">Salomlashish</button>
                <button onclick="insertQuickReply('Rahmat, tekshirib sizga tez orada javob beraman.')" class="btn btn-secondary btn-sm text-left">Standart javob</button>
              </div>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-100">
              <div class="flex items-center justify-between gap-2 mb-2">
                <p class="text-xs text-gray-400">Custom emoji bank</p>
                <button onclick="loadCustomEmojiLibrary(true)" class="btn btn-secondary btn-sm">🔄</button>
              </div>
              <div id="emojiBankCount" class="text-xs text-gray-500 mb-2">0 ta emoji</div>
              <div id="emojiBankList" class="max-h-[260px] overflow-y-auto space-y-1">
                <div class="text-xs text-gray-400">Yuklanmoqda...</div>
              </div>
              <p class="text-[11px] text-gray-400 mt-2">Emoji ustiga bossangiz, aktiv matn maydoniga qo'shiladi.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="tab-payments" class="hidden">
      <div class="tab-section-shell">
      <div class="tab-section-head">
        <div>
          <p class="text-xs uppercase tracking-wide text-gray-400">To'lovlar paneli</p>
          <h3 class="text-lg font-bold text-gray-800">Konversiya va to'lov holatlarini boshqarish</h3>
        </div>
        <div class="table-filter-summary" id="paymentsFilterSummary">Filtr: To'langan</div>
      </div>
      <!-- Payment Status Tabs -->
      <div class="flex flex-wrap gap-2 mb-4 tab-row">
        <button class="tab active" data-payment-status="completed" onclick="filterPayments('completed')">✅ To'langan</button>
        <button class="tab" data-payment-status="pending" onclick="filterPayments('pending')">⏳ Jarayonda</button>
        <button class="tab" data-payment-status="cancelled" onclick="filterPayments('cancelled')">❌ Bekor qilingan</button>
        <button class="tab" data-payment-status="all" onclick="filterPayments('all')">📋 Barchasi</button>
      </div>

      <!-- Payment Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 kpi-grid">
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Bugun</p>
          <p class="text-2xl font-bold text-green-600" id="payToday">0</p>
          <p class="text-xs text-gray-400" id="payTodayCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Hafta</p>
          <p class="text-2xl font-bold text-blue-600" id="payWeek">0</p>
          <p class="text-xs text-gray-400" id="payWeekCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Oy</p>
          <p class="text-2xl font-bold text-indigo-600" id="payMonth">0</p>
          <p class="text-xs text-gray-400" id="payMonthCount">0 ta</p>
        </div>
        <div class="card p-5 kpi-card">
          <p class="text-gray-500 text-sm mb-1">Jami</p>
          <p class="text-2xl font-bold text-gray-800" id="payTotal">0</p>
          <p class="text-xs text-gray-400" id="payTotalCount">0 ta</p>
        </div>
      </div>

      <!-- Payment Status Summary -->
      <div class="grid grid-cols-3 gap-4 mb-6 kpi-grid">
        <div class="card p-4 border-l-4 border-green-500 kpi-card">
          <p class="text-sm text-gray-500">To'langan</p>
          <p class="text-xl font-bold text-green-600" id="payCompletedCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-yellow-500 kpi-card">
          <p class="text-sm text-gray-500">Jarayonda</p>
          <p class="text-xl font-bold text-yellow-600" id="payPendingCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-red-500 kpi-card">
          <p class="text-sm text-gray-500">Bekor qilingan</p>
          <p class="text-xl font-bold text-red-600" id="payCancelledCount">0</p>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="table-shell">
        <div class="table-header">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h3 class="font-semibold text-gray-800 text-lg">💳 To'lovlar tarixi</h3>
            <div class="table-meta" id="paymentsTableMeta">0 ta yozuv</div>
          </div>
          <div class="relative">
            <button onclick="toggleTableSettings('payments')" class="btn btn-secondary btn-sm ui-btn-icon"><span class="material-symbols-outlined">view_column</span> Ustunlar</button>
            <div id="paymentsTableSettings" class="table-settings-pop hidden"></div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full responsive-table table-sticky-first table-sticky-actions" id="paymentsTable">
            <thead class="bg-gray-50">
              <tr>
                <th data-col="date" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th data-col="user" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th data-col="amount" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summa</th>
                <th data-col="plan" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reja</th>
                <th data-col="status" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th data-col="system" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tizim</th>
                <th data-col="premium" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Premium kanal</th>
                <th data-col="actions" class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amal</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="8" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </div>

    <!-- Lessons Tab -->
    <div id="tab-lessons" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <h3 class="font-semibold text-gray-800 text-lg">📚 Darslar</h3>
          <button onclick="openLessonModal()" class="btn btn-primary">+ Yangi dars</button>
        </div>
        <div id="lessonsList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- Lesson Progress Stats -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">📊 Darslar bo'yicha statistika</h3>
        <div id="lessonProgressStats" class="space-y-3">
          <p class="text-gray-400 text-center">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Media ID Info -->
      <div class="card mt-6 p-5 bg-blue-50 border-blue-200">
        <h3 class="font-semibold text-blue-800 mb-2">💡 Media ID olish</h3>
        <p class="text-sm text-blue-600">
          Telegram botga video/audio/fayl/video xabar yuboring - bot sizga File ID beradi.
          O'sha ID ni darsga joylashtirsangiz, foydalanuvchilarga o'sha media yuboriladi.
        </p>
      </div>
    </div>

    <!-- Library Tab (Darslar kutubxonasi) -->
    <div id="tab-library" class="hidden">

      <!-- Media Library Section (Botga yuborilgan fayllar) -->
      <div class="card p-5 mb-6 insight-card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">📁 Media kutubxonasi</h3>
            <p class="text-sm text-gray-500">Botga yuborilgan barcha media fayllar</p>
          </div>
          <div class="flex flex-wrap gap-2 w-full sm:w-auto">
            <select id="mediaTypeFilter" class="input text-sm w-full sm:w-auto" onchange="loadMediaLibrary()">
              <option value="all">Barchasi</option>
              <option value="video">🎬 Video</option>
              <option value="photo">🖼 Rasm</option>
              <option value="voice">🎤 Ovozli</option>
              <option value="audio">🎵 Audio</option>
              <option value="video_note">⚪ Video xabar</option>
            </select>
            <button onclick="loadMediaLibrary()" class="btn btn-secondary text-sm w-full sm:w-auto">🔄</button>
          </div>
        </div>

        <!-- Media Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-4">
          <div class="bg-indigo-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Jami</p>
            <p class="text-lg font-bold text-indigo-600" id="mediaStatsTotal">0</p>
          </div>
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video</p>
            <p class="text-lg font-bold text-blue-600" id="mediaStatsVideo">0</p>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Rasm</p>
            <p class="text-lg font-bold text-green-600" id="mediaStatsPhoto">0</p>
          </div>
          <div class="bg-orange-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Audio</p>
            <p class="text-lg font-bold text-orange-600" id="mediaStatsAudio">0</p>
          </div>
          <div class="bg-purple-50 rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">Video xabar</p>
            <p class="text-lg font-bold text-purple-600" id="mediaStatsVideoNote">0</p>
          </div>
        </div>

        <div id="mediaLibraryList" class="space-y-2 max-h-[400px] overflow-y-auto">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>

        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-800">💡 <strong>Yangi media qo'shish:</strong> Botga istalgan media (video, rasm, audio) yuboring - avtomatik kutubxonaga qo'shiladi!</p>
        </div>
      </div>

      <!-- Darslar kutubxonasi -->
      <div class="card p-5 mb-6 insight-card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">📖 Darslar kutubxonasi</h3>
            <p class="text-sm text-gray-500">Barcha darslarning ID lari va tafsilotlari</p>
          </div>
          <button onclick="copyAllLessonIds()" class="btn btn-secondary text-sm">
            📋 Barcha ID larni nusxalash
          </button>
        </div>

        <div id="libraryLessonsList" class="space-y-3">
          <p class="text-gray-400 text-center py-8">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Quick Reference -->
      <div class="card p-5 bg-gradient-to-br from-indigo-50 to-purple-50">
        <h3 class="font-semibold text-indigo-800 mb-4">📌 Tez ma'lumot</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Jami darslar</p>
            <p class="text-2xl font-bold text-indigo-600" id="libraryTotalLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Video bilan</p>
            <p class="text-2xl font-bold text-green-600" id="libraryVideoLessons">0</p>
          </div>
          <div class="bg-white/80 rounded-lg p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Audio bilan</p>
            <p class="text-2xl font-bold text-orange-600" id="libraryAudioLessons">0</p>
          </div>
        </div>
      </div>

      <!-- Usage Guide -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">💡 Foydalanish bo'yicha</h3>
        <div class="space-y-3 text-sm text-gray-600">
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">1</span>
            <p><strong>ID nusxalash:</strong> Istalgan dars ID sini bosib nusxalang</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">2</span>
            <p><strong>Media qo'shish:</strong> Botga video/audio yuboring, File ID oling</p>
          </div>
          <div class="flex gap-3 items-start">
            <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 font-bold text-xs">3</span>
            <p><strong>Test qilish:</strong> Admin paneldan darsni test sifatida yuborib ko'ring</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Progrev Tab (Pitch/Sales/Soft Attack) -->
    <div id="tab-progrev" class="hidden">

      <!-- Flow Visual Guide -->
      <div class="card progrev-flow-card p-4 mb-6">
        <h3 class="font-semibold text-gray-800 mb-3">📊 Progrev ketma-ketligi</h3>
        <div class="progrev-flow-track">
          <span class="progrev-flow-pill flow-green">1. Tabrik</span>
          <span class="progrev-flow-arrow">→</span>
          <span class="progrev-flow-pill flow-blue">2. Feedback savoli</span>
          <span class="progrev-flow-arrow">→</span>
          <span class="progrev-flow-pill flow-purple">3. Ha: Kurs haqida</span>
          <span class="progrev-flow-arrow">→</span>
          <span class="progrev-flow-pill flow-orange">4. Sales Pitch</span>
          <span class="progrev-flow-arrow">→</span>
          <span class="progrev-flow-pill flow-red">5. Soft Attack</span>
        </div>
        <p class="text-xs text-gray-500 mt-2">Yo'q javobida: Sabab so'rash → Follow-up → (ixtiyoriy) Chegirmali taklif</p>
      </div>

      <!-- Universal Progrev Formatter -->
      <div class="card progrev-editor-card p-4 mb-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
          <h3 class="font-semibold text-gray-800 text-sm">✍️ Progrev matn formatlash</h3>
          <p id="progrevActiveEditorLabel" class="text-xs text-gray-500">Maydon tanlanmagan</p>
        </div>
        <div class="format-toolbar">
          <button class="format-btn" onclick="applyProgrevFormat('b')" title="Bold"><b>B</b></button>
          <button class="format-btn" onclick="applyProgrevFormat('i')" title="Italic"><i>I</i></button>
          <button class="format-btn" onclick="applyProgrevFormat('u')" title="Underline"><u>U</u></button>
          <button class="format-btn" onclick="applyProgrevFormat('s')" title="Strike"><s>S</s></button>
          <button class="format-btn" onclick="applyProgrevFormat('spoiler')" title="Spoiler">🙈</button>
          <button class="format-btn wide" onclick="applyProgrevFormat('blockquote')" title="Quote">❝ Quote</button>
          <button class="format-btn wide" onclick="applyProgrevFormat('blockquote_expand')" title="Expandable quote (bosganda ochiladi)">📖 Expand Quote</button>
          <button class="format-btn" onclick="applyProgrevFormat('code')" title="Code">{ }</button>
          <button class="format-btn" onclick="applyProgrevFormat('link')" title="Link">🔗</button>
          <button class="format-btn" onclick="applyProgrevFormat('emoji')" title="Custom emoji">✨</button>
        </div>
        <p class="text-xs text-gray-400 mt-2">Qaysi maydonga yozayotgan bo'lsangiz, tugma o'sha maydonga ishlaydi. `Expand Quote` Telegramda bosilganda ochiladi.</p>
        <div class="emoji-bank-shell">
          <div class="emoji-bank-head">
            <p class="text-xs text-gray-500">Custom emoji bank (Progrev)</p>
            <button onclick="loadCustomEmojiLibrary(true)" class="emoji-bank-refresh" title="Emoji bankni yangilash">🔄</button>
          </div>
          <div id="emojiBankProgrevCount" class="text-xs text-gray-500 mb-2">0 ta emoji</div>
          <div id="emojiBankProgrevList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
            <div class="text-xs text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

      <!-- Step 1: Congrats -->
      <div class="card p-5 mb-4 border-l-4 border-green-500">
        <h3 class="font-semibold text-gray-800 mb-2">1️⃣ Tabrik xabari</h3>
        <p class="text-xs text-gray-500 mb-3">Barcha darslar tugaganidan keyin</p>
        <textarea id="congratsText" class="input h-24 resize-none" placeholder="🎉 Tabriklayman! Barcha bepul darslarni tugatdingiz!"></textarea>
      </div>

      <!-- Start Messages -->
      <div class="card p-5 mb-4 border-l-4 border-indigo-500">
        <h3 class="font-semibold text-gray-800 mb-2">🆕 Start xabarlari</h3>
        <p class="text-xs text-gray-500 mb-3">/start bosilganda yuboriladigan birinchi xabarlar</p>

        <div class="flex flex-wrap gap-1 mb-3">
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','b')"><b>B</b></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','i')"><i>I</i></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','u')"><u>U</u></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','s')"><s>S</s></button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','spoiler')">🙈 Spoiler</button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','blockquote')">❝ Quote</button>
          <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startWelcomeText','code')">{ }</button>
          <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplateTo('startWelcomeText')">🔗 Link</button>
          <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplateTo('startWelcomeText')">✨ Emoji</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Welcome xabari (`welcome`)</label>
            <textarea id="startWelcomeText" class="input h-36 resize-none" placeholder="🎉 Assalomu alaykum!..."></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Ism so'rash xabari (`ask_name`)</label>
            <textarea id="startAskNameText" class="input h-36 resize-none" placeholder="👤 Iltimos, ism-familiyangizni kiriting:"></textarea>
            <div class="flex flex-wrap gap-1 mt-2">
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','b')"><b>B</b></button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','i')"><i>I</i></button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','spoiler')">🙈</button>
              <button class="btn btn-secondary btn-sm" onclick="wrapTextareaSelection('startAskNameText','blockquote')">❝</button>
              <button class="btn btn-secondary btn-sm" onclick="insertLinkTemplateTo('startAskNameText')">🔗</button>
              <button class="btn btn-secondary btn-sm" onclick="insertCustomEmojiTemplateTo('startAskNameText')">✨</button>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Bu maydonlar HTML parse mode bilan yuboriladi. `&lt;tg-spoiler&gt;`, `&lt;blockquote&gt;`, `&lt;tg-emoji ...&gt;` ishlaydi.</p>
      </div>

      <!-- Step 2: Feedback Question -->
      <div class="card p-5 mb-4 border-l-4 border-blue-500">
        <h3 class="font-semibold text-gray-800 mb-2">2️⃣ Feedback savoli</h3>
        <p class="text-xs text-gray-500 mb-3">Darslar yoqdimi so'rash</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg mb-3">
              <input type="checkbox" id="feedbackEnabled" class="w-5 h-5 accent-blue-600" checked>
              <label class="text-sm font-medium text-blue-800">Feedback flow yoqilgan</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - tabrikdan keyin</label>
              <input type="number" id="pitchDelayMinutes" class="input" value="0" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = darhol</p>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
            <textarea id="feedbackQuestion" class="input h-20 resize-none" placeholder="Bepul darslar yoqdimi? 🤔"></textarea>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input type="text" id="feedbackYesBtn" class="input text-sm" value="👍 Ha, juda yoqdi!" placeholder="Ha tugmasi">
              <input type="text" id="feedbackNoBtn" class="input text-sm" value="😐 Unchalik emas" placeholder="Yo'q tugmasi">
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Positive Response - Course Info -->
      <div class="card p-5 mb-4 border-l-4 border-purple-500">
        <h3 class="font-semibold text-gray-800 mb-2">3️⃣ ✅ "Ha" javobidan keyin - Kurs haqida</h3>
        <p class="text-xs text-gray-500 mb-3">Pullik kurs haqida ma'lumot + tugma → Sales Pitch ga o'tish</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Kurs haqida matn</label>
            <textarea id="pitchInfoText" class="input h-32 resize-none" placeholder="🎉 Ajoyib tanlov!

To'liq kursda sizni kutmoqda:
✅ 50+ dars
✅ Amaliy topshiriqlar
✅ Sertifikat

Hoziroq ro'yxatdan o'ting! 👇"></textarea>
            <div class="mt-2">
              <label class="text-sm text-gray-600 mb-1 block">Tugma matni</label>
              <input type="text" id="pitchInfoBtn" class="input" value="🚀 Kursga yozilish" placeholder="Tugma matni">
            </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg space-y-3">
            <label class="text-sm font-medium text-purple-800 block">📎 Media (ixtiyoriy)</label>
            <select id="pitchMediaType" class="input" onchange="togglePitchMediaFields()">
              <option value="none">📝 Faqat matn</option>
              <option value="video">🎬 Video</option>
              <option value="audio">🎤 Ovozli xabar</option>
              <option value="image">🖼️ Rasm</option>
              <option value="video_note">⚪ Dumaloq video</option>
            </select>
            <div id="pitchMediaVideoField" class="hidden">
              <input type="text" id="pitchVideoFileId" class="input file-id-input text-sm" placeholder="Video File ID">
            </div>
            <div id="pitchMediaAudioField" class="hidden">
              <input type="text" id="pitchAudioFileId" class="input file-id-input text-sm" placeholder="Audio File ID">
            </div>
            <div id="pitchMediaImageField" class="hidden">
              <input type="text" id="pitchImageFileId" class="input file-id-input text-sm" placeholder="Rasm File ID">
            </div>
            <div id="pitchMediaVideoNoteField" class="hidden">
              <input type="text" id="pitchVideoNoteFileId" class="input file-id-input text-sm" placeholder="Video Note File ID">
            </div>
            <p class="text-xs text-gray-500">Botga media yuboring va File ID ni oling</p>
          </div>
        </div>
      </div>

      <!-- Step 3b: Negative Response -->
      <div class="card p-5 mb-4 border-l-4 border-red-400">
        <h3 class="font-semibold text-gray-800 mb-2">3️⃣ ❌ "Yo'q" javobidan keyin</h3>
        <p class="text-xs text-gray-500 mb-3">Sabab so'rash va follow-up</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sabab so'rash xabari</label>
              <textarea id="feedbackNoResponse" class="input h-20 resize-none" placeholder="😔 Tushunaman. Iltimos, nimada kamchilik borligini yozing..."></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Follow-up xabar (sabab yozganidan keyin)</label>
              <textarea id="feedbackFollowup" class="input h-20 resize-none" placeholder="Rahmat fikringiz uchun! 🙏 Biz doimo yaxshilanib boramiz..."></textarea>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
              <input type="checkbox" id="feedbackSpecialOfferEnabled" class="w-5 h-5 accent-orange-600">
              <label class="text-sm font-medium text-orange-800">Maxsus 20% chegirma taklifi</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Chegirma xabari</label>
              <textarea id="feedbackSpecialOffer" class="input h-16 resize-none" placeholder="🎁 Sizga maxsus 20% chegirma!"></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sales Pitch ga o'tish (daqiqa)</label>
              <input type="number" id="feedbackNoSalesDelay" class="input" value="30" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = follow-up dan keyin darhol</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Sales Pitch -->
      <div class="card p-5 mb-4 border-l-4 border-orange-500">
        <h3 class="font-semibold text-gray-800 mb-2">4️⃣ Sales Pitch (Narxlar)</h3>
        <p class="text-xs text-gray-500 mb-3">"Kursga yozilish" tugmasi bosilgandan keyin</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Sales matn sarlavhasi</label>
            <textarea id="salesPitchText" class="input h-28 resize-none" placeholder="🎓 SMM PRO KURSGA TAKLIF!

Obuna turini tanlang:"></textarea>
            <p class="text-xs text-gray-400 mt-1">Narxlar avtomatik qo'shiladi</p>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - feedback yo'q bo'lsa</label>
            <input type="number" id="salesDelayMinutes" class="input" value="0" min="0">
            <p class="text-xs text-gray-400 mt-1">Agar feedback o'chirilgan bo'lsa, tabrikdan keyin</p>
          </div>
        </div>
      </div>

      <!-- Step 5: Soft Attack -->
      <div class="card p-5 mb-4 border-l-4 border-red-500">
        <h3 class="font-semibold text-gray-800 mb-2">5️⃣ Soft Attack (Oxirgi taklif)</h3>
        <p class="text-xs text-gray-500 mb-3">Sotib olmagan foydalanuvchilarga</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" id="softAttackDisabled" class="w-5 h-5 accent-red-600">
              <label class="text-sm text-gray-600">O'chirilgan</label>
            </div>
            <label class="text-sm text-gray-600 mb-1 block">Soft attack matni</label>
            <textarea id="softAttackText" class="input h-24 resize-none" placeholder="🤔 Hali qaror qilmadingizmi?

Kurs haqida savollaringiz bo'lsa yozing!"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - sales pitchdan keyin</label>
            <input type="number" id="softAttackDelayMinutes" class="input" value="1440" min="0">
            <p class="text-xs text-gray-400 mt-1">1440 daqiqa = 24 soat</p>
          </div>
        </div>
      </div>

      <!-- Lesson Completion Settings -->
      <div class="card p-5 mb-4">
        <h3 class="font-semibold text-gray-800 mb-2">📺 Dars ko'rish tugmasi (default)</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Tugmadan oldingi matn</label>
            <input type="text" id="watchedMessageDefault" class="input" placeholder="Videoni ko'rib bo'lganingizdan keyin tugmani bosing:">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Tugma matni</label>
            <input type="text" id="watchedButtonDefault" class="input" placeholder="✅ Videoni ko'rib bo'ldim">
          </div>
        </div>
      </div>

      <button onclick="saveProgrevSettings()" class="btn btn-primary">💾 Progrev sozlamalarini saqlash</button>
    </div>

    <!-- CustDev Tab -->
    <div id="tab-custdev" class="hidden">
      <!-- CustDev Header with Export -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <h2 class="text-xl font-bold text-gray-800">CustDev ma'lumotlari</h2>
        <button onclick="exportCustDevAnswers()" class="btn btn-secondary">📥 Javoblarni eksport qilish (CSV)</button>
      </div>

      <!-- CustDev Overview Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami savollar</p>
          <p class="text-2xl font-bold text-indigo-600" id="custdevTotalQuestions">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami javoblar</p>
          <p class="text-2xl font-bold text-green-600" id="custdevTotalAnswers">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Javob berganlar</p>
          <p class="text-2xl font-bold text-blue-600" id="custdevRespondents">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">O'rtacha javob</p>
          <p class="text-2xl font-bold text-orange-600" id="custdevAvgAnswers">0</p>
        </div>
      </div>

      <!-- CustDev Charts -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Yosh</p>
          <div class="chart-container h-[120px]">
            <canvas id="ageChart"></canvas>
          </div>
          <div id="ageChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Kasb</p>
          <div class="chart-container h-[120px]">
            <canvas id="occupationChart"></canvas>
          </div>
          <div id="occupationChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Daromad</p>
          <div class="chart-container h-[120px]">
            <canvas id="incomeChart"></canvas>
          </div>
          <div id="incomeChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Byudjet</p>
          <div class="chart-container h-[120px]">
            <canvas id="budgetChart"></canvas>
          </div>
          <div id="budgetChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
      </div>

      <!-- Questions List -->
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <h3 class="font-semibold text-gray-800 text-lg">📝 CustDev savollari</h3>
          <button onclick="openCustDevModal()" class="btn btn-primary">+ Yangi savol</button>
        </div>
        <div id="custdevList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- User Feedback Section -->
      <div class="card mt-6">
        <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg">💬 Foydalanuvchi feedbacklari</h3>
            <p class="text-sm text-gray-400">Bepul darslar haqida fikrlar</p>
          </div>
          <div class="flex flex-wrap gap-2 w-full sm:w-auto">
            <select id="feedbackFilter" class="input py-2 px-3 w-full sm:w-auto text-sm" onchange="filterFeedback()">
              <option value="all">Barchasi</option>
              <option value="liked">👍 Yoqdi</option>
              <option value="not_liked">👎 Yoqmadi</option>
              <option value="disliked_reason">📝 Sabablar</option>
            </select>
            <button onclick="loadFeedback()" class="btn btn-secondary text-sm w-full sm:w-auto">🔄 Yangilash</button>
          </div>
        </div>

        <!-- Feedback Stats -->
        <div class="grid grid-cols-3 gap-4 p-5 border-b border-gray-100 bg-gray-50">
          <div class="text-center">
            <p class="text-2xl font-bold text-green-600" id="feedbackLikedCount">0</p>
            <p class="text-xs text-gray-500">👍 Yoqdi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-red-600" id="feedbackDislikedCount">0</p>
            <p class="text-xs text-gray-500">👎 Yoqmadi</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-indigo-600" id="feedbackTotalCount">0</p>
            <p class="text-xs text-gray-500">Jami</p>
          </div>
        </div>

        <!-- Feedback List -->
        <div id="feedbackList" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-renewal" class="hidden">
      <div class="card p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h3 class="font-semibold text-gray-800">🔁 Uzaytirish eslatmalari</h3>
            <p class="text-sm text-gray-500">10/5/3/1 kun qolganda yuboriladigan matnlar. To'lov summalari xabarda tugmalar orqali avtomatik chiqadi.</p>
          </div>
          <button onclick="loadRenewalSettings()" class="btn btn-secondary btn-sm">🔄 Yangilash</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">10 kun oldin</label>
            <textarea id="renewalReminder10d" class="input h-28 resize-none" placeholder="10 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">5 kun oldin</label>
            <textarea id="renewalReminder5d" class="input h-28 resize-none" placeholder="5 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">3 kun oldin</label>
            <textarea id="renewalReminder3d" class="input h-28 resize-none" placeholder="3 kun oldin yuboriladigan xabar"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">1 kun oldin</label>
            <textarea id="renewalReminder1d" class="input h-28 resize-none" placeholder="1 kun oldin yuboriladigan xabar"></textarea>
          </div>
        </div>

        <div class="mt-4">
          <label class="text-sm text-gray-600 mb-1 block">Obuna tugagandan keyin</label>
          <textarea id="renewalReminderExpired" class="input h-28 resize-none" placeholder="Obuna tugagandan keyingi xabar"></textarea>
        </div>

        <button onclick="saveRenewalSettings()" class="btn btn-primary mt-5">💾 Uzaytirish sozlamalarini saqlash</button>
      </div>
    </div>

    <!-- Promo Codes Tab -->
    <div id="tab-promo" class="hidden">
      <div class="card p-5 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-gray-800">🎟️ Promo kodlar</h3>
          <button onclick="showCreatePromoModal()" class="btn btn-primary btn-sm">+ Yangi kod</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">Kod</th>
                <th class="pb-3">Chegirma</th>
                <th class="pb-3">Ishlatilgan</th>
                <th class="pb-3">Limit</th>
                <th class="pb-3">Amal qilish</th>
                <th class="pb-3">Holat</th>
                <th class="pb-3"></th>
              </tr>
            </thead>
            <tbody id="promoCodesTable">
              <tr><td colspan="7" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Create Promo Modal -->
    <div id="promoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
        <h3 class="font-semibold text-lg mb-4">🎟️ Yangi promo kod</h3>
        <div class="flex items-center gap-2 mb-4 text-xs">
          <span id="promoStepDot1" class="saved-view-chip active">1. Asosiy</span>
          <span id="promoStepDot2" class="saved-view-chip">2. Qo'shimcha</span>
        </div>

        <div id="promoStep1" class="space-y-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Kod *</label>
            <input type="text" id="promoCode" class="input uppercase" placeholder="YANGIOBUNA50" maxlength="20">
          </div>

          <div>
            <label class="text-sm text-gray-600 mb-1 block">Chegirma foizi *</label>
            <input type="number" id="promoDiscount" class="input" placeholder="50" min="1" max="100">
          </div>
        </div>

        <div id="promoStep2" class="space-y-4 hidden">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Maksimal ishlatish soni (bo'sh = cheksiz)</label>
            <input type="number" id="promoMaxUses" class="input" placeholder="100" min="1">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Boshlanish sanasi</label>
              <input type="date" id="promoValidFrom" class="input">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Tugash sanasi</label>
              <input type="date" id="promoValidUntil" class="input">
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-600 mb-1 block">Minimal tarif</label>
            <select id="promoMinPlan" class="input">
              <option value="">Barcha tariflar</option>
              <option value="1month">1 oylik</option>
              <option value="3month">3 oylik</option>
              <option value="6month">6 oylik</option>
              <option value="1year">12 oylik</option>
            </select>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="closePromoModal()" class="btn btn-secondary flex-1">Bekor qilish</button>
          <button id="promoBackBtn" onclick="setPromoWizardStep(1)" class="btn btn-secondary flex-1 hidden">Orqaga</button>
          <button id="promoNextBtn" onclick="setPromoWizardStep(2)" class="btn btn-secondary flex-1">Keyingi</button>
          <button id="promoCreateBtn" onclick="createPromoCode()" class="btn btn-primary flex-1 hidden">Yaratish</button>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics" class="hidden ref-analytics">
      <div class="sf-shell">
        <div class="sf-topbar">
          <div class="sf-brand">✶ funnelforce</div>
          <div class="sf-top-pills">
            <span class="sf-pill" onclick="showTab('overview')" style="cursor:pointer">Overview</span>
            <span class="sf-pill active">Analitika</span>
            <span class="sf-pill" onclick="showTab('payments')" style="cursor:pointer">To'lovlar</span>
            <span class="sf-pill" onclick="showTab('users')" style="cursor:pointer">Userlar</span>
          </div>
          <div class="sf-actions">
            <button id="analyticsPeriod7" onclick="setAnalyticsPeriod(7)" class="sf-mini-btn">7 kun</button>
            <button id="analyticsPeriod30" onclick="setAnalyticsPeriod(30)" class="sf-mini-btn">30 kun</button>
            <button id="analyticsViewToggle" onclick="toggleAnalyticsView()" class="sf-main-btn">Batafsil</button>
          </div>
        </div>

        <div class="sf-header-row">
          <h2 class="sf-title">Analitika</h2>
          <div class="flex items-center gap-2">
            <button id="diagActionHighIntentBtn" class="sf-main-btn light" onclick="prepareHighIntentBroadcast()" disabled>High-intent follow-up</button>
            <button id="diagActionStuckBtn" class="sf-main-btn" onclick="prepareStuckPaymentsBroadcast()" disabled>Stuck follow-up</button>
          </div>
        </div>

        <div class="sf-summary">
          <div class="sf-stat">
            <div class="k">Umumiy CR</div>
            <div class="v" id="diagOverallCR">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Eng katta yo'qotish</div>
            <div class="v sm" id="diagBiggestDrop">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Pitch -> Checkout</div>
            <div class="v" id="payDiagPitchToCheckout">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Checkout -> Prepare</div>
            <div class="v" id="payDiagCheckoutToPrepared">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Prepare -> Complete</div>
            <div class="v" id="payDiagPreparedToCompleted">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Pitchdan checkoutsiz</div>
            <div class="v" id="diagStuckUsers">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Stuck to'lovlar</div>
            <div class="v" id="payDiagStuckCount">-</div>
          </div>
          <div class="sf-stat">
            <div class="k">Asosiy action</div>
            <div class="v sm" id="diagNextAction">-</div>
          </div>
        </div>

        <div class="sf-filter-row">
          <div class="sf-filter-label">Active filters</div>
          <div class="sf-chip" onclick="scrollToAnalyticsSection('analyticsCRHeatmap')" style="cursor:pointer">Manba CR</div>
          <div class="sf-chip" onclick="scrollToAnalyticsSection('segmentLessonList')" style="cursor:pointer">Dars CR</div>
          <div class="sf-chip" onclick="scrollToAnalyticsSection('segmentActivityList')" style="cursor:pointer">Aktivlik CR</div>
          <div class="sf-chip" onclick="scrollToAnalyticsSection('highIntentTable')" style="cursor:pointer">High intent</div>
          <span class="sf-legend-badge" title="CR = to'lov qilgan / jami user × 100%">
            <span class="sf-legend-dot" style="background:#22c55e"></span>CR
          </span>
          <span class="sf-legend-badge" title="Prev = joriy bosqich / oldingi bosqich × 100%">
            <span class="sf-legend-dot" style="background:#f59e0b"></span>Prev
          </span>
          <span class="sf-legend-badge" title="Start = joriy bosqich / jami ro'yxatdan o'tgan × 100%">
            <span class="sf-legend-dot" style="background:#6366f1"></span>Start
          </span>
        </div>

        <!-- MEGA FUNNEL VISUALIZATION -->
        <div class="analytics-mega-funnel" id="analyticsMegaFunnel">
          <div class="analytics-mega-funnel-title">
            <span>📊</span> Sotish Voronkasi — Foydalanuvchi Yo'li
          </div>
          <div class="analytics-funnel-stages">
            <div class="analytics-funnel-stage">
              <div class="analytics-funnel-bar">
                <span class="analytics-funnel-value" id="afTotalUsers">0</span>
                <span class="analytics-funnel-percent">100%</span>
              </div>
              <span class="analytics-funnel-dropoff" id="afDropoff1">-0%</span>
              <p class="analytics-funnel-label">Jami Userlar</p>
            </div>
            <div class="analytics-funnel-stage">
              <div class="analytics-funnel-bar">
                <span class="analytics-funnel-value" id="afActiveUsers">0</span>
                <span class="analytics-funnel-percent" id="afActivePercent">0%</span>
              </div>
              <span class="analytics-funnel-dropoff" id="afDropoff2">-0%</span>
              <p class="analytics-funnel-label">Faol Userlar</p>
            </div>
            <div class="analytics-funnel-stage">
              <div class="analytics-funnel-bar">
                <span class="analytics-funnel-value" id="afPitchViewed">0</span>
                <span class="analytics-funnel-percent" id="afPitchPercent">0%</span>
              </div>
              <span class="analytics-funnel-dropoff" id="afDropoff3">-0%</span>
              <p class="analytics-funnel-label">Pitch Ko'rgan</p>
            </div>
            <div class="analytics-funnel-stage">
              <div class="analytics-funnel-bar">
                <span class="analytics-funnel-value" id="afCheckout">0</span>
                <span class="analytics-funnel-percent" id="afCheckoutPercent">0%</span>
              </div>
              <span class="analytics-funnel-dropoff" id="afDropoff4">-0%</span>
              <p class="analytics-funnel-label">Checkout Ochgan</p>
            </div>
            <div class="analytics-funnel-stage">
              <div class="analytics-funnel-bar">
                <span class="analytics-funnel-value" id="afPaidUsers">0</span>
                <span class="analytics-funnel-percent" id="afPaidPercent">0%</span>
              </div>
              <p class="analytics-funnel-label">Pullik Userlar</p>
            </div>
          </div>
        </div>

        <!-- AI INSIGHTS PANEL -->
        <div class="analytics-insights" id="analyticsInsights">
          <div class="analytics-insights-header">
            <div class="analytics-insights-title">
              <span>🤖</span> AI Tavsiyalar
            </div>
            <button onclick="refreshAnalyticsInsights()" class="sf-mini-btn">Yangilash</button>
          </div>
          <div id="analyticsInsightsContainer">
            <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- CR HEATMAP TABLE -->
        <div class="analytics-heatmap" id="analyticsCRHeatmap">
          <div class="analytics-heatmap-header">📈 Manba bo'yicha Konversiya Heatmap</div>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Manba</th>
                  <th style="text-align: center;">Userlar</th>
                  <th style="text-align: center;">→ Faol</th>
                  <th style="text-align: center;">→ Pitch</th>
                  <th style="text-align: center;">→ Checkout</th>
                  <th style="text-align: center;">→ Pullik</th>
                  <th style="text-align: center;">Umumiy CR</th>
                </tr>
              </thead>
              <tbody id="analyticsCRHeatmapBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 20px; color: #7b788a;">
                    Yuklanmoqda...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="sf-workspace">
          <div class="sf-left">
            <div class="sf-left-head">
              <div class="sf-left-title">High-intent userlar</div>
              <div class="diag-chip" id="highIntentCount">0 ta</div>
            </div>
            <div class="diag-table-scroll sf-dark-scroll">
              <table class="w-full text-sm responsive-table">
                <thead>
                  <tr>
                    <th class="py-2">User</th>
                    <th class="py-2">Dars</th>
                    <th class="py-2">Signal</th>
                    <th class="py-2">Oxirgi aktivlik</th>
                    <th class="py-2">Harakatlar</th>
                  </tr>
                </thead>
                <tbody id="highIntentTable">
                  <tr><td colspan="4" class="py-3 text-center text-gray-400">Yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="sf-right">
            <div class="sf-detail-card">
              <div class="sf-detail-grid">
                <div>
                  <div class="sf-label">Bosqichlar oqimi</div>
                  <div class="diag-chart-wrap"><canvas id="diagFunnelChart"></canvas></div>
                </div>
                <div>
                  <div class="sf-label">Segmentlar taqqoslanishi</div>
                  <div class="diag-chart-wrap"><canvas id="segmentMixChart"></canvas></div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
                <div class="sf-mini-list">
                  <div class="sf-label">Manba bo'yicha CR</div>
                  <div id="segmentSourceList" class="space-y-1 text-sm text-gray-500">Yuklanmoqda...</div>
                </div>
                <div class="sf-mini-list">
                  <div class="sf-label">Dars bo'yicha CR</div>
                  <div id="segmentLessonList" class="space-y-1 text-sm text-gray-500">Yuklanmoqda...</div>
                </div>
                <div class="sf-mini-list">
                  <div class="sf-label">Aktivlik bo'yicha CR</div>
                  <div id="segmentActivityList" class="space-y-1 text-sm text-gray-500">Yuklanmoqda...</div>
                </div>
              </div>

              <div class="diag-table-scroll mt-4">
                <table class="w-full text-sm responsive-table">
                  <thead>
                    <tr class="text-left text-gray-500 border-b">
                      <th class="pb-2 px-3">Bosqich</th>
                      <th class="pb-2 px-3">User</th>
                      <th class="pb-2 px-3">Prev dan</th>
                      <th class="pb-2 px-3">Start dan</th>
                      <th class="pb-2 px-3">Izoh</th>
                    </tr>
                  </thead>
                  <tbody id="diagFunnelTable">
                    <tr><td colspan="5" class="py-3 text-center text-gray-400">Yuklanmoqda...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="sf-payment-row">
              <div class="sf-payment-card">
                <div class="sf-label">To'lov usuli bo'yicha conversion</div>
                <div class="diag-chart-wrap mb-3"><canvas id="payMethodChart"></canvas></div>
                <div id="payDiagMethods" class="space-y-1 text-sm text-gray-500">Yuklanmoqda...</div>
              </div>
              <div class="sf-payment-card">
                <div class="sf-label">Asosiy tavsiya</div>
                <div id="payDiagNextAction" class="text-sm text-gray-700 mb-3">Yuklanmoqda...</div>
                <div class="diag-table-scroll">
                  <table class="w-full text-sm responsive-table">
                    <thead>
                      <tr class="text-left text-gray-500 border-b">
                        <th class="py-2 px-3">User</th>
                        <th class="py-2 px-3">Buyurtma</th>
                        <th class="py-2 px-3">Holat</th>
                        <th class="py-2 px-3">Usul</th>
                        <th class="py-2 px-3">Qachondan beri</th>
                      </tr>
                    </thead>
                    <tbody id="payDiagStuckTable">
                      <tr><td colspan="5" class="py-3 text-center text-gray-400">Yuklanmoqda...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="diagAlerts" class="space-y-2 analytics-advanced">
          <div class="text-sm text-gray-400">Diagnostika yuklanmoqda...</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 analytics-advanced">
          <div class="card p-5">
            <h3 class="font-semibold text-gray-800 mb-4">💰 Daromad (<span id="analyticsRevenuePeriodLabel">so'nggi 30 kun</span>)</h3>
            <div class="chart-container"><canvas id="analyticsRevenueChart"></canvas></div>
          </div>
          <div class="card p-5">
            <h3 class="font-semibold text-gray-800 mb-4">📈 Obunalar o'sishi (<span id="analyticsSubsPeriodLabel">so'nggi 30 kun</span>)</h3>
            <div class="chart-container"><canvas id="analyticsSubscribersChart"></canvas></div>
          </div>
        </div>

        <div class="card p-5 analytics-advanced">
          <h3 class="font-semibold text-gray-800 mb-4">🌐 Trafik manbalari</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <canvas id="sourcesPieChart" height="250"></canvas>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-500 border-b">
                    <th class="pb-3">Manba</th>
                    <th class="pb-3">Userlar</th>
                    <th class="pb-3">To'lagan</th>
                    <th class="pb-3">Konversiya</th>
                  </tr>
                </thead>
                <tbody id="sourcesTable">
                  <tr><td colspan="4" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card p-5 analytics-advanced">
          <h3 class="font-semibold text-gray-800 mb-4">🛒 Xaridor statistikasi</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center p-4 bg-blue-50 rounded-xl">
              <div class="text-2xl font-bold text-blue-600" id="buyerAvgLesson">-</div>
              <div class="text-xs text-gray-500">Jami xaridorlar</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-xl">
              <div class="text-2xl font-bold text-green-600" id="buyerAvgDays">-</div>
              <div class="text-xs text-gray-500">O'rtacha kun (sotib olish)</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-xl">
              <div class="text-2xl font-bold text-purple-600" id="buyerConversion">-</div>
              <div class="text-xs text-gray-500">Konversiya</div>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-xl">
              <div class="text-2xl font-bold text-orange-600" id="buyerAvgCheck">-</div>
              <div class="text-xs text-gray-500">Eng tez xarid</div>
            </div>
          </div>
          <p class="text-xs text-gray-400 mb-2">Xaridorlar yosh guruhi bo'yicha:</p>
          <div class="chart-container h-[150px]"><canvas id="buyerFunnelChart"></canvas></div>
        </div>

        <div class="card p-5 analytics-advanced">
          <h3 class="font-semibold text-gray-800 mb-4">⏰ Faolsizlik eslatmalari</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-xl">
              <div class="text-2xl font-bold text-gray-700" id="inactTotalDeliveries">-</div>
              <div class="text-xs text-gray-500">Yuborilgan darslar</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-xl">
              <div class="text-2xl font-bold text-green-600" id="inactWatched">-</div>
              <div class="text-xs text-gray-500">Ko'rilgan</div>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded-xl">
              <div class="text-2xl font-bold text-yellow-600" id="inactReminder1">-</div>
              <div class="text-xs text-gray-500">1-eslatma</div>
            </div>
            <div class="text-center p-4 bg-orange-50 rounded-xl">
              <div class="text-2xl font-bold text-orange-600" id="inactReminder2">-</div>
              <div class="text-xs text-gray-500">2-eslatma</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-xl">
              <div class="text-2xl font-bold text-blue-600" id="inactWatchedAfter">-</div>
              <div class="text-xs text-gray-500">Eslatmadan keyin</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Referrals Tab -->
    <div id="tab-referrals" class="hidden">
      <!-- Referral Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-blue-600" id="refTotalReferrals">-</div>
          <div class="text-sm text-gray-500">Jami referallar</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-green-600" id="refQualified">-</div>
          <div class="text-sm text-gray-500">Faol (qualified)</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-purple-600" id="refDiscountsUsed">-</div>
          <div class="text-sm text-gray-500">Chegirma olgan</div>
        </div>
        <div class="card p-5 text-center">
          <div class="text-3xl font-bold text-orange-600" id="refActiveReferrers">-</div>
          <div class="text-sm text-gray-500">Faol referrerlar</div>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card p-5 mb-6">
        <h3 class="font-semibold text-gray-800 mb-4">🏆 Top Referrerlar</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">#</th>
                <th class="pb-3">Foydalanuvchi</th>
                <th class="pb-3">Taklif qilgan</th>
                <th class="pb-3">Chegirma</th>
              </tr>
            </thead>
            <tbody id="referralLeaderboard">
              <tr><td colspan="4" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invite Links -->
      <div class="card p-5">
        <h3 class="font-semibold text-gray-800 mb-4">🔗 Taklifnoma linklari</h3>
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="text-center p-3 bg-blue-50 rounded-xl">
            <div class="text-xl font-bold text-blue-600" id="inviteTotal">-</div>
            <div class="text-xs text-gray-500">Jami yaratilgan</div>
          </div>
          <div class="text-center p-3 bg-green-50 rounded-xl">
            <div class="text-xl font-bold text-green-600" id="inviteUsed">-</div>
            <div class="text-xs text-gray-500">Ishlatilgan</div>
          </div>
          <div class="text-center p-3 bg-gray-50 rounded-xl">
            <div class="text-xl font-bold text-gray-600" id="inviteUnused">-</div>
            <div class="text-xs text-gray-500">Ishlatilmagan</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Log Tab -->
    <div id="tab-audit" class="hidden">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
          <h3 class="font-semibold text-gray-800">📋 Audit Log (Tekshiruv jurnali)</h3>
          <div class="flex gap-2 flex-wrap">
            <select id="auditActionFilter" class="input w-40" onchange="loadAuditLogs()">
              <option value="">Barcha harakatlar</option>
              <option value="PAYMENT_COMPLETED">To'lovlar</option>
              <option value="USER_CREATED">Yangi userlar</option>
              <option value="SETTINGS_CHANGED">Sozlamalar</option>
              <option value="SECURITY_">Xavfsizlik</option>
            </select>
            <input type="date" id="auditDateFilter" class="input w-40" onchange="loadAuditLogs()">
            <button onclick="exportAuditLogs()" class="btn btn-secondary btn-sm">📥 Export</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-3">Vaqt</th>
                <th class="pb-3">Harakat</th>
                <th class="pb-3">Foydalanuvchi</th>
                <th class="pb-3">Maqsad</th>
                <th class="pb-3">Tafsilotlar</th>
              </tr>
            </thead>
            <tbody id="auditLogsTable">
              <tr><td colspan="5" class="py-4 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="flex justify-center mt-4 gap-2">
          <button onclick="loadAuditLogs(auditOffset - 50)" class="btn btn-secondary btn-sm" id="auditPrevBtn" disabled>← Oldingi</button>
          <span class="px-4 py-2 text-sm text-gray-500" id="auditPageInfo">1-50</span>
          <button onclick="loadAuditLogs(auditOffset + 50)" class="btn btn-secondary btn-sm" id="auditNextBtn">Keyingi →</button>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Channel Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">📢 Kanal sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Premium kanal ID</label>
              <input type="text" id="settingPremiumChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal ID</label>
              <input type="text" id="settingFreeChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal linki</label>
              <input type="text" id="settingFreeChannelLink" class="input" placeholder="https://t.me/channel">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Obuna so'raladigan darsdan keyin (0 = talab qilinmaydi)</label>
              <input type="number" id="settingRequireSub" class="input" value="0" min="0">
            </div>
          </div>

          <!-- Subscription bypass settings -->
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" id="settingSubBypassEnabled" class="w-4 h-4 rounded">
              <label class="text-sm text-gray-700">Obuna tekshiruvi o'tkazib yuborish</label>
            </div>
            <p class="text-xs text-gray-500 mb-3">Agar foydalanuvchi bir necha marta urinib ko'rsa va o'xshamasa, keyingi darsga o'tkazib yuborish</p>
            <div class="flex items-center gap-2">
              <input type="number" id="settingSubBypassAttempts" class="input w-20" value="3" min="1" max="10">
              <span class="text-sm text-gray-600">ta urinishdan keyin o'tkazish</span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">💰 Narxlar (so'm)</h3>
          <p class="text-xs text-gray-500 mb-4">1 oylik narxni kiriting - 3/6/12 oylik avtomatik chegirma bilan hisoblanadi</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1 oylik <span class="text-blue-600 font-medium">(asosiy)</span></label>
              <input type="number" id="settingPrice1m" class="input" placeholder="97000" oninput="calculateDiscountedPrices()">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">3 oylik <span class="text-green-600 font-medium">(-10%)</span></label>
              <input type="number" id="settingPrice3m" class="input bg-gray-100" placeholder="247000" readonly>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">6 oylik <span class="text-green-600 font-medium">(-25%)</span></label>
              <input type="number" id="settingPrice6m" class="input bg-gray-100" placeholder="447000" readonly>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">12 oylik <span class="text-green-600 font-medium">(-40%)</span></label>
              <input type="number" id="settingPrice12m" class="input bg-gray-100" placeholder="797000" readonly>
            </div>
          </div>
        </div>

        <!-- Payment Systems -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">💳 To'lov tizimlari</h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingPayme" class="w-5 h-5 accent-blue-600">
              <span class="text-lg">💳</span>
              <span class="font-medium">Payme</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingClick" class="w-5 h-5 accent-green-600">
              <span class="text-lg">💠</span>
              <span class="font-medium">Click</span>
            </label>
          </div>
        </div>

        <!-- Inactivity Reminders -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">⏰ Dars eslatmalari</h3>
          <p class="text-xs text-gray-500 mb-4">Darsni ko'rmagan userlarga avtomatik eslatma yuborish</p>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingInactivityEnabled" class="w-5 h-5 accent-orange-600">
              <span class="font-medium">Eslatmalarni yoqish</span>
            </label>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1-eslatma matni (1 soatdan keyin)</label>
              <textarea id="settingInactivityReminder1" class="input min-h-[60px]" placeholder="Hey! Darsni hali ko'rmadingizmi?"></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">2-eslatma matni (3 soatdan keyin)</label>
              <textarea id="settingInactivityReminder2" class="input min-h-[60px]" placeholder="Dars sizni kutmoqda!"></textarea>
            </div>
          </div>
        </div>

        <!-- Referral System -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">🔗 Referal tizimi</h3>
          <p class="text-xs text-gray-500 mb-4">Userlar do'stlarini taklif qilib chegirma olishlari mumkin</p>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingReferralEnabled" class="w-5 h-5 accent-green-600">
              <span class="font-medium">Referal tizimini yoqish</span>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">Kerakli referallar soni</label>
                <input type="number" id="settingReferralCount" class="input" value="3" min="1">
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">Chegirma foizi (%)</label>
                <input type="number" id="settingReferralDiscount" class="input" value="50" min="1" max="100">
              </div>
            </div>

            <!-- Referral Offer (24h after sales pitch) -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">📬 Referal taklif xabari (to'lov qilmaganlarga)</h4>
              <p class="text-xs text-gray-500 mb-3">User to'lov sahifasini ko'rganidan keyin bir muncha vaqt o'tsa, maxsus referal taklif xabari yuboriladi</p>

              <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 mb-3">
                <input type="checkbox" id="settingReferralOfferEnabled" class="w-5 h-5 accent-green-600">
                <span class="font-medium">Referal taklif xabarini yoqish</span>
              </label>

              <div class="mb-3">
                <label class="text-sm text-gray-600 mb-1 block">Necha soatdan keyin yuborish</label>
                <input type="number" id="settingReferralOfferDelay" class="input" value="24" min="1" max="168">
                <p class="text-xs text-gray-400 mt-1">Masalan: 24 = to'lov sahifasidan 24 soat o'tgach</p>
              </div>

              <div>
                <label class="text-sm text-gray-600 mb-1 block">Taklif xabari matni</label>
                <textarea id="settingReferralOfferMessage" class="input" rows="4" placeholder="Xabar matnini kiriting...">🎁 <b>Sizga maxsus taklif!</b>

Hozirgi tariflarni <b>{{chegirma}}% chegirmada</b> olishingiz mumkin!

Buning uchun <b>{{kerakli_odam}} ta do'stingizni</b> referal havolangiz orqali chaqiring.

Ular birinchi darsni ko'rishni boshlashganda siz chegirmaga ega bo'lasiz! 🎉</textarea>
                <p class="text-xs text-gray-400 mt-1">O'zgaruvchilar: {{ism}}, {{chegirma}}, {{kerakli_odam}}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin Info -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">👤 Admin</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Admin Telegram ID</label>
              <input type="text" id="settingAdminId" class="input font-mono" placeholder="123456789">
            </div>
          </div>
        </div>

      </div>

      <button onclick="saveSettings()" class="btn btn-primary mt-6 w-full lg:w-auto">💾 Sozlamalarni saqlash</button>
    </div>

  </main>

  <!-- Right Panel (Desktop only) -->
  <aside class="right-panel hidden lg:block w-80 p-6 border-l border-gray-100 bg-gradient-to-b from-white to-gray-50/50">

    <!-- Stats Card -->
    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 rounded-2xl p-5 text-white mb-6 shadow-lg shadow-indigo-500/25 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <p class="text-white/80 text-sm mb-1 relative font-medium">💰 Umumiy daromad</p>
      <p class="text-3xl font-bold mb-4 relative text-white" id="rightPanelRevenue">0 so'm</p>
      <div class="flex justify-between text-sm relative">
        <span class="text-white/70">📅 Bu oy</span>
        <span class="font-semibold bg-white/20 px-2 py-0.5 rounded-full" id="rightPanelMonthRevenue">0</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-800">⚡ So'nggi faoliyat</h3>
        <span class="text-xs text-indigo-500 font-medium">Live</span>
      </div>
      <div id="recentActivity" class="space-y-2 max-h-64 overflow-y-auto">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Lesson Funnel -->
    <div class="bg-gradient-to-br from-gray-50 to-indigo-50/30 rounded-xl p-4 -mx-2">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-sm">📊</span>
        Darslar funneli
      </h3>
      <div id="lessonProgressPanel" class="funnel-container">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

  </aside>

</div>

<!-- Source Link Generator Modal -->
<div id="sourceLinkModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6 max-w-md w-full">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">🔗 Trafik linki yaratish</h3>
      <button onclick="closeModal('sourceLinkModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">✕</button>
    </div>

    <div class="space-y-4">
      <!-- Quick Source Buttons -->
      <div>
        <label class="text-sm font-medium text-gray-700 mb-2 block">Tezkor tanlash:</label>
        <div class="flex flex-wrap gap-2">
          <button onclick="setSourceName('instagram')" class="px-3 py-1.5 text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90">📸 Instagram</button>
          <button onclick="setSourceName('telegram')" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:opacity-90">📱 Telegram</button>
          <button onclick="setSourceName('facebook')" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:opacity-90">👤 Facebook</button>
          <button onclick="setSourceName('youtube')" class="px-3 py-1.5 text-sm bg-red-500 text-white rounded-lg hover:opacity-90">🎬 YouTube</button>
          <button onclick="setSourceName('tiktok')" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded-lg hover:opacity-90">🎵 TikTok</button>
        </div>
      </div>

      <!-- Custom Source Input -->
      <div>
        <label class="text-sm font-medium text-gray-700 mb-2 block">Yoki o'zingiz yozing:</label>
        <input type="text" id="sourceNameInput" class="input" placeholder="Masalan: instagram, telegram_kanal, reklama1..." oninput="generateSourceLink()">
        <p class="text-xs text-gray-400 mt-1">Faqat lotin harflari, raqamlar va _ ishlatiladi</p>
      </div>

      <!-- Generated Link -->
      <div id="generatedLinkContainer" class="hidden">
        <label class="text-sm font-medium text-gray-700 mb-2 block">Tayyor havola:</label>
        <div class="flex gap-2">
          <input type="text" id="generatedSourceLink" class="input font-mono text-sm flex-1" readonly>
          <button onclick="copySourceLink()" class="btn btn-primary px-4">📋</button>
        </div>
        <p class="text-xs text-green-600 mt-2" id="sourceLinkCopied" style="display:none">✓ Nusxalandi!</p>
      </div>

      <!-- Instructions -->
      <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
        <p class="font-medium mb-2">📝 Qanday ishlaydi:</p>
        <ol class="list-decimal list-inside space-y-1 text-xs">
          <li>Manba nomini tanlang yoki yozing</li>
          <li>Havolani nusxalang</li>
          <li>Reklama yoki postda shu havolani qo'ying</li>
          <li>Dashboard'da statistikani kuzating</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Broadcast Modal (Advanced) -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6 max-h-[95vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">📨 Xabar yuborish</h3>
      <button onclick="closeModal('broadcastModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">✕</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Target & Variables -->
      <div class="space-y-4">
        <!-- Target Selection -->
        <div class="bg-gray-50 rounded-xl p-4">
          <label class="text-sm font-medium text-gray-700 mb-2 block">📍 Kimga yuborish</label>
          <select id="broadcastTarget" class="input" onchange="toggleUserSelect(); updateRecipientCount()">
            <option value="all">Hammaga</option>
            <option value="paid">To'laganlarga (Premium)</option>
            <option value="free">To'lamaganlarga (Free)</option>
            <option value="active">Aktiv foydalanuvchilarga</option>
            <option value="lesson">Muayyan darsda bo'lganlarga</option>
            <option value="specific">Tanlangan foydalanuvchilarga</option>
          </select>

          <!-- Lesson Range (for lesson target) -->
          <div id="lessonRangeDiv" class="hidden mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500">Dars (dan)</label>
              <input type="number" id="broadcastLessonFrom" class="input py-2" min="0" value="1" onchange="updateRecipientCount()">
            </div>
            <div>
              <label class="text-xs text-gray-500">Dars (gacha)</label>
              <input type="number" id="broadcastLessonTo" class="input py-2" min="0" value="4" onchange="updateRecipientCount()">
            </div>
          </div>

          <!-- User Search (for specific) -->
          <div id="userSelectDiv" class="hidden mt-3">
            <input type="text" id="broadcastUserSearch" class="input mb-2" placeholder="🔍 Ism yoki telefon..." oninput="searchBroadcastUsers()">
            <div id="broadcastUsersList" class="max-h-32 overflow-y-auto border rounded-lg p-2 space-y-1 bg-white"></div>
            <div class="mt-2">
              <p class="text-xs text-gray-500">Tanlangan: <span id="selectedUsersCount" class="font-medium text-indigo-600">0</span> ta</p>
              <div id="selectedUsersList" class="flex flex-wrap gap-1 mt-1"></div>
            </div>
          </div>

          <!-- Recipient Count -->
          <div class="mt-3 p-3 bg-indigo-50 rounded-lg">
            <p class="text-sm text-indigo-700">
              <span class="font-semibold" id="recipientCount">0</span> ta foydalanuvchiga yuboriladi
            </p>
          </div>
        </div>

        <!-- Variables Help -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-4 border border-amber-100">
          <label class="text-sm font-medium text-amber-800 mb-2 block">🔤 O'zgaruvchilar (bosib qo'shing)</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" onclick="insertVariable('{{ism}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{ism}}</button>
            <button type="button" onclick="insertVariable('{{fio}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{fio}}</button>
            <button type="button" onclick="insertVariable('{{telefon}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{telefon}}</button>
            <button type="button" onclick="insertVariable('{{dars}}')" class="px-3 py-1.5 bg-white rounded-lg text-xs font-medium text-amber-700 border border-amber-200 hover:bg-amber-100 transition-colors">{{dars}}</button>
          </div>
          <div class="mt-3 text-xs text-amber-600 space-y-1">
            <p><code class="bg-white px-1 rounded">{{ism}}</code> - Foydalanuvchi ismi</p>
            <p><code class="bg-white px-1 rounded">{{fio}}</code> - To'liq ism</p>
            <p><code class="bg-white px-1 rounded">{{telefon}}</code> - Telefon raqami</p>
            <p><code class="bg-white px-1 rounded">{{dars}}</code> - Hozirgi dars raqami</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Message Content -->
      <div class="space-y-4">
        <!-- Message Type -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">📎 Xabar turi</label>
          <select id="broadcastType" class="input" onchange="toggleBroadcastMedia()">
            <option value="text">📝 Faqat matn</option>
            <option value="photo">🖼️ Rasm + Matn</option>
            <option value="video">🎬 Video + Matn</option>
            <option value="video_note">🔵 Video xabar (dumaloq)</option>
            <option value="voice">🎤 Ovozli xabar</option>
            <option value="audio">🎵 Audio fayl</option>
            <option value="document">📄 Hujjat</option>
          </select>
        </div>

        <!-- Media File ID -->
        <div id="broadcastMediaDiv" class="hidden">
          <label class="text-sm font-medium text-gray-700 mb-2 block">🔗 Media File ID</label>
          <input type="text" id="broadcastMediaId" class="input file-id-input" placeholder="File ID ni kiriting...">
          <p class="text-xs text-gray-400 mt-1">💡 Botga media yuboring - avtomatik ID olasiz</p>
        </div>

        <!-- Message Text -->
        <div>
          <label class="text-sm font-medium text-gray-700 mb-2 block">✏️ Xabar matni</label>
          <div class="flex flex-wrap gap-1 mb-2">
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('b')"><b>B</b></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('i')"><i>I</i></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('u')"><u>U</u></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('s')"><s>S</s></button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('spoiler')">🙈 Spoiler</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('blockquote')">❝ Quote</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('blockquote_expand')">📖 Expand Quote</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('code')">{ }</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('link')">🔗 Link</button>
            <button class="btn btn-secondary btn-sm" type="button" onclick="applyBroadcastFormat('emoji')">✨ Emoji</button>
          </div>
          <textarea id="broadcastText" class="input h-36 resize-none" placeholder="Salom, {{ism}}! 👋&#10;&#10;Xabaringizni yozing..." oninput="updatePreview()"></textarea>
          <div class="flex justify-between mt-1">
            <p class="text-xs text-gray-400">HTML teglar: &lt;b&gt;, &lt;i&gt;, &lt;tg-spoiler&gt;, &lt;blockquote expandable&gt;, &lt;tg-emoji&gt;</p>
            <p class="text-xs text-gray-400"><span id="charCount">0</span> belgi</p>
          </div>
        </div>

        <!-- Buttons -->
        <div>
          <div class="flex items-center justify-between gap-2 mb-2">
            <label class="text-sm font-medium text-gray-700 block">🔘 Tugmalar (ixtiyoriy)</label>
            <button type="button" class="btn btn-secondary btn-sm" onclick="prefillPaymentButtons()">💳 To'lov tugmalarini qo'yish</button>
          </div>
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <input type="text" id="broadcastBtnText" class="input" placeholder="1-tugma matni (masalan: 💳 Payme)" oninput="updatePreview()">
              <input type="text" id="broadcastBtnUrl" class="input" placeholder="1-tugma URL ({{tg}} ishlatish mumkin)" oninput="updatePreview()">
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input type="text" id="broadcastBtn2Text" class="input" placeholder="2-tugma matni (masalan: 💠 Click)" oninput="updatePreview()">
              <input type="text" id="broadcastBtn2Url" class="input" placeholder="2-tugma URL ({{tg}} ishlatish mumkin)" oninput="updatePreview()">
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-1">Placeholderlar: {{tg}}, {{username}}, {{phone}}, {{ism}}, {{payme_checkout_url}}, {{click_checkout_url}}</p>
        </div>

        <!-- Preview -->
        <div class="bg-gray-900 rounded-xl p-4">
          <label class="text-xs font-medium text-gray-400 mb-2 block">👁 Oldindan ko'rish</label>
          <div id="broadcastPreview" class="bg-indigo-600/20 rounded-lg p-3 text-white text-sm">
            <p class="text-gray-300 italic">Xabar matni bu yerda ko'rinadi...</p>
          </div>
          <div id="previewButton" class="hidden mt-2 space-y-2">
            <div class="inline-block bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium">
              <span id="previewBtnText">Tugma 1</span>
            </div>
            <div id="previewButton2" class="hidden">
              <div class="inline-block bg-indigo-500/80 text-white px-4 py-2 rounded-lg text-sm font-medium">
                <span id="previewBtn2Text">Tugma 2</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-6 flex flex-col sm:flex-row gap-3">
      <button onclick="sendBroadcast()" class="btn btn-primary flex-1 flex items-center justify-center gap-2">
        <span>📤</span> Yuborish
      </button>
      <button onclick="previewBroadcast()" class="btn btn-secondary flex items-center justify-center gap-2">
        <span>👁</span> Test (o'zimga)
      </button>
      <button onclick="closeModal('broadcastModal')" class="btn btn-secondary">Bekor qilish</button>
    </div>

    <!-- Progress Indicator -->
    <div id="broadcastProgress" class="hidden mt-4">
      <div class="bg-gray-100 rounded-full h-2 overflow-hidden">
        <div id="broadcastProgressBar" class="bg-indigo-600 h-full transition-all duration-300" style="width: 0%"></div>
      </div>
      <p class="text-sm text-gray-500 mt-2 text-center">
        <span id="broadcastSent">0</span> / <span id="broadcastTotal">0</span> yuborildi
      </p>
    </div>
  </div>
</div>

<!-- Lesson Modal (with Media IDs) -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="lessonModalTitle">📚 Yangi dars</h3>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">✕</button>
    </div>
    <form id="lessonForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <input type="hidden" id="lessonId">

      <!-- Basic Info -->
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Dars raqami</label>
            <input type="number" id="lessonNumber" class="input" required min="1">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (soat)</label>
            <input type="number" id="lessonDelay" class="input" value="24" min="0">
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Sarlavha</label>
          <input type="text" id="lessonTitle" class="input" required>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Matn</label>
          <textarea id="lessonText" class="input h-40 resize-none"></textarea>
        </div>
      </div>

      <!-- Media IDs -->
      <div class="space-y-4">
        <div class="p-3 bg-blue-50 rounded-lg mb-4">
          <p class="text-sm text-blue-700">💡 Botga media yuboring - File ID oling. O'sha ID ni qo'ying.</p>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">🎬 Video File ID</label>
          <input type="text" id="lessonVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">🔵 Video xabar File ID (dumaloq)</label>
          <input type="text" id="lessonVideoNoteFileId" class="input file-id-input" placeholder="DQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">🎵 Audio File ID</label>
          <input type="text" id="lessonAudioFileId" class="input file-id-input" placeholder="CQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">📎 Fayl File ID</label>
          <input type="text" id="lessonDocumentFileId" class="input file-id-input" placeholder="BQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">🖼 Rasm File ID</label>
          <input type="text" id="lessonPhotoFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
        </div>
      </div>

      <div class="lg:col-span-2">
        <button type="submit" class="btn btn-primary w-full">💾 Saqlash</button>
      </div>
    </form>
  </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">👤 Foydalanuvchi ma'lumotlari</h3>
      <button onclick="closeModal('userDetailModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">✕</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- User Info -->
      <div>
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-2xl font-bold" id="userDetailAvatar">U</div>
          <div>
            <p class="text-xl font-bold text-gray-800" id="userDetailName">-</p>
            <p class="text-gray-500" id="userDetailUsername">-</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telegram ID</span>
            <span class="font-mono font-medium" id="userDetailTgId">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telefon</span>
            <span class="font-medium" id="userDetailPhone">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Hozirgi dars</span>
            <span class="badge badge-blue" id="userDetailLesson">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Status</span>
            <span id="userDetailStatus">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Ro'yxatdan o'tgan</span>
            <span class="font-medium" id="userDetailCreated">-</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-4 flex gap-2">
          <button onclick="sendMessageToUser()" class="btn btn-primary btn-sm flex-1">📨 Xabar yuborish</button>
        </div>
      </div>

      <!-- CustDev Answers -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">📝 CustDev javoblari</h4>
        <div id="userDetailCustdev" class="space-y-3">
          <p class="text-gray-400 text-center py-4">Javoblar yo'q</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Question Stats Modal -->
<div id="custdevStatsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevStatsTitle">📊 Savol statistikasi</h3>
      <button onclick="closeModal('custdevStatsModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">✕</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chart -->
      <div>
        <div class="chart-container h-[250px]">
          <canvas id="questionStatsChart"></canvas>
        </div>
      </div>

      <!-- Answers List -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">Javoblar ro'yxati</h4>
        <div id="questionAnswersList" class="max-h-[300px] overflow-y-auto space-y-2">
          <p class="text-gray-400">Yuklanmoqda...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevModalTitle">📝 Yangi savol</h3>
      <button onclick="closeModal('custdevModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">✕</button>
    </div>
    <form id="custdevForm" class="space-y-4">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
        <input type="number" id="custdevAfterLesson" class="input" value="1" min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
        <textarea id="custdevQuestion" class="input h-24 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Javob turi</label>
        <select id="custdevType" class="input" onchange="toggleCustdevOptions()">
          <option value="text">Matn (yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      <div id="custdevOptionsDiv" class="hidden">
        <label class="text-sm text-gray-600 mb-1 block">Variantlar (har qator - bitta)</label>
        <textarea id="custdevOptions" class="input h-24 resize-none font-mono" placeholder="18-25&#10;26-35&#10;36-45"></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Field nomi (statistika uchun)</label>
        <input type="text" id="custdevFieldName" class="input" placeholder="age, income, occupation...">
        <p class="text-xs text-gray-400 mt-1">Masalan: age, income, occupation, budget</p>
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<!-- Command Palette -->
<div id="commandPalette" class="cmd-overlay" onclick="closeCommandPalette(event)">
  <div class="cmd-modal" onclick="event.stopPropagation()">
    <div class="p-3 border-b border-gray-100">
      <input id="commandInput" class="input" placeholder="Buyruq qidiring... (tab, user, action)" oninput="renderCommandResults()" />
      <div class="text-xs text-gray-400 mt-2">Tablar, actionlar va user quick-open uchun. Enter bosib oching.</div>
    </div>
    <div id="commandResults" class="max-h-[52vh] overflow-y-auto">
      <div class="p-4 text-sm text-gray-400">Yozishni boshlang...</div>
    </div>
  </div>
</div>

<!-- Notifications -->
<aside id="notificationsPanel" class="notif-panel">
  <div class="p-3 border-b border-gray-100 flex items-center justify-between">
    <div class="font-semibold text-sm text-gray-700">Bildirishnomalar</div>
    <button class="btn btn-secondary btn-sm" onclick="clearNotifications()">Tozalash</button>
  </div>
  <div id="notificationsList" class="notif-list">
    <div class="p-3 text-xs text-gray-400">Hozircha bildirishnoma yo'q</div>
  </div>
</aside>

<!-- UX Quick Dock -->
<div id="uxQuickDock" class="ux-quick-dock" aria-label="Quick navigation">
  <button class="ux-dock-chip active" data-quick-tab="overview" onclick="showTab('overview')">Umumiy</button>
  <button class="ux-dock-chip" data-quick-tab="analytics" onclick="showTab('analytics')">Analitika</button>
  <button class="ux-dock-chip" data-quick-tab="users" onclick="showTab('users')">Userlar</button>
  <button class="ux-dock-chip" data-quick-tab="payments" onclick="showTab('payments')">To'lovlar</button>
  <button class="ux-dock-chip" onclick="openUxShortcutsHelp()">Qisqa tugmalar</button>
</div>

<!-- UX Shortcuts -->
<div id="uxShortcutsModal" class="ux-shortcuts-modal" onclick="closeUxShortcutsHelp(event)">
  <div class="ux-shortcuts-card" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-lg font-bold text-gray-800">Klaviatura qisqa tugmalari</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeUxShortcutsHelp()">Yopish</button>
    </div>
    <div class="ux-shortcut-row"><span>Global qidiruv</span><span class="ux-kbd">Ctrl/Cmd + K</span></div>
    <div class="ux-shortcut-row"><span>Umumiy tab</span><span class="ux-kbd">G O</span></div>
    <div class="ux-shortcut-row"><span>Users tab</span><span class="ux-kbd">G U</span></div>
    <div class="ux-shortcut-row"><span>Payments tab</span><span class="ux-kbd">G P</span></div>
    <div class="ux-shortcut-row"><span>Analytics tab</span><span class="ux-kbd">G A</span></div>
    <div class="ux-shortcut-row"><span>Yangilash</span><span class="ux-kbd">R</span></div>
    <div class="ux-shortcut-row"><span>Yordam</span><span class="ux-kbd">?</span></div>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let auth = '';
let tgInitData = '';
let allUsers = [];
let allPayments = [];
let allLessons = [];
let allCustDev = [];
let allFeedback = [];
let allConversations = [];
let customEmojiLibrary = [];
let unicodeEmojiLibrary = [];
let emojiLottieInstances = [];
const emojiTgsDataCache = new Map();
let selectedConversationUserId = null;
let selectedReplyToMessageId = null;
let selectedReplyToSnippet = '';
let activeProgrevEditorId = null;
let currentPage = 1;
const perPage = 20;
let paymentFilter = 'completed';
let selectedBroadcastUsers = new Set();
let custdevAnswers = {};
const uiTheme = 'light';
let tableDensity = localStorage.getItem('tableDensity') || 'comfortable';
let sidebarMoreOpen = false;
let currentUsersSavedView = localStorage.getItem('usersSavedView') || 'all';
const commandItems = [];
let notifications = [];
let pendingGoShortcut = null;
const selectedUsersOnPage = new Set();
const tabDataState = {};
let activeModalId = null;
let prevFocusedElement = null;
const analyticsCacheByPeriod = new Map();
let analyticsFetchInFlight = false;
let tableColumnPrefs = {
  users: JSON.parse(localStorage.getItem('tableColumnsUsers') || '{"user":true,"phone":true,"lesson":true,"status":true,"date":true,"actions":true}'),
  payments: JSON.parse(localStorage.getItem('tableColumnsPayments') || '{"date":true,"user":true,"amount":true,"plan":true,"status":true,"system":true,"premium":true,"actions":true}')
};
let lastDataRefresh = Date.now();

// ========== FORMATTERS (Unified Number/Date Formatting) ==========
const formatters = {
  money: (value, options = {}) => {
    const { compact = false, showCurrency = true } = options;
    if (value === null || value === undefined || value === '') return '—';
    const num = Number(value);
    if (isNaN(num)) return '—';
    if (compact && Math.abs(num) >= 1000000) {
      return `${(num / 1000000).toFixed(1)}M${showCurrency ? " so'm" : ''}`;
    }
    if (compact && Math.abs(num) >= 1000) {
      return `${(num / 1000).toFixed(1)}K${showCurrency ? " so'm" : ''}`;
    }
    const formatted = new Intl.NumberFormat('uz-UZ').format(num);
    return showCurrency ? `${formatted} so'm` : formatted;
  },
  number: (value, options = {}) => {
    const { compact = false, decimals = 0 } = options;
    if (value === null || value === undefined || value === '') return '—';
    const num = Number(value);
    if (isNaN(num)) return '—';
    if (compact) {
      if (Math.abs(num) >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
      if (Math.abs(num) >= 1000) return `${(num / 1000).toFixed(1)}K`;
    }
    return new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
  },
  percent: (value, options = {}) => {
    const { decimals = 1, showSign = false } = options;
    if (value === null || value === undefined || value === '') return '—';
    const num = Number(value);
    if (isNaN(num)) return '—';
    const sign = showSign && num > 0 ? '+' : '';
    return `${sign}${num.toFixed(decimals)}%`;
  },
  relativeTime: (date) => {
    if (!date) return '—';
    const now = new Date();
    const then = new Date(date);
    const diffMs = now - then;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Hozirgina';
    if (diffMins < 60) return `${diffMins} daqiqa oldin`;
    if (diffHours < 24) return `${diffHours} soat oldin`;
    if (diffDays < 7) return `${diffDays} kun oldin`;
    return then.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', year: diffDays > 365 ? 'numeric' : undefined });
  }
};

// ========== TOAST NOTIFICATIONS ==========
function initToastContainer() {
  if (!document.getElementById('toastContainer')) {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container';
    container.setAttribute('aria-live', 'polite');
    container.setAttribute('aria-atomic', 'true');
    document.body.appendChild(container);
  }
}

function showToast(message, type = 'info', options = {}) {
  const { title, duration = 4000, showClose = true } = options;
  initToastContainer();
  const container = document.getElementById('toastContainer');
  const toastId = 'toast-' + Date.now();
  const icons = { success: 'check_circle', error: 'error', warning: 'warning', info: 'info' };
  const toast = document.createElement('div');
  toast.id = toastId;
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <div class="toast-icon"><span class="material-symbols-outlined" style="font-size: 18px;">${icons[type] || 'info'}</span></div>
    <div class="toast-content">
      ${title ? `<div class="toast-title">${title}</div>` : ''}
      <div class="${title ? 'toast-message' : 'toast-title'}">${message}</div>
    </div>
    ${showClose ? `<button class="toast-close" onclick="dismissToast('${toastId}')" aria-label="Yopish"><span class="material-symbols-outlined" style="font-size: 18px;">close</span></button>` : ''}
  `;
  container.appendChild(toast);
  if (duration > 0) {
    setTimeout(() => dismissToast(toastId), duration);
  }
  return toastId;
}

function dismissToast(toastId) {
  const toast = document.getElementById(toastId);
  if (toast) {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 200);
  }
}

// ========== SKELETON LOADING ==========
function showSectionSkeleton(sectionId, type = 'card') {
  const section = document.getElementById(sectionId);
  if (!section) return;
  if (type === 'kpi') {
    section.innerHTML = `
      <div class="skeleton-card card p-5">
        <div class="skeleton-pulse skeleton-icon"></div>
        <div class="skeleton-pulse skeleton-label"></div>
        <div class="skeleton-pulse skeleton-value"></div>
        <div class="skeleton-pulse skeleton-subtitle"></div>
      </div>
    `;
  } else if (type === 'chart') {
    section.innerHTML = `<div class="skeleton-pulse" style="width: 100%; height: 200px; border-radius: var(--radius-xl);"></div>`;
  } else if (type === 'funnel') {
    section.innerHTML = Array(5).fill(0).map((_, i) => `
      <div style="margin-bottom: 8px;">
        <div class="flex justify-between mb-1"><div class="skeleton-pulse" style="width: 80px; height: 14px;"></div><div class="skeleton-pulse" style="width: 50px; height: 14px;"></div></div>
        <div class="skeleton-pulse" style="width: ${100 - i * 15}%; height: 40px;"></div>
      </div>
    `).join('');
  }
}

function showErrorState(containerId, options = {}) {
  const { title = "Ma'lumot yuklanmadi", message = "Xatolik yuz berdi. Qayta urinib ko'ring.", retryFn } = options;
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = `
    <div class="error-state">
      <div class="error-state-icon"><span class="material-symbols-outlined">error</span></div>
      <div class="error-state-title">${title}</div>
      <div class="error-state-message">${message}</div>
      ${retryFn ? `<button class="btn btn-primary btn-sm" onclick="${retryFn}"><span class="material-symbols-outlined" style="font-size: 16px;">refresh</span> Qayta urinish</button>` : ''}
    </div>
  `;
}

function showEmptyState(containerId, options = {}) {
  const { icon = 'inbox', title = "Ma'lumot yo'q", message = '' } = options;
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = `
    <div class="empty-state-modern">
      <div class="empty-state-modern-icon"><span class="material-symbols-outlined">${icon}</span></div>
      <div class="empty-state-modern-title">${title}</div>
      ${message ? `<div class="empty-state-modern-message">${message}</div>` : ''}
    </div>
  `;
}

// ========== DATA FRESHNESS ==========
function updateFreshnessIndicator() {
  const indicator = document.getElementById('freshnessIndicator');
  if (!indicator) return;
  const elapsed = Date.now() - lastDataRefresh;
  const minutes = Math.floor(elapsed / 60000);
  const dot = indicator.querySelector('.freshness-dot');
  const text = indicator.querySelector('.freshness-text');
  if (minutes < 1) {
    text.textContent = 'Hozirgina yangilandi';
    dot.className = 'freshness-dot pulse';
  } else if (minutes < 5) {
    text.textContent = `${minutes} daqiqa oldin`;
    dot.className = 'freshness-dot';
  } else {
    text.textContent = `${minutes} daqiqa oldin`;
    dot.className = 'freshness-dot stale';
  }
}
setInterval(updateFreshnessIndicator, 30000);

function normalizeTablePrefs() {
  const usersDefaults = { user: true, phone: true, lesson: true, status: true, date: true, actions: true };
  const paymentsDefaults = { date: true, user: true, amount: true, plan: true, status: true, system: true, premium: true, actions: true };
  tableColumnPrefs.users = { ...usersDefaults, ...(tableColumnPrefs.users || {}) };
  tableColumnPrefs.payments = { ...paymentsDefaults, ...(tableColumnPrefs.payments || {}) };
  localStorage.setItem('tableColumnsUsers', JSON.stringify(tableColumnPrefs.users));
  localStorage.setItem('tableColumnsPayments', JSON.stringify(tableColumnPrefs.payments));
}

function markTabStale(tab) {
  if (!tab) return;
  tabDataState[tab] = 0;
}

function markTabsStale(tabs) {
  (tabs || []).forEach((tab) => markTabStale(tab));
}
const TAB_META = {
  overview: { title: 'Bosh panel', subtitle: 'Asosiy monitoring paneli' },
  analytics: { title: 'Analitika', subtitle: 'Funnel, segment va to\'lov diagnostikasi' },
  users: { title: 'Foydalanuvchilar', subtitle: 'Qidiruv, segmentlash va boshqaruv' },
  conversations: { title: 'Suhbatlar', subtitle: 'User chat monitoring va tez javoblar' },
  payments: { title: 'To\'lovlar', subtitle: 'Holatlar, status va premium oqimi' },
  lessons: { title: 'Darslar', subtitle: 'Kontent va progress boshqaruvi' },
  library: { title: 'Kutubxona', subtitle: 'Media va dars ID katalogi' },
  progrev: { title: 'Progrev', subtitle: 'Sotuv oqimi va follow-up kontentlari' },
  custdev: { title: 'CustDev', subtitle: 'Savollar, javoblar va feedback tahlili' },
  renewal: { title: 'Uzaytirish', subtitle: 'Subscription renewal eslatmalari' },
  referrals: { title: 'Referallar', subtitle: 'Referral performance va leaderboard' },
  promo: { title: 'Promo kodlar', subtitle: 'Chegirma kodlari va limitlar' },
  audit: { title: 'Audit log', subtitle: 'Tizim bo\'yicha kuzatuv yozuvlari' },
  settings: { title: 'Sozlamalar', subtitle: 'Global platforma parametrlari' }
};

// Charts
let revenueChart, userTypeChart, subscriberGrowthChart;
let ageChart, occupationChart, incomeChart, budgetChart;
let questionStatsChart;

// ========== INITIALIZATION ==========
const isMobile = () => window.matchMedia('(max-width: 768px)').matches;
const chartTickFont = () => ({ size: isMobile() ? 10 : 12, family: 'Public Sans' });
const chartLayoutPadding = () => isMobile() ? { left: 6, right: 6, top: 6, bottom: 20 } : { left: 0, right: 0, top: 0, bottom: 0 };
const chartMaxXTicks = () => isMobile() ? 5 : 12;
const chartGridColor = () => (isMobile() ? 'rgba(148,163,184,0.25)' : 'rgba(148,163,184,0.2)');
const chartTextColor = () => '#64748b';
const chartAccent = () => '#7367f0';
const chartAccentSoft = () => 'rgba(115,103,240,0.16)';
const chartMuted = () => 'rgba(148,163,184,0.7)';
const nativeFetch = window.fetch.bind(window);

function setGlobalLoadingState(isLoading) {
  document.body.classList.toggle('ux-loading', !!isLoading);
}

function syncQuickDock(tab) {
  document.querySelectorAll('#uxQuickDock [data-quick-tab]').forEach((el) => {
    el.classList.toggle('active', el.getAttribute('data-quick-tab') === tab);
  });
}

function openUxShortcutsHelp() {
  document.getElementById('uxShortcutsModal')?.classList.add('show');
}

function closeUxShortcutsHelp(event) {
  if (event && event.target && event.target.id !== 'uxShortcutsModal') return;
  document.getElementById('uxShortcutsModal')?.classList.remove('show');
}

function applyAccessibilityLabels() {
  document.querySelectorAll('button, input, select, textarea').forEach((el) => {
    if (el.getAttribute('aria-label')) return;
    const title = el.getAttribute('title');
    if (title) {
      el.setAttribute('aria-label', title);
      return;
    }
    if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement || el instanceof HTMLSelectElement) {
      const placeholder = el.getAttribute('placeholder');
      if (placeholder) el.setAttribute('aria-label', placeholder.replace(/\s+/g, ' ').trim());
    }
  });
}

function enhanceTabStructure() {
  document.querySelectorAll('[id^="tab-"]').forEach((tab) => {
    tab.classList.add('ux-tab');
  });
}

function hydrateEmptyStates() {
  const map = [
    { id: 'recentUsersList', text: "So'nggi foydalanuvchilar hozircha yo'q" },
    { id: 'recentPaymentsList', text: "So'nggi to'lovlar hozircha yo'q" },
    { id: 'lessonsList', text: "Darslar ro'yxati bo'sh" },
    { id: 'mediaLibraryList', text: "Media kutubxonada yozuv yo'q" },
    { id: 'libraryLessonsList', text: "Kutubxonada darslar topilmadi" }
  ];
  map.forEach((entry) => {
    const el = document.getElementById(entry.id);
    if (!el) return;
    const txt = (el.textContent || '').toLowerCase();
    const hasNoData = txt.includes('yo\'q') || txt.includes('bo\'sh') || txt.includes('topilmadi');
    if (hasNoData) el.innerHTML = `<div class="ux-empty">${entry.text}</div>`;
  });
}

function syncUiToggleLabels() {
  const densityLabel = document.getElementById('tableDensityToggleLabel');
  if (densityLabel) densityLabel.textContent = tableDensity === 'compact' ? 'Keng' : 'Zich';
}

function updatePageHeader(tab) {
  const title = document.getElementById('pageTitle');
  const subtitle = document.getElementById('pageSubtitle');
  const meta = TAB_META[tab] || TAB_META.overview;
  if (title) title.textContent = meta.title;
  if (subtitle) subtitle.textContent = meta.subtitle;
}

function addNotification(message, level = 'info') {
  const item = {
    id: Date.now() + Math.random().toString(16).slice(2),
    message,
    level,
    createdAt: new Date().toISOString()
  };
  notifications.unshift(item);
  if (notifications.length > 80) notifications = notifications.slice(0, 80);
  renderNotifications();
}

function renderNotifications() {
  const list = document.getElementById('notificationsList');
  const badge = document.getElementById('notifBadge');
  if (!list || !badge) return;
  if (!notifications.length) {
    list.innerHTML = '<div class="p-3 text-xs text-gray-400">Hozircha bildirishnoma yo\'q</div>';
    badge.classList.add('hidden');
    return;
  }
  badge.classList.remove('hidden');
  badge.textContent = String(Math.min(99, notifications.length));
  list.innerHTML = notifications.slice(0, 40).map((n) => {
    const dot = n.level === 'error' ? '#ea5455' : n.level === 'warn' ? '#ff9f43' : '#7367f0';
    return `<div class="notif-item"><span style="display:inline-block;width:7px;height:7px;border-radius:999px;background:${dot};margin-right:8px;"></span>${escapeHtml(n.message)}<div class="text-[10px] text-gray-400 mt-1">${fmtDateTime(n.createdAt)}</div></div>`;
  }).join('');
}

function toggleNotificationsPanel() {
  document.getElementById('notificationsPanel')?.classList.toggle('show');
}

function clearNotifications() {
  notifications = [];
  renderNotifications();
}

function toggleSidebarMore() {
  sidebarMoreOpen = !sidebarMoreOpen;
  document.querySelectorAll('.extra-nav').forEach((el) => {
    el.classList.toggle('show', sidebarMoreOpen);
  });
}

function applyUsersSavedView(view) {
  currentUsersSavedView = view || 'all';
  localStorage.setItem('usersSavedView', currentUsersSavedView);
  document.querySelectorAll('#userSavedViews .saved-view-chip').forEach((el) => {
    const t = (el.textContent || '').trim().toLowerCase();
    const key = t.includes('high') ? 'high_intent' : t.includes('paid') ? 'paid_not_joined' : t.includes('inactive') ? 'inactive' : 'all';
    el.classList.toggle('active', key === currentUsersSavedView);
  });
  applyUserFilters();
}

function buildCommandPaletteData() {
  commandItems.length = 0;
  Object.keys(TAB_META).forEach((tab) => {
    commandItems.push({ type: 'tab', key: tab, label: `Bo'lim: ${TAB_META[tab].title}`, hint: TAB_META[tab].subtitle });
  });
  commandItems.push(
    { type: 'action', key: 'refresh', label: 'Amal: Yangilash (loadAll)', hint: 'Barcha datani qayta yuklaydi', handler: () => loadAll() },
    { type: 'action', key: 'broadcast', label: 'Amal: Broadcast oynasi', hint: 'Ommaviy xabar oynasini ochadi', handler: () => openBroadcastModal() },
    { type: 'action', key: 'analytics', label: 'Amal: Analitikani yangilash', hint: 'Analitika datalarini qayta yuklaydi', handler: () => { showTab('analytics'); loadAnalyticsData(); } }
  );
  allUsers.slice(0, 80).forEach((u) => {
    commandItems.push({
      type: 'user',
      key: String(u.telegram_id),
      label: `User: ${u.full_name || u.username || u.telegram_id}`,
      hint: `ID ${u.telegram_id} • dars ${u.current_lesson || 0}`,
      handler: () => { showTab('users'); openUserDetail(u.telegram_id); }
    });
  });
}

function openCommandPalette() {
  buildCommandPaletteData();
  const overlay = document.getElementById('commandPalette');
  const input = document.getElementById('commandInput');
  if (!overlay || !input) return;
  overlay.classList.add('show');
  input.value = '';
  renderCommandResults();
  setTimeout(() => input.focus(), 0);
}

function closeCommandPalette(event) {
  if (event && event.target && event.target.id !== 'commandPalette') return;
  document.getElementById('commandPalette')?.classList.remove('show');
}

function executeCommandItem(index) {
  const items = window.__commandFiltered || [];
  const selected = items[index];
  if (!selected) return;
  closeCommandPalette();
  if (selected.type === 'tab') {
    showTab(selected.key);
    return;
  }
  if (typeof selected.handler === 'function') selected.handler();
}

function renderCommandResults() {
  const q = (document.getElementById('commandInput')?.value || '').trim().toLowerCase();
  const results = q
    ? commandItems.filter((i) => (`${i.label} ${i.hint || ''} ${i.key}`).toLowerCase().includes(q))
    : commandItems.slice(0, 18);
  window.__commandFiltered = results.slice(0, 40);
  const wrap = document.getElementById('commandResults');
  if (!wrap) return;
  if (!window.__commandFiltered.length) {
    wrap.innerHTML = '<div class="p-4 text-sm text-gray-400">Hech nima topilmadi</div>';
    return;
  }
  wrap.innerHTML = window.__commandFiltered.map((i, idx) => `
    <button class="cmd-item w-full text-left" onclick="executeCommandItem(${idx})">
      <span>${escapeHtml(i.label)}</span>
      <span class="text-xs text-gray-400">${escapeHtml(i.hint || i.type)}</span>
    </button>
  `).join('');
}

setTimeout(() => {
  const input = document.getElementById('commandInput');
  if (!input) return;
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      executeCommandItem(0);
    }
  });
}, 0);

function toggleTableSettings(type) {
  const el = document.getElementById(type === 'users' ? 'usersTableSettings' : 'paymentsTableSettings');
  if (!el) return;
  el.classList.toggle('hidden');
}

function renderTableSettings(type) {
  const map = tableColumnPrefs[type] || {};
  const el = document.getElementById(type === 'users' ? 'usersTableSettings' : 'paymentsTableSettings');
  if (!el) return;
  el.innerHTML = Object.keys(map).map((key) => `
    <label class="table-settings-opt">
      <input type="checkbox" ${map[key] ? 'checked' : ''} onchange="setTableColumn('${type}','${key}',this.checked)" />
      <span>${escapeHtml(key)}</span>
    </label>
  `).join('');
}

function applyTableColumnVisibility(type) {
  const table = document.getElementById(type === 'users' ? 'usersTable' : 'paymentsTable');
  if (!table) return;
  const map = tableColumnPrefs[type] || {};
  Object.keys(map).forEach((key) => {
    table.querySelectorAll(`[data-col="${key}"]`).forEach((cell) => {
      cell.style.display = map[key] ? '' : 'none';
    });
  });
}

function setTableColumn(type, key, visible) {
  if (!tableColumnPrefs[type]) tableColumnPrefs[type] = {};
  tableColumnPrefs[type][key] = !!visible;
  localStorage.setItem(type === 'users' ? 'tableColumnsUsers' : 'tableColumnsPayments', JSON.stringify(tableColumnPrefs[type]));
  applyTableColumnVisibility(type);
}

function applyUiPreferences() {
  document.body.classList.remove('theme-dark');
  document.body.classList.toggle('table-compact', tableDensity === 'compact');
  syncUiToggleLabels();
  configureChartDefaults();
}

function configureChartDefaults() {
  if (!window.Chart) return;
  Chart.defaults.color = chartTextColor();
  Chart.defaults.borderColor = chartGridColor();
  Chart.defaults.font.family = 'Public Sans';
  Chart.defaults.animation = isMobile() ? false : { duration: 450 };
  Chart.defaults.plugins.legend.labels.usePointStyle = true;
  Chart.defaults.plugins.legend.labels.boxWidth = 8;
  Chart.defaults.plugins.legend.labels.padding = 14;
  Chart.defaults.plugins.tooltip.backgroundColor = '#2f2b3d';
  Chart.defaults.plugins.tooltip.titleColor = '#fff';
  Chart.defaults.plugins.tooltip.bodyColor = '#fff';
  Chart.defaults.plugins.tooltip.cornerRadius = 8;
  Chart.defaults.plugins.tooltip.padding = 10;
}

function toggleUiTheme() {
  // Light-only UI retained intentionally.
  applyUiPreferences();
  if (!document.getElementById('dashboard')?.classList.contains('hidden')) loadAll();
}

function toggleTableDensity() {
  tableDensity = tableDensity === 'compact' ? 'comfortable' : 'compact';
  localStorage.setItem('tableDensity', tableDensity);
  applyUiPreferences();
}

window.fetch = function(input, init = {}) {
  const url = typeof input === 'string' ? input : (input?.url || '');
  const isApiRequest = url.startsWith('/api/') || url.includes('/api/');
  if (!isApiRequest) return nativeFetch(input, init);

  const nextInit = { ...init };
  const headers = new Headers(nextInit.headers || (input instanceof Request ? input.headers : undefined));
  if (auth) headers.set('Authorization', auth);
  if (tgInitData) headers.set('X-Telegram-Init-Data', tgInitData);
  nextInit.headers = headers;

  return nativeFetch(input, nextInit);
};

applyUiPreferences();

// Chart period state (declared early to avoid hoisting issues)
let currentRevenuePeriod = 'week';
let currentGrowthPeriod = 'day';

let uiResizeTimer = null;
window.addEventListener('resize', () => {
  clearTimeout(uiResizeTimer);
  uiResizeTimer = setTimeout(() => {
    configureChartDefaults();
    const activeTab = document.querySelector('[id^="tab-"]:not(.hidden)')?.id || '';
    if (activeTab === 'tab-overview') {
      if (typeof renderRevenueChart === 'function') renderRevenueChart(currentRevenuePeriod);
      if (typeof renderSubscriberGrowthChart === 'function') renderSubscriberGrowthChart(currentGrowthPeriod);
      if (typeof renderUserTypeChart === 'function') renderUserTypeChart();
    } else if (activeTab === 'tab-analytics') {
      Object.values(analyticsCharts).forEach((c) => c?.resize?.());
    }
  }, 220);
});

const currentDateEl = document.getElementById('currentDate');
if (currentDateEl) {
  currentDateEl.textContent = new Date().toLocaleDateString('uz-UZ', {
    year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
  });
}

function blockAccess(message) {
  const title = document.querySelector('#loginModal h1');
  const subtitle = document.querySelector('#loginModal p.text-gray-500');
  const form = document.getElementById('loginForm');
  const error = document.getElementById('loginError');

  if (title) title.textContent = 'Ruxsat yo\'q';
  if (subtitle) subtitle.textContent = 'Bu sahifa faqat admin uchun';
  if (form) {
    form.classList.add('opacity-60', 'pointer-events-none');
    form.querySelectorAll('input, button').forEach((el) => {
      el.disabled = true;
    });
  }
  if (error) {
    error.textContent = message || 'Kirish rad etildi';
    error.classList.remove('hidden');
  }
}

async function initAuth() {
  const tgWebApp = window.Telegram?.WebApp;
  if (tgWebApp?.initData) {
    tgInitData = tgWebApp.initData;
    try {
      tgWebApp.ready();
      tgWebApp.expand();
    } catch (_) {}

    try {
      const r = await fetch('/api/auth/telegram-webapp');
      if (!r.ok) throw new Error('forbidden');
      showDashboard();
      return;
    } catch (e) {
      blockAccess('Siz admin emassiz. WebApp yopildi.');
      return;
    }
  }

  const saved = localStorage.getItem('adminAuth');
  if (saved) {
    auth = saved;
    showDashboard();
  }
}
initAuth();

// Login
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  const loginError = document.getElementById('loginError');
  loginError.classList.add('hidden');

  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', { headers: { Authorization: auth } });
    if (r.ok) {
      localStorage.setItem('adminAuth', auth);
      showDashboard();
    } else {
      const errorData = await r.json().catch(() => ({}));
      if (r.status === 429) {
        loginError.textContent = 'Ko\'p urinish. 15 daqiqa kuting.';
      } else if (r.status === 401) {
        loginError.textContent = 'Login yoki parol xato';
      } else {
        loginError.textContent = 'Server xatosi: ' + (errorData.error || r.status);
      }
      loginError.classList.remove('hidden');
    }
  } catch(err) {
    loginError.textContent = 'Server bilan bog\'lanib bo\'lmadi';
    loginError.classList.remove('hidden');
    console.error('Login error:', err);
  }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  updatePageHeader('overview');
  applyUiPreferences();
  normalizeTablePrefs();
  applyAccessibilityLabels();
  enhanceTabStructure();
  renderTableSettings('users');
  renderTableSettings('payments');
  applyTableColumnVisibility('users');
  applyTableColumnVisibility('payments');
  applyUsersSavedView(currentUsersSavedView);
  syncQuickDock('overview');
  hydrateEmptyStates();
  addNotification('Dashboard ochildi', 'info');
  watchResponsiveTables();
  loadAll();
}

function logout() {
  localStorage.removeItem('adminAuth');
  location.reload();
}

function toggleMobileMenu() {
  const modal = document.getElementById('mobileMenuModal');
  modal.classList.toggle('hidden');
}

document.addEventListener('keydown', (e) => {
  if (activeModalId && e.key === 'Tab') {
    trapModalFocus(e);
    return;
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
    e.preventDefault();
    openCommandPalette();
    return;
  }
  if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key === '?') {
    e.preventDefault();
    openUxShortcutsHelp();
    return;
  }
  if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key.toLowerCase() === 'r' && !['INPUT', 'TEXTAREA', 'SELECT'].includes((document.activeElement?.tagName || '').toUpperCase())) {
    e.preventDefault();
    loadAll();
    return;
  }
  if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key.toLowerCase() === 'g') {
    pendingGoShortcut = 'g';
    setTimeout(() => { pendingGoShortcut = null; }, 1200);
    return;
  }
  if (pendingGoShortcut === 'g' && !e.ctrlKey && !e.metaKey && !e.altKey) {
    const k = e.key.toLowerCase();
    if (k === 'o') showTab('overview');
    if (k === 'u') showTab('users');
    if (k === 'p') showTab('payments');
    if (k === 'a') showTab('analytics');
    pendingGoShortcut = null;
  }
  if (e.key === 'Escape') {
    if (activeModalId) {
      closeModal(activeModalId);
      return;
    }
    closeCommandPalette();
    closeUxShortcutsHelp();
    document.getElementById('notificationsPanel')?.classList.remove('show');
    document.querySelectorAll('.table-settings-pop').forEach((el) => el.classList.add('hidden'));
  }
});

document.addEventListener('click', (e) => {
  const t = e.target;
  if (!(t instanceof Element)) return;
  if (!t.closest('.table-settings-pop') && !t.closest('[onclick*="toggleTableSettings"]')) {
    document.querySelectorAll('.table-settings-pop').forEach((el) => el.classList.add('hidden'));
  }
});

// ========== RESPONSIVE TABLE LABELS ==========
function applyTableLabels() {
  document.querySelectorAll('table.responsive-table').forEach(table => {
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      Array.from(tr.children).forEach((cell, i) => {
        if (cell.tagName && cell.tagName.toLowerCase() === 'td' && headers[i]) {
          cell.setAttribute('data-label', headers[i]);
        }
      });
    });
  });
}

function watchResponsiveTables() {
  applyTableLabels();
  document.querySelectorAll('table.responsive-table tbody').forEach(tbody => {
    const observer = new MutationObserver(() => applyTableLabels());
    observer.observe(tbody, { childList: true });
  });
}

// ========== SIDEBAR TOGGLE ==========
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.querySelector('.main-content');
  const icon = document.getElementById('sidebarToggleIcon');

  sidebar.classList.toggle('expanded');
  const isExpanded = sidebar.classList.contains('expanded');

  icon.textContent = isExpanded ? 'chevron_left' : 'chevron_right';
  mainContent.style.marginLeft = isExpanded ? '220px' : '94px';

  localStorage.setItem('sidebarExpanded', isExpanded);
}

// Initialize sidebar state from localStorage
(function initSidebar() {
  const stored = localStorage.getItem('sidebarExpanded');
  const isExpanded = stored === null ? true : stored === 'true';
  if (isExpanded) {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const icon = document.getElementById('sidebarToggleIcon');
    if (sidebar && mainContent && icon) {
      sidebar.classList.add('expanded');
      icon.textContent = '←';
      mainContent.style.marginLeft = '270px';
    }
  } else {
    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.style.marginLeft = '94px';
  }
})();

// ========== ADVANCED USER FILTERS ==========
let advancedFiltersVisible = false;

function toggleAdvancedFilters() {
  advancedFiltersVisible = !advancedFiltersVisible;
  const panel = document.getElementById('advancedFiltersPanel');
  const label = document.getElementById('advFilterLabel');
  panel.classList.toggle('hidden', !advancedFiltersVisible);
  label.textContent = advancedFiltersVisible ? 'Yopish' : 'Filtrlar';
}

function updateUsersFilterSummary(activeCount, total) {
  const el = document.getElementById('usersFilterSummary');
  if (!el) return;
  el.textContent = activeCount > 0
    ? `Filtrlar: ${activeCount} ta faol • ${total} natija`
    : `Filtrlar: barchasi • ${total} natija`;
}

function updateUsersBulkBar() {
  const bar = document.getElementById('usersBulkActionBar');
  const countEl = document.getElementById('usersBulkCount');
  const selectAll = document.getElementById('usersSelectAllPage');
  if (!bar || !countEl) return;
  const count = selectedUsersOnPage.size;
  bar.classList.toggle('show', count > 0);
  countEl.textContent = `${count} ta user tanlangan`;
  if (selectAll) {
    const boxes = document.querySelectorAll('#usersTableBody input.row-select');
    const totalVisible = boxes.length;
    selectAll.checked = !!totalVisible && count === totalVisible;
  }
}

function toggleUserRowSelection(telegramId, checked) {
  const id = String(telegramId);
  if (checked) selectedUsersOnPage.add(id);
  else selectedUsersOnPage.delete(id);
  updateUsersBulkBar();
}

function toggleSelectAllUsersPage(checked) {
  document.querySelectorAll('#usersTableBody input.row-select').forEach((box) => {
    box.checked = checked;
    const id = String(box.getAttribute('data-user-id') || '');
    if (!id) return;
    if (checked) selectedUsersOnPage.add(id);
    else selectedUsersOnPage.delete(id);
  });
  updateUsersBulkBar();
}

function clearUsersSelection() {
  selectedUsersOnPage.clear();
  document.querySelectorAll('#usersTableBody input.row-select').forEach((box) => { box.checked = false; });
  const selectAll = document.getElementById('usersSelectAllPage');
  if (selectAll) selectAll.checked = false;
  updateUsersBulkBar();
}

function bulkBroadcastSelectedUsers() {
  if (!selectedUsersOnPage.size) return;
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();
  selectedBroadcastUsers.clear();
  selectedUsersOnPage.forEach((id) => selectedBroadcastUsers.add(Number(id)));
  updateSelectedUsersList();
}

function renderUsersTableSkeleton() {
  const tbody = document.getElementById('usersTableBody');
  if (!tbody) return;
  tbody.innerHTML = Array.from({ length: 6 }).map(() => `
    <tr>
      <td class="px-4 py-4"><div class="skeleton h-4 w-4"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-8 w-44"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-24"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-16"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-20"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-24"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-8 w-20"></div></td>
    </tr>
  `).join('');
}

function renderPaymentsTableSkeleton() {
  const tbody = document.getElementById('paymentsTableBody');
  if (!tbody) return;
  tbody.innerHTML = Array.from({ length: 6 }).map(() => `
    <tr>
      <td class="px-5 py-4"><div class="skeleton h-6 w-28"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-8 w-40"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-20"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-16"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-24"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-20"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-6 w-24"></div></td>
      <td class="px-5 py-4"><div class="skeleton h-8 w-16"></div></td>
    </tr>
  `).join('');
}

function applyUserFilters() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const status = document.getElementById('userStatusFilter').value;
  const lessonFrom = parseInt(document.getElementById('filterLessonFrom')?.value) || 0;
  const lessonTo = parseInt(document.getElementById('filterLessonTo')?.value) || 999;
  const regDate = document.getElementById('filterRegDate')?.value || 'all';
  const phone = document.getElementById('filterPhone')?.value || 'all';
  const funnelStep = document.getElementById('filterFunnelStep')?.value || 'all';

  // Show/hide custom date range
  const customDateDiv = document.getElementById('customDateRange');
  if (customDateDiv) {
    customDateDiv.classList.toggle('hidden', regDate !== 'custom');
  }

  let filtered = allUsers.filter(u => {
    // Search filter
    if (search) {
      const searchMatch = (u.full_name || '').toLowerCase().includes(search) ||
                         (u.username || '').toLowerCase().includes(search) ||
                         (u.phone || '').includes(search) ||
                         String(u.telegram_id).includes(search);
      if (!searchMatch) return false;
    }

    // Status filter
    if (status === 'paid' && !u.is_paid) return false;
    if (status === 'free' && u.is_paid) return false;
    if (status === 'paid_not_joined' && (!u.is_paid || u.joined_premium_channel)) return false;

    // Lesson range filter
    const lesson = u.current_lesson || 0;
    if (lesson < lessonFrom || lesson > lessonTo) return false;

    // Phone filter
    if (phone === 'has' && !u.phone) return false;
    if (phone === 'no' && u.phone) return false;

    // Funnel step filter
    if (funnelStep !== 'all') {
      const step = parseInt(funnelStep);
      if (step === 1 && (u.funnel_step < 1 || u.funnel_step > 4)) return false;
      if (step === 5 && (u.funnel_step < 5 || u.funnel_step > 7)) return false;
      if (step === 8 && u.funnel_step < 8) return false;
      if (step === 0 && u.funnel_step !== 0) return false;
    }

    // Saved view shortcuts
    if (currentUsersSavedView === 'high_intent') {
      const isHighIntent = (u.current_lesson || 0) >= 3 && !u.is_paid;
      if (!isHighIntent) return false;
    }
    if (currentUsersSavedView === 'paid_not_joined') {
      if (!(u.is_paid && !u.joined_premium_channel)) return false;
    }
    if (currentUsersSavedView === 'inactive') {
      const last = u.last_activity ? new Date(u.last_activity).getTime() : 0;
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      if (!last || (Date.now() - last) < sevenDays) return false;
    }

    // Date filter
    if (regDate !== 'all' && regDate !== 'custom') {
      const created = new Date(u.created_at);
      const now = new Date();
      if (regDate === 'today') {
        if (created.toDateString() !== now.toDateString()) return false;
      } else if (regDate === 'week') {
        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
        if (created < weekAgo) return false;
      } else if (regDate === 'month') {
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        if (created < monthAgo) return false;
      }
    } else if (regDate === 'custom') {
      const fromDate = document.getElementById('filterDateFrom')?.value;
      const toDate = document.getElementById('filterDateTo')?.value;
      const created = new Date(u.created_at);
      if (fromDate && created < new Date(fromDate)) return false;
      if (toDate && created > new Date(toDate + 'T23:59:59')) return false;
    }

    return true;
  });

  // Update filtered count
  document.getElementById('filteredUsersCount').textContent = `(${filtered.length} ta)`;

  // Update active filters info
  let activeCount = 0;
  if (search) activeCount++;
  if (status !== 'all') activeCount++;
  if (lessonFrom > 0 || lessonTo < 999) activeCount++;
  if (regDate !== 'all') activeCount++;
  if (phone !== 'all') activeCount++;
  if (funnelStep !== 'all') activeCount++;

  const infoEl = document.getElementById('activeFiltersInfo');
  if (infoEl) {
    infoEl.textContent = activeCount > 0 ? `${activeCount} ta filtr faol` : '';
  }

  updateUsersFilterSummary(activeCount, filtered.length);
  const maxPage = Math.max(1, Math.ceil(filtered.length / perPage));
  if (currentPage > maxPage) currentPage = 1;

  // Render filtered results
  renderFilteredUsers(filtered);
}

function renderFilteredUsers(filtered) {
  const start = (currentPage - 1) * perPage;
  const paginated = filtered.slice(start, start + perPage);
  const pageIds = new Set(paginated.map((u) => String(u.telegram_id)));
  Array.from(selectedUsersOnPage).forEach((id) => {
    if (!pageIds.has(id)) selectedUsersOnPage.delete(id);
  });

  const tbody = document.getElementById('usersTableBody');
  if (!paginated.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-gray-400">Foydalanuvchilar topilmadi</td></tr>';
    applyTableColumnVisibility('users');
    updateUsersBulkBar();
    return;
  }

  tbody.innerHTML = paginated.map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-4 py-4">
        <input type="checkbox" class="row-select" data-user-id="${u.telegram_id}" ${selectedUsersOnPage.has(String(u.telegram_id)) ? 'checked' : ''} onclick="event.stopPropagation()" onchange="toggleUserRowSelection(${u.telegram_id}, this.checked)">
      </td>
      <td data-col="user" class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td data-col="phone" class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td data-col="lesson" class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td data-col="status" class="px-5 py-4">
        ${u.is_paid
          ? (u.joined_premium_channel
              ? '<span class="badge badge-green">Premium</span>'
              : '<span class="badge badge-orange" title="To\'lagan, lekin kanalga qo\'shilmagan">To\'lagan ❌</span>')
          : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td data-col="date" class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td data-col="actions" class="px-5 py-4">
        <div class="flex gap-1">
          <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm" title="Ko'rish">👁</button>
          <button onclick="event.stopPropagation(); deleteUser(${u.telegram_id}, '${(u.full_name || u.username || 'User').replace(/'/g, "\\'")}')" class="btn btn-sm bg-red-50 text-red-600 hover:bg-red-100" title="O'chirish">🗑️</button>
        </div>
      </td>
    </tr>
  `).join('');
  applyTableColumnVisibility('users');
  updateUsersBulkBar();

  // Pagination
  const totalPages = Math.ceil(filtered.length / perPage);
  const pagination = document.getElementById('usersPagination');
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHTML = '';
  for (let i = 1; i <= Math.min(totalPages, 10); i++) {
    paginationHTML += `<button onclick="currentPage=${i}; applyUserFilters()" class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm">${i}</button>`;
  }
  pagination.innerHTML = paginationHTML;
}

function resetUserFilters() {
  document.getElementById('userSearch').value = '';
  document.getElementById('userStatusFilter').value = 'all';
  if (document.getElementById('filterLessonFrom')) document.getElementById('filterLessonFrom').value = '';
  if (document.getElementById('filterLessonTo')) document.getElementById('filterLessonTo').value = '';
  if (document.getElementById('filterRegDate')) document.getElementById('filterRegDate').value = 'all';
  if (document.getElementById('filterPhone')) document.getElementById('filterPhone').value = 'all';
  if (document.getElementById('filterFunnelStep')) document.getElementById('filterFunnelStep').value = 'all';
  if (document.getElementById('filterDateFrom')) document.getElementById('filterDateFrom').value = '';
  if (document.getElementById('filterDateTo')) document.getElementById('filterDateTo').value = '';
  clearUsersSelection();
  currentPage = 1;
  applyUserFilters();
}

function exportUsers() {
  // Export filtered users to CSV
  const search = document.getElementById('userSearch').value.toLowerCase();
  let filtered = allUsers;
  if (search) {
    filtered = allUsers.filter(u =>
      (u.full_name || '').toLowerCase().includes(search) ||
      (u.phone || '').includes(search)
    );
  }

  const csv = [
    ['ID', 'Ism', 'Username', 'Telefon', 'Dars', 'Status', 'Sana'].join(','),
    ...filtered.map(u => [
      u.telegram_id,
      `"${u.full_name || ''}"`,
      `"${u.username || ''}"`,
      u.phone || '',
      u.current_lesson || 0,
      u.is_paid ? 'Premium' : 'Free',
      u.created_at?.split('T')[0] || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
}

// ========== BROADCAST ENHANCEMENTS ==========
function insertVariable(variable) {
  const textarea = document.getElementById('broadcastText');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  textarea.value = text.substring(0, start) + variable + text.substring(end);
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  textarea.focus();
  updatePreview();
}

function applyBroadcastFormat(kind) {
  if (kind === 'link') {
    insertLinkTemplateTo('broadcastText');
    updatePreview();
    return;
  }
  if (kind === 'emoji') {
    insertCustomEmojiTemplateTo('broadcastText');
    updatePreview();
    return;
  }
  wrapTextareaSelection('broadcastText', kind);
  updatePreview();
}

function updatePreview() {
  const text = document.getElementById('broadcastText').value || '';
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;
  const btn2Text = document.getElementById('broadcastBtn2Text').value;
  const btn2Url = document.getElementById('broadcastBtn2Url').value;

  // Update char count
  document.getElementById('charCount').textContent = text.length;

  // Preview with sample data
  let preview = text
    .replace(/\{\{ism\}\}/gi, 'Ali')
    .replace(/\{\{fio\}\}/gi, 'Ali Valiyev')
    .replace(/\{\{telefon\}\}/gi, '+998901234567')
    .replace(/\{\{dars\}\}/gi, '3')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/&lt;b&gt;/g, '<b>')
    .replace(/&lt;\/b&gt;/g, '</b>')
    .replace(/&lt;i&gt;/g, '<i>')
    .replace(/&lt;\/i&gt;/g, '</i>')
    .replace(/\n/g, '<br>');

  document.getElementById('broadcastPreview').innerHTML = preview || '<p class="text-gray-300 italic">Xabar matni bu yerda ko\'rinadi...</p>';

  // Preview button
  const previewBtn = document.getElementById('previewButton');
  const previewBtn2 = document.getElementById('previewButton2');
  if (btnText && btnUrl) {
    document.getElementById('previewBtnText').textContent = btnText;
    previewBtn.classList.remove('hidden');
    if (btn2Text && btn2Url) {
      document.getElementById('previewBtn2Text').textContent = btn2Text;
      previewBtn2.classList.remove('hidden');
    } else {
      previewBtn2.classList.add('hidden');
    }
  } else {
    previewBtn.classList.add('hidden');
    previewBtn2.classList.add('hidden');
  }
}

function collectBroadcastButtons() {
  const pairs = [
    {
      text: document.getElementById('broadcastBtnText')?.value?.trim(),
      url: document.getElementById('broadcastBtnUrl')?.value?.trim()
    },
    {
      text: document.getElementById('broadcastBtn2Text')?.value?.trim(),
      url: document.getElementById('broadcastBtn2Url')?.value?.trim()
    }
  ];
  return pairs.filter((b) => b.text && b.url);
}

function prefillPaymentButtons() {
  document.getElementById('broadcastBtnText').value = "💳 Payme orqali to'lash";
  document.getElementById('broadcastBtnUrl').value = `{{payme_checkout_url}}`;
  document.getElementById('broadcastBtn2Text').value = "💠 Click orqali to'lash";
  document.getElementById('broadcastBtn2Url').value = `{{click_checkout_url}}`;
  updatePreview();
}

function updateRecipientCount() {
  const target = document.getElementById('broadcastTarget').value;
  let count = 0;

  // Show/hide lesson range div
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }

  if (target === 'all') {
    count = allUsers.length;
  } else if (target === 'paid') {
    count = allUsers.filter(u => u.is_paid).length;
  } else if (target === 'free') {
    count = allUsers.filter(u => !u.is_paid).length;
  } else if (target === 'active') {
    count = allUsers.filter(u => u.current_lesson > 0 && !u.is_paid).length;
  } else if (target === 'lesson') {
    const from = parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0;
    const to = parseInt(document.getElementById('broadcastLessonTo')?.value) || 999;
    count = allUsers.filter(u => u.current_lesson >= from && u.current_lesson <= to).length;
  } else if (target === 'specific') {
    count = selectedBroadcastUsers.size;
  }

  document.getElementById('recipientCount').textContent = count;
}

async function previewBroadcast() {
  // Send test message to admin
  const text = document.getElementById('broadcastText').value;
  if (!text) {
    alert('Xabar matnini kiriting');
    return;
  }

  try {
    const buttons = collectBroadcastButtons();
    const res = await fetch('/api/broadcast/test', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        type: document.getElementById('broadcastType').value,
        media_id: document.getElementById('broadcastMediaId').value,
        button: buttons[0] || null,
        buttons
      })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data?.success === false) {
      throw new Error(data?.error || 'Test xabar yuborilmadi');
    }
    alert('✅ Test xabar yuborildi (o\'zingizga)');
  } catch (e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.sidebar-item[data-tab], .mobile-nav-item[data-tab]').forEach(item => {
  item.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

// ========== REVENUE PERIOD TABS ==========
document.querySelectorAll('button[data-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentRevenuePeriod = this.dataset.period;
    renderRevenueChart(currentRevenuePeriod);
  });
});

// ========== SUBSCRIBER GROWTH PERIOD TABS ==========
document.querySelectorAll('button[data-growth-period]').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('button[data-growth-period]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    currentGrowthPeriod = this.dataset.growthPeriod;
    renderSubscriberGrowthChart(currentGrowthPeriod);
  });
});

async function ensureTabData(tab, force = false) {
  const now = Date.now();
  const lastLoadedAt = tabDataState[tab] || 0;
  if (!force && lastLoadedAt && (now - lastLoadedAt) < 120000) return;

  if (tab === 'progrev') {
    await loadProgrevSettings();
    initProgrevFormatEditors();
    await loadCustomEmojiLibrary();
  }
  if (tab === 'custdev') await loadFeedback();
  if (tab === 'conversations') {
    await loadConversations();
    await loadCustomEmojiLibrary();
  }
  if (tab === 'renewal') await loadRenewalSettings();
  if (tab === 'settings') await loadSettingsForm();
  if (tab === 'analytics') {
    applyAnalyticsViewPreference();
    await loadAnalyticsData(force);
  }
  if (tab === 'referrals') await loadReferralData();
  if (tab === 'audit') await loadAuditLogs();
  tabDataState[tab] = Date.now();
}

function showTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');
  updatePageHeader(tab);
  syncQuickDock(tab);
  hydrateEmptyStates();
  applyAccessibilityLabels();

  document.querySelectorAll('.sidebar-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.sidebar-item[data-tab="' + tab + '"]')?.classList.add('active');

  document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.mobile-nav-item[data-tab="' + tab + '"]')?.classList.add('active');

  ensureTabData(tab).catch((e) => console.error(`ensureTabData(${tab}) error:`, e));
  addNotification(`Tab ochildi: ${TAB_META[tab]?.title || tab}`, 'info');
}

async function loadSettingsForm() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    // Channel settings
    document.getElementById('settingPremiumChannel').value = data.premium_channel_id || '';
    document.getElementById('settingFreeChannel').value = data.free_channel_id || '';
    document.getElementById('settingFreeChannelLink').value = data.free_channel_link || '';
    document.getElementById('settingRequireSub').value = data.require_subscription_before_lesson || 0;

    // Subscription bypass settings
    document.getElementById('settingSubBypassEnabled').checked = data.subscription_bypass_enabled === 'true';
    document.getElementById('settingSubBypassAttempts').value = data.subscription_bypass_attempts || 3;

    // Payment settings - FIXED: load saved values
    document.getElementById('settingPayme').checked = data.payme_enabled !== false;
    document.getElementById('settingClick').checked = data.click_enabled !== false;

    // Price settings - load and calculate discounts
    if (data.price_1m) {
      document.getElementById('settingPrice1m').value = Math.round(data.price_1m / 100);
      // Auto-calculate discounted prices for display
      calculateDiscountedPrices();
    }
    // Also show saved values if different (for backward compatibility)
    if (data.price_3m) document.getElementById('settingPrice3m').value = Math.round(data.price_3m / 100);
    if (data.price_6m) document.getElementById('settingPrice6m').value = Math.round(data.price_6m / 100);
    if (data.price_12m) document.getElementById('settingPrice12m').value = Math.round(data.price_12m / 100);

    // Inactivity reminder settings
    document.getElementById('settingInactivityEnabled').checked = data.inactivity_reminder_enabled === 'true';
    document.getElementById('settingInactivityReminder1').value = data.inactivity_reminder_1 || '';
    document.getElementById('settingInactivityReminder2').value = data.inactivity_reminder_2 || '';

    // Referral system settings
    document.getElementById('settingReferralEnabled').checked = data.referral_enabled === 'true';
    document.getElementById('settingReferralCount').value = data.referral_required_count || 3;
    document.getElementById('settingReferralDiscount').value = data.referral_discount_percent || 50;

    // Referral offer settings
    document.getElementById('settingReferralOfferEnabled').checked = data.referral_offer_enabled === 'true';
    document.getElementById('settingReferralOfferDelay').value = data.referral_offer_delay_hours || 24;
    document.getElementById('settingReferralOfferMessage').value = data.referral_offer_message || '';

  } catch(e) { console.error('loadSettingsForm error:', e); }
}

// ========== PROMO CODES ==========
let promoCodes = [];

async function loadPromoCodes() {
  try {
    promoCodes = await (await fetch('/api/promo-codes', { headers: { Authorization: auth } })).json();
    renderPromoCodes();
  } catch(e) {
    console.error('loadPromoCodes error:', e);
  }
}

function renderPromoCodes() {
  const tbody = document.getElementById('promoCodesTable');
  if (!promoCodes || promoCodes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-400">Promo kodlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = promoCodes.map(p => {
    const isActive = p.is_active;
    const isExpired = p.valid_until && new Date(p.valid_until) < new Date();
    const limitReached = p.max_uses && p.current_uses >= p.max_uses;

    let status = 'badge-green';
    let statusText = 'Faol';
    if (!isActive) { status = 'badge-gray'; statusText = 'O\'chirilgan'; }
    else if (isExpired) { status = 'badge-red'; statusText = 'Muddati o\'tgan'; }
    else if (limitReached) { status = 'badge-orange'; statusText = 'Limit tugagan'; }

    const validUntil = p.valid_until ? new Date(p.valid_until).toLocaleDateString('uz') : 'Cheksiz';

    return `
      <tr class="table-row">
        <td class="py-3 font-mono font-semibold">${p.code}</td>
        <td class="py-3">${p.discount_percent}%</td>
        <td class="py-3">${p.current_uses || 0}</td>
        <td class="py-3">${p.max_uses || '∞'}</td>
        <td class="py-3">${validUntil}</td>
        <td class="py-3"><span class="badge ${status}">${statusText}</span></td>
        <td class="py-3">
          <button onclick="togglePromoCode(${p.id}, ${!p.is_active})" class="text-sm ${p.is_active ? 'text-red-500' : 'text-green-500'} hover:underline">
            ${p.is_active ? "O'chirish" : 'Yoqish'}
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

function showCreatePromoModal() {
  document.getElementById('promoModal').classList.remove('hidden');
  document.getElementById('promoModal').classList.add('flex');
  activateModalA11y('promoModal');
  setPromoWizardStep(1);
  document.getElementById('promoCode').value = '';
  document.getElementById('promoDiscount').value = '';
  document.getElementById('promoMaxUses').value = '';
  document.getElementById('promoValidFrom').value = '';
  document.getElementById('promoValidUntil').value = '';
  document.getElementById('promoMinPlan').value = '';
}

function setPromoWizardStep(step) {
  const isStep2 = Number(step) === 2;
  document.getElementById('promoStep1')?.classList.toggle('hidden', isStep2);
  document.getElementById('promoStep2')?.classList.toggle('hidden', !isStep2);
  document.getElementById('promoBackBtn')?.classList.toggle('hidden', !isStep2);
  document.getElementById('promoNextBtn')?.classList.toggle('hidden', isStep2);
  document.getElementById('promoCreateBtn')?.classList.toggle('hidden', !isStep2);
  document.getElementById('promoStepDot1')?.classList.toggle('active', !isStep2);
  document.getElementById('promoStepDot2')?.classList.toggle('active', isStep2);
}

function closePromoModal() {
  document.getElementById('promoModal').classList.add('hidden');
  document.getElementById('promoModal').classList.remove('flex');
  deactivateModalA11y('promoModal');
}

async function createPromoCode() {
  const code = document.getElementById('promoCode').value.trim().toUpperCase();
  const discountPercent = parseInt(document.getElementById('promoDiscount').value);
  const maxUses = document.getElementById('promoMaxUses').value ? parseInt(document.getElementById('promoMaxUses').value) : null;
  const validFrom = document.getElementById('promoValidFrom').value || null;
  const validUntil = document.getElementById('promoValidUntil').value || null;
  const minPlan = document.getElementById('promoMinPlan').value || null;

  if (!code || !discountPercent) {
    return alert('Kod va chegirma foizini kiriting');
  }

  if (discountPercent < 1 || discountPercent > 100) {
    return alert('Chegirma 1-100% orasida bo\'lishi kerak');
  }

  try {
    const res = await fetch('/api/promo-codes', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, discountPercent, maxUses, validFrom, validUntil, minPlan })
    });

    const data = await res.json();
    if (data.error) {
      return alert('Xatolik: ' + data.error);
    }

    closePromoModal();
    await loadPromoCodes();
    alert('Promo kod yaratildi!');
  } catch(e) {
    alert('Xatolik: ' + e.message);
  }
}

async function togglePromoCode(id, isActive) {
  try {
    await fetch('/api/promo-codes/' + id, {
      method: 'PUT',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_active: isActive })
    });
    await loadPromoCodes();
  } catch(e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== LOAD DATA ==========
async function loadAll() {
  try {
    setGlobalLoadingState(true);
    addNotification('Data yangilanmoqda...', 'info');
    await Promise.all([
      loadStats(),
      loadUsers(),
      loadPayments(),
      loadLessons(),
      loadCustDev(),
      loadCustdevAnswers(),
      loadFeedback(),
      loadSettingsForm(),
      loadMediaLibrary(),
      loadPromoCodes()
    ]);
    markTabsStale(['analytics', 'conversations', 'progrev', 'renewal', 'referrals', 'audit']);
    const activeTab = (document.querySelector('[id^="tab-"]:not(.hidden)')?.id || 'tab-overview').replace('tab-', '');
    if (activeTab && activeTab !== 'overview' && activeTab !== 'users' && activeTab !== 'payments' && activeTab !== 'lessons' && activeTab !== 'library' && activeTab !== 'custdev' && activeTab !== 'settings' && activeTab !== 'promo') {
      await ensureTabData(activeTab, true);
    }
    renderCharts();
    renderTodayStats();
    renderLessonProgress(); // Re-render after all data is loaded
    hydrateEmptyStates();
    applyAccessibilityLabels();
    addNotification('Yangilash muvaffaqiyatli yakunlandi', 'info');
  } catch (e) {
    console.error('loadAll error:', e);
    addNotification('Yangilashda xatolik yuz berdi', 'error');
  } finally {
    setGlobalLoadingState(false);
  }
}

async function loadStats() {
  try {
    const stats = await (await fetch('/api/stats', { headers: { Authorization: auth } })).json();

    // Main stat cards
    document.getElementById('statTotalUsers').textContent = formatters.number(stats.totalUsers || 0);
    document.getElementById('statPaidUsers').textContent = formatters.number(stats.paidUsers || 0);
    document.getElementById('statRevenue').textContent = formatters.money(stats.monthRevenue || stats.totalRevenue || 0);

    // Calculate conversion rate properly
    const conv = stats.totalUsers > 0 ? ((stats.paidUsers / stats.totalUsers) * 100).toFixed(1) : 0;
    document.getElementById('statConversion').textContent = formatters.percent(conv, { decimals: 1 });

    // Hero banner stats
    const heroBannerUsersEl = document.getElementById('heroBannerUsers');
    const heroBannerGrowthEl = document.getElementById('heroBannerGrowth');
    const heroBannerActiveEl = document.getElementById('heroBannerActive');
    const heroBannerMessageEl = document.getElementById('heroBannerMessage');
    if (heroBannerUsersEl) heroBannerUsersEl.textContent = formatters.number(stats.totalUsers || 0);
    if (heroBannerActiveEl) heroBannerActiveEl.textContent = formatters.number(stats.activeUsers || 0);

    // Calculate today's growth for hero banner
    const todayGrowth = stats.todayNewUsers && stats.totalUsers > 0
      ? ((stats.todayNewUsers / stats.totalUsers) * 100).toFixed(1)
      : 0;
    if (heroBannerGrowthEl) heroBannerGrowthEl.textContent = todayGrowth;

    // Dynamic hero message based on data
    if (heroBannerMessageEl) {
      const totalUsers = stats.totalUsers || 0;
      const paidUsers = stats.paidUsers || 0;
      const activeUsers = stats.activeUsers || 0;
      if (totalUsers === 0) {
        heroBannerMessageEl.textContent = 'Hali foydalanuvchilar yo\'q. Botingizni tarqating!';
      } else if (paidUsers > 0) {
        heroBannerMessageEl.textContent = `${paidUsers} ta pullik obunachi bor. Daromad o'sishda!`;
      } else if (activeUsers > 0) {
        heroBannerMessageEl.textContent = `${activeUsers} ta faol foydalanuvchi. Birinchi sotuvni kutmoqda!`;
      } else {
        heroBannerMessageEl.textContent = `${totalUsers} ta foydalanuvchi ro'yxatdan o'tgan.`;
      }
    }

    // Platform health section
    const activeRatio = stats.totalUsers > 0 ? Math.round(((stats.activeUsers || 0) / stats.totalUsers) * 100) : 0;
    const paidRatio = stats.totalUsers > 0 ? ((stats.paidUsers / stats.totalUsers) * 100).toFixed(1) : 0;
    const healthTitle = (stats.totalUsers || 0) > 0 ? 'Monitoring faol' : 'Data kutilyapti';
    const healthMeta = (stats.totalUsers || 0) > 0
      ? `Jami ${stats.totalUsers} user ichidan ${stats.paidUsers || 0} tasi to'lov qilgan.`
      : 'Userlar qo\'shilgach bu bo\'lim avtomatik to\'ladi.';
    document.getElementById('overviewPaidRatio').textContent = paidRatio + '%';
    document.getElementById('overviewActiveRatio').textContent = activeRatio + '%';
    document.getElementById('overviewHealthTitle').textContent = healthTitle;
    document.getElementById('overviewHealthMeta').textContent = healthMeta;

    // Right panel revenue
    document.getElementById('rightPanelRevenue').textContent = formatters.money(stats.totalRevenue || 0);
    document.getElementById('rightPanelMonthRevenue').textContent = formatters.money(stats.monthRevenue || 0);
    document.getElementById('totalRevenueDisplay').textContent = formatters.money(stats.monthRevenue || stats.totalRevenue || 0);

    // User type counts
    document.getElementById('activeUsersCount').textContent = formatters.number(stats.activeUsers || 0);
    document.getElementById('paidUsersCount').textContent = formatters.number(stats.paidUsers || 0);
    document.getElementById('completedUsersCount').textContent = formatters.number(stats.completedUsers || 0);

    // Show growth badges only if we have growth data from API
    if (stats.growth) {
      updateGrowthBadge('statTotalUsersGrowth', stats.growth.users);
      updateGrowthBadge('statPaidUsersGrowth', stats.growth.paid);
      updateGrowthBadge('statRevenueGrowth', stats.growth.revenue);
      updateGrowthBadge('statConversionGrowth', stats.growth.conversion);
    }

    // Load source and referral stats
    loadSourceStats();
    loadReferralStats();

  } catch(e) { console.error('loadStats error:', e); }
}

function updateGrowthBadge(elementId, growthValue) {
  const el = document.getElementById(elementId);
  if (!el) return;

  if (growthValue === undefined || growthValue === null) {
    el.classList.add('hidden');
    return;
  }

  const value = parseFloat(growthValue);
  const isPositive = value >= 0;
  const icon = el.querySelector('.material-symbols-outlined');
  const valueEl = el.querySelector('.growth-value');

  if (isPositive) {
    el.style.background = 'rgba(34,197,94,0.12)';
    el.style.color = '#22C55E';
    if (icon) icon.textContent = 'trending_up';
    if (valueEl) valueEl.textContent = '+' + Math.abs(value).toFixed(1) + '%';
  } else {
    el.style.background = 'rgba(239,68,68,0.12)';
    el.style.color = '#EF4444';
    if (icon) icon.textContent = 'trending_down';
    if (valueEl) valueEl.textContent = '-' + Math.abs(value).toFixed(1) + '%';
  }

  el.classList.remove('hidden');
}

async function loadSourceStats() {
  try {
    const data = await (await fetch('/api/analytics/sources', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('sourceStatsContainer');

    if (!data.sources || data.sources.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-400 py-4">Hozircha ma\'lumot yo\'q</div>';
      return;
    }

    const total = data.sources.reduce((sum, s) => sum + s.total_users, 0);

    container.innerHTML = '<div class="space-y-3">' + data.sources.map(source => {
      const percent = total > 0 ? Math.round((source.total_users / total) * 100) : 0;
      const sourceName = source.source === 'direct' ? '🌐 Direct (havolasiz)' :
                         source.source === 'instagram' ? '📸 Instagram' :
                         source.source === 'telegram' ? '📱 Telegram' :
                         source.source === 'facebook' ? '👤 Facebook' :
                         source.source === 'youtube' ? '🎬 YouTube' :
                         source.source === 'tiktok' ? '🎵 TikTok' :
                         '🔗 ' + source.source;

      return `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2 min-w-0">
            <span class="text-sm truncate">${sourceName}</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs text-gray-400">${source.paid_users} to'lagan</span>
            <span class="text-sm font-medium">${source.total_users}</span>
            <span class="text-xs text-gray-400">(${percent}%)</span>
          </div>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2">
          <div class="bg-indigo-500 h-2 rounded-full" style="width: ${percent}%"></div>
        </div>
      `;
    }).join('') + '</div>';

  } catch(e) {
    console.error('loadSourceStats error:', e);
    document.getElementById('sourceStatsContainer').innerHTML = '<div class="text-center text-red-400 py-4">Xatolik</div>';
  }
}

async function loadReferralStats() {
  try {
    const data = await (await fetch('/api/analytics/referrals', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('referralStatsContainer');

    const stats = data.stats || { total_referrers: 0, total_referrals: 0, qualified_referrals: 0, discounts_used: 0 };
    const leaderboard = data.leaderboard || [];

    let html = `
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-indigo-600">${stats.total_referrers}</p>
          <p class="text-xs text-gray-500">Taklif qilganlar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-green-600">${stats.qualified_referrals}</p>
          <p class="text-xs text-gray-500">Faol referallar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-blue-600">${stats.total_referrals}</p>
          <p class="text-xs text-gray-500">Jami referallar</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-3 text-center">
          <p class="text-2xl font-bold text-orange-600">${stats.discounts_used}</p>
          <p class="text-xs text-gray-500">Chegirma olganlar</p>
        </div>
      </div>
    `;

    if (leaderboard.length > 0) {
      html += `
        <p class="text-sm font-medium text-gray-600 mb-2">🏆 Top referalchilar:</p>
        <div class="space-y-2">
          ${leaderboard.slice(0, 5).map((u, i) => `
            <div class="flex items-center justify-between text-sm">
              <span>${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i+1) + '.'} ${u.full_name || u.username || u.telegram_id}</span>
              <span class="font-medium text-indigo-600">${u.referral_count} ta</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    container.innerHTML = html;

  } catch(e) {
    console.error('loadReferralStats error:', e);
    document.getElementById('referralStatsContainer').innerHTML = '<div class="text-center text-red-400 py-4">Xatolik</div>';
  }
}

function renderTodayStats() {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  // Set today's date text
  const dateEl = document.getElementById('todayDateText');
  if (dateEl) {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    dateEl.textContent = today.toLocaleDateString('uz-UZ', options);
  }

  // Calculate today's new users
  const todayUsers = allUsers.filter(u => {
    if (!u.created_at) return false;
    return u.created_at.split('T')[0] === todayStr;
  });
  const todayNewUsersEl = document.getElementById('todayNewUsers');
  if (todayNewUsersEl) todayNewUsersEl.textContent = todayUsers.length;

  // Calculate yesterday for comparison
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  const yesterdayUsers = allUsers.filter(u => {
    if (!u.created_at) return false;
    return u.created_at.split('T')[0] === yesterdayStr;
  });

  const changeEl = document.getElementById('todayNewUsersChange');
  if (changeEl) {
    const diff = todayUsers.length - yesterdayUsers.length;
    if (diff > 0) changeEl.innerHTML = '<span class="text-green-300">↑ ' + diff + '</span> kechaga nisbatan';
    else if (diff < 0) changeEl.innerHTML = '<span class="text-red-300">↓ ' + Math.abs(diff) + '</span> kechaga nisbatan';
    else changeEl.textContent = 'Kecha bilan teng';
  }

  // Calculate today's payments
  const todayPayments = allPayments.filter(p => {
    if (!p.created_at || p.status !== 'completed') return false;
    return p.created_at.split('T')[0] === todayStr;
  });
  const todayPaymentsEl = document.getElementById('todayPayments');
  if (todayPaymentsEl) todayPaymentsEl.textContent = todayPayments.length;

  const todayPaymentsAmount = todayPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
  const todayPaymentsAmountEl = document.getElementById('todayPaymentsAmount');
  if (todayPaymentsAmountEl) todayPaymentsAmountEl.textContent = fmtMoney(todayPaymentsAmount);

  // Calculate active users today (users with activity today)
  const todayActiveUsers = allUsers.filter(u => {
    if (!u.last_activity) return false;
    return u.last_activity.split('T')[0] === todayStr;
  });
  const todayLessonsWatchedEl = document.getElementById('todayLessonsWatched');
  if (todayLessonsWatchedEl) todayLessonsWatchedEl.textContent = todayActiveUsers.length;

  // Calculate today's feedback
  const todayFeedbackList = allFeedback.filter(f => {
    if (!f.created_at) return false;
    return f.created_at.split('T')[0] === todayStr;
  });
  const todayFeedbackEl = document.getElementById('todayFeedback');
  if (todayFeedbackEl) todayFeedbackEl.textContent = todayFeedbackList.length;

  const todayPositive = todayFeedbackList.filter(f => f.feedback_type === 'liked').length;
  const todayPositiveEl = document.getElementById('todayFeedbackPositive');
  if (todayPositiveEl) todayPositiveEl.textContent = todayPositive + ' ijobiy';
}

async function loadUsers() {
  try {
    renderUsersTableSkeleton();
    const data = await (await fetch('/api/users', { headers: { Authorization: auth } })).json();
    allUsers = data;
    renderUsers();
    renderRecentUsers();
    renderRecentActivity();
    buildCommandPaletteData();
  } catch(e) { console.error('loadUsers error:', e); addNotification('Users yuklanmadi', 'error'); }
}

async function loadPayments() {
  try {
    renderPaymentsTableSkeleton();
    const data = await (await fetch('/api/payments?all=true', { headers: { Authorization: auth } })).json();
    allPayments = data;
    renderPayments();
    renderRecentPayments();
    renderPaymentStats();
  } catch(e) { console.error('loadPayments error:', e); addNotification('Payments yuklanmadi', 'error'); }
}

async function loadLessons() {
  try {
    const data = await (await fetch('/api/lessons', { headers: { Authorization: auth } })).json();
    allLessons = data.sort((a, b) => a.lesson_number - b.lesson_number);
    renderLessons();
    renderLessonProgress();
    renderLibrary();
  } catch(e) { console.error('loadLessons error:', e); addNotification('Lessons yuklanmadi', 'warn'); }
}

async function loadCustDev() {
  try {
    const data = await (await fetch('/api/custdev', { headers: { Authorization: auth } })).json();
    allCustDev = data;
    renderCustDev();
  } catch(e) { console.error('loadCustDev error:', e); }
}

async function loadCustdevAnswers() {
  try {
    const data = await (await fetch('/api/custdev/answers', { headers: { Authorization: auth } })).json();
    custdevAnswers = data;
    renderCustDevStats();
  } catch(e) { console.error('loadCustdevAnswers error:', e); }
}

async function loadFeedback() {
  try {
    const response = await fetch('/api/feedback', { headers: { Authorization: auth } });
    if (!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    const data = await response.json();
    allFeedback = Array.isArray(data) ? data : [];
    renderFeedback();
  } catch(e) {
    console.error('loadFeedback error:', e);
    const container = document.getElementById('feedbackList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

async function loadConversations() {
  try {
    const response = await fetch('/api/conversations?limit=500', { headers: { Authorization: auth } });
    if (!response.ok) throw new Error('API error: ' + response.status);
    const data = await response.json();
    allConversations = Array.isArray(data) ? data : [];
    renderConversationUsers();
  } catch (e) {
    console.error('loadConversations error:', e);
    const usersContainer = document.getElementById('convUsersList');
    const messagesContainer = document.getElementById('convMessagesList');
    if (usersContainer) usersContainer.innerHTML = '<div class="p-4 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    if (messagesContainer) messagesContainer.innerHTML = '<div class="p-4 text-center text-red-500">Xatolik: ' + e.message + '</div>';
  }
}

async function loadCustomEmojiLibrary(forceRefresh = false) {
  const listEl = document.getElementById('emojiBankList');
  const countEl = document.getElementById('emojiBankCount');
  const progrevListEl = document.getElementById('emojiBankProgrevList');
  const progrevCountEl = document.getElementById('emojiBankProgrevCount');
  try {
    const refreshFlag = forceRefresh ? '1' : '0';
    const [customResp, unicodeResp] = await Promise.all([
      fetch('/api/custom-emojis?limit=400&refresh=' + refreshFlag, { headers: { Authorization: auth } }),
      fetch('/api/unicode-emojis?limit=4000&top=180', { headers: { Authorization: auth } })
    ]);
    if (!customResp.ok) throw new Error('Custom emoji API error: ' + customResp.status);
    if (!unicodeResp.ok) throw new Error('Unicode emoji API error: ' + unicodeResp.status);
    const customData = await customResp.json();
    const unicodeData = await unicodeResp.json();
    customEmojiLibrary = Array.isArray(customData) ? customData : [];
    unicodeEmojiLibrary = Array.isArray(unicodeData) ? unicodeData : [];
    renderCustomEmojiLibrary();
  } catch (e) {
    console.error('loadCustomEmojiLibrary error:', e);
    customEmojiLibrary = [];
    unicodeEmojiLibrary = [];
    if (countEl) countEl.textContent = '0 ta emoji';
    if (listEl) listEl.innerHTML = '<div class="text-xs text-red-500">Emoji bank yuklanmadi</div>';
    if (progrevCountEl) progrevCountEl.textContent = '0 ta emoji';
    if (progrevListEl) progrevListEl.innerHTML = '<div class="text-xs text-red-500">Emoji bank yuklanmadi</div>';
  }
}

function renderCustomEmojiLibrary() {
  clearEmojiLottiePreviews();
  renderCustomEmojiBankInto('emojiBankList', 'emojiBankCount', false);
  renderCustomEmojiBankInto('emojiBankProgrevList', 'emojiBankProgrevCount', true);
  initEmojiLottiePreviews();
}

function clearEmojiLottiePreviews() {
  emojiLottieInstances.forEach((inst) => {
    try { inst.destroy(); } catch (_) {}
  });
  emojiLottieInstances = [];
}

async function initEmojiLottiePreviews() {
  if (typeof window.lottie === 'undefined' || typeof window.pako === 'undefined') return;
  const targets = Array.from(document.querySelectorAll('[data-emoji-tgs-file-id]'));
  for (const container of targets) {
    const fileId = String(container.dataset.emojiTgsFileId || '').trim();
    if (!fileId || container.dataset.emojiLoaded === '1') continue;

    try {
      let animationData = emojiTgsDataCache.get(fileId);
      if (!animationData) {
        const response = await fetch('/api/telegram-file/' + encodeURIComponent(fileId), { headers: { Authorization: auth } });
        if (!response.ok) throw new Error('TGS load failed');
        const ab = await response.arrayBuffer();
        const uint8 = new Uint8Array(ab);
        const jsonText = window.pako.ungzip(uint8, { to: 'string' });
        animationData = JSON.parse(jsonText);
        emojiTgsDataCache.set(fileId, animationData);
      }

      container.innerHTML = '';
      const inst = window.lottie.loadAnimation({
        container,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        animationData
      });
      emojiLottieInstances.push(inst);
      container.dataset.emojiLoaded = '1';
    } catch (e) {
      // fallback text saqlanadi
      container.dataset.emojiLoaded = '0';
    }
  }
}

function renderCustomEmojiBankInto(listId, countId, compact = false) {
  const listEl = document.getElementById(listId);
  const countEl = document.getElementById(countId);
  if (!listEl) return;

  const customItems = (Array.isArray(customEmojiLibrary) ? customEmojiLibrary : [])
    .map((item) => {
      const id = String(item?.custom_emoji_id || '').replace(/\D/g, '');
      if (!id) return null;
      return { ...item, _kind: 'custom', _emojiId: id };
    })
    .filter(Boolean);

  const unicodeItems = (Array.isArray(unicodeEmojiLibrary) ? unicodeEmojiLibrary : [])
    .map((item) => {
      const emoji = String(item?.emoji || '').trim();
      if (!emoji) return null;
      return { ...item, _kind: 'unicode', _unicodeEmoji: emoji };
    })
    .filter(Boolean);

  const items = [...customItems, ...unicodeItems].sort((a, b) => {
    const ad = new Date(a.last_seen_at || 0).getTime();
    const bd = new Date(b.last_seen_at || 0).getTime();
    return bd - ad;
  });

  if (countEl) countEl.textContent = `${items.length} ta emoji`;

  if (!items.length) {
    listEl.innerHTML = '<div class="text-xs text-gray-400">Hozircha custom emoji topilmadi</div>';
    return;
  }

  listEl.innerHTML = items.map((item) => {
    const isUnicode = item._kind === 'unicode';
    const emojiId = item._emojiId || '';
    const unicodeChar = String(item._unicodeEmoji || '🙂');
    const emojiChar = isUnicode ? unicodeChar : String(item.emoji_char || '✨').slice(0, 2);
    // Video custom emoji: file_id bilan video preview.
    // Animated TGS custom emoji: lottie bilan jonli render, bo'lmasa text fallback.
    const mediaFileId = isUnicode ? '' : (item.is_video ? (item.file_id || '') : (item.thumb_file_id || ''));
    const previewSrc = mediaFileId ? `/api/telegram-file/${encodeURIComponent(mediaFileId)}` : '';
    const badge = isUnicode ? 'unicode' : (item.is_video ? 'video anim' : (item.is_animated ? 'anim (live)' : 'static'));
    const seen = Number(item.seen_count || 0);

    const fallbackHtml = `<div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-base">${escapeHtml(emojiChar)}</div>`;
    let previewHtml = fallbackHtml;
    if (previewSrc) {
      if (item.is_video) {
        previewHtml = `<video src="${previewSrc}" autoplay muted loop playsinline class="w-8 h-8 rounded-lg object-cover bg-gray-100" onerror="this.outerHTML='${escapeJsString(fallbackHtml)}'"></video>`;
      } else if (!item.is_animated) {
        previewHtml = `<img src="${previewSrc}" alt="${escapeHtml(emojiChar)}" class="w-8 h-8 rounded-lg object-cover bg-gray-100" loading="lazy" onerror="this.outerHTML='${escapeJsString(fallbackHtml)}'" />`;
      }
    }
    if (!isUnicode && item.is_animated && !item.is_video && item.file_id) {
      previewHtml = `<div data-emoji-tgs-file-id="${escapeHtml(item.file_id)}" class="w-8 h-8 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">${escapeHtml(emojiChar)}</div>`;
    }

    if (compact) {
      const removeBtn = `<button type="button" class="emoji-trash-btn"
             onclick="removeEmojiFromLibrary('${isUnicode ? 'unicode' : 'custom'}', '${escapeJsString(isUnicode ? unicodeChar : emojiId)}', event)" title="Emoji o'chirish">🗑</button>`;
      return `
        <div class="emoji-chip">
          <button type="button" class="emoji-main-btn"
            onclick="${isUnicode ? `insertUnicodeEmojiFromLibrary('${escapeJsString(unicodeChar)}')` : `insertCustomEmojiFromLibrary('${emojiId}')`}"
            title="${escapeHtml(isUnicode ? emojiChar : emojiId)}">
            <div class="flex items-center gap-2 justify-center">
              ${previewHtml}
              <span class="text-sm font-semibold text-gray-700">${escapeHtml(emojiChar)}</span>
            </div>
          </button>
          <div class="mt-2 flex justify-end">${removeBtn}</div>
        </div>
      `;
    }

    const removeBtn = `<button type="button" class="ml-2 px-2 py-1 rounded-md border border-red-200 text-red-500 hover:bg-red-50 hover:border-red-300 text-xs"
           onclick="removeEmojiFromLibrary('${isUnicode ? 'unicode' : 'custom'}', '${escapeJsString(isUnicode ? unicodeChar : emojiId)}', event)">🗑</button>`;
    return `
      <div class="w-full rounded-lg border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50 px-2 py-2">
        <button type="button" class="w-full text-left"
          onclick="${isUnicode ? `insertUnicodeEmojiFromLibrary('${escapeJsString(unicodeChar)}')` : `insertCustomEmojiFromLibrary('${emojiId}')`}">
          <div class="flex items-center gap-2">
            ${previewHtml}
            <div class="min-w-0 flex-1">
              <p class="text-xs font-medium text-gray-700 truncate">${escapeHtml(emojiChar)} • ${escapeHtml(isUnicode ? 'unicode' : emojiId)}</p>
              <p class="text-[11px] text-gray-500">${escapeHtml(badge)} • ishlatilgan: ${seen}</p>
            </div>
          </div>
        </button>
        <div class="mt-2 flex justify-end">${removeBtn}</div>
      </div>
    `;
  }).join('');

}

function renderConversationUsers() {
  const usersContainer = document.getElementById('convUsersList');
  if (!usersContainer) return;

  const byUser = new Map();
  allConversations.forEach(m => {
    const current = byUser.get(m.telegram_id);
    if (!current) {
      byUser.set(m.telegram_id, m);
    } else {
      const oldTime = new Date(current.created_at).getTime();
      const newTime = new Date(m.created_at).getTime();
      if (newTime > oldTime) byUser.set(m.telegram_id, m);
    }
  });

  const query = (document.getElementById('convSearch')?.value || '').toLowerCase().trim();
  const users = Array.from(byUser.values())
    .filter(u => {
      if (!query) return true;
      const name = (u.full_name || '').toLowerCase();
      const username = (u.username || '').toLowerCase();
      const tg = String(u.telegram_id || '');
      return name.includes(query) || username.includes(query) || tg.includes(query);
    })
    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  if (!users.length) {
    usersContainer.innerHTML = '<div class="p-4 text-center text-gray-400">Suhbatlar topilmadi</div>';
    return;
  }

  usersContainer.innerHTML = users.map(u => {
    const name = u.full_name || u.username || ('User ' + u.telegram_id);
    const username = u.username ? '@' + u.username : '';
    const initial = (name || 'U').charAt(0).toUpperCase();
    const activeClass = String(selectedConversationUserId) === String(u.telegram_id) ? 'active' : '';
    const preview = getConversationPreview(u);
    return `
      <button class="conv-user-item ${activeClass}" onclick="openConversationUser(${u.telegram_id})">
        <div class="flex items-start gap-3">
          <div class="conv-avatar">${escapeHtml(initial)}</div>
          <div class="min-w-0 flex-1">
            <p class="font-medium text-gray-800 truncate">${escapeHtml(name)}</p>
            <p class="text-xs text-gray-400 truncate">${escapeHtml(username)} • ${u.telegram_id}</p>
            <p class="text-xs text-gray-500 mt-1 truncate">${escapeHtml(preview)}</p>
          </div>
          <span class="text-[10px] text-gray-400">${timeAgo(u.created_at)}</span>
        </div>
      </button>
    `;
  }).join('');

  if (!selectedConversationUserId && users[0]) {
    openConversationUser(users[0].telegram_id);
  }
}

async function openConversationUser(telegramId) {
  selectedConversationUserId = telegramId;
  renderConversationUsers();

  const header = document.getElementById('convSelectedUser');
  const headerMeta = document.getElementById('convSelectedUserMeta');
  const headerAvatar = document.getElementById('convHeaderAvatar');
  const messagesContainer = document.getElementById('convMessagesList');
  if (!messagesContainer) return;

  try {
    const res = await fetch('/api/conversations/' + telegramId + '?limit=400', { headers: { Authorization: auth } });
    if (!res.ok) throw new Error('API error: ' + res.status);
    const rows = await res.json();
    const messages = Array.isArray(rows) ? rows : [];

    const user = allUsers.find(u => String(u.telegram_id) === String(telegramId));
    const userName = user?.full_name || user?.username || ('User ' + telegramId);
    if (header) header.textContent = userName;
    if (headerAvatar) headerAvatar.textContent = (userName || 'U').charAt(0).toUpperCase();
    fillConversationUserInfo(user || { telegram_id: telegramId, username: null, phone: null, current_lesson: 0, is_paid: false, full_name: userName });

    if (!messages.length) {
      messagesContainer.innerHTML = '<div class="text-center text-gray-400">Xabarlar yoq</div>';
      return;
    }

    const latest = messages[0];
    const latestMeta = normalizeMessageMeta(latest.meta);
    if (headerMeta) {
      const username = user?.username ? '@' + user.username : 'username yoq';
      const lesson = latestMeta.current_lesson ?? '-';
      const funnel = latestMeta.funnel_step ?? '-';
      headerMeta.textContent = `${username} • ID ${telegramId} • dars ${lesson} • step ${funnel}`;
    }

    const timeline = messages.slice().reverse();
    messagesContainer.innerHTML = timeline
      .map((m, idx) => {
        const metaObj = normalizeMessageMeta(m.meta);
        const text = formatConversationMessage(m, metaObj);
        const mediaPreview = buildMediaPreviewHtml(m, metaObj);
        const isAction = m.message_type === 'callback';
        const isOutgoing = m.message_type === 'admin_outgoing';
        const isBotOutgoing = String(m.message_type || '').startsWith('bot_outgoing_');
        const isIncomingUser = !isOutgoing && !isBotOutgoing;
        const rowClass = isOutgoing ? 'user' : 'incoming';
        const bubbleClass = isOutgoing ? 'user' : '';
        const tag = isOutgoing
          ? '🧑‍💼 admin'
          : (isBotOutgoing ? '🤖 bot' : (isAction ? '🔘 button' : (m.message_type || 'text')));
        const stepInfo = `d:${metaObj.current_lesson ?? '-'} s:${metaObj.funnel_step ?? '-'}`;
        let replyContext = '';
        if (isIncomingUser) {
          for (let i = idx - 1; i >= 0; i--) {
            const prev = timeline[i];
            const prevType = String(prev.message_type || '');
            if (prevType === 'admin_outgoing' || prevType.startsWith('bot_outgoing_')) {
              const prevText = formatConversationMessage(prev, normalizeMessageMeta(prev.meta));
              replyContext = prevText ? prevText.slice(0, 90) : '';
              break;
            }
          }
        }
        const messageId = metaObj.message_id || null;
        return `
          <div class="tg-bubble-row ${rowClass}">
            <div class="tg-bubble ${bubbleClass} ${isAction ? 'action' : ''}" ${messageId ? `data-message-id="${messageId}" onclick="setConversationReplyTo(${messageId}, '${escapeJsString(text.slice(0, 120))}')"` : ''} style="${messageId ? 'cursor:pointer;' : ''}">
              <span class="tg-tag">${escapeHtml(tag)}</span>
              ${replyContext ? `<p class="text-[11px] text-gray-500 mb-1">↪ Javob berilgan xabar: ${escapeHtml(replyContext)}</p>` : ''}
              <p class="text-sm text-gray-800 whitespace-pre-wrap break-words">${escapeHtml(text)}</p>
              ${mediaPreview}
              <div class="tg-meta">
                <span>${escapeHtml(stepInfo)}</span>
                <span>${fmtDateTime(m.created_at).split(' ')[1] || fmtDateTime(m.created_at)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  } catch (e) {
    console.error('openConversationUser error:', e);
    messagesContainer.innerHTML = '<div class="text-center text-red-500">Xatolik: ' + e.message + '</div>';
  }
}

function fillConversationUserInfo(user) {
  const set = (id, v) => {
    const el = document.getElementById(id);
    if (el) el.textContent = v ?? '-';
  };
  set('convInfoName', user.full_name || user.username || '-');
  set('convInfoUsername', user.username ? '@' + user.username : '-');
  set('convInfoTgId', user.telegram_id || '-');
  set('convInfoPhone', user.phone || '-');
  set('convInfoLesson', (user.current_lesson ?? 0) + '-dars');
  set('convInfoStatus', user.is_paid ? 'Premium' : 'Free');
}

function handleConvReplyKey(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendConversationReply();
  }
}

async function sendConversationReply() {
  if (!selectedConversationUserId) {
    alert('Avval user tanlang');
    return;
  }
  const input = document.getElementById('convReplyInput');
  const stickerInput = document.getElementById('convStickerFileId');
  const parseModeSelect = document.getElementById('convParseMode');
  const disablePreviewEl = document.getElementById('convDisablePreview');
  const btn = document.getElementById('convReplyBtn');
  const text = (input?.value || '').trim();
  const stickerFileId = (stickerInput?.value || '').trim();
  let parseMode = (parseModeSelect?.value || 'HTML');
  const hasHtmlTags = /<[^>]+>/.test(text);
  if (parseMode === 'MarkdownV2' && hasHtmlTags) {
    parseMode = 'HTML';
    if (parseModeSelect) parseModeSelect.value = 'HTML';
  }
  const disableLinkPreview = !!disablePreviewEl?.checked;
  if (!text && !stickerFileId) return;

  try {
    if (btn) btn.disabled = true;
    const res = await fetch('/api/conversations/' + selectedConversationUserId + '/reply', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        sticker_file_id: stickerFileId,
        parse_mode: parseMode,
        disable_link_preview: disableLinkPreview,
        reply_to_message_id: selectedReplyToMessageId || null
      })
    });
    if (!res.ok) {
      const payload = await res.json().catch(() => ({}));
      throw new Error(payload.error || ('API error: ' + res.status));
    }
    if (input) input.value = '';
    if (stickerInput) stickerInput.value = '';
    clearConversationReplyTo();
    await loadConversations();
    await openConversationUser(selectedConversationUserId);
  } catch (e) {
    alert('Xatolik: ' + e.message);
  } finally {
    if (btn) btn.disabled = false;
  }
}

function insertQuickReply(text) {
  const input = document.getElementById('convReplyInput');
  if (!input) return;
  input.value = text;
  input.focus();
}

function setConversationReplyTo(messageId, snippet) {
  selectedReplyToMessageId = Number(messageId) || null;
  selectedReplyToSnippet = snippet || '';
  const bar = document.getElementById('convReplyToBar');
  const textEl = document.getElementById('convReplyToText');
  if (bar) bar.classList.remove('hidden');
  if (textEl) textEl.textContent = selectedReplyToSnippet;
}

function clearConversationReplyTo() {
  selectedReplyToMessageId = null;
  selectedReplyToSnippet = '';
  const bar = document.getElementById('convReplyToBar');
  const textEl = document.getElementById('convReplyToText');
  if (bar) bar.classList.add('hidden');
  if (textEl) textEl.textContent = '';
}

function wrapReplySelection(kind) {
  wrapTextareaSelection('convReplyInput', kind);
}

function wrapTextareaSelection(textareaId, kind) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const start = input.selectionStart ?? 0;
  const end = input.selectionEnd ?? 0;
  const selected = input.value.slice(start, end) || 'text';
  const map = {
    b: ['<b>', '</b>'],
    i: ['<i>', '</i>'],
    u: ['<u>', '</u>'],
    s: ['<s>', '</s>'],
    spoiler: ['<tg-spoiler>', '</tg-spoiler>'],
    blockquote: ['<blockquote>', '</blockquote>'],
    blockquote_expand: ['<blockquote expandable>', '</blockquote>'],
    code: ['<code>', '</code>']
  };
  const pair = map[kind];
  if (!pair) return;
  const [open, close] = pair;
  const insert = open + selected + close;
  input.value = input.value.slice(0, start) + insert + input.value.slice(end);
  const pos = start + insert.length;
  input.focus();
  input.setSelectionRange(pos, pos);
}

function initProgrevFormatEditors() {
  const container = document.getElementById('tab-progrev');
  if (!container) return;
  const fields = container.querySelectorAll('textarea, input[type="text"]');
  fields.forEach((el) => {
    if (el.dataset.progrevFormatBound === '1') return;
    el.dataset.progrevFormatBound = '1';
    el.addEventListener('focus', () => setActiveProgrevEditor(el.id));
    el.addEventListener('click', () => setActiveProgrevEditor(el.id));
  });
}

function setActiveProgrevEditor(editorId) {
  activeProgrevEditorId = editorId || null;
  const label = document.getElementById('progrevActiveEditorLabel');
  if (!label) return;
  if (!activeProgrevEditorId) {
    label.textContent = 'Maydon tanlanmagan';
    return;
  }
  const el = document.getElementById(activeProgrevEditorId);
  const fieldLabel = el?.closest('div')?.querySelector('label')?.textContent?.trim() || activeProgrevEditorId;
  label.textContent = `Aktiv maydon: ${fieldLabel}`;
}

function applyProgrevFormat(kind) {
  if (!activeProgrevEditorId) {
    alert("Avval biror matn maydonini tanlang");
    return;
  }
  if (kind === 'link') {
    insertLinkTemplateTo(activeProgrevEditorId);
    return;
  }
  if (kind === 'emoji') {
    insertCustomEmojiTemplateTo(activeProgrevEditorId);
    return;
  }
  wrapTextareaSelection(activeProgrevEditorId, kind);
}

function insertLinkTemplate() {
  insertLinkTemplateTo('convReplyInput');
}

function insertCustomEmojiTemplate() {
  insertCustomEmojiTemplateTo('convReplyInput');
}

function insertLinkTemplateTo(textareaId) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const text = '<a href="https://example.com">Link text</a>';
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0, start) + text + input.value.slice(end);
  input.focus();
}

function insertCustomEmojiTemplateTo(textareaId) {
  const input = document.getElementById(textareaId);
  if (!input) return;
  const text = '<tg-emoji emoji-id="5368324170671202286">✨</tg-emoji>';
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0, start) + text + input.value.slice(end);
  input.focus();
}

function insertCustomEmojiFromLibrary(customEmojiId) {
  const safeId = String(customEmojiId || '').replace(/\D/g, '');
  if (!safeId) return;
  const tag = `<tg-emoji emoji-id="${safeId}">✨</tg-emoji>`;
  insertTextIntoBestEditor(tag);
}

function insertUnicodeEmojiFromLibrary(emojiChar) {
  const safeEmoji = String(emojiChar || '').trim();
  if (!safeEmoji) return;
  insertTextIntoBestEditor(safeEmoji);
}

async function removeEmojiFromLibrary(kind, value, event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }

  const safeKind = String(kind || '').trim();
  if (safeKind !== 'custom' && safeKind !== 'unicode') return;

  const rawValue = String(value || '').trim();
  const safeValue = safeKind === 'custom' ? rawValue.replace(/\D/g, '') : rawValue;
  if (!safeValue) return;

  const label = safeKind === 'custom' ? `ID: ${safeValue}` : `Emoji: ${safeValue}`;
  const confirmed = confirm(`Emoji o'chirilsinmi?\n${label}`);
  if (!confirmed) return;

  try {
    const endpoint = safeKind === 'custom'
      ? '/api/custom-emojis/' + encodeURIComponent(safeValue)
      : '/api/unicode-emojis/' + encodeURIComponent(safeValue);
    const res = await fetch(endpoint, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || ('API error: ' + res.status));

    if (safeKind === 'custom') {
      customEmojiLibrary = (Array.isArray(customEmojiLibrary) ? customEmojiLibrary : [])
        .filter((item) => String(item?.custom_emoji_id || '').replace(/\D/g, '') !== safeValue);
    } else {
      unicodeEmojiLibrary = (Array.isArray(unicodeEmojiLibrary) ? unicodeEmojiLibrary : [])
        .filter((item) => String(item?.emoji || '').trim() !== safeValue);
    }

    renderCustomEmojiLibrary();
    showToast('Emoji o\'chirildi');
  } catch (e) {
    console.error('removeEmojiFromLibrary error:', e);
    showToast('O\'chirishda xatolik: ' + e.message, 'error');
  }
}

function insertTextIntoBestEditor(text) {
  const active = document.activeElement;
  const isTextInput = active && (
    active.tagName === 'TEXTAREA' ||
    (active.tagName === 'INPUT' && (active.type === 'text' || active.type === 'search'))
  );

  if (isTextInput && typeof active.value === 'string') {
    const start = active.selectionStart ?? active.value.length;
    const end = active.selectionEnd ?? active.value.length;
    active.value = active.value.slice(0, start) + text + active.value.slice(end);
    active.focus();
    return;
  }

  if (activeProgrevEditorId) {
    const target = document.getElementById(activeProgrevEditorId);
    if (target && typeof target.value === 'string') {
      const start = target.selectionStart ?? target.value.length;
      const end = target.selectionEnd ?? target.value.length;
      target.value = target.value.slice(0, start) + text + target.value.slice(end);
      target.focus();
      return;
    }
  }

  const convInput = document.getElementById('convReplyInput');
  if (convInput) {
    const start = convInput.selectionStart ?? convInput.value.length;
    const end = convInput.selectionEnd ?? convInput.value.length;
    convInput.value = convInput.value.slice(0, start) + text + convInput.value.slice(end);
    convInput.focus();
  }
}

function normalizeMessageMeta(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  try { return JSON.parse(meta); } catch { return {}; }
}

function formatConversationMessage(message, metaObj) {
  if (message.message_type === 'callback') {
    return `Tugma bosildi: ${humanizeCallbackData(message.text_content || 'callback')}`;
  }
  if (message.message_type === 'admin_outgoing') {
    return message.text_content || '';
  }
  if (message.message_type === 'bot_outgoing_video') return message.text_content || '🎬 Video yuborildi';
  if (message.message_type === 'bot_outgoing_photo') return message.text_content || '🖼 Rasm yuborildi';
  if (message.message_type === 'bot_outgoing_voice') return message.text_content || '🎤 Ovozli xabar yuborildi';
  if (message.message_type === 'bot_outgoing_audio') return message.text_content || '🎵 Audio yuborildi';
  if (message.message_type === 'bot_outgoing_video_note') return message.text_content || '🔵 Video note yuborildi';
  if (message.message_type === 'bot_outgoing_document') return message.text_content || '📎 Hujjat yuborildi';
  if (message.message_type === 'bot_outgoing_sticker') return message.text_content || '🎭 Sticker yuborildi';
  if (message.message_type === 'bot_outgoing_text') return message.text_content || '';
  if (message.message_type === 'admin_outgoing_sticker') return '🎭 Siz sticker yubordingiz';
  if (message.message_type === 'contact') {
    return `Kontakt yuborildi: ${message.text_content || ''}`.trim();
  }
  if (message.text_content) {
    return message.text_content;
  }
  return `(${message.message_type || 'event'})`;
}

function getConversationPreview(message) {
  if (!message) return '';
  if (message.message_type === 'callback') return 'Tugma: ' + humanizeCallbackData(message.text_content || '');
  if (message.message_type === 'admin_outgoing') return 'Siz: ' + (message.text_content || '');
  if (message.message_type === 'admin_outgoing_sticker') return 'Siz: sticker yubordingiz';
  if (message.message_type && message.message_type.startsWith('bot_outgoing_')) return formatConversationMessage(message, {});
  if (message.text_content) return message.text_content;
  return '(' + (message.message_type || 'event') + ')';
}

function humanizeCallbackData(data) {
  const raw = String(data || '');
  let m;

  if ((m = raw.match(/^watched_(\d+)$/))) return `${m[1]}-dars: "ko'rib bo'ldim"`;
  if ((m = raw.match(/^watched_funnel_(\d+)_(\d+)$/))) return `Funnel ${m[1]}, ${m[2]}-dars ko'rildi`;
  if ((m = raw.match(/^cd_(\d+)_(.+)$/))) return `CustDev savol ${m[1]} javobi: ${decodeURIComponentSafe(m[2])}`;
  if ((m = raw.match(/^fcd_(\d+)_(\d+)_(\d+)_(.+)$/))) return `Funnel CustDev javobi: ${decodeURIComponentSafe(m[4])}`;
  if ((m = raw.match(/^check_subscription_?(\d*)$/))) return `Obuna tekshirish${m[1] ? ` (${m[1]}-dars)` : ''}`;
  if ((m = raw.match(/^check_funnel_sub_(\d+)_(\d+)$/))) return `Funnel obuna tekshirish (funnel ${m[1]}, lesson ${m[2]})`;
  if (raw === 'feedback_yes') return 'Feedback: Ha, yoqdi';
  if (raw === 'feedback_no') return 'Feedback: Yoqmadi';
  if ((m = raw.match(/^plan_(.+)$/))) return `Tarif tanlandi: ${m[1]}`;
  if ((m = raw.match(/^extend_(.+)$/))) return `Obuna uzaytirish tarifi: ${m[1]}`;
  if ((m = raw.match(/^discount_plan_(\d+)_(.+)$/))) return `${m[1]}% chegirma tarifi: ${m[2]}`;
  if ((m = raw.match(/^resume_[lf]:(.+)$/))) return `Davom etish: ${m[1]}`;
  if (raw === 'question') return 'Savolim bor tugmasi';
  if (raw === 'back_to_plans') return 'Tariflarga qaytish';
  if (raw === 'cancel_extend') return 'Uzaytirishni bekor qilish';
  return raw;
}

function decodeURIComponentSafe(value) {
  try { return decodeURIComponent(value); } catch { return value; }
}

function escapeJsString(value) {
  return String(value || '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/\n/g, ' ')
    .replace(/\r/g, ' ');
}

function buildMediaPreviewHtml(message, metaObj) {
  const type = String(message?.message_type || '');
  const fileRef = metaObj?.file_ref || metaObj?.file_id || metaObj?.sticker_file_id;
  if (!fileRef) return '';

  const src = '/api/telegram-file/' + encodeURIComponent(fileRef);

  if (type.includes('photo')) {
    return `<div class="mt-2">
      <img src="${src}" alt="preview" class="rounded-xl border border-gray-200 max-h-[220px] object-cover" loading="lazy" />
    </div>`;
  }

  if (type.includes('video') && !type.includes('video_note')) {
    return `<div class="mt-2">
      <video src="${src}" controls preload="metadata" class="rounded-xl border border-gray-200 max-h-[260px] w-full bg-black/80"></video>
    </div>`;
  }

  if (type.includes('video_note')) {
    return `<div class="mt-2">
      <video src="${src}" controls preload="metadata" class="rounded-full border border-gray-200 w-[180px] h-[180px] bg-black/80 object-cover"></video>
    </div>`;
  }

  if (type.includes('audio') || type.includes('voice')) {
    return `<div class="mt-2">
      <audio src="${src}" controls preload="metadata" class="w-full"></audio>
    </div>`;
  }

  if (type.includes('document')) {
    return `<div class="mt-2 text-xs">
      <a href="${src}" target="_blank" class="text-indigo-600 underline">📎 Hujjatni ochish</a>
    </div>`;
  }

  if (type.includes('sticker')) {
    return `<div class="mt-2">
      <img src="${src}" alt="sticker" class="max-h-[180px] max-w-[180px] rounded-lg border border-gray-200" loading="lazy" />
    </div>`;
  }

  return '';
}

// ========== MEDIA LIBRARY ==========
let allMedia = [];

async function loadMediaLibrary() {
  try {
    const filterType = document.getElementById('mediaTypeFilter')?.value || 'all';
    const url = filterType === 'all' ? '/api/media' : '/api/media/' + filterType;
    const data = await (await fetch(url, { headers: { Authorization: auth } })).json();
    allMedia = Array.isArray(data) ? data : [];
    renderMediaLibrary();
  } catch(e) {
    console.error('loadMediaLibrary error:', e);
    const container = document.getElementById('mediaLibraryList');
    if (container) {
      container.innerHTML = '<div class="p-8 text-center text-red-500">Xatolik: ' + e.message + '</div>';
    }
  }
}

function renderMediaLibrary() {
  const container = document.getElementById('mediaLibraryList');
  if (!container) return;

  // Calculate stats
  const videoCount = allMedia.filter(m => m.file_type === 'video').length;
  const photoCount = allMedia.filter(m => m.file_type === 'photo').length;
  const audioCount = allMedia.filter(m => m.file_type === 'audio' || m.file_type === 'voice').length;
  const videoNoteCount = allMedia.filter(m => m.file_type === 'video_note').length;

  document.getElementById('mediaStatsTotal').textContent = allMedia.length;
  document.getElementById('mediaStatsVideo').textContent = videoCount;
  document.getElementById('mediaStatsPhoto').textContent = photoCount;
  document.getElementById('mediaStatsAudio').textContent = audioCount;
  document.getElementById('mediaStatsVideoNote').textContent = videoNoteCount;

  if (!allMedia.length) {
    container.innerHTML = `<div class="p-8 text-center text-gray-400">
      <p class="mb-2">Hali media yo'q</p>
      <p class="text-xs">Botga video, rasm yoki audio yuboring - bu yerda ko'rinadi</p>
    </div>`;
    return;
  }

  container.innerHTML = allMedia.map(m => {
    const time = timeAgo(m.created_at);

    // Get icon and color based on type
    let icon = '📎';
    let color = 'gray';
    let typeName = m.file_type;

    if (m.file_type === 'video') { icon = '🎬'; color = 'blue'; typeName = 'Video'; }
    else if (m.file_type === 'photo') { icon = '🖼'; color = 'green'; typeName = 'Rasm'; }
    else if (m.file_type === 'voice') { icon = '🎤'; color = 'orange'; typeName = 'Ovozli'; }
    else if (m.file_type === 'audio') { icon = '🎵'; color = 'orange'; typeName = 'Audio'; }
    else if (m.file_type === 'video_note') { icon = '⚪'; color = 'purple'; typeName = 'Video xabar'; }

    const caption = m.caption ? m.caption.slice(0, 50) + (m.caption.length > 50 ? '...' : '') : '';
    const fileName = m.file_name || 'Nomsiz';
    const safeCaption = (m.caption || '').replace(/'/g, "\\'");

    return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">' +
      '<div class="flex items-center gap-3 flex-1 min-w-0">' +
        '<span class="text-2xl">' + icon + '</span>' +
        '<div class="flex-1 min-w-0">' +
          '<div class="flex items-center gap-2">' +
            '<span class="badge badge-' + color + ' text-xs">' + typeName + '</span>' +
            '<span class="text-xs text-gray-400">' + time + '</span>' +
          '</div>' +
          '<p class="text-sm font-medium text-gray-700 truncate" title="' + fileName + '">' + fileName + '</p>' +
          (caption ? '<p class="text-xs text-gray-500 truncate">' + caption + '</p>' : '') +
        '</div>' +
      '</div>' +
      '<div class="flex items-center gap-2 ml-2">' +
        '<button onclick="copyMediaId(\'' + m.file_id + '\')" class="btn btn-secondary text-xs px-2 py-1" title="File ID nusxalash">📋</button>' +
        '<button onclick="editMediaCaption(' + m.id + ', \'' + safeCaption + '\', \'' + m.file_id + '\')" class="btn btn-secondary text-xs px-2 py-1" title="Izoh o\'zgartirish">✏️</button>' +
        '<button onclick="deleteMediaItem(' + m.id + ')" class="btn btn-danger text-xs px-2 py-1" title="O\'chirish">🗑</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function copyMediaId(fileId) {
  navigator.clipboard.writeText(fileId).then(() => {
    showToast('✅ File ID nusxalandi!');
  }).catch(e => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = fileId;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('✅ File ID nusxalandi!');
  });
}

function editMediaCaption(id, currentCaption, fileId) {
  const newCaption = prompt('Yangi izoh kiriting:', currentCaption);
  if (newCaption === null) return; // cancelled

  fetch('/api/media/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', Authorization: auth },
    body: JSON.stringify({ caption: newCaption })
  })
  .then(r => r.json())
  .then(() => {
    showToast('✅ Izoh saqlandi!');
    loadMediaLibrary();
  })
  .catch(e => {
    showToast('❌ Xatolik: ' + e.message);
  });
}

async function deleteMediaItem(id) {
  if (!confirm("Bu media faylni o'chirishni xohlaysizmi?")) return;

  try {
    await fetch('/api/media/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    showToast("✅ Media o'chirildi!");
    loadMediaLibrary();
  } catch(e) {
    showToast('❌ Xatolik: ' + e.message);
  }
}

function renderFeedback() {
  const container = document.getElementById('feedbackList');
  const filter = document.getElementById('feedbackFilter')?.value || 'all';

  // Filter feedbacks
  let filteredFeedback = allFeedback;
  if (filter !== 'all') {
    filteredFeedback = allFeedback.filter(f => f.feedback_type === filter);
  }

  // Update stats
  const liked = allFeedback.filter(f => f.feedback_type === 'liked').length;
  const notLiked = allFeedback.filter(f => f.feedback_type === 'not_liked' || f.feedback_type === 'disliked_reason').length;

  document.getElementById('feedbackLikedCount').textContent = liked;
  document.getElementById('feedbackDislikedCount').textContent = notLiked;
  document.getElementById('feedbackTotalCount').textContent = allFeedback.length;

  if (!filteredFeedback.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Feedback yo\'q<br><span class="text-xs">Bu yerda 4-darsdan keyin "Yoqdi/Yoqmadi" bosgan foydalanuvchilar ko\'rinadi</span></div>';
    return;
  }

  container.innerHTML = filteredFeedback.map(f => {
    const time = timeAgo(f.created_at);
    const name = f.full_name || f.username || 'Noma\'lum';

    let typeIcon = '💬';
    let typeBadge = 'badge-gray';
    let typeText = 'Feedback';

    if (f.feedback_type === 'liked') {
      typeIcon = '👍';
      typeBadge = 'badge-green';
      typeText = 'Yoqdi';
    } else if (f.feedback_type === 'not_liked') {
      typeIcon = '👎';
      typeBadge = 'badge-red';
      typeText = 'Yoqmadi';
    } else if (f.feedback_type === 'disliked_reason') {
      typeIcon = '📝';
      typeBadge = 'badge-orange';
      typeText = 'Sabab';
    }

    return `
      <div class="p-4 hover:bg-gray-50 transition-colors">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-lg flex-shrink-0">
            ${typeIcon}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap mb-1">
              <span class="font-medium text-gray-800">${name}</span>
              <span class="badge ${typeBadge}">${typeText}</span>
              <span class="text-xs text-gray-400">${time}</span>
            </div>
            ${f.feedback_text ? `
              <p class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 mt-2">${f.feedback_text}</p>
            ` : ''}
            <div class="flex items-center gap-3 mt-2 text-xs text-gray-400">
              ${f.phone ? `<span>📱 ${f.phone}</span>` : ''}
              <span>ID: ${f.telegram_id}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function filterFeedback() {
  renderFeedback();
}

function togglePitchMediaFields() {
  const mediaType = document.getElementById('pitchMediaType').value;

  // Hide all media fields
  document.getElementById('pitchMediaVideoField').classList.add('hidden');
  document.getElementById('pitchMediaAudioField').classList.add('hidden');
  document.getElementById('pitchMediaImageField').classList.add('hidden');
  document.getElementById('pitchMediaVideoNoteField').classList.add('hidden');

  // Show selected field
  if (mediaType === 'video') {
    document.getElementById('pitchMediaVideoField').classList.remove('hidden');
  } else if (mediaType === 'audio') {
    document.getElementById('pitchMediaAudioField').classList.remove('hidden');
  } else if (mediaType === 'image') {
    document.getElementById('pitchMediaImageField').classList.remove('hidden');
  } else if (mediaType === 'video_note') {
    document.getElementById('pitchMediaVideoNoteField').classList.remove('hidden');
  }
}

async function loadProgrevSettings() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    // Start messages
    document.getElementById('startWelcomeText').value = data.welcome || '';
    document.getElementById('startAskNameText').value = data.ask_name || '';

    // Step 1: Congrats
    document.getElementById('congratsText').value = data.congrats_text || '';

    // Step 2: Feedback question
    document.getElementById('feedbackEnabled').checked = data.feedback_enabled !== false;
    document.getElementById('pitchDelayMinutes').value = data.pitch_delay_minutes || 0;
    document.getElementById('feedbackQuestion').value = data.feedback_question || 'Bepul darslar yoqdimi? 🤔';
    document.getElementById('feedbackYesBtn').value = data.feedback_yes_btn || '👍 Ha, juda yoqdi!';
    document.getElementById('feedbackNoBtn').value = data.feedback_no_btn || '😐 Unchalik emas';

    // Step 3: Pitch info (after "Ha")
    document.getElementById('pitchInfoText').value = data.pitch_info_text || '🎉 Ajoyib tanlov!\n\nTo\'liq kursda sizni kutmoqda:\n✅ 50+ dars\n✅ Amaliy topshiriqlar\n✅ Sertifikat\n\nHoziroq ro\'yxatdan o\'ting! 👇';
    document.getElementById('pitchInfoBtn').value = data.pitch_info_btn || '🚀 Kursga yozilish';

    // Pitch media
    document.getElementById('pitchVideoFileId').value = data.pitch_video_file_id || '';
    document.getElementById('pitchAudioFileId').value = data.pitch_audio_file_id || '';
    document.getElementById('pitchImageFileId').value = data.pitch_image_file_id || '';
    document.getElementById('pitchVideoNoteFileId').value = data.pitch_video_note_file_id || '';
    let mediaType = 'none';
    if (data.pitch_video_file_id) mediaType = 'video';
    else if (data.pitch_audio_file_id) mediaType = 'audio';
    else if (data.pitch_image_file_id) mediaType = 'image';
    else if (data.pitch_video_note_file_id) mediaType = 'video_note';
    if (data.pitch_media_type) mediaType = data.pitch_media_type;
    document.getElementById('pitchMediaType').value = mediaType;
    togglePitchMediaFields();

    // Step 3b: Negative response
    document.getElementById('feedbackNoResponse').value = data.feedback_no_response || '😔 Tushunaman. Iltimos, nimada kamchilik borligini yozing...';
    document.getElementById('feedbackFollowup').value = data.feedback_followup || '';
    document.getElementById('feedbackSpecialOfferEnabled').checked = data.feedback_special_offer_enabled || false;
    document.getElementById('feedbackSpecialOffer').value = data.feedback_special_offer || '';
    document.getElementById('feedbackNoSalesDelay').value = data.feedback_no_sales_delay || 30;

    // Step 4: Sales pitch
    document.getElementById('salesPitchText').value = data.sales_pitch || '';
    document.getElementById('salesDelayMinutes').value = data.sales_delay_minutes || 0;

    // Step 5: Soft attack
    document.getElementById('softAttackDisabled').checked = data.soft_attack_disabled || false;
    document.getElementById('softAttackText').value = data.soft_attack_text || '';
    document.getElementById('softAttackDelayMinutes').value = data.soft_attack_delay_minutes || 1440;

    // Lesson completion defaults
    document.getElementById('watchedMessageDefault').value = data.watched_message_default || '';
    document.getElementById('watchedButtonDefault').value = data.watched_button_default || '';
  } catch(e) { console.error('loadProgrevSettings error:', e); }
}

// ========== RENDER FUNCTIONS ==========
function renderUsers() {
  // Use new advanced filter system
  applyUserFilters();
}

function goToPage(page) {
  currentPage = page;
  applyUserFilters();
}

function searchUsers() {
  // Deprecated - use applyUserFilters instead
  applyUserFilters();
}

function searchUsersOld() {
  const query = document.getElementById('userSearch').value.toLowerCase();
  if (!query) { renderUsers(); return; }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  );

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = filtered.slice(0, 20).map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid
          ? (u.joined_premium_channel
              ? '<span class="badge badge-green">Premium</span>'
              : '<span class="badge badge-orange" title="To\'lagan, lekin kanalga qo\'shilmagan">To\'lagan ❌</span>')
          : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">👁</button>
      </td>
    </tr>
  `).join('');
}

function renderRecentUsers() {
  const recent = allUsers.slice(0, 5);
  const container = document.getElementById('recentUsersList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">Foydalanuvchilar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(u => `
    <div class="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50" onclick="openUserDetail(${u.telegram_id})">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
        ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${u.current_lesson || 0}-dars</p>
      </div>
      ${u.is_paid ? '<span class="badge badge-green">💎</span>' : ''}
    </div>
  `).join('');
}

function filterPayments(status) {
  paymentFilter = status;

  document.querySelectorAll('[data-payment-status]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.paymentStatus === status);
  });
  const summary = document.getElementById('paymentsFilterSummary');
  if (summary) {
    const map = { completed: "Filtr: To'langan", pending: 'Filtr: Jarayonda', cancelled: 'Filtr: Bekor qilingan', all: 'Filtr: Barchasi' };
    summary.textContent = map[status] || 'Filtr: Barchasi';
  }

  renderPayments();
}

function renderPayments() {
  const tbody = document.getElementById('paymentsTableBody');

  let filtered = allPayments;
  if (paymentFilter !== 'all') {
    filtered = allPayments.filter(p => p.status === paymentFilter);
  }
  const meta = document.getElementById('paymentsTableMeta');
  if (meta) meta.textContent = `${filtered.length} ta yozuv`;

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="px-5 py-8 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    applyTableColumnVisibility('payments');
    return;
  }

  tbody.innerHTML = filtered.slice(0, 50).map(p => {
    let statusBadge = '';
    if (p.status === 'completed') statusBadge = '<span class="badge badge-green">To\'langan</span>';
    else if (p.status === 'pending') statusBadge = '<span class="badge badge-yellow">Jarayonda</span>';
    else if (p.status === 'cancelled' || p.status === 'failed') statusBadge = '<span class="badge badge-red">Bekor</span>';
    else statusBadge = `<span class="badge badge-gray">${p.status || '-'}</span>`;

    let channelStatus = '<span class="text-gray-400">-</span>';
    if (p.status === 'completed') {
      channelStatus = p.joined_premium_channel
        ? '<span class="badge badge-green">Qo\'shilgan</span>'
        : '<span class="badge badge-orange">Qo\'shilmagan</span>';
    }

    return `
      <tr class="table-row">
        <td data-col="date" class="px-5 py-4 text-gray-500 text-sm">${fmtDateTime(p.created_at)}</td>
        <td data-col="user" class="px-5 py-4">
          <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
          <p class="text-xs text-gray-400">ID: ${p.telegram_id || '-'}</p>
        </td>
        <td data-col="amount" class="px-5 py-4 font-semibold ${p.status === 'completed' ? 'text-green-600' : 'text-gray-600'}">${fmtMoney(p.amount)}</td>
        <td data-col="plan" class="px-5 py-4"><span class="badge badge-blue">${p.plan || '-'}</span></td>
        <td data-col="status" class="px-5 py-4">${statusBadge}</td>
        <td data-col="system" class="px-5 py-4 text-gray-500">${p.payment_system || '-'}</td>
        <td data-col="premium" class="px-5 py-4">${channelStatus}</td>
        <td data-col="actions" class="px-5 py-4">
          <button class="btn btn-secondary btn-sm" onclick="openUserDetail(${p.telegram_id || 0})" ${p.telegram_id ? '' : 'disabled'}>👁</button>
        </td>
      </tr>
    `;
  }).join('');
  applyTableColumnVisibility('payments');
}

function renderRecentPayments() {
  const recent = allPayments.filter(p => p.status === 'completed').slice(0, 5);
  const container = document.getElementById('recentPaymentsList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">To\'lovlar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(p => `
    <div class="flex items-center gap-3 p-4">
      <div class="activity-icon bg-green-100 text-green-600">💰</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${fmtDate(p.created_at)}</p>
      </div>
      <p class="font-semibold text-green-600">${fmtMoney(p.amount)}</p>
    </div>
  `).join('');
}

function renderPaymentStats() {
  const completed = allPayments.filter(p => p.status === 'completed');
  const pending = allPayments.filter(p => p.status === 'pending');
  const cancelled = allPayments.filter(p => p.status === 'cancelled' || p.status === 'failed');

  document.getElementById('payCompletedCount').textContent = completed.length;
  document.getElementById('payPendingCount').textContent = pending.length;
  document.getElementById('payCancelledCount').textContent = cancelled.length;

  const now = new Date();
  const today = completed.filter(p => new Date(p.created_at).toDateString() === now.toDateString());
  const week = completed.filter(p => (now - new Date(p.created_at)) < 7 * 24 * 60 * 60 * 1000);
  const month = completed.filter(p => (now - new Date(p.created_at)) < 30 * 24 * 60 * 60 * 1000);

  const sum = arr => arr.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('payToday').textContent = fmtMoney(sum(today));
  document.getElementById('payTodayCount').textContent = today.length + ' ta';
  document.getElementById('payWeek').textContent = fmtMoney(sum(week));
  document.getElementById('payWeekCount').textContent = week.length + ' ta';
  document.getElementById('payMonth').textContent = fmtMoney(sum(month));
  document.getElementById('payMonthCount').textContent = month.length + ' ta';
  document.getElementById('payTotal').textContent = fmtMoney(sum(completed));
  document.getElementById('payTotalCount').textContent = completed.length + ' ta';
}

function renderLessons() {
  const container = document.getElementById('lessonsList');

  if (!allLessons.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Darslar yo\'q. Yangi dars qo\'shing!</div>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const hasMedia = l.video_file_id || l.video_note_file_id || l.audio_file_id || l.document_file_id || l.photo_file_id;
    const mediaIcons = [];
    if (l.video_file_id) mediaIcons.push('🎬');
    if (l.video_note_file_id) mediaIcons.push('🔵');
    if (l.audio_file_id) mediaIcons.push('🎵');
    if (l.document_file_id) mediaIcons.push('📎');
    if (l.photo_file_id) mediaIcons.push('🖼');

    return `
      <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
        <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
          ${l.lesson_number}
        </div>
        <div class="flex-1">
          <p class="font-medium text-gray-800">${l.title}</p>
          <p class="text-sm text-gray-400">
            ${l.delay_hours || 0} soat keyin
            ${mediaIcons.length ? ' • ' + mediaIcons.join(' ') : ''}
          </p>
        </div>
        <button onclick="editLesson(${l.id})" class="btn btn-secondary text-sm">✏️</button>
        <button onclick="deleteLesson(${l.id})" class="btn bg-red-50 text-red-600 text-sm">🗑️</button>
      </div>
    `;
  }).join('');
}

// ========== LIBRARY (Darslar kutubxonasi) ==========
function renderLibrary() {
  const container = document.getElementById('libraryLessonsList');
  if (!container) return;

  // Update stats
  const videoCount = allLessons.filter(l => l.video_file_id || l.video_note_file_id).length;
  const audioCount = allLessons.filter(l => l.audio_file_id).length;

  document.getElementById('libraryTotalLessons').textContent = allLessons.length;
  document.getElementById('libraryVideoLessons').textContent = videoCount;
  document.getElementById('libraryAudioLessons').textContent = audioCount;

  if (!allLessons.length) {
    container.innerHTML = '<p class="text-gray-400 text-center py-8">Darslar yo\'q</p>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const mediaInfo = [];
    if (l.video_file_id) mediaInfo.push({ type: 'Video', id: l.video_file_id, icon: '🎬', color: 'indigo' });
    if (l.video_note_file_id) mediaInfo.push({ type: 'Video xabar', id: l.video_note_file_id, icon: '🔵', color: 'blue' });
    if (l.audio_file_id) mediaInfo.push({ type: 'Audio', id: l.audio_file_id, icon: '🎵', color: 'orange' });
    if (l.document_file_id) mediaInfo.push({ type: 'Fayl', id: l.document_file_id, icon: '📎', color: 'gray' });
    if (l.photo_file_id) mediaInfo.push({ type: 'Rasm', id: l.photo_file_id, icon: '🖼', color: 'green' });

    const mediaHtml = mediaInfo.map(m => `
      <div class="flex items-center gap-2 bg-${m.color}-50 rounded-lg px-3 py-2">
        <span>${m.icon}</span>
        <span class="text-xs text-${m.color}-600 font-medium">${m.type}:</span>
        <code class="text-xs bg-${m.color}-100 px-2 py-0.5 rounded cursor-pointer hover:bg-${m.color}-200 transition-colors max-w-[200px] truncate" onclick="copyToClipboard('${m.id}')" title="${m.id}">${m.id.substring(0, 25)}...</code>
      </div>
    `).join('');

    return `
      <div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between gap-4 mb-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
              ${l.lesson_number}
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">${l.title}</h4>
              <p class="text-xs text-gray-400">ID: <code class="bg-gray-100 px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200" onclick="copyToClipboard('${l.id}')">${l.id}</code></p>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="testSendLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Test yuborish">
              📤 Test
            </button>
            <button onclick="editLesson(${l.id})" class="btn btn-secondary text-xs px-3 py-1.5" title="Tahrirlash">
              ✏️
            </button>
          </div>
        </div>

        <div class="text-sm text-gray-600 mb-3 line-clamp-2">${l.text ? l.text.substring(0, 150) + (l.text.length > 150 ? '...' : '') : '<span class="text-gray-400 italic">Matn yo\'q</span>'}</div>

        ${mediaInfo.length ? `
          <div class="border-t border-gray-100 pt-3">
            <p class="text-xs text-gray-400 mb-2 font-medium">Media fayllari:</p>
            <div class="flex flex-wrap gap-2">
              ${mediaHtml}
            </div>
          </div>
        ` : '<p class="text-xs text-gray-400 italic">Media fayl biriktirilmagan</p>'}

        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400">
          <span>⏱ ${l.delay_hours || 0} soat keyin</span>
          ${l.button_text ? `<span>🔘 ${l.button_text}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast('Nusxalandi! ✅');
  }).catch(() => {
    // Fallback
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('Nusxalandi! ✅');
  });
}

function copyAllLessonIds() {
  const ids = allLessons.map(l => `${l.lesson_number}-dars (ID: ${l.id}): ${l.title}`).join('\n');
  copyToClipboard(ids);
}

async function testSendLesson(lessonId) {
  if (!confirm('Bu darsni o\'zingizga test sifatida yubormoqchimisiz?')) return;

  try {
    const res = await fetch('/api/lessons/' + lessonId + '/test', {
      method: 'POST',
      headers: { Authorization: auth }
    });
    if (res.ok) {
      showToast('Dars yuborildi! Telegram ni tekshiring 📱');
    } else {
      showToast('Xatolik yuz berdi ❌', 'error');
    }
  } catch(e) {
    showToast('Xatolik: ' + e.message, 'error');
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-20 md:bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

function renderLessonProgress() {
  const statsContainer = document.getElementById('lessonProgressStats');
  const panelContainer = document.getElementById('lessonProgressPanel');

  // Empty state check
  if (!allUsers.length || !allLessons.length) {
    const emptyHtml = `
      <div class="flex flex-col items-center justify-center py-8 text-center">
        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
        <p class="text-gray-500 font-medium mb-1">Hali ma'lumot yo'q</p>
        <p class="text-gray-400 text-sm">Foydalanuvchilar darslarni boshlashi bilan statistika ko'rinadi</p>
      </div>
    `;
    if (statsContainer) statsContainer.innerHTML = emptyHtml;
    if (panelContainer) panelContainer.innerHTML = emptyHtml;
    return;
  }

  const lessonCounts = {};
  allUsers.forEach(u => {
    const lesson = u.current_lesson || 0;
    lessonCounts[lesson] = (lessonCounts[lesson] || 0) + 1;
  });

  const maxUsers = Math.max(...Object.values(lessonCounts), 1);
  const totalUsers = allUsers.length || 1;

  // Standard bar chart for stats section
  const statsHtml = allLessons.slice(0, 10).map(l => {
    const count = lessonCounts[l.lesson_number] || 0;
    const pct = Math.round((count / maxUsers) * 100);
    return `
      <div class="flex items-center gap-3 group hover:bg-indigo-50 rounded-lg p-2 -mx-2 transition-colors cursor-default">
        <span class="w-16 text-sm text-gray-600 group-hover:text-indigo-600 font-medium transition-colors">${l.lesson_number}-dars</span>
        <div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
        </div>
        <span class="w-12 text-sm text-gray-600 text-right font-semibold">${formatters.number(count)}</span>
      </div>
    `;
  }).join('');

  if (statsContainer) {
    statsContainer.innerHTML = statsHtml || '<p class="text-gray-400 text-center">Ma\'lumot yo\'q</p>';
  }

  // Visual funnel for right panel
  const funnelGradients = [
    'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
    'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)',
    'linear-gradient(135deg, #a5b4fc 0%, #818cf8 100%)',
    'linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%)',
    'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)',
    'linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)',
    'linear-gradient(135deg, #f5f3ff 0%, #eef2ff 100%)'
  ];
  const lessons = allLessons.slice(0, 7);

  if (!lessons.length) {
    if (panelContainer) panelContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">Ma\'lumot yo\'q</p>';
    return;
  }

  // Calculate cumulative users (users at lesson N or higher)
  const cumulativeCounts = lessons.map((l, idx) => {
    let count = 0;
    lessons.slice(idx).forEach(lesson => {
      count += lessonCounts[lesson.lesson_number] || 0;
    });
    return { lesson: l, count };
  });

  let funnelHtml = '<div class="funnel-container">';

  cumulativeCounts.forEach((item, idx) => {
    const count = item.count;
    const lesson = item.lesson;
    const widthPct = Math.max(35, 100 - (idx * 10));
    const pct = Math.round((count / totalUsers) * 100);
    const bgGradient = funnelGradients[idx % funnelGradients.length];
    const textColor = idx < 3 ? '#fff' : '#4338ca';
    const subTextColor = idx < 3 ? 'rgba(255,255,255,0.8)' : '#6366f1';

    funnelHtml += `
      <div class="funnel-step-wrapper" style="display: flex; flex-direction: column; align-items: center;">
        <div class="funnel-step" style="width: ${widthPct}%; background: ${bgGradient}; padding: 10px 14px; border-radius: 8px; transition: all 0.2s ease; cursor: default;"
             onmouseenter="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(99,102,241,0.3)'"
             onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px; font-weight: 600; color: ${textColor}">${lesson.lesson_number}-dars</span>
            <span style="font-size: 14px; font-weight: 800; color: ${textColor}">${formatters.number(count)}</span>
          </div>
          <div style="font-size: 11px; color: ${subTextColor}; margin-top: 2px;">${pct}% foydalanuvchi</div>
        </div>`;

    // Drop-off indicator between steps
    if (idx < cumulativeCounts.length - 1) {
      const nextCount = cumulativeCounts[idx + 1].count;
      const dropOff = count > 0 ? Math.round(((count - nextCount) / count) * 100) : 0;
      if (dropOff > 0) {
        funnelHtml += `
          <div style="display: flex; align-items: center; gap: 4px; margin: 4px 0; color: ${dropOff > 30 ? '#ef4444' : '#f59e0b'};">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M19 12l-7 7-7-7"/>
            </svg>
            <span style="font-size: 10px; font-weight: 600;">-${dropOff}%</span>
          </div>`;
      } else {
        funnelHtml += `<div style="height: 8px;"></div>`;
      }
    }

    funnelHtml += `</div>`;
  });

  funnelHtml += '</div>';

  // Overall conversion summary
  if (cumulativeCounts.length > 1 && cumulativeCounts[0].count > 0) {
    const startCount = cumulativeCounts[0].count;
    const endCount = cumulativeCounts[cumulativeCounts.length - 1].count;
    const conversionRate = Math.round((endCount / startCount) * 100);
    const totalDropOff = startCount - endCount;
    const conversionColor = conversionRate >= 50 ? '#10b981' : conversionRate >= 25 ? '#f59e0b' : '#ef4444';

    funnelHtml += `
      <div style="margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid rgba(99,102,241,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Umumiy konversiya</div>
            <div style="font-size: 24px; font-weight: 800; color: ${conversionColor}; font-family: 'JetBrains Mono', monospace;">${conversionRate}%</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 11px; color: #6b7280;">Yo'qotish</div>
            <div style="font-size: 14px; font-weight: 700; color: #ef4444;">-${formatters.number(totalDropOff)} kishi</div>
          </div>
        </div>
      </div>
    `;
  }

  if (panelContainer) panelContainer.innerHTML = funnelHtml;
}

function renderCustDev() {
  const container = document.getElementById('custdevList');

  if (!allCustDev.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Savollar yo\'q. Yangi savol qo\'shing!</div>';
    return;
  }

  container.innerHTML = allCustDev.map(q => `
    <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
      <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
        ${q.after_lesson}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${q.question_text}</p>
        <p class="text-sm text-gray-400">
          ${q.question_type === 'buttons' ? 'Tugmalar' : 'Matn'}
          • ${q.answer_count || 0} javob
          ${q.field_name ? ' • ' + q.field_name : ''}
        </p>
      </div>
      <button onclick="openQuestionStats(${q.id})" class="btn btn-secondary text-sm">📊</button>
      <button onclick="editCustDev(${q.id})" class="btn btn-secondary text-sm">✏️</button>
      <button onclick="deleteCustDev(${q.id})" class="btn bg-red-50 text-red-600 text-sm">🗑️</button>
    </div>
  `).join('');
}

function renderCustDevStats() {
  // Count stats
  const totalQuestions = allCustDev.length;
  const totalAnswers = Object.values(custdevAnswers).reduce((sum, arr) => sum + arr.length, 0);
  const respondents = new Set();
  Object.values(custdevAnswers).forEach(answers => {
    answers.forEach(a => respondents.add(a.telegram_id));
  });
  const avgAnswers = respondents.size > 0 ? (totalAnswers / respondents.size).toFixed(1) : 0;

  document.getElementById('custdevTotalQuestions').textContent = totalQuestions;
  document.getElementById('custdevTotalAnswers').textContent = totalAnswers;
  document.getElementById('custdevRespondents').textContent = respondents.size;
  document.getElementById('custdevAvgAnswers').textContent = avgAnswers;

  // Render charts with field data
  renderCustDevCharts();
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');

  const activities = [
    ...allUsers.slice(0, 5).map(u => ({ type: 'user', data: u, date: new Date(u.created_at) })),
    ...allPayments.filter(p => p.status === 'completed').slice(0, 5).map(p => ({ type: 'payment', data: p, date: new Date(p.created_at) }))
  ].sort((a, b) => b.date - a.date).slice(0, 5);

  if (!activities.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><div class="empty-state-text">Faoliyat yo\'q</div></div>';
    return;
  }

  const timeAgo = (date) => {
    const mins = Math.floor((Date.now() - date) / 60000);
    if (mins < 1) return 'hozirgina';
    if (mins < 60) return mins + ' min oldin';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + ' soat oldin';
    return Math.floor(hours / 24) + ' kun oldin';
  };

  container.innerHTML = activities.map(a => {
    const getName = (d) => d.full_name || d.username || 'Foydalanuvchi';
    const time = timeAgo(a.date);
    if (a.type === 'user') {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600">👤</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-gray-400">Yangi foydalanuvchi • ${time}</p>
          </div>
          <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
        </div>
      `;
    } else {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">💰</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-green-600 font-medium">${fmtMoney(a.data.amount)} • ${time}</p>
          </div>
          <span class="w-2 h-2 bg-green-400 rounded-full"></span>
        </div>
      `;
    }
  }).join('');
}

// ========== CHARTS ==========
function renderCharts() {
  renderRevenueChart(currentRevenuePeriod);
  renderUserTypeChart();
  renderCustDevCharts();
  renderSubscriberGrowthChart(currentGrowthPeriod);
}

function renderRevenueChart(period = 'week') {
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;

  const now = new Date();
  const completedPayments = allPayments.filter(p => p.status === 'completed');

  let labels = [];
  let data = [];
  let periodTotal = 0;

  if (period === 'week') {
    // Last 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      const dayName = days[d.getDay()];
      dailyData[key] = { label: dayName, amount: 0 };
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) {
        dailyData[key].amount += (p.amount || 0);
      }
    });

    Object.values(dailyData).forEach(d => {
      labels.push(d.label);
      data.push(d.amount / 100);
      periodTotal += d.amount;
    });

  } else if (period === 'month') {
    // Current month by days (1-31)
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const dailyData = {};

    for (let i = 1; i <= Math.min(now.getDate(), daysInMonth); i++) {
      dailyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        const day = date.getDate();
        dailyData[day] = (dailyData[day] || 0) + (p.amount || 0);
      }
    });

    Object.entries(dailyData).forEach(([day, amount]) => {
      labels.push(day);
      data.push(amount / 100);
      periodTotal += amount;
    });

  } else if (period === 'year') {
    // Months of current year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
    }

    completedPayments.forEach(p => {
      const date = new Date(p.created_at);
      if (date.getFullYear() === now.getFullYear()) {
        monthlyData[date.getMonth()] = (monthlyData[date.getMonth()] || 0) + (p.amount || 0);
      }
    });

    Object.entries(monthlyData).forEach(([month, amount]) => {
      labels.push(months[parseInt(month)]);
      data.push(amount / 100);
      periodTotal += amount;
    });
  }

  // Update display
  document.getElementById('totalRevenueDisplay').textContent = fmtMoney(periodTotal);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: chartAccent(),
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: chartLayoutPadding() },
      plugins: { legend: { display: false } },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: true,
            maxTicksLimit: chartMaxXTicks(),
            autoSkipPadding: isMobile() ? 18 : 6,
            maxRotation: isMobile() ? 45 : 0,
            minRotation: isMobile() ? 45 : 0,
            font: chartTickFont(),
            color: chartTextColor()
          }
        },
        y: {
          grid: { color: chartGridColor() },
          ticks: {
            callback: v => v >= 1000 ? (v/1000) + 'K' : v,
            font: chartTickFont(),
            color: chartTextColor(),
            padding: 8
          }
        }
      }
    }
  });
}

function renderSubscriberGrowthChart(period = 'day') {
  const canvas = document.getElementById('subscriberGrowthChart');
  if (!canvas) {
    console.warn('subscriberGrowthChart canvas not found');
    return;
  }
  const ctx = canvas.getContext('2d');
  if (!ctx) {
    console.warn('subscriberGrowthChart context not found');
    return;
  }

  // Ensure canvas has dimensions
  const container = canvas.parentElement;
  if (container) {
    canvas.style.width = '100%';
    canvas.style.height = '100%';
  }

  const now = new Date();
  let labels = [];
  let data = [];
  let prevData = [];
  let periodLabels = { day: 'Kunlik', week: 'Haftalik', month: 'Oylik', year: 'Yillik' };

  document.getElementById('subscriberGrowthTitle').textContent = periodLabels[period] + ' o\'sish';

  if (period === 'day') {
    // Last 24 hours by hour (current) and previous 24 hours
    const hourlyData = {};
    const prevHourlyData = {};

    for (let i = 23; i >= 0; i--) {
      const h = new Date(now);
      h.setHours(h.getHours() - i, 0, 0, 0);
      const key = h.getHours();
      hourlyData[23 - i] = { hour: key, count: 0 };
      prevHourlyData[23 - i] = { hour: key, count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const diffHours = (now - date) / (1000 * 60 * 60);

      if (diffHours <= 24) {
        const hourIndex = Math.floor(23 - diffHours);
        if (hourIndex >= 0 && hourlyData[hourIndex]) hourlyData[hourIndex].count++;
      } else if (diffHours <= 48) {
        const hourIndex = Math.floor(23 - (diffHours - 24));
        if (hourIndex >= 0 && prevHourlyData[hourIndex]) prevHourlyData[hourIndex].count++;
      }
    });

    Object.values(hourlyData).forEach((d, i) => {
      labels.push(d.hour + ':00');
      data.push(d.count);
      prevData.push(prevHourlyData[i]?.count || 0);
    });

  } else if (period === 'week') {
    // Last 7 days (current) and previous 7 days
    const days = ['Yak', 'Dush', 'Sesh', 'Chor', 'Pay', 'Jum', 'Shan'];
    const dailyData = {};
    const prevDailyData = {};

    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const key = d.toISOString().split('T')[0];
      dailyData[key] = { label: days[d.getDay()], count: 0 };

      const pd = new Date(now);
      pd.setDate(pd.getDate() - i - 7);
      const prevKey = pd.toISOString().split('T')[0];
      prevDailyData[prevKey] = { label: days[pd.getDay()], count: 0 };
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const key = date.toISOString().split('T')[0];
      if (dailyData[key]) dailyData[key].count++;
      if (prevDailyData[key]) prevDailyData[key].count++;
    });

    const prevValues = Object.values(prevDailyData);
    Object.values(dailyData).forEach((d, i) => {
      labels.push(d.label);
      data.push(d.count);
      prevData.push(prevValues[i]?.count || 0);
    });

  } else if (period === 'month') {
    // Current month by days vs previous month
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
    const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
    const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();

    const dailyData = {};
    const prevDailyData = {};
    const maxDays = Math.min(now.getDate(), daysInMonth);

    for (let i = 1; i <= maxDays; i++) {
      dailyData[i] = 0;
      prevDailyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const day = date.getDate();

      if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
        if (dailyData[day] !== undefined) dailyData[day]++;
      } else if (date.getMonth() === prevMonth && date.getFullYear() === prevYear && day <= maxDays) {
        if (prevDailyData[day] !== undefined) prevDailyData[day]++;
      }
    });

    Object.entries(dailyData).forEach(([day, count]) => {
      labels.push(day);
      data.push(count);
      prevData.push(prevDailyData[day] || 0);
    });

  } else if (period === 'year') {
    // Current year months vs previous year
    const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];
    const monthlyData = {};
    const prevMonthlyData = {};

    for (let i = 0; i <= now.getMonth(); i++) {
      monthlyData[i] = 0;
      prevMonthlyData[i] = 0;
    }

    allUsers.forEach(u => {
      const date = new Date(u.created_at);
      const month = date.getMonth();

      if (date.getFullYear() === now.getFullYear() && month <= now.getMonth()) {
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      } else if (date.getFullYear() === now.getFullYear() - 1 && month <= now.getMonth()) {
        prevMonthlyData[month] = (prevMonthlyData[month] || 0) + 1;
      }
    });

    Object.entries(monthlyData).forEach(([month, count]) => {
      labels.push(months[parseInt(month)]);
      data.push(count);
      prevData.push(prevMonthlyData[month] || 0);
    });
  }

  // Calculate totals and growth percentage
  const currentTotal = data.reduce((a, b) => a + b, 0);
  const previousTotal = prevData.reduce((a, b) => a + b, 0);

  let growthPercent = 0;
  if (previousTotal > 0) {
    growthPercent = Math.round(((currentTotal - previousTotal) / previousTotal) * 100);
  } else if (currentTotal > 0) {
    growthPercent = 100;
  }

  // Update comparison text
  document.getElementById('currentPeriodCount').textContent = currentTotal;
  document.getElementById('prevPeriodCount').textContent = previousTotal;

  const indicator = document.getElementById('growthIndicator');
  const arrow = document.getElementById('growthArrow');
  const percent = document.getElementById('growthPercent');

  if (growthPercent >= 0) {
    indicator.className = 'flex items-center gap-1 text-green-600 font-semibold text-lg';
    arrow.textContent = '↑';
    percent.textContent = '+' + growthPercent + '%';
  } else {
    indicator.className = 'flex items-center gap-1 text-red-600 font-semibold text-lg';
    arrow.textContent = '↓';
    percent.textContent = growthPercent + '%';
  }

  // Debug log
  console.log('renderSubscriberGrowthChart:', { period, labels: labels.length, dataSum: currentTotal, prevSum: previousTotal, sampleData: data.slice(0, 5) });

  if (subscriberGrowthChart) subscriberGrowthChart.destroy();

  // Create chart with explicit dimensions
  subscriberGrowthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Bu davr',
          data,
          borderColor: chartAccent(),
          backgroundColor: chartAccentSoft(),
          fill: true,
          tension: 0.4,
          pointRadius: isMobile() ? 2 : 4,
          pointHoverRadius: isMobile() ? 3 : 5,
          borderWidth: isMobile() ? 2 : 3,
          pointBackgroundColor: chartAccent(),
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        },
        {
          label: 'O\'tgan davr',
          data: prevData,
          borderColor: chartMuted(),
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.4,
          pointRadius: isMobile() ? 1.5 : 3,
          pointHoverRadius: isMobile() ? 2.5 : 4,
          borderWidth: isMobile() ? 2 : 3,
          pointBackgroundColor: chartMuted(),
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: chartLayoutPadding() },
      plugins: { legend: { display: false } },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: true,
            maxTicksLimit: chartMaxXTicks(),
            autoSkipPadding: isMobile() ? 18 : 6,
            maxRotation: isMobile() ? 45 : 0,
            minRotation: isMobile() ? 45 : 0,
            font: chartTickFont(),
            color: chartTextColor()
          }
        },
        y: {
          grid: { color: chartGridColor() },
          beginAtZero: true,
          ticks: { stepSize: 1, font: chartTickFont(), color: chartTextColor(), padding: 6 }
        }
      }
    }
  });
}

function renderUserTypeChart() {
  const ctx = document.getElementById('userTypeChart')?.getContext('2d');
  if (!ctx) return;

  const active = allUsers.filter(u => !u.is_paid && !u.lessons_completed).length;
  const paid = allUsers.filter(u => u.is_paid).length;
  const completed = allUsers.filter(u => u.lessons_completed && !u.is_paid).length;

  if (userTypeChart) userTypeChart.destroy();

  userTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Aktiv', 'To\'lagan', 'Tugatgan'],
      datasets: [{
        data: [active, paid, completed],
        backgroundColor: [chartAccent(), '#12b981', 'rgba(148,163,184,0.35)'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: isMobile() ? '68%' : '70%',
      plugins: { legend: { display: false } }
    }
  });
}

function renderCustDevCharts() {
  const colors = [chartAccent(), '#12b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Map various field_name values to chart keys
  const fieldNameMap = {
    // English variations
    'age': 'age', 'age_group': 'age', 'yosh': 'age',
    'occupation': 'occupation', 'kasb': 'occupation', 'job': 'occupation',
    'income': 'income', 'income_level': 'income', 'daromad': 'income',
    'budget': 'budget', 'budget_range': 'budget', 'byudjet': 'budget'
  };

  // Group answers by mapped field_name
  const fieldData = {};
  allCustDev.forEach(q => {
    if (q.field_name && custdevAnswers[q.id]) {
      const answers = custdevAnswers[q.id];
      const mappedField = fieldNameMap[q.field_name.toLowerCase()] || q.field_name;
      if (!fieldData[mappedField]) fieldData[mappedField] = {};

      answers.forEach(a => {
        const value = a.answer_text || 'Boshqa';
        fieldData[mappedField][value] = (fieldData[mappedField][value] || 0) + 1;
      });
    }
  });

  // Render charts for each field
  ['age', 'occupation', 'income', 'budget'].forEach((field, idx) => {
    const ctx = document.getElementById(field + 'Chart')?.getContext('2d');
    if (!ctx) return;

    const data = fieldData[field] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window[field + 'ChartInstance']) window[field + 'ChartInstance'].destroy();

    window[field + 'ChartInstance'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: isMobile() ? '62%' : '60%',
        plugins: { legend: { display: false } }
      }
    });

    // Render legend
    const legendContainer = document.getElementById(field + 'ChartLegend');
    if (legendContainer && labels.length) {
      legendContainer.innerHTML = labels.slice(0, 4).map((label, i) => `
        <div class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full" style="background: ${colors[i % colors.length]}"></span>
          <span class="truncate">${label}: ${values[i]}</span>
        </div>
      `).join('');
    }
  });
}

// ========== MODALS ==========
function activateModalA11y(id) {
  const el = document.getElementById(id);
  if (!el) return;
  prevFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  activeModalId = id;
  el.setAttribute('role', 'dialog');
  el.setAttribute('aria-modal', 'true');
  el.setAttribute('tabindex', '-1');
  setTimeout(() => {
    const firstFocusable = el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (firstFocusable instanceof HTMLElement) firstFocusable.focus();
    else el.focus();
  }, 0);
}

function deactivateModalA11y(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.removeAttribute('role');
  el.removeAttribute('aria-modal');
  if (activeModalId === id) activeModalId = null;
  if (prevFocusedElement instanceof HTMLElement) {
    prevFocusedElement.focus();
    prevFocusedElement = null;
  }
}

function trapModalFocus(event) {
  const modal = activeModalId ? document.getElementById(activeModalId) : null;
  if (!modal) return;
  const focusables = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
    .filter((el) => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
  if (!focusables.length) {
    event.preventDefault();
    return;
  }
  const first = focusables[0];
  const last = focusables[focusables.length - 1];
  const active = document.activeElement;
  if (event.shiftKey && active === first) {
    event.preventDefault();
    last.focus();
  } else if (!event.shiftKey && active === last) {
    event.preventDefault();
    first.focus();
  }
}

function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  activateModalA11y(id);
  // Load bot username for source link modal
  if (id === 'sourceLinkModal') {
    loadBotUsername();
  }
}
function closeModal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('hidden');
  if (id === 'promoModal') el.classList.remove('flex');
  deactivateModalA11y(id);
}

// ========== SOURCE LINK GENERATOR ==========
let botUsername = '';

async function loadBotUsername() {
  try {
    if (!botUsername) {
      const botInfo = await (await fetch('/api/bot-info', { headers: { Authorization: auth } })).json();
      botUsername = botInfo.username || 'your_bot';
    }
  } catch(e) {
    console.error('loadBotUsername error:', e);
  }
}

function setSourceName(name) {
  document.getElementById('sourceNameInput').value = name;
  generateSourceLink();
}

function generateSourceLink() {
  const sourceName = document.getElementById('sourceNameInput').value.trim();
  const container = document.getElementById('generatedLinkContainer');
  const linkInput = document.getElementById('generatedSourceLink');

  // Clean source name: only allow letters, numbers, underscore
  const cleanSource = sourceName.toLowerCase().replace(/[^a-z0-9_]/g, '');

  if (!cleanSource) {
    container.classList.add('hidden');
    return;
  }

  const link = `https://t.me/${botUsername || 'your_bot'}?start=_${cleanSource}`;
  linkInput.value = link;
  container.classList.remove('hidden');
  document.getElementById('sourceLinkCopied').style.display = 'none';
}

function copySourceLink() {
  const linkInput = document.getElementById('generatedSourceLink');
  linkInput.select();
  document.execCommand('copy');
  document.getElementById('sourceLinkCopied').style.display = 'block';
  setTimeout(() => {
    document.getElementById('sourceLinkCopied').style.display = 'none';
  }, 2000);
}

// ========== DELETE USER ==========
async function deleteUser(telegramId, userName) {
  if (!confirm(`"${userName}" ni o'chirmoqchimisiz?\n\nBu foydalanuvchining barcha ma'lumotlari o'chiriladi:\n- To'lovlar\n- Obunalar\n- Dars javoblari\n- Referral ma'lumotlari\n\nBu amalni qaytarib bo'lmaydi!`)) {
    return;
  }

  try {
    const res = await fetch(`/api/users/${telegramId}`, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });

    const data = await res.json();
    if (data.success) {
      showToast('Foydalanuvchi o\'chirildi', 'success');
      // Remove from local array
      allUsers = allUsers.filter(u => u.telegram_id !== telegramId);
      // Re-render
      applyUserFilters();
      loadStats();
    } else {
      showToast('Xatolik: ' + (data.error || 'Noma\'lum xatolik'), 'error');
    }
  } catch (e) {
    showToast('Xatolik: ' + e.message, 'error');
  }
}

// ========== USER DETAIL ==========
async function openUserDetail(telegramId) {
  const user = allUsers.find(u => u.telegram_id == telegramId);
  if (!user) return;

  const displayName = user.full_name || user.username || 'Foydalanuvchi';
  document.getElementById('userDetailAvatar').textContent = displayName.charAt(0).toUpperCase();
  document.getElementById('userDetailName').textContent = displayName;
  document.getElementById('userDetailUsername').textContent = user.username ? '@' + user.username : 'username yo\'q';
  document.getElementById('userDetailTgId').textContent = user.telegram_id;
  document.getElementById('userDetailPhone').textContent = user.phone || '-';
  document.getElementById('userDetailLesson').textContent = (user.current_lesson || 0) + '-dars';
  document.getElementById('userDetailStatus').innerHTML = user.is_paid
    ? (user.joined_premium_channel
        ? '<span class="badge badge-green">Premium</span> <span class="text-green-600 text-xs">✓ Kanalda</span>'
        : '<span class="badge badge-orange">To\'lagan</span> <span class="text-red-500 text-xs">✗ Kanalda emas</span>')
    : '<span class="badge badge-gray">Free</span>';
  document.getElementById('userDetailCreated').textContent = fmtDateTime(user.created_at);

  // Load user's custdev answers
  try {
    const answers = await (await fetch('/api/users/' + telegramId + '/custdev', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('userDetailCustdev');

    if (!answers || !answers.length) {
      container.innerHTML = '<p class="text-gray-400 text-center py-4">Javoblar yo\'q</p>';
    } else {
      container.innerHTML = answers.map(a => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500 mb-1">${a.question_text}</p>
          <p class="font-medium text-gray-800">${a.answer_text}</p>
        </div>
      `).join('');
    }
  } catch(e) {
    document.getElementById('userDetailCustdev').innerHTML = '<p class="text-red-400 text-center py-4">Xatolik</p>';
  }

  // Store current user for sending message
  window.currentUserTgId = telegramId;
  openModal('userDetailModal');
}

function sendMessageToUser() {
  closeModal('userDetailModal');
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  const user = allUsers.find(u => u.telegram_id == window.currentUserTgId);
  if (user) {
    selectedBroadcastUsers.add(user.telegram_id);
    updateSelectedUsersList();
  }
}

// ========== BROADCAST ==========
function openBroadcastModal() {
  selectedBroadcastUsers.clear();
  document.getElementById('broadcastTarget').value = 'all';
  document.getElementById('broadcastType').value = 'text';
  document.getElementById('broadcastText').value = '';
  document.getElementById('broadcastMediaId').value = '';
  document.getElementById('broadcastBtnText').value = '';
  document.getElementById('broadcastBtnUrl').value = '';
  document.getElementById('broadcastBtn2Text').value = '';
  document.getElementById('broadcastBtn2Url').value = '';
  document.getElementById('broadcastProgress')?.classList.add('hidden');
  document.getElementById('charCount').textContent = '0';
  toggleUserSelect();
  toggleBroadcastMedia();
  updateRecipientCount();
  updatePreview();
  openModal('broadcastModal');
}

function toggleUserSelect() {
  const target = document.getElementById('broadcastTarget').value;
  document.getElementById('userSelectDiv').classList.toggle('hidden', target !== 'specific');
  const lessonDiv = document.getElementById('lessonRangeDiv');
  if (lessonDiv) {
    lessonDiv.classList.toggle('hidden', target !== 'lesson');
  }
}

function toggleBroadcastMedia() {
  const type = document.getElementById('broadcastType').value;
  document.getElementById('broadcastMediaDiv').classList.toggle('hidden', type === 'text');
}

function searchBroadcastUsers() {
  const query = document.getElementById('broadcastUserSearch').value.toLowerCase();
  const container = document.getElementById('broadcastUsersList');

  if (!query) {
    container.innerHTML = '<p class="text-gray-400 text-sm">Qidirish...</p>';
    return;
  }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  ).slice(0, 10);

  container.innerHTML = filtered.map(u => `
    <div class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="toggleBroadcastUser(${u.telegram_id})">
      <input type="checkbox" ${selectedBroadcastUsers.has(u.telegram_id) ? 'checked' : ''} class="pointer-events-none">
      <span class="text-sm">${u.full_name || u.username || 'User'}</span>
      <span class="text-xs text-gray-400">${u.phone || u.telegram_id}</span>
    </div>
  `).join('') || '<p class="text-gray-400 text-sm">Topilmadi</p>';
}

function toggleBroadcastUser(telegramId) {
  if (selectedBroadcastUsers.has(telegramId)) {
    selectedBroadcastUsers.delete(telegramId);
  } else {
    selectedBroadcastUsers.add(telegramId);
  }
  searchBroadcastUsers();
  updateSelectedUsersList();
}

function updateSelectedUsersList() {
  document.getElementById('selectedUsersCount').textContent = selectedBroadcastUsers.size;

  const container = document.getElementById('selectedUsersList');
  container.innerHTML = Array.from(selectedBroadcastUsers).map(id => {
    const user = allUsers.find(u => u.telegram_id == id);
    return `
      <span class="badge badge-blue flex items-center gap-1">
        ${user?.full_name || user?.username || id}
        <button onclick="toggleBroadcastUser(${id})" class="ml-1">×</button>
      </span>
    `;
  }).join('');
}

async function sendBroadcast() {
  const target = document.getElementById('broadcastTarget').value;
  const type = document.getElementById('broadcastType').value;
  const text = document.getElementById('broadcastText').value;
  const mediaId = document.getElementById('broadcastMediaId').value;
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;
  const buttons = collectBroadcastButtons();

  if (!text.trim() && type === 'text') {
    alert('Xabar matni bo\'sh');
    return;
  }

  if (type !== 'text' && type !== 'video_note' && !mediaId.trim()) {
    alert('Media File ID kiriting');
    return;
  }

  if (target === 'specific' && selectedBroadcastUsers.size === 0) {
    alert('Kamida bitta foydalanuvchi tanlang');
    return;
  }

  // Get recipient count
  const recipientCount = parseInt(document.getElementById('recipientCount').textContent) || 0;
  if (recipientCount === 0) {
    alert('Yuborish uchun foydalanuvchi yo\'q');
    return;
  }

  // Confirm before sending
  if (!confirm(`${recipientCount} ta foydalanuvchiga xabar yuboriladi. Davom etasizmi?`)) {
    return;
  }

  // Show progress
  const progressDiv = document.getElementById('broadcastProgress');
  const progressBar = document.getElementById('broadcastProgressBar');
  const sentSpan = document.getElementById('broadcastSent');
  const totalSpan = document.getElementById('broadcastTotal');

  progressDiv.classList.remove('hidden');
  totalSpan.textContent = recipientCount;
  sentSpan.textContent = '0';
  progressBar.style.width = '0%';

  try {
    const body = {
      target,
      type,
      text,
      media_id: mediaId || null,
      button: btnText && btnUrl ? { text: btnText, url: btnUrl } : null,
      buttons,
      user_ids: target === 'specific' ? Array.from(selectedBroadcastUsers) : null,
      lesson_from: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonFrom')?.value) || 0 : null,
      lesson_to: target === 'lesson' ? parseInt(document.getElementById('broadcastLessonTo')?.value) || 999 : null
    };

    const res = await fetch('/api/broadcast/advanced', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const result = await res.json();

    // Complete progress
    progressBar.style.width = '100%';
    sentSpan.textContent = result.sent || 0;

    if (res.ok) {
      setTimeout(() => {
        progressDiv.classList.add('hidden');
        alert(`✅ Xabar yuborildi!\n\n📤 ${result.sent || 0} ta muvaffaqiyatli\n❌ ${result.failed || 0} ta xato`);
        closeModal('broadcastModal');

        // Reset form
        document.getElementById('broadcastText').value = '';
        document.getElementById('broadcastMediaId').value = '';
        document.getElementById('broadcastBtnText').value = '';
        document.getElementById('broadcastBtnUrl').value = '';
        document.getElementById('broadcastBtn2Text').value = '';
        document.getElementById('broadcastBtn2Url').value = '';
        selectedBroadcastUsers.clear();
        updateRecipientCount();
      }, 500);
    } else {
      progressDiv.classList.add('hidden');
      alert('Xatolik: ' + (result.error || 'Noma\'lum xato'));
    }
  } catch(e) {
    progressDiv.classList.add('hidden');
    alert('Xatolik: ' + e.message);
  }
}

// ========== LESSONS ==========
function openLessonModal() {
  document.getElementById('lessonModalTitle').textContent = '📚 Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonNumber').value = allLessons.length + 1;
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonText').value = '';
  document.getElementById('lessonDelay').value = 24;
  document.getElementById('lessonVideoFileId').value = '';
  document.getElementById('lessonVideoNoteFileId').value = '';
  document.getElementById('lessonAudioFileId').value = '';
  document.getElementById('lessonDocumentFileId').value = '';
  document.getElementById('lessonPhotoFileId').value = '';
  openModal('lessonModal');
}

function editLesson(id) {
  const lesson = allLessons.find(l => l.id === id);
  if (!lesson) return;

  document.getElementById('lessonModalTitle').textContent = '✏️ Darsni tahrirlash';
  document.getElementById('lessonId').value = lesson.id;
  document.getElementById('lessonNumber').value = lesson.lesson_number;
  document.getElementById('lessonTitle').value = lesson.title;
  document.getElementById('lessonText').value = lesson.content || lesson.text || '';
  document.getElementById('lessonDelay').value = lesson.delay_hours || 0;
  document.getElementById('lessonVideoFileId').value = lesson.video_file_id || '';
  document.getElementById('lessonVideoNoteFileId').value = lesson.video_note_file_id || '';
  document.getElementById('lessonAudioFileId').value = lesson.audio_file_id || '';
  document.getElementById('lessonDocumentFileId').value = lesson.document_file_id || '';
  document.getElementById('lessonPhotoFileId').value = lesson.photo_file_id || '';
  openModal('lessonModal');
}

document.getElementById('lessonForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('lessonId').value;
  const data = {
    lesson_number: parseInt(document.getElementById('lessonNumber').value),
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonText').value,
    delay_hours: parseInt(document.getElementById('lessonDelay').value) || 0,
    video_file_id: document.getElementById('lessonVideoFileId').value || null,
    video_note_file_id: document.getElementById('lessonVideoNoteFileId').value || null,
    audio_file_id: document.getElementById('lessonAudioFileId').value || null,
    document_file_id: document.getElementById('lessonDocumentFileId').value || null,
    photo_file_id: document.getElementById('lessonPhotoFileId').value || null
  };

  try {
    const url = id ? '/api/lessons/' + id : '/api/lessons';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('lessonModal');
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteLesson(id) {
  if (!confirm('Darsni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/lessons/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== CUSTDEV ==========
function openCustDevModal() {
  document.getElementById('custdevModalTitle').textContent = '📝 Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevAfterLesson').value = 1;
  document.getElementById('custdevQuestion').value = '';
  document.getElementById('custdevType').value = 'text';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevFieldName').value = '';
  document.getElementById('custdevOptionsDiv').classList.add('hidden');
  openModal('custdevModal');
}

function editCustDev(id) {
  const q = allCustDev.find(c => c.id === id);
  if (!q) return;

  document.getElementById('custdevModalTitle').textContent = '✏️ Savolni tahrirlash';
  document.getElementById('custdevId').value = q.id;
  document.getElementById('custdevAfterLesson').value = q.after_lesson;
  document.getElementById('custdevQuestion').value = q.question_text;
  document.getElementById('custdevType').value = q.question_type;
  document.getElementById('custdevOptions').value = q.options ? q.options.join('\n') : '';
  document.getElementById('custdevFieldName').value = q.field_name || '';
  toggleCustdevOptions();
  openModal('custdevModal');
}

function toggleCustdevOptions() {
  const type = document.getElementById('custdevType').value;
  document.getElementById('custdevOptionsDiv').classList.toggle('hidden', type !== 'buttons');
}

document.getElementById('custdevForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('custdevId').value;
  const type = document.getElementById('custdevType').value;
  const optionsText = document.getElementById('custdevOptions').value;

  const data = {
    after_lesson: parseInt(document.getElementById('custdevAfterLesson').value),
    question_text: document.getElementById('custdevQuestion').value,
    question_type: type,
    options: type === 'buttons' ? optionsText.split('\n').filter(o => o.trim()) : null,
    field_name: document.getElementById('custdevFieldName').value || null
  };

  try {
    const url = id ? '/api/custdev/' + id : '/api/custdev';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('custdevModal');
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteCustDev(id) {
  if (!confirm('Savolni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/custdev/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

async function openQuestionStats(questionId) {
  const question = allCustDev.find(q => q.id === questionId);
  if (!question) return;

  document.getElementById('custdevStatsTitle').textContent = '📊 ' + question.question_text.substring(0, 50) + '...';

  // Get answers for this question
  const answers = custdevAnswers[questionId] || [];

  // Count answers
  const answerCounts = {};
  answers.forEach(a => {
    const value = a.answer_text || 'Boshqa';
    answerCounts[value] = (answerCounts[value] || 0) + 1;
  });

  const labels = Object.keys(answerCounts);
  const values = Object.values(answerCounts);
  const colors = [chartAccent(), '#12b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Render chart
  const ctx = document.getElementById('questionStatsChart')?.getContext('2d');
  if (ctx) {
    if (questionStatsChart) questionStatsChart.destroy();

    questionStatsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { boxWidth: 8, font: chartTickFont(), color: chartTextColor() }
          }
        }
      }
    });
  }

  // Render answers list
  const listContainer = document.getElementById('questionAnswersList');
  listContainer.innerHTML = labels.map((label, i) => `
    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full" style="background: ${colors[i % colors.length]}"></span>
        <span class="font-medium">${label}</span>
      </div>
      <span class="text-gray-600">${values[i]} (${Math.round(values[i] / answers.length * 100)}%)</span>
    </div>
  `).join('') || '<p class="text-gray-400">Javoblar yo\'q</p>';

  openModal('custdevStatsModal');
}

// ========== PROGREV SETTINGS ==========
async function saveProgrevSettings() {
  try {
    const mediaType = document.getElementById('pitchMediaType').value;
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        // Start messages
        welcome: document.getElementById('startWelcomeText').value,
        ask_name: document.getElementById('startAskNameText').value,
        // Step 1: Congrats
        congrats_text: document.getElementById('congratsText').value,
        // Step 2: Feedback question
        feedback_enabled: document.getElementById('feedbackEnabled').checked,
        pitch_delay_minutes: parseInt(document.getElementById('pitchDelayMinutes').value) || 0,
        feedback_question: document.getElementById('feedbackQuestion').value,
        feedback_yes_btn: document.getElementById('feedbackYesBtn').value,
        feedback_no_btn: document.getElementById('feedbackNoBtn').value,
        // Step 3: Pitch info (after "Ha")
        pitch_info_text: document.getElementById('pitchInfoText').value,
        pitch_info_btn: document.getElementById('pitchInfoBtn').value,
        pitch_media_type: mediaType,
        pitch_video_file_id: mediaType === 'video' ? document.getElementById('pitchVideoFileId').value : null,
        pitch_audio_file_id: mediaType === 'audio' ? document.getElementById('pitchAudioFileId').value : null,
        pitch_image_file_id: mediaType === 'image' ? document.getElementById('pitchImageFileId').value : null,
        pitch_video_note_file_id: mediaType === 'video_note' ? document.getElementById('pitchVideoNoteFileId').value : null,
        // Step 3b: Negative response
        feedback_no_response: document.getElementById('feedbackNoResponse').value,
        feedback_followup: document.getElementById('feedbackFollowup').value,
        feedback_special_offer_enabled: document.getElementById('feedbackSpecialOfferEnabled').checked,
        feedback_special_offer: document.getElementById('feedbackSpecialOffer').value,
        feedback_no_sales_delay: parseInt(document.getElementById('feedbackNoSalesDelay').value) || 30,
        // Step 4: Sales pitch
        sales_pitch: document.getElementById('salesPitchText').value,
        sales_delay_minutes: parseInt(document.getElementById('salesDelayMinutes').value) || 0,
        // Step 5: Soft attack
        soft_attack_disabled: document.getElementById('softAttackDisabled').checked,
        soft_attack_text: document.getElementById('softAttackText').value,
        soft_attack_delay_minutes: parseInt(document.getElementById('softAttackDelayMinutes').value) || 1440,
        // Lesson completion defaults
        watched_message_default: document.getElementById('watchedMessageDefault').value,
        watched_button_default: document.getElementById('watchedButtonDefault').value
      })
    });

    alert('✅ Progrev sozlamalari saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== SETTINGS ==========

async function loadRenewalSettings() {
  try {
    const data = await (await fetch('/api/subscription-reminders', { headers: { Authorization: auth } })).json();
    document.getElementById('renewalReminder10d').value = data.reminder_10d || '';
    document.getElementById('renewalReminder5d').value = data.reminder_5d || '';
    document.getElementById('renewalReminder3d').value = data.reminder_3d || '';
    document.getElementById('renewalReminder1d').value = data.reminder_1d || '';
    document.getElementById('renewalReminderExpired').value = data.reminder_expired || '';
  } catch (e) {
    console.error('loadRenewalSettings error:', e);
  }
}

async function saveRenewalSettings() {
  try {
    await fetch('/api/subscription-reminders', {
      method: 'PUT',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        reminder_10d: document.getElementById('renewalReminder10d').value,
        reminder_5d: document.getElementById('renewalReminder5d').value,
        reminder_3d: document.getElementById('renewalReminder3d').value,
        reminder_1d: document.getElementById('renewalReminder1d').value,
        reminder_expired: document.getElementById('renewalReminderExpired').value
      })
    });

    alert('✅ Uzaytirish eslatmalari saqlandi!');
  } catch (e) {
    alert('Xatolik: ' + e.message);
  }
}

// Auto-calculate 3/6/12 month prices with discounts
function calculateDiscountedPrices() {
  const price1m = parseInt(document.getElementById('settingPrice1m').value) || 0;
  if (price1m > 0) {
    // Automatic discounts: 3 months = 10%, 6 months = 25%, 12 months = 40%
    document.getElementById('settingPrice3m').value = Math.round(price1m * 3 * 0.90);
    document.getElementById('settingPrice6m').value = Math.round(price1m * 6 * 0.75);
    document.getElementById('settingPrice12m').value = Math.round(price1m * 12 * 0.60);
  }
}

async function saveSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        premium_channel_id: document.getElementById('settingPremiumChannel').value,
        free_channel_id: document.getElementById('settingFreeChannel').value,
        free_channel_link: document.getElementById('settingFreeChannelLink').value,
        require_subscription_before_lesson: parseInt(document.getElementById('settingRequireSub').value) || 0,
        subscription_bypass_enabled: document.getElementById('settingSubBypassEnabled').checked ? 'true' : 'false',
        subscription_bypass_attempts: parseInt(document.getElementById('settingSubBypassAttempts').value) || 3,
        payme_enabled: document.getElementById('settingPayme').checked,
        click_enabled: document.getElementById('settingClick').checked,
        price_1m: parseInt(document.getElementById('settingPrice1m').value) * 100 || null,
        // 3/6/12 month prices are auto-calculated on server with discounts
        // Inactivity reminder settings
        inactivity_reminder_enabled: document.getElementById('settingInactivityEnabled').checked ? 'true' : 'false',
        inactivity_reminder_1: document.getElementById('settingInactivityReminder1').value,
        inactivity_reminder_2: document.getElementById('settingInactivityReminder2').value,
        // Referral system settings
        referral_enabled: document.getElementById('settingReferralEnabled').checked ? 'true' : 'false',
        referral_required_count: document.getElementById('settingReferralCount').value,
        referral_discount_percent: document.getElementById('settingReferralDiscount').value,
        // Referral offer settings
        referral_offer_enabled: document.getElementById('settingReferralOfferEnabled').checked ? 'true' : 'false',
        referral_offer_delay_hours: document.getElementById('settingReferralOfferDelay').value,
        referral_offer_message: document.getElementById('settingReferralOfferMessage').value
      })
    });

    alert('✅ Sozlamalar saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== ANALYTICS TAB ==========
let analyticsCharts = {};
let auditOffset = 0;
let latestSegmentDiagnostics = null;
let latestPaymentFrictionDiagnostics = null;
let analyticsSimpleView = localStorage.getItem('analyticsSimpleView') !== 'false';
let analyticsPeriodDays = parseInt(localStorage.getItem('analyticsPeriodDays') || '30', 10);
if (![7, 30].includes(analyticsPeriodDays)) analyticsPeriodDays = 30;

function updateAnalyticsPeriodUi() {
  const btn7 = document.getElementById('analyticsPeriod7');
  const btn30 = document.getElementById('analyticsPeriod30');
  const periodText = analyticsPeriodDays === 7 ? "so'nggi 7 kun" : "so'nggi 30 kun";
  if (btn7) btn7.classList.toggle('active', analyticsPeriodDays === 7);
  if (btn30) btn30.classList.toggle('active', analyticsPeriodDays === 30);
  const revLabel = document.getElementById('analyticsRevenuePeriodLabel');
  const subLabel = document.getElementById('analyticsSubsPeriodLabel');
  if (revLabel) revLabel.textContent = periodText;
  if (subLabel) subLabel.textContent = periodText;
}

function setAnalyticsPeriod(days) {
  const normalized = Number(days) === 7 ? 7 : 30;
  if (analyticsPeriodDays === normalized) return;
  analyticsPeriodDays = normalized;
  localStorage.setItem('analyticsPeriodDays', String(analyticsPeriodDays));
  updateAnalyticsPeriodUi();
  loadAnalyticsData(true);
}

function applyAnalyticsViewPreference() {
  document.querySelectorAll('.analytics-advanced').forEach((el) => {
    el.classList.toggle('hidden', analyticsSimpleView);
  });

  const btn = document.getElementById('analyticsViewToggle');
  if (btn) {
    btn.textContent = analyticsSimpleView ? '🔎 Batafsil ko\'rinish' : '🧹 Faqat asosiy bloklar';
  }
}

function toggleAnalyticsView() {
  analyticsSimpleView = !analyticsSimpleView;
  localStorage.setItem('analyticsSimpleView', analyticsSimpleView ? 'true' : 'false');
  applyAnalyticsViewPreference();
}

async function loadAnalyticsData(force = false) {
  try {
    if (analyticsFetchInFlight && !force) return;
    updateAnalyticsPeriodUi();
    const cacheKey = String(analyticsPeriodDays);
    const cached = analyticsCacheByPeriod.get(cacheKey);
    const freshMs = 90 * 1000;
    let payload = null;

    if (!force && cached && (Date.now() - cached.ts) < freshMs) {
      payload = cached.data;
    } else {
      analyticsFetchInFlight = true;
      const [revenueData, subscribersData, sourcesData, buyerData, inactivityData, funnelDiagData, segmentDiagData, paymentFrictionData] = await Promise.all([
        fetch(`/api/analytics/revenue?days=${analyticsPeriodDays}`, { headers: { Authorization: auth } }).then(r => r.json()),
        fetch(`/api/subscribers/daily?days=${analyticsPeriodDays}`, { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/sources', { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/buyers', { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/inactivity', { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/funnel-diagnostics', { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/segments?limit=100', { headers: { Authorization: auth } }).then(r => r.json()),
        fetch('/api/analytics/payment-friction?limit=100', { headers: { Authorization: auth } }).then(r => r.json())
      ]);
      payload = { revenueData, subscribersData, sourcesData, buyerData, inactivityData, funnelDiagData, segmentDiagData, paymentFrictionData };
      analyticsCacheByPeriod.set(cacheKey, { ts: Date.now(), data: payload });
    }
    const { revenueData, subscribersData, sourcesData, buyerData, inactivityData, funnelDiagData, segmentDiagData, paymentFrictionData } = payload;

    // Render revenue chart
    renderAnalyticsRevenueChart(revenueData);

    // Render subscribers chart
    renderSubscribersChart(subscribersData);

    // Render sources table and pie chart
    renderSourcesAnalytics(sourcesData);

    // Render buyer journey stats
    renderBuyerAnalytics(buyerData);

    // Render inactivity stats
    renderInactivityStats(inactivityData);

    // Render funnel diagnostics
    renderFunnelDiagnostics(funnelDiagData);

    // Render segment diagnostics
    renderSegmentDiagnostics(segmentDiagData);

    // Render payment friction diagnostics
    renderPaymentFrictionDiagnostics(paymentFrictionData);

    // NEW: Render analytics mega funnel
    renderAnalyticsMegaFunnel(funnelDiagData);

    // NEW: Render CR heatmap
    renderAnalyticsCRHeatmap(sourcesData);

    // NEW: Render AI insights
    renderAnalyticsInsights(funnelDiagData, segmentDiagData, paymentFrictionData);

  } catch(e) {
    console.error('loadAnalyticsData error:', e);
  } finally {
    analyticsFetchInFlight = false;
  }
}

// ═══ NEW ANALYTICS VISUALIZATION FUNCTIONS ═══

// Scroll to a section in analytics
function scrollToAnalyticsSection(elementId) {
  const element = document.getElementById(elementId);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    element.style.boxShadow = '0 0 0 3px rgba(115, 103, 240, 0.3)';
    setTimeout(() => { element.style.boxShadow = ''; }, 2000);
  }
}

function renderAnalyticsMegaFunnel(data) {
  // Data comes from funnel-diagnostics with stages array
  const stages = Array.isArray(data?.stages) ? data.stages : [];

  if (!stages.length) {
    console.log('No stages data for mega funnel');
    return;
  }

  const totalUsers = stages[0]?.count || 0;

  // Map stage labels to element IDs (must match database.js labels exactly)
  const mapping = {
    "Ro'yxatdan o'tgan": { valueId: 'afTotalUsers', percentId: null, dropoffId: 'afDropoff1' },
    'Darsni boshlagan': { valueId: 'afActiveUsers', percentId: 'afActivePercent', dropoffId: 'afDropoff2' },
    "Pitch ko'rgan": { valueId: 'afPitchViewed', percentId: 'afPitchPercent', dropoffId: 'afDropoff3' },
    'Checkout ochgan': { valueId: 'afCheckout', percentId: 'afCheckoutPercent', dropoffId: 'afDropoff4' },
    "To'lov qilgan": { valueId: 'afPaidUsers', percentId: 'afPaidPercent', dropoffId: null }
  };

  stages.forEach((stage, idx) => {
    const m = mapping[stage.label];
    if (!m) return;

    const valueEl = document.getElementById(m.valueId);
    if (valueEl) valueEl.textContent = (stage.count || 0).toLocaleString();

    if (m.percentId) {
      const percentEl = document.getElementById(m.percentId);
      if (percentEl) {
        percentEl.textContent = (stage.fromStart || 0) + '%';
      }
    }

    if (m.dropoffId && idx < stages.length - 1) {
      const dropoffEl = document.getElementById(m.dropoffId);
      if (dropoffEl) {
        const nextStage = stages[idx + 1];
        const dropoff = stage.count > 0 ? Math.round(((stage.count - (nextStage?.count || 0)) / stage.count) * 100) : 0;
        dropoffEl.textContent = '-' + dropoff + '%';
      }
    }
  });
}

function renderAnalyticsCRHeatmap(data) {
  const container = document.getElementById('analyticsCRHeatmapBody');
  if (!container) return;

  const sources = data?.sources || [];
  if (!sources.length) {
    container.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #7b788a;">Ma\'lumot yo\'q</td></tr>';
    return;
  }

  const getHeatmapClass = (value) => {
    if (value >= 20) return 'excellent';
    if (value >= 15) return 'good';
    if (value >= 10) return 'average';
    if (value >= 5) return 'poor';
    return 'critical';
  };

  const sourceIcons = {
    'direct': { icon: '🌐', bg: '#E0E7FF' },
    'instagram': { icon: '📸', bg: '#FCE7F3' },
    'telegram': { icon: '📱', bg: '#DBEAFE' },
    'facebook': { icon: '👤', bg: '#DBEAFE' },
    'youtube': { icon: '🎬', bg: '#FEE2E2' },
    'tiktok': { icon: '🎵', bg: '#F3E8FF' }
  };

  const formatName = (s) => {
    const names = { 'direct': 'Direct', 'instagram': 'Instagram', 'telegram': 'Telegram', 'facebook': 'Facebook', 'youtube': 'YouTube', 'tiktok': 'TikTok' };
    return names[s] || s;
  };

  container.innerHTML = sources.map(source => {
    const iconInfo = sourceIcons[source.source] || { icon: '🔗', bg: '#E5E7EB' };
    const total = source.total_users || 0;
    const active = source.active_users || Math.round(total * 0.6);
    const pitch = source.pitch_viewed || Math.round(total * 0.3);
    const checkout = source.checkout_opened || Math.round(total * 0.15);
    const paid = source.paid_users || 0;

    const activeRate = total > 0 ? ((active / total) * 100).toFixed(1) : 0;
    const pitchRate = active > 0 ? ((pitch / active) * 100).toFixed(1) : 0;
    const checkoutRate = pitch > 0 ? ((checkout / pitch) * 100).toFixed(1) : 0;
    const paidRate = checkout > 0 ? ((paid / checkout) * 100).toFixed(1) : 0;
    const overallCR = total > 0 ? ((paid / total) * 100).toFixed(1) : 0;

    return `
      <tr>
        <td>
          <div class="heatmap-source">
            <span class="heatmap-source-icon" style="background: ${iconInfo.bg};">${iconInfo.icon}</span>
            ${formatName(source.source)}
          </div>
        </td>
        <td style="text-align: center; font-weight: 600;">${total.toLocaleString()}</td>
        <td style="text-align: center;"><span class="heatmap-cell ${getHeatmapClass(parseFloat(activeRate))}">${activeRate}%</span></td>
        <td style="text-align: center;"><span class="heatmap-cell ${getHeatmapClass(parseFloat(pitchRate))}">${pitchRate}%</span></td>
        <td style="text-align: center;"><span class="heatmap-cell ${getHeatmapClass(parseFloat(checkoutRate))}">${checkoutRate}%</span></td>
        <td style="text-align: center;"><span class="heatmap-cell ${getHeatmapClass(parseFloat(paidRate))}">${paidRate}%</span></td>
        <td style="text-align: center;"><span class="heatmap-cell ${getHeatmapClass(parseFloat(overallCR))}" style="font-size: 12px;">${overallCR}%</span></td>
      </tr>
    `;
  }).join('');
}

function renderAnalyticsInsights(funnelData, segmentData, paymentData) {
  const container = document.getElementById('analyticsInsightsContainer');
  if (!container) return;

  const insights = [];
  const steps = funnelData?.steps || [];

  // Analyze funnel drop-offs
  if (steps.length >= 2) {
    for (let i = 0; i < steps.length - 1; i++) {
      const current = steps[i].count || 0;
      const next = steps[i + 1].count || 0;
      const dropoff = current > 0 ? ((current - next) / current) * 100 : 0;

      if (dropoff > 50) {
        insights.push({
          type: 'critical',
          icon: '⚠️',
          title: `${steps[i].name} → ${steps[i + 1].name} da ${Math.round(dropoff)}% yo'qotish`,
          detail: `${current - next} ta foydalanuvchi keyingi bosqichga o'tmayapti`,
          action: `${steps[i].name} bosqichini tahlil qiling va optimallashtiring`
        });
      } else if (dropoff > 30) {
        insights.push({
          type: 'warning',
          icon: '📊',
          title: `${steps[i].name} → ${steps[i + 1].name} da ${Math.round(dropoff)}% drop-off`,
          detail: 'Bu bosqichda o\'rtacha yo\'qotish bor',
          action: 'Kontentni yaxshilash yoki eslatmalar qo\'shish tavsiya etiladi'
        });
      }
    }
  }

  // Analyze stuck payments
  const stuckPayments = paymentData?.stuck_payments || [];
  if (stuckPayments.length > 3) {
    insights.push({
      type: 'critical',
      icon: '💳',
      title: `${stuckPayments.length} ta to'lov muallaq holda`,
      detail: 'Foydalanuvchilar to\'lovni yakunlamayapti',
      action: 'Ushbu foydalanuvchilarga eslatma xabari yuboring'
    });
  }

  // Positive insights
  const overallCR = funnelData?.overall_cr;
  if (overallCR && overallCR > 10) {
    insights.push({
      type: 'success',
      icon: '🎉',
      title: `Konversiya ${overallCR.toFixed(1)}% - yaxshi natija!`,
      detail: 'Funnel samarali ishlayapti',
      action: 'Shu yo\'nalishda davom eting'
    });
  }

  // Default insight if nothing found
  if (insights.length === 0) {
    insights.push({
      type: 'info',
      icon: '📈',
      title: 'Hozircha tahlil qilish uchun yetarli ma\'lumot yo\'q',
      detail: 'Ko\'proq foydalanuvchilar kelgach tavsiyalar paydo bo\'ladi',
      action: 'Trafikni oshirishga e\'tibor qarating'
    });
  }

  container.innerHTML = insights.slice(0, 4).map(insight => `
    <div class="analytics-insight-card ${insight.type}">
      <div class="analytics-insight-icon">${insight.icon}</div>
      <div class="analytics-insight-content">
        <div class="analytics-insight-title">${insight.title}</div>
        <div class="analytics-insight-detail">${insight.detail}</div>
        <div class="analytics-insight-action">💡 ${insight.action}</div>
      </div>
    </div>
  `).join('');
}

function refreshAnalyticsInsights() {
  loadAnalyticsData(true);
}

// Quick action functions for high-intent users
function sendQuickMessage(telegramId) {
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();
  // Pre-select the user
  const userSelect = document.getElementById('broadcastUserSelect');
  if (userSelect) {
    setTimeout(() => {
      const option = Array.from(userSelect.options).find(opt => opt.value === String(telegramId));
      if (option) option.selected = true;
    }, 100);
  }
}

function sendQuickOffer(telegramId) {
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();
  // Pre-fill with offer template
  const messageInput = document.getElementById('broadcastMessage');
  if (messageInput) {
    messageInput.value = '🎁 Maxsus taklif!\n\nSiz uchun chegirmali narx tayyorladik. Bugun to\'lov qilsangiz, 20% chegirma olasiz!\n\n💰 Batafsil: /checkout';
  }
  const userSelect = document.getElementById('broadcastUserSelect');
  if (userSelect) {
    setTimeout(() => {
      const option = Array.from(userSelect.options).find(opt => opt.value === String(telegramId));
      if (option) option.selected = true;
    }, 100);
  }
}

function renderAnalyticsRevenueChart(data) {
  const ctx = document.getElementById('analyticsRevenueChart');
  if (!ctx) return;

  if (analyticsCharts.revenue) {
    analyticsCharts.revenue.destroy();
  }

  const labels = data.map(d => {
    const date = new Date(d.date);
    return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
  });

  const values = data.map(d => Math.round((d.revenue || 0) / 100));

  analyticsCharts.revenue = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Daromad',
        data: values,
        borderColor: chartAccent(),
        backgroundColor: chartAccentSoft(),
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v.toLocaleString() + " so'm" }
        }
      }
    }
  });
}

function renderSubscribersChart(data) {
  const ctx = document.getElementById('analyticsSubscribersChart');
  if (!ctx) return;

  if (analyticsCharts.subscribers) {
    analyticsCharts.subscribers.destroy();
  }

  const labels = data.map(d => {
    const date = new Date(d.date);
    return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
  });

  const newUsers = data.map(d => d.new_users || 0);
  const paidUsers = data.map(d => d.new_paid || 0);

  analyticsCharts.subscribers = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Yangi userlar',
          data: newUsers,
          backgroundColor: 'rgba(115, 103, 240, 0.72)',
          borderRadius: 4
        },
        {
          label: "To'lagan",
          data: paidUsers,
          backgroundColor: 'rgba(34, 197, 94, 0.7)',
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderSourcesAnalytics(data) {
  const tableBody = document.getElementById('sourcesTable');
  const ctx = document.getElementById('sourcesPieChart');

  if (!data.sources || data.sources.length === 0) {
    if (tableBody) tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Ma\'lumot yo\'q</td></tr>';
    return;
  }

  // Render table
  if (tableBody) {
    tableBody.innerHTML = data.sources.map(s => {
      const conv = s.total_users > 0 ? Math.round((s.paid_users / s.total_users) * 100) : 0;
      const sourceName = getSourceName(s.source);
      return `
        <tr class="border-b border-gray-100">
          <td class="py-3">${sourceName}</td>
          <td class="py-3 font-medium">${s.total_users}</td>
          <td class="py-3 text-green-600">${s.paid_users}</td>
          <td class="py-3"><span class="badge ${conv > 10 ? 'badge-green' : conv > 5 ? 'badge-yellow' : 'badge-gray'}">${conv}%</span></td>
        </tr>
      `;
    }).join('');
  }

  // Render pie chart
  if (ctx) {
    if (analyticsCharts.sources) {
      analyticsCharts.sources.destroy();
    }

    const colors = ['#7367f0', '#28c76f', '#ff9f43', '#ea5455', '#00cfe8', '#a8aaae', '#666cff'];

    analyticsCharts.sources = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: data.sources.map(s => getSourceName(s.source)),
        datasets: [{
          data: data.sources.map(s => s.total_users),
          backgroundColor: colors.slice(0, data.sources.length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' }
        }
      }
    });
  }
}

function getSourceName(source) {
  const names = {
    'direct': '🌐 Direct',
    'instagram': '📸 Instagram',
    'telegram': '📱 Telegram',
    'facebook': '👤 Facebook',
    'youtube': '🎬 YouTube',
    'tiktok': '🎵 TikTok'
  };
  return names[source] || ('🔗 ' + source);
}

function renderBuyerAnalytics(data) {
  // Total buyers
  document.getElementById('buyerAvgLesson').textContent = data.totalBuyers || '0';

  // avgTimeToPurchase is in milliseconds, convert to days
  const avgDays = data.avgTimeToPurchase ? (data.avgTimeToPurchase / (1000 * 60 * 60 * 24)).toFixed(1) : '-';
  document.getElementById('buyerAvgDays').textContent = avgDays;

  // Conversion rate
  document.getElementById('buyerConversion').textContent = data.conversionRate ? data.conversionRate.toFixed(1) + '%' : '0%';

  // Fastest purchase in days
  const fastestDays = data.fastestPurchase ? (data.fastestPurchase / (1000 * 60 * 60 * 24)).toFixed(1) : '-';
  document.getElementById('buyerAvgCheck').textContent = fastestDays + ' kun';

  // Render buyer demographics chart (by age group)
  const ctx = document.getElementById('buyerFunnelChart');
  if (ctx) {
    if (analyticsCharts.buyerFunnel) {
      analyticsCharts.buyerFunnel.destroy();
    }

    const ageData = data.buyersByAge || {};
    const hasAgeData = Object.keys(ageData).length > 0;

    if (hasAgeData) {
      analyticsCharts.buyerFunnel = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(ageData),
          datasets: [{
            label: 'Xaridorlar soni',
        data: Object.values(ageData),
            backgroundColor: ['#7367f0', '#00cfe8', '#ff9f43', '#28c76f', '#ea5455'],
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }
  }
}

function renderInactivityStats(data) {
  document.getElementById('inactTotalDeliveries').textContent = data.total_deliveries || '-';
  document.getElementById('inactWatched').textContent = data.watched || '-';
  document.getElementById('inactReminder1').textContent = data.reminder_1_sent || '-';
  document.getElementById('inactReminder2').textContent = data.reminder_2_sent || '-';
  document.getElementById('inactWatchedAfter').textContent = data.watched_after_reminder || '-';
}

function renderDiagFunnelChart(stages) {
  const ctx = document.getElementById('diagFunnelChart');
  if (!ctx) return;
  if (analyticsCharts.diagFunnel) analyticsCharts.diagFunnel.destroy();
  if (!Array.isArray(stages) || stages.length === 0) return;

  // Create gradient colors for funnel effect
  const funnelColors = [
    'rgba(99, 102, 241, 0.9)',   // Indigo - Start
    'rgba(139, 92, 246, 0.85)',  // Purple
    'rgba(167, 139, 250, 0.8)',  // Light purple
    'rgba(196, 181, 253, 0.75)', // Lighter
    'rgba(34, 197, 94, 0.85)'    // Green - End (paid)
  ];

  const borderColors = [
    'rgba(99, 102, 241, 1)',
    'rgba(139, 92, 246, 1)',
    'rgba(167, 139, 250, 1)',
    'rgba(196, 181, 253, 1)',
    'rgba(34, 197, 94, 1)'
  ];

  analyticsCharts.diagFunnel = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stages.map((s) => s.label),
      datasets: [{
        label: 'Foydalanuvchilar',
        data: stages.map((s) => s.count || 0),
        backgroundColor: stages.map((_, i) => funnelColors[i % funnelColors.length]),
        borderColor: stages.map((_, i) => borderColors[i % borderColors.length]),
        borderWidth: 2,
        borderRadius: 10,
        borderSkipped: false,
        maxBarThickness: 60
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y', // Horizontal bars for funnel effect
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleFont: { size: 13, weight: 'bold' },
          bodyFont: { size: 12 },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            afterLabel: function(context) {
              const idx = context.dataIndex;
              if (idx < stages.length - 1) {
                const current = stages[idx].count || 0;
                const next = stages[idx + 1]?.count || 0;
                const dropoff = current > 0 ? Math.round(((current - next) / current) * 100) : 0;
                return `📉 Keyingi bosqichga: -${dropoff}%`;
              }
              return '✅ Yakuniy bosqich';
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.05)' },
          ticks: {
            precision: 0,
            font: { size: 11 }
          }
        },
        y: {
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: '600' },
            color: '#374151'
          }
        }
      }
    }
  });
}

function renderSegmentMixChart(data) {
  const ctx = document.getElementById('segmentMixChart');
  if (!ctx) return;
  if (analyticsCharts.segmentMix) analyticsCharts.segmentMix.destroy();

  const sources = Array.isArray(data?.sources) ? data.sources : [];
  const lessons = Array.isArray(data?.lessons) ? data.lessons : [];
  const activity = Array.isArray(data?.activity) ? data.activity : [];
  const buckets = [
    { label: 'Manba', value: sources.length ? Math.max(...sources.map((x) => Number(x.conversion) || 0)) : 0 },
    { label: 'Dars', value: lessons.length ? Math.max(...lessons.map((x) => Number(x.conversion) || 0)) : 0 },
    { label: 'Aktivlik', value: activity.length ? Math.max(...activity.map((x) => Number(x.conversion) || 0)) : 0 }
  ];

  analyticsCharts.segmentMix = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: buckets.map((b) => b.label),
      datasets: [{
        label: 'Top CR',
        data: buckets.map((b) => b.value),
        borderColor: '#7367f0',
        backgroundColor: 'rgba(115,103,240,0.2)',
        pointBackgroundColor: '#7367f0',
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        r: {
          beginAtZero: true,
          suggestedMax: 100,
          ticks: { stepSize: 20, backdropColor: 'transparent' }
        }
      }
    }
  });
}

function renderPayMethodChart(methods) {
  const ctx = document.getElementById('payMethodChart');
  if (!ctx) return;
  if (analyticsCharts.payMethods) analyticsCharts.payMethods.destroy();

  const rows = Array.isArray(methods) ? methods : [];
  if (!rows.length) return;
  analyticsCharts.payMethods = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: rows.map((m) => (m.payment_method || 'unknown').toUpperCase()),
      datasets: [{
        data: rows.map((m) => Number(m.conversion) || 0),
        backgroundColor: ['#f59e0b', '#3b82f6', '#22c55e', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10, padding: 14 } }
      }
    }
  });
}

function getFunnelStageHint(stageLabel) {
  const label = String(stageLabel || '').toLowerCase();
  if (label.includes("ro'yxat") || label.includes("register")) return "Start nuqta";
  if (label.includes("darsni boshlagan")) return "Onboarding bosqichi";
  if (label.includes("1-dars")) return "Kontentga kirish";
  if (label.includes("pitch")) return "Sotuvga qiziqish";
  if (label.includes("checkout")) return "To'lov niyati";
  if (label.includes("to'lov") || label.includes("paid")) return "Yakuniy konversiya";
  return "Bosqich holati";
}

function renderFunnelDiagnostics(data) {
  const summary = data?.summary || {};
  const stages = Array.isArray(data?.stages) ? data.stages : [];
  const alerts = Array.isArray(data?.alerts) ? data.alerts : [];
  const biggestDrop = data?.biggestDrop || null;

  const overallCrEl = document.getElementById('diagOverallCR');
  const biggestDropEl = document.getElementById('diagBiggestDrop');
  const stuckEl = document.getElementById('diagStuckUsers');
  const nextActionEl = document.getElementById('diagNextAction');
  const tableBody = document.getElementById('diagFunnelTable');
  const alertsWrap = document.getElementById('diagAlerts');

  if (overallCrEl) overallCrEl.textContent = (summary.overallConversion ?? 0) + '%';
  if (biggestDropEl) {
    biggestDropEl.textContent = biggestDrop
      ? `${biggestDrop.from} -> ${biggestDrop.to} (-${biggestDrop.dropCount})`
      : '-';
  }
  if (stuckEl) stuckEl.textContent = summary.pitchWithoutCheckout ?? 0;
  if (nextActionEl) nextActionEl.textContent = data?.nextAction || '-';
  renderDiagFunnelChart(stages);

  if (tableBody) {
    if (!stages.length) {
      tableBody.innerHTML = '<tr><td colspan="5" class="py-3 text-center text-gray-400">Ma\'lumot yo\'q</td></tr>';
    } else {
      tableBody.innerHTML = stages.map((s) => `
        <tr class="border-b border-gray-100">
          <td class="py-2 px-3" data-label="Bosqich">${s.label}</td>
          <td class="py-2 px-3 font-semibold" data-label="User">${s.count}</td>
          <td class="py-2 px-3" data-label="Prev dan">${(s.fromPrev ?? 0)}%</td>
          <td class="py-2 px-3" data-label="Start dan">${(s.fromStart ?? 0)}%</td>
          <td class="py-2 px-3 text-xs text-gray-600" data-label="Izoh">${getFunnelStageHint(s.label)}</td>
        </tr>
      `).join('');
    }
  }

  if (alertsWrap) {
    if (!alerts.length) {
      alertsWrap.innerHTML = '<div class="text-sm text-green-700 bg-green-50 border border-green-100 rounded-lg px-3 py-2">Hozircha kritik signal yo\'q.</div>';
    } else {
      alertsWrap.innerHTML = alerts.map((a) => {
        const tone = a.level === 'high'
          ? 'bg-red-50 border-red-100 text-red-700'
          : a.level === 'medium'
            ? 'bg-amber-50 border-amber-100 text-amber-700'
            : 'bg-blue-50 border-blue-100 text-blue-700';
        return `
          <div class="border rounded-lg px-3 py-2 ${tone}">
            <div class="font-semibold text-sm">${a.title}</div>
            <div class="text-xs mt-1">${a.detail}</div>
          </div>
        `;
      }).join('');
    }
  }
}

function renderSegmentDiagnostics(data) {
  latestSegmentDiagnostics = data || null;

  const sourceList = document.getElementById('segmentSourceList');
  const lessonList = document.getElementById('segmentLessonList');
  const activityList = document.getElementById('segmentActivityList');
  const highIntentTable = document.getElementById('highIntentTable');
  const highIntentCount = document.getElementById('highIntentCount');
  const highIntentActionBtn = document.getElementById('diagActionHighIntentBtn');

  const renderSimpleList = (rows, toneClass) => {
    if (!Array.isArray(rows) || rows.length === 0) return '<div class="text-gray-400">Ma\'lumot yo\'q</div>';
    return rows.slice(0, 8).map((r) => `
      <div class="diag-list-row">
        <div class="diag-list-head">
          <span class="diag-list-label">${escapeHtml(String(r.segment || '-'))}</span>
          <span class="diag-list-meta">${r.paid_users}/${r.total_users} (${r.conversion}%)</span>
        </div>
        <div class="diag-progress">
          <div class="diag-progress-fill ${toneClass}" style="width:${Math.max(0, Math.min(100, Number(r.conversion) || 0))}%"></div>
        </div>
      </div>
    `).join('');
  };

  if (sourceList) sourceList.innerHTML = renderSimpleList(data?.sources, 'source');
  if (lessonList) lessonList.innerHTML = renderSimpleList(data?.lessons, 'lesson');
  if (activityList) activityList.innerHTML = renderSimpleList(data?.activity, 'activity');
  renderSegmentMixChart(data);

  const highIntent = Array.isArray(data?.highIntent) ? data.highIntent : [];
  if (highIntentCount) highIntentCount.textContent = `${highIntent.length} ta`;
  if (highIntentActionBtn) {
    highIntentActionBtn.disabled = highIntent.length === 0;
    highIntentActionBtn.textContent = highIntent.length > 0
      ? `High-intent follow-up (${Math.min(highIntent.length, 100)})`
      : 'High-intent yo\'q';
  }

  if (highIntentTable) {
    if (highIntent.length === 0) {
      highIntentTable.innerHTML = '<tr><td colspan="5" class="py-3 text-center text-gray-400">High-intent user topilmadi</td></tr>';
    } else {
      const topRows = highIntent.slice(0, 20);
      highIntentTable.innerHTML = topRows.map((u) => {
        const signal = [];
        if (u.sales_pitch_seen_at) signal.push('Pitch');
        if ((u.current_lesson || 0) >= 3) signal.push('3+ dars');
        if ((u.score || 0) >= 4) signal.push('Yuqori');
        return `
          <tr class="border-b border-gray-100">
            <td class="py-2" data-label="User">
              <div class="font-medium text-gray-800">${escapeHtml(u.full_name || u.username || String(u.telegram_id))}</div>
              <div class="text-xs text-gray-400">ID: ${u.telegram_id}</div>
            </td>
            <td class="py-2" data-label="Dars">${u.current_lesson || 0}</td>
            <td class="py-2" data-label="Signal">${escapeHtml(signal.join(', ') || '-')}</td>
            <td class="py-2" data-label="Oxirgi aktivlik">${u.last_activity ? fmtDateTime(u.last_activity) : '-'}</td>
            <td class="py-2" data-label="Harakatlar">
              <div class="high-intent-quick-actions">
                <button class="high-intent-action" onclick="sendQuickMessage(${u.telegram_id})" title="Xabar yuborish">💬</button>
                <button class="high-intent-action primary" onclick="sendQuickOffer(${u.telegram_id})" title="Maxsus taklif">🎁</button>
              </div>
            </td>
          </tr>
        `;
      }).join('') + (highIntent.length > topRows.length
        ? `<tr><td colspan="5" class="py-3 text-center text-xs text-gray-500">Yana ${highIntent.length - topRows.length} ta user bor</td></tr>`
        : '');
    }
  }
}

function prepareHighIntentBroadcast() {
  const users = latestSegmentDiagnostics?.highIntent || [];
  if (!Array.isArray(users) || users.length === 0) {
    alert('High-intent user topilmadi');
    return;
  }

  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  selectedBroadcastUsers.clear();
  users.slice(0, 100).forEach((u) => {
    if (u?.telegram_id) selectedBroadcastUsers.add(Number(u.telegram_id));
  });

  const textArea = document.getElementById('broadcastText');
  if (textArea && !textArea.value.trim()) {
    textArea.value = "Assalomu alaykum {{ism}}! Siz uchun maxsus taklif bor.\n\nBugun to'lov qilsangiz, bonus darslar ham qo'shib beramiz. Savol bo'lsa shu yerga yozing.";
    updatePreview();
  }
  prefillPaymentButtons();

  updateSelectedUsersList();
  updateRecipientCount();
}

function renderPaymentFrictionDiagnostics(data) {
  latestPaymentFrictionDiagnostics = data || null;

  const summary = data?.summary || {};
  const methods = Array.isArray(data?.methods) ? data.methods : [];
  const stuck = Array.isArray(data?.stuckPayments) ? data.stuckPayments : [];

  const pitchToCheckout = document.getElementById('payDiagPitchToCheckout');
  const checkoutToPrepared = document.getElementById('payDiagCheckoutToPrepared');
  const preparedToCompleted = document.getElementById('payDiagPreparedToCompleted');
  const stuckCount = document.getElementById('payDiagStuckCount');
  const methodWrap = document.getElementById('payDiagMethods');
  const nextAction = document.getElementById('payDiagNextAction');
  const stuckTable = document.getElementById('payDiagStuckTable');
  const stuckActionBtn = document.getElementById('diagActionStuckBtn');

  if (pitchToCheckout) pitchToCheckout.textContent = `${summary.pitchToCheckout ?? 0}%`;
  if (checkoutToPrepared) checkoutToPrepared.textContent = `${summary.checkoutToPrepared ?? 0}%`;
  if (preparedToCompleted) preparedToCompleted.textContent = `${summary.preparedToCompleted ?? 0}%`;
  if (stuckCount) stuckCount.textContent = `${stuck.length}`;
  if (nextAction) nextAction.textContent = data?.nextAction || '-';
  if (stuckActionBtn) {
    stuckActionBtn.disabled = stuck.length === 0;
    stuckActionBtn.textContent = stuck.length > 0
      ? `Stuck follow-up (${Math.min(stuck.length, 100)})`
      : 'Stuck to\'lov yo\'q';
  }
  renderPayMethodChart(methods);

  if (methodWrap) {
    if (!methods.length) {
      methodWrap.innerHTML = '<div class="text-gray-400">Ma\'lumot yo\'q</div>';
    } else {
      methodWrap.innerHTML = methods.map((m) => `
        <div class="diag-list-row">
          <div class="diag-list-head">
            <span class="diag-list-label">${escapeHtml((m.payment_method || '-').toUpperCase())}</span>
            <span class="diag-list-meta">${m.completed_orders}/${m.total_orders} (${m.conversion}%)</span>
          </div>
          <div class="diag-progress">
            <div class="diag-progress-fill method" style="width:${Math.max(0, Math.min(100, Number(m.conversion) || 0))}%"></div>
          </div>
        </div>
      `).join('');
    }
  }

  if (stuckTable) {
    if (!stuck.length) {
      stuckTable.innerHTML = '<tr><td colspan="5" class="py-3 text-center text-gray-400">Stuck to\'lov topilmadi</td></tr>';
    } else {
      const topRows = stuck.slice(0, 20);
      stuckTable.innerHTML = topRows.map((p) => {
        const ageMin = Math.max(0, Math.floor((p.age_seconds || 0) / 60));
        return `
          <tr class="border-b border-gray-100">
            <td class="py-2" data-label="User">
              <div class="font-medium text-gray-800">${escapeHtml(p.full_name || p.username || String(p.telegram_id))}</div>
              <div class="text-xs text-gray-400">ID: ${p.telegram_id}</div>
            </td>
            <td class="py-2" data-label="Buyurtma">${escapeHtml(p.order_id || '-')}</td>
            <td class="py-2" data-label="Holat"><span class="diag-chip">${escapeHtml(p.state || '-')}</span></td>
            <td class="py-2" data-label="Usul"><span class="diag-chip">${escapeHtml((p.payment_method || 'unknown').toUpperCase())}</span></td>
            <td class="py-2" data-label="Qachondan beri">${ageMin} daqiqa</td>
          </tr>
        `;
      }).join('') + (stuck.length > topRows.length
        ? `<tr><td colspan="5" class="py-3 text-center text-xs text-gray-500">Yana ${stuck.length - topRows.length} ta stuck buyurtma bor</td></tr>`
        : '');
    }
  }
}

function prepareStuckPaymentsBroadcast() {
  const stuck = latestPaymentFrictionDiagnostics?.stuckPayments || [];
  if (!Array.isArray(stuck) || stuck.length === 0) {
    alert("Stuck to'lov userlari topilmadi");
    return;
  }

  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  selectedBroadcastUsers.clear();
  const uniq = new Set();
  stuck.forEach((p) => {
    const id = Number(p.telegram_id);
    if (Number.isFinite(id) && !uniq.has(id)) {
      uniq.add(id);
      if (uniq.size <= 100) selectedBroadcastUsers.add(id);
    }
  });

  const textArea = document.getElementById('broadcastText');
  if (textArea && !textArea.value.trim()) {
    textArea.value = "Assalomu alaykum {{ism}}! To'lov jarayoni oxirigacha bormagan ko'rinadi.\n\nQulay bo'lsa hozir yakunlab qo'ying, savol bo'lsa shu yerga yozing.";
    updatePreview();
  }
  prefillPaymentButtons();

  updateSelectedUsersList();
  updateRecipientCount();
}

// ========== REFERRALS TAB ==========
async function loadReferralData() {
  try {
    const [referralData, inviteData] = await Promise.all([
      fetch('/api/analytics/referrals', { headers: { Authorization: auth } }).then(r => r.json()),
      fetch('/api/invite-links', { headers: { Authorization: auth } }).then(r => r.json())
    ]);

    // Render referral stats
    const stats = referralData.stats || {};
    document.getElementById('refTotalReferrals').textContent = formatters.number(stats.total_referrals || 0);
    document.getElementById('refQualified').textContent = formatters.number(stats.qualified_referrals || 0);
    document.getElementById('refDiscountsUsed').textContent = formatters.number(stats.discounts_used || 0);
    document.getElementById('refActiveReferrers').textContent = formatters.number(stats.total_referrers || 0);

    // Render leaderboard
    const leaderboard = referralData.leaderboard || [];
    const tbody = document.getElementById('referralLeaderboard');
    if (leaderboard.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-400">Hozircha referallar yo\'q</td></tr>';
    } else {
      tbody.innerHTML = leaderboard.map((u, i) => {
        const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : (i + 1);
        const discount = u.referral_discount_used ? '<span class="badge badge-green">Oldi</span>' : '<span class="badge badge-gray">-</span>';
        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 font-medium">${medal}</td>
            <td class="py-3">${escapeHtml(u.full_name || u.username || u.telegram_id)}</td>
            <td class="py-3 text-center font-bold text-indigo-600">${u.referral_count}</td>
            <td class="py-3">${discount}</td>
          </tr>
        `;
      }).join('');
    }

    // Render invite links stats
    const links = inviteData.links || [];
    const totalLinks = links.length;
    const usedLinks = links.filter(l => l.is_used).length;
    document.getElementById('inviteTotal').textContent = totalLinks;
    document.getElementById('inviteUsed').textContent = usedLinks;
    document.getElementById('inviteUnused').textContent = totalLinks - usedLinks;

  } catch(e) {
    console.error('loadReferralData error:', e);
  }
}

// ========== AUDIT LOG TAB ==========
async function loadAuditLogs(offset = 0) {
  auditOffset = Math.max(0, offset);

  try {
    const action = document.getElementById('auditActionFilter').value;
    const date = document.getElementById('auditDateFilter').value;

    let url = `/api/audit-logs?limit=50&offset=${auditOffset}`;
    if (action) url += '&action=' + encodeURIComponent(action);
    if (date) url += '&startDate=' + date + '&endDate=' + date;

    const logs = await fetch(url, { headers: { Authorization: auth } }).then(r => r.json());

    const tbody = document.getElementById('auditLogsTable');

    if (!logs || logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">Log topilmadi</td></tr>';
      document.getElementById('auditPrevBtn').disabled = true;
      document.getElementById('auditNextBtn').disabled = true;
      document.getElementById('auditPageInfo').textContent = '0';
      return;
    }

    tbody.innerHTML = logs.map(log => {
      const time = new Date(log.timestamp).toLocaleString('uz-UZ', {
        day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
      });
      const actionBadge = getAuditActionBadge(log.action);
      const details = log.details ? JSON.stringify(log.details).slice(0, 50) : '-';

      return `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-3 text-xs text-gray-500">${time}</td>
          <td class="py-3">${actionBadge}</td>
          <td class="py-3 text-sm">${escapeHtml(log.user || '-')}</td>
          <td class="py-3 text-sm">${escapeHtml(log.target || '-')}</td>
          <td class="py-3 text-xs text-gray-400 truncate max-w-[200px]">${escapeHtml(details)}</td>
        </tr>
      `;
    }).join('');

    // Update pagination
    document.getElementById('auditPrevBtn').disabled = auditOffset === 0;
    document.getElementById('auditNextBtn').disabled = logs.length < 50;
    document.getElementById('auditPageInfo').textContent = `${auditOffset + 1}-${auditOffset + logs.length}`;

  } catch(e) {
    console.error('loadAuditLogs error:', e);
    document.getElementById('auditLogsTable').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-400">Xatolik yuz berdi</td></tr>';
  }
}

function getAuditActionBadge(action) {
  const badges = {
    'PAYMENT_COMPLETED': '<span class="badge badge-green">To\'lov</span>',
    'PAYMENT_CREATED': '<span class="badge badge-blue">To\'lov yaratildi</span>',
    'PAYMENT_FAILED': '<span class="badge badge-red">To\'lov xato</span>',
    'USER_CREATED': '<span class="badge badge-blue">Yangi user</span>',
    'USER_UPDATED': '<span class="badge badge-yellow">User yangilandi</span>',
    'SETTINGS_CHANGED': '<span class="badge badge-orange">Sozlama</span>',
    'SECURITY_SUSPICIOUS': '<span class="badge badge-red">Xavfsizlik</span>',
    'SECURITY_RATE_LIMIT': '<span class="badge badge-orange">Rate limit</span>',
    'SUBSCRIPTION_CREATED': '<span class="badge badge-green">Obuna</span>',
    'REFERRAL_CREATED': '<span class="badge badge-blue">Referal</span>',
    'BROADCAST_SENT': '<span class="badge badge-purple">Xabar</span>'
  };
  return badges[action] || `<span class="badge badge-gray">${action}</span>`;
}

async function exportCustDevAnswers() {
  try {
    const answers = await fetch('/api/custdev/answers', { headers: { Authorization: auth } }).then(r => r.json());

    if (!answers || answers.length === 0) {
      alert('Eksport qilish uchun javob topilmadi');
      return;
    }

    // Get all unique question IDs
    const questions = [...new Set(answers.map(a => a.question_id))];

    // Get question texts
    const questionsData = await fetch('/api/custdev', { headers: { Authorization: auth } }).then(r => r.json());
    const questionMap = {};
    questionsData.forEach(q => { questionMap[q.id] = q.question; });

    // Build CSV with user info and their answers
    const userAnswers = {};
    answers.forEach(a => {
      if (!userAnswers[a.telegram_id]) {
        userAnswers[a.telegram_id] = { telegram_id: a.telegram_id };
      }
      userAnswers[a.telegram_id]['q_' + a.question_id] = a.answer;
    });

    const headers = ['Telegram ID', ...questions.map(qId => questionMap[qId] || 'Savol ' + qId)];
    const rows = Object.values(userAnswers).map(u => {
      return [u.telegram_id, ...questions.map(qId => u['q_' + qId] || '')];
    });

    const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'custdev_answers_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();

  } catch(e) {
    console.error('exportCustDevAnswers error:', e);
    alert('Eksport xatosi: ' + e.message);
  }
}

async function exportAuditLogs() {
  try {
    const action = document.getElementById('auditActionFilter').value;
    const date = document.getElementById('auditDateFilter').value;

    let url = '/api/audit-logs?limit=10000';
    if (action) url += '&action=' + encodeURIComponent(action);
    if (date) url += '&startDate=' + date + '&endDate=' + date;

    const logs = await fetch(url, { headers: { Authorization: auth } }).then(r => r.json());

    if (!logs || logs.length === 0) {
      alert('Eksport qilish uchun log topilmadi');
      return;
    }

    // Convert to CSV
    const headers = ['Vaqt', 'Harakat', 'Foydalanuvchi', 'Maqsad', 'Tafsilotlar'];
    const rows = logs.map(log => [
      log.timestamp,
      log.action,
      log.user || '',
      log.target || '',
      log.details ? JSON.stringify(log.details) : ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'audit_logs_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();

  } catch(e) {
    console.error('exportAuditLogs error:', e);
    alert('Eksport xatosi: ' + e.message);
  }
}

// ========== HELPERS ==========
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const now = new Date();
  const date = new Date(dateStr);
  const seconds = Math.floor((now - date) / 1000);

  if (seconds < 60) return 'hozirgina';
  if (seconds < 3600) return Math.floor(seconds / 60) + ' daqiqa oldin';
  if (seconds < 86400) return Math.floor(seconds / 3600) + ' soat oldin';
  if (seconds < 604800) return Math.floor(seconds / 86400) + ' kun oldin';
  return fmtDate(dateStr);
}

function fmtMoney(tiyin) {
  const som = Math.round(tiyin / 100);
  return som.toLocaleString('uz-UZ') + ' so\'m';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
}

function fmtDateTime(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
</script>

</body>
</html>
