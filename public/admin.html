<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); min-height: 100vh; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }

    /* Sidebar */
    .sidebar { width: 70px; background: linear-gradient(180deg, #fff 0%, #fafaff 100%); border-right: 1px solid #e5e7eb; box-shadow: 2px 0 8px rgba(99,102,241,0.05); }
    .sidebar-item { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #9ca3af; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; font-size: 20px; }
    .sidebar-item:hover { background: #f3f4f6; color: #6366f1; transform: scale(1.05); }
    .sidebar-item.active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }

    /* Cards */
    .card { background: #fff; border-radius: 16px; border: 1px solid rgba(99,102,241,0.08); box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: all 0.25s ease; }
    .card-hover:hover { box-shadow: 0 8px 30px rgba(99,102,241,0.12); transform: translateY(-3px); border-color: rgba(99,102,241,0.15); }

    /* Stat card with icon */
    .stat-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

    /* Table */
    .table-row { border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: all 0.15s ease; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover { background: linear-gradient(90deg, #f8faff 0%, #fff 100%); }

    /* Badge */
    .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-green { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
    .badge-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1d4ed8; }
    .badge-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #c2410c; }
    .badge-yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309; }
    .badge-red { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }

    /* Button */
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 14px rgba(99,102,241,0.35); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.45); }
    .btn-secondary { background: #fff; color: #374151; border: 1px solid #e5e7eb; }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; transform: translateY(-1px); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; box-shadow: 0 4px 14px rgba(239,68,68,0.35); }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(239,68,68,0.45); }

    /* Input */
    .input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; transition: all 0.2s; background: #fafafa; }
    .input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99,102,241,0.1); background: #fff; }
    .input::placeholder { color: #9ca3af; }

    /* Modal */
    .modal-overlay { background: rgba(17,24,39,0.4); backdrop-filter: blur(8px); }
    .modal-content { background: #fff; border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-lg { max-width: 800px; }

    /* Activity item */
    .activity-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

    /* Tab */
    .tab { padding: 10px 18px; border-radius: 10px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.25s ease; }
    .tab:hover { background: #f3f4f6; color: #4b5563; }
    .tab.active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }

    /* Chart container */
    .chart-container { position: relative; height: 200px; }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; }

    /* Hide scrollbar for mobile nav */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile bottom nav */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0 !important; }
      .mobile-nav { display: flex !important; }
      .right-panel { display: none; }
    }
    .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #eee; padding: 8px 16px; z-index: 50; }
    .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px; border-radius: 10px; color: #9ca3af; font-size: 10px; }
    .mobile-nav-item.active { color: #6366f1; background: #eef2ff; }

    /* File ID Input */
    .file-id-input { font-family: monospace; font-size: 12px; background: #f9fafb; }

    /* Funnel Visualization */
    .funnel-container { position: relative; }
    .funnel-step {
      position: relative;
      margin: 0 auto;
      padding: 8px 12px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .funnel-step:hover { transform: scale(1.02); }
    .funnel-step::before {
      content: '';
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      border-radius: 4px;
      z-index: -1;
    }
    .funnel-label { font-size: 11px; font-weight: 500; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .funnel-count { font-size: 14px; font-weight: 700; color: #fff; }
    .funnel-pct { font-size: 10px; color: rgba(255,255,255,0.8); }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 z-50">
  <div class="card p-8 w-full max-w-sm mx-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <span class="text-3xl">ğŸš€</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
      <p class="text-gray-500 text-sm mt-1">Tizimga kirish</p>
    </div>
    <form id="loginForm">
      <input type="text" id="username" class="input mb-3" placeholder="Login" required>
      <input type="password" id="password" class="input mb-4" placeholder="Parol" required>
      <button type="submit" class="btn btn-primary w-full">Kirish</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden">Login yoki parol xato</p>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="hidden flex min-h-screen">

  <!-- Left Sidebar -->
  <aside class="sidebar fixed left-0 top-0 bottom-0 flex flex-col items-center py-6 z-40">
    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-lg font-bold mb-8">F</div>

    <nav class="flex flex-col gap-2 flex-1">
      <div class="sidebar-item active" data-tab="overview" title="Umumiy">ğŸ“Š</div>
      <div class="sidebar-item" data-tab="users" title="Foydalanuvchilar">ğŸ‘¥</div>
      <div class="sidebar-item" data-tab="payments" title="To'lovlar">ğŸ’³</div>
      <div class="sidebar-item" data-tab="lessons" title="Darslar">ğŸ“š</div>
      <div class="sidebar-item" data-tab="progrev" title="Progrevlar">ğŸ”¥</div>
      <div class="sidebar-item" data-tab="custdev" title="CustDev">ğŸ“</div>
      <div class="sidebar-item" data-tab="settings" title="Sozlamalar">âš™ï¸</div>
    </nav>

    <div class="sidebar-item text-red-400" onclick="logout()" title="Chiqish">ğŸšª</div>
  </aside>

  <!-- Mobile Bottom Nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="overview"><span class="text-lg">ğŸ“Š</span>Umumiy</div>
    <div class="mobile-nav-item" data-tab="users"><span class="text-lg">ğŸ‘¥</span>Userlar</div>
    <div class="mobile-nav-item" data-tab="payments"><span class="text-lg">ğŸ’³</span>To'lov</div>
    <div class="mobile-nav-item" data-tab="lessons"><span class="text-lg">ğŸ“š</span>Darslar</div>
    <div class="mobile-nav-item" data-tab="settings"><span class="text-lg">âš™ï¸</span>Sozlama</div>
  </nav>

  <!-- Main Content -->
  <main class="main-content flex-1 ml-[70px] p-6 pb-24 md:pb-6">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <p class="text-gray-500 text-sm" id="currentDate"></p>
      </div>
      <div class="flex gap-3">
        <button onclick="openBroadcastModal()" class="btn btn-primary flex items-center gap-2">
          <span>ğŸ“¨</span> Xabar yuborish
        </button>
        <button onclick="loadAll()" class="btn btn-secondary">ğŸ”„</button>
      </div>
    </header>

    <!-- Overview Tab -->
    <div id="tab-overview">

      <!-- Quick Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-20 h-20 bg-indigo-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600">ğŸ‘¥</div>
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide font-medium">Jami userlar</p>
              <p class="text-2xl font-bold text-gray-800" id="statTotalUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-20 h-20 bg-green-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">ğŸ’</div>
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide font-medium">To'lagan</p>
              <p class="text-2xl font-bold text-green-600" id="statPaidUsers">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-blue-100 to-cyan-100 text-blue-600">ğŸ’°</div>
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide font-medium">Daromad</p>
              <p class="text-2xl font-bold text-blue-600" id="statRevenue">0</p>
            </div>
          </div>
        </div>
        <div class="card p-5 card-hover relative overflow-hidden">
          <div class="absolute top-0 right-0 w-20 h-20 bg-orange-50 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="flex items-center gap-4 relative">
            <div class="stat-icon bg-gradient-to-br from-orange-100 to-amber-100 text-orange-600">ğŸ“ˆ</div>
            <div>
              <p class="text-gray-400 text-xs uppercase tracking-wide font-medium">Konversiya</p>
              <p class="text-2xl font-bold text-orange-600" id="statConversion">0%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Revenue Chart -->
        <div class="card p-5 lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <div>
              <p class="text-gray-500 text-sm">Daromad</p>
              <p class="text-3xl font-bold text-gray-800" id="totalRevenueDisplay">0 so'm</p>
            </div>
            <div class="flex gap-2">
              <button class="tab active" data-period="week">Hafta</button>
              <button class="tab" data-period="month">Oy</button>
              <button class="tab" data-period="year">Yil</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <!-- User Types -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">Foydalanuvchilar</h3>
          <div class="chart-container h-[180px]">
            <canvas id="userTypeChart"></canvas>
          </div>
          <div class="mt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-indigo-500"></span> Aktiv</span>
              <span class="font-medium" id="activeUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> To'lagan</span>
              <span class="font-medium" id="paidUsersCount">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-300"></span> Tugatgan</span>
              <span class="font-medium" id="completedUsersCount">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Users -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi foydalanuvchilar</h3>
            <button onclick="showTab('users')" class="text-indigo-600 text-sm font-medium">Barchasi â†’</button>
          </div>
          <div id="recentUsersList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>

        <!-- Recent Payments -->
        <div class="card">
          <div class="p-5 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">So'nggi to'lovlar</h3>
            <button onclick="showTab('payments')" class="text-indigo-600 text-sm font-medium">Barchasi â†’</button>
          </div>
          <div id="recentPaymentsList" class="divide-y divide-gray-50">
            <div class="p-4 text-center text-gray-400">Yuklanmoqda...</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex flex-col md:flex-row justify-between gap-4">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ‘¥ Foydalanuvchilar</h3>
          <div class="flex gap-2">
            <select id="userStatusFilter" class="input py-2 px-3 w-auto" onchange="loadUsers()">
              <option value="all">Barchasi</option>
              <option value="active">Aktiv</option>
              <option value="paid">To'lagan</option>
              <option value="completed">Tugatgan</option>
            </select>
            <input type="text" id="userSearch" class="input py-2 px-3 w-48" placeholder="ğŸ” Qidirish..." oninput="searchUsers()">
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dars</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-100 flex justify-center gap-2" id="usersPagination"></div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="tab-payments" class="hidden">
      <!-- Payment Status Tabs -->
      <div class="flex gap-2 mb-4">
        <button class="tab active" data-payment-status="completed" onclick="filterPayments('completed')">âœ… To'langan</button>
        <button class="tab" data-payment-status="pending" onclick="filterPayments('pending')">â³ Jarayonda</button>
        <button class="tab" data-payment-status="cancelled" onclick="filterPayments('cancelled')">âŒ Bekor qilingan</button>
        <button class="tab" data-payment-status="all" onclick="filterPayments('all')">ğŸ“‹ Barchasi</button>
      </div>

      <!-- Payment Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Bugun</p>
          <p class="text-2xl font-bold text-green-600" id="payToday">0</p>
          <p class="text-xs text-gray-400" id="payTodayCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Hafta</p>
          <p class="text-2xl font-bold text-blue-600" id="payWeek">0</p>
          <p class="text-xs text-gray-400" id="payWeekCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Oy</p>
          <p class="text-2xl font-bold text-indigo-600" id="payMonth">0</p>
          <p class="text-xs text-gray-400" id="payMonthCount">0 ta</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami</p>
          <p class="text-2xl font-bold text-gray-800" id="payTotal">0</p>
          <p class="text-xs text-gray-400" id="payTotalCount">0 ta</p>
        </div>
      </div>

      <!-- Payment Status Summary -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="card p-4 border-l-4 border-green-500">
          <p class="text-sm text-gray-500">To'langan</p>
          <p class="text-xl font-bold text-green-600" id="payCompletedCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-yellow-500">
          <p class="text-sm text-gray-500">Jarayonda</p>
          <p class="text-xl font-bold text-yellow-600" id="payPendingCount">0</p>
        </div>
        <div class="card p-4 border-l-4 border-red-500">
          <p class="text-sm text-gray-500">Bekor qilingan</p>
          <p class="text-xl font-bold text-red-600" id="payCancelledCount">0</p>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="card">
        <div class="p-5 border-b border-gray-100">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ’³ To'lovlar tarixi</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sana</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Foydalanuvchi</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Summa</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reja</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tizim</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
              <tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lessons Tab -->
    <div id="tab-lessons" class="hidden">
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ“š Darslar</h3>
          <button onclick="openLessonModal()" class="btn btn-primary">+ Yangi dars</button>
        </div>
        <div id="lessonsList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>

      <!-- Lesson Progress Stats -->
      <div class="card mt-6 p-5">
        <h3 class="font-semibold text-gray-800 mb-4">ğŸ“Š Darslar bo'yicha statistika</h3>
        <div id="lessonProgressStats" class="space-y-3">
          <p class="text-gray-400 text-center">Yuklanmoqda...</p>
        </div>
      </div>

      <!-- Media ID Info -->
      <div class="card mt-6 p-5 bg-blue-50 border-blue-200">
        <h3 class="font-semibold text-blue-800 mb-2">ğŸ’¡ Media ID olish</h3>
        <p class="text-sm text-blue-600">
          Telegram botga video/audio/fayl/video xabar yuboring - bot sizga File ID beradi.
          O'sha ID ni darsga joylashtirsangiz, foydalanuvchilarga o'sha media yuboriladi.
        </p>
      </div>
    </div>

    <!-- Progrev Tab (Pitch/Sales/Soft Attack) -->
    <div id="tab-progrev" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Pitch Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ¬ Pitch (Asosiy taklif)</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
              <input type="number" id="pitchAfterLesson" class="input" value="4" min="1">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - darsdan keyin qancha vaqt o'tib yuboriladi</label>
              <input type="number" id="pitchDelayMinutes" class="input" value="120" min="0">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Pitch matni</label>
              <textarea id="pitchText" class="input h-32 resize-none" placeholder="Maxsus taklif matni..."></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Video File ID (ixtiyoriy)</label>
              <input type="text" id="pitchVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Rasm File ID (ixtiyoriy)</label>
              <input type="text" id="pitchImageFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
            </div>
          </div>
        </div>

        <!-- Sales Pitch Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ’° Sales Pitch (Qayta taklif)</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - pitchdan keyin</label>
              <input type="number" id="salesDelayMinutes" class="input" value="60" min="0">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Sales matni</label>
              <textarea id="salesPitchText" class="input h-32 resize-none" placeholder="Qayta taklif matni..."></textarea>
            </div>
          </div>
        </div>

        <!-- Soft Attack Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ”¥ Soft Attack (Oxirgi taklif)</h3>
          <div class="space-y-4">
            <div class="flex items-center gap-3">
              <input type="checkbox" id="softAttackDisabled" class="w-5 h-5 accent-red-600">
              <label class="text-sm text-gray-600">O'chirilgan</label>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Delay (daqiqa) - sales pitchdan keyin</label>
              <input type="number" id="softAttackDelayMinutes" class="input" value="1440" min="0">
              <p class="text-xs text-gray-400 mt-1">1440 daqiqa = 24 soat</p>
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Soft attack matni</label>
              <textarea id="softAttackText" class="input h-32 resize-none" placeholder="Oxirgi taklif matni..."></textarea>
            </div>
          </div>
        </div>

        <!-- Congrats Message -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ‰ Tabrik xabari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Barcha darslar tugaganidan keyin</label>
              <textarea id="congratsText" class="input h-32 resize-none" placeholder="ğŸ‰ Tabriklayman! Barcha bepul darslarni tugatdingiz!"></textarea>
            </div>
          </div>
        </div>

      </div>

      <!-- Feedback Flow Section -->
      <div class="card p-5 mt-6">
        <h3 class="font-semibold text-gray-800 mb-4">ğŸ’¬ Feedback Flow (Fikr olish va sotuvga o'tish)</h3>
        <p class="text-sm text-gray-500 mb-4">4-darsdan keyin darhol foydalanuvchi fikrini oling va javobga qarab sotuvga o'ting</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Feedback Question -->
          <div class="space-y-4">
            <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg">
              <input type="checkbox" id="feedbackEnabled" class="w-5 h-5 accent-indigo-600" checked>
              <label class="text-sm font-medium text-indigo-800">Feedback flow yoqilgan (darsdan keyin darhol so'raydi)</label>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">Feedback savoli</label>
              <textarea id="feedbackQuestion" class="input h-24 resize-none" placeholder="Bepul darslar yoqdimi? ğŸ¤”"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">ğŸ‘ Ha tugmasi</label>
                <input type="text" id="feedbackYesBtn" class="input" value="ğŸ‘ Ha, juda yoqdi!">
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">ğŸ‘ Yo'q tugmasi</label>
                <input type="text" id="feedbackNoBtn" class="input" value="ğŸ˜ Unchalik emas">
              </div>
            </div>
          </div>

          <!-- Feedback Responses -->
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">âœ… Ijobiy javobdan keyin (darhol sotuvga o'tadi)</label>
              <textarea id="feedbackYesResponse" class="input h-20 resize-none" placeholder="ğŸ‰ Ajoyib! Unda to'liq kursga taklif qilaman..."></textarea>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">âŒ Salbiy javobdan keyin (sabab so'raydi)</label>
              <textarea id="feedbackNoResponse" class="input h-20 resize-none" placeholder="ğŸ˜” Tushunaman. Iltimos, nimada kamchilik borligini yozing..."></textarea>
            </div>

            <div>
              <label class="text-sm text-gray-600 mb-1 block">ğŸ”„ Salbiy feedbackdan keyin qancha vaqtda sotuvga o'tadi (daqiqa)</label>
              <input type="number" id="feedbackNoSalesDelay" class="input" value="30" min="0">
              <p class="text-xs text-gray-400 mt-1">0 = darhol sabab yozganidan keyin</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Negative Feedback Follow-up -->
      <div class="card p-5 mt-6">
        <h3 class="font-semibold text-gray-800 mb-4">ğŸ”„ Salbiy feedback follow-up</h3>
        <p class="text-sm text-gray-500 mb-4">Foydalanuvchi salbiy fikr bildirganidan keyin yuboriladi</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Follow-up xabar (sabab yozganidan keyin)</label>
              <textarea id="feedbackFollowup" class="input h-28 resize-none" placeholder="Rahmat fikringiz uchun! ğŸ™

Biz doimo yaxshilanib boramiz. Shunday bo'lsa ham, to'liq kursda bunday muammolar yo'q - professional darajada tayyorlangan..."></textarea>
            </div>

            <div class="flex items-center gap-3">
              <input type="checkbox" id="feedbackFollowupShowPrices" class="w-5 h-5 accent-indigo-600" checked>
              <label class="text-sm text-gray-600">Follow-up bilan birga narxlarni ko'rsatish</label>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Maxsus chegirma taklifi (salbiy feedback uchun)</label>
              <textarea id="feedbackSpecialOffer" class="input h-20 resize-none" placeholder="ğŸ Sizga maxsus 20% chegirma! Faqat bugun amal qiladi..."></textarea>
            </div>
            <div class="flex items-center gap-3">
              <input type="checkbox" id="feedbackSpecialOfferEnabled" class="w-5 h-5 accent-orange-600">
              <label class="text-sm text-gray-600">Maxsus chegirma taklifini yoqish</label>
            </div>
          </div>
        </div>
      </div>

      <button onclick="saveProgrevSettings()" class="btn btn-primary mt-6">ğŸ’¾ Progrev sozlamalarini saqlash</button>
    </div>

    <!-- CustDev Tab -->
    <div id="tab-custdev" class="hidden">
      <!-- CustDev Overview Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami savollar</p>
          <p class="text-2xl font-bold text-indigo-600" id="custdevTotalQuestions">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Jami javoblar</p>
          <p class="text-2xl font-bold text-green-600" id="custdevTotalAnswers">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">Javob berganlar</p>
          <p class="text-2xl font-bold text-blue-600" id="custdevRespondents">0</p>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-1">O'rtacha javob</p>
          <p class="text-2xl font-bold text-orange-600" id="custdevAvgAnswers">0</p>
        </div>
      </div>

      <!-- CustDev Charts -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Yosh</p>
          <div class="chart-container h-[120px]">
            <canvas id="ageChart"></canvas>
          </div>
          <div id="ageChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Kasb</p>
          <div class="chart-container h-[120px]">
            <canvas id="occupationChart"></canvas>
          </div>
          <div id="occupationChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Daromad</p>
          <div class="chart-container h-[120px]">
            <canvas id="incomeChart"></canvas>
          </div>
          <div id="incomeChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
        <div class="card p-5">
          <p class="text-gray-500 text-sm mb-2">Byudjet</p>
          <div class="chart-container h-[120px]">
            <canvas id="budgetChart"></canvas>
          </div>
          <div id="budgetChartLegend" class="mt-2 text-xs space-y-1"></div>
        </div>
      </div>

      <!-- Questions List -->
      <div class="card">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800 text-lg">ğŸ“ CustDev savollari</h3>
          <button onclick="openCustDevModal()" class="btn btn-primary">+ Yangi savol</button>
        </div>
        <div id="custdevList" class="divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-400">Yuklanmoqda...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Channel Settings -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ“¢ Kanal sozlamalari</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Premium kanal ID</label>
              <input type="text" id="settingPremiumChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal ID</label>
              <input type="text" id="settingFreeChannel" class="input font-mono" placeholder="-1001234567890">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Bepul kanal linki</label>
              <input type="text" id="settingFreeChannelLink" class="input" placeholder="https://t.me/channel">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Obuna talab qilinadigan dars (0 = talab qilinmaydi)</label>
              <input type="number" id="settingRequireSub" class="input" value="0" min="0">
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ’° Narxlar (so'm)</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">1 oylik</label>
              <input type="number" id="settingPrice1m" class="input" placeholder="97000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">3 oylik</label>
              <input type="number" id="settingPrice3m" class="input" placeholder="247000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">6 oylik</label>
              <input type="number" id="settingPrice6m" class="input" placeholder="447000">
            </div>
            <div>
              <label class="text-sm text-gray-600 mb-1 block">12 oylik</label>
              <input type="number" id="settingPrice12m" class="input" placeholder="797000">
            </div>
          </div>
        </div>

        <!-- Payment Systems -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ’³ To'lov tizimlari</h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingPayme" class="w-5 h-5 accent-blue-600" checked>
              <span class="text-lg">ğŸ’³</span>
              <span class="font-medium">Payme</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" id="settingClick" class="w-5 h-5 accent-green-600" checked>
              <span class="text-lg">ğŸ’ </span>
              <span class="font-medium">Click</span>
            </label>
          </div>
        </div>

        <!-- Admin Info -->
        <div class="card p-5">
          <h3 class="font-semibold text-gray-800 mb-4">ğŸ‘¤ Admin</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-600 mb-1 block">Admin Telegram ID</label>
              <input type="text" id="settingAdminId" class="input font-mono" placeholder="123456789">
            </div>
          </div>
        </div>

      </div>

      <button onclick="saveSettings()" class="btn btn-primary mt-6 w-full lg:w-auto">ğŸ’¾ Sozlamalarni saqlash</button>
    </div>

  </main>

  <!-- Right Panel (Desktop only) -->
  <aside class="right-panel hidden lg:block w-80 p-6 border-l border-gray-100 bg-gradient-to-b from-white to-gray-50/50">

    <!-- Stats Card -->
    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 rounded-2xl p-5 text-white mb-6 shadow-lg shadow-indigo-500/25 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <p class="text-indigo-200 text-sm mb-1 relative">ğŸ’° Umumiy daromad</p>
      <p class="text-3xl font-bold mb-4 relative" id="rightPanelRevenue">0 so'm</p>
      <div class="flex justify-between text-sm relative">
        <span class="text-indigo-200">ğŸ“… Bu oy</span>
        <span class="font-semibold bg-white/20 px-2 py-0.5 rounded-full" id="rightPanelMonthRevenue">0</span>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-800">âš¡ So'nggi faoliyat</h3>
        <span class="text-xs text-indigo-500 font-medium">Live</span>
      </div>
      <div id="recentActivity" class="space-y-2 max-h-64 overflow-y-auto">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

    <!-- Lesson Funnel -->
    <div class="bg-gradient-to-br from-gray-50 to-indigo-50/30 rounded-xl p-4 -mx-2">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-sm">ğŸ“Š</span>
        Darslar funneli
      </h3>
      <div id="lessonProgressPanel" class="funnel-container">
        <div class="text-center text-gray-400 py-4 text-sm">Yuklanmoqda...</div>
      </div>
    </div>

  </aside>

</div>

<!-- Broadcast Modal (Advanced) -->
<div id="broadcastModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">ğŸ“¨ Xabar yuborish</h3>
      <button onclick="closeModal('broadcastModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Target Selection -->
      <div class="space-y-4">
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Kimga yuborish</label>
          <select id="broadcastTarget" class="input" onchange="toggleUserSelect()">
            <option value="all">Hammaga</option>
            <option value="paid">To'laganlarga</option>
            <option value="free">To'lamaganlarga</option>
            <option value="specific">Tanlangan foydalanuvchilarga</option>
          </select>
        </div>

        <!-- User Search (for specific) -->
        <div id="userSelectDiv" class="hidden">
          <label class="text-sm text-gray-600 mb-1 block">Foydalanuvchi qidirish</label>
          <input type="text" id="broadcastUserSearch" class="input mb-2" placeholder="Ism yoki telefon..." oninput="searchBroadcastUsers()">
          <div id="broadcastUsersList" class="max-h-40 overflow-y-auto border rounded-lg p-2 space-y-1"></div>
          <div class="mt-2">
            <p class="text-xs text-gray-500">Tanlangan: <span id="selectedUsersCount">0</span> ta</p>
            <div id="selectedUsersList" class="flex flex-wrap gap-1 mt-1"></div>
          </div>
        </div>
      </div>

      <!-- Message Content -->
      <div class="space-y-4">
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Xabar turi</label>
          <select id="broadcastType" class="input" onchange="toggleBroadcastMedia()">
            <option value="text">Matn</option>
            <option value="photo">Rasm + Matn</option>
            <option value="video">Video + Matn</option>
            <option value="video_note">Video xabar (dumaloq)</option>
            <option value="audio">Audio</option>
            <option value="document">Fayl</option>
          </select>
        </div>

        <div id="broadcastMediaDiv" class="hidden">
          <label class="text-sm text-gray-600 mb-1 block">Media File ID</label>
          <input type="text" id="broadcastMediaId" class="input file-id-input" placeholder="File ID ni kiriting...">
          <p class="text-xs text-gray-400 mt-1">Botga media yuboring - ID oling</p>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">Xabar matni</label>
          <textarea id="broadcastText" class="input h-32 resize-none" placeholder="Xabar yozing..."></textarea>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">Tugma (ixtiyoriy)</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="text" id="broadcastBtnText" class="input" placeholder="Tugma matni">
            <input type="text" id="broadcastBtnUrl" class="input" placeholder="https://...">
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 flex gap-3">
      <button onclick="sendBroadcast()" class="btn btn-primary flex-1">ğŸ“¤ Yuborish</button>
      <button onclick="closeModal('broadcastModal')" class="btn btn-secondary">Bekor qilish</button>
    </div>
  </div>
</div>

<!-- Lesson Modal (with Media IDs) -->
<div id="lessonModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="lessonModalTitle">ğŸ“š Yangi dars</h3>
      <button onclick="closeModal('lessonModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <form id="lessonForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <input type="hidden" id="lessonId">

      <!-- Basic Info -->
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Dars raqami</label>
            <input type="number" id="lessonNumber" class="input" required min="1">
          </div>
          <div>
            <label class="text-sm text-gray-600 mb-1 block">Delay (soat)</label>
            <input type="number" id="lessonDelay" class="input" value="24" min="0">
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Sarlavha</label>
          <input type="text" id="lessonTitle" class="input" required>
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">Matn</label>
          <textarea id="lessonText" class="input h-40 resize-none"></textarea>
        </div>
      </div>

      <!-- Media IDs -->
      <div class="space-y-4">
        <div class="p-3 bg-blue-50 rounded-lg mb-4">
          <p class="text-sm text-blue-700">ğŸ’¡ Botga media yuboring - File ID oling. O'sha ID ni qo'ying.</p>
        </div>

        <div>
          <label class="text-sm text-gray-600 mb-1 block">ğŸ¬ Video File ID</label>
          <input type="text" id="lessonVideoFileId" class="input file-id-input" placeholder="BAACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">ğŸ”µ Video xabar File ID (dumaloq)</label>
          <input type="text" id="lessonVideoNoteFileId" class="input file-id-input" placeholder="DQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">ğŸµ Audio File ID</label>
          <input type="text" id="lessonAudioFileId" class="input file-id-input" placeholder="CQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">ğŸ“ Fayl File ID</label>
          <input type="text" id="lessonDocumentFileId" class="input file-id-input" placeholder="BQACAgIAAxk...">
        </div>
        <div>
          <label class="text-sm text-gray-600 mb-1 block">ğŸ–¼ Rasm File ID</label>
          <input type="text" id="lessonPhotoFileId" class="input file-id-input" placeholder="AgACAgIAAxk...">
        </div>
      </div>

      <div class="lg:col-span-2">
        <button type="submit" class="btn btn-primary w-full">ğŸ’¾ Saqlash</button>
      </div>
    </form>
  </div>
</div>

<!-- User Detail Modal -->
<div id="userDetailModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">ğŸ‘¤ Foydalanuvchi ma'lumotlari</h3>
      <button onclick="closeModal('userDetailModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- User Info -->
      <div>
        <div class="flex items-center gap-4 mb-6">
          <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-2xl font-bold" id="userDetailAvatar">U</div>
          <div>
            <p class="text-xl font-bold text-gray-800" id="userDetailName">-</p>
            <p class="text-gray-500" id="userDetailUsername">-</p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telegram ID</span>
            <span class="font-mono font-medium" id="userDetailTgId">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Telefon</span>
            <span class="font-medium" id="userDetailPhone">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Hozirgi dars</span>
            <span class="badge badge-blue" id="userDetailLesson">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Status</span>
            <span id="userDetailStatus">-</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-500">Ro'yxatdan o'tgan</span>
            <span class="font-medium" id="userDetailCreated">-</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-4 flex gap-2">
          <button onclick="sendMessageToUser()" class="btn btn-primary btn-sm flex-1">ğŸ“¨ Xabar yuborish</button>
        </div>
      </div>

      <!-- CustDev Answers -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">ğŸ“ CustDev javoblari</h4>
        <div id="userDetailCustdev" class="space-y-3">
          <p class="text-gray-400 text-center py-4">Javoblar yo'q</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Question Stats Modal -->
<div id="custdevStatsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content modal-lg mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevStatsTitle">ğŸ“Š Savol statistikasi</h3>
      <button onclick="closeModal('custdevStatsModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chart -->
      <div>
        <div class="chart-container h-[250px]">
          <canvas id="questionStatsChart"></canvas>
        </div>
      </div>

      <!-- Answers List -->
      <div>
        <h4 class="font-semibold text-gray-800 mb-4">Javoblar ro'yxati</h4>
        <div id="questionAnswersList" class="max-h-[300px] overflow-y-auto space-y-2">
          <p class="text-gray-400">Yuklanmoqda...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CustDev Modal -->
<div id="custdevModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
  <div class="modal-content mx-4 p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800" id="custdevModalTitle">ğŸ“ Yangi savol</h3>
      <button onclick="closeModal('custdevModal')" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">âœ•</button>
    </div>
    <form id="custdevForm" class="space-y-4">
      <input type="hidden" id="custdevId">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Nechanchi darsdan keyin</label>
        <input type="number" id="custdevAfterLesson" class="input" value="1" min="1">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Savol matni</label>
        <textarea id="custdevQuestion" class="input h-24 resize-none" required></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Javob turi</label>
        <select id="custdevType" class="input" onchange="toggleCustdevOptions()">
          <option value="text">Matn (yozadi)</option>
          <option value="buttons">Tugmalar (tanlaydi)</option>
        </select>
      </div>
      <div id="custdevOptionsDiv" class="hidden">
        <label class="text-sm text-gray-600 mb-1 block">Variantlar (har qator - bitta)</label>
        <textarea id="custdevOptions" class="input h-24 resize-none font-mono" placeholder="18-25&#10;26-35&#10;36-45"></textarea>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Field nomi (statistika uchun)</label>
        <input type="text" id="custdevFieldName" class="input" placeholder="age, income, occupation...">
        <p class="text-xs text-gray-400 mt-1">Masalan: age, income, occupation, budget</p>
      </div>
      <button type="submit" class="btn btn-primary w-full">Saqlash</button>
    </form>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let auth = '';
let allUsers = [];
let allPayments = [];
let allLessons = [];
let allCustDev = [];
let currentPage = 1;
const perPage = 20;
let paymentFilter = 'completed';
let selectedBroadcastUsers = new Set();
let custdevAnswers = {};

// Charts
let revenueChart, userTypeChart;
let ageChart, occupationChart, incomeChart, budgetChart;
let questionStatsChart;

// ========== INITIALIZATION ==========
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('uz-UZ', {
  year: 'numeric', month: 'short', day: 'numeric', weekday: 'short'
});

const saved = localStorage.getItem('adminAuth');
if (saved) { auth = saved; showDashboard(); }

// Login
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  auth = 'Basic ' + btoa(document.getElementById('username').value + ':' + document.getElementById('password').value);
  try {
    const r = await fetch('/api/stats', { headers: { Authorization: auth } });
    if (r.ok) { localStorage.setItem('adminAuth', auth); showDashboard(); }
    else document.getElementById('loginError').classList.remove('hidden');
  } catch(e) { document.getElementById('loginError').classList.remove('hidden'); }
};

function showDashboard() {
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  loadAll();
}

function logout() {
  localStorage.removeItem('adminAuth');
  location.reload();
}

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.sidebar-item[data-tab], .mobile-nav-item[data-tab]').forEach(item => {
  item.addEventListener('click', function() {
    showTab(this.dataset.tab);
  });
});

function showTab(tab) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');

  document.querySelectorAll('.sidebar-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.sidebar-item[data-tab="' + tab + '"]')?.classList.add('active');

  document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(el => el.classList.remove('active'));
  document.querySelector('.mobile-nav-item[data-tab="' + tab + '"]')?.classList.add('active');

  // Load tab-specific data
  if (tab === 'progrev') loadProgrevSettings();
}

// ========== LOAD DATA ==========
async function loadAll() {
  await Promise.all([loadStats(), loadUsers(), loadPayments(), loadLessons(), loadCustDev(), loadCustdevAnswers()]);
  renderCharts();
}

async function loadStats() {
  try {
    const stats = await (await fetch('/api/stats', { headers: { Authorization: auth } })).json();

    document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
    document.getElementById('statPaidUsers').textContent = stats.paidUsers || 0;
    document.getElementById('statRevenue').textContent = fmtMoney(stats.totalRevenue || 0);

    const conv = stats.totalUsers > 0 ? Math.round((stats.paidUsers / stats.totalUsers) * 100) : 0;
    document.getElementById('statConversion').textContent = conv + '%';

    document.getElementById('rightPanelRevenue').textContent = fmtMoney(stats.totalRevenue || 0);
    document.getElementById('rightPanelMonthRevenue').textContent = fmtMoney(stats.monthRevenue || 0);
    document.getElementById('totalRevenueDisplay').textContent = fmtMoney(stats.totalRevenue || 0);

    document.getElementById('activeUsersCount').textContent = stats.activeUsers || 0;
    document.getElementById('paidUsersCount').textContent = stats.paidUsers || 0;
    document.getElementById('completedUsersCount').textContent = stats.completedUsers || 0;

  } catch(e) { console.error('loadStats error:', e); }
}

async function loadUsers() {
  try {
    const data = await (await fetch('/api/users', { headers: { Authorization: auth } })).json();
    allUsers = data;
    renderUsers();
    renderRecentUsers();
    renderRecentActivity();
  } catch(e) { console.error('loadUsers error:', e); }
}

async function loadPayments() {
  try {
    const data = await (await fetch('/api/payments?all=true', { headers: { Authorization: auth } })).json();
    allPayments = data;
    renderPayments();
    renderRecentPayments();
    renderPaymentStats();
  } catch(e) { console.error('loadPayments error:', e); }
}

async function loadLessons() {
  try {
    const data = await (await fetch('/api/lessons', { headers: { Authorization: auth } })).json();
    allLessons = data.sort((a, b) => a.lesson_number - b.lesson_number);
    renderLessons();
    renderLessonProgress();
  } catch(e) { console.error('loadLessons error:', e); }
}

async function loadCustDev() {
  try {
    const data = await (await fetch('/api/custdev', { headers: { Authorization: auth } })).json();
    allCustDev = data;
    renderCustDev();
  } catch(e) { console.error('loadCustDev error:', e); }
}

async function loadCustdevAnswers() {
  try {
    const data = await (await fetch('/api/custdev/answers', { headers: { Authorization: auth } })).json();
    custdevAnswers = data;
    renderCustDevStats();
  } catch(e) { console.error('loadCustdevAnswers error:', e); }
}

async function loadProgrevSettings() {
  try {
    const data = await (await fetch('/api/settings', { headers: { Authorization: auth } })).json();

    document.getElementById('pitchAfterLesson').value = data.pitch_after_lesson || 4;
    document.getElementById('pitchDelayMinutes').value = data.pitch_delay_minutes || 0;
    document.getElementById('pitchText').value = data.pitch_text || '';
    document.getElementById('pitchVideoFileId').value = data.pitch_video_file_id || '';
    document.getElementById('pitchImageFileId').value = data.pitch_image_file_id || '';

    document.getElementById('salesDelayMinutes').value = data.sales_delay_minutes || 0;
    document.getElementById('salesPitchText').value = data.sales_pitch || '';

    document.getElementById('softAttackDisabled').checked = data.soft_attack_disabled || false;
    document.getElementById('softAttackDelayMinutes').value = data.soft_attack_delay_minutes || 1440;
    document.getElementById('softAttackText').value = data.soft_attack_text || '';

    document.getElementById('congratsText').value = data.congrats_text || '';

    // Feedback flow settings
    document.getElementById('feedbackEnabled').checked = data.feedback_enabled !== false;
    document.getElementById('feedbackQuestion').value = data.feedback_question || 'Bepul darslar yoqdimi? ğŸ¤”';
    document.getElementById('feedbackYesBtn').value = data.feedback_yes_btn || 'ğŸ‘ Ha, juda yoqdi!';
    document.getElementById('feedbackNoBtn').value = data.feedback_no_btn || 'ğŸ˜ Unchalik emas';
    document.getElementById('feedbackYesResponse').value = data.feedback_yes_response || 'ğŸ‰ Ajoyib! Unda to\'liq kursga taklif qilaman...';
    document.getElementById('feedbackNoResponse').value = data.feedback_no_response || 'ğŸ˜” Tushunaman. Iltimos, nimada kamchilik borligini yozing...';
    document.getElementById('feedbackNoSalesDelay').value = data.feedback_no_sales_delay || 30;
    document.getElementById('feedbackFollowup').value = data.feedback_followup || '';
    document.getElementById('feedbackFollowupShowPrices').checked = data.feedback_followup_show_prices !== false;
    document.getElementById('feedbackSpecialOffer').value = data.feedback_special_offer || '';
    document.getElementById('feedbackSpecialOfferEnabled').checked = data.feedback_special_offer_enabled || false;
  } catch(e) { console.error('loadProgrevSettings error:', e); }
}

// ========== RENDER FUNCTIONS ==========
function renderUsers() {
  const filter = document.getElementById('userStatusFilter').value;
  let filtered = allUsers;

  if (filter === 'active') filtered = allUsers.filter(u => !u.is_paid && u.current_lesson > 0);
  else if (filter === 'paid') filtered = allUsers.filter(u => u.is_paid);
  else if (filter === 'completed') filtered = allUsers.filter(u => u.lessons_completed);

  const start = (currentPage - 1) * perPage;
  const paginated = filtered.slice(start, start + perPage);

  const tbody = document.getElementById('usersTableBody');
  if (!paginated.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">Foydalanuvchilar topilmadi</td></tr>';
    return;
  }

  tbody.innerHTML = paginated.map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">ğŸ‘</button>
      </td>
    </tr>
  `).join('');

  // Pagination
  const totalPages = Math.ceil(filtered.length / perPage);
  const pagination = document.getElementById('usersPagination');
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHtml = '';
  for (let i = 1; i <= Math.min(totalPages, 10); i++) {
    paginationHtml += `<button onclick="goToPage(${i})" class="w-10 h-10 rounded-lg ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'}">${i}</button>`;
  }
  pagination.innerHTML = paginationHtml;
}

function goToPage(page) {
  currentPage = page;
  renderUsers();
}

function searchUsers() {
  const query = document.getElementById('userSearch').value.toLowerCase();
  if (!query) { renderUsers(); return; }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  );

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = filtered.slice(0, 20).map(u => `
    <tr class="table-row" onclick="openUserDetail(${u.telegram_id})">
      <td class="px-5 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
            ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
          </div>
          <div>
            <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
            <p class="text-xs text-gray-400">@${u.username || 'no_username'}</p>
          </div>
        </div>
      </td>
      <td class="px-5 py-4 text-gray-600">${u.phone || '-'}</td>
      <td class="px-5 py-4"><span class="badge badge-blue">${u.current_lesson || 0}-dars</span></td>
      <td class="px-5 py-4">
        ${u.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>'}
      </td>
      <td class="px-5 py-4 text-gray-500 text-sm">${fmtDate(u.created_at)}</td>
      <td class="px-5 py-4">
        <button onclick="event.stopPropagation(); openUserDetail(${u.telegram_id})" class="btn btn-secondary btn-sm">ğŸ‘</button>
      </td>
    </tr>
  `).join('');
}

function renderRecentUsers() {
  const recent = allUsers.slice(0, 5);
  const container = document.getElementById('recentUsersList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">Foydalanuvchilar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(u => `
    <div class="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50" onclick="openUserDetail(${u.telegram_id})">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
        ${(u.full_name || u.username || 'U').charAt(0).toUpperCase()}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${u.full_name || u.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${u.current_lesson || 0}-dars</p>
      </div>
      ${u.is_paid ? '<span class="badge badge-green">ğŸ’</span>' : ''}
    </div>
  `).join('');
}

function filterPayments(status) {
  paymentFilter = status;

  document.querySelectorAll('[data-payment-status]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.paymentStatus === status);
  });

  renderPayments();
}

function renderPayments() {
  const tbody = document.getElementById('paymentsTableBody');

  let filtered = allPayments;
  if (paymentFilter !== 'all') {
    filtered = allPayments.filter(p => p.status === paymentFilter);
  }

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-400">To\'lovlar yo\'q</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.slice(0, 50).map(p => {
    let statusBadge = '';
    if (p.status === 'completed') statusBadge = '<span class="badge badge-green">To\'langan</span>';
    else if (p.status === 'pending') statusBadge = '<span class="badge badge-yellow">Jarayonda</span>';
    else if (p.status === 'cancelled' || p.status === 'failed') statusBadge = '<span class="badge badge-red">Bekor</span>';
    else statusBadge = `<span class="badge badge-gray">${p.status || '-'}</span>`;

    return `
      <tr class="table-row">
        <td class="px-5 py-4 text-gray-500 text-sm">${fmtDateTime(p.created_at)}</td>
        <td class="px-5 py-4">
          <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
          <p class="text-xs text-gray-400">ID: ${p.telegram_id || '-'}</p>
        </td>
        <td class="px-5 py-4 font-semibold ${p.status === 'completed' ? 'text-green-600' : 'text-gray-600'}">${fmtMoney(p.amount)}</td>
        <td class="px-5 py-4"><span class="badge badge-blue">${p.plan || '-'}</span></td>
        <td class="px-5 py-4">${statusBadge}</td>
        <td class="px-5 py-4 text-gray-500">${p.payment_system || '-'}</td>
      </tr>
    `;
  }).join('');
}

function renderRecentPayments() {
  const recent = allPayments.filter(p => p.status === 'completed').slice(0, 5);
  const container = document.getElementById('recentPaymentsList');

  if (!recent.length) {
    container.innerHTML = '<div class="p-4 text-center text-gray-400">To\'lovlar yo\'q</div>';
    return;
  }

  container.innerHTML = recent.map(p => `
    <div class="flex items-center gap-3 p-4">
      <div class="activity-icon bg-green-100 text-green-600">ğŸ’°</div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${p.full_name || p.username || 'Foydalanuvchi'}</p>
        <p class="text-xs text-gray-400">${fmtDate(p.created_at)}</p>
      </div>
      <p class="font-semibold text-green-600">${fmtMoney(p.amount)}</p>
    </div>
  `).join('');
}

function renderPaymentStats() {
  const completed = allPayments.filter(p => p.status === 'completed');
  const pending = allPayments.filter(p => p.status === 'pending');
  const cancelled = allPayments.filter(p => p.status === 'cancelled' || p.status === 'failed');

  document.getElementById('payCompletedCount').textContent = completed.length;
  document.getElementById('payPendingCount').textContent = pending.length;
  document.getElementById('payCancelledCount').textContent = cancelled.length;

  const now = new Date();
  const today = completed.filter(p => new Date(p.created_at).toDateString() === now.toDateString());
  const week = completed.filter(p => (now - new Date(p.created_at)) < 7 * 24 * 60 * 60 * 1000);
  const month = completed.filter(p => (now - new Date(p.created_at)) < 30 * 24 * 60 * 60 * 1000);

  const sum = arr => arr.reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('payToday').textContent = fmtMoney(sum(today));
  document.getElementById('payTodayCount').textContent = today.length + ' ta';
  document.getElementById('payWeek').textContent = fmtMoney(sum(week));
  document.getElementById('payWeekCount').textContent = week.length + ' ta';
  document.getElementById('payMonth').textContent = fmtMoney(sum(month));
  document.getElementById('payMonthCount').textContent = month.length + ' ta';
  document.getElementById('payTotal').textContent = fmtMoney(sum(completed));
  document.getElementById('payTotalCount').textContent = completed.length + ' ta';
}

function renderLessons() {
  const container = document.getElementById('lessonsList');

  if (!allLessons.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Darslar yo\'q. Yangi dars qo\'shing!</div>';
    return;
  }

  container.innerHTML = allLessons.map(l => {
    const hasMedia = l.video_file_id || l.video_note_file_id || l.audio_file_id || l.document_file_id || l.photo_file_id;
    const mediaIcons = [];
    if (l.video_file_id) mediaIcons.push('ğŸ¬');
    if (l.video_note_file_id) mediaIcons.push('ğŸ”µ');
    if (l.audio_file_id) mediaIcons.push('ğŸµ');
    if (l.document_file_id) mediaIcons.push('ğŸ“');
    if (l.photo_file_id) mediaIcons.push('ğŸ–¼');

    return `
      <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
        <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">
          ${l.lesson_number}
        </div>
        <div class="flex-1">
          <p class="font-medium text-gray-800">${l.title}</p>
          <p class="text-sm text-gray-400">
            ${l.delay_hours || 0} soat keyin
            ${mediaIcons.length ? ' â€¢ ' + mediaIcons.join(' ') : ''}
          </p>
        </div>
        <button onclick="editLesson(${l.id})" class="btn btn-secondary text-sm">âœï¸</button>
        <button onclick="deleteLesson(${l.id})" class="btn bg-red-50 text-red-600 text-sm">ğŸ—‘ï¸</button>
      </div>
    `;
  }).join('');
}

function renderLessonProgress() {
  const lessonCounts = {};
  allUsers.forEach(u => {
    const lesson = u.current_lesson || 0;
    lessonCounts[lesson] = (lessonCounts[lesson] || 0) + 1;
  });

  const maxUsers = Math.max(...Object.values(lessonCounts), 1);
  const totalUsers = allUsers.length || 1;

  const statsContainer = document.getElementById('lessonProgressStats');
  const panelContainer = document.getElementById('lessonProgressPanel');

  // Standard bar chart for stats section
  const statsHtml = allLessons.slice(0, 10).map(l => {
    const count = lessonCounts[l.lesson_number] || 0;
    const pct = Math.round((count / maxUsers) * 100);
    return `
      <div class="flex items-center gap-3">
        <span class="w-16 text-sm text-gray-600">${l.lesson_number}-dars</span>
        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
          <div class="h-full bg-indigo-500 rounded-full" style="width: ${pct}%"></div>
        </div>
        <span class="w-12 text-sm text-gray-600 text-right">${count}</span>
      </div>
    `;
  }).join('');

  statsContainer.innerHTML = statsHtml || '<p class="text-gray-400 text-center">Ma\'lumot yo\'q</p>';

  // Visual funnel for right panel
  const funnelColors = ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#eef2ff', '#f5f3ff'];
  const lessons = allLessons.slice(0, 7);

  if (!lessons.length) {
    panelContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">Ma\'lumot yo\'q</p>';
    return;
  }

  // Calculate cumulative users (users at lesson N or higher)
  const cumulativeCounts = lessons.map((l, idx) => {
    let count = 0;
    lessons.slice(idx).forEach(lesson => {
      count += lessonCounts[lesson.lesson_number] || 0;
    });
    return { lesson: l, count };
  });

  const funnelHtml = cumulativeCounts.map((item, idx) => {
    const count = item.count;
    const lesson = item.lesson;
    const widthPct = Math.max(30, 100 - (idx * 12));
    const pct = Math.round((count / totalUsers) * 100);
    const bgColor = funnelColors[idx % funnelColors.length];
    const textColor = idx < 3 ? '#fff' : '#4338ca';

    return `
      <div class="funnel-step" style="width: ${widthPct}%; background: ${bgColor}; margin-bottom: 2px;">
        <div class="flex justify-between items-center">
          <span style="font-size: 11px; font-weight: 500; color: ${textColor}">${lesson.lesson_number}-dars</span>
          <span style="font-size: 12px; font-weight: 700; color: ${textColor}">${count}</span>
        </div>
        <div style="font-size: 10px; color: ${idx < 3 ? 'rgba(255,255,255,0.7)' : '#6366f1'}">${pct}% foydalanuvchi</div>
      </div>
    `;
  }).join('');

  // Add drop-off stats
  let dropOffHtml = '';
  if (cumulativeCounts.length > 1) {
    const dropOff = cumulativeCounts[0].count - cumulativeCounts[cumulativeCounts.length - 1].count;
    const conversionRate = Math.round((cumulativeCounts[cumulativeCounts.length - 1].count / Math.max(cumulativeCounts[0].count, 1)) * 100);
    dropOffHtml = `
      <div class="mt-3 p-2 bg-gray-50 rounded-lg text-center">
        <div class="text-xs text-gray-500">Konversiya</div>
        <div class="text-lg font-bold text-indigo-600">${conversionRate}%</div>
      </div>
    `;
  }

  panelContainer.innerHTML = funnelHtml + dropOffHtml;
}

function renderCustDev() {
  const container = document.getElementById('custdevList');

  if (!allCustDev.length) {
    container.innerHTML = '<div class="p-8 text-center text-gray-400">Savollar yo\'q. Yangi savol qo\'shing!</div>';
    return;
  }

  container.innerHTML = allCustDev.map(q => `
    <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
      <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
        ${q.after_lesson}
      </div>
      <div class="flex-1">
        <p class="font-medium text-gray-800">${q.question_text}</p>
        <p class="text-sm text-gray-400">
          ${q.question_type === 'buttons' ? 'Tugmalar' : 'Matn'}
          â€¢ ${q.answer_count || 0} javob
          ${q.field_name ? ' â€¢ ' + q.field_name : ''}
        </p>
      </div>
      <button onclick="openQuestionStats(${q.id})" class="btn btn-secondary text-sm">ğŸ“Š</button>
      <button onclick="editCustDev(${q.id})" class="btn btn-secondary text-sm">âœï¸</button>
      <button onclick="deleteCustDev(${q.id})" class="btn bg-red-50 text-red-600 text-sm">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

function renderCustDevStats() {
  // Count stats
  const totalQuestions = allCustDev.length;
  const totalAnswers = Object.values(custdevAnswers).reduce((sum, arr) => sum + arr.length, 0);
  const respondents = new Set();
  Object.values(custdevAnswers).forEach(answers => {
    answers.forEach(a => respondents.add(a.telegram_id));
  });
  const avgAnswers = respondents.size > 0 ? (totalAnswers / respondents.size).toFixed(1) : 0;

  document.getElementById('custdevTotalQuestions').textContent = totalQuestions;
  document.getElementById('custdevTotalAnswers').textContent = totalAnswers;
  document.getElementById('custdevRespondents').textContent = respondents.size;
  document.getElementById('custdevAvgAnswers').textContent = avgAnswers;

  // Render charts with field data
  renderCustDevCharts();
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivity');

  const activities = [
    ...allUsers.slice(0, 5).map(u => ({ type: 'user', data: u, date: new Date(u.created_at) })),
    ...allPayments.filter(p => p.status === 'completed').slice(0, 5).map(p => ({ type: 'payment', data: p, date: new Date(p.created_at) }))
  ].sort((a, b) => b.date - a.date).slice(0, 5);

  if (!activities.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">Faoliyat yo\'q</div></div>';
    return;
  }

  const timeAgo = (date) => {
    const mins = Math.floor((Date.now() - date) / 60000);
    if (mins < 1) return 'hozirgina';
    if (mins < 60) return mins + ' min oldin';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + ' soat oldin';
    return Math.floor(hours / 24) + ' kun oldin';
  };

  container.innerHTML = activities.map(a => {
    const getName = (d) => d.full_name || d.username || 'Foydalanuvchi';
    const time = timeAgo(a.date);
    if (a.type === 'user') {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600">ğŸ‘¤</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-gray-400">Yangi foydalanuvchi â€¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
        </div>
      `;
    } else {
      return `
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/80 transition-colors cursor-pointer">
          <div class="activity-icon bg-gradient-to-br from-green-100 to-emerald-100 text-green-600">ğŸ’°</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-800 truncate">${getName(a.data)}</p>
            <p class="text-xs text-green-600 font-medium">${fmtMoney(a.data.amount)} â€¢ ${time}</p>
          </div>
          <span class="w-2 h-2 bg-green-400 rounded-full"></span>
        </div>
      `;
    }
  }).join('');
}

// ========== CHARTS ==========
function renderCharts() {
  renderRevenueChart();
  renderUserTypeChart();
  renderCustDevCharts();
}

function renderRevenueChart() {
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;

  const monthlyData = {};
  const months = ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyn', 'Iyl', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'];

  allPayments.filter(p => p.status === 'completed').forEach(p => {
    const date = new Date(p.created_at);
    const key = months[date.getMonth()];
    monthlyData[key] = (monthlyData[key] || 0) + (p.amount || 0);
  });

  const labels = months.slice(0, new Date().getMonth() + 1);
  const data = labels.map(m => (monthlyData[m] || 0) / 100);

  if (revenueChart) revenueChart.destroy();

  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: '#6366f1',
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { grid: { color: '#f3f4f6' }, ticks: { callback: v => v >= 1000 ? (v/1000) + 'K' : v } }
      }
    }
  });
}

function renderUserTypeChart() {
  const ctx = document.getElementById('userTypeChart')?.getContext('2d');
  if (!ctx) return;

  const active = allUsers.filter(u => !u.is_paid && !u.lessons_completed).length;
  const paid = allUsers.filter(u => u.is_paid).length;
  const completed = allUsers.filter(u => u.lessons_completed && !u.is_paid).length;

  if (userTypeChart) userTypeChart.destroy();

  userTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Aktiv', 'To\'lagan', 'Tugatgan'],
      datasets: [{
        data: [active, paid, completed],
        backgroundColor: ['#6366f1', '#22c55e', '#e5e7eb'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: { legend: { display: false } }
    }
  });
}

function renderCustDevCharts() {
  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Map various field_name values to chart keys
  const fieldNameMap = {
    // English variations
    'age': 'age', 'age_group': 'age', 'yosh': 'age',
    'occupation': 'occupation', 'kasb': 'occupation', 'job': 'occupation',
    'income': 'income', 'income_level': 'income', 'daromad': 'income',
    'budget': 'budget', 'budget_range': 'budget', 'byudjet': 'budget'
  };

  // Group answers by mapped field_name
  const fieldData = {};
  allCustDev.forEach(q => {
    if (q.field_name && custdevAnswers[q.id]) {
      const answers = custdevAnswers[q.id];
      const mappedField = fieldNameMap[q.field_name.toLowerCase()] || q.field_name;
      if (!fieldData[mappedField]) fieldData[mappedField] = {};

      answers.forEach(a => {
        const value = a.answer_text || 'Boshqa';
        fieldData[mappedField][value] = (fieldData[mappedField][value] || 0) + 1;
      });
    }
  });

  // Render charts for each field
  ['age', 'occupation', 'income', 'budget'].forEach((field, idx) => {
    const ctx = document.getElementById(field + 'Chart')?.getContext('2d');
    if (!ctx) return;

    const data = fieldData[field] || {};
    const labels = Object.keys(data);
    const values = Object.values(data);

    if (window[field + 'ChartInstance']) window[field + 'ChartInstance'].destroy();

    window[field + 'ChartInstance'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { display: false } }
      }
    });

    // Render legend
    const legendContainer = document.getElementById(field + 'ChartLegend');
    if (legendContainer && labels.length) {
      legendContainer.innerHTML = labels.slice(0, 4).map((label, i) => `
        <div class="flex items-center gap-1">
          <span class="w-2 h-2 rounded-full" style="background: ${colors[i % colors.length]}"></span>
          <span class="truncate">${label}: ${values[i]}</span>
        </div>
      `).join('');
    }
  });
}

// ========== MODALS ==========
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ========== USER DETAIL ==========
async function openUserDetail(telegramId) {
  const user = allUsers.find(u => u.telegram_id == telegramId);
  if (!user) return;

  const displayName = user.full_name || user.username || 'Foydalanuvchi';
  document.getElementById('userDetailAvatar').textContent = displayName.charAt(0).toUpperCase();
  document.getElementById('userDetailName').textContent = displayName;
  document.getElementById('userDetailUsername').textContent = user.username ? '@' + user.username : 'username yo\'q';
  document.getElementById('userDetailTgId').textContent = user.telegram_id;
  document.getElementById('userDetailPhone').textContent = user.phone || '-';
  document.getElementById('userDetailLesson').textContent = (user.current_lesson || 0) + '-dars';
  document.getElementById('userDetailStatus').innerHTML = user.is_paid ? '<span class="badge badge-green">Premium</span>' : '<span class="badge badge-gray">Free</span>';
  document.getElementById('userDetailCreated').textContent = fmtDateTime(user.created_at);

  // Load user's custdev answers
  try {
    const answers = await (await fetch('/api/users/' + telegramId + '/custdev', { headers: { Authorization: auth } })).json();
    const container = document.getElementById('userDetailCustdev');

    if (!answers || !answers.length) {
      container.innerHTML = '<p class="text-gray-400 text-center py-4">Javoblar yo\'q</p>';
    } else {
      container.innerHTML = answers.map(a => `
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-500 mb-1">${a.question_text}</p>
          <p class="font-medium text-gray-800">${a.answer_text}</p>
        </div>
      `).join('');
    }
  } catch(e) {
    document.getElementById('userDetailCustdev').innerHTML = '<p class="text-red-400 text-center py-4">Xatolik</p>';
  }

  // Store current user for sending message
  window.currentUserTgId = telegramId;
  openModal('userDetailModal');
}

function sendMessageToUser() {
  closeModal('userDetailModal');
  openBroadcastModal();
  document.getElementById('broadcastTarget').value = 'specific';
  toggleUserSelect();

  const user = allUsers.find(u => u.telegram_id == window.currentUserTgId);
  if (user) {
    selectedBroadcastUsers.add(user.telegram_id);
    updateSelectedUsersList();
  }
}

// ========== BROADCAST ==========
function openBroadcastModal() {
  selectedBroadcastUsers.clear();
  document.getElementById('broadcastTarget').value = 'all';
  document.getElementById('broadcastType').value = 'text';
  document.getElementById('broadcastText').value = '';
  document.getElementById('broadcastMediaId').value = '';
  document.getElementById('broadcastBtnText').value = '';
  document.getElementById('broadcastBtnUrl').value = '';
  toggleUserSelect();
  toggleBroadcastMedia();
  openModal('broadcastModal');
}

function toggleUserSelect() {
  const target = document.getElementById('broadcastTarget').value;
  document.getElementById('userSelectDiv').classList.toggle('hidden', target !== 'specific');
}

function toggleBroadcastMedia() {
  const type = document.getElementById('broadcastType').value;
  document.getElementById('broadcastMediaDiv').classList.toggle('hidden', type === 'text');
}

function searchBroadcastUsers() {
  const query = document.getElementById('broadcastUserSearch').value.toLowerCase();
  const container = document.getElementById('broadcastUsersList');

  if (!query) {
    container.innerHTML = '<p class="text-gray-400 text-sm">Qidirish...</p>';
    return;
  }

  const filtered = allUsers.filter(u =>
    (u.full_name || '').toLowerCase().includes(query) ||
    (u.username || '').toLowerCase().includes(query) ||
    (u.phone || '').includes(query) ||
    String(u.telegram_id).includes(query)
  ).slice(0, 10);

  container.innerHTML = filtered.map(u => `
    <div class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="toggleBroadcastUser(${u.telegram_id})">
      <input type="checkbox" ${selectedBroadcastUsers.has(u.telegram_id) ? 'checked' : ''} class="pointer-events-none">
      <span class="text-sm">${u.full_name || u.username || 'User'}</span>
      <span class="text-xs text-gray-400">${u.phone || u.telegram_id}</span>
    </div>
  `).join('') || '<p class="text-gray-400 text-sm">Topilmadi</p>';
}

function toggleBroadcastUser(telegramId) {
  if (selectedBroadcastUsers.has(telegramId)) {
    selectedBroadcastUsers.delete(telegramId);
  } else {
    selectedBroadcastUsers.add(telegramId);
  }
  searchBroadcastUsers();
  updateSelectedUsersList();
}

function updateSelectedUsersList() {
  document.getElementById('selectedUsersCount').textContent = selectedBroadcastUsers.size;

  const container = document.getElementById('selectedUsersList');
  container.innerHTML = Array.from(selectedBroadcastUsers).map(id => {
    const user = allUsers.find(u => u.telegram_id == id);
    return `
      <span class="badge badge-blue flex items-center gap-1">
        ${user?.full_name || user?.username || id}
        <button onclick="toggleBroadcastUser(${id})" class="ml-1">Ã—</button>
      </span>
    `;
  }).join('');
}

async function sendBroadcast() {
  const target = document.getElementById('broadcastTarget').value;
  const type = document.getElementById('broadcastType').value;
  const text = document.getElementById('broadcastText').value;
  const mediaId = document.getElementById('broadcastMediaId').value;
  const btnText = document.getElementById('broadcastBtnText').value;
  const btnUrl = document.getElementById('broadcastBtnUrl').value;

  if (!text.trim() && type === 'text') {
    alert('Xabar matni bo\'sh');
    return;
  }

  if (type !== 'text' && !mediaId.trim()) {
    alert('Media File ID kiriting');
    return;
  }

  if (target === 'specific' && selectedBroadcastUsers.size === 0) {
    alert('Kamida bitta foydalanuvchi tanlang');
    return;
  }

  try {
    const body = {
      target,
      type,
      text,
      media_id: mediaId || null,
      button: btnText && btnUrl ? { text: btnText, url: btnUrl } : null,
      user_ids: target === 'specific' ? Array.from(selectedBroadcastUsers) : null
    };

    const res = await fetch('/api/broadcast/advanced', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const result = await res.json();

    if (res.ok) {
      alert(`âœ… Xabar yuborildi! ${result.sent || 0} ta muvaffaqiyatli, ${result.failed || 0} ta xato`);
      closeModal('broadcastModal');
    } else {
      alert('Xatolik: ' + (result.error || 'Noma\'lum xato'));
    }
  } catch(e) {
    alert('Xatolik: ' + e.message);
  }
}

// ========== LESSONS ==========
function openLessonModal() {
  document.getElementById('lessonModalTitle').textContent = 'ğŸ“š Yangi dars';
  document.getElementById('lessonId').value = '';
  document.getElementById('lessonNumber').value = allLessons.length + 1;
  document.getElementById('lessonTitle').value = '';
  document.getElementById('lessonText').value = '';
  document.getElementById('lessonDelay').value = 24;
  document.getElementById('lessonVideoFileId').value = '';
  document.getElementById('lessonVideoNoteFileId').value = '';
  document.getElementById('lessonAudioFileId').value = '';
  document.getElementById('lessonDocumentFileId').value = '';
  document.getElementById('lessonPhotoFileId').value = '';
  openModal('lessonModal');
}

function editLesson(id) {
  const lesson = allLessons.find(l => l.id === id);
  if (!lesson) return;

  document.getElementById('lessonModalTitle').textContent = 'âœï¸ Darsni tahrirlash';
  document.getElementById('lessonId').value = lesson.id;
  document.getElementById('lessonNumber').value = lesson.lesson_number;
  document.getElementById('lessonTitle').value = lesson.title;
  document.getElementById('lessonText').value = lesson.content || lesson.text || '';
  document.getElementById('lessonDelay').value = lesson.delay_hours || 0;
  document.getElementById('lessonVideoFileId').value = lesson.video_file_id || '';
  document.getElementById('lessonVideoNoteFileId').value = lesson.video_note_file_id || '';
  document.getElementById('lessonAudioFileId').value = lesson.audio_file_id || '';
  document.getElementById('lessonDocumentFileId').value = lesson.document_file_id || '';
  document.getElementById('lessonPhotoFileId').value = lesson.photo_file_id || '';
  openModal('lessonModal');
}

document.getElementById('lessonForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('lessonId').value;
  const data = {
    lesson_number: parseInt(document.getElementById('lessonNumber').value),
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonText').value,
    delay_hours: parseInt(document.getElementById('lessonDelay').value) || 0,
    video_file_id: document.getElementById('lessonVideoFileId').value || null,
    video_note_file_id: document.getElementById('lessonVideoNoteFileId').value || null,
    audio_file_id: document.getElementById('lessonAudioFileId').value || null,
    document_file_id: document.getElementById('lessonDocumentFileId').value || null,
    photo_file_id: document.getElementById('lessonPhotoFileId').value || null
  };

  try {
    const url = id ? '/api/lessons/' + id : '/api/lessons';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('lessonModal');
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteLesson(id) {
  if (!confirm('Darsni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/lessons/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadLessons();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== CUSTDEV ==========
function openCustDevModal() {
  document.getElementById('custdevModalTitle').textContent = 'ğŸ“ Yangi savol';
  document.getElementById('custdevId').value = '';
  document.getElementById('custdevAfterLesson').value = 1;
  document.getElementById('custdevQuestion').value = '';
  document.getElementById('custdevType').value = 'text';
  document.getElementById('custdevOptions').value = '';
  document.getElementById('custdevFieldName').value = '';
  document.getElementById('custdevOptionsDiv').classList.add('hidden');
  openModal('custdevModal');
}

function editCustDev(id) {
  const q = allCustDev.find(c => c.id === id);
  if (!q) return;

  document.getElementById('custdevModalTitle').textContent = 'âœï¸ Savolni tahrirlash';
  document.getElementById('custdevId').value = q.id;
  document.getElementById('custdevAfterLesson').value = q.after_lesson;
  document.getElementById('custdevQuestion').value = q.question_text;
  document.getElementById('custdevType').value = q.question_type;
  document.getElementById('custdevOptions').value = q.options ? q.options.join('\n') : '';
  document.getElementById('custdevFieldName').value = q.field_name || '';
  toggleCustdevOptions();
  openModal('custdevModal');
}

function toggleCustdevOptions() {
  const type = document.getElementById('custdevType').value;
  document.getElementById('custdevOptionsDiv').classList.toggle('hidden', type !== 'buttons');
}

document.getElementById('custdevForm').onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById('custdevId').value;
  const type = document.getElementById('custdevType').value;
  const optionsText = document.getElementById('custdevOptions').value;

  const data = {
    after_lesson: parseInt(document.getElementById('custdevAfterLesson').value),
    question_text: document.getElementById('custdevQuestion').value,
    question_type: type,
    options: type === 'buttons' ? optionsText.split('\n').filter(o => o.trim()) : null,
    field_name: document.getElementById('custdevFieldName').value || null
  };

  try {
    const url = id ? '/api/custdev/' + id : '/api/custdev';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, {
      method,
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    closeModal('custdevModal');
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
};

async function deleteCustDev(id) {
  if (!confirm('Savolni o\'chirmoqchimisiz?')) return;

  try {
    await fetch('/api/custdev/' + id, {
      method: 'DELETE',
      headers: { Authorization: auth }
    });
    loadCustDev();
  } catch(e) { alert('Xatolik: ' + e.message); }
}

async function openQuestionStats(questionId) {
  const question = allCustDev.find(q => q.id === questionId);
  if (!question) return;

  document.getElementById('custdevStatsTitle').textContent = 'ğŸ“Š ' + question.question_text.substring(0, 50) + '...';

  // Get answers for this question
  const answers = custdevAnswers[questionId] || [];

  // Count answers
  const answerCounts = {};
  answers.forEach(a => {
    const value = a.answer_text || 'Boshqa';
    answerCounts[value] = (answerCounts[value] || 0) + 1;
  });

  const labels = Object.keys(answerCounts);
  const values = Object.values(answerCounts);
  const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

  // Render chart
  const ctx = document.getElementById('questionStatsChart')?.getContext('2d');
  if (ctx) {
    if (questionStatsChart) questionStatsChart.destroy();

    questionStatsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data: values.length ? values : [1],
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // Render answers list
  const listContainer = document.getElementById('questionAnswersList');
  listContainer.innerHTML = labels.map((label, i) => `
    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full" style="background: ${colors[i % colors.length]}"></span>
        <span class="font-medium">${label}</span>
      </div>
      <span class="text-gray-600">${values[i]} (${Math.round(values[i] / answers.length * 100)}%)</span>
    </div>
  `).join('') || '<p class="text-gray-400">Javoblar yo\'q</p>';

  openModal('custdevStatsModal');
}

// ========== PROGREV SETTINGS ==========
async function saveProgrevSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pitch_after_lesson: parseInt(document.getElementById('pitchAfterLesson').value) || 4,
        pitch_delay_minutes: parseInt(document.getElementById('pitchDelayMinutes').value) || 0,
        pitch_text: document.getElementById('pitchText').value,
        pitch_video_file_id: document.getElementById('pitchVideoFileId').value || null,
        pitch_image_file_id: document.getElementById('pitchImageFileId').value || null,
        sales_delay_minutes: parseInt(document.getElementById('salesDelayMinutes').value) || 0,
        sales_pitch: document.getElementById('salesPitchText').value,
        soft_attack_disabled: document.getElementById('softAttackDisabled').checked,
        soft_attack_delay_minutes: parseInt(document.getElementById('softAttackDelayMinutes').value) || 1440,
        soft_attack_text: document.getElementById('softAttackText').value,
        congrats_text: document.getElementById('congratsText').value,
        // Feedback flow settings
        feedback_enabled: document.getElementById('feedbackEnabled').checked,
        feedback_question: document.getElementById('feedbackQuestion').value,
        feedback_yes_btn: document.getElementById('feedbackYesBtn').value,
        feedback_no_btn: document.getElementById('feedbackNoBtn').value,
        feedback_yes_response: document.getElementById('feedbackYesResponse').value,
        feedback_no_response: document.getElementById('feedbackNoResponse').value,
        feedback_no_sales_delay: parseInt(document.getElementById('feedbackNoSalesDelay').value) || 30,
        feedback_followup: document.getElementById('feedbackFollowup').value,
        feedback_followup_show_prices: document.getElementById('feedbackFollowupShowPrices').checked,
        feedback_special_offer: document.getElementById('feedbackSpecialOffer').value,
        feedback_special_offer_enabled: document.getElementById('feedbackSpecialOfferEnabled').checked
      })
    });

    alert('âœ… Progrev sozlamalari saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== SETTINGS ==========
async function saveSettings() {
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { Authorization: auth, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        premium_channel_id: document.getElementById('settingPremiumChannel').value,
        free_channel_id: document.getElementById('settingFreeChannel').value,
        free_channel_link: document.getElementById('settingFreeChannelLink').value,
        require_subscription_before_lesson: parseInt(document.getElementById('settingRequireSub').value) || 0,
        payme_enabled: document.getElementById('settingPayme').checked,
        click_enabled: document.getElementById('settingClick').checked,
        price_1m: parseInt(document.getElementById('settingPrice1m').value) * 100 || null,
        price_3m: parseInt(document.getElementById('settingPrice3m').value) * 100 || null,
        price_6m: parseInt(document.getElementById('settingPrice6m').value) * 100 || null,
        price_12m: parseInt(document.getElementById('settingPrice12m').value) * 100 || null
      })
    });

    alert('âœ… Sozlamalar saqlandi!');
  } catch(e) { alert('Xatolik: ' + e.message); }
}

// ========== HELPERS ==========
function fmtMoney(tiyin) {
  const som = Math.round(tiyin / 100);
  return som.toLocaleString('uz-UZ') + ' so\'m';
}

function fmtDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
}

function fmtDateTime(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}
</script>

</body>
</html>
